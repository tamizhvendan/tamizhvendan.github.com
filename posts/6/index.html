
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>P3 Programmer</title>
	<meta name="author" content="Tamizhvendan S">

	
	<meta name="description" content="Mar 2nd, 2015 fsharp, rop Comments Step-7 Validation and Error Handling Using ROP This is step 7 of my blog series on Web Application Development in &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="http://feeds.feedburner.com/tamizhvendan-blog" rel="alternate" title="P3 Programmer" type="application/atom+xml">
	
	<link rel="canonical" href="http://blog.tamizhvendan.in/posts/6/">
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link href="/favicon.png" rel="shortcut icon">
  <link href='/stylesheets/fonts.css' rel='stylesheet' type='text/css'>
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <style type="text/css">

  </style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
	<!-- Start of Leadin Embed -->
  <script type="text/javascript" src="//js.leadin.com/js/v1/2177345.js" id="LeadinEmbed-2177345" crossorigin="use-credentials" async defer></script>
<!-- End of Leadin Embed -->
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-43004255-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><!-- <div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("tamizh88@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div> -->
<style>
@media (max-width: 600px) {
  #book-cover, #tag-cloud {
    display: none;
  }
}
</style>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="http://about.me/tamizhvendan">About Me</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <li><a href="/open-source-contributions">Contributions</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:tamizh88@gmail.com" title="Email">Email</a>
		
		
		
		
			<a class="twitter" href="http://twitter.com/tamizhvendan" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/tamizhvendan" title="GitHub">GitHub</a>
		
		
			<a class="coderwall" href="https://coderwall.com/tamizhvendan" title="Coderwall">Coderwall</a>
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="http://feeds.feedburner.com/tamizhvendan-blog" title="RSS">RSS</a>
		
	</div>
</nav>
<nav id="book-cover" style="margin-top:32px">
	<a href="http://products.tamizhvendan.in/fsharp-applied">
	<img class="center" src="/images/fsharp_applied_cover.jpg" width="160">
</a>
</nav>
<nav id="tag-cloud">
	<section>
    <!-- <h3>Tag Cloud</h3>
    <span id="tag-cloud"><a href='/blog/categories/asp-dot-net-mvc' style='font-size: 141.73913043478262%'>asp.net mvc</a> <a href='/blog/categories/c-number' style='font-size: 110.43478260869566%'>c#</a> <a href='/blog/categories/craftsmanship' style='font-size: 115.65217391304348%'>craftsmanship</a> <a href='/blog/categories/entity-framework' style='font-size: 113.04347826086956%'>entity framework</a> <a href='/blog/categories/fsharp' style='font-size: 160.0%'>fsharp</a> <a href='/blog/categories/functional-programming' style='font-size: 120.86956521739131%'>functional-programming</a> <a href='/blog/categories/javascript' style='font-size: 110.43478260869566%'>javascript</a> <a href='/blog/categories/programming' style='font-size: 115.65217391304348%'>programming</a> <a href='/blog/categories/suave' style='font-size: 113.04347826086956%'>suave</a> <a href='/blog/categories/unit-testing' style='font-size: 113.04347826086956%'>unit testing</a> </span> -->
</section>
</nav>


</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-03-02T12:30:33+05:30" data-updated="true" itemprop="datePublished">Mar 2<sup>nd</sup>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/fsharp/'>fsharp</a>, <a class='category' href='/blog/categories/rop/'>rop</a>


</div>
		
			<span class="comments"><a href="/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/" itemprop="url">Step-7 Validation and Error Handling Using ROP</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<blockquote>
  <p>This is step 7 of my blog series on <a href="/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="/blog/2015/02/04/step-6-authentication-using-owin-middleware-and-asp-dot-net-identity/">last blog post</a> we have seen how to register a new user using the Asp.Net Identity Management framework. Validating the incoming data before updating the backend datastore and handling error while saving are typical tasks in a web application. In this blog post we are going to see how to achieve these things in a web application written in fsharp. As mentioned in the last blog post we will be adding validation logic for new user registration using <a href="http://fsharpforfunandprofit.com/rop/">Railway oriented Programming</a> aka <em>ROP</em>.</p>

<h3 id="cleanup">Cleanup</h3>

<p>Before adding the validation,  let’s do some cleanup and make it ready for adding validation. </p>

<p>Create a new source file <code>UserStorage</code> in the <strong>Identity</strong> project and move the user manager creation logic from <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/6/Web/MvcInfrastructure.fs#L15-L20">MvcInfrastructure</a> to here.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">UserStorage</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">createUserManager</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userStore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserStore</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">UserDbContext</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userStore</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userValidator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserValidator</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userManager</span><span class="o">)</span>
</span><span class="line">    <span class="n">userValidator</span><span class="o">.</span><span class="n">AllowOnlyAlphanumericUserNames</span> <span class="o">&lt;-</span> <span class="k">false</span>
</span><span class="line">    <span class="n">userManager</span><span class="o">.</span><span class="n">UserValidator</span> <span class="o">&lt;-</span> <span class="n">userValidator</span>
</span><span class="line">    <span class="n">userManager</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Create a Request record type in <code>Users</code> that represents the request for creating a new user</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CreateUserRequest</span> <span class="o">=</span> <span class="o">{</span><span class="n">Name</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Password</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Email</span> <span class="o">:</span> <span class="kt">string</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then move the user creation logic from Authentication Controller’s <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/6/Web/Controllers/AuthenticationController.fs#L62-L65">Register action method</a> to <code>UserStorage</code> and update it to use <code>CreateUserRequest</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">createUser</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">,</span>
</span><span class="line">                      <span class="n">UserName</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">,</span>
</span><span class="line">                      <span class="n">Email</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">userManager</span><span class="o">.</span><span class="n">Create</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Finally, update the <code>Register</code> action method in <code>AuthenticationController</code> to use the above function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">createUserRequest</span> <span class="o">:</span> <span class="n">CreateUserRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span>
</span><span class="line">    <span class="n">Email</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span><span class="o">;</span>
</span><span class="line">    <span class="n">Password</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Password</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userCreateResult</span> <span class="o">=</span> <span class="nn">Users</span><span class="p">.</span><span class="n">createUser</span> <span class="n">userManager</span> <span class="n">createUserRequest</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">userCreateResult</span><span class="o">.</span><span class="n">Succeeded</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="n">userCreateResult</span><span class="o">.</span><span class="n">Errors</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">iter</span><span class="o">(</span><span class="k">fun</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">err</span><span class="o">))</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">registerViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With this we are wrapping the cleanup work and all set for adding validation.</p>

<h3 id="adding-validation">Adding Validation</h3>

<p>The first step in ROP is defining the “two tracks”. The track <code>Success</code> represents a successful operation (here its validation) and the other track <code>Failure</code> represents the failure while executing an operation. Usually these “two tracks” will be defined using a discriminated union.</p>

<p>Create a source file <code>Rop</code> in the <strong>Identity</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Rop</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">Error</span> <span class="o">=</span> <span class="o">{</span><span class="n">Property</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Message</span> <span class="o">:</span> <span class="kt">string</span><span class="o">}</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">Result</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Success</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">a</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Failure</span> <span class="k">of</span> <span class="n">Error</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Error</code> type provides the metadata associated with the error.</p>

<p>Let’s start writing validation rules from validating Name. Create a source file <code>NameValidation</code> in <strong>Identity</strong> project and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">NameValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameEmptiness</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span>
</span><span class="line">          <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span> <span class="o">&lt;&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">Empty</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Name&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Name is required&quot;</span><span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameLength</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">        <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Name&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Name should not contain more than 50 characters&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Hope these rules are self-explanatory. We are just validating the name for emptiness and length, and based on the result we are returning either the <code>Success</code> track or <code>Failure</code> track.</p>

<p>Next, add validation rules for Password. Similar to Name Validation add a source file with the name <code>PasswordValidation</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">PasswordValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordEmptiness</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span>
</span><span class="line">          <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span> <span class="o">&lt;&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">Empty</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Password&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Password is required&quot;</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordLength</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Password&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Password should not contain more than 10 characters&quot;</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordStrength</span>  <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">specialCharacters</span> <span class="o">=</span> <span class="o">[</span> <span class="s">&quot;*&quot;</span><span class="o">;</span> <span class="s">&quot;&amp;&quot;</span><span class="o">;</span> <span class="s">&quot;%&quot;</span><span class="o">;</span> <span class="s">&quot;$&quot;</span> <span class="o">]</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">hasSpecialCharacters</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="n">String</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="n">specialCharacters</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">exists</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">errorMessage</span> <span class="o">=</span>
</span><span class="line">      <span class="s">&quot;Password should contain atleast one of the special characters &quot;</span>
</span><span class="line">        <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">Join</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">,</span> <span class="n">specialCharacters</span><span class="o">)</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="n">hasSpecialCharacters</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="n">errorMessage</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In addition to the two validation rules that we have seen in <code>NameValidation</code> here we have added one more validation to verify the presence of special characters in the <code>Password</code>.</p>

<p>There is a pattern in all the validation rules that we have seen so far. </p>

<p><img class="center" src="/images/fsharp_phonecat/step_7/validation_pattern.png" width="450" height="450" /></p>

<p>Let’s extract this pattern out of these validation rules and reduce the lines of code!</p>

<p>Create a new source file <code>Validation</code> and add the write this pattern as a function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Validation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validate</span> <span class="n">isValid</span> <span class="n">property</span> <span class="n">message</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="n">isValid</span> <span class="n">createUserRequest</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span><span class="n">Property</span> <span class="o">=</span> <span class="n">property</span><span class="o">;</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">message</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>validate</code> function represents the outer box of the above diagram which takes four inputs</p>

<ul>
  <li>A function to validate the createUserRequest <code>isValid</code> which has the signature
<code>'a -&gt; bool</code> that represents the validation rule</li>
  <li>A string to show which property is invalid in the error <code>property</code></li>
  <li>A string representing the error <code>message</code></li>
  <li>The last is the incoming userCreateRequest <code>createUserRequest</code></li>
</ul>

<p><em>Note: Property and Message parameters are not shown in the diagram just to express the pattern clearly</em></p>

<p>We also need a small utility function to check the emptiness of the string. So add it in <code>Validation</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">isNonEmptyString</span> <span class="n">str</span> <span class="o">=</span> <span class="n">str</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span> <span class="n">str</span> <span class="o">&lt;&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">Empty</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With these functions in place we can refactor the validation rules that we written before.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">NameValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameEmptiness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isNonEmptyString</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Name&quot;</span>
</span><span class="line">      <span class="s">&quot;Name is required&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameLength</span>  <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Name&quot;</span>
</span><span class="line">      <span class="s">&quot;Name should not contain more than 50 characters&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">PasswordValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordEmptiness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isNonEmptyString</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="s">&quot;Password is required&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordLength</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="s">&quot;Password should not contain more than 10 characters&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">hasSpecialCharacters</span> <span class="n">specialCharacters</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="n">String</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">specialCharacters</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">exists</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordStrength</span>  <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">specialCharacters</span> <span class="o">=</span> <span class="o">[</span> <span class="s">&quot;*&quot;</span><span class="o">;</span> <span class="s">&quot;&amp;&quot;</span><span class="o">;</span> <span class="s">&quot;%&quot;</span><span class="o">;</span> <span class="s">&quot;$&quot;</span> <span class="o">]</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">errorMessage</span> <span class="o">=</span>
</span><span class="line">      <span class="s">&quot;Password should contain atleast one of the special characters &quot;</span>
</span><span class="line">        <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">Join</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">,</span> <span class="n">specialCharacters</span><span class="o">)</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="n">hasSpecialCharacters</span> <span class="n">specialCharacters</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="n">errorMessage</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Much cleaner than the previous version, isn’t it?</p>

<p>The final validation is Email validation. It is very similar to the other validations that we have seen so far. One extra validation is verifying the uniqueness of the email id being used to register.</p>

<p>Create a new source file <code>EmailValidation</code> and add the validations</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">EmailValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">isUniqueEmailAddr</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">emailAddr</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">FindByName</span><span class="o">(</span><span class="n">emailAddr</span><span class="o">)</span>
</span><span class="line">    <span class="n">user</span> <span class="o">=</span> <span class="k">null</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">isValidEmailAddress</span> <span class="n">emailAddr</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">emailAddrRegex</span> <span class="o">=</span>
</span><span class="line">      <span class="s">@&quot;\A(?:[a-z0-9!#$%&amp;&#39;*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&amp;&#39;*+/=?^_`{|}~-]+)&quot;</span> <span class="o">+</span>
</span><span class="line">        <span class="s">&quot;*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?</span><span class="err">\</span><span class="s">.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?)</span><span class="err">\</span><span class="s">Z&quot;</span>
</span><span class="line">    <span class="nn">Regex</span><span class="p">.</span><span class="n">IsMatch</span><span class="o">(</span><span class="n">emailAddr</span><span class="o">,</span> <span class="n">emailAddrRegex</span><span class="o">,</span> <span class="nn">RegexOptions</span><span class="p">.</span><span class="n">IgnoreCase</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateEmailEmptiness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isNonEmptyString</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Email&quot;</span>
</span><span class="line">      <span class="s">&quot;Email is required&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateEmailUniqueness</span> <span class="n">isUniqueEmailAddr</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isUniqueEmailAddr</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Email&quot;</span>
</span><span class="line">      <span class="s">&quot;Email address already exists&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateEmailCorrectness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isValidEmailAddress</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Email&quot;</span>
</span><span class="line">      <span class="s">&quot;Email address is invalid&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="putting-all-the-validations-together">Putting all the validations together</h3>

<p>So far we have seen individual property validation rules. It’s time to put all these pieces together and validate the <code>CreateUserRequest</code> as a whole.</p>

<p>Create a source file <code>UserValidation</code> and update it as below</p>

<p><img src="/images/fsharp_phonecat/step_7/uservalidation_match.png" /></p>

<p>Wait.. Wait.. I know how do you feel here.. It’s too much code! Can we do it in a better way? </p>

<h3 id="using-railway-oriented-programming-rop">Using Railway Oriented Programming (ROP)</h3>

<p>Thanks to ROP, we can make the mighty code smaller and more readable. I am going ahead with an assumption that you are aware of ROP. In case if you are not aware of it then watch this <a href="http://vimeo.com/97344498">excellent presentation</a> by <a href="https://twitter.com/ScottWlaschin">Scott Wlaschin</a></p>

<p><img class="center" src="/images/fsharp_phonecat/step_7/bind_function.png" width="350" height="500" /></p>

<p>The crux of ROP is the bind function which composes two functions where the output type of one function is not matching with that of the input. If you want to know more this bind function, do visit this <a href="http://adit.io./posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html">awesome blog post</a> by <a href="https://twitter.com/_egonschiele">Aditya</a>. In this blog post he explains about the bind function under the title <strong>Monads</strong></p>

<p>Let’s start by adding this bind function in the module <code>Rop</code> that we have already created.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">bind</span> <span class="n">f1</span> <span class="n">f2</span> <span class="n">x</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">f1</span> <span class="n">str</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Success</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f2</span> <span class="n">x</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Failure</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">Failure</span> <span class="n">err</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">inline</span> <span class="o">(&gt;&gt;=)</span> <span class="n">f1</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">bind</span> <span class="n">f1</span> <span class="n">f2</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The bind function here calls the function <code>f1</code> with the given input <code>x</code> if it succeeds, then executes the second function <code>f2</code> with <code>x</code>. In case if the execution of <code>f1</code> resulted in failure then it just passes without executing the second function. </p>

<p>The infix operator <code>&gt;&gt;=</code> is an alias of bind function. </p>

<p>With the help of this bind function, we can rewrite the <code>validateCreateUserRequest</code> function in a better way as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">UserValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validateCreateUserRequest</span> <span class="n">userManager</span>  <span class="o">=</span>
</span><span class="line">      <span class="n">validateEmailEmptiness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateEmailCorrectness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateEmailUniqueness</span> <span class="o">(</span><span class="n">isUniqueEmailAddr</span> <span class="n">userManager</span><span class="o">)</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateNameEmptiness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateNameLength</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validatePasswordEmptiness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validatePasswordLength</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validatePasswordStrength</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It’s awesome! Isn’t it? If you are still wondering what’s happening here! Watch the Scott’s presentation one more time.</p>

<h3 id="adding-validation-before-saving">Adding validation before saving</h3>

<p>Now we have the validation infrastructure in place. So, let’s go ahead and add it before creating a new user in the backend. As part of this refactoring we are also going to do error handling of new user creation. </p>

<p>Create a new private function in <code>UserStorage</code> to create a new user with error handling</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">createUser&#39;</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">  <span class="k">try</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">,</span>
</span><span class="line">                        <span class="n">UserName</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">,</span>
</span><span class="line">                        <span class="n">Email</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">identityResult</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Create</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">identityResult</span><span class="o">.</span><span class="n">Succeeded</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">errors</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s">&quot;,&quot;</span> <span class="n">identityResult</span><span class="o">.</span><span class="n">Errors</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="n">errors</span><span class="o">}</span>
</span><span class="line">  <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;An unexpected error happened while creating new user&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Like validation rules defined before this new <code>createUser'</code> function is also outputs “two tracks”, Success if the user creation is successful others it outputs Failure. Because of this change in function signature <br />
(<code>UserManager&lt;User&gt; -&gt; CreateUserRequest -&gt; Result&lt;CreateUserRequest&gt;</code>) we can fit this easily into the bind function.</p>

<p>Modify the existing <code>CreateUser</code> function to use this</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">createUser</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">      <span class="n">validateCreateUserRequest</span> <span class="n">userManager</span> <span class="o">&gt;&gt;=</span> <span class="n">createUser&#39;</span> <span class="n">userManager</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Thanks to <a href="http://fsharpforfunandprofit.com/posts/partial-application/">Partial application</a> we have created new functions on the fly by passing only the partial parameters (<code>UserManager</code> in this case) and make it fit with less code. </p>

<p>Since we have changed the signature of the <code>createUser</code> function from <code>UserManager&lt;User&gt; -&gt; CreateUserRequest -&gt; IdentityResult</code> to <code>UserManager&lt;User&gt; -&gt; CreateUserRequest -&gt; Result&lt;CreateUserRequest&gt;</code> we need to change the <code>Register</code> action method in the <code>AuthenticationController</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">createUserRequest</span> <span class="o">:</span> <span class="n">CreateUserRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span>
</span><span class="line">    <span class="n">Email</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span><span class="o">;</span>
</span><span class="line">    <span class="n">Password</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Password</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">match</span> <span class="nn">UserStorage</span><span class="p">.</span><span class="n">createUser</span> <span class="n">userManager</span> <span class="n">createUserRequest</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Failure</span> <span class="n">error</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">Property</span><span class="o">,</span> <span class="n">error</span><span class="o">.</span><span class="n">Message</span><span class="o">)</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">registerViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Success</span> <span class="n">createUserRequest&#39;</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Find</span><span class="o">(</span><span class="n">createUserRequest&#39;</span><span class="o">.</span><span class="n">Email</span><span class="o">,</span> <span class="n">createUserRequest&#39;</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s it, we are ready to go!</p>

<h3 id="summary">Summary</h3>

<p>In this blog post we have seen how to add validations and error handling in fsharp using ROP. Though it is little hard to get this kind of functional thinking, it offers a great deal of expressiveness and flexibility to your codebase. Just like any other skills if you practice it for quite time you can also master it. You can find the source code associated with this step in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/7">github repository</a></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-02-04T17:24:22+05:30" data-updated="true" itemprop="datePublished">Feb 4<sup>th</sup>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/asp-dot-net-identity/'>asp.net-identity</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>, <a class='category' href='/blog/categories/owin/'>owin</a>


</div>
		
			<span class="comments"><a href="/blog/2015/02/04/step-6-authentication-using-owin-middleware-and-asp-dot-net-identity/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/02/04/step-6-authentication-using-owin-middleware-and-asp-dot-net-identity/" itemprop="url">Step-6 Authentication Using Owin Authentication Middleware and ASP.NET Identity</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<blockquote>
  <p>This is step 6 of my blog series on <a href="/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec/">last blog post</a> we have added an interactive feature to search phones and in this blog post we are going to add authentication to our PhoneCat application using Owin Authentication Middleware and ASP.NET identity.</p>

<p>In the first half of this blog post we are going to see how to implement a new user registration workflow </p>

<p><img src="/images/fsharp_phonecat/step_6/registration_workflow.png" /></p>

<p>And in the second half, we are going to see how to do authentication using the registered login credentials</p>

<p><img src="/images/fsharp_phonecat/step_6/login_workflow.png" /></p>

<h3 id="owin-authentication-middleware-in-brief">Owin Authentication Middleware in brief</h3>

<p>In the <a href="https://msdn.microsoft.com/en-us/magazine/dn451439.aspx">Owin Specification</a>, a middleware access the request before it reaches the underlying web framework. You can view the authentication middleware as gate keeper who checks the incoming request, if it is authenticated it let the request to go through the other middlewares in the pipeline else it bypasses the pipeline and take a different route (usually redirecting to the login page)</p>

<p>In the blog post we are going to use cookie based authentication middleware which is similar to the <a href="https://msdn.microsoft.com/en-us/library/7t6b43z4%28v=vs.140%29.aspx">Asp.Net Forms Authentication</a> and it also supports <a href="https://msdn.microsoft.com/en-us/library/system.security.claims.claim(v=vs.110).aspx">Claims</a>.</p>

<p>Another appreciable feature in Owin it is upto us on how to validate the incoming user credentials. We can plug it to any external authentication providers like Google, Facebook, etc., or using Active Directory or Asp.Net Identity. Here we are going to validate the user credentials using <a href="http://odetocode.com/blogs/scott/archive/2013/11/25/asp-net-core-identity.aspx">Asp.Net Identity framework</a> which provides the required interfaces for handling the authentication and <a href="http://odetocode.com/blogs/scott/archive/2014/01/03/asp-net-identity-with-the-entity-framework.aspx">Entity Framework Identity</a> which provides the concrete implementations for this Identity interfaces.</p>

<h3 id="setting-up-the-infrastructure">Setting up the infrastructure</h3>

<p>Create a new F# class library project with the name <code>Identity</code> and install the Microsoft <a href="https://www.nuget.org/packages/Microsoft.AspNet.Identity.EntityFramework/">AspNet.Identity.EntityFramework</a> nuget package which provides a pluggable data store for the user identity management using Entity Framework.</p>

<p>Then add a source file in the <code>Identity</code> project with the name <code>User</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">open</span> <span class="nn">Microsoft.AspNet.Identity.EntityFramework</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AllowNullLiteral</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">User</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">IdentityUser</span><span class="bp">()</span>
</span><span class="line">  <span class="k">member</span> <span class="k">val</span> <span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="k">with</span> <span class="n">get</span><span class="o">,</span> <span class="n">set</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">UserDbContext</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">IdentityDbContext</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="s">&quot;IdentityConnection&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>IdentityUser</code> represents the default implementation of <a href="https://msdn.microsoft.com/en-us/library/microsoft.aspnet.identity.iuser%28v=vs.108%29.aspx">IUser</a> interface which provides the basic properties for a user. We can extend it by adding our custom properties. Here we have added a custom property called <code>Name</code> which represents the name of the user.</p>

<p>The <a href="https://msdn.microsoft.com/en-us/library/ee353608.aspx">AllowNullLiteral</a> attribute is one of the feature in F# which explicitly make a type to allow null as one of its value. F# by default doesn’t support null value for its types and the beauty is you will get a compiler error if you assign null to an identifier! Pretty cool isn’t it? No Null Exception, <a href="http://www.infoq.com/presentations/Null-References-The-Billion-Dollar-Mistake-Tony-Hoare">No Billion Dollar Mistake</a>! Then why we are allowing it explicitly here. Well, it has been added here for a reason and I will reveal it later in this blog post</p>

<p>The <code>IdentityDbContext</code> represents the data store abstraction of Identity entities like Users, Roles, Claims and Logins. The <code>UserDbContext</code> is just a subclass of <code>IdentityDbContext</code> which tells Entity Framework to use the connection string name <code>IdentityConnection</code></p>

<h3 id="setting-up-user-registration">Setting up User Registration</h3>

<p>With all the needed infrastructure in place its time to do the actual work and lets start with adding a provision for registering new user.</p>

<p>In the <code>Web</code> project add the reference to the <code>Identity</code> project and install the following nuget packages</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Microsoft.Owin.Security.Cookies
</span><span class="line">Microsoft.Owin.Host.SystemWeb
</span><span class="line">Microsoft.AspNet.Identity.EntityFramework
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Create a controller with the name <code>AuthenticationController</code> in the <code>Web</code> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">CLIMutable</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">RegisterViewModel</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Email</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Password</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">AuthenticationController</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="bp">()</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>AuthenticationController</code> depends on <code>UserManager</code> to take care of managing users. <a href="https://msdn.microsoft.com/en-us/library/dn613290%28v=vs.108%29.aspx">UserManager</a> is an abstraction defined in the <strong>AspNet.Identity</strong> assembly. It provides various APIs to work with the underlying user datastore. </p>

<p>As the name indicates <code>RegisterViewModel</code> represents the view model for Registration View. The <a href="https://msdn.microsoft.com/en-us/library/hh289724.aspx">CLIMutable</a> attribute creates a default constructor and “getters and setters” for all the properties of a record type when it is compiled to IL and here it makes the <code>RegisterViewModel</code> compatible with the Asp.Net <a href="https://msdn.microsoft.com/en-us/library/system.web.mvc.defaultmodelbinder(v=vs.118).aspx">DefaultModelBinder</a> which expects the types to have default constructor to bind the incoming request.</p>

<p>The action method <code>Register</code> simply renders the Register View. This view not created yet so lets add it. Create a cshtml file with the name <em>Register.cshtml</em> in the directory <strong>Views/Authentication</strong>. </p>

<p>This is a strongly typed view of type <code>RegisterViewModel</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="html"><span class="line">@model PhoneCat.Web.Controllers.RegisterViewModel
</span><span class="line">
</span><span class="line"><span class="nt">&lt;h3&gt;</span>Register New User<span class="nt">&lt;/h3&gt;</span>
</span><span class="line">
</span><span class="line">@using (Html.BeginForm(&quot;Register&quot;, &quot;Authentication&quot;, FormMethod.Post))
</span><span class="line">{
</span><span class="line">  @Html.AntiForgeryToken()
</span><span class="line">  @Html.ValidationSummary()
</span><span class="line">
</span><span class="line">  @Html.TextBoxFor(m =&gt; m.Name)
</span><span class="line">
</span><span class="line">  @Html.TextBoxFor(m =&gt; m.Email)
</span><span class="line">
</span><span class="line">  @Html.PasswordFor(m =&gt; m.Password)
</span><span class="line">
</span><span class="line">  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span><span class="nt">&gt;</span>Create<span class="nt">&lt;/button&gt;</span>
</span><span class="line">}
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p><em>Note: I’ve intentionally ignored the bootstrap css form styles here to keep the code snippet less noisy</em></p>

<p><img src="/images/fsharp_phonecat/step_6/new_user_registration.png" /></p>

<p>It’s a typical razor view representing the registration screen. For the sake of simplicity I’ve ignored the retype password field. </p>

<p>The next step is handling the new user registration POST request.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Name</span><span class="o">,</span>
</span><span class="line">                      <span class="n">UserName</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span> <span class="o">,</span>
</span><span class="line">                      <span class="n">Email</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userCreateResult</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Create</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">userCreateResult</span><span class="o">.</span><span class="n">Succeeded</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="n">userCreateResult</span><span class="o">.</span><span class="n">Errors</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">iter</span><span class="o">(</span><span class="k">fun</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">err</span><span class="o">))</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">registerViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Add the above action method in the <code>AuthenticationController</code> to create new user. It creates a <code>User</code> object from the <code>RegisterViewModel</code> and use it to create a new user via <code>UserManager</code>. We are using <code>Email</code> as the <code>UserName</code> in the above code snippet</p>

<p>If the user creation is successful, we are redirecting the user to the home page else we are showing the error messages to the user. After we implemented the login we will modify the above logic to sign in after successful registration.</p>

<p>The next task is creation of <code>AuthenticationController</code> instance. Open <code>MvcInfrastructure</code> that we have <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/2/Web/MvcInfrastructure.fs">created in the step-2</a> and update it as below.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">createUserManager</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">UserStore</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">UserDbContext</span><span class="bp">()</span><span class="o">))</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userValidator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserValidator</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userManager</span><span class="o">)</span>
</span><span class="line">  <span class="n">userValidator</span><span class="o">.</span><span class="n">AllowOnlyAlphanumericUserNames</span> <span class="o">&lt;-</span> <span class="k">false</span>
</span><span class="line">  <span class="n">userManager</span><span class="o">.</span><span class="n">UserValidator</span> <span class="o">&lt;-</span> <span class="n">userValidator</span>
</span><span class="line">  <span class="n">userManager</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">    <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="c1">// ... Existing code ...</span>
</span><span class="line">      <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">AuthenticationController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">authenticationController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthenticationController</span><span class="o">(</span><span class="n">createUserManager</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">        <span class="n">authenticationController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">      <span class="c1">// ... Existing code ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>As we are using email as username we need to change the user validator in the <code>UserManager</code> to allow the alphanumeric characters in the username.</p>

<p>The final step is providing the connection string to access the identity database. Open the <strong>Web.config</strong> file and add the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;connectionStrings&gt;</span>
</span><span class="line">    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;IdentityConnection&quot;</span>
</span><span class="line">      <span class="na">connectionString=</span><span class="s">&quot;Data Source=localhost;Initial Catalog=PhoneCatIdentity;Integrated Security=True&quot;</span>
</span><span class="line">      <span class="na">providerName=</span><span class="s">&quot;System.Data.SqlClient&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/connectionStrings&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As we are using Entity Framework’s Code First here, the schema will be generated dynamically when we run the code for the very first time.</p>

<p>That’s it. We have wired up everything to create a new user!</p>

<h3 id="setting-up-user-login">Setting up User Login</h3>

<p>As we are going to use owin <a href="http://blogs.msdn.com/b/webdev/archive/2013/07/03/understanding-owin-forms-authentication-in-mvc-5.aspx">cookies based authentication</a> middleware, the first step to tell the application startup pipeline to use cookie authentication. </p>

<p>Open <code>Startup</code> and update it to support authentication</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Startup</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">configureAuthentication</span> <span class="o">(</span><span class="n">app</span> <span class="o">:</span> <span class="n">IAppBuilder</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">cookieAuthenticationOptions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CookieAuthenticationOptions</span><span class="bp">()</span>
</span><span class="line">    <span class="n">cookieAuthenticationOptions</span><span class="o">.</span><span class="n">AuthenticationType</span> <span class="o">&lt;-</span> <span class="nn">DefaultAuthenticationTypes</span><span class="p">.</span><span class="n">ApplicationCookie</span>
</span><span class="line">    <span class="n">cookieAuthenticationOptions</span><span class="o">.</span><span class="n">LoginPath</span> <span class="o">&lt;-</span> <span class="k">new</span> <span class="n">PathString</span><span class="o">(</span><span class="s">&quot;/authentication/login&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">UseCookieAuthentication</span><span class="o">(</span><span class="n">cookieAuthenticationOptions</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">  <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Configuration</span><span class="o">(</span><span class="n">app</span> <span class="o">:</span> <span class="n">IAppBuilder</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">MapSignalR</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="n">configureAuthentication</span> <span class="n">app</span>
</span><span class="line">    <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>AuthenticationType</code> is an identifier to distinguish between different authentication middlewares and the <code>LoginPath</code> is the url to the Login Page which will be used to redirect the unauthorized requests.</p>

<p>After setting up cookie authentication, like we did for new user registration, we are going to create a view to enable the user to login.</p>

<p>Add the <code>Login</code> action method in the <code>AuthenticationController</code> and also create <code>LoginViewModel</code> </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">CLIMutable</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">LoginViewModel</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Email</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Password</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">AuthenticationController</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">  <span class="c1">// ... Existing code ...  </span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Login</span><span class="bp">()</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>and create <code>Login</code> view in the <strong>Authentication\Login</strong> directory</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="html"><span class="line">@model PhoneCat.Web.Controllers.LoginViewModel
</span><span class="line">
</span><span class="line"><span class="nt">&lt;h3&gt;</span>Login<span class="nt">&lt;/h3&gt;</span>
</span><span class="line">@using (Html.BeginForm(&quot;Login&quot;, &quot;Authentication&quot;, FormMethod.Post))
</span><span class="line">{
</span><span class="line">  @Html.AntiForgeryToken()
</span><span class="line">  @Html.ValidationSummary()
</span><span class="line">
</span><span class="line">  @Html.TextBoxFor(m =&gt; m.Email)
</span><span class="line">
</span><span class="line">  @Html.PasswordFor(m =&gt; m.Password)
</span><span class="line">
</span><span class="line">  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>Log in<span class="nt">&lt;/button&gt;</span>
</span><span class="line">}
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p><img src="/images/fsharp_phonecat/step_6/login.png" /></p>

<p>The next step is the crux of this blog post. Challenging the incoming user login credentials against its corresponding registered one.</p>

<p>We will be using <code>UserManager</code>’s following methods to achieve it.</p>

<ul>
  <li>
    <p><a href="https://msdn.microsoft.com/en-us/library/dn497475(v=vs.108).aspx">Find</a> - Returns a user with the specified username and password or null if there is no match (C# needs <a href="http://fsharpforfunandprofit.com/posts/the-option-type/">Option</a> type badly!). In the beginning of the blog post I’ve mentioned you that I will talk about why we are using <code>AllowNullLiteral</code> attribute for the <code>User</code> class. As you see here <code>Find</code> method returns <code>null</code> if the user is not available! So, As per this definition <code>null</code> is valid value for <code>User</code> class.</p>
  </li>
  <li>
    <p><a href="https://msdn.microsoft.com/en-us/library/dn497467(v=vs.108).aspx">CreateIdentity</a> - Creates the Claim Identity representing the user. We need this claim identity to signin and also to pass around the claim details. </p>
  </li>
</ul>

<p>Both of the above methods are having their async counterparts. But for the sake of simplicity I’m ignoring it. May be it can be a exercise for you to figure it out!</p>

<p>Let’s add some utility function to handle finding the user and signing in</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">signin</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">(</span><span class="n">request</span> <span class="o">:</span> <span class="n">HttpRequestBase</span><span class="o">)</span> <span class="n">user</span>  <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">identity</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">CreateIdentity</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="nn">DefaultAuthenticationTypes</span><span class="p">.</span><span class="n">ApplicationCookie</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">authManager</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GetOwinContext</span><span class="bp">()</span><span class="o">.</span><span class="n">Authentication</span>
</span><span class="line">  <span class="n">identity</span><span class="o">.</span><span class="n">AddClaim</span><span class="o">(</span><span class="k">new</span> <span class="n">Claim</span><span class="o">(</span><span class="nn">ClaimTypes</span><span class="p">.</span><span class="n">GivenName</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="n">Name</span><span class="o">))</span>
</span><span class="line">  <span class="n">authManager</span><span class="o">.</span><span class="n">SignIn</span><span class="o">(</span><span class="n">identity</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">tryFindUser</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">email</span> <span class="n">password</span>  <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Find</span><span class="o">(</span><span class="n">email</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span>
</span><span class="line">  <span class="k">if</span> <span class="n">user</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="k">then</span> <span class="n">Some</span> <span class="n">user</span> <span class="k">else</span> <span class="n">None</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Since we are using Email as the UserName here in this example, we need to have a specific claim to pass around the Name of the user. That’s what we are doing in the <code>signin</code> method. Later we will be using this claim to display the user name in the header of the page.</p>

<p>Great! Now its time to handle handle Login POST request. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Login</span><span class="o">(</span><span class="n">loginViewModel</span> <span class="o">:</span> <span class="n">LoginViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">tryFindUser</span> <span class="n">userManager</span> <span class="n">loginViewModel</span><span class="o">.</span><span class="n">Email</span> <span class="n">loginViewModel</span><span class="o">.</span><span class="n">Password</span>  <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="s">&quot;Invalid Email or Password&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">loginViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">user</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Login</code> action method just tries to find the user using given credentials. If the user is available, signin to the application using his credentials and redirect to the home page else show login error to the user.</p>

<p>We can add this same signin behavior after successful user registration too.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// ... Existing Code ...</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">userCreateResult</span><span class="o">.</span><span class="n">Succeeded</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="c1">// ... Existing Code ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Since <code>UserManager</code> is an <code>IDisposable</code>. It’s good practices to dispose it after using. So, Override <code>Dispose</code> method in <code>AuthenticationController</code> and dispose it. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">Dispose</span><span class="o">(</span><span class="n">disposing</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">if</span> <span class="n">disposing</span> <span class="k">then</span>
</span><span class="line">    <span class="n">userManager</span><span class="o">.</span><span class="n">Dispose</span><span class="bp">()</span>
</span><span class="line">  <span class="k">base</span><span class="o">.</span><span class="n">Dispose</span><span class="o">(</span><span class="n">disposing</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The final pending work is displaying the user name in the header after successful login. Open <strong>Layout.cshtml</strong> add the following lines</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="c">&lt;!-- ... Existing code ... --&gt;</span>
</span><span class="line"><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav navbar-nav navbar-right top-nav&quot;</span><span class="nt">&gt;</span>
</span><span class="line">
</span><span class="line">  @if (Request.IsAuthenticated)
</span><span class="line">  {
</span><span class="line">    var identity = User.Identity as ClaimsIdentity;
</span><span class="line">    var name = identity.FindFirst(ClaimTypes.GivenName).Value;
</span><span class="line">    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
</span><span class="line">      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span> <span class="na">aria-expanded=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-user&quot;</span><span class="nt">&gt;&lt;/i&gt;</span>@name
</span><span class="line">      <span class="nt">&lt;/a&gt;</span>
</span><span class="line">      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;li&gt;</span>
</span><span class="line">          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;@Url.Action(&quot;</span><span class="na">Logout</span><span class="err">&quot;,&quot;</span><span class="na">Authentication</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class="line">            <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-fw fa-power-off&quot;</span><span class="nt">&gt;&lt;/i&gt;</span> Log Out
</span><span class="line">          <span class="nt">&lt;/a&gt;</span>
</span><span class="line">        <span class="nt">&lt;/li&gt;</span>
</span><span class="line">      <span class="nt">&lt;/ul&gt;</span>
</span><span class="line">    <span class="nt">&lt;/li&gt;</span>
</span><span class="line">  }
</span><span class="line">  else
</span><span class="line">  {
</span><span class="line">    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
</span><span class="line">      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span> <span class="na">aria-expanded=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-user&quot;</span><span class="nt">&gt;&lt;/i&gt;</span> Guest
</span><span class="line">      <span class="nt">&lt;/a&gt;</span>
</span><span class="line">      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;li&gt;</span>
</span><span class="line">          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;@Url.Action(&quot;</span><span class="na">Login</span><span class="err">&quot;,&quot;</span><span class="na">Authentication</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class="line">            <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-fw fa-bank&quot;</span><span class="nt">&gt;&lt;/i&gt;</span> Log In
</span><span class="line">          <span class="nt">&lt;/a&gt;</span>
</span><span class="line">        <span class="nt">&lt;/li&gt;</span>
</span><span class="line">        <span class="nt">&lt;li&gt;</span>
</span><span class="line">          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;@Url.Action(&quot;</span><span class="na">Register</span><span class="err">&quot;,&quot;</span><span class="na">Authentication</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class="line">            <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-fw fa-laptop&quot;</span><span class="nt">&gt;&lt;/i&gt;</span>Register
</span><span class="line">          <span class="nt">&lt;/a&gt;</span>
</span><span class="line">        <span class="nt">&lt;/li&gt;</span>
</span><span class="line">      <span class="nt">&lt;/ul&gt;</span>
</span><span class="line">    <span class="nt">&lt;/li&gt;</span>
</span><span class="line">  }
</span><span class="line"><span class="nt">&lt;/ul&gt;</span>
</span><span class="line"><span class="c">&lt;!-- ... Existing code ... --&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="adding-logout">Adding Logout</h3>

<p>Adding logout is very simple and straight forward. All we need to do is just invoke the Owin Authentication Manager’s <code>SignOut</code> method. Create an action method in <code>AuthenticationController</code> to handle it</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Logout</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">authManager</span> <span class="o">=</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">GetOwinContext</span><span class="bp">()</span><span class="o">.</span><span class="n">Authentication</span>
</span><span class="line">  <span class="n">authManager</span><span class="o">.</span><span class="n">SignOut</span><span class="o">(</span><span class="nn">DefaultAuthenticationTypes</span><span class="p">.</span><span class="n">ApplicationCookie</span><span class="o">)</span>
</span><span class="line">  <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="summary">Summary</h3>

<p>The interoperability offered by F# to integrate with the existing C# libraries is very seamless and I hope you have got it too! You can find the source code in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/6">github</a> as usual. In the next blog post We will see how to add validations in the User Registration. Stay tuned!</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-01-18T19:52:26+05:30" data-updated="true" itemprop="datePublished">Jan 18<sup>th</sup>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/dsl/'>dsl</a>, <a class='category' href='/blog/categories/fparsec/'>fparsec</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>


</div>
		
			<span class="comments"><a href="/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec/" itemprop="url">Step-5 Advanced Search DSL Using FParsec</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<blockquote>
  <p>This is step 5 of my blog series on <a href="/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In this blog post we are going create an advanced Search <a href="http://en.wikipedia.org/wiki/Domain-specific_language">DSL</a> for searching Phones in the PhoneCat application that we are building in this blog series, using a F# parser combinator library called <a href="http://www.quanttec.com/fparsec/">FParsec</a>. </p>

<p><img src="/images/fsharp_phonecat/step_5/search_results.png" /></p>

<p>As you seen in the screenshot above the DSL that we are going to build will enable us to search phones using three search filters (parameters) <strong>weight</strong>, <strong>screen</strong> and <strong>ram</strong>. The values (value filters) of these search filters can be defined in three ways as <strong>&gt;</strong>(greater than), <strong>-</strong>(range) and <strong>{value}</strong>(actual value itself i.e <em>=</em>). Each of these values should be accompanied with their unit of measures <strong>g</strong>, <strong>inch</strong> and <strong>MB</strong> respectively. For simplicity, I’ve expressed these units in singulars. The <strong>:</strong> symbol is used to separate Search Filter and Value Filter. Multiple filters can be used by seperating thing using the <strong>;</strong> symbol. </p>

<p>The <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract syntax tree (AST)</a> of this external DSL is</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">SearchFilter</span> <span class="o">=</span>
</span><span class="line"><span class="o">|</span> <span class="n">Ram</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line"><span class="o">|</span> <span class="n">Weight</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line"><span class="o">|</span> <span class="n">Screen</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">ValueFilter</span> <span class="o">=</span>
</span><span class="line"><span class="o">|</span> <span class="n">Value</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line"><span class="o">|</span> <span class="n">GreaterThan</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line"><span class="o">|</span> <span class="n">Range</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">*</span> <span class="kt">float</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">filters</span> <span class="o">:</span> <span class="o">(</span><span class="n">SearchFilter</span> <span class="o">*</span> <span class="n">ValueFilter</span><span class="o">)</span> <span class="kt">list</span> <span class="o">=</span> <span class="c1">// ... </span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>FParsec does both <a href="http://en.wikipedia.org/wiki/Lexical_analysis">lexical analysis</a> (converting raw character sequence into meaningful tokens) and <a href="http://en.wikipedia.org/wiki/Parsing">parsing</a> (converting tokens to an AST like the one above). FParsec has been built using pure functions from the ground up and it enable us to create complex parser by combining small parsers (aka <a href="http://programmers.stackexchange.com/questions/117522/what-are-combinators-and-how-are-they-applied-to-programming-projects-practica">combinators</a>). </p>

<h3 id="fpasec-101">FPasec 101</h3>

<p>Lets quickly walk through the basics of FParsec.</p>

<p>In Fparsec all the parsers are of type <code>Parser&lt;'Result,'UserState&gt;</code> . The <code>'Result</code> represents the type of the parser result and the <code>'UserState</code> represents the internal state of the parser. </p>

<p>FParsec offers lot of in-built parser functions which takes F# primitive types and return a parser type for it. </p>

<h4 id="pchar">pchar</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">psearchValueSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;:&#39;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pmultiFiltersSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;;&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>pchar</code> function takes a character and returns a parser (i.e of type <code>Parser&lt;char, 'UserState&gt;</code>) which parses only the given character. </p>

<p>FParsec uses a convention of prefix <strong>p</strong> to define all its parser function and we are also going to use the same to define our custom parser functions.</p>

<h3 id="pstring">pstring</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pram</span> <span class="o">=</span> <span class="n">pstring</span> <span class="s">&quot;ram&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pweight</span> <span class="o">=</span> <span class="n">pstring</span> <span class="s">&quot;weight&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pscreen</span> <span class="o">=</span> <span class="n">pstring</span> <span class="s">&quot;ram&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Like <code>pchar</code> function, the <code>pstring</code> takes a string as its input and return a parser (<code>Parser&lt;string, 'UserState&gt;</code>) that parses only the given string. This parser is case-sensitive. If you want to have a parser which is case-insensitive you can use <code>pstringCI</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pmb</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;MB&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pg</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;g&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pinch</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;inch&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="pfloat">pfloat</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pvalue</span> <span class="o">=</span> <span class="n">pfloat</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I hope by this time you would have been familiar with the FParsec functions. Yes, you are right <code>pfloat</code> parses a floating point and returns the parser for the same. But unlike <code>pchar</code> and <code>pstrig</code> it doesn’t take any input and it can parse any floating point numbers and return the same when we execute the parser. </p>

<h3 id="section">|»</h3>

<p>So far we have seen parsers for the F# primitive types. What about our custom types ? FParsec has an answer for that too using the function (aka operator) <code>|&gt;&gt;</code>. </p>

<p>The signature of <code>|&gt;&gt;</code> function is</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; (a&#39; -&gt; &#39;b) -&gt; Parser&lt;&#39;b, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>i.e this function takes two inputs, a parser of type <code>'a</code> and a function that transform the type <code>'a</code> to <code>'b</code> and return a parser of type <code>'b</code></p>

<p>If you remember the AST that we have defined in the beginning of the post, the search filter has been defined as a discriminated union of type <code>SearchFilter</code>. Each fields <code>Ram</code>, <code>Screen</code>, <code>Weight</code> are being represented in the DSL by their string counterparts <em>“ram”</em>, <em>“screen”</em>, <em>“weight”</em> respectively. We can leverage this <code>|&gt;&gt;</code> function to take care of this data type transformation</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">toLowerCase</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">ToLowerInvariant</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">toSearchFilter</span> <span class="n">str</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">toLowerCase</span> <span class="n">str</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="s">&quot;ram&quot;</span> <span class="o">-&gt;</span> <span class="n">Ram</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="n">Weight</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="s">&quot;screen&quot;</span> <span class="o">-&gt;</span> <span class="n">Screen</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s">&quot;Invalid search filter&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">psearchFilter</span> <span class="n">str</span> <span class="o">=</span> <span class="n">pstring</span> <span class="n">str</span> <span class="o">|&gt;&gt;</span> <span class="n">toSearchFilter</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">pram</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;ram&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pweight</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;weight&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pscreen</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;screen&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>If you see the type of <code>pram</code> it is Parser&lt;SearchFilter, ‘u&gt; i.e Parser for our custom type. The <code>psearchFilter</code> is an utility function which helps in avoiding the code duplication across multiple search filter parser creation.</p>

<h3 id="section-1">».</h3>

<p>I love this function and it represents the beauty of functional programming. This function has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It takes two parsers of same or different types and returns a parser that parses the input using the given two parsers by applying them sequentially and returns a parser with the input type of second parser (The <strong>.</strong> symbol represents which parser to pick)</p>

<p>Lets see this action to understand it more</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">let pgreaterThan = pchar &#39;&gt;&#39; &gt;&gt;. pfloat |&gt;&gt; GreaterThan
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have created parser here for greater than. It parses the string <strong>“&gt;80.2”</strong> (i.e <code>pchar</code> parses the <strong>&gt;</strong> symbol and <code>pfloat</code> parses the number <strong>80.2</strong>. Since we have created it using <code>&gt;&gt;.</code> function, both <code>pchar</code> and <code>pfloat</code> are applied in sequence and it returns a parser of float type) and retrieve the floating number <strong>80.2</strong> when the parser is executed. Then we have applied the <code>|&gt;&gt;</code> function which translate it our custom type <code>GreaterThan</code> that we defined in the AST.</p>

<p>The <code>&gt;&gt;.</code> is much like functional composition done by the <a href="http://en.wikibooks.org/wiki/F_Sharp_Programming/Higher_Order_Functions#The_Composition_Function_.28.3C.3C_operator.29">» function (aka operator)</a> but instead of acting at the function level it acts at the parser level.</p>

<h3 id="section-2">.»</h3>

<p>It is similar to the <code>&gt;&gt;.</code> function but instead of returning a parser with the input type of second parser it returns a parser with the input type of the first parser.</p>

<p>It has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt; -&gt; Parser&lt;&#39;a, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-3">.».</h3>

<p>It is a combination of <code>.&gt;&gt;</code> and <code>&gt;&gt;.</code> i.e Instead of dropping the output of either of the given parsers, it returns a parser which parses the input and returns a parser with the result type as tuple representing the inputs of both of the given parsers.</p>

<p>It has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt; -&gt; Parser&lt;(&#39;a * &#39;c), &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Lets see both <code>.&gt;&gt;</code> and <code>.&gt;&gt;.</code> in action</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">prange</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">.&gt;&gt;</span> <span class="o">(</span><span class="n">pchar</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Range</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>prange</code> parser parses the string “100-200” and returns <code>Range (100, 200)</code>.</p>

<p>The <code>.&gt;&gt;</code> function here dropped the symbol <strong>-</strong> here (output of <code>pchar</code> parser) and the function <code>.&gt;&gt;.</code> picked the output of these parsers and returned a tuple representing the given range.</p>

<p>Now you got why I said I love this function! These tiny functions allow us to create parsers by combining them. If you understand how these tiny functions work and trust me you can create complex parsers even a <a href="http://trelford.com/blog/post/parsecsharp.aspx">C# compiler</a></p>

<h3 id="attempt">attempt</h3>

<p>This function takes parser <code>p</code> and execute it against the input. If it result in <strong>fatal error</strong>, it <a href="http://en.wikipedia.org/wiki/Backtracking">backtracks</a> the parser state to its original state as if that the given input is not being consumed. </p>

<h3 id="choice">choice</h3>

<p>This function takes multiple parsers say <code>p1</code>, <code>p2</code> … <code>pn</code> and execute it against the input in the following order.</p>

<p>Run the parser <code>p1</code> against the input. If the parsing succeed skip the rest of the parsers and return the parser else if it resulted an <strong>non-fatal error</strong>, backtrack the parser state to its original state and try the same with the next parser <code>p2</code>. This continues all the way down to <code>pn</code>.</p>

<p>What is the difference between <a href="http://www.quanttec.com/fparsec/reference/primitives.html#members.Error">Non-Fatal Error</a> and a <a href="http://www.quanttec.com/fparsec/reference/primitives.html#members.FatalError">Fatal Error</a> ?</p>

<p>Well, its closely associated with the internal implementation of FParsec. FParsec implements backtracking with only a “one token look-ahead”. i.e if the parser consumed one input token from the stream, it modifies the internal state and if it fails after that it would result in Fatal Error. Not-Fatal Error occurs when parer error happened without consuming the input. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pgreaterThan</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">GreaterThan</span>
</span><span class="line"><span class="k">let</span> <span class="nv">prange</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">.&gt;&gt;</span> <span class="o">(</span><span class="n">pchar</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Range</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pvalue</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Value</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pvalueFilters</span> <span class="o">=</span> <span class="n">choice</span> <span class="o">[</span><span class="n">pgreaterThan</span><span class="o">;</span> <span class="o">(</span><span class="n">attempt</span> <span class="n">prange</span><span class="o">);</span> <span class="n">pvalue</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>If you seen the AST of the DSL that we are going to implement, the value filters can be any one of greaterThan or range or value. Using <code>choice</code> we have implemented this “either or” parser and also we have leveraged the <code>attempt</code> function to get rid of parser fatal error.</p>

<p>Both <code>prange</code> and <code>value</code>, shares the same first token i.e for “100-200MB” &amp; “100MB”, the first token ‘1’ is same. So while parsing the string “100MB” it starts by consuming the first token ‘1’ from the input sequence. FParsec assumes its a range filter and changes its internal state. By the time it reaches the token ‘M’ in “100MB”, it would result in a fatal error saying <em>Expecting: ‘-‘</em>. As we have used <code>attempt</code> here, it backtracks the parser state back to the token ‘1’ of “100MB” and start parsing using <code>pvalue</code> parser. Its hard to get it first time (I’ve spent close to an hour to figure it out) and I recommend you to spend some quality time in understanding the <a href="http://www.quanttec.com/fparsec/users-guide/parsing-alternatives.html">documentation</a> if you want really want to crack it!</p>

<h3 id="sepby">sepBy</h3>

<p><a href="http://www.quanttec.com/fparsec/reference/primitives.html#members.sepBy">sepBy</a> takes an element parser <code>p1</code> and a separator parser as its input and returns a parser for a list of elements separated by the separators.</p>

<p>It has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a,&#39;u&gt; -&gt; Parser&lt;&#39;b,&#39;u&gt; -&gt; Parser&lt;&#39;a list, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We will be using this function to parse multiple search filters separated by <strong>;</strong></p>

<h3 id="run">run</h3>

<p>The <a href="http://www.quanttec.com/fparsec/reference/charparsers.html#members.run">run function</a> takes a parser and a string as its input and it executes the given parser against the string input and returns a <a href="http://www.quanttec.com/fparsec/reference/charparsers.html#members.ParserResult">ParserResult</a> representing the result.</p>

<h2 id="implementing-the-parser">Implementing the Parser</h2>

<p>We have seen a brief overview of some of the basic building blocks of FParsec. It’s time to pull all these things together and create the complete parser which parses the Search DSL.</p>

<p>Create a source file in the <strong>Domain</strong> project and name it as <code>Search</code>. Then add the AST that we have discussed as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Search</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">SearchFilter</span> <span class="o">=</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Ram</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Weight</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Screen</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">ValueFilter</span> <span class="o">=</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Value</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line">  <span class="o">|</span> <span class="n">GreaterThan</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Range</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">*</span> <span class="kt">float</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The next step is to install the <a href="https://www.nuget.org/packages/FParsec">FParsec Nuget Package</a> in the <strong>Domain</strong> project. After installing it create a source file with the name <code>SearchParser</code> and add a function to parse the filter string as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">SearchParser</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">parseFilter</span> <span class="n">filterStr</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">toLowerCase</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">ToLowerInvariant</span><span class="bp">()</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">toSearchFilter</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">      <span class="o">|</span> <span class="s">&quot;ram&quot;</span> <span class="o">-&gt;</span> <span class="n">Ram</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line">      <span class="o">|</span> <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="n">Weight</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line">      <span class="o">|</span> <span class="s">&quot;screen&quot;</span> <span class="o">-&gt;</span> <span class="n">Screen</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s">&quot;Invalid search filter&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">psearchFilter</span> <span class="n">str</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="n">str</span> <span class="o">|&gt;&gt;</span> <span class="o">(</span><span class="n">toLowerCase</span> <span class="o">&gt;&gt;</span> <span class="n">toSearchFilter</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">psearchValueSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;:&#39;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pmultiFiltersSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;;&#39;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pgreaterThan</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">GreaterThan</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">prange</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">.&gt;&gt;</span> <span class="o">(</span><span class="n">pchar</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Range</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pvalue</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Value</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pvalueFilters</span> <span class="o">=</span> <span class="n">choice</span> <span class="o">[</span><span class="n">pgreaterThan</span><span class="o">;</span> <span class="o">(</span><span class="n">attempt</span> <span class="n">prange</span><span class="o">);</span> <span class="n">pvalue</span><span class="o">]</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">createCompleteFilter</span> <span class="n">psearchfilter</span> <span class="n">puom</span>  <span class="o">=</span>
</span><span class="line">      <span class="n">psearchfilter</span> <span class="o">.&gt;&gt;</span> <span class="n">psearchValueSeperator</span> <span class="o">.&gt;&gt;.</span> <span class="n">pvalueFilters</span> <span class="o">.&gt;&gt;</span> <span class="n">puom</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">pmb</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;MB&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pg</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;g&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pinch</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;inch&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pram</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;ram&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pweight</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;weight&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pscreen</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;screen&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">pramFilter</span> <span class="o">=</span> <span class="n">createCompleteFilter</span> <span class="n">pram</span> <span class="n">pmb</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pweightFilter</span> <span class="o">=</span> <span class="n">createCompleteFilter</span> <span class="n">pweight</span> <span class="n">pg</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pscreenFilter</span> <span class="o">=</span> <span class="n">createCompleteFilter</span> <span class="n">pscreen</span> <span class="n">pinch</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pfilter</span> <span class="o">=</span> <span class="n">choice</span> <span class="o">[</span><span class="n">pramFilter</span><span class="o">;</span><span class="n">pweightFilter</span><span class="o">;</span><span class="n">pscreenFilter</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">parser</span> <span class="o">=</span> <span class="n">sepBy</span> <span class="n">pfilter</span> <span class="n">pmultiFiltersSeperator</span>
</span><span class="line">
</span><span class="line">    <span class="k">match</span> <span class="n">run</span> <span class="n">parser</span> <span class="n">filterStr</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Success</span><span class="o">(</span><span class="n">filters</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="n">Choice1Of2</span><span class="o">(</span><span class="n">filters</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Failure</span><span class="o">(</span><span class="n">err</span><span class="o">,_,_)</span> <span class="o">-&gt;</span> <span class="n">Choice2Of2</span><span class="o">(</span><span class="n">err</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>parseFilter</code> function takes the search filter query from the front end, parses it using the custom parsers that we have built and return the <a href="http://msdn.microsoft.com/en-us/library/ee353439.aspx">Choice type</a>.</p>

<p>The <code>Choice1Of2</code> will contain a list of tuples (SearchFilter * ValueFilter) that represents the strongly typed AST of the given input query.</p>

<p>The <code>Choice2of2</code> will contain the error message in case if there is any parser error happened while parsing the input query.</p>

<h2 id="implementing-phone-search-backend">Implementing Phone Search backend</h2>

<p>With the parser in place, the next step is to building the backend logic of filtering the phones using the filters returned by the parsers</p>

<p>Open the module <code>Search</code> in the <strong>Domain</strong> project and add the following <code>searchPhones</code> function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">searchPhones</span> <span class="n">phones</span> <span class="n">filters</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">hasMetValueFilter</span> <span class="n">toUom</span> <span class="n">valueFilter</span> <span class="n">property</span>  <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">valueFilter</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Value</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">property</span> <span class="o">=</span> <span class="n">toUom</span> <span class="n">x</span>
</span><span class="line">    <span class="o">|</span> <span class="n">GreaterThan</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">property</span> <span class="o">&gt;</span> <span class="n">toUom</span> <span class="n">x</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Range</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">property</span> <span class="o">&gt;=</span> <span class="n">toUom</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">property</span> <span class="o">&lt;=</span> <span class="n">toUom</span> <span class="n">y</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">hasMetSearchFilter</span> <span class="n">filter</span> <span class="n">phone</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">valueFilter</span> <span class="o">=</span> <span class="o">(</span><span class="n">snd</span> <span class="n">filter</span><span class="o">)</span>
</span><span class="line">    <span class="k">match</span> <span class="o">(</span><span class="n">fst</span> <span class="n">filter</span><span class="o">)</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Ram</span> <span class="n">toMB</span> <span class="o">-&gt;</span> <span class="n">hasMetValueFilter</span> <span class="n">toMB</span> <span class="n">valueFilter</span> <span class="n">phone</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">Ram</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Weight</span> <span class="n">toG</span> <span class="o">-&gt;</span> <span class="n">hasMetValueFilter</span> <span class="n">toG</span> <span class="n">valueFilter</span> <span class="n">phone</span><span class="o">.</span><span class="n">Weight</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Screen</span> <span class="n">toInch</span><span class="o">-&gt;</span> <span class="n">hasMetValueFilter</span> <span class="n">toInch</span> <span class="n">valueFilter</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">ScreenSize</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">filterPhones</span> <span class="n">phones&#39;</span> <span class="n">filter</span> <span class="o">=</span>
</span><span class="line">    <span class="n">phones&#39;</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="n">hasMetSearchFilter</span> <span class="n">filter</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">rec</span> <span class="n">searchPhones&#39;</span> <span class="n">phones&#39;</span> <span class="n">filters&#39;</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">filters&#39;</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">phones&#39;</span>
</span><span class="line">    <span class="o">|</span> <span class="n">x</span> <span class="o">::</span> <span class="n">xs</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">searchPhones&#39;</span> <span class="o">(</span><span class="n">filterPhones</span> <span class="n">phones&#39;</span> <span class="n">x</span><span class="o">)</span> <span class="n">xs</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">searchPhones&#39;</span> <span class="n">phones</span> <span class="n">filters</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The function <code>searchPhones</code> recursively applies the filters one by one over the list of phones and filter the phones based on the filter criteria.</p>

<h2 id="exposing-the-phone-search-as-web-api">Exposing the phone search as web-api</h2>

<p>Open the <code>PhonesController</code> that we have added in the <a href="/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">step-1</a> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Error</span> <span class="o">=</span> <span class="o">{</span> <span class="n">message</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/phones&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">PhonesController</span>
</span><span class="line">    <span class="o">(</span>
</span><span class="line">        <span class="n">getTopSellingPhones</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">        <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">        <span class="n">catalogPhones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">Catalog</span><span class="p">.</span><span class="n">Phone</span><span class="o">&gt;</span>
</span><span class="line">    <span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">    <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;topselling&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetTopSelling</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">      <span class="n">getTopSellingPhones</span> <span class="mi">3</span> <span class="n">phones</span>
</span><span class="line">
</span><span class="line">    <span class="o">[&lt;</span><span class="n">HttpGet</span><span class="o">&gt;]</span>
</span><span class="line">    <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;search&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">SearchPhones</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">parserResult</span> <span class="o">=</span> <span class="nn">SearchParser</span><span class="p">.</span><span class="n">parseFilter</span> <span class="n">q</span>
</span><span class="line">      <span class="k">match</span> <span class="n">parserResult</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Choice1Of2</span> <span class="n">filters</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">filteredPhones</span> <span class="o">=</span> <span class="nn">Search</span><span class="p">.</span><span class="n">searchPhones</span> <span class="n">catalogPhones</span> <span class="n">filters</span>
</span><span class="line">        <span class="k">base</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">CreateResponse</span><span class="o">(</span><span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="o">,</span> <span class="n">filteredPhones</span><span class="o">)</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Choice2Of2</span> <span class="n">errMsg</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="k">base</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">CreateResponse</span><span class="o">(</span><span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="o">,</span> <span class="o">{</span> <span class="n">message</span> <span class="o">=</span> <span class="n">errMsg</span> <span class="o">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The action method <code>SearchPhones</code> gets the input query <code>q</code> from the user and give it to the parser using the <code>parseFilter</code> function. If the parsing is successful, then we will be calling the <code>searchPhones</code> function with the filters returned by the parser. If the parsing failed, we will be returning the error response with the error message from the parser.</p>

<p>We have added a new dependency <code>catalogPhones</code> in the <code>PhonesController</code> constructor which represents all the available phones in the catalog. We need to inject it while creating the controller. Open the <code>Infrastructure</code> module and update the <code>PhonesController</code> creation as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">controllerDescriptor</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phoneIndexes</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhoneIndex</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">catalogPhones</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToCatalogPhone</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">
</span><span class="line">  <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhonesController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getTopSellingPhones</span> <span class="o">(</span><span class="nn">InMemoryInventory</span><span class="p">.</span><span class="n">getPhonesSold</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">phonesController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhonesController</span><span class="o">(</span><span class="n">getTopSellingPhones</span><span class="o">,</span> <span class="n">phones&#39;</span><span class="o">,</span> <span class="n">catalogPhones</span><span class="o">)</span>
</span><span class="line">      <span class="n">phonesController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">  <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="creating-phone-search-view">Creating Phone Search View</h2>

<p>The final step of the creating a view for the Phone Search which enable the user to search the phones using the DSL that we have created so far.</p>

<p>It is straight forward razor view creation as we have seen in <a href="/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">step-2</a>. Add an action method <code>Search</code> in the <code>PhoneController</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Search</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="bp">()</span>
</span><span class="line"><span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Create a razor view <strong>Search.cshtml</strong> in the <em>Views/Phone</em> directory and add the code as <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/5/Web/Views/Phone/Show.cshtml">defined here</a>.</p>

<p>The javascript side has been taken care by knockout.js and you can find the script that takes care of calling the api and rendering the filtered phones <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/5/Web/Scripts/search.js">here</a>. </p>

<h2 id="summary">Summary</h2>

<p>Its a little longer post than I expected and I am glad that you have read it this far. I’d like give credit to this <a href="http://blog.fogcreek.com/fparsec/">blog post</a> by <a href="http://haolian.org/">Hao Lian</a> which I’ve used as a reference to come up with this implementation. As usual you can find the source code in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/5">phonecat github repository</a>.</p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
        <a href="5" class="prev">Prev</a>
    
    
        <a href="7" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2016

    Tamizhvendan S


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'tamizhvendan-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>






</body>
</html>
