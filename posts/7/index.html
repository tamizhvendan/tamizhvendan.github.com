
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>P3 Programmer</title>
	<meta name="author" content="Tamizhvendan S">

	
	<meta name="description" content="Jan 18th, 2015 dsl, fparsec, fsharp Comments Step-5 Advanced Search DSL Using FParsec This is step 5 of my blog series on Web Application &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="http://feeds.feedburner.com/tamizhvendan-blog" rel="alternate" title="P3 Programmer" type="application/atom+xml">
	
	<link rel="canonical" href="http://blog.tamizhvendan.in/posts/7/">
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link href="/favicon.png" rel="shortcut icon">
  <link href='/stylesheets/fonts.css' rel='stylesheet' type='text/css'>
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <style type="text/css">

  </style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
	<!-- Start of Leadin Embed -->
  <script type="text/javascript" src="//js.leadin.com/js/v1/2177345.js" id="LeadinEmbed-2177345" crossorigin="use-credentials" async defer></script>
<!-- End of Leadin Embed -->
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-43004255-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><style>
@media (max-width: 600px) {
  #book-cover, #tag-cloud {
    display: none;
  }
}
</style>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a target="_blank" href="http://about.me/tamizhvendan">About Me</a></li>
    <li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a target="_blank" class="email" href="mailto:tamizh88@gmail.com" title="Email">Email</a>
		
		
		
		
			<a target="_blank" class="twitter" href="http://twitter.com/tamizhvendan" title="Twitter">Twitter</a>
		
		
			<a target="_blank" class="github" href="https://github.com/tamizhvendan" title="GitHub">GitHub</a>
		
		
			<a target="_blank" class="coderwall" href="https://coderwall.com/tamizhvendan" title="Coderwall">Coderwall</a>
		
		
		
		
		
		
		
		
		
    	
    	
			<a target="_blank" class="rss" href="http://feeds.feedburner.com/tamizhvendan-blog" title="RSS">RSS</a>
		
	</div>
</nav>
<nav id="book-cover" style="margin-top:32px">
	<a target="_blank" href="http://products.tamizhvendan.in/fsharp-applied">
	<img class="center" src="/images/fsharp_applied_cover.jpg" width="160">
</a>
</nav>
<nav id="tag-cloud">
	<section>
    <!-- <h3>Tag Cloud</h3>
    <span id="tag-cloud"><a href='/blog/categories/asp-dot-net-mvc' style='font-size: 140.0%'>asp.net mvc</a> <a href='/blog/categories/c-number' style='font-size: 110.0%'>c#</a> <a href='/blog/categories/craftsmanship' style='font-size: 115.0%'>craftsmanship</a> <a href='/blog/categories/entity-framework' style='font-size: 112.5%'>entity framework</a> <a href='/blog/categories/fsharp' style='font-size: 160.0%'>fsharp</a> <a href='/blog/categories/functional-programming' style='font-size: 120.0%'>functional-programming</a> <a href='/blog/categories/javascript' style='font-size: 110.0%'>javascript</a> <a href='/blog/categories/programming' style='font-size: 115.0%'>programming</a> <a href='/blog/categories/suave' style='font-size: 115.0%'>suave</a> <a href='/blog/categories/unit-testing' style='font-size: 112.5%'>unit testing</a> </span> -->
</section>
</nav>


</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-01-18T19:52:26+05:30" data-updated="true" itemprop="datePublished">Jan 18<sup>th</sup>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/dsl/'>dsl</a>, <a class='category' href='/blog/categories/fparsec/'>fparsec</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>


</div>
		
			<span class="comments"><a href="/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec/" itemprop="url">Step-5 Advanced Search DSL Using FParsec</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<blockquote>
  <p>This is step 5 of my blog series on <a href="/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In this blog post we are going create an advanced Search <a href="http://en.wikipedia.org/wiki/Domain-specific_language">DSL</a> for searching Phones in the PhoneCat application that we are building in this blog series, using a F# parser combinator library called <a href="http://www.quanttec.com/fparsec/">FParsec</a>. </p>

<p><img src="/images/fsharp_phonecat/step_5/search_results.png" /></p>

<p>As you seen in the screenshot above the DSL that we are going to build will enable us to search phones using three search filters (parameters) <strong>weight</strong>, <strong>screen</strong> and <strong>ram</strong>. The values (value filters) of these search filters can be defined in three ways as <strong>&gt;</strong>(greater than), <strong>-</strong>(range) and <strong>{value}</strong>(actual value itself i.e <em>=</em>). Each of these values should be accompanied with their unit of measures <strong>g</strong>, <strong>inch</strong> and <strong>MB</strong> respectively. For simplicity, I’ve expressed these units in singulars. The <strong>:</strong> symbol is used to separate Search Filter and Value Filter. Multiple filters can be used by seperating thing using the <strong>;</strong> symbol. </p>

<p>The <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract syntax tree (AST)</a> of this external DSL is</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">SearchFilter</span> <span class="o">=</span>
</span><span class="line"><span class="o">|</span> <span class="n">Ram</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line"><span class="o">|</span> <span class="n">Weight</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line"><span class="o">|</span> <span class="n">Screen</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">ValueFilter</span> <span class="o">=</span>
</span><span class="line"><span class="o">|</span> <span class="n">Value</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line"><span class="o">|</span> <span class="n">GreaterThan</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line"><span class="o">|</span> <span class="n">Range</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">*</span> <span class="kt">float</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">filters</span> <span class="o">:</span> <span class="o">(</span><span class="n">SearchFilter</span> <span class="o">*</span> <span class="n">ValueFilter</span><span class="o">)</span> <span class="kt">list</span> <span class="o">=</span> <span class="c1">// ... </span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>FParsec does both <a href="http://en.wikipedia.org/wiki/Lexical_analysis">lexical analysis</a> (converting raw character sequence into meaningful tokens) and <a href="http://en.wikipedia.org/wiki/Parsing">parsing</a> (converting tokens to an AST like the one above). FParsec has been built using pure functions from the ground up and it enable us to create complex parser by combining small parsers (aka <a href="http://programmers.stackexchange.com/questions/117522/what-are-combinators-and-how-are-they-applied-to-programming-projects-practica">combinators</a>). </p>

<h3 id="fpasec-101">FPasec 101</h3>

<p>Lets quickly walk through the basics of FParsec.</p>

<p>In Fparsec all the parsers are of type <code>Parser&lt;'Result,'UserState&gt;</code> . The <code>'Result</code> represents the type of the parser result and the <code>'UserState</code> represents the internal state of the parser. </p>

<p>FParsec offers lot of in-built parser functions which takes F# primitive types and return a parser type for it. </p>

<h4 id="pchar">pchar</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">psearchValueSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;:&#39;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pmultiFiltersSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;;&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>pchar</code> function takes a character and returns a parser (i.e of type <code>Parser&lt;char, 'UserState&gt;</code>) which parses only the given character. </p>

<p>FParsec uses a convention of prefix <strong>p</strong> to define all its parser function and we are also going to use the same to define our custom parser functions.</p>

<h3 id="pstring">pstring</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pram</span> <span class="o">=</span> <span class="n">pstring</span> <span class="s">&quot;ram&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pweight</span> <span class="o">=</span> <span class="n">pstring</span> <span class="s">&quot;weight&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pscreen</span> <span class="o">=</span> <span class="n">pstring</span> <span class="s">&quot;ram&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Like <code>pchar</code> function, the <code>pstring</code> takes a string as its input and return a parser (<code>Parser&lt;string, 'UserState&gt;</code>) that parses only the given string. This parser is case-sensitive. If you want to have a parser which is case-insensitive you can use <code>pstringCI</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pmb</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;MB&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pg</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;g&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pinch</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;inch&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="pfloat">pfloat</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pvalue</span> <span class="o">=</span> <span class="n">pfloat</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I hope by this time you would have been familiar with the FParsec functions. Yes, you are right <code>pfloat</code> parses a floating point and returns the parser for the same. But unlike <code>pchar</code> and <code>pstrig</code> it doesn’t take any input and it can parse any floating point numbers and return the same when we execute the parser. </p>

<h3 id="section">|»</h3>

<p>So far we have seen parsers for the F# primitive types. What about our custom types ? FParsec has an answer for that too using the function (aka operator) <code>|&gt;&gt;</code>. </p>

<p>The signature of <code>|&gt;&gt;</code> function is</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; (a&#39; -&gt; &#39;b) -&gt; Parser&lt;&#39;b, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>i.e this function takes two inputs, a parser of type <code>'a</code> and a function that transform the type <code>'a</code> to <code>'b</code> and return a parser of type <code>'b</code></p>

<p>If you remember the AST that we have defined in the beginning of the post, the search filter has been defined as a discriminated union of type <code>SearchFilter</code>. Each fields <code>Ram</code>, <code>Screen</code>, <code>Weight</code> are being represented in the DSL by their string counterparts <em>“ram”</em>, <em>“screen”</em>, <em>“weight”</em> respectively. We can leverage this <code>|&gt;&gt;</code> function to take care of this data type transformation</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">toLowerCase</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">ToLowerInvariant</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">toSearchFilter</span> <span class="n">str</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">toLowerCase</span> <span class="n">str</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="s">&quot;ram&quot;</span> <span class="o">-&gt;</span> <span class="n">Ram</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="n">Weight</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="s">&quot;screen&quot;</span> <span class="o">-&gt;</span> <span class="n">Screen</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s">&quot;Invalid search filter&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">psearchFilter</span> <span class="n">str</span> <span class="o">=</span> <span class="n">pstring</span> <span class="n">str</span> <span class="o">|&gt;&gt;</span> <span class="n">toSearchFilter</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">pram</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;ram&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pweight</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;weight&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pscreen</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;screen&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>If you see the type of <code>pram</code> it is Parser&lt;SearchFilter, ‘u&gt; i.e Parser for our custom type. The <code>psearchFilter</code> is an utility function which helps in avoiding the code duplication across multiple search filter parser creation.</p>

<h3 id="section-1">».</h3>

<p>I love this function and it represents the beauty of functional programming. This function has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It takes two parsers of same or different types and returns a parser that parses the input using the given two parsers by applying them sequentially and returns a parser with the input type of second parser (The <strong>.</strong> symbol represents which parser to pick)</p>

<p>Lets see this action to understand it more</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">let pgreaterThan = pchar &#39;&gt;&#39; &gt;&gt;. pfloat |&gt;&gt; GreaterThan
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have created parser here for greater than. It parses the string <strong>“&gt;80.2”</strong> (i.e <code>pchar</code> parses the <strong>&gt;</strong> symbol and <code>pfloat</code> parses the number <strong>80.2</strong>. Since we have created it using <code>&gt;&gt;.</code> function, both <code>pchar</code> and <code>pfloat</code> are applied in sequence and it returns a parser of float type) and retrieve the floating number <strong>80.2</strong> when the parser is executed. Then we have applied the <code>|&gt;&gt;</code> function which translate it our custom type <code>GreaterThan</code> that we defined in the AST.</p>

<p>The <code>&gt;&gt;.</code> is much like functional composition done by the <a href="http://en.wikibooks.org/wiki/F_Sharp_Programming/Higher_Order_Functions#The_Composition_Function_.28.3C.3C_operator.29">» function (aka operator)</a> but instead of acting at the function level it acts at the parser level.</p>

<h3 id="section-2">.»</h3>

<p>It is similar to the <code>&gt;&gt;.</code> function but instead of returning a parser with the input type of second parser it returns a parser with the input type of the first parser.</p>

<p>It has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt; -&gt; Parser&lt;&#39;a, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-3">.».</h3>

<p>It is a combination of <code>.&gt;&gt;</code> and <code>&gt;&gt;.</code> i.e Instead of dropping the output of either of the given parsers, it returns a parser which parses the input and returns a parser with the result type as tuple representing the inputs of both of the given parsers.</p>

<p>It has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt; -&gt; Parser&lt;(&#39;a * &#39;c), &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Lets see both <code>.&gt;&gt;</code> and <code>.&gt;&gt;.</code> in action</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">prange</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">.&gt;&gt;</span> <span class="o">(</span><span class="n">pchar</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Range</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>prange</code> parser parses the string “100-200” and returns <code>Range (100, 200)</code>.</p>

<p>The <code>.&gt;&gt;</code> function here dropped the symbol <strong>-</strong> here (output of <code>pchar</code> parser) and the function <code>.&gt;&gt;.</code> picked the output of these parsers and returned a tuple representing the given range.</p>

<p>Now you got why I said I love this function! These tiny functions allow us to create parsers by combining them. If you understand how these tiny functions work and trust me you can create complex parsers even a <a href="http://trelford.com/blog/post/parsecsharp.aspx">C# compiler</a></p>

<h3 id="attempt">attempt</h3>

<p>This function takes parser <code>p</code> and execute it against the input. If it result in <strong>fatal error</strong>, it <a href="http://en.wikipedia.org/wiki/Backtracking">backtracks</a> the parser state to its original state as if that the given input is not being consumed. </p>

<h3 id="choice">choice</h3>

<p>This function takes multiple parsers say <code>p1</code>, <code>p2</code> … <code>pn</code> and execute it against the input in the following order.</p>

<p>Run the parser <code>p1</code> against the input. If the parsing succeed skip the rest of the parsers and return the parser else if it resulted an <strong>non-fatal error</strong>, backtrack the parser state to its original state and try the same with the next parser <code>p2</code>. This continues all the way down to <code>pn</code>.</p>

<p>What is the difference between <a href="http://www.quanttec.com/fparsec/reference/primitives.html#members.Error">Non-Fatal Error</a> and a <a href="http://www.quanttec.com/fparsec/reference/primitives.html#members.FatalError">Fatal Error</a> ?</p>

<p>Well, its closely associated with the internal implementation of FParsec. FParsec implements backtracking with only a “one token look-ahead”. i.e if the parser consumed one input token from the stream, it modifies the internal state and if it fails after that it would result in Fatal Error. Not-Fatal Error occurs when parer error happened without consuming the input. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pgreaterThan</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">GreaterThan</span>
</span><span class="line"><span class="k">let</span> <span class="nv">prange</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">.&gt;&gt;</span> <span class="o">(</span><span class="n">pchar</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Range</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pvalue</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Value</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pvalueFilters</span> <span class="o">=</span> <span class="n">choice</span> <span class="o">[</span><span class="n">pgreaterThan</span><span class="o">;</span> <span class="o">(</span><span class="n">attempt</span> <span class="n">prange</span><span class="o">);</span> <span class="n">pvalue</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>If you seen the AST of the DSL that we are going to implement, the value filters can be any one of greaterThan or range or value. Using <code>choice</code> we have implemented this “either or” parser and also we have leveraged the <code>attempt</code> function to get rid of parser fatal error.</p>

<p>Both <code>prange</code> and <code>value</code>, shares the same first token i.e for “100-200MB” &amp; “100MB”, the first token ‘1’ is same. So while parsing the string “100MB” it starts by consuming the first token ‘1’ from the input sequence. FParsec assumes its a range filter and changes its internal state. By the time it reaches the token ‘M’ in “100MB”, it would result in a fatal error saying <em>Expecting: ‘-‘</em>. As we have used <code>attempt</code> here, it backtracks the parser state back to the token ‘1’ of “100MB” and start parsing using <code>pvalue</code> parser. Its hard to get it first time (I’ve spent close to an hour to figure it out) and I recommend you to spend some quality time in understanding the <a href="http://www.quanttec.com/fparsec/users-guide/parsing-alternatives.html">documentation</a> if you want really want to crack it!</p>

<h3 id="sepby">sepBy</h3>

<p><a href="http://www.quanttec.com/fparsec/reference/primitives.html#members.sepBy">sepBy</a> takes an element parser <code>p1</code> and a separator parser as its input and returns a parser for a list of elements separated by the separators.</p>

<p>It has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a,&#39;u&gt; -&gt; Parser&lt;&#39;b,&#39;u&gt; -&gt; Parser&lt;&#39;a list, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We will be using this function to parse multiple search filters separated by <strong>;</strong></p>

<h3 id="run">run</h3>

<p>The <a href="http://www.quanttec.com/fparsec/reference/charparsers.html#members.run">run function</a> takes a parser and a string as its input and it executes the given parser against the string input and returns a <a href="http://www.quanttec.com/fparsec/reference/charparsers.html#members.ParserResult">ParserResult</a> representing the result.</p>

<h2 id="implementing-the-parser">Implementing the Parser</h2>

<p>We have seen a brief overview of some of the basic building blocks of FParsec. It’s time to pull all these things together and create the complete parser which parses the Search DSL.</p>

<p>Create a source file in the <strong>Domain</strong> project and name it as <code>Search</code>. Then add the AST that we have discussed as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Search</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">SearchFilter</span> <span class="o">=</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Ram</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Weight</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Screen</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">ValueFilter</span> <span class="o">=</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Value</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line">  <span class="o">|</span> <span class="n">GreaterThan</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Range</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">*</span> <span class="kt">float</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The next step is to install the <a href="https://www.nuget.org/packages/FParsec">FParsec Nuget Package</a> in the <strong>Domain</strong> project. After installing it create a source file with the name <code>SearchParser</code> and add a function to parse the filter string as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">SearchParser</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">parseFilter</span> <span class="n">filterStr</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">toLowerCase</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">ToLowerInvariant</span><span class="bp">()</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">toSearchFilter</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">      <span class="o">|</span> <span class="s">&quot;ram&quot;</span> <span class="o">-&gt;</span> <span class="n">Ram</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line">      <span class="o">|</span> <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="n">Weight</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line">      <span class="o">|</span> <span class="s">&quot;screen&quot;</span> <span class="o">-&gt;</span> <span class="n">Screen</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s">&quot;Invalid search filter&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">psearchFilter</span> <span class="n">str</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="n">str</span> <span class="o">|&gt;&gt;</span> <span class="o">(</span><span class="n">toLowerCase</span> <span class="o">&gt;&gt;</span> <span class="n">toSearchFilter</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">psearchValueSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;:&#39;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pmultiFiltersSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;;&#39;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pgreaterThan</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">GreaterThan</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">prange</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">.&gt;&gt;</span> <span class="o">(</span><span class="n">pchar</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Range</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pvalue</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Value</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pvalueFilters</span> <span class="o">=</span> <span class="n">choice</span> <span class="o">[</span><span class="n">pgreaterThan</span><span class="o">;</span> <span class="o">(</span><span class="n">attempt</span> <span class="n">prange</span><span class="o">);</span> <span class="n">pvalue</span><span class="o">]</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">createCompleteFilter</span> <span class="n">psearchfilter</span> <span class="n">puom</span>  <span class="o">=</span>
</span><span class="line">      <span class="n">psearchfilter</span> <span class="o">.&gt;&gt;</span> <span class="n">psearchValueSeperator</span> <span class="o">.&gt;&gt;.</span> <span class="n">pvalueFilters</span> <span class="o">.&gt;&gt;</span> <span class="n">puom</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">pmb</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;MB&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pg</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;g&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pinch</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;inch&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pram</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;ram&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pweight</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;weight&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pscreen</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;screen&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">pramFilter</span> <span class="o">=</span> <span class="n">createCompleteFilter</span> <span class="n">pram</span> <span class="n">pmb</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pweightFilter</span> <span class="o">=</span> <span class="n">createCompleteFilter</span> <span class="n">pweight</span> <span class="n">pg</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pscreenFilter</span> <span class="o">=</span> <span class="n">createCompleteFilter</span> <span class="n">pscreen</span> <span class="n">pinch</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pfilter</span> <span class="o">=</span> <span class="n">choice</span> <span class="o">[</span><span class="n">pramFilter</span><span class="o">;</span><span class="n">pweightFilter</span><span class="o">;</span><span class="n">pscreenFilter</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">parser</span> <span class="o">=</span> <span class="n">sepBy</span> <span class="n">pfilter</span> <span class="n">pmultiFiltersSeperator</span>
</span><span class="line">
</span><span class="line">    <span class="k">match</span> <span class="n">run</span> <span class="n">parser</span> <span class="n">filterStr</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Success</span><span class="o">(</span><span class="n">filters</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="n">Choice1Of2</span><span class="o">(</span><span class="n">filters</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Failure</span><span class="o">(</span><span class="n">err</span><span class="o">,_,_)</span> <span class="o">-&gt;</span> <span class="n">Choice2Of2</span><span class="o">(</span><span class="n">err</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>parseFilter</code> function takes the search filter query from the front end, parses it using the custom parsers that we have built and return the <a href="http://msdn.microsoft.com/en-us/library/ee353439.aspx">Choice type</a>.</p>

<p>The <code>Choice1Of2</code> will contain a list of tuples (SearchFilter * ValueFilter) that represents the strongly typed AST of the given input query.</p>

<p>The <code>Choice2of2</code> will contain the error message in case if there is any parser error happened while parsing the input query.</p>

<h2 id="implementing-phone-search-backend">Implementing Phone Search backend</h2>

<p>With the parser in place, the next step is to building the backend logic of filtering the phones using the filters returned by the parsers</p>

<p>Open the module <code>Search</code> in the <strong>Domain</strong> project and add the following <code>searchPhones</code> function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">searchPhones</span> <span class="n">phones</span> <span class="n">filters</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">hasMetValueFilter</span> <span class="n">toUom</span> <span class="n">valueFilter</span> <span class="n">property</span>  <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">valueFilter</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Value</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">property</span> <span class="o">=</span> <span class="n">toUom</span> <span class="n">x</span>
</span><span class="line">    <span class="o">|</span> <span class="n">GreaterThan</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">property</span> <span class="o">&gt;</span> <span class="n">toUom</span> <span class="n">x</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Range</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">property</span> <span class="o">&gt;=</span> <span class="n">toUom</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">property</span> <span class="o">&lt;=</span> <span class="n">toUom</span> <span class="n">y</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">hasMetSearchFilter</span> <span class="n">filter</span> <span class="n">phone</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">valueFilter</span> <span class="o">=</span> <span class="o">(</span><span class="n">snd</span> <span class="n">filter</span><span class="o">)</span>
</span><span class="line">    <span class="k">match</span> <span class="o">(</span><span class="n">fst</span> <span class="n">filter</span><span class="o">)</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Ram</span> <span class="n">toMB</span> <span class="o">-&gt;</span> <span class="n">hasMetValueFilter</span> <span class="n">toMB</span> <span class="n">valueFilter</span> <span class="n">phone</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">Ram</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Weight</span> <span class="n">toG</span> <span class="o">-&gt;</span> <span class="n">hasMetValueFilter</span> <span class="n">toG</span> <span class="n">valueFilter</span> <span class="n">phone</span><span class="o">.</span><span class="n">Weight</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Screen</span> <span class="n">toInch</span><span class="o">-&gt;</span> <span class="n">hasMetValueFilter</span> <span class="n">toInch</span> <span class="n">valueFilter</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">ScreenSize</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">filterPhones</span> <span class="n">phones&#39;</span> <span class="n">filter</span> <span class="o">=</span>
</span><span class="line">    <span class="n">phones&#39;</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="n">hasMetSearchFilter</span> <span class="n">filter</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">rec</span> <span class="n">searchPhones&#39;</span> <span class="n">phones&#39;</span> <span class="n">filters&#39;</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">filters&#39;</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">phones&#39;</span>
</span><span class="line">    <span class="o">|</span> <span class="n">x</span> <span class="o">::</span> <span class="n">xs</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">searchPhones&#39;</span> <span class="o">(</span><span class="n">filterPhones</span> <span class="n">phones&#39;</span> <span class="n">x</span><span class="o">)</span> <span class="n">xs</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">searchPhones&#39;</span> <span class="n">phones</span> <span class="n">filters</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The function <code>searchPhones</code> recursively applies the filters one by one over the list of phones and filter the phones based on the filter criteria.</p>

<h2 id="exposing-the-phone-search-as-web-api">Exposing the phone search as web-api</h2>

<p>Open the <code>PhonesController</code> that we have added in the <a href="/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">step-1</a> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Error</span> <span class="o">=</span> <span class="o">{</span> <span class="n">message</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/phones&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">PhonesController</span>
</span><span class="line">    <span class="o">(</span>
</span><span class="line">        <span class="n">getTopSellingPhones</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">        <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">        <span class="n">catalogPhones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">Catalog</span><span class="p">.</span><span class="n">Phone</span><span class="o">&gt;</span>
</span><span class="line">    <span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">    <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;topselling&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetTopSelling</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">      <span class="n">getTopSellingPhones</span> <span class="mi">3</span> <span class="n">phones</span>
</span><span class="line">
</span><span class="line">    <span class="o">[&lt;</span><span class="n">HttpGet</span><span class="o">&gt;]</span>
</span><span class="line">    <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;search&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">SearchPhones</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">parserResult</span> <span class="o">=</span> <span class="nn">SearchParser</span><span class="p">.</span><span class="n">parseFilter</span> <span class="n">q</span>
</span><span class="line">      <span class="k">match</span> <span class="n">parserResult</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Choice1Of2</span> <span class="n">filters</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">filteredPhones</span> <span class="o">=</span> <span class="nn">Search</span><span class="p">.</span><span class="n">searchPhones</span> <span class="n">catalogPhones</span> <span class="n">filters</span>
</span><span class="line">        <span class="k">base</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">CreateResponse</span><span class="o">(</span><span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="o">,</span> <span class="n">filteredPhones</span><span class="o">)</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Choice2Of2</span> <span class="n">errMsg</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="k">base</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">CreateResponse</span><span class="o">(</span><span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="o">,</span> <span class="o">{</span> <span class="n">message</span> <span class="o">=</span> <span class="n">errMsg</span> <span class="o">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The action method <code>SearchPhones</code> gets the input query <code>q</code> from the user and give it to the parser using the <code>parseFilter</code> function. If the parsing is successful, then we will be calling the <code>searchPhones</code> function with the filters returned by the parser. If the parsing failed, we will be returning the error response with the error message from the parser.</p>

<p>We have added a new dependency <code>catalogPhones</code> in the <code>PhonesController</code> constructor which represents all the available phones in the catalog. We need to inject it while creating the controller. Open the <code>Infrastructure</code> module and update the <code>PhonesController</code> creation as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">controllerDescriptor</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phoneIndexes</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhoneIndex</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">catalogPhones</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToCatalogPhone</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">
</span><span class="line">  <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhonesController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getTopSellingPhones</span> <span class="o">(</span><span class="nn">InMemoryInventory</span><span class="p">.</span><span class="n">getPhonesSold</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">phonesController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhonesController</span><span class="o">(</span><span class="n">getTopSellingPhones</span><span class="o">,</span> <span class="n">phones&#39;</span><span class="o">,</span> <span class="n">catalogPhones</span><span class="o">)</span>
</span><span class="line">      <span class="n">phonesController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">  <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="creating-phone-search-view">Creating Phone Search View</h2>

<p>The final step of the creating a view for the Phone Search which enable the user to search the phones using the DSL that we have created so far.</p>

<p>It is straight forward razor view creation as we have seen in <a href="/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">step-2</a>. Add an action method <code>Search</code> in the <code>PhoneController</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Search</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="bp">()</span>
</span><span class="line"><span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Create a razor view <strong>Search.cshtml</strong> in the <em>Views/Phone</em> directory and add the code as <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/5/Web/Views/Phone/Show.cshtml">defined here</a>.</p>

<p>The javascript side has been taken care by knockout.js and you can find the script that takes care of calling the api and rendering the filtered phones <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/5/Web/Scripts/search.js">here</a>. </p>

<h2 id="summary">Summary</h2>

<p>Its a little longer post than I expected and I am glad that you have read it this far. I’d like give credit to this <a href="http://blog.fogcreek.com/fparsec/">blog post</a> by <a href="http://haolian.org/">Hao Lian</a> which I’ve used as a reference to come up with this implementation. As usual you can find the source code in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/5">phonecat github repository</a>.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-01-06T05:22:32+05:30" data-updated="true" itemprop="datePublished">Jan 6<sup>th</sup>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/devops/'>devops</a>, <a class='category' href='/blog/categories/fake/'>fake</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>


</div>
		
			<span class="comments"><a href="/blog/2015/01/06/step-4-build-automation-using-fake/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/01/06/step-4-build-automation-using-fake/" itemprop="url">Step-4 Build Automation Using FAKE</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<blockquote>
  <p>This is step 4 of my blog series on <a href="/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the last three steps, we have seen how to build an web application in fsharp by leveraging <a href="/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">Web-Api</a>, <a href="/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">Razor</a> and <a href="/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/">SignalR</a>. In this step for a change we are going to take the <a href="http://en.wikipedia.org/wiki/DevOps">DevOps</a> side of the application and going to add the build automation capabilities for the application. Let’s get stated!</p>

<h2 id="fake---an-awesome-build-automation-library">Fake - An awesome build automation library</h2>

<p><a href="http://fsharp.github.io/FAKE/">Fake</a> is a F# version of very successful and widely used build automation libraries <a href="http://www.gnu.org/software/make/">Make</a> and <a href="http://en.wikipedia.org/wiki/Rake_%28software%29">Rake</a>. The combination of <a href="http://fsharp.org/testimonials/">fsharp’s expressiveness</a> and the <a href="http://fsharp.github.io/FAKE/gettingstarted.html">Fake’s DSL</a> is a visual treat to the eyes and especially if you are someone who is using <a href="http://en.wikipedia.org/wiki/MSBuild">MsBuild</a> xml files for doing build automation you will definitely appreciate it.</p>

<h3 id="adding-nugetexe-to-nuget-folder">Adding nuget.exe to .nuget folder</h3>

<p>As we are going to drive the nuget packages installation from the fsharp script file, we will be needing a <a href="nuget.org/nuget.exe">command line version of nuget</a>. Download it and place it inside the <strong>.nuget</strong> folder</p>

<p>Also its a good practice to add a <a href="http://docs.nuget.org/docs/reference/nuget-config-settings">Nuget.config file</a>. Add it too under <strong>.nuget</strong> folder. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class="line"><span class="nt">&lt;configuration&gt;</span>
</span><span class="line">  <span class="nt">&lt;packageSources&gt;</span>
</span><span class="line">    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">&quot;nuget.org&quot;</span> <span class="na">value=</span><span class="s">&quot;https://www.nuget.org/api/v2/&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/packageSources&gt;</span>
</span><span class="line"><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="adding-buildbat-file">Adding build.bat file</h3>

<p>Create a batch file <strong>build.bat</strong> in the root directory of the solution. It is going act as bootstrap file which initiates the entire build process.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="bat"><span class="line"><span class="p">@</span><span class="k">echo</span> <span class="k">off</span>
</span><span class="line"><span class="k">cls</span>
</span><span class="line"><span class="s2">&quot;.nuget\NuGet.exe&quot;</span> <span class="s2">&quot;Install&quot;</span> <span class="s2">&quot;FAKE&quot;</span> <span class="s2">&quot;-OutputDirectory&quot;</span> <span class="s2">&quot;tools&quot;</span> <span class="s2">&quot;-ExcludeVersion&quot;</span>
</span><span class="line"><span class="s2">&quot;tools\FAKE\tools\Fake.exe&quot;</span> build.fsx
</span><span class="line"><span class="k">pause</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>It just download the Fake nuget package using the nuget.exe that we added earlier and call the fake.exe with the fsharp build script <strong>build.fsx</strong>.</p>

<h3 id="adding-buildfsx-file">Adding build.fsx file</h3>

<p>Create a <a href="http://blogs.msdn.com/b/chrsmith/archive/2008/09/12/scripting-in-f.aspx">fsharp script file</a> with the name <strong>build.fsx</strong> in the root directory. This script is going to implement all our build automation tasks by using fake library.</p>

<h3 id="cleaning-the-build-directory">Cleaning the build directory</h3>

<p>Just a like any other build process, the first step is to clear the build directory. Fake follows the same convention of MsBuild’s <a href="http://msdn.microsoft.com/en-us/library/ms171462.aspx">Targets</a>. Defining targets in Fake is less verbose compare to its MsBuild’s counterpart. As a matter of fact, it is a fsharp function that take two parameters, the name of the target and a function which defines the target. </p>

<p>Since it is a script file we need to add reference to the <strong>FakeLib.dll</strong> before writing the actual code.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">#</span><span class="n">r</span> <span class="s">&quot;tools/FAKE/tools/FakeLib.dll&quot;</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Fake</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">buildDir</span> <span class="o">=</span> <span class="s">&quot;./build&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">Target</span> <span class="s">&quot;Clean&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">CleanDir</span> <span class="n">buildDir</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Less verbose, Isn’t it ?</p>

<p>The <code>CleanDir</code> is a predefined function in Fake library which clean up this build directory. If the directory doesn’t exist it creates the directory. </p>

<h3 id="build-the-solution">Build the solution</h3>

<p>After cleaning the build directory the next step is to carrying out the actual build process. Before building the application we need to resolve the nuget packages being referred in the application. It’s so simple in Fake. All you need to do is just call predefined function <code>RestorePackages</code>.    </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="n">Target</span> <span class="s">&quot;Build&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="n">RestorePackages</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">!!</span> <span class="s">&quot;./PhoneCat.sln&quot;</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">MSBuildRelease</span> <span class="n">buildDir</span> <span class="s">&quot;Build&quot;</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">Log</span> <span class="s">&quot;Build-Output: &quot;</span>
</span><span class="line">
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>!!</code> is a function which takes a file path and returns <a href="http://fsharp.github.io/FAKE/apidocs/fake-filesystem-fileincludes.html">FileIncludes</a> which is Fake’s internal representation of a file set.</p>

<p>FileIncludes <a href="https://github.com/fsharp/FAKE/blob/master/src/app/FakeLib/Globbing/FileSystem.fs#L95-l117">implements</a> <code>IEnumerable&lt;string&gt;</code> so it can be used wherever we need an <code>IEnumerable&lt;string&gt;</code>. </p>

<p>The <code>MsBuildRelease</code> is also a predefined function in Fake which builds the given solution (which is piped from the <code>!!</code>). The first two parameters are the output build directory path and the target names which should be run by MsBuild. Fake offers lot of functional wrappers on top of MsBuild and you can find more about it in this <a href="http://fsharp.github.io/FAKE/apidocs/fake-msbuildhelper.html">api documentation.</a>. </p>

<p>The last line just pipes the log result from the <code>MsBuildRelease</code> function to the log output.</p>

<h3 id="running-unit-tests-using-nunitrunner">Running unit tests using Nunit.Runner</h3>

<p>Now we have built the solution and the next step is running the unit test cases. Since I’ve written the test cases using Nunit and we are going to see how to run nunit tests using Fake. Fake also supports <a href="http://fsharp.github.io/FAKE/apidocs/fake-xunithelper.html">XUnit</a> and <a href="http://fsharp.github.io/FAKE/apidocs/fake-mstest.html">MsTest</a>. Porting the below code to other unit testing framework is very straight forward.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="n">Target</span> <span class="s">&quot;Test&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">  <span class="o">!!</span> <span class="o">(</span><span class="n">buildDir</span> <span class="o">+</span> <span class="s">&quot;/*.Tests.dll&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">NUnit</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">p</span> <span class="k">with</span> <span class="n">ToolPath</span> <span class="o">=</span> <span class="s">&quot;./tools/NUnit.Runners/tools&quot;</span> <span class="o">})</span>
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>As we did it in the build target, the <code>!!</code> function picks all the unit test files (I’ve used a convention of naming the unit tests projects with the <strong>.Tests</strong> suffix) in the build directory and transform them to FileIncludes. </p>

<p>The <code>NUnit</code> is yet another <a href="http://fsharp.github.io/FAKE/apidocs/fake-nunitsequential.html">inbuilt function of Fake</a> which runs nunit on the given group of assemblies.</p>

<p>It takes two parameter, a function that returns the modified default <code>NUnitParams</code> value and a sequence of assembly paths. We have modified the default <code>ToolPath</code> property which specifies the file path of <strong>NUnit Runner</strong> </p>

<p>As we did for Fake we have to modify the batch file as below to install the Nunit Runner nuget package before running the actual script.  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="bat"><span class="line"><span class="p">@</span><span class="k">echo</span> <span class="k">off</span>
</span><span class="line"><span class="k">cls</span>
</span><span class="line"><span class="s2">&quot;.nuget\NuGet.exe&quot;</span> <span class="s2">&quot;Install&quot;</span> <span class="s2">&quot;FAKE&quot;</span> <span class="s2">&quot;-OutputDirectory&quot;</span> <span class="s2">&quot;tools&quot;</span> <span class="s2">&quot;-ExcludeVersion&quot;</span>
</span><span class="line"><span class="s2">&quot;.nuget\NuGet.exe&quot;</span> <span class="s2">&quot;Install&quot;</span> <span class="s2">&quot;NUnit.Runners&quot;</span> <span class="s2">&quot;-OutputDirectory&quot;</span> <span class="s2">&quot;tools&quot;</span> <span class="s2">&quot;-ExcludeVersion&quot;</span>
</span><span class="line">
</span><span class="line"><span class="s2">&quot;tools\FAKE\tools\Fake.exe&quot;</span> build.fsx
</span><span class="line"><span class="k">pause</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="deploy-the-application-in-iis">Deploy the application in IIS</h3>

<p>Well, now we are at the final step of the build process which deploy the application in the local IIS server. </p>

<p>Deploying an application in IIS is super easy using Fake. All you need to do is just input necessary things like site name, virtual directory name, etc., and call the <code>IIS</code> function in <strong>Fake.IIS</strong> library which is installed as part of Fake.</p>

<p>To begin with we need to add reference in the beginning <strong>build.fsx</strong> to include the <strong>Fake.IIS</strong> library. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">#</span><span class="n">r</span> <span class="s">&quot;tools/FAKE/tools/Fake.IIS.dll&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This <strong>Fake.IIS</strong> makes heavy use of <a href="http://msdn.microsoft.com/en-us/library/microsoft.web.administration.servermanager(v=vs.90).aspx">ServerManager</a> which helps to dynamically configure IIS 7.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="n">Target</span> <span class="s">&quot;Deploy&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">siteName</span> <span class="o">=</span> <span class="s">&quot;fsharp&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">appPool</span> <span class="o">=</span> <span class="s">&quot;fsharp.appPool&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">port</span> <span class="o">=</span> <span class="s">&quot;:9999:&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">vdir</span> <span class="o">=</span> <span class="s">&quot;/phonecat&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">webBuildPath</span> <span class="o">=</span> <span class="n">buildDir</span> <span class="o">+</span> <span class="s">&quot;/_PublishedWebsites/Web&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">sitePhysicalPath</span> <span class="o">=</span> <span class="s">@&quot;c:\inetpub\wwwroot\phonecat&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="n">XCopy</span> <span class="n">webBuildPath</span> <span class="n">sitePhysicalPath</span>
</span><span class="line">
</span><span class="line">  <span class="o">(</span><span class="n">IIS</span>
</span><span class="line">    <span class="o">(</span><span class="n">Site</span> <span class="n">siteName</span> <span class="s">&quot;http&quot;</span> <span class="n">port</span> <span class="s">@&quot;C:\inetpub\wwwroot&quot;</span> <span class="n">appPool</span><span class="o">)</span>
</span><span class="line">    <span class="o">(</span><span class="n">ApplicationPool</span> <span class="n">appPool</span> <span class="k">true</span> <span class="s">&quot;v4.0&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">(</span><span class="n">Some</span><span class="o">(</span><span class="n">Application</span> <span class="n">vdir</span> <span class="n">sitePhysicalPath</span><span class="o">)))</span>
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>When we build a web project using MsBuild in release mode, it creates a deployable directory which can be accessed using the path <em>/_PublishedWebsites/Web</em> in the build directory. So, after building the application we just need to copy this deployable directory to the <strong>intepub\wwwroot</strong> directory using the XCopy function in Fake.</p>

<p>The <code>IIS</code> function takes three parameters</p>

<ul>
  <li>site - A function with the signature <code>ServerManager -&gt; Site</code> which takes an instance of ServerManager and returns a <a href="http://msdn.microsoft.com/en-us/library/microsoft.web.administration.site(v=vs.90).aspx">Site</a> with the given site settings. </li>
  <li>appPool - A function with the signature <code>ServerManager -&gt; ApplicationPool</code> which takes an instance of ServerManager and returns a <a href="http://msdn.microsoft.com/en-us/library/microsoft.web.administration.applicationpool(v=vs.90).aspx">AppPool</a> with the given appPool settings.  </li>
  <li>app - An option type with the signature <code>(Site -&gt; ServerManager -&gt; Application) option</code> provides the <a href="http://msdn.microsoft.com/en-us/library/microsoft.web.administration.application(v=vs.90).aspx">Application</a>  </li>
</ul>

<p>Fake’s IIS helper library has in-built function for Site, ApplicationPool and Application which takes the necessary inputs need for its creation and returns the associated instances. All of these function creates Site, ApplicationPool and Application respectively if they are not available in the IIS. </p>

<h3 id="running-the-targets">Running the Targets</h3>

<p>In the above steps we just defined various Fake targets. These targets doesn’t execute on its own and we need to explicitly define the order of its execution and initiate.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="s">&quot;Clean&quot;</span>
</span><span class="line">  <span class="o">==&gt;</span> <span class="s">&quot;Build&quot;</span>
</span><span class="line">  <span class="o">==&gt;</span> <span class="s">&quot;Test&quot;</span>
</span><span class="line">  <span class="o">==&gt;</span> <span class="s">&quot;Deploy&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">RunTargetOrDefault</span> <span class="s">&quot;Deploy&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>==&gt;</code> is one of <a href="http://fsharp.github.io/FAKE/apidocs/fake-additionalsyntax.html">the DSL in Fake</a> which is actually a function that defines the target execution order.</p>

<p>The <code>RunTargetOrDefault</code> function runs the target specified in the parameter or executes the default target.</p>

<h3 id="summary">Summary</h3>

<p>Fake is just awesome. We can automate so much things with very few lines of code and the beauty is it can be used in <strong>any .net projects</strong>. If you are using MsBuild Xml scripts, do try Fake! It will make you super productive. You can find the source of this step in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/4">fsharp-phonecat repository</a>. </p>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-01-02T05:44:52+05:30" data-updated="true" itemprop="datePublished">Jan 2<sup>nd</sup>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/asp-dot-net-mvc/'>asp.net mvc</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>, <a class='category' href='/blog/categories/functional-programming/'>functional-programming</a>, <a class='category' href='/blog/categories/rx/'>rx</a>, <a class='category' href='/blog/categories/signalr/'>signalr</a>


</div>
		
			<span class="comments"><a href="/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/" itemprop="url">Step-3 PhoneCat Recommendation System Using F# Agents, SignalR and Rx</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<blockquote>
  <p>This is step 3 of my blog series on <a href="/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the last two steps we have seen how to create a <a href="/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">web apis</a> and <a href="/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">static razor views</a> in fsharp. In this blog post we are going to see one of my favorite feature in fsharp <a href="http://fsharpforfunandprofit.com/posts/concurrency-actor-model/">“Message based approach to concurrency”</a>.</p>

<h3 id="a-small-flashback">A Small Flashback</h3>
<p>I’ve actually planned to put this blog post for the great fsharp community initiative <a href="https://sergeytihon.wordpress.com/2014/11/24/f-advent-calendar-in-english-2014/">F# Advent Calender</a>. Unfortunately it was not able to get through as I’ve <a href="http://sergeytihon.wordpress.com/2014/11/24/f-advent-calendar-in-english-2014/#comment-4135">nominated myself</a> little late. I always believe there is an opportunity behind every adversity. I didn’t get hung up and I knew this is one of the great topic to blog about. When I decided to blog about it, I needed a sample web application. So, I was creating that sample application and it suddenly strikes! <em>How about a blog series on web application development in fsharp?</em> I’ve immediately started working on it and hence this blog series.</p>

<h3 id="so-what-we-gonna-do-in-this-step">So what we gonna do in this step</h3>
<p>In this blog post we are going to build a recommendation system which keeps track of what phones that the user is viewing, and based on his navigation history, we will be recommending a phone that he might be interested in</p>

<p style="text-align:center"> <strong> User visits &#8220;Motorola XOOM™&#8221; </strong> </p>
<p><img src="/images/fsharp_phonecat/step_3/Phone_1.png" /></p>

<p style="text-align:center"> <strong> User visits &#8220;Motorola XOOM™ with Wi-Fi&#8221; </strong> </p>
<p><img src="/images/fsharp_phonecat/step_3/Phone_2.png" /></p>

<p>Let us start the implementation by defining two high level tasks</p>

<ol>
  <li>Tracking user navigation</li>
  <li>Recommending a phone</li>
</ol>

<h3 id="tracking-user-navigation">1. Tracking user navigation</h3>

<p><img class="center" src="/images/fsharp_phonecat/step_3/Phone_Visit_Workflow.png" width="600" height="500" /></p>

<p>The first two components has been already implemented as part of <a href="/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">step-2</a>. So we just need to wire up the other two components. Let’s start from <code>PhoneViewTracker</code></p>

<p>Create a source file in the <strong>Web</strong> project and name it as <code>PhoneViewTracker</code>. Add a function <code>observePhonesViewed</code> which will be invoked when you a user visits a phone.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">PhoneViewTracker</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">observePhonesViewed</span> <span class="n">anonymousId</span> <span class="n">phoneIdBeingVisited</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">StorageAgent</span><span class="p">.</span><span class="n">Post</span> <span class="o">(</span><span class="n">SavePhoneVisit</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">phoneIdBeingVisited</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>anonymousId</code> is a <a href="http://msdn.microsoft.com/en-us/library/system.web.httprequest.anonymousid%28v=vs.110%29.aspx">http property</a> which represents a unique identifier for the given user session</p>

<p>Upon receiving the <code>anonymousId</code> and <code>phoneIdBeingVisited</code> we will be posting a message to the <code>StorageAgent</code> to save this visit. Both the agent and the message doesn’t exist now, so lets create them</p>

<p>Create a source file in the <strong>Domain</strong> project and name it as <code>UserNavigationHistory</code> and add the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Reactive.Subjects</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Collections.Generic</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Agent</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">MailboxProcessor</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">T</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">UserNavigationHistory</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">StorageAgentMessage</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">storageAgentFunc</span> <span class="o">(</span><span class="n">agent</span> <span class="o">:</span> <span class="n">Agent</span><span class="o">&lt;</span><span class="n">StorageAgentMessage</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">loop</span> <span class="o">(</span><span class="n">dict</span> <span class="o">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">list</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">storageAgentMessage</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
</span><span class="line">      <span class="k">match</span> <span class="n">storageAgentMessage</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">phoneIdBeingVisited</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="k">if</span> <span class="n">dict</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">            <span class="k">let</span> <span class="nv">phoneIdsVisited</span> <span class="o">=</span> <span class="n">phoneIdBeingVisited</span> <span class="o">::</span> <span class="n">dict</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span>
</span><span class="line">            <span class="n">dict</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">phoneIdsVisited</span>
</span><span class="line">          <span class="k">else</span>
</span><span class="line">            <span class="n">dict</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="o">[</span><span class="n">phoneIdBeingVisited</span><span class="o">])</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">loop</span> <span class="n">dict</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="n">loop</span> <span class="o">(</span><span class="k">new</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">list</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">StorageAgent</span> <span class="o">=</span> <span class="nn">Agent</span><span class="p">.</span><span class="n">Start</span><span class="o">(</span><span class="n">storageAgentFunc</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Storage Agent is an F# Agent which stores the user navigation history in an in-memory dictionary. It can be replaced by any key-value store like <a href="http://redis.io/">redis</a> but for experimentation I’ve preferred to use F# Agents.</p>

<p>The <code>StorageAgentMessage</code> is a <a href="http://fsharpforfunandprofit.com/posts/discriminated-unions/">dicriminated union</a> represents possible messages that the <code>StorageAgent</code> can process. Right now it has only message <code>SavePhoneVisit</code> which takes a tuple representing the <code>anonymousId</code> and the <code>phoneIdBeingVisited</code></p>

<p>The <code>StorageAgent</code> is a typical F# Agent which waits for the incoming <code>StorageAgentMessage</code> and upon receiving it stores the visit in the in-memory dictionary. </p>

<p>The next step is wiring the <code>PhoneViewTracker.observePhonesViewed</code> function with the <code>PhoneController.Show</code> action method. We can call the function directly that will create a strongly coupled code. We can even directly post the message to the agent. But that also makes the code tightly coupled. </p>

<p>What we are actually trying to implement here is a <strong>User Phone Visit Stream</strong>. Whenever the user visits a phone, we just want to notifiy somebody to keep track of it and move on. And its where <a href="http://msdn.microsoft.com/en-in/data/gg577609.aspx">Reactive Extensions aka Rx</a> comes into the picture. If you are new to Reactive Programming or Rx, I strongly recommend you to go through <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">this excellent article</a> by <a href="http://staltz.com/">André Staltz</a></p>

<p>Install the <a href="https://www.nuget.org/packages/Rx-Main/">Rx Nuget Package</a> in the <em>Web</em> project. With Rx in the kitty the next step is to make the User’s phone visit as event and subscribe this event with the <code>PhoneViewTracker</code></p>

<p>The first step is to make the <code>PhoneController</code> as observable. Modify the already created <code>PhoneController</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">PhoneController</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Subject</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">interface</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span> <span class="k">with</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Subscribe</span> <span class="n">observer</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">Subscribe</span> <span class="n">observer</span>
</span><span class="line">
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Show</span> <span class="o">(</span><span class="n">id</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phone</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">id</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">PhoneViewModel</span><span class="p">.</span><span class="n">ToPhoneViewModel</span>
</span><span class="line">    <span class="n">subject</span><span class="o">.</span><span class="n">OnNext</span> <span class="n">id</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">phone</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">Dispose</span> <span class="n">disposing</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="n">disposing</span> <span class="k">then</span>
</span><span class="line">      <span class="n">subject</span><span class="o">.</span><span class="n">OnCompleted</span><span class="bp">()</span>
</span><span class="line">      <span class="n">subject</span><span class="o">.</span><span class="n">Dispose</span><span class="bp">()</span>
</span><span class="line">    <span class="k">base</span><span class="o">.</span><span class="n">Dispose</span> <span class="n">disposing</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>One of the great feature of F# is its seamless interoperability with C# libraries. As you seen in the above code snippet we have just made the <code>PhoneController</code> into an observable by implementing the interface <a href="http://msdn.microsoft.com/en-us/library/dd990377%28v=vs.110%29.aspx">IObservable</a>. </p>

<p>We have created a private <a href="http://msdn.microsoft.com/en-us/library/hh242970%28v=vs.103%29.aspx">Rx Subject</a> and made it responsible for pushing the notification which contains the phone id that is being visited.</p>

<p>But wait how do we configure the subscription between this controller and the <code>PhoneViewTracker</code> ? Thanks to the CompositionRoot that we have <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/2/Web/Infrastructure.fs#L28-L32">created in the step-2</a>. As we have full control over the creation of controller its just a matter of two lines to achieve it.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">      <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">        <span class="c1">// ...</span>
</span><span class="line">        <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhoneController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToCatalogPhone</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">observer</span> <span class="o">=</span> <span class="nn">PhoneViewTracker</span><span class="p">.</span><span class="n">observePhonesViewed</span> <span class="o">(</span><span class="n">requestContext</span><span class="o">.</span><span class="n">HttpContext</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">AnonymousID</span><span class="o">)</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">phoneController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhoneController</span><span class="o">(</span><span class="n">phones&#39;</span><span class="o">)</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">subscription</span> <span class="o">=</span> <span class="n">phoneController</span><span class="o">.</span><span class="n">Subscribe</span> <span class="n">observer</span>
</span><span class="line">          <span class="n">phoneController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">        <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We are leveraging the ASP.NET’s <a href="http://msdn.microsoft.com/en-us/library/fsykd036.aspx">Anonymous Identification Module</a> which help us in creating a unique anonymous id for every user session. We can retrieve it from the <a href="http://msdn.microsoft.com/en-us/library/system.web.httprequest.anonymousid.aspx">HttpRequest</a> as mentioned in the above snippet</p>

<p><a href="http://msdn.microsoft.com/en-in/library/91ka2e6a(v=vs.85).aspx">Anonymous identification of user session</a> are not enabled by default, so add the following entry in the <strong>Web.config</strong> file</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;configuration&gt;</span>
</span><span class="line">  <span class="c">&lt;!-- Existing Code ignored for brevity ... --&gt;</span>
</span><span class="line">  <span class="nt">&lt;system.web&gt;</span>
</span><span class="line">    <span class="c">&lt;!-- Existing Code ignored for brevity... --&gt;</span>
</span><span class="line">    <span class="nt">&lt;anonymousIdentification</span> <span class="na">enabled=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/system.web&gt;</span>
</span><span class="line"><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With the help of the partial application of functions as we did it in the previous steps, we have created a partial function called <code>observer</code> which has the signature <code>string -&gt; unit</code>. Then we have subscribed to <code>PhoneController</code> using the <code>Subscribe</code> method and with this we are done with saving an user visit. </p>

<h3 id="recommending-a-phone">2. Recommending a phone</h3>

<p><strong>Workflow</strong></p>

<p><img class="center" src="/images/fsharp_phonecat/step_3/Phone_Recommendation_Workflow.png" width="600" height="500" /></p>

<ol>
  <li>User initiates the recommendation request using SignalR</li>
  <li>Upon receiving it, Recommendation SignalR hub sends a recommendation request message to Storage Agent with the user Anonymous Id and SignlaR connection Id of the given user</li>
  <li>Storage Agent then fetches the phone visit history of the given user based on the incoming anonymous id and pass it to the Recommendation Agent along with the SignalR connection id.</li>
  <li>Recommendation Agent responds to this by computing the recommendation and publish the result (Either recommended phone id or none) in the Recommendation observable</li>
  <li>Recommendation hub receives this recommendation result, send the response back to the corresponding SignalR client.</li>
</ol>

<p>The beauty of this entire workflow is all are message driven and asynchronous by default.  </p>

<p>Let’s start from Recommendation SignalR hub. The first step is installing SingalR from <a href="https://www.nuget.org/packages/Microsoft.AspNet.SignalR/2.1.2">the nuget</a>.</p>

<p>After installing create a source file in the <strong>Web</strong> project and name it as <code>Startup</code> then add the following code as per the SignalR convention.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Web</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">Owin</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Startup</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Configuration</span><span class="o">(</span><span class="n">app</span> <span class="o">:</span> <span class="n">IAppBuilder</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">MapSignalR</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then add an app setting in the <em>Web.config</em> file and configure the SignalR to use this <code>Startup</code> class</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;configuration&gt;</span>
</span><span class="line">  <span class="nt">&lt;appSettings&gt;</span>
</span><span class="line">    <span class="c">&lt;!-- Other keys.. --&gt;</span>
</span><span class="line">    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">&quot;owin:AppStartup&quot;</span> <span class="na">value=</span><span class="s">&quot;PhoneCat.Web.Startup&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/appSettings&gt;</span>
</span><span class="line">  <span class="c">&lt;!-- other configuration items.. --&gt;</span>
</span><span class="line"><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With SignalR added to the system, the next step is to create <code>RecommendationHub</code>. Add a source file in <strong>Web</strong> project and name it as <code>Hubs</code>.</p>

<p>Then create a <code>RecommendationHub</code> class with a public method <code>GetRecommendation</code> which will be invoked by the SignalR client to initiate recommendation process.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">RecommendationHub</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">Hub</span> <span class="bp">()</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetRecommendation</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">encodedAnonymousId</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">Cookies</span><span class="o">.[</span><span class="s">&quot;.ASPXANONYMOUS&quot;</span><span class="o">].</span><span class="n">Value</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">anonymousId</span> <span class="o">=</span> <span class="n">decode</span> <span class="n">encodedAnonymousId</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">connectionId</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">ConnectionId</span>
</span><span class="line">      <span class="nn">StorageAgent</span><span class="p">.</span><span class="n">Post</span> <span class="o">(</span><span class="n">GetRecommendation</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">connectionId</span><span class="o">))</span>
</span><span class="line">      <span class="s">&quot;Recommendation initiated&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then anonymous id of the user session is actually persisted in the <a href="http://msdn.microsoft.com/en-in/library/91ka2e6a%28v=vs.85%29.aspx">request cookies by Asp.Net</a> in an encoded format. In the <code>GetRecommendation</code> method we will be retrieving this encoded anonymous id from the cookie and decode it. Then we need to get the SignalR connection id which available in the base class <code>Hub</code>. After getting both the anonymous id and the connection id, send a <code>GetRecommendation</code> message to the <code>StorageAgent</code> with these information. Finally send a response to the SignalR client as “Recommendation initiated”.</p>

<p>The <code>decode</code> function is not added yet so let’s add them. Thanks to <a href="http://stackoverflow.com/a/2481110/159850">this stackoverflow answer</a> we just need to convert the code from C# to F#</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">decode</span> <span class="n">encodedAnonymousId</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">decodeMethod</span> <span class="o">=</span>
</span><span class="line">      <span class="n">typeof</span><span class="o">&lt;</span><span class="n">AnonymousIdentificationModule</span><span class="o">&gt;</span>
</span><span class="line">        <span class="o">.</span><span class="n">GetMethod</span><span class="o">(</span><span class="s">&quot;GetDecodedValue&quot;</span><span class="o">,</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">Static</span> <span class="o">|||</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">anonymousIdData</span> <span class="o">=</span> <span class="n">decodeMethod</span><span class="o">.</span><span class="n">Invoke</span><span class="o">(</span><span class="k">null</span><span class="o">,</span> <span class="o">[|</span> <span class="n">encodedAnonymousId</span> <span class="o">|]);</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">field</span> <span class="o">=</span>
</span><span class="line">      <span class="n">anonymousIdData</span><span class="o">.</span><span class="n">GetType</span><span class="bp">()</span>
</span><span class="line">        <span class="o">.</span><span class="n">GetField</span><span class="o">(</span><span class="s">&quot;AnonymousId&quot;</span><span class="o">,</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="o">|||</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="o">);</span>
</span><span class="line">    <span class="n">field</span><span class="o">.</span><span class="n">GetValue</span><span class="o">(</span><span class="n">anonymousIdData</span><span class="o">)</span> <span class="o">:?&gt;</span> <span class="kt">string</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We have used a special F# operator here <code>:?&gt;</code> which is a dynamic down cast operator which casts a base class to a sub-class of it. You can read <a href="http://msdn.microsoft.com/en-us/library/dd233220.aspx">this msdn documentation</a> to know more about F# casting and conversions.</p>

<p>The <code>GetRecommendation</code> message is not added yet, so let’s add them too. Modify <code>StorageAgentMessage</code> created before as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line">  <span class="k">type</span> <span class="nc">StorageAgentMessage</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span><span class="line">    <span class="o">|</span> <span class="n">GetRecommendation</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The final step of this pipeline is to Update the <code>StorageAgent</code> to handle this <code>GetRecommendation</code> message. Modify the <code>storageAgentFunc</code> in the <code>UserNavigationHistory</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"> <span class="k">let</span> <span class="nv">private</span> <span class="n">storageAgentFunc</span> <span class="o">(</span><span class="n">agent</span> <span class="o">:</span> <span class="n">Agent</span><span class="o">&lt;</span><span class="n">StorageAgentMessage</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">loop</span> <span class="o">(</span><span class="n">dict</span> <span class="o">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">list</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">storageAgentMessage</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
</span><span class="line">      <span class="k">match</span> <span class="n">storageAgentMessage</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">phoneIdBeingVisited</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="c1">// .. existing code ignored for brevity ..</span>
</span><span class="line">      <span class="o">|</span> <span class="n">GetRecommendation</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">connectionId</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="k">if</span> <span class="n">dict</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">            <span class="k">let</span> <span class="nv">phoneIdsVisited</span> <span class="o">=</span> <span class="n">dict</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span>
</span><span class="line">            <span class="nn">RecommendationAgent</span><span class="p">.</span><span class="n">Post</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span><span class="n">phoneIdsVisited</span><span class="o">)</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">loop</span> <span class="n">dict</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Handling of the <code>GetRecommendation</code> message is very straight forward. Just get the phone ids being visited by the given anonymous id from the in memory dictionary and send a message consists of connection id and this phone ids visited to the <code>RecommendationAgent</code> which we will be creating next.</p>

<p>Create a source file with the name <code>Recommendations</code> in the <strong>Domain</strong> project and add the <code>RecommendationAgent</code> below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Recommendation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">recommendationAgentFunc</span> <span class="o">(</span><span class="n">inbox</span> <span class="o">:</span> <span class="n">Agent</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">*</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">messageLoop</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">connectionId</span><span class="o">,</span> <span class="n">visitedPhoneIds</span> <span class="o">=</span> <span class="n">inbox</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="nn">Seq</span><span class="p">.</span><span class="n">length</span> <span class="n">visitedPhoneIds</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">then</span>
</span><span class="line">        <span class="n">suggestRecommendation</span> <span class="n">connectionId</span> <span class="o">(</span><span class="n">visitedPhoneIds</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">take</span> <span class="mi">2</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toList</span><span class="o">)</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">messageLoop</span><span class="bp">()</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">messageLoop</span> <span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">RecommendationAgent</span> <span class="o">=</span> <span class="nn">Agent</span><span class="p">.</span><span class="n">Start</span> <span class="n">recommendationAgentFunc</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In order to keep this blog post simple I’ve used my own ‘Hello World’ kind of algorithm which picks the latest two phone ids being visited and suggests recommendation based on it. In a real world you would be replacing this toddler algorithm with more sophisticated algorithms like <a href="http://en.wikipedia.org/wiki/Association_rule_learning">Association Rule Learning</a>. I am planning to implement this algorithm at later stages of this blog series.</p>

<p>Then the next step is to implement the <code>suggestRecommendation</code> function which picks a hardcoded recommendation and publish the result using Rx. To do this add the <a href="https://www.nuget.org/packages/Rx-Main/">Rx Nuget Package</a> in the <strong>Domain</strong> project and add the  <code>suggestRecommendation</code> function in the <code>Recommendation</code> module</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">RecommendationPipe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Subject</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">*</span><span class="kt">string</span> <span class="n">option</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">suggestRecommendation</span> <span class="n">connectionId</span> <span class="n">visitedPhoneIds</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">visitedPhoneIds</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="o">[</span><span class="s">&quot;motorola-xoom-with-wi-fi&quot;</span><span class="o">;</span> <span class="s">&quot;motorola-xoom&quot;</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">OnNext</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">Some</span> <span class="s">&quot;motorola-atrix-4g&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="o">[</span><span class="s">&quot;dell-streak-7&quot;</span><span class="o">;</span> <span class="s">&quot;dell-venue&quot;</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">OnNext</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">Some</span> <span class="s">&quot;nexus-s&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">OnNext</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">None</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The implementation is a very straight forward pattern matching. If last visited two items are (“motorola-xoom-with-wi-fi”, “motorola-xoom”), send the recommendation as “motorola-atrix-4g”, else if they are (“dell-streak-7”,”dell-venue”) then recommend “nexus-s”. If none of the condition matches then send none. Thanks to the <a href="http://fsharpforfunandprofit.com/posts/the-option-type/">option type</a> which expresses this result in type safe manner.</p>

<p>With all these infrastructure in place, all we need to do is to just subscribe to this <code>RecommendationPipe</code> and send the suggestion to the user via SignalR</p>

<p>Let’s add a observer for this pipe in the <strong>Web</strong> project. Open <code>Hubs</code> module in the <strong>Web</strong> project and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">getUrl</span> <span class="o">(</span><span class="n">phoneId</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="n">httpContext</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">routeValueDictionary</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RouteValueDictionary</span><span class="bp">()</span>
</span><span class="line">    <span class="n">routeValueDictionary</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;controller&quot;</span><span class="o">,</span> <span class="s">&quot;Phone&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">routeValueDictionary</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;action&quot;</span><span class="o">,</span> <span class="s">&quot;Show&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">routeValueDictionary</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">phoneId</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">requestContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RequestContext</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpContextWrapper</span><span class="o">(</span><span class="n">httpContext</span><span class="o">),</span> <span class="k">new</span> <span class="n">RouteData</span><span class="bp">()</span><span class="o">);</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">virtualPathData</span> <span class="o">=</span> <span class="nn">RouteTable</span><span class="p">.</span><span class="nn">Routes</span><span class="p">.</span><span class="n">GetVirtualPath</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">routeValueDictionary</span><span class="o">);</span>
</span><span class="line">    <span class="n">virtualPathData</span><span class="o">.</span><span class="n">VirtualPath</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">notifyRecommendation</span> <span class="n">httpContext</span> <span class="n">phones</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">recommendedPhoneId</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span>
</span><span class="line">    <span class="k">match</span> <span class="n">recommendedPhoneId</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="n">phoneId</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">recommendedPhone</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getPhoneById</span> <span class="n">phones&#39;</span> <span class="n">phoneId</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">phoneUrl</span> <span class="o">=</span> <span class="n">getUrl</span> <span class="n">phoneId</span> <span class="n">httpContext</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">hubContext</span> <span class="o">=</span> <span class="nn">GlobalHost</span><span class="p">.</span><span class="nn">ConnectionManager</span><span class="p">.</span><span class="n">GetHubContext</span><span class="o">&lt;</span><span class="n">RecommendationHub</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">      <span class="n">hubContext</span><span class="o">.</span><span class="n">Clients</span><span class="o">.</span><span class="n">Client</span><span class="o">(</span><span class="n">connectionId</span><span class="o">)?</span><span class="n">showRecommendation</span><span class="o">(</span><span class="n">recommendedPhone</span><span class="o">,</span> <span class="n">phoneUrl</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>notifyRecommendation</code> function checks whether the incoming recommendedPhoneId has value or not. If it has value, it just picks the <code>Phone</code> record corresponding to the given phoneId and get the url for the recommended phone. With all these data in place, we just need to send the response to the using via SignalR.</p>

<p>You would have a noticed a weird <code>?</code> symbol which is actually part of the <a href="https://www.nuget.org/packages/ImpromptuInterface.FSharp/">ImpromptuInterface.FSharp</a>. This library adds provisions to use <a href="http://msdn.microsoft.com/en-IN/library/dd264736.aspx">C# dynamic types</a> in F#</p>

<p>They are two missing pieces. One is <code>Phones.getPhoneById</code> which we are not having. Let’s add them. Open <code>Phones</code> module in <strong>Domain</strong> project and add it as mentioned below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getPhoneById</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="n">phoneId</span> <span class="o">=</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">phoneId</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The final step is wiring the <code>RecommendationPipe</code> with the <code>notifyRecommendation</code>. Open <code>Global.asax.fs</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Global</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// .. existing code ignore for brevity ..</span>
</span><span class="line"> <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Application_Start</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhones</span><span class="bp">()</span>
</span><span class="line">    <span class="c1">// .. existing code ignore for brevity ..</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">notificationObserver</span> <span class="o">=</span> <span class="nn">Hubs</span><span class="p">.</span><span class="n">notifyRecommendation</span> <span class="nn">HttpContext</span><span class="p">.</span><span class="n">Current</span> <span class="n">phones</span>
</span><span class="line">    <span class="nn">Recommendation</span><span class="p">.</span><span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">Subscribe</span> <span class="n">notificationObserver</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Partial application of function is a very handy thing which actually replaces its counterpart Dependency Injection in the OOP. We just provided the first two arguments of <code>notifyRecommendation</code> and created a new function with the signature <code>string * string option -&gt; unit</code> which is the expected observer signature for the <code>RecommendationPipe</code>.</p>

<h4 id="the-front-end-ui">The Front End UI</h4>
<p>The front end for this is a typical SignalR-Javascript client code which you can find it the <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/3/Web/Scripts/recommendation.js">github repository</a>. I’ve intentionally leaving the front-end part of this application as it would be extends the scope of the blog post. Moreover if you go through the source code in the github repository you can easily understand</p>

<h3 id="summary">Summary</h3>
<p>F# is just so awesome with so much expressive functional programming features. Rx, Agents and SignalR add more powers to it and enable you to create a scalable functional reactive architecture. I’d like give credits two incredible resources on this subject Mark Seemann’s Pluralsight course on <a href="http://www.pluralsight.com/courses/functional-architecture-fsharp">Functional Architecture with F#</a> and Kevin Ashton’s excellent blog post on <a href="http://namelessinteractive.com/blog/Full_Stack_FSharp_%E2%80%93_The_Long_Version_(Part_1)">Full Stack F#</a> which helped me a lot in coming out with this blog post.</p>

<p>Last but not the least, Thanks to <a href="https://sergeytihon.wordpress.com">Sergey Tihon</a> for the words of encouragement to write the blog post on this topic.</p>

<p>You can find the source code of this step in <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/3">the github repository</a>. </p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
        <a href="6" class="prev">Prev</a>
    
    
        <a href="8" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2017

    Tamizhvendan S


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'tamizhvendan-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>






</body>
</html>
