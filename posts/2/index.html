
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>P3 Programmer</title>
	<meta name="author" content="Tamizhvendan S">

	
	<meta name="description" content="May 1st, 2017 experiences, golang Comments Using Golang in Production - My Experiences For the last one year, I was working with the development &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="http://feeds.feedburner.com/tamizhvendan-blog" rel="alternate" title="P3 Programmer" type="application/atom+xml">
	
	<link rel="canonical" href="http://blog.tamizhvendan.in/posts/2/">
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link href="/favicon.png" rel="shortcut icon">
  <link href='/stylesheets/fonts.css' rel='stylesheet' type='text/css'>
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <style type="text/css">

  </style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
	<!-- Start of Leadin Embed -->
  <script type="text/javascript" src="//js.leadin.com/js/v1/2177345.js" id="LeadinEmbed-2177345" crossorigin="use-credentials" async defer></script>
<!-- End of Leadin Embed -->
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-43004255-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><style>
@media (max-width: 600px) {
  #book-cover, #tag-cloud {
    display: none;
  }
}
</style>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a target="_blank" href="http://about.me/tamizhvendan">About Me</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <br/>
    <li><a target="_blank" href="https://www.codementor.io/tamizhvendan?utm_source=github&utm_medium=button&utm_term=tamizhvendan&utm_campaign=github"><img src="https://cdn.codementor.io/badges/book_session_github.svg" alt="Book session on Codementor" style="max-width:100%" /></a>
		</li>
    <br/>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a target="_blank" class="email" href="mailto:tamizh88@gmail.com" title="Email">Email</a>
		
		
		
		
			<a target="_blank" class="twitter" href="http://twitter.com/tamizhvendan" title="Twitter">Twitter</a>
		
		
			<a target="_blank" class="github" href="https://github.com/tamizhvendan" title="GitHub">GitHub</a>
		
		
			<a target="_blank" class="coderwall" href="https://coderwall.com/tamizhvendan" title="Coderwall">Coderwall</a>
		
		
		
		
		
		
		
		
		
    	
    	
			<a target="_blank" class="rss" href="http://feeds.feedburner.com/tamizhvendan-blog" title="RSS">RSS</a>
		
	</div>
</nav>
<nav id="book-cover" style="margin-top:32px">
	<a target="_blank" href="http://products.tamizhvendan.in/fsharp-applied">
	<img class="center" src="/images/fsharp_applied_cover.jpg" width="160">
</a>
</nav>
<nav id="tag-cloud">
	<section>
    <!-- <h3>Tag Cloud</h3>
    <span id="tag-cloud"><a href='/blog/categories/asp-dot-net-mvc' style='font-size: 140.0%'>asp.net mvc</a> <a href='/blog/categories/c-number' style='font-size: 110.0%'>c#</a> <a href='/blog/categories/craftsmanship' style='font-size: 115.0%'>craftsmanship</a> <a href='/blog/categories/entity-framework' style='font-size: 112.5%'>entity framework</a> <a href='/blog/categories/fsharp' style='font-size: 160.0%'>fsharp</a> <a href='/blog/categories/functional-programming' style='font-size: 120.0%'>functional-programming</a> <a href='/blog/categories/golang' style='font-size: 110.0%'>golang</a> <a href='/blog/categories/javascript' style='font-size: 110.0%'>javascript</a> <a href='/blog/categories/programming' style='font-size: 115.0%'>programming</a> <a href='/blog/categories/suave' style='font-size: 115.0%'>suave</a> <a href='/blog/categories/unit-testing' style='font-size: 112.5%'>unit testing</a> </span> -->
</section>
</nav>


</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2017-05-01T07:50:32+05:30" data-updated="true" itemprop="datePublished">May 1<sup>st</sup>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/experiences/'>experiences</a>, <a class='category' href='/blog/categories/golang/'>golang</a>


</div>
		
			<span class="comments"><a href="/blog/2017/05/01/using-golang-in-production-my-experiences/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2017/05/01/using-golang-in-production-my-experiences/" itemprop="url">Using Golang in Production - My Experiences</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>For the last one year, I was working with the development team of a leading media entertainment company in India and developed a cloud platform to distribute the <a href="https://en.wikipedia.org/wiki/Digital_Cinema_Package">DCPs</a> across the globe in a uniform, scalable and cost-effective manner.</p>

<p>We built the entire platform using <a href="https://golang.org/">golang</a> and <a href="https://www.nginx.com/blog/event-driven-data-management-microservices/">event-driven microservices architecture</a>. It was an exciting journey, and this blog post summarizes my experiences of using golang in this project.</p>

<h2 id="the-learning-curve">The Learning Curve</h2>

<p>Golang is <a href="https://www.youtube.com/watch?v=rFejpH_tAHM">a simple language</a> to learn. Any developer who has some good experience in any programming language can pick it in a month. It took me two weeks to understand the language. </p>

<p>I’ve also learned a lot from the code review comments from the other developers of my team who are already familiar with the language. </p>

<p>The official golang site has done an excellent job in coming up two important learning resources for the beginners.</p>

<ul>
  <li><a href="https://tour.golang.org">A Tour of Go</a> - Through a series of in-browser hands-on tutorials you can get a good feel of the language in few hours. </li>
  <li><a href="https://golang.org/doc/effective_go.html">Effective Go</a> - It is one the best introduction as well as best practices documentation of a programming language that I have read. Right from package naming convention to how to do state sharing, this documentation will provide all it required to write an idiomatic golang code. </li>
</ul>

<p>In addition to these resources, I recommend the <a href="https://golang.org/doc/faq">Golang FAQs</a> and the <a href="https://gobyexample.com/">GoByExample</a> for the beginners. </p>

<h2 id="go-routines-channels-and-select">Go Routines, Channels and Select</h2>

<p>In my perspective, go routines, channels and select are the sweet spots of golang. These <a href="https://talks.golang.org/2015/simplicity-is-complicated.slide#21">abstractions</a> are elegant and enable you to write concurrent programs without any hassles.</p>

<p>We have made substantial use of golang concurrency whenever it made sense, and the benefits were incredible. The blog post on <a href="https://blog.golang.org/pipelines">Go Concurrency Patterns</a> is an excellent read to get a feel of it.</p>

<h2 id="interfaces-in-golang">Interfaces in golang</h2>

<p>My favorite feature in golang is its support for <a href="https://gobyexample.com/interfaces">interfaces</a>. </p>

<p>Unlike C# or Java, you don’t need to specify the name of the interface when a type implements an interface. Because of this, the package in which the type present, doesn’t need to refer the package in which the interface has been declared.</p>

<p>Yan Cui has written a great <a href="https://hackernoon.com/why-i-like-gos-interfaces-2891adf2803c">blog post</a> about its elegance.</p>

<blockquote>
  <p>The design for Go’s interface stems from the observation that <strong>patterns and abstractions only become apparent after we’ve seen it a few times</strong>. So rather than locking us in with abstractions at the start of a project when we’re at the point of our greatest ignorance, we can define these abstractions as and when they become apparent to us. - <em>Yan Cui</em></p>
</blockquote>

<h2 id="the-go-proverbs">The Go Proverbs</h2>

<p>The <a href="https://go-proverbs.github.io/">Go Proverbs</a> provides a set of principles and guidelines while developing software in golang. </p>

<p>Though certain principles <em>(A little copying is better than a little dependency.)</em> look weird, they have profound meaning behind it. </p>

<p>Like the saying, <em>“You need to spend time crawling alone through shadows to truly appreciate what it is to stand in the sun.”</em>, to appreciate these proverbs you need to spend a decent amount time in developing software in go.</p>

<h2 id="golang-standard-library">Golang Standard Library</h2>

<p>The golang <a href="https://golang.org/pkg/">standard library</a> is futuristic. It has pretty much all that is required for solving the general problems efficiently. </p>

<p>The surprising factor for me is treating <a href="https://golang.org/pkg/encoding/json/">JSON</a> as a first class citizen in the standard library. </p>

<p>Most of the languages rely on an open source library to deal with JSON. Having JSON handling as part of the standard library shows how much thought and care has been put in.</p>

<h2 id="declared-and-not-used-compiler-error">Declared and Not used Compiler Error</h2>

<p>Another good thing that golang got it right is showing compiler errors for unused variables and packages. </p>

<p>The software which we write evolve along with its business requirements. Continuous refactoring, feature addition or deletion, changing the architecture to meet the new demands are some the stuff that we do during the evolution of the software. During these activities often we miss removing the unused code and the packages that we were using before.</p>

<p>Through this compiler error, golang forces the developer to write better code. The biggest advantage is while reading the code written by someone, you can be sure that the variables and the packages are always being used.</p>

<p>Also removing unused packages results in smaller binary size.</p>

<h2 id="go-command-command-line-interface-and-go-tools">go Command (Command Line Interface) and go tools</h2>

<p>The <a href="https://golang.org/cmd/go/">go command</a> is an another well thought out feature in golang which comes by default with the installation. </p>

<p>Using <code>go command</code>, you can compile &amp; build the code, download and install external packages, run the tests and lot more without relying on any other external tools. The <code>go test</code> command is incredibly fast and it made our job easier while doing Test-Driven development. </p>

<p>The <a href="https://golang.org/cmd/gofmt/">gofmt</a> command enabled our team to follow a consistent formatting of golang source files. Thanks to this awesome tool we hardly had code review comments on the format of the code.</p>

<p>The <a href="https://godoc.org/golang.org/x/tools">golang tools</a>, especially <a href="https://godoc.org/golang.org/x/tools/cmd/goimports">goimports</a> and <a href="https://godoc.org/golang.org/x/tools/cmd/gorename">gorename</a> has been extremely useful </p>

<h2 id="go-install-and-single-executable-binary">go install and Single executable binary</h2>

<p>The command which I loved the most in golang is the <code>go install</code> command. It takes care of compiling the code and produces a stand alone executable binary. Due to caching of intermediary packages, it builds the executable binary incredibly fast.</p>

<p>To run this resulted binary file, we don’t have to install anything on the target machine <em>(Like JVM, .NET)</em>.</p>

<p>It enabled us to share the microservice as an executable file with the other team members to create <a href="http://www.extremeprogramming.org/rules/spike.html">spikes</a>, develop and locally test other dependent microservices. </p>

<blockquote>
  <p>Just like bundling the front-end assets into single javascript file and serving them via CDNs, we can even do continuous deployment of golang codebase by serving the binaries from a content provider like Amazon S3, if it makes sense!</p>
</blockquote>

<p>We can also do <a href="https://dave.cheney.net/2015/08/22/cross-compilation-with-go-1-5">cross-compilation</a> of your golang code for different OSes and Architectures using <code>go build</code> command. </p>

<h2 id="open-source-libraries-in-golang">Open Source Libraries in golang</h2>

<p>Golang has a thriving open source community, and it houses a vast collection of <a href="https://github.com/avelino/awesome-go">open source libraries and frameworks</a>. Here is the list of some of the things that we have used heavily</p>

<ul>
  <li><a href="https://github.com/streadway/amqp">AMQP</a> - To interact with RabbitMQ</li>
  <li><a href="https://github.com/jinzhu/gorm">GORM</a> - To perform database operations in PostgreSQL</li>
  <li><a href="https://github.com/satori/go.uuid">go-uuid</a> - To generate and use UUIDs</li>
  <li><a href="https://github.com/mattes/migrate">migrate</a> - For database migrations</li>
  <li><a href="https://github.com/kelseyhightower/envconfig">envconfig</a> - For managing configuration data from environment variables</li>
  <li><a href="https://github.com/urfave/negroni">negroni</a> - To write HTTP middlewares</li>
  <li><a href="http://github.com/julienschmidt/httprouter">httprouter</a> - For handling HTTP routes. We have used this along with golang’s <a href="https://golang.org/doc/articles/wiki/">standard HTTP handlers</a> </li>
  <li><a href="http://github.com/sirupsen/logrus">logrus</a> - Simple and powerful library for logging</li>
  <li><a href="https://github.com/stretchr/testify">testify</a> - For unit test assertions</li>
</ul>

<p>For most of the common things that you’d like to do in your project, you can always find an off the shelf open source library</p>

<h2 id="private-methods-functions-and-struct-fields">Private methods, functions and struct fields</h2>

<p>I was admired when I came to know that just by using <a href="https://golang.org/ref/spec#Exported_identifiers">a naming convention</a>, I can specify public and private methods, functions and struct fields. </p>

<p>It is a smart feature in the language. If you want to expose them as public, start with an upper case letter and start with a lower case letter if you want to them to be used only inside a package or a struct. </p>

<h2 id="not-so-good-features-in-golang">Not So Good Features in Golang</h2>

<p>So far in this blog post, I’ve shared the features that I liked very much in golang. In the rest of the post, I am about to share the not so good features in golang. The heading was intentionally started with “Not So Good” as the things that I am about to share are not bad ones according to the golang language design principles and the go proverbs that we have seen earlier.</p>

<p>IMHO there is no perfect programming language, and there is no silver bullet. All languages shine in certain areas and not so good in some other areas. At the end of the day, a programming language is just a tool which we use to solve the business problems. We need to pick an appropriate language that solves the problem in hand. </p>

<blockquote>
  <p>Disclaimer: The intention of this blog post is to share my experiences and provide honest feedback to the people who is evaluating golang. </p>
</blockquote>

<h2 id="the-golang-way-of-handling-errors">The Golang way of handling errors</h2>

<p>The imperative way of handling errors is one of the <a href="http://stackoverflow.com/questions/18771569/avoid-checking-if-error-is-nil-repetition">common complaint raised</a> by many people.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">foobar1</span><span class="p">()</span>
</span><span class="line"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line"> <span class="k">return</span> <span class="nx">err</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">foobar2</span><span class="p">()</span>
</span><span class="line"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line"> <span class="k">return</span> <span class="nx">err</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">foobar3</span><span class="p">()</span>
</span><span class="line"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line"> <span class="k">return</span> <span class="nx">err</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="c1">// and so on</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Rob Pike addresses this concern in a detailed blog post, <a href="https://blog.golang.org/errors-are-values">Errors are values</a> and quotes a pattern using <code>errWriter</code> to avoid the repetition. It is a good design and elegantly wraps the <code>nil</code> check on the <code>error</code>. The downside of this approach is we need to write an extra wrapper for every new type to get rid of the repetitiveness. The wrapper approach may get complex if the <code>foobar1</code>, <code>foobar2</code>, and <code>foobar3</code> are addressing different concerns. </p>

<p>For people who is coming from typed functional programming languages (F#, Haskell, Scala) background, like me, this may look little awkward to write it in this way. There is a <a href="https://github.com/golang/go/issues/19991">proposal</a> to include Result type in golang but I feel it may not be incorporated.</p>

<h2 id="treating-nil-as-value">Treating nil as value</h2>

<p>While other languages are moving away from dealing with null values and replacing it with option types, golang is taking a backward step by treating <code>nil</code> (equivalent for <code>null</code> in Go) as a valid value. So we need to be cautious while using the nil value. Lack of discipline may result in runtime exceptions (panic in go vocabulary)</p>

<p>This problem can be avoided to some degree by having a function/method to return two values, the actual value to be returned and the error, and ensuring that the actual value will never be <code>nil</code>, if the error is <code>nil</code> and vice versa. Unfortunately, this approach leads to the repetition concern that we just saw.</p>

<h2 id="absence-of-generics">Absence of generics</h2>

<p>This also an another typical critic in golang. There is an answer of for this question in <a href="https://golang.org/doc/faq#generics">golang FAQ</a> saying, it is in the pipeline but my opinion is it may not be in the near future.</p>

<p>There are some workarounds like using <a href="https://tour.golang.org/methods/14">an empty interface</a> and casting it to appropriate types using <a href="https://tour.golang.org/methods/15">type assertion</a>. </p>

<p>The real concern is trying to do map, filter, reduce operations over collections. Again there are workarounds by using <a href="http://bouk.co/blog/idiomatic-generics-in-go/">templating and reflection</a>, but it has its own cost (performance and boilerplate code). After fiddling around with different options, We went back to the classic way of iterating through <code>for loop</code>.</p>

<h2 id="mutable-variables-and-imperative-coding">Mutable variables and imperative coding</h2>

<p>For developers who is coming from the functional programming background, the mutable variables and imperative way of writing code are speed breakers in the golang journey.</p>

<p>Though golang has some <a href="https://golang.org/doc/codewalk/functions/">good support</a> for doing functional programming, the presence of mutable variables and imperative way doing certain things, hinder the progress.</p>

<h2 id="summary">Summary</h2>

<p>Apart from these few concerns, I’ve liked golang and enjoyed using it.</p>

<p>The language design principles of golang are my important takeaways. I strongly recommend watching the <a href="http://go-lang.cat-v.org/talks/">talks of Rob Pike</a> on golang design; even you are not going to use golang.</p>

<p>I’d consider using golang in an another project in future for sure if it is an appropriate language for the problem at hand.</p>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2016-12-26T18:34:27+05:30" data-updated="true" itemprop="datePublished">Dec 26<sup>th</sup>, 2016</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/fsharp/'>fsharp</a>, <a class='category' href='/blog/categories/suave/'>suave</a>


</div>
		
			<span class="comments"><a href="/blog/2016/12/26/implementing-two-factor-authentication-in-suave/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2016/12/26/implementing-two-factor-authentication-in-suave/" itemprop="url">Implementing Two-Factor Authentication in Suave</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Two-factor authentication is a type of <a href="https://en.wikipedia.org/wiki/Multi-factor_authentication">Multi-factor authentication</a> which adds an extra layer of security to the applications.</p>

<p><a href="https://en.wikipedia.org/wiki/Google_Authenticator">Google Authenticator</a> is one of the popular application that implements two-factor authentication services. In this blog post, we are going to learn how to implement Two-factor authentication in web applications developed using <a href="https://suave.io">suave</a></p>

<p>The idea presented here is a naive implementation of Two-factor authentication. The objective here is to demonstrate how to implement it in a functional programming language, F#. Things like TLS/HTTPS, preventing CSRF and other attacks are ignored for brevity. </p>

<blockquote>
  <p>This blog post is a part of <a href="https://sergeytihon.wordpress.com/2016/10/23/f-advent-calendar-in-english-2016/">fsharp advent calendar 2016</a>. </p>
</blockquote>

<h2 id="prerequisite">Prerequisite</h2>

<p>This blog post assumes that you are familiar with the concept of Two-factor authentication and Google Authenticator. </p>

<p>If you would like to know more about these, check out the below resources to get a picture of what it is all about.</p>

<ul>
  <li><a href="https://www.google.com/landing/2step">Two-step verification</a> by Google </li>
  <li><a href="https://garbagecollected.org/2014/09/14/how-google-authenticator-works/">How Google Authenticator works</a></li>
  <li><a href="https://security.stackexchange.com/questions/35157/how-does-google-authenticator-work">A Stack-Overflow Question</a></li>
</ul>

<p>We are going to use <a href="https://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm">Time-based One-time Password(TOTP)</a> algorithm in this blog post</p>

<h2 id="what-we-will-be-building">What we will be building</h2>

<p>We are going to build a tiny web appliaction that has an inbuilt user account with the username <code>foo</code> and the password <code>bar</code></p>

<p><img class="center border" src="/images/suave_two_factor/Login.png" width="300" height="200" /></p>

<p>After successful login, the user redirected to the <strong>Profile</strong> page where the user sees his name with a couple of buttons. One to enable <em>Two-factor authentication</em> and another one to <em>log out</em></p>

<p><img class="center border" src="/images/suave_two_factor/Profile.png" width="350" height="200" /></p>

<p>Upon clicking the <em>Enable Two Factor Authentication</em> button, the user redirected to the <strong>Enable Two Factor Authentication</strong> page where the user has to scan the QR Code with the Google Authenticator App (For <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&amp;hl=en">Android</a> or <a href="https://itunes.apple.com/in/app/google-authenticator/id388497605?mt=8">iPhone</a>). Then he needs to enter the verification code to enable Two-factor authentication for his account. </p>

<p><img class="center border" src="/images/suave_two_factor/Enable_Two_Factor.png" width="450" height="250" /></p>

<p><em>Google Authenticator App</em></p>

<p><img class="center border" src="/images/suave_two_factor/Google_Authenticator.png" width="200" height="400" /></p>

<p>If the verification code matches, the updated <strong>Profile</strong> page will look like </p>

<p><img class="center border" src="/images/suave_two_factor/Profile_After_Two_Factor.png" width="350" height="200" /></p>

<p>Now if the user logout and login again, he will be prompted to enter the verification code </p>

<p><img class="center border" src="/images/suave_two_factor/Auth_Code_Prompt.png" width="250" height="150" /></p>

<p>After entering the verification code from the Google Authenticator, the user will be redirected to his <strong>Profile</strong> page. </p>

<h2 id="getting-started">Getting Started</h2>

<p>Create a new <strong>F# Console Project</strong> with the name <em>Suave.TwoFactorAuth</em> and use Paket to install the following dependencies. </p>

<p><em>paket.dependencies</em></p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class=""><span class="line">nuget FSharp.Core
</span><span class="line">nuget Suave
</span><span class="line">nuget DotLiquid
</span><span class="line">nuget Suave.DotLiquid
</span><span class="line">nuget OtpSharp</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then reference them in the <em>Suave.TwoFactorAuth</em> project.</p>

<p><em>Suave.TwoFactorAuth/paket.references</em></p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class=""><span class="line">FSharp.Core
</span><span class="line">Suave
</span><span class="line">DotLiquid
</span><span class="line">Suave.DotLiquid
</span><span class="line">OtpSharp</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <a href="https://www.nuget.org/packages/OtpSharp/">OtpSharp</a> is an .NET library that we will be using to generate keys and to verify the verification code from Google Authenticator app using the <a href="https://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm">TOTP</a> algorithm.</p>

<p>The reference to <a href="https://www.nuget.org/packages/DotLiquid/">DotLiquid</a> library is required to render the templates using <a href="https://www.nuget.org/packages/Suave.DotLiquid/">Suave.DotLiquid</a></p>

<h2 id="initializing-dotliquid">Initializing DotLiquid</h2>

<p>To use <a href="https://github.com/Shopify/liquid/wiki/Liquid-for-Designers">DotLiquid</a> to render the views in Suave, we need to set the templates directory explicitly. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Suave.TwoFactorAuth.fs</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Suave.TwoFactorAuth.Main</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">Suave</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.IO</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Reflection</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.DotLiquid</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">initializeDotLiquid</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">currentDirectory</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">mainExeFileInfo</span> <span class="o">=</span>
</span><span class="line">      <span class="k">new</span> <span class="n">FileInfo</span><span class="o">(</span><span class="nn">Assembly</span><span class="p">.</span><span class="n">GetEntryAssembly</span><span class="bp">()</span><span class="o">.</span><span class="n">Location</span><span class="o">)</span>
</span><span class="line">    <span class="n">mainExeFileInfo</span><span class="o">.</span><span class="n">Directory</span>
</span><span class="line">  <span class="nn">Path</span><span class="p">.</span><span class="n">Combine</span><span class="o">(</span><span class="n">currentDirectory</span><span class="o">.</span><span class="n">FullName</span><span class="o">,</span> <span class="s">&quot;views&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="n">setTemplatesDir</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="nv">main</span> <span class="n">argv</span> <span class="o">=</span>
</span><span class="line">  <span class="n">initializeDotLiquid</span> <span class="bp">()</span>
</span><span class="line">  <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In this sample application we are going to create a directory <em>views</em>. This <em>views</em> directory will contain the liquid templates of our appliaction</p>

<h2 id="serving-the-login-page">Serving the Login Page</h2>

<p>Let’s start by serving the Login page. </p>

<p>Create a new directory with the name <em>views</em> in the <em>Suave.TwoFactorAuth</em> project and add a new liquid template <em>page.liquid</em>. This <em>page.liquid</em> is the master template for our application</p>

<p><img class="center border" src="/images/suave_two_factor/page.png" width="300" height="300" /></p>

<p>After creating, change the ‘Copy to output’ property of the <em>page.liquid</em> file to ‘Copy if newer’ so that the view files copied to the build output directory. </p>

<p>This step is applicable for all the other view templates that we will be creating later</p>

<blockquote>
  <p>If you are using VS Code or atom editor, you need to do this property change manually by opening the <em>Suave.TwoFactorAuth.fsproj</em> file </p>
</blockquote>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="c">&lt;!-- .... --&gt;</span>
</span><span class="line"><span class="nt">&lt;ItemGroup&gt;</span>
</span><span class="line">  <span class="nt">&lt;Folder</span> <span class="na">Include=</span><span class="s">&quot;views\&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line"><span class="nt">&lt;/ItemGroup&gt;</span>
</span><span class="line"><span class="nt">&lt;ItemGroup&gt;</span>
</span><span class="line">  <span class="nt">&lt;None</span> <span class="na">Include=</span><span class="s">&quot;views\page.liquid&quot;</span><span class="nt">&gt;</span>
</span><span class="line">    <span class="nt">&lt;CopyToOutputDirectory&gt;</span>PreserveNewest<span class="nt">&lt;/CopyToOutputDirectory&gt;</span>
</span><span class="line">  <span class="nt">&lt;/None&gt;</span>
</span><span class="line"><span class="nt">&lt;/ItemGroup&gt;</span>
</span><span class="line"><span class="c">&lt;!-- .... --&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then create a new template file <em>login.liquid</em> in the <em>views</em> directory </p>

<p><img class="center border" src="/images/suave_two_factor/login_view.png" width="500" height="300" /></p>

<p>The <em>login.liquid</em> view extends the <em>page.liquid</em> view and fill the placeholders for <code>head</code> and <code>content</code>.</p>

<p>To display the error messages like <em>Password didn’t match</em>, <em>login.liquid</em> view bounded to the model of type <code>string</code>. </p>

<p>Now we have the view template for the login page ready and the next step is to render it upon receiving an HTTP request.</p>

<p>Create a new fsharp source file <em>Login.fs</em> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Suave.TwoFactorAuth.Login</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">Suave</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.DotLiquid</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Filters</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Operators</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">loginPath</span> <span class="o">=</span> <span class="s">&quot;/login&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">renderLoginView</span> <span class="o">(</span><span class="n">request</span> <span class="o">:</span> <span class="n">HttpRequest</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">errMsg</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">request</span><span class="o">.[</span><span class="s">&quot;err&quot;</span><span class="o">]</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">msg</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s">&quot;&quot;</span>
</span><span class="line">  <span class="n">page</span> <span class="s">&quot;login.liquid&quot;</span> <span class="n">errMsg</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">loginWebPart</span> <span class="o">=</span>
</span><span class="line">  <span class="n">path</span> <span class="n">loginPath</span> <span class="o">&gt;=&gt;</span> <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">      <span class="n">GET</span> <span class="o">&gt;=&gt;</span> <span class="n">request</span> <span class="n">renderLoginView</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As a good practice let’s create a new module <code>Web</code> which will be containing all the WebParts of the application</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Suave.Web.fs</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Login</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">app</span> <span class="o">=</span>
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="n">loginWebPart</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then start the Web Server</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Suave.TwoFactorAuth.fs</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Web</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">let</span> <span class="nv">main</span> <span class="n">argv</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="n">startWebServer</span> <span class="n">defaultConfig</span> <span class="n">app</span>
</span><span class="line">  <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<blockquote>
  <p>Keeping all the Suave WebParts in a single place like we did in the <code>Web.fs</code> file, enable us to host Suave in <a href="https://www.nuget.org/packages/Suave.Azure.Functions">Azure Functions</a> or <a href="https://dusted.codes/running-suave-in-aspnet-core-and-on-top-of-kestrel">Asp.Net Core</a> without doing any significant changes. </p>
</blockquote>

<h2 id="handling-user-login">Handling User Login</h2>

<p>To handle the login request from the user, we need to have some users in the application. Let’s hardcode a user account. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Suave.TwoFactorAuth.fs</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Suave.TwoFactorAuth.User</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Collections.Generic</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">User</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Username</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Password</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line"><span class="n">users</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">,</span> <span class="o">{</span><span class="n">Username</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span><span class="o">;</span> <span class="n">Password</span> <span class="o">=</span> <span class="s">&quot;bar&quot;</span><span class="o">})</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">getUser</span> <span class="n">username</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">users</span><span class="o">.</span><span class="n">TryGetValue</span> <span class="n">username</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="k">true</span><span class="o">,</span> <span class="n">user</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">user</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Post successful login, to serve the subsequent requests we need to identify the user who logged in. We can achieve it Suave using <code>statefulForSession</code>, which initializes a user state for a browsing session. </p>

<p>Let’s create some helper functions to do this. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Combinators.fs</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Suave.TwoFactorAuth.Combinators</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.State.CookieStateStore</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Cookie</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Operators</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Authentication</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">sessionSet</span> <span class="n">failureF</span> <span class="n">key</span> <span class="n">value</span> <span class="o">=</span>
</span><span class="line">  <span class="n">statefulForSession</span>
</span><span class="line">  <span class="o">&gt;=&gt;</span> <span class="n">context</span> <span class="o">(</span><span class="k">fun</span> <span class="n">ctx</span> <span class="o">-&gt;</span>
</span><span class="line">                <span class="k">match</span> <span class="nn">HttpContext</span><span class="p">.</span><span class="n">state</span> <span class="n">ctx</span> <span class="k">with</span>
</span><span class="line">                <span class="o">|</span> <span class="n">Some</span> <span class="n">state</span> <span class="o">-&gt;</span> <span class="n">state</span><span class="o">.</span><span class="n">set</span> <span class="n">key</span> <span class="n">value</span>
</span><span class="line">                <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failureF</span>
</span><span class="line">              <span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">sessionGet</span> <span class="n">failureF</span> <span class="n">key</span> <span class="n">successF</span> <span class="o">=</span>
</span><span class="line">  <span class="n">statefulForSession</span>
</span><span class="line">  <span class="o">&gt;=&gt;</span> <span class="n">context</span> <span class="o">(</span><span class="k">fun</span> <span class="n">ctx</span> <span class="o">-&gt;</span>
</span><span class="line">                <span class="k">match</span> <span class="nn">HttpContext</span><span class="p">.</span><span class="n">state</span> <span class="n">ctx</span> <span class="k">with</span>
</span><span class="line">                <span class="o">|</span> <span class="n">Some</span> <span class="n">store</span> <span class="o">-&gt;</span>
</span><span class="line">                  <span class="k">match</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span> <span class="n">key</span> <span class="k">with</span>
</span><span class="line">                  <span class="o">|</span> <span class="n">Some</span> <span class="n">value</span> <span class="o">-&gt;</span> <span class="n">successF</span> <span class="n">value</span>
</span><span class="line">                  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failureF</span>
</span><span class="line">                <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failureF</span>
</span><span class="line">  <span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">clearSession</span> <span class="o">=</span>
</span><span class="line">  <span class="n">unsetPair</span> <span class="n">SessionAuthCookie</span>
</span><span class="line">    <span class="o">&gt;=&gt;</span> <span class="n">unsetPair</span> <span class="n">StateCookie</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>sessionSet</code> function takes a WebPart and a key value pair and tries to persist the value in the session state with the given key. If it fails, it calls the WebPart. </p>

<p>The <code>sessionGet</code> function takes a success WebPart Combinator, a failure WebPart, and a key. If retrieving the value from session state is successful it calls the success WebPart combinator with the retrieved value. In case of retrieval failure it calls the failure WebPart</p>

<p>The <code>clearSession</code> function clears the state. We will be using it while implementing <em>log out</em></p>

<p>Now we have all the building blocks for handling user login request, and it’s time to start its implementation</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Login.fs</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Redirection</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Authentication</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Cookie</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">Combinators</span>
</span><span class="line"><span class="k">open</span> <span class="nn">User</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">let</span> <span class="nv">userSessionKey</span> <span class="o">=</span> <span class="s">&quot;loggedUser&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">redirectToLogin</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">errMsg</span> <span class="o">-&gt;</span> <span class="n">FOUND</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s">&quot;%s?err=%s&quot;</span> <span class="n">loginPath</span> <span class="n">errMsg</span><span class="o">)</span>
</span><span class="line">  <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="n">FOUND</span> <span class="n">loginPath</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">loginSucess</span> <span class="n">failureW</span> <span class="n">redirectPath</span> <span class="n">username</span> <span class="o">=</span>
</span><span class="line">  <span class="n">authenticated</span> <span class="nn">Cookie</span><span class="p">.</span><span class="nn">CookieLife</span><span class="p">.</span><span class="n">Session</span> <span class="k">false</span>
</span><span class="line">    <span class="o">&gt;=&gt;</span> <span class="n">sessionSet</span> <span class="n">failureW</span> <span class="n">userSessionKey</span> <span class="n">username</span>
</span><span class="line">    <span class="o">&gt;=&gt;</span> <span class="n">FOUND</span> <span class="n">redirectPath</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">onLogin</span> <span class="n">redirectPath</span> <span class="o">(</span><span class="n">request</span> <span class="o">:</span> <span class="n">HttpRequest</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">request</span><span class="o">.[</span><span class="s">&quot;Username&quot;</span><span class="o">],</span> <span class="n">request</span><span class="o">.[</span><span class="s">&quot;Password&quot;</span><span class="o">]</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">username</span><span class="o">,</span> <span class="n">Some</span> <span class="n">password</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">match</span> <span class="n">getUser</span> <span class="n">username</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="n">user</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">match</span> <span class="n">user</span><span class="o">.</span><span class="n">Password</span> <span class="o">=</span> <span class="n">password</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="k">true</span> <span class="o">-&gt;</span> <span class="n">loginSucess</span> <span class="n">never</span> <span class="n">redirectPath</span> <span class="n">username</span>
</span><span class="line">      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">redirectToLogin</span> <span class="o">(</span><span class="n">Some</span> <span class="s">&quot;Password didn&#39;t match&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">redirectToLogin</span> <span class="o">(</span><span class="n">Some</span> <span class="s">&quot;Invalid username&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">redirectToLogin</span> <span class="o">(</span><span class="n">Some</span> <span class="s">&quot;Invalid request&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">secured</span> <span class="n">webpart</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">onFail</span> <span class="o">=</span> <span class="n">redirectToLogin</span> <span class="o">(</span><span class="n">Some</span> <span class="s">&quot;sign-in to access&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="n">sessionGet</span> <span class="n">onFail</span> <span class="n">userSessionKey</span> <span class="n">webpart</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">loginWebPart</span> <span class="n">redirectPath</span> <span class="o">=</span>
</span><span class="line">  <span class="n">path</span> <span class="n">loginPath</span> <span class="o">&gt;=&gt;</span> <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">      <span class="c1">// ...</span>
</span><span class="line">      <span class="n">POST</span> <span class="o">&gt;=&gt;</span> <span class="n">request</span> <span class="o">(</span><span class="n">onLogin</span> <span class="n">redirectPath</span><span class="o">)]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The key function to note here is <code>secured</code> that takes a WebPart. It calls this WebPart only if the user has logged in. If he didn’t the user will be redirected to the Login page</p>

<p>After successful login, we need to redirect the user to his profile page. Let’s create a <code>profile.liquid</code> a view template for the Profile page</p>

<p><img class="center border" src="/images/suave_two_factor/profile_view.png" width="600" height="450" /></p>

<p>To render this profile page let’s add some code </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Profile.fs</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Suave.TwoFactorAuth.Profile</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.DotLiquid</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Redirection</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Filters</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Operators</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">User</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Login</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">ProfileViewModel</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Username</span><span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">SecretKey</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">IsTwoFactorAuthEnabled</span> <span class="o">:</span> <span class="kt">bool</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="k">with</span> <span class="k">static</span> <span class="k">member</span> <span class="n">FromUser</span> <span class="n">user</span> <span class="o">=</span>
</span><span class="line">        <span class="o">{</span>
</span><span class="line">          <span class="n">SecretKey</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class="line">          <span class="n">IsTwoFactorAuthEnabled</span> <span class="o">=</span> <span class="k">false</span>
</span><span class="line">          <span class="n">Username</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Username</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">profilePath</span> <span class="o">=</span> <span class="s">&quot;/profile&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">renderProfile</span> <span class="n">notFoundPath</span> <span class="n">username</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">getUser</span> <span class="n">username</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">user</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">user</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">ProfileViewModel</span><span class="p">.</span><span class="n">FromUser</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">page</span> <span class="s">&quot;profile.liquid&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">FOUND</span> <span class="n">notFoundPath</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">profileWebPart</span> <span class="n">notFoundPath</span> <span class="o">=</span>
</span><span class="line">  <span class="n">path</span> <span class="n">profilePath</span> <span class="o">&gt;=&gt;</span> <span class="n">secured</span> <span class="o">(</span><span class="n">renderProfile</span> <span class="n">notFoundPath</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The labels <code>IsTwoFactorAuthEnabled</code>, <code>SecretKey</code> are just blank right now, and we will be seeing them in action while adding two-factor authentication</p>

<p>The <code>notfound.liquid</code> page that is going to our fancy <code>404</code> page</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="c">&lt;!-- Suave.TwoFactorAuth/views/not_found.liquid --&gt;</span>
</span><span class="line">Not Found :(
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The final step is to put these WebParts together</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Web.fs</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Profile</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.DotLiquid</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Filters</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Operators</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">notFoundPath</span> <span class="o">=</span> <span class="s">&quot;/notfound&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">app</span> <span class="o">=</span>
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="n">loginWebPart</span> <span class="n">profilePath</span>
</span><span class="line">    <span class="n">profileWebPart</span> <span class="n">notFoundPath</span>
</span><span class="line">    <span class="n">path</span> <span class="n">notFoundPath</span> <span class="o">&gt;=&gt;</span> <span class="n">page</span> <span class="s">&quot;not_found.liquid&quot;</span> <span class="s">&quot;&quot;</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="handling-logout">Handling Logout</h2>

<p>Handling logout is a simpler task as we have all the infrastructure already in place. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Web.fs</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Combinators</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Login</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">app</span> <span class="o">=</span>
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="c1">// ...</span>
</span><span class="line">    <span class="n">path</span> <span class="s">&quot;/logout&quot;</span> <span class="o">&gt;=&gt;</span> <span class="n">clearSession</span> <span class="o">&gt;=&gt;</span> <span class="n">redirectToLogin</span> <span class="n">None</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="enabling-two-factor-authentication">Enabling Two-factor Authentication</h2>

<p>To enable Two-factor authentication, we need to change our <code>User</code> domain model first. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/User.fs</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">type</span> <span class="nc">TwoFactorAuthentication</span> <span class="o">=</span>
</span><span class="line"><span class="o">|</span> <span class="n">Enabled</span> <span class="k">of</span> <span class="n">SecretKey</span><span class="o">:</span><span class="kt">string</span>
</span><span class="line"><span class="o">|</span> <span class="n">Disabled</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">User</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="n">TwoFactorAuthentication</span> <span class="o">:</span> <span class="n">TwoFactorAuthentication</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="c1">// ... </span>
</span><span class="line"><span class="c1">// Let&#39;s assume TwoFactorAuthentication is disabled by default </span>
</span><span class="line"><span class="n">users</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">,</span> <span class="o">{</span><span class="n">Username</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span><span class="o">;</span> <span class="n">Password</span> <span class="o">=</span> <span class="s">&quot;bar&quot;</span><span class="o">;</span> <span class="n">TwoFactorAuthentication</span> <span class="o">=</span> <span class="n">Disabled</span><span class="o">})</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">let</span> <span class="nv">enableTwoFactorAuth</span> <span class="n">username</span> <span class="n">key</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">getUser</span> <span class="n">username</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">user</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">users</span><span class="o">.[</span><span class="n">username</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="o">{</span><span class="n">user</span> <span class="k">with</span> <span class="n">TwoFactorAuthentication</span> <span class="o">=</span> <span class="n">Enabled</span> <span class="n">key</span><span class="o">}</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The next step is to define a liquid view template for the <code>enable_two_factor</code> page.</p>

<p><img class="center border" src="/images/suave_two_factor/enable_two_factor_view.png" width="600" height="450" /></p>

<p>While enabling the Two-factor authentication, we need to generate a secret key for the user that will be required for both, one-time verification code generation as well as its verification.</p>

<p>So, in the <em>enable_two_factor.liquid</em> template we pass the generated <code>SecretKey</code> as a <code>hidden</code> input which will then be used for the verification of the code. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;SecretKey&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now we need to render the <code>enable_two_factor</code> page in response to the <em>HTTP GET</em> request <code>/enable_two_factor</code></p>

<p><img class="center border" src="/images/suave_two_factor/Enable_Two_Factor.png" width="450" height="250" /></p>

<p>Let’s create a new module <code>GoogleAuthenticator</code> to put the Two-factor authentication related functions together</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/GoogleAuthenticator.fs</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Suave.TwoFactorAuth.GoogleAuthenticator</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">Suave</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Filters</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Operators</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.DotLiquid</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Redirection</span>
</span><span class="line"><span class="k">open</span> <span class="nn">OtpSharp</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Base32</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">Login</span>
</span><span class="line"><span class="k">open</span> <span class="nn">User</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">enableTwoFactorAuthPath</span> <span class="o">=</span> <span class="s">&quot;/enable_two_factor&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">EnableTwoFactorViewModel</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Key</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Url</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Err</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="k">with</span> <span class="k">static</span> <span class="k">member</span> <span class="n">From</span> <span class="n">username</span> <span class="n">err</span> <span class="o">=</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">secretKey</span> <span class="o">=</span> <span class="nn">KeyGeneration</span><span class="p">.</span><span class="n">GenerateRandomKey</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">appName</span> <span class="o">=</span> <span class="s">&quot;SuaveRocks&quot;</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">label</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s">&quot;%s (%s.com/%s)&quot;</span> <span class="n">appName</span> <span class="n">appName</span> <span class="n">username</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">keyUrl</span> <span class="o">=</span> <span class="nn">KeyUrl</span><span class="p">.</span><span class="n">GetTotpUrl</span><span class="o">(</span><span class="n">secretKey</span><span class="o">,</span> <span class="n">label</span><span class="o">)</span>
</span><span class="line">      <span class="o">{</span> <span class="n">Url</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s">&quot;https://qrcode.kaywa.com/img.php?s=4&amp;d=%s&amp;issuer=%s&quot;</span> <span class="n">keyUrl</span> <span class="n">appName</span>
</span><span class="line">        <span class="n">Key</span> <span class="o">=</span> <span class="nn">Base32Encoder</span><span class="p">.</span><span class="n">Encode</span><span class="o">(</span><span class="n">secretKey</span><span class="o">)</span>
</span><span class="line">        <span class="n">Err</span> <span class="o">=</span> <span class="n">err</span><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">renderEnableTwoFactorAuthView</span> <span class="n">notFoundPath</span> <span class="n">username</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">  <span class="k">match</span> <span class="n">getUser</span> <span class="n">username</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">user</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">err</span> <span class="o">=</span>
</span><span class="line">      <span class="k">match</span> <span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="o">.[</span><span class="s">&quot;err&quot;</span><span class="o">]</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Some</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">err</span>
</span><span class="line">      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s">&quot;&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">vm</span> <span class="o">=</span> <span class="nn">EnableTwoFactorViewModel</span><span class="p">.</span><span class="n">From</span> <span class="n">username</span> <span class="n">err</span>
</span><span class="line">    <span class="k">return</span><span class="o">!</span> <span class="n">page</span> <span class="s">&quot;enable_two_factor.liquid&quot;</span> <span class="n">vm</span> <span class="n">ctx</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="o">!</span> <span class="n">redirect</span> <span class="n">notFoundPath</span> <span class="n">ctx</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">googleAuthenticatorWebPart</span> <span class="n">notFoundPath</span> <span class="o">=</span>
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="n">path</span> <span class="n">enableTwoFactorAuthPath</span> <span class="o">&gt;=&gt;</span> <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">      <span class="n">GET</span> <span class="o">&gt;=&gt;</span> <span class="n">secured</span> <span class="o">(</span><span class="n">renderEnableTwoFactorAuthView</span> <span class="n">notFoundPath</span><span class="o">)</span>
</span><span class="line">    <span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As we did in the login page, we are using the <code>err</code> query string in the request to pass the verification code mismatch errors. </p>

<p>We are leveraging the <code>OtpSharp</code> library to generate the URL that is in turn represented as a QR Code. </p>

<blockquote>
  <p>If you would like to how Google Authenticator interprets the generated key and the issuer name from the URL embedded in the QR Code, check out the <a href="https://github.com/google/google-authenticator/wiki/Key-Uri-Format">UriFormat</a> documentation. </p>
</blockquote>

<p>The last step in rendering this page is adding the <code>googleAuthenticatorWebPart</code> in the <code>Web</code> module where we are putting all the WebParts together</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Web.fs</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">open</span> <span class="nn">GoogleAuthenticator</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">app</span> <span class="o">=</span>
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="c1">// ...</span>
</span><span class="line">    <span class="n">googleAuthenticatorWebPart</span> <span class="n">notFoundPath</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>While enabling Two-factor authentication, the user has to scan the QR-Code from his <em>Google Authenticator</em> app and he will be getting a one-time verification code like this upon adding</p>

<p><img class="center border" src="/images/suave_two_factor/Google_Authenticator.png" width="200" height="400" /></p>

<p>Then he will be entering this in the <code>enable_two_factor</code> page and click <code>Enable</code>.</p>

<p>Let’s handle this <em>POST</em> request. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/GoogleAuthenticator.fs</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">let</span> <span class="nv">verifyOtp</span> <span class="n">secretKey</span> <span class="n">code</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">otp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Totp</span><span class="o">(</span><span class="nn">Base32Encoder</span><span class="p">.</span><span class="n">Decode</span> <span class="n">secretKey</span><span class="o">)</span>
</span><span class="line">  <span class="n">otp</span><span class="o">.</span><span class="n">VerifyTotp</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">ref</span> <span class="mi">0L</span><span class="o">,</span> <span class="k">new</span> <span class="n">VerificationWindow</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">enableTwoFactorAuth</span> <span class="n">redirectPath</span> <span class="n">notFoundPath</span> <span class="n">username</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">  <span class="k">match</span> <span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="o">.[</span><span class="s">&quot;SecretKey&quot;</span><span class="o">],</span> <span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="o">.[</span><span class="s">&quot;Code&quot;</span><span class="o">]</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">secretKey</span><span class="o">,</span> <span class="n">Some</span> <span class="n">code</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">match</span> <span class="n">verifyOtp</span> <span class="n">secretKey</span> <span class="n">code</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="k">true</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">enableTwoFactorAuth</span> <span class="n">username</span> <span class="n">secretKey</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">redirect</span> <span class="n">redirectPath</span> <span class="n">ctx</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">redirectTo</span> <span class="o">=</span>
</span><span class="line">        <span class="n">sprintf</span> <span class="s">&quot;%s?err=code validation failed&quot;</span> <span class="n">enableTwoFactorAuthPath</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">redirect</span> <span class="n">redirectTo</span> <span class="n">ctx</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="o">!</span> <span class="n">redirect</span> <span class="n">notFoundPath</span> <span class="n">ctx</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">googleAuthenticatorWebPart</span> <span class="n">redirectPath</span> <span class="n">notFoundPath</span> <span class="o">=</span>
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="n">path</span> <span class="n">enableTwoFactorAuthPath</span> <span class="o">&gt;=&gt;</span> <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">      <span class="c1">// ...</span>
</span><span class="line">      <span class="n">POST</span> <span class="o">&gt;=&gt;</span> <span class="n">secured</span> <span class="o">(</span><span class="n">enableTwoFactorAuth</span> <span class="n">redirectPath</span> <span class="n">notFoundPath</span><span class="o">)</span>
</span><span class="line">    <span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Thanks to the <em>OtpSharp</em> library for making our job simpler here. We just need to get the <code>SecretKey</code>, and the <code>Code</code> from the POST request and get it verified using <em>OtpSharp’s</em> <a href="https://bitbucket.org/devinmartin/otp-sharp/wiki/TOTP">VerifyTotp</a> function. </p>

<p>If the verification is successful, we will be enabling the Two-factor authentication for the user in our in-memory backend using the <code>enableTwoFactorAuth</code> function and then redirect to the redirect path which in this case the <em>Profile</em> page.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Web.fs</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">app</span> <span class="o">=</span>
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="c1">// ...</span>
</span><span class="line">    <span class="n">googleAuthenticatorWebPart</span> <span class="n">profilePath</span> <span class="n">notFoundPath</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="login-with-two-factor-authentication">Login With Two-factor Authentication</h2>

<p>The last step is to prompt for the verification code whenever the Two-factor Authentication enabled user tries to log in and verify the one-time verification code before granting the access. </p>

<p>Let’s start by defining the liquid view template <code>auth_code.liquid</code> for getting the one-time verification code.</p>

<p><img class="center border" src="/images/suave_two_factor/auth_code_view.png" width="450" height="350" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/GoogleAuthenticator.fs</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">let</span> <span class="nv">authCodePath</span> <span class="o">=</span> <span class="s">&quot;/authcode&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">googleAuthenticatorWebPart</span> <span class="n">redirectPath</span> <span class="n">notFoundPath</span> <span class="o">=</span>
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="c1">// ...</span>
</span><span class="line">    <span class="n">path</span> <span class="n">authCodePath</span> <span class="o">&gt;=&gt;</span> <span class="n">page</span> <span class="s">&quot;auth_code.liquid&quot;</span> <span class="s">&quot;&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>After username and password verification, the user has to be redirected the <em>auth_code</em> page</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Login.fs</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">let</span> <span class="nv">authCodeSessionKey</span> <span class="o">=</span> <span class="s">&quot;loginUser&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">onLogin</span> <span class="n">redirectPath</span> <span class="n">authCodePath</span> <span class="o">(</span><span class="n">request</span> <span class="o">:</span> <span class="n">HttpRequest</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">request</span><span class="o">.[</span><span class="s">&quot;Username&quot;</span><span class="o">],</span> <span class="n">request</span><span class="o">.[</span><span class="s">&quot;Password&quot;</span><span class="o">]</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">username</span><span class="o">,</span> <span class="n">Some</span> <span class="n">password</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">match</span> <span class="n">getUser</span> <span class="n">username</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="n">user</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">match</span> <span class="n">user</span><span class="o">.</span><span class="n">Password</span> <span class="o">=</span> <span class="n">password</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="n">TwoFactorAuthentication</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="k">true</span><span class="o">,</span> <span class="n">Disabled</span> <span class="o">-&gt;</span> <span class="n">loginSucess</span> <span class="n">never</span> <span class="n">redirectPath</span> <span class="n">username</span>
</span><span class="line">      <span class="o">|</span> <span class="k">true</span><span class="o">,</span> <span class="n">Enabled</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="n">sessionSet</span> <span class="n">never</span> <span class="n">authCodeSessionKey</span> <span class="n">username</span>
</span><span class="line">            <span class="o">&gt;=&gt;</span> <span class="n">FOUND</span> <span class="n">authCodePath</span>
</span><span class="line">      <span class="c1">// ...</span>
</span><span class="line">
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">loginWebPart</span> <span class="n">redirectPath</span> <span class="n">authCodePath</span> <span class="o">=</span>
</span><span class="line">  <span class="n">path</span> <span class="n">loginPath</span> <span class="o">&gt;=&gt;</span> <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">      <span class="c1">// ...</span>
</span><span class="line">      <span class="n">POST</span> <span class="o">&gt;=&gt;</span> <span class="n">request</span> <span class="o">(</span><span class="n">onLogin</span> <span class="n">redirectPath</span> <span class="n">authCodePath</span><span class="o">)]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/Web.fs</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">let</span> <span class="nv">app</span> <span class="o">=</span>
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="n">loginWebPart</span> <span class="n">profilePath</span> <span class="n">authCodePath</span>
</span><span class="line">    <span class="c1">// ...</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We are using a separate session key <code>authCodeSessionKey</code> to hold the username of the user. </p>

<p>The final step is verifying the one-time verification code (from the Google Authenticator app) entered by the user. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Suave.TwoFactorAuth/GoogleAuthenticator.fs</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Combinators</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">let</span> <span class="nv">onAuthCodeVerification</span> <span class="n">redirectPath</span> <span class="o">(</span><span class="n">request</span> <span class="o">:</span> <span class="n">HttpRequest</span><span class="o">)</span> <span class="n">username</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">request</span><span class="o">.[</span><span class="s">&quot;Code&quot;</span><span class="o">],</span> <span class="n">getUser</span> <span class="n">username</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">code</span><span class="o">,</span> <span class="n">Some</span> <span class="n">user</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">match</span> <span class="n">user</span><span class="o">.</span><span class="n">TwoFactorAuthentication</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Enabled</span> <span class="n">secretKey</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">match</span> <span class="n">verifyOtp</span> <span class="n">secretKey</span> <span class="n">code</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="k">true</span> <span class="o">-&gt;</span> <span class="n">loginSucess</span> <span class="n">never</span> <span class="n">redirectPath</span> <span class="n">user</span><span class="o">.</span><span class="n">Username</span>
</span><span class="line">      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">redirectToLogin</span> <span class="o">(</span><span class="n">Some</span> <span class="s">&quot;invalid otp&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">redirectToLogin</span> <span class="o">(</span><span class="n">Some</span> <span class="s">&quot;invalid request&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">redirectToLogin</span> <span class="o">(</span><span class="n">Some</span> <span class="s">&quot;invalid request&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">onVerifyAuthCode</span> <span class="n">redirectPath</span> <span class="n">httpRequest</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">onFail</span> <span class="o">=</span> <span class="n">redirectToLogin</span> <span class="o">(</span><span class="n">Some</span> <span class="s">&quot;invalid request&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">onAuthCodeVerification</span> <span class="o">=</span>
</span><span class="line">    <span class="n">onAuthCodeVerification</span> <span class="n">redirectPath</span> <span class="n">httpRequest</span>
</span><span class="line">  <span class="n">sessionGet</span> <span class="n">onFail</span> <span class="n">authCodeSessionKey</span> <span class="n">onAuthCodeVerification</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">googleAuthenticatorWebPart</span> <span class="n">redirectPath</span> <span class="n">notFoundPath</span> <span class="o">=</span>
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="c1">// ...</span>
</span><span class="line">    <span class="n">path</span> <span class="s">&quot;/verify_auth_code&quot;</span> <span class="o">&gt;=&gt;</span> <span class="n">request</span> <span class="o">(</span><span class="n">onVerifyAuthCode</span> <span class="n">redirectPath</span><span class="o">)]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s it! We have successfully implemented Two-factor authentication. </p>

<p>The complete source code is available in <a href="https://github.com/tamizhvendan/blog-samples/tree/master/SuaveTwoFactorAuth">my GitHub repository</a></p>

<h3 id="related-posts">Related Post(s)</h3>

<ul>
  <li><a href="/blog/2015/07/15/securing-apis-in-suave-using-json-web-token/">Securing APIs in Suave using JSON Web Token</a></li>
</ul>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2016-09-30T09:06:15+05:30" data-updated="true" itemprop="datePublished">Sep 30<sup>th</sup>, 2016</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/fscheck/'>fscheck</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>, <a class='category' href='/blog/categories/functional-programming/'>functional-programming</a>, <a class='category' href='/blog/categories/property-based-testing/'>property-based-testing</a>


</div>
		
			<span class="comments"><a href="/blog/2016/09/30/leveraging-property-based-testing/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2016/09/30/leveraging-property-based-testing/" itemprop="url">Leveraging Property Based Testing</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p><a href="http://fsharpforfunandprofit.com/posts/property-based-testing/">Property-based testing</a> is one of the powerful technique to unit test the code. Unlike the example-based testing (where we <em>Arrange</em> a set of example inputs to <em>Assert</em> the system under test), Property based testing enable us to focus on what we wanted to test and liberate us from doing mundane work on coming up with sample inputs.</p>

<p>Recently, I got a chance to use Property based testing in <a href="https://github.com/tamizhvendan/Suave.Azure.Functions">an open source library</a> that I am developing to use <a href="https://suave.io">Suave</a> in <a href="https://azure.microsoft.com/en-in/services/functions/">Azure Functions</a>. I felt very productive and it was a such a joy to write the unit tests.  </p>

<p>In this blog post, you are going to learn how Property-based testing has helped me and why you need to consider using(or learning) it</p>

<h2 id="use-case">Use Case</h2>

<p>Let me start with the use case that I wanted to test. The library that I am working is an adapter between two HTTP protocol abstractions, <a href="https://msdn.microsoft.com/en-us/library/system.net.http.aspx">System.Net.Http</a> and <a href="https://github.com/SuaveIO/suave/blob/v1.1.3/src/Suave/Http.fs">Suave.Http</a></p>

<p>The first task is to map <a href="https://msdn.microsoft.com/en-us/library/system.net.httpstatuscode.aspx">HttpStatusCode</a> of <em>System.Net</em> to the <a href="https://github.com/SuaveIO/suave/blob/v1.1.3/src/Suave/Http.fs#L64-L71">HttpCode</a> of <em>Suave.Http</em> and the next task is doing the vice-versa.</p>

<blockquote>
  <p><em>HttpStatusCode</em> is an enum type and <em>HttpCode</em> is a discriminated union type. Refer this <a href="https://fsharpforfunandprofit.com/posts/enum-types/">blog post</a> to know more about this difference.</p>
</blockquote>

<h2 id="identifying-the-property">Identifying the Property</h2>

<p>The first step is Property-based testing is identifying the property. In other words, it forces to think about the relationship between the <em>input</em> and the <em>output</em>.</p>

<p>I believe this <em>thinking</em> will make a huge difference in the quality of the software that we deliver.</p>

<p>In the first task that we are about to implement, the relationship is the <em>integer</em> representation of the HTTP status code is both <em>HttpStatusCode</em> and <em>HttpCode</em>.</p>

<p>Programmatically, this can be asserted like</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// boolean condition</span>
</span><span class="line"><span class="c1">// In F# (=) operator represents the equality checking</span>
</span><span class="line"><span class="nn">LanguagePrimitives</span><span class="p">.</span><span class="n">EnumToValue</span> <span class="n">httpStatusCode</span> <span class="o">=</span> <span class="n">httpCode</span><span class="o">.</span><span class="n">code</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<blockquote>
  <p>The <a href="https://msdn.microsoft.com/en-us/visualfsharpdocs/conceptual/languageprimitives.enumtovalue%5B'enum,'t%5D-function-%5Bfsharp%5D">EnumToValue</a> returns the integer value associated with the enum, which is nothing but the integer representation of the HTTP status code it represents. The <code>code</code> is <a href="https://github.com/SuaveIO/suave/blob/v1.1.3/src/Suave/Http.fs#L73-L85">a member of</a> <em>HttpCode</em> that represents the same integer.</p>
</blockquote>

<p>If this property holds true for given set of inputs, then we can assert that the function that does the transformation is working correctly.</p>

<h2 id="implementing-the-mapping-function-httpstatuscode">Implementing the mapping function <code>httpStatusCode</code></h2>

<p>The initial implementation that I had in my mind was</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">NetStatusCode</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line"><span class="o">|</span> <span class="nn">HttpCode</span><span class="p">.</span><span class="n">HTTP_200</span> <span class="o">-&gt;</span> <span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span>
</span><span class="line"><span class="o">|</span> <span class="nn">HttpCode</span><span class="p">.</span><span class="n">HTTP_201</span> <span class="o">-&gt;</span> <span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">Created</span>
</span><span class="line"><span class="o">|</span> <span class="nn">HttpCode</span><span class="p">.</span><span class="n">HTTP_400</span> <span class="o">-&gt;</span> <span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">BadRequest</span>
</span><span class="line"><span class="o">|</span> <span class="nn">HttpCode</span><span class="p">.</span><span class="n">HTTP_404</span> <span class="o">-&gt;</span> <span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">NotFound</span>
</span><span class="line"><span class="o">|</span> <span class="nn">HttpCode</span><span class="p">.</span><span class="n">HTTP_202</span> <span class="o">-&gt;</span> <span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">Accepted</span>
</span><span class="line"><span class="o">|</span> <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>If I haven’t choosen to use Property based testing, I might have ended up with this line by line mapping for all the HTTP status codes. As a matter of fact, in <a href="(/blog/2016/09/19/scale-up-azure-functions-in-f-number-using-suave/)">my last blog post</a> on using Suave in Azure Functions, I’ve used this same approach.</p>

<p>While thinking regarding properties to assert the transformation, for the first time I came to know about the <a href="https://msdn.microsoft.com/en-us/visualfsharpdocs/conceptual/core.languageprimitives-module-%5Bfsharp%5D">Language Primitives</a> module in F# and the <em>EnumToValue</em> function.</p>

<p>There should be an another function <em>EnumOfValue</em> right?</p>

<p>Yes!</p>

<p>Let’s use this in the <code>httpStatusCode</code> function implementation</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">httpStatusCode</span> <span class="o">(</span><span class="n">httpCode</span> <span class="o">:</span> <span class="n">HttpCode</span><span class="o">)</span> <span class="o">:</span> <span class="n">HttpStatusCode</span> <span class="o">=</span>
</span><span class="line">  <span class="nn">LanguagePrimitives</span><span class="p">.</span><span class="n">EnumOfValue</span> <span class="n">httpCode</span><span class="o">.</span><span class="n">code</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Short and Sweet!</p>

<p>Property-based testing made my day and helped me <a href="http://keysleft.com/">to save</a> a lot of keystrokes!</p>

<h2 id="writing-our-first-property-based-unit-test">Writing Our First Property based Unit Test</h2>

<p>In F# we can use the <a href="https://fscheck.github.io/FsCheck/">FsCheck</a> library to write the Property based unit tests. For this implementation, we will be using <em>FsCheck.Xunit</em> to run Property tests in <a href="http://xunit.github.io/">XUnit</a></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">open</span> <span class="nn">Suave.Http</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Net</span>
</span><span class="line"><span class="k">open</span> <span class="nn">FsCheck</span>
</span><span class="line"><span class="k">open</span> <span class="nn">FsCheck.Xunit</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">Property</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="o">``</span><span class="n">httpStatusCode</span> <span class="n">maps</span> <span class="n">Suave&#39;s</span> <span class="n">HttpCode</span> <span class="k">to</span> <span class="nn">System</span><span class="p">.</span><span class="n">Net&#39;s</span> <span class="n">HttpStatusCode</span> <span class="o">``</span>
</span><span class="line">  <span class="o">(</span><span class="n">httpCode</span> <span class="o">:</span> <span class="n">HttpCode</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">httpStatusCode</span> <span class="o">=</span> <span class="nn">Response</span><span class="p">.</span><span class="n">httpStatusCode</span> <span class="n">httpCode</span>
</span><span class="line">    <span class="nn">LanguagePrimitives</span><span class="p">.</span><span class="n">EnumToValue</span> <span class="n">httpStatusCode</span> <span class="o">=</span> <span class="n">httpCode</span><span class="o">.</span><span class="n">code</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The magic here is the <code>Property</code> attribute. It makes our life easier by auto-populating the parameter <code>httpCode</code> with the all the possible values and runs the unit test against each value.</p>

<p>As a convention, we need to return boolean by validating the property that we wanted to assert.</p>

<blockquote>
  <p>There is no Arrange step to setup the input parameter and FsCheck does that for you with 100% test coverage :-)</p>
</blockquote>

<h2 id="mapping-httpcode-to-httpstatuscode">Mapping HttpCode to HttpStatusCode</h2>

<p>The next task in the use case is doing the reverse, mapping <em>HttpStatusCode</em> to <em>HttpCode</em>.</p>

<p>Let’s start with the test first.</p>

<p>The integer representation of HTTP status code property that we used on the previous task holds true for this mapping also.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">Property</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="o">``</span><span class="n">suaveHttpCode</span> <span class="n">maps</span> <span class="nn">System</span><span class="p">.</span><span class="n">Net&#39;s</span> <span class="n">HttpStatusCode</span> <span class="k">to</span> <span class="n">Suave&#39;s</span> <span class="n">HttpCode</span> <span class="k">if</span> <span class="n">exists</span><span class="o">``</span>
</span><span class="line">  <span class="o">(</span><span class="n">httpStatusCode</span> <span class="o">:</span> <span class="n">HttpStatusCode</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">httpCode</span> <span class="o">=</span> <span class="n">suaveHttpCode</span> <span class="n">httpStatusCode</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">code</span> <span class="o">=</span> <span class="nn">LanguagePrimitives</span><span class="p">.</span><span class="n">EnumToValue</span> <span class="n">httpStatusCode</span>
</span><span class="line">
</span><span class="line">    <span class="nn">Option</span><span class="p">.</span><span class="n">isSome</span> <span class="n">httpCode</span> <span class="o">&amp;&amp;</span> <span class="n">httpCode</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>suaveHttpCode</code> function returns an <a href="http://fsharpforfunandprofit.com/posts/the-option-type/">Option type</a> as Suave.Http.HttpCode’s <code>tryParse</code> function <a href="https://github.com/SuaveIO/suave/blob/v1.1.3/src/Suave/Http.fs#L184-L194">parses the integer HTTP status code</a> and returns the corresponding <code>HttpCode</code> if the parsing succeeds.</p>

<p>The implementation of <code>suaveHttpCode</code> function is</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">suaveHttpCode</span> <span class="o">(</span><span class="n">httpStatusCode</span> <span class="o">:</span> <span class="n">HttpStatusCode</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">code</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">LanguagePrimitives</span><span class="p">.</span><span class="n">EnumToValue</span> <span class="n">httpStatusCode</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">HttpCode</span><span class="p">.</span><span class="n">tryParse</span>
</span><span class="line">  <span class="k">match</span> <span class="n">code</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Choice1Of2</span> <span class="n">httpCode</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">httpCode</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now if we run the unit tests, You will be getting the following error (if you are using Suave NuGet package version &lt;= 1.1.3)</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="nn">Suave</span><span class="p">.</span><span class="nn">Azure</span><span class="p">.</span><span class="nn">Functions</span><span class="p">.</span><span class="nn">Tests</span><span class="p">.</span><span class="n">suaveHttpCode</span> <span class="n">maps</span> <span class="nn">System</span><span class="p">.</span><span class="n">Net&#39;s</span> <span class="n">HttpStatusCode</span> <span class="k">to</span> <span class="n">Suave&#39;s</span> <span class="n">HttpCode</span> <span class="o">[</span><span class="n">FAIL</span><span class="o">]</span>
</span><span class="line"><span class="nn">FsCheck</span><span class="p">.</span><span class="nn">Xunit</span><span class="p">.</span><span class="n">PropertyFailedException</span> <span class="o">:</span>
</span><span class="line">     <span class="n">Falsifiable</span><span class="o">,</span> <span class="n">after</span> <span class="mi">7</span> <span class="n">tests</span> <span class="o">(</span><span class="mi">0</span> <span class="n">shrinks</span><span class="o">)</span> <span class="o">(</span><span class="n">StdGen</span> <span class="o">(</span><span class="mi">1629668181</span><span class="o">,</span><span class="mi">296211181</span><span class="o">)):</span>
</span><span class="line">     <span class="n">Original</span><span class="o">:</span>
</span><span class="line">     <span class="n">Unused</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The reason for this failure is Suave (up to v1.1.3) doesn’t have the HTTP status code <em>306 (UnUsed)</em>. The unit test that we wrote was exercised by the <em>FsCheck</em> for the all possible values of the <code>HttpStatusCode</code> enum till it encountered this failure case.</p>

<p>Let’s patch our unit test to fix this failure.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">httpCode</span> <span class="o">=</span> <span class="nn">Response</span><span class="p">.</span><span class="n">suaveHttpCode</span> <span class="n">httpStatusCode</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">code</span> <span class="o">=</span> <span class="nn">LanguagePrimitives</span><span class="p">.</span><span class="n">EnumToValue</span> <span class="n">httpStatusCode</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">unSupportedSuaveHttpCodes</span> <span class="o">=</span> <span class="o">[</span><span class="mi">306</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">contains</span> <span class="n">code</span> <span class="n">unSupportedSuaveHttpCodes</span> <span class="k">then</span>
</span><span class="line">    <span class="nn">Option</span><span class="p">.</span><span class="n">isNone</span> <span class="n">httpCode</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="nn">Option</span><span class="p">.</span><span class="n">isSome</span> <span class="n">httpCode</span> <span class="o">&amp;&amp;</span> <span class="n">httpCode</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If you run the unit test after this, you will get an another failure</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="nn">Suave</span><span class="p">.</span><span class="nn">Azure</span><span class="p">.</span><span class="nn">Functions</span><span class="p">.</span><span class="nn">Tests</span><span class="p">.</span><span class="n">suaveHttpCode</span> <span class="n">maps</span> <span class="nn">System</span><span class="p">.</span><span class="n">Net&#39;s</span> <span class="n">HttpStatusCode</span> <span class="k">to</span> <span class="n">Suave&#39;s</span> <span class="n">HttpCode</span> <span class="o">[</span><span class="n">FAIL</span><span class="o">]</span>
</span><span class="line"><span class="nn">FsCheck</span><span class="p">.</span><span class="nn">Xunit</span><span class="p">.</span><span class="n">PropertyFailedException</span> <span class="o">:</span>
</span><span class="line">  <span class="n">Falsifiable</span><span class="o">,</span> <span class="n">after</span> <span class="mi">10</span> <span class="n">tests</span> <span class="o">(</span><span class="mi">0</span> <span class="n">shrinks</span><span class="o">)</span> <span class="o">(</span><span class="n">StdGen</span> <span class="o">(</span><span class="mi">507658935</span><span class="o">,</span><span class="mi">296211184</span><span class="o">)):</span>
</span><span class="line">  <span class="n">Original</span><span class="o">:</span>
</span><span class="line">  <span class="n">UpgradeRequired</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Again, The reason is HTTP Status Code <code>426 (UpgradeRequired)</code> is not supported is Suave at this point of writing. Let’s patch this too by adding this to the list <code>unSupportedSuaveHttpCodes</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">let</span> <span class="nv">unSupportedSuaveHttpCodes</span> <span class="o">=</span> <span class="o">[</span><span class="mi">306</span><span class="o">;</span><span class="mi">426</span><span class="o">]</span>
</span><span class="line"><span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>After this FsCheck is happy and we too.</p>

<blockquote>
  <p>If I haven’t used Property based testing, for sure, I might have missed these two unsupported HTTP status codes.</p>
</blockquote>

<h2 id="the-spirit-of-open-source">The Spirit of Open Source</h2>

<p>While looking at <code>Suave.Http</code> codebase to fix the unit test failures, this is what I saw in the code</p>

<p><img class="center border" src="/images/leveraging_pbt/send_pr.png" /></p>

<p>This is the beauty of open source, and I am glad <a href="https://github.com/SuaveIO/suave/pull/512">to do it</a></p>

<h2 id="summary">Summary</h2>

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Writing tests first forces you to think about the problem you&#39;re solving. Writing property-based tests forces you to think way harder.</p>&mdash; Jessica Kerr (@jessitron) <a href="https://twitter.com/jessitron/status/327480330900611072">April 25, 2013</a></blockquote>


		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
        <a href="1" class="prev">Prev</a>
    
    
        <a href="3" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2017

    Tamizhvendan S


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'tamizhvendan-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>






</body>
</html>
