<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[P3 Programmer]]></title>
  <link href="http://www.p3programmer.com/blog/atom.xml" rel="self"/>
  <link href="http://www.p3programmer.com/blog/"/>
  <updated>2015-02-21T12:03:56+05:30</updated>
  <id>http://www.p3programmer.com/blog/</id>
  <author>
    <name><![CDATA[Tamizhvendan S]]></name>
    <email><![CDATA[tamizh88@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Step-6 Authentication using Owin authentication Middleware and ASP.NET Identity]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2015/02/04/step-6-authentication-using-owin-middleware-and-asp-dot-net-identity/"/>
    <updated>2015-02-04T17:24:22+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2015/02/04/step-6-authentication-using-owin-middleware-and-asp-dot-net-identity</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 6 of my blog series on <a href="http://www.p3programmer.com/blog/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="http://www.p3programmer.com/blog/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec/">last blog post</a> we have added an interactive feature to search phones and in this blog post we are going to add authentication to our PhoneCat application using Owin Authentication Middleware and ASP.NET identity.</p>

<p>In the first half of this blog post we are going to see how to implement a new user registration workflow </p>

<p><img src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_6/registration_workflow.png" /></p>

<p>And in the second half, we are going to see how to do authentication using the registered login credentials</p>

<p><img src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_6/login_workflow.png" /></p>

<h3 id="owin-authentication-middleware-in-brief">Owin Authentication Middleware in brief</h3>

<p>In the <a href="https://msdn.microsoft.com/en-us/magazine/dn451439.aspx">Owin Specification</a>, a middleware access the request before it reaches the underlying web framework. You can view the authentication middleware as gate keeper who checks the incoming request, if it is authenticated it let the request to go through the other middlewares in the pipeline else it bypasses the pipeline and take a different route (usually redirecting to the login page)</p>

<p>In the blog post we are going to use cookie based authentication middleware which is similar to the <a href="https://msdn.microsoft.com/en-us/library/7t6b43z4%28v=vs.140%29.aspx">Asp.Net Forms Authentication</a> and it also supports <a href="https://msdn.microsoft.com/en-us/library/system.security.claims.claim(v=vs.110).aspx">Claims</a>.</p>

<p>Another appreciable feature in Owin it is upto us on how to validate the incoming user credentials. We can plug it to any external authentication providers like Google, Facebook, etc., or using Active Directory or Asp.Net Identity. Here we are going to validate the user credentials using <a href="http://odetocode.com/blogs/scott/archive/2013/11/25/asp-net-core-identity.aspx">Asp.Net Identity framework</a> which provides the required interfaces for handling the authentication and <a href="http://odetocode.com/blogs/scott/archive/2014/01/03/asp-net-identity-with-the-entity-framework.aspx">Entity Framework Identity</a> which provides the concrete implementations for this Identity interfaces.</p>

<h3 id="setting-up-the-infrastructure">Setting up the infrastructure</h3>

<p>Create a new F# class library project with the name <code>Identity</code> and install the Microsoft <a href="https://www.nuget.org/packages/Microsoft.AspNet.Identity.EntityFramework/">AspNet.Identity.EntityFramework</a> nuget package which provides a pluggable data store for the user identity management using Entity Framework.</p>

<p>Then add a source file in the <code>Identity</code> project with the name <code>User</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">open</span> <span class="nn">Microsoft.AspNet.Identity.EntityFramework</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AllowNullLiteral</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">User</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">IdentityUser</span><span class="bp">()</span>
</span><span class="line">  <span class="k">member</span> <span class="k">val</span> <span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="k">with</span> <span class="n">get</span><span class="o">,</span> <span class="n">set</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">UserDbContext</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">IdentityDbContext</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="s">&quot;IdentityConnection&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>IdentityUser</code> represents the default implementation of <a href="https://msdn.microsoft.com/en-us/library/microsoft.aspnet.identity.iuser%28v=vs.108%29.aspx">IUser</a> interface which provides the basic properties for a user. We can extend it by adding our custom properties. Here we have added a custom property called <code>Name</code> which represents the name of the user.</p>

<p>The <a href="https://msdn.microsoft.com/en-us/library/ee353608.aspx">AllowNullLiteral</a> attribute is one of the feature in F# which explicitly make a type to allow null as one of its value. F# by default doesn’t support null value for its types and the beauty is you will get a compiler error if you assign null to an identifier! Pretty cool isn’t it? No Null Exception, <a href="http://www.infoq.com/presentations/Null-References-The-Billion-Dollar-Mistake-Tony-Hoare">No Billion Dollar Mistake</a>! Then why we are allowing it explicitly here. Well, it has been added here for a reason and I will reveal it later in this blog post</p>

<p>The <code>IdentityDbContext</code> represents the data store abstraction of Identity entities like Users, Roles, Claims and Logins. The <code>UserDbContext</code> is just a subclass of <code>IdentityDbContext</code> which tells Entity Framework to use the connection string name <code>IdentityConnection</code></p>

<h3 id="setting-up-user-registration">Setting up User Registration</h3>

<p>With all the needed infrastructure in place its time to do the actual work and lets start with adding a provision for registering new user.</p>

<p>In the <code>Web</code> project add the reference to the <code>Identity</code> project and install the following nuget packages</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Microsoft.Owin.Security.Cookies
</span><span class="line">Microsoft.Owin.Host.SystemWeb
</span><span class="line">Microsoft.AspNet.Identity.EntityFramework
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Create a controller with the name <code>AuthenticationController</code> in the <code>Web</code> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">CLIMutable</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">RegisterViewModel</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Email</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Password</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">AuthenticationController</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="bp">()</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>AuthenticationController</code> depends on <code>UserManager</code> to take care of managing users. <a href="https://msdn.microsoft.com/en-us/library/dn613290%28v=vs.108%29.aspx">UserManager</a> is an abstraction defined in the <strong>AspNet.Identity</strong> assembly. It provides various APIs to work with the underlying user datastore. </p>

<p>As the name indicates <code>RegisterViewModel</code> represents the view model for Registration View. The <a href="https://msdn.microsoft.com/en-us/library/hh289724.aspx">CLIMutable</a> attribute creates a default constructor and “getters and setters” for all the properties of a record type when it is compiled to IL and here it makes the <code>RegisterViewModel</code> compatible with the Asp.Net <a href="https://msdn.microsoft.com/en-us/library/system.web.mvc.defaultmodelbinder(v=vs.118).aspx">DefaultModelBinder</a> which expects the types to have default constructor to bind the incoming request.</p>

<p>The action method <code>Register</code> simply renders the Register View. This view not created yet so lets add it. Create a cshtml file with the name <em>Register.cshtml</em> in the directory <strong>Views/Authentication</strong>. </p>

<p>This is a strongly typed view of type <code>RegisterViewModel</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="html"><span class="line">@model PhoneCat.Web.Controllers.RegisterViewModel
</span><span class="line">
</span><span class="line"><span class="nt">&lt;h3&gt;</span>Register New User<span class="nt">&lt;/h3&gt;</span>
</span><span class="line">
</span><span class="line">@using (Html.BeginForm(&quot;Register&quot;, &quot;Authentication&quot;, FormMethod.Post))
</span><span class="line">{
</span><span class="line">  @Html.AntiForgeryToken()
</span><span class="line">  @Html.ValidationSummary()
</span><span class="line">
</span><span class="line">  @Html.TextBoxFor(m =&gt; m.Name)
</span><span class="line">
</span><span class="line">  @Html.TextBoxFor(m =&gt; m.Email)
</span><span class="line">
</span><span class="line">  @Html.PasswordFor(m =&gt; m.Password)
</span><span class="line">
</span><span class="line">  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span><span class="nt">&gt;</span>Create<span class="nt">&lt;/button&gt;</span>
</span><span class="line">}
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p><em>Note: I’ve intentionally ignored the bootstrap css form styles here to keep the code snippet less noisy</em></p>

<p><img src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_6/new_user_registration.png" /></p>

<p>It’s a typical razor view representing the registration screen. For the sake of simplicity I’ve ignored the retype password field. </p>

<p>The next step is handling the new user registration POST request.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Name</span><span class="o">,</span>
</span><span class="line">                      <span class="n">UserName</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span> <span class="o">,</span>
</span><span class="line">                      <span class="n">Email</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userCreateResult</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Create</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">userCreateResult</span><span class="o">.</span><span class="n">Succeeded</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="n">userCreateResult</span><span class="o">.</span><span class="n">Errors</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">iter</span><span class="o">(</span><span class="k">fun</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">err</span><span class="o">))</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">registerViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Add the above action method in the <code>AuthenticationController</code> to create new user. It creates a <code>User</code> object from the <code>RegisterViewModel</code> and use it to create a new user via <code>UserManager</code>. We are using <code>Email</code> as the <code>UserName</code> in the above code snippet</p>

<p>If the user creation is successful, we are redirecting the user to the home page else we are showing the error messages to the user. After we implemented the login we will modify the above logic to sign in after successful registration.</p>

<p>The next task is creation of <code>AuthenticationController</code> instance. Open <code>MvcInfrastructure</code> that we have <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/2/Web/MvcInfrastructure.fs">created in the step-2</a> and update it as below.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">createUserManager</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">UserStore</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">UserDbContext</span><span class="bp">()</span><span class="o">))</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userValidator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserValidator</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userManager</span><span class="o">)</span>
</span><span class="line">  <span class="n">userValidator</span><span class="o">.</span><span class="n">AllowOnlyAlphanumericUserNames</span> <span class="o">&lt;-</span> <span class="k">false</span>
</span><span class="line">  <span class="n">userManager</span><span class="o">.</span><span class="n">UserValidator</span> <span class="o">&lt;-</span> <span class="n">userValidator</span>
</span><span class="line">  <span class="n">userManager</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">    <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="c1">// ... Existing code ...</span>
</span><span class="line">      <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">AuthenticationController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">authenticationController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthenticationController</span><span class="o">(</span><span class="n">createUserManager</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">        <span class="n">authenticationController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">      <span class="c1">// ... Existing code ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>As we are using email as username we need to change the user validator in the <code>UserManager</code> to allow the alphanumeric characters in the username.</p>

<p>The final step is providing the connection string to access the identity database. Open the <strong>Web.config</strong> file and add the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;connectionStrings&gt;</span>
</span><span class="line">    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;IdentityConnection&quot;</span>
</span><span class="line">      <span class="na">connectionString=</span><span class="s">&quot;Data Source=localhost;Initial Catalog=PhoneCatIdentity;Integrated Security=True&quot;</span>
</span><span class="line">      <span class="na">providerName=</span><span class="s">&quot;System.Data.SqlClient&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/connectionStrings&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As we are using Entity Framework’s Code First here, the schema will be generated dynamically when we run the code for the very first time.</p>

<p>That’s it. We have wired up everything to create a new user!</p>

<h3 id="setting-up-user-login">Setting up User Login</h3>

<p>As we are going to use owin <a href="http://blogs.msdn.com/b/webdev/archive/2013/07/03/understanding-owin-forms-authentication-in-mvc-5.aspx">cookies based authentication</a> middleware, the first step to tell the application startup pipeline to use cookie authentication. </p>

<p>Open <code>Startup</code> and update it to support authentication</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Startup</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">configureAuthentication</span> <span class="o">(</span><span class="n">app</span> <span class="o">:</span> <span class="n">IAppBuilder</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">cookieAuthenticationOptions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CookieAuthenticationOptions</span><span class="bp">()</span>
</span><span class="line">    <span class="n">cookieAuthenticationOptions</span><span class="o">.</span><span class="n">AuthenticationType</span> <span class="o">&lt;-</span> <span class="nn">DefaultAuthenticationTypes</span><span class="p">.</span><span class="n">ApplicationCookie</span>
</span><span class="line">    <span class="n">cookieAuthenticationOptions</span><span class="o">.</span><span class="n">LoginPath</span> <span class="o">&lt;-</span> <span class="k">new</span> <span class="n">PathString</span><span class="o">(</span><span class="s">&quot;/authentication/login&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">UseCookieAuthentication</span><span class="o">(</span><span class="n">cookieAuthenticationOptions</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">  <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Configuration</span><span class="o">(</span><span class="n">app</span> <span class="o">:</span> <span class="n">IAppBuilder</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">MapSignalR</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="n">configureAuthentication</span> <span class="n">app</span>
</span><span class="line">    <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>AuthenticationType</code> is an identifier to distinguish between different authentication middlewares and the <code>LoginPath</code> is the url to the Login Page which will be used to redirect the unauthorized requests.</p>

<p>After setting up cookie authentication, like we did for new user registration, we are going to create a view to enable the user to login.</p>

<p>Add the <code>Login</code> action method in the <code>AuthenticationController</code> and also create <code>LoginViewModel</code> </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">CLIMutable</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">LoginViewModel</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Email</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Password</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">AuthenticationController</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">  <span class="c1">// ... Existing code ...  </span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Login</span><span class="bp">()</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>and create <code>Login</code> view in the <strong>Authentication\Login</strong> directory</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="html"><span class="line">@model PhoneCat.Web.Controllers.LoginViewModel
</span><span class="line">
</span><span class="line"><span class="nt">&lt;h3&gt;</span>Login<span class="nt">&lt;/h3&gt;</span>
</span><span class="line">@using (Html.BeginForm(&quot;Login&quot;, &quot;Authentication&quot;, FormMethod.Post))
</span><span class="line">{
</span><span class="line">  @Html.AntiForgeryToken()
</span><span class="line">  @Html.ValidationSummary()
</span><span class="line">
</span><span class="line">  @Html.TextBoxFor(m =&gt; m.Email)
</span><span class="line">
</span><span class="line">  @Html.PasswordFor(m =&gt; m.Password)
</span><span class="line">
</span><span class="line">  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>Log in<span class="nt">&lt;/button&gt;</span>
</span><span class="line">}
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p><img src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_6/login.png" /></p>

<p>The next step is the crux of this blog post. Challenging the incoming user login credentials against its corresponding registered one.</p>

<p>We will be using <code>UserManager</code>’s following methods to achieve it.</p>

<ul>
  <li>
    <p><a href="https://msdn.microsoft.com/en-us/library/dn497475(v=vs.108).aspx">Find</a> - Returns a user with the specified username and password or null if there is no match (C# needs <a href="http://fsharpforfunandprofit.com/posts/the-option-type/">Option</a> type badly!). In the beginning of the blog post I’ve mentioned you that I will talk about why we are using <code>AllowNullLiteral</code> attribute for the <code>User</code> class. As you see here <code>Find</code> method returns <code>null</code> if the user is not available! So, As per this definition <code>null</code> is valid value for <code>User</code> class.</p>
  </li>
  <li>
    <p><a href="https://msdn.microsoft.com/en-us/library/dn497467(v=vs.108).aspx">CreateIdentity</a> - Creates the Claim Identity representing the user. We need this claim identity to signin and also to pass around the claim details. </p>
  </li>
</ul>

<p>Both of the above methods are having their async counterparts. But for the sake of simplicity I’m ignoring it. May be it can be a exercise for you to figure it out!</p>

<p>Let’s add some utility function to handle finding the user and signing in</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">signin</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">(</span><span class="n">request</span> <span class="o">:</span> <span class="n">HttpRequestBase</span><span class="o">)</span> <span class="n">user</span>  <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">identity</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">CreateIdentity</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="nn">DefaultAuthenticationTypes</span><span class="p">.</span><span class="n">ApplicationCookie</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">authManager</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GetOwinContext</span><span class="bp">()</span><span class="o">.</span><span class="n">Authentication</span>
</span><span class="line">  <span class="n">identity</span><span class="o">.</span><span class="n">AddClaim</span><span class="o">(</span><span class="k">new</span> <span class="n">Claim</span><span class="o">(</span><span class="nn">ClaimTypes</span><span class="p">.</span><span class="n">GivenName</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="n">Name</span><span class="o">))</span>
</span><span class="line">  <span class="n">authManager</span><span class="o">.</span><span class="n">SignIn</span><span class="o">(</span><span class="n">identity</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">tryFindUser</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">email</span> <span class="n">password</span>  <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Find</span><span class="o">(</span><span class="n">email</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span>
</span><span class="line">  <span class="k">if</span> <span class="n">user</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="k">then</span> <span class="n">Some</span> <span class="n">user</span> <span class="k">else</span> <span class="n">None</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Since we are using Email as the UserName here in this example, we need to have a specific claim to pass around the Name of the user. That’s what we are doing in the <code>signin</code> method. Later we will be using this claim to display the user name in the header of the page.</p>

<p>Great! Now its time to handle handle Login POST request. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Login</span><span class="o">(</span><span class="n">loginViewModel</span> <span class="o">:</span> <span class="n">LoginViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">tryFindUser</span> <span class="n">userManager</span> <span class="n">loginViewModel</span><span class="o">.</span><span class="n">Email</span> <span class="n">loginViewModel</span><span class="o">.</span><span class="n">Password</span>  <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="s">&quot;Invalid Email or Password&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">loginViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">user</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Login</code> action method just tries to find the user using given credentials. If the user is available, signin to the application using his credentials and redirect to the home page else show login error to the user.</p>

<p>We can add this same signin behavior after successful user registration too.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// ... Existing Code ...</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">userCreateResult</span><span class="o">.</span><span class="n">Succeeded</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="c1">// ... Existing Code ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Since <code>UserManager</code> is an <code>IDisposable</code>. It’s good practices to dispose it after using. So, Override <code>Dispose</code> method in <code>AuthenticationController</code> and dispose it. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">Dispose</span><span class="o">(</span><span class="n">disposing</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">if</span> <span class="n">disposing</span> <span class="k">then</span>
</span><span class="line">    <span class="n">userManager</span><span class="o">.</span><span class="n">Dispose</span><span class="bp">()</span>
</span><span class="line">  <span class="k">base</span><span class="o">.</span><span class="n">Dispose</span><span class="o">(</span><span class="n">disposing</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The final pending work is displaying the user name in the header after successful login. Open <strong>Layout.cshtml</strong> add the following lines</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="c">&lt;!-- ... Existing code ... --&gt;</span>
</span><span class="line"><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav navbar-nav navbar-right top-nav&quot;</span><span class="nt">&gt;</span>
</span><span class="line">
</span><span class="line">  @if (Request.IsAuthenticated)
</span><span class="line">  {
</span><span class="line">    var identity = User.Identity as ClaimsIdentity;
</span><span class="line">    var name = identity.FindFirst(ClaimTypes.GivenName).Value;
</span><span class="line">    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
</span><span class="line">      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span> <span class="na">aria-expanded=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-user&quot;</span><span class="nt">&gt;&lt;/i&gt;</span>@name
</span><span class="line">      <span class="nt">&lt;/a&gt;</span>
</span><span class="line">      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;li&gt;</span>
</span><span class="line">          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;@Url.Action(&quot;</span><span class="na">Logout</span><span class="err">&quot;,&quot;</span><span class="na">Authentication</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class="line">            <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-fw fa-power-off&quot;</span><span class="nt">&gt;&lt;/i&gt;</span> Log Out
</span><span class="line">          <span class="nt">&lt;/a&gt;</span>
</span><span class="line">        <span class="nt">&lt;/li&gt;</span>
</span><span class="line">      <span class="nt">&lt;/ul&gt;</span>
</span><span class="line">    <span class="nt">&lt;/li&gt;</span>
</span><span class="line">  }
</span><span class="line">  else
</span><span class="line">  {
</span><span class="line">    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
</span><span class="line">      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span> <span class="na">aria-expanded=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-user&quot;</span><span class="nt">&gt;&lt;/i&gt;</span> Guest
</span><span class="line">      <span class="nt">&lt;/a&gt;</span>
</span><span class="line">      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;li&gt;</span>
</span><span class="line">          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;@Url.Action(&quot;</span><span class="na">Login</span><span class="err">&quot;,&quot;</span><span class="na">Authentication</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class="line">            <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-fw fa-bank&quot;</span><span class="nt">&gt;&lt;/i&gt;</span> Log In
</span><span class="line">          <span class="nt">&lt;/a&gt;</span>
</span><span class="line">        <span class="nt">&lt;/li&gt;</span>
</span><span class="line">        <span class="nt">&lt;li&gt;</span>
</span><span class="line">          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;@Url.Action(&quot;</span><span class="na">Register</span><span class="err">&quot;,&quot;</span><span class="na">Authentication</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class="line">            <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-fw fa-laptop&quot;</span><span class="nt">&gt;&lt;/i&gt;</span>Register
</span><span class="line">          <span class="nt">&lt;/a&gt;</span>
</span><span class="line">        <span class="nt">&lt;/li&gt;</span>
</span><span class="line">      <span class="nt">&lt;/ul&gt;</span>
</span><span class="line">    <span class="nt">&lt;/li&gt;</span>
</span><span class="line">  }
</span><span class="line"><span class="nt">&lt;/ul&gt;</span>
</span><span class="line"><span class="c">&lt;!-- ... Existing code ... --&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="adding-logout">Adding Logout</h3>

<p>Adding logout is very simple and straight forward. All we need to do is just invoke the Owin Authentication Manager’s <code>SignOut</code> method. Create an action method in <code>AuthenticationController</code> to handle it</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Logout</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">authManager</span> <span class="o">=</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">GetOwinContext</span><span class="bp">()</span><span class="o">.</span><span class="n">Authentication</span>
</span><span class="line">  <span class="n">authManager</span><span class="o">.</span><span class="n">SignOut</span><span class="o">(</span><span class="nn">DefaultAuthenticationTypes</span><span class="p">.</span><span class="n">ApplicationCookie</span><span class="o">)</span>
</span><span class="line">  <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="summary">Summary</h3>

<p>The interoperability offered by F# to integrate with the existing C# libraries is very seamless and I hope you have got it too! You can find the source code in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/6">github</a> as usual. In the next blog post We will see how to add validations in the User Registration. Stay tuned!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-5 Advanced Search DSL using FParsec]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec/"/>
    <updated>2015-01-18T19:52:26+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 5 of my blog series on <a href="http://www.p3programmer.com/blog/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In this blog post we are going create an advanced Search <a href="http://en.wikipedia.org/wiki/Domain-specific_language">DSL</a> for searching Phones in the PhoneCat application that we are building in this blog series, using a F# parser combinator library called <a href="http://www.quanttec.com/fparsec/">FParsec</a>. </p>

<p><img src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_5/search_results.png" /></p>

<p>As you seen in the screenshot above the DSL that we are going to build will enable us to search phones using three search filters (parameters) <strong>weight</strong>, <strong>screen</strong> and <strong>ram</strong>. The values (value filters) of these search filters can be defined in three ways as <strong>&gt;</strong>(greater than), <strong>-</strong>(range) and <strong>{value}</strong>(actual value itself i.e <em>=</em>). Each of these values should be accompanied with their unit of measures <strong>g</strong>, <strong>inch</strong> and <strong>MB</strong> respectively. For simplicity, I’ve expressed these units in singulars. The <strong>:</strong> symbol is used to separate Search Filter and Value Filter. Multiple filters can be used by seperating thing using the <strong>;</strong> symbol. </p>

<p>The <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract syntax tree (AST)</a> of this external DSL is</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">SearchFilter</span> <span class="o">=</span>
</span><span class="line"><span class="o">|</span> <span class="n">Ram</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line"><span class="o">|</span> <span class="n">Weight</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line"><span class="o">|</span> <span class="n">Screen</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">ValueFilter</span> <span class="o">=</span>
</span><span class="line"><span class="o">|</span> <span class="n">Value</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line"><span class="o">|</span> <span class="n">GreaterThan</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line"><span class="o">|</span> <span class="n">Range</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">*</span> <span class="kt">float</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">filters</span> <span class="o">:</span> <span class="o">(</span><span class="n">SearchFilter</span> <span class="o">*</span> <span class="n">ValueFilter</span><span class="o">)</span> <span class="kt">list</span> <span class="o">=</span> <span class="c1">// ... </span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>FParsec does both <a href="http://en.wikipedia.org/wiki/Lexical_analysis">lexical analysis</a> (converting raw character sequence into meaningful tokens) and <a href="http://en.wikipedia.org/wiki/Parsing">parsing</a> (converting tokens to an AST like the one above). FParsec has been built using pure functions from the ground up and it enable us to create complex parser by combining small parsers (aka <a href="http://programmers.stackexchange.com/questions/117522/what-are-combinators-and-how-are-they-applied-to-programming-projects-practica">combinators</a>). </p>

<h3 id="fpasec-101">FPasec 101</h3>

<p>Lets quickly walk through the basics of FParsec.</p>

<p>In Fparsec all the parsers are of type <code>Parser&lt;'Result,'UserState&gt;</code> . The <code>'Result</code> represents the type of the parser result and the <code>'UserState</code> represents the internal state of the parser. </p>

<p>FParsec offers lot of in-built parser functions which takes F# primitive types and return a parser type for it. </p>

<h4 id="pchar">pchar</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">psearchValueSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;:&#39;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pmultiFiltersSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;;&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>pchar</code> function takes a character and returns a parser (i.e of type <code>Parser&lt;char, 'UserState&gt;</code>) which parses only the given character. </p>

<p>FParsec uses a convention of prefix <strong>p</strong> to define all its parser function and we are also going to use the same to define our custom parser functions.</p>

<h3 id="pstring">pstring</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pram</span> <span class="o">=</span> <span class="n">pstring</span> <span class="s">&quot;ram&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pweight</span> <span class="o">=</span> <span class="n">pstring</span> <span class="s">&quot;weight&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pscreen</span> <span class="o">=</span> <span class="n">pstring</span> <span class="s">&quot;ram&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Like <code>pchar</code> function, the <code>pstring</code> takes a string as its input and return a parser (<code>Parser&lt;string, 'UserState&gt;</code>) that parses only the given string. This parser is case-sensitive. If you want to have a parser which is case-insensitive you can use <code>pstringCI</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pmb</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;MB&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pg</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;g&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pinch</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;inch&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="pfloat">pfloat</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pvalue</span> <span class="o">=</span> <span class="n">pfloat</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I hope by this time you would have been familiar with the FParsec functions. Yes, you are right <code>pfloat</code> parses a floating point and returns the parser for the same. But unlike <code>pchar</code> and <code>pstrig</code> it doesn’t take any input and it can parse any floating point numbers and return the same when we execute the parser. </p>

<h3 id="section">|»</h3>

<p>So far we have seen parsers for the F# primitive types. What about our custom types ? FParsec has an answer for that too using the function (aka operator) <code>|&gt;&gt;</code>. </p>

<p>The signature of <code>|&gt;&gt;</code> function is</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; (a&#39; -&gt; &#39;b) -&gt; Parser&lt;&#39;b, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>i.e this function takes two inputs, a parser of type <code>'a</code> and a function that transform the type <code>'a</code> to <code>'b</code> and return a parser of type <code>'b</code></p>

<p>If you remember the AST that we have defined in the beginning of the post, the search filter has been defined as a discriminated union of type <code>SearchFilter</code>. Each fields <code>Ram</code>, <code>Screen</code>, <code>Weight</code> are being represented in the DSL by their string counterparts <em>“ram”</em>, <em>“screen”</em>, <em>“weight”</em> respectively. We can leverage this <code>|&gt;&gt;</code> function to take care of this data type transformation</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">toLowerCase</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">ToLowerInvariant</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">toSearchFilter</span> <span class="n">str</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">toLowerCase</span> <span class="n">str</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="s">&quot;ram&quot;</span> <span class="o">-&gt;</span> <span class="n">Ram</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="n">Weight</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="s">&quot;screen&quot;</span> <span class="o">-&gt;</span> <span class="n">Screen</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s">&quot;Invalid search filter&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">psearchFilter</span> <span class="n">str</span> <span class="o">=</span> <span class="n">pstring</span> <span class="n">str</span> <span class="o">|&gt;&gt;</span> <span class="n">toSearchFilter</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">pram</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;ram&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pweight</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;weight&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pscreen</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;screen&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>If you see the type of <code>pram</code> it is Parser&lt;SearchFilter, ‘u&gt; i.e Parser for our custom type. The <code>psearchFilter</code> is an utility function which helps in avoiding the code duplication across multiple search filter parser creation.</p>

<h3 id="section-1">».</h3>

<p>I love this function and it represents the beauty of functional programming. This function has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It takes two parsers of same or different types and returns a parser that parses the input using the given two parsers by applying them sequentially and returns a parser with the input type of second parser (The <strong>.</strong> symbol represents which parser to pick)</p>

<p>Lets see this action to understand it more</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">let pgreaterThan = pchar &#39;&gt;&#39; &gt;&gt;. pfloat |&gt;&gt; GreaterThan
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have created parser here for greater than. It parses the string <strong>“&gt;80.2”</strong> (i.e <code>pchar</code> parses the <strong>&gt;</strong> symbol and <code>pfloat</code> parses the number <strong>80.2</strong>. Since we have created it using <code>&gt;&gt;.</code> function, both <code>pchar</code> and <code>pfloat</code> are applied in sequence and it returns a parser of float type) and retrieve the floating number <strong>80.2</strong> when the parser is executed. Then we have applied the <code>|&gt;&gt;</code> function which translate it our custom type <code>GreaterThan</code> that we defined in the AST.</p>

<p>The <code>&gt;&gt;.</code> is much like functional composition done by the <a href="http://en.wikibooks.org/wiki/F_Sharp_Programming/Higher_Order_Functions#The_Composition_Function_.28.3C.3C_operator.29">» function (aka operator)</a> but instead of acting at the function level it acts at the parser level.</p>

<h3 id="section-2">.»</h3>

<p>It is similar to the <code>&gt;&gt;.</code> function but instead of returning a parser with the input type of second parser it returns a parser with the input type of the first parser.</p>

<p>It has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt; -&gt; Parser&lt;&#39;a, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-3">.».</h3>

<p>It is a combination of <code>.&gt;&gt;</code> and <code>&gt;&gt;.</code> i.e Instead of dropping the output of either of the given parsers, it returns a parser which parses the input and returns a parser with the result type as tuple representing the inputs of both of the given parsers.</p>

<p>It has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt; -&gt; Parser&lt;(&#39;a * &#39;c), &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Lets see both <code>.&gt;&gt;</code> and <code>.&gt;&gt;.</code> in action</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">prange</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">.&gt;&gt;</span> <span class="o">(</span><span class="n">pchar</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Range</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>prange</code> parser parses the string “100-200” and returns <code>Range (100, 200)</code>.</p>

<p>The <code>.&gt;&gt;</code> function here dropped the symbol <strong>-</strong> here (output of <code>pchar</code> parser) and the function <code>.&gt;&gt;.</code> picked the output of these parsers and returned a tuple representing the given range.</p>

<p>Now you got why I said I love this function! These tiny functions allow us to create parsers by combining them. If you understand how these tiny functions work and trust me you can create complex parsers even a <a href="http://trelford.com/blog/post/parsecsharp.aspx">C# compiler</a></p>

<h3 id="attempt">attempt</h3>

<p>This function takes parser <code>p</code> and execute it against the input. If it result in <strong>fatal error</strong>, it <a href="http://en.wikipedia.org/wiki/Backtracking">backtracks</a> the parser state to its original state as if that the given input is not being consumed. </p>

<h3 id="choice">choice</h3>

<p>This function takes multiple parsers say <code>p1</code>, <code>p2</code> … <code>pn</code> and execute it against the input in the following order.</p>

<p>Run the parser <code>p1</code> against the input. If the parsing succeed skip the rest of the parsers and return the parser else if it resulted an <strong>non-fatal error</strong>, backtrack the parser state to its original state and try the same with the next parser <code>p2</code>. This continues all the way down to <code>pn</code>.</p>

<p>What is the difference between <a href="http://www.quanttec.com/fparsec/reference/primitives.html#members.Error">Non-Fatal Error</a> and a <a href="http://www.quanttec.com/fparsec/reference/primitives.html#members.FatalError">Fatal Error</a> ?</p>

<p>Well, its closely associated with the internal implementation of FParsec. FParsec implements backtracking with only a “one token look-ahead”. i.e if the parser consumed one input token from the stream, it modifies the internal state and if it fails after that it would result in Fatal Error. Not-Fatal Error occurs when parer error happened without consuming the input. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pgreaterThan</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">GreaterThan</span>
</span><span class="line"><span class="k">let</span> <span class="nv">prange</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">.&gt;&gt;</span> <span class="o">(</span><span class="n">pchar</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Range</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pvalue</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Value</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pvalueFilters</span> <span class="o">=</span> <span class="n">choice</span> <span class="o">[</span><span class="n">pgreaterThan</span><span class="o">;</span> <span class="o">(</span><span class="n">attempt</span> <span class="n">prange</span><span class="o">);</span> <span class="n">pvalue</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>If you seen the AST of the DSL that we are going to implement, the value filters can be any one of greaterThan or range or value. Using <code>choice</code> we have implemented this “either or” parser and also we have leveraged the <code>attempt</code> function to get rid of parser fatal error.</p>

<p>Both <code>prange</code> and <code>value</code>, shares the same first token i.e for “100-200MB” &amp; “100MB”, the first token ‘1’ is same. So while parsing the string “100MB” it starts by consuming the first token ‘1’ from the input sequence. FParsec assumes its a range filter and changes its internal state. By the time it reaches the token ‘M’ in “100MB”, it would result in a fatal error saying <em>Expecting: ‘-‘</em>. As we have used <code>attempt</code> here, it backtracks the parser state back to the token ‘1’ of “100MB” and start parsing using <code>pvalue</code> parser. Its hard to get it first time (I’ve spent close to an hour to figure it out) and I recommend you to spend some quality time in understanding the <a href="http://www.quanttec.com/fparsec/users-guide/parsing-alternatives.html">documentation</a> if you want really want to crack it!</p>

<h3 id="sepby">sepBy</h3>

<p><a href="http://www.quanttec.com/fparsec/reference/primitives.html#members.sepBy">sepBy</a> takes an element parser <code>p1</code> and a separator parser as its input and returns a parser for a list of elements separated by the separators.</p>

<p>It has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a,&#39;u&gt; -&gt; Parser&lt;&#39;b,&#39;u&gt; -&gt; Parser&lt;&#39;a list, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We will be using this function to parse multiple search filters separated by <strong>;</strong></p>

<h3 id="run">run</h3>

<p>The <a href="http://www.quanttec.com/fparsec/reference/charparsers.html#members.run">run function</a> takes a parser and a string as its input and it executes the given parser against the string input and returns a <a href="http://www.quanttec.com/fparsec/reference/charparsers.html#members.ParserResult">ParserResult</a> representing the result.</p>

<h2 id="implementing-the-parser">Implementing the Parser</h2>

<p>We have seen a brief overview of some of the basic building blocks of FParsec. It’s time to pull all these things together and create the complete parser which parses the Search DSL.</p>

<p>Create a source file in the <strong>Domain</strong> project and name it as <code>Search</code>. Then add the AST that we have discussed as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Search</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">SearchFilter</span> <span class="o">=</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Ram</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Weight</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Screen</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">ValueFilter</span> <span class="o">=</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Value</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line">  <span class="o">|</span> <span class="n">GreaterThan</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Range</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">*</span> <span class="kt">float</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The next step is to install the <a href="https://www.nuget.org/packages/FParsec">FParsec Nuget Package</a> in the <strong>Domain</strong> project. After installing it create a source file with the name <code>SearchParser</code> and add a function to parse the filter string as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">SearchParser</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">parseFilter</span> <span class="n">filterStr</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">toLowerCase</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">ToLowerInvariant</span><span class="bp">()</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">toSearchFilter</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">      <span class="o">|</span> <span class="s">&quot;ram&quot;</span> <span class="o">-&gt;</span> <span class="n">Ram</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line">      <span class="o">|</span> <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="n">Weight</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line">      <span class="o">|</span> <span class="s">&quot;screen&quot;</span> <span class="o">-&gt;</span> <span class="n">Screen</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s">&quot;Invalid search filter&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">psearchFilter</span> <span class="n">str</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="n">str</span> <span class="o">|&gt;&gt;</span> <span class="o">(</span><span class="n">toLowerCase</span> <span class="o">&gt;&gt;</span> <span class="n">toSearchFilter</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">psearchValueSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;:&#39;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pmultiFiltersSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;;&#39;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pgreaterThan</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">GreaterThan</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">prange</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">.&gt;&gt;</span> <span class="o">(</span><span class="n">pchar</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Range</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pvalue</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Value</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pvalueFilters</span> <span class="o">=</span> <span class="n">choice</span> <span class="o">[</span><span class="n">pgreaterThan</span><span class="o">;</span> <span class="o">(</span><span class="n">attempt</span> <span class="n">prange</span><span class="o">);</span> <span class="n">pvalue</span><span class="o">]</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">createCompleteFilter</span> <span class="n">psearchfilter</span> <span class="n">puom</span>  <span class="o">=</span>
</span><span class="line">      <span class="n">psearchfilter</span> <span class="o">.&gt;&gt;</span> <span class="n">psearchValueSeperator</span> <span class="o">.&gt;&gt;.</span> <span class="n">pvalueFilters</span> <span class="o">.&gt;&gt;</span> <span class="n">puom</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">pmb</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;MB&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pg</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;g&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pinch</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;inch&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pram</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;ram&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pweight</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;weight&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pscreen</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;screen&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">pramFilter</span> <span class="o">=</span> <span class="n">createCompleteFilter</span> <span class="n">pram</span> <span class="n">pmb</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pweightFilter</span> <span class="o">=</span> <span class="n">createCompleteFilter</span> <span class="n">pweight</span> <span class="n">pg</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pscreenFilter</span> <span class="o">=</span> <span class="n">createCompleteFilter</span> <span class="n">pscreen</span> <span class="n">pinch</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pfilter</span> <span class="o">=</span> <span class="n">choice</span> <span class="o">[</span><span class="n">pramFilter</span><span class="o">;</span><span class="n">pweightFilter</span><span class="o">;</span><span class="n">pscreenFilter</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">parser</span> <span class="o">=</span> <span class="n">sepBy</span> <span class="n">pfilter</span> <span class="n">pmultiFiltersSeperator</span>
</span><span class="line">
</span><span class="line">    <span class="k">match</span> <span class="n">run</span> <span class="n">parser</span> <span class="n">filterStr</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Success</span><span class="o">(</span><span class="n">filters</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="n">Choice1Of2</span><span class="o">(</span><span class="n">filters</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Failure</span><span class="o">(</span><span class="n">err</span><span class="o">,_,_)</span> <span class="o">-&gt;</span> <span class="n">Choice2Of2</span><span class="o">(</span><span class="n">err</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>parseFilter</code> function takes the search filter query from the front end, parses it using the custom parsers that we have built and return the <a href="http://msdn.microsoft.com/en-us/library/ee353439.aspx">Choice type</a>.</p>

<p>The <code>Choice1Of2</code> will contain a list of tuples (SearchFilter * ValueFilter) that represents the strongly typed AST of the given input query.</p>

<p>The <code>Choice2of2</code> will contain the error message in case if there is any parser error happened while parsing the input query.</p>

<h2 id="implementing-phone-search-backend">Implementing Phone Search backend</h2>

<p>With the parser in place, the next step is to building the backend logic of filtering the phones using the filters returned by the parsers</p>

<p>Open the module <code>Search</code> in the <strong>Domain</strong> project and add the following <code>searchPhones</code> function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">searchPhones</span> <span class="n">phones</span> <span class="n">filters</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">hasMetValueFilter</span> <span class="n">toUom</span> <span class="n">valueFilter</span> <span class="n">property</span>  <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">valueFilter</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Value</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">property</span> <span class="o">=</span> <span class="n">toUom</span> <span class="n">x</span>
</span><span class="line">    <span class="o">|</span> <span class="n">GreaterThan</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">property</span> <span class="o">&gt;</span> <span class="n">toUom</span> <span class="n">x</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Range</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">property</span> <span class="o">&gt;=</span> <span class="n">toUom</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">property</span> <span class="o">&lt;=</span> <span class="n">toUom</span> <span class="n">y</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">hasMetSearchFilter</span> <span class="n">filter</span> <span class="n">phone</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">valueFilter</span> <span class="o">=</span> <span class="o">(</span><span class="n">snd</span> <span class="n">filter</span><span class="o">)</span>
</span><span class="line">    <span class="k">match</span> <span class="o">(</span><span class="n">fst</span> <span class="n">filter</span><span class="o">)</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Ram</span> <span class="n">toMB</span> <span class="o">-&gt;</span> <span class="n">hasMetValueFilter</span> <span class="n">toMB</span> <span class="n">valueFilter</span> <span class="n">phone</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">Ram</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Weight</span> <span class="n">toG</span> <span class="o">-&gt;</span> <span class="n">hasMetValueFilter</span> <span class="n">toG</span> <span class="n">valueFilter</span> <span class="n">phone</span><span class="o">.</span><span class="n">Weight</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Screen</span> <span class="n">toInch</span><span class="o">-&gt;</span> <span class="n">hasMetValueFilter</span> <span class="n">toInch</span> <span class="n">valueFilter</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">ScreenSize</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">filterPhones</span> <span class="n">phones&#39;</span> <span class="n">filter</span> <span class="o">=</span>
</span><span class="line">    <span class="n">phones&#39;</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="n">hasMetSearchFilter</span> <span class="n">filter</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">rec</span> <span class="n">searchPhones&#39;</span> <span class="n">phones&#39;</span> <span class="n">filters&#39;</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">filters&#39;</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">phones&#39;</span>
</span><span class="line">    <span class="o">|</span> <span class="n">x</span> <span class="o">::</span> <span class="n">xs</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">searchPhones&#39;</span> <span class="o">(</span><span class="n">filterPhones</span> <span class="n">phones&#39;</span> <span class="n">x</span><span class="o">)</span> <span class="n">xs</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">searchPhones&#39;</span> <span class="n">phones</span> <span class="n">filters</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The function <code>searchPhones</code> recursively applies the filters one by one over the list of phones and filter the phones based on the filter criteria.</p>

<h2 id="exposing-the-phone-search-as-web-api">Exposing the phone search as web-api</h2>

<p>Open the <code>PhonesController</code> that we have added in the <a href="http://www.p3programmer.com/blog/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">step-1</a> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Error</span> <span class="o">=</span> <span class="o">{</span> <span class="n">message</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/phones&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">PhonesController</span>
</span><span class="line">    <span class="o">(</span>
</span><span class="line">        <span class="n">getTopSellingPhones</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">        <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">        <span class="n">catalogPhones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">Catalog</span><span class="p">.</span><span class="n">Phone</span><span class="o">&gt;</span>
</span><span class="line">    <span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">    <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;topselling&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetTopSelling</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">      <span class="n">getTopSellingPhones</span> <span class="mi">3</span> <span class="n">phones</span>
</span><span class="line">
</span><span class="line">    <span class="o">[&lt;</span><span class="n">HttpGet</span><span class="o">&gt;]</span>
</span><span class="line">    <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;search&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">SearchPhones</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">parserResult</span> <span class="o">=</span> <span class="nn">SearchParser</span><span class="p">.</span><span class="n">parseFilter</span> <span class="n">q</span>
</span><span class="line">      <span class="k">match</span> <span class="n">parserResult</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Choice1Of2</span> <span class="n">filters</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">filteredPhones</span> <span class="o">=</span> <span class="nn">Search</span><span class="p">.</span><span class="n">searchPhones</span> <span class="n">catalogPhones</span> <span class="n">filters</span>
</span><span class="line">        <span class="k">base</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">CreateResponse</span><span class="o">(</span><span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="o">,</span> <span class="n">filteredPhones</span><span class="o">)</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Choice2Of2</span> <span class="n">errMsg</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="k">base</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">CreateResponse</span><span class="o">(</span><span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="o">,</span> <span class="o">{</span> <span class="n">message</span> <span class="o">=</span> <span class="n">errMsg</span> <span class="o">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The action method <code>SearchPhones</code> gets the input query <code>q</code> from the user and give it to the parser using the <code>parseFilter</code> function. If the parsing is successful, then we will be calling the <code>searchPhones</code> function with the filters returned by the parser. If the parsing failed, we will be returning the error response with the error message from the parser.</p>

<p>We have added a new dependency <code>catalogPhones</code> in the <code>PhonesController</code> constructor which represents all the available phones in the catalog. We need to inject it while creating the controller. Open the <code>Infrastructure</code> module and update the <code>PhonesController</code> creation as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">controllerDescriptor</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phoneIndexes</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhoneIndex</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">catalogPhones</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToCatalogPhone</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">
</span><span class="line">  <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhonesController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getTopSellingPhones</span> <span class="o">(</span><span class="nn">InMemoryInventory</span><span class="p">.</span><span class="n">getPhonesSold</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">phonesController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhonesController</span><span class="o">(</span><span class="n">getTopSellingPhones</span><span class="o">,</span> <span class="n">phones&#39;</span><span class="o">,</span> <span class="n">catalogPhones</span><span class="o">)</span>
</span><span class="line">      <span class="n">phonesController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">  <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="creating-phone-search-view">Creating Phone Search View</h2>

<p>The final step of the creating a view for the Phone Search which enable the user to search the phones using the DSL that we have created so far.</p>

<p>It is straight forward razor view creation as we have seen in <a href="http://www.p3programmer.com/blog/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">step-2</a>. Add an action method <code>Search</code> in the <code>PhoneController</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Search</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="bp">()</span>
</span><span class="line"><span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Create a razor view <strong>Search.cshtml</strong> in the <em>Views/Phone</em> directory and add the code as <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/5/Web/Views/Phone/Show.cshtml">defined here</a>.</p>

<p>The javascript side has been taken care by knockout.js and you can find the script that takes care of calling the api and rendering the filtered phones <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/5/Web/Scripts/search.js">here</a>. </p>

<h2 id="summary">Summary</h2>

<p>Its a little longer post than I expected and I am glad that you have read it this far. I’d like give credit to this <a href="http://blog.fogcreek.com/fparsec/">blog post</a> by <a href="http://haolian.org/">Hao Lian</a> which I’ve used as a reference to come up with this implementation. As usual you can find the source code in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/5">phonecat github repository</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-4 Build automation using FAKE]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2015/01/06/step-4-build-automation-using-fake/"/>
    <updated>2015-01-06T05:22:32+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2015/01/06/step-4-build-automation-using-fake</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 4 of my blog series on <a href="http://www.p3programmer.com/blog/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the last three steps, we have seen how to build an web application in fsharp by leveraging <a href="http://www.p3programmer.com/blog/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">Web-Api</a>, <a href="http://www.p3programmer.com/blog/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">Razor</a> and <a href="http://www.p3programmer.com/blog/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/">SignalR</a>. In this step for a change we are going to take the <a href="http://en.wikipedia.org/wiki/DevOps">DevOps</a> side of the application and going to add the build automation capabilities for the application. Let’s get stated!</p>

<h2 id="fake---an-awesome-build-automation-library">Fake - An awesome build automation library</h2>

<p><a href="http://fsharp.github.io/FAKE/">Fake</a> is a F# version of very successful and widely used build automation libraries <a href="http://www.gnu.org/software/make/">Make</a> and <a href="http://en.wikipedia.org/wiki/Rake_%28software%29">Rake</a>. The combination of <a href="http://fsharp.org/testimonials/">fsharp’s expressiveness</a> and the <a href="http://fsharp.github.io/FAKE/gettingstarted.html">Fake’s DSL</a> is a visual treat to the eyes and especially if you are someone who is using <a href="http://en.wikipedia.org/wiki/MSBuild">MsBuild</a> xml files for doing build automation you will definitely appreciate it.</p>

<h3 id="adding-nugetexe-to-nuget-folder">Adding nuget.exe to .nuget folder</h3>

<p>As we are going to drive the nuget packages installation from the fsharp script file, we will be needing a <a href="nuget.org/nuget.exe">command line version of nuget</a>. Download it and place it inside the <strong>.nuget</strong> folder</p>

<p>Also its a good practice to add a <a href="http://docs.nuget.org/docs/reference/nuget-config-settings">Nuget.config file</a>. Add it too under <strong>.nuget</strong> folder. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class="line"><span class="nt">&lt;configuration&gt;</span>
</span><span class="line">  <span class="nt">&lt;packageSources&gt;</span>
</span><span class="line">    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">&quot;nuget.org&quot;</span> <span class="na">value=</span><span class="s">&quot;https://www.nuget.org/api/v2/&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/packageSources&gt;</span>
</span><span class="line"><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="adding-buildbat-file">Adding build.bat file</h3>

<p>Create a batch file <strong>build.bat</strong> in the root directory of the solution. It is going act as bootstrap file which initiates the entire build process.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="bat"><span class="line"><span class="p">@</span><span class="k">echo</span> <span class="k">off</span>
</span><span class="line"><span class="k">cls</span>
</span><span class="line"><span class="s2">&quot;.nuget\NuGet.exe&quot;</span> <span class="s2">&quot;Install&quot;</span> <span class="s2">&quot;FAKE&quot;</span> <span class="s2">&quot;-OutputDirectory&quot;</span> <span class="s2">&quot;tools&quot;</span> <span class="s2">&quot;-ExcludeVersion&quot;</span>
</span><span class="line"><span class="s2">&quot;tools\FAKE\tools\Fake.exe&quot;</span> build.fsx
</span><span class="line"><span class="k">pause</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>It just download the Fake nuget package using the nuget.exe that we added earlier and call the fake.exe with the fsharp build script <strong>build.fsx</strong>.</p>

<h3 id="adding-buildfsx-file">Adding build.fsx file</h3>

<p>Create a <a href="http://blogs.msdn.com/b/chrsmith/archive/2008/09/12/scripting-in-f.aspx">fsharp script file</a> with the name <strong>build.fsx</strong> in the root directory. This script is going to implement all our build automation tasks by using fake library.</p>

<h3 id="cleaning-the-build-directory">Cleaning the build directory</h3>

<p>Just a like any other build process, the first step is to clear the build directory. Fake follows the same convention of MsBuild’s <a href="http://msdn.microsoft.com/en-us/library/ms171462.aspx">Targets</a>. Defining targets in Fake is less verbose compare to its MsBuild’s counterpart. As a matter of fact, it is a fsharp function that take two parameters, the name of the target and a function which defines the target. </p>

<p>Since it is a script file we need to add reference to the <strong>FakeLib.dll</strong> before writing the actual code.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">#</span><span class="n">r</span> <span class="s">&quot;tools/FAKE/tools/FakeLib.dll&quot;</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Fake</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">buildDir</span> <span class="o">=</span> <span class="s">&quot;./build&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">Target</span> <span class="s">&quot;Clean&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">CleanDir</span> <span class="n">buildDir</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Less verbose, Isn’t it ?</p>

<p>The <code>CleanDir</code> is a predefined function in Fake library which clean up this build directory. If the directory doesn’t exist it creates the directory. </p>

<h3 id="build-the-solution">Build the solution</h3>

<p>After cleaning the build directory the next step is to carrying out the actual build process. Before building the application we need to resolve the nuget packages being referred in the application. It’s so simple in Fake. All you need to do is just call predefined function <code>RestorePackages</code>.    </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="n">Target</span> <span class="s">&quot;Build&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="n">RestorePackages</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">!!</span> <span class="s">&quot;./PhoneCat.sln&quot;</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">MSBuildRelease</span> <span class="n">buildDir</span> <span class="s">&quot;Build&quot;</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">Log</span> <span class="s">&quot;Build-Output: &quot;</span>
</span><span class="line">
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>!!</code> is a function which takes a file path and returns <a href="http://fsharp.github.io/FAKE/apidocs/fake-filesystem-fileincludes.html">FileIncludes</a> which is Fake’s internal representation of a file set.</p>

<p>FileIncludes <a href="https://github.com/fsharp/FAKE/blob/master/src/app/FakeLib/Globbing/FileSystem.fs#L95-l117">implements</a> <code>IEnumerable&lt;string&gt;</code> so it can be used wherever we need an <code>IEnumerable&lt;string&gt;</code>. </p>

<p>The <code>MsBuildRelease</code> is also a predefined function in Fake which builds the given solution (which is piped from the <code>!!</code>). The first two parameters are the output build directory path and the target names which should be run by MsBuild. Fake offers lot of functional wrappers on top of MsBuild and you can find more about it in this <a href="http://fsharp.github.io/FAKE/apidocs/fake-msbuildhelper.html">api documentation.</a>. </p>

<p>The last line just pipes the log result from the <code>MsBuildRelease</code> function to the log output.</p>

<h3 id="running-unit-tests-using-nunitrunner">Running unit tests using Nunit.Runner</h3>

<p>Now we have built the solution and the next step is running the unit test cases. Since I’ve written the test cases using Nunit and we are going to see how to run nunit tests using Fake. Fake also supports <a href="http://fsharp.github.io/FAKE/apidocs/fake-xunithelper.html">XUnit</a> and <a href="http://fsharp.github.io/FAKE/apidocs/fake-mstest.html">MsTest</a>. Porting the below code to other unit testing framework is very straight forward.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="n">Target</span> <span class="s">&quot;Test&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">  <span class="o">!!</span> <span class="o">(</span><span class="n">buildDir</span> <span class="o">+</span> <span class="s">&quot;/*.Tests.dll&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">NUnit</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">p</span> <span class="k">with</span> <span class="n">ToolPath</span> <span class="o">=</span> <span class="s">&quot;./tools/NUnit.Runners/tools&quot;</span> <span class="o">})</span>
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>As we did it in the build target, the <code>!!</code> function picks all the unit test files (I’ve used a convention of naming the unit tests projects with the <strong>.Tests</strong> suffix) in the build directory and transform them to FileIncludes. </p>

<p>The <code>NUnit</code> is yet another <a href="http://fsharp.github.io/FAKE/apidocs/fake-nunitsequential.html">inbuilt function of Fake</a> which runs nunit on the given group of assemblies.</p>

<p>It takes two parameter, a function that returns the modified default <code>NUnitParams</code> value and a sequence of assembly paths. We have modified the default <code>ToolPath</code> property which specifies the file path of <strong>NUnit Runner</strong> </p>

<p>As we did for Fake we have to modify the batch file as below to install the Nunit Runner nuget package before running the actual script.  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="bat"><span class="line"><span class="p">@</span><span class="k">echo</span> <span class="k">off</span>
</span><span class="line"><span class="k">cls</span>
</span><span class="line"><span class="s2">&quot;.nuget\NuGet.exe&quot;</span> <span class="s2">&quot;Install&quot;</span> <span class="s2">&quot;FAKE&quot;</span> <span class="s2">&quot;-OutputDirectory&quot;</span> <span class="s2">&quot;tools&quot;</span> <span class="s2">&quot;-ExcludeVersion&quot;</span>
</span><span class="line"><span class="s2">&quot;.nuget\NuGet.exe&quot;</span> <span class="s2">&quot;Install&quot;</span> <span class="s2">&quot;NUnit.Runners&quot;</span> <span class="s2">&quot;-OutputDirectory&quot;</span> <span class="s2">&quot;tools&quot;</span> <span class="s2">&quot;-ExcludeVersion&quot;</span>
</span><span class="line">
</span><span class="line"><span class="s2">&quot;tools\FAKE\tools\Fake.exe&quot;</span> build.fsx
</span><span class="line"><span class="k">pause</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="deploy-the-application-in-iis">Deploy the application in IIS</h3>

<p>Well, now we are at the final step of the build process which deploy the application in the local IIS server. </p>

<p>Deploying an application in IIS is super easy using Fake. All you need to do is just input necessary things like site name, virtual directory name, etc., and call the <code>IIS</code> function in <strong>Fake.IIS</strong> library which is installed as part of Fake.</p>

<p>To begin with we need to add reference in the beginning <strong>build.fsx</strong> to include the <strong>Fake.IIS</strong> library. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">#</span><span class="n">r</span> <span class="s">&quot;tools/FAKE/tools/Fake.IIS.dll&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This <strong>Fake.IIS</strong> makes heavy use of <a href="http://msdn.microsoft.com/en-us/library/microsoft.web.administration.servermanager(v=vs.90).aspx">ServerManager</a> which helps to dynamically configure IIS 7.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="n">Target</span> <span class="s">&quot;Deploy&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">siteName</span> <span class="o">=</span> <span class="s">&quot;fsharp&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">appPool</span> <span class="o">=</span> <span class="s">&quot;fsharp.appPool&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">port</span> <span class="o">=</span> <span class="s">&quot;:9999:&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">vdir</span> <span class="o">=</span> <span class="s">&quot;/phonecat&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">webBuildPath</span> <span class="o">=</span> <span class="n">buildDir</span> <span class="o">+</span> <span class="s">&quot;/_PublishedWebsites/Web&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">sitePhysicalPath</span> <span class="o">=</span> <span class="s">@&quot;c:\inetpub\wwwroot\phonecat&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="n">XCopy</span> <span class="n">webBuildPath</span> <span class="n">sitePhysicalPath</span>
</span><span class="line">
</span><span class="line">  <span class="o">(</span><span class="n">IIS</span>
</span><span class="line">    <span class="o">(</span><span class="n">Site</span> <span class="n">siteName</span> <span class="s">&quot;http&quot;</span> <span class="n">port</span> <span class="s">@&quot;C:\inetpub\wwwroot&quot;</span> <span class="n">appPool</span><span class="o">)</span>
</span><span class="line">    <span class="o">(</span><span class="n">ApplicationPool</span> <span class="n">appPool</span> <span class="k">true</span> <span class="s">&quot;v4.0&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">(</span><span class="n">Some</span><span class="o">(</span><span class="n">Application</span> <span class="n">vdir</span> <span class="n">sitePhysicalPath</span><span class="o">)))</span>
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>When we build a web project using MsBuild in release mode, it creates a deployable directory which can be accessed using the path <em>/_PublishedWebsites/Web</em> in the build directory. So, after building the application we just need to copy this deployable directory to the <strong>intepub\wwwroot</strong> directory using the XCopy function in Fake.</p>

<p>The <code>IIS</code> function takes three parameters</p>

<ul>
  <li>site - A function with the signature <code>ServerManager -&gt; Site</code> which takes an instance of ServerManager and returns a <a href="http://msdn.microsoft.com/en-us/library/microsoft.web.administration.site(v=vs.90).aspx">Site</a> with the given site settings. </li>
  <li>appPool - A function with the signature <code>ServerManager -&gt; ApplicationPool</code> which takes an instance of ServerManager and returns a <a href="http://msdn.microsoft.com/en-us/library/microsoft.web.administration.applicationpool(v=vs.90).aspx">AppPool</a> with the given appPool settings.  </li>
  <li>app - An option type with the signature <code>(Site -&gt; ServerManager -&gt; Application) option</code> provides the <a href="http://msdn.microsoft.com/en-us/library/microsoft.web.administration.application(v=vs.90).aspx">Application</a>  </li>
</ul>

<p>Fake’s IIS helper library has in-built function for Site, ApplicationPool and Application which takes the necessary inputs need for its creation and returns the associated instances. All of these function creates Site, ApplicationPool and Application respectively if they are not available in the IIS. </p>

<h3 id="running-the-targets">Running the Targets</h3>

<p>In the above steps we just defined various Fake targets. These targets doesn’t execute on its own and we need to explicitly define the order of its execution and initiate.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="s">&quot;Clean&quot;</span>
</span><span class="line">  <span class="o">==&gt;</span> <span class="s">&quot;Build&quot;</span>
</span><span class="line">  <span class="o">==&gt;</span> <span class="s">&quot;Test&quot;</span>
</span><span class="line">  <span class="o">==&gt;</span> <span class="s">&quot;Deploy&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">RunTargetOrDefault</span> <span class="s">&quot;Deploy&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>==&gt;</code> is one of <a href="http://fsharp.github.io/FAKE/apidocs/fake-additionalsyntax.html">the DSL in Fake</a> which is actually a function that defines the target execution order.</p>

<p>The <code>RunTargetOrDefault</code> function runs the target specified in the parameter or executes the default target.</p>

<h3 id="summary">Summary</h3>

<p>Fake is just awesome. We can automate so much things with very few lines of code and the beauty is it can be used in <strong>any .net projects</strong>. If you are using MsBuild Xml scripts, do try Fake! It will make you super productive. You can find the source of this step in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/4">fsharp-phonecat repository</a>. </p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-3 PhoneCat Recommendation System using F# Agents, SignalR and Rx]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/"/>
    <updated>2015-01-02T05:44:52+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 3 of my blog series on <a href="http://www.p3programmer.com/blog/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the last two steps we have seen how to create a <a href="http://www.p3programmer.com/blog/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">web apis</a> and <a href="http://www.p3programmer.com/blog/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">static razor views</a> in fsharp. In this blog post we are going to see one of my favorite feature in fsharp <a href="http://fsharpforfunandprofit.com/posts/concurrency-actor-model/">“Message based approach to concurrency”</a>.</p>

<h3 id="a-small-flashback">A Small Flashback</h3>
<p>I’ve actually planned to put this blog post for the great fsharp community initiative <a href="https://sergeytihon.wordpress.com/2014/11/24/f-advent-calendar-in-english-2014/">F# Advent Calender</a>. Unfortunately it was not able to get through as I’ve <a href="http://sergeytihon.wordpress.com/2014/11/24/f-advent-calendar-in-english-2014/#comment-4135">nominated myself</a> little late. I always believe there is an opportunity behind every adversity. I didn’t get hung up and I knew this is one of the great topic to blog about. When I decided to blog about it, I needed a sample web application. So, I was creating that sample application and it suddenly strikes! <em>How about a blog series on web application development in fsharp?</em> I’ve immediately started working on it and hence this blog series.</p>

<h3 id="so-what-we-gonna-do-in-this-step">So what we gonna do in this step</h3>
<p>In this blog post we are going to build a recommendation system which keeps track of what phones that the user is viewing, and based on his navigation history, we will be recommending a phone that he might be interested in</p>

<p style="text-align:center"> <strong> User visits &#8220;Motorola XOOM™&#8221; </strong> </p>
<p><img src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_3/Phone_1.png" /></p>

<p style="text-align:center"> <strong> User visits &#8220;Motorola XOOM™ with Wi-Fi&#8221; </strong> </p>
<p><img src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_3/Phone_2.png" /></p>

<p>Let us start the implementation by defining two high level tasks</p>

<ol>
  <li>Tracking user navigation</li>
  <li>Recommending a phone</li>
</ol>

<h3 id="tracking-user-navigation">1. Tracking user navigation</h3>

<p><img class="center" src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_3/Phone_Visit_Workflow.png" width="600" height="500" /></p>

<p>The first two components has been already implemented as part of <a href="http://www.p3programmer.com/blog/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">step-2</a>. So we just need to wire up the other two components. Let’s start from <code>PhoneViewTracker</code></p>

<p>Create a source file in the <strong>Web</strong> project and name it as <code>PhoneViewTracker</code>. Add a function <code>observePhonesViewed</code> which will be invoked when you a user visits a phone.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">PhoneViewTracker</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">observePhonesViewed</span> <span class="n">anonymousId</span> <span class="n">phoneIdBeingVisited</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">StorageAgent</span><span class="p">.</span><span class="n">Post</span> <span class="o">(</span><span class="n">SavePhoneVisit</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">phoneIdBeingVisited</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>anonymousId</code> is a <a href="http://msdn.microsoft.com/en-us/library/system.web.httprequest.anonymousid%28v=vs.110%29.aspx">http property</a> which represents a unique identifier for the given user session</p>

<p>Upon receiving the <code>anonymousId</code> and <code>phoneIdBeingVisited</code> we will be posting a message to the <code>StorageAgent</code> to save this visit. Both the agent and the message doesn’t exist now, so lets create them</p>

<p>Create a source file in the <strong>Domain</strong> project and name it as <code>UserNavigationHistory</code> and add the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Reactive.Subjects</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Collections.Generic</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Agent</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">MailboxProcessor</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">T</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">UserNavigationHistory</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">StorageAgentMessage</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">storageAgentFunc</span> <span class="o">(</span><span class="n">agent</span> <span class="o">:</span> <span class="n">Agent</span><span class="o">&lt;</span><span class="n">StorageAgentMessage</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">loop</span> <span class="o">(</span><span class="n">dict</span> <span class="o">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">list</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">storageAgentMessage</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
</span><span class="line">      <span class="k">match</span> <span class="n">storageAgentMessage</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">phoneIdBeingVisited</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="k">if</span> <span class="n">dict</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">            <span class="k">let</span> <span class="nv">phoneIdsVisited</span> <span class="o">=</span> <span class="n">phoneIdBeingVisited</span> <span class="o">::</span> <span class="n">dict</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span>
</span><span class="line">            <span class="n">dict</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">phoneIdsVisited</span>
</span><span class="line">          <span class="k">else</span>
</span><span class="line">            <span class="n">dict</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="o">[</span><span class="n">phoneIdBeingVisited</span><span class="o">])</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">loop</span> <span class="n">dict</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="n">loop</span> <span class="o">(</span><span class="k">new</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">list</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">StorageAgent</span> <span class="o">=</span> <span class="nn">Agent</span><span class="p">.</span><span class="n">Start</span><span class="o">(</span><span class="n">storageAgentFunc</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Storage Agent is an F# Agent which stores the user navigation history in an in-memory dictionary. It can be replaced by any key-value store like <a href="http://redis.io/">redis</a> but for experimentation I’ve preferred to use F# Agents.</p>

<p>The <code>StorageAgentMessage</code> is a <a href="http://fsharpforfunandprofit.com/posts/discriminated-unions/">dicriminated union</a> represents possible messages that the <code>StorageAgent</code> can process. Right now it has only message <code>SavePhoneVisit</code> which takes a tuple representing the <code>anonymousId</code> and the <code>phoneIdBeingVisited</code></p>

<p>The <code>StorageAgent</code> is a typical F# Agent which waits for the incoming <code>StorageAgentMessage</code> and upon receiving it stores the visit in the in-memory dictionary. </p>

<p>The next step is wiring the <code>PhoneViewTracker.observePhonesViewed</code> function with the <code>PhoneController.Show</code> action method. We can call the function directly that will create a strongly coupled code. We can even directly post the message to the agent. But that also makes the code tightly coupled. </p>

<p>What we are actually trying to implement here is a <strong>User Phone Visit Stream</strong>. Whenever the user visits a phone, we just want to notifiy somebody to keep track of it and move on. And its where <a href="http://msdn.microsoft.com/en-in/data/gg577609.aspx">Reactive Extensions aka Rx</a> comes into the picture. If you are new to Reactive Programming or Rx, I strongly recommend you to go through <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">this excellent article</a> by <a href="http://staltz.com/">André Staltz</a></p>

<p>Install the <a href="https://www.nuget.org/packages/Rx-Main/">Rx Nuget Package</a> in the <em>Web</em> project. With Rx in the kitty the next step is to make the User’s phone visit as event and subscribe this event with the <code>PhoneViewTracker</code></p>

<p>The first step is to make the <code>PhoneController</code> as observable. Modify the already created <code>PhoneController</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">PhoneController</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Subject</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">interface</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span> <span class="k">with</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Subscribe</span> <span class="n">observer</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">Subscribe</span> <span class="n">observer</span>
</span><span class="line">
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Show</span> <span class="o">(</span><span class="n">id</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phone</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">id</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">PhoneViewModel</span><span class="p">.</span><span class="n">ToPhoneViewModel</span>
</span><span class="line">    <span class="n">subject</span><span class="o">.</span><span class="n">OnNext</span> <span class="n">id</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">phone</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">Dispose</span> <span class="n">disposing</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="n">disposing</span> <span class="k">then</span>
</span><span class="line">      <span class="n">subject</span><span class="o">.</span><span class="n">OnCompleted</span><span class="bp">()</span>
</span><span class="line">      <span class="n">subject</span><span class="o">.</span><span class="n">Dispose</span><span class="bp">()</span>
</span><span class="line">    <span class="k">base</span><span class="o">.</span><span class="n">Dispose</span> <span class="n">disposing</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>One of the great feature of F# is its seamless interoperability with C# libraries. As you seen in the above code snippet we have just made the <code>PhoneController</code> into an observable by implementing the interface <a href="http://msdn.microsoft.com/en-us/library/dd990377%28v=vs.110%29.aspx">IObservable</a>. </p>

<p>We have created a private <a href="http://msdn.microsoft.com/en-us/library/hh242970%28v=vs.103%29.aspx">Rx Subject</a> and made it responsible for pushing the notification which contains the phone id that is being visited.</p>

<p>But wait how do we configure the subscription between this controller and the <code>PhoneViewTracker</code> ? Thanks to the CompositionRoot that we have <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/2/Web/Infrastructure.fs#L28-L32">created in the step-2</a>. As we have full control over the creation of controller its just a matter of two lines to achieve it.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">      <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">        <span class="c1">// ...</span>
</span><span class="line">        <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhoneController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToCatalogPhone</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">observer</span> <span class="o">=</span> <span class="nn">PhoneViewTracker</span><span class="p">.</span><span class="n">observePhonesViewed</span> <span class="o">(</span><span class="n">requestContext</span><span class="o">.</span><span class="n">HttpContext</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">AnonymousID</span><span class="o">)</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">phoneController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhoneController</span><span class="o">(</span><span class="n">phones&#39;</span><span class="o">)</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">subscription</span> <span class="o">=</span> <span class="n">phoneController</span><span class="o">.</span><span class="n">Subscribe</span> <span class="n">observer</span>
</span><span class="line">          <span class="n">phoneController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">        <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We are leveraging the ASP.NET’s <a href="http://msdn.microsoft.com/en-us/library/fsykd036.aspx">Anonymous Identification Module</a> which help us in creating a unique anonymous id for every user session. We can retrieve it from the <a href="http://msdn.microsoft.com/en-us/library/system.web.httprequest.anonymousid.aspx">HttpRequest</a> as mentioned in the above snippet</p>

<p><a href="http://msdn.microsoft.com/en-in/library/91ka2e6a(v=vs.85).aspx">Anonymous identification of user session</a> are not enabled by default, so add the following entry in the <strong>Web.config</strong> file</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;configuration&gt;</span>
</span><span class="line">  <span class="c">&lt;!-- Existing Code ignored for brevity ... --&gt;</span>
</span><span class="line">  <span class="nt">&lt;system.web&gt;</span>
</span><span class="line">    <span class="c">&lt;!-- Existing Code ignored for brevity... --&gt;</span>
</span><span class="line">    <span class="nt">&lt;anonymousIdentification</span> <span class="na">enabled=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/system.web&gt;</span>
</span><span class="line"><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With the help of the partial application of functions as we did it in the previous steps, we have created a partial function called <code>observer</code> which has the signature <code>string -&gt; unit</code>. Then we have subscribed to <code>PhoneController</code> using the <code>Subscribe</code> method and with this we are done with saving an user visit. </p>

<h3 id="recommending-a-phone">2. Recommending a phone</h3>

<p><strong>Workflow</strong></p>

<p><img class="center" src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_3/Phone_Recommendation_Workflow.png" width="600" height="500" /></p>

<ol>
  <li>User initiates the recommendation request using SignalR</li>
  <li>Upon receiving it, Recommendation SignalR hub sends a recommendation request message to Storage Agent with the user Anonymous Id and SignlaR connection Id of the given user</li>
  <li>Storage Agent then fetches the phone visit history of the given user based on the incoming anonymous id and pass it to the Recommendation Agent along with the SignalR connection id.</li>
  <li>Recommendation Agent responds to this by computing the recommendation and publish the result (Either recommended phone id or none) in the Recommendation observable</li>
  <li>Recommendation hub receives this recommendation result, send the response back to the corresponding SignalR client.</li>
</ol>

<p>The beauty of this entire workflow is all are message driven and asynchronous by default.  </p>

<p>Let’s start from Recommendation SignalR hub. The first step is installing SingalR from <a href="https://www.nuget.org/packages/Microsoft.AspNet.SignalR/2.1.2">the nuget</a>.</p>

<p>After installing create a source file in the <strong>Web</strong> project and name it as <code>Startup</code> then add the following code as per the SignalR convention.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Web</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">Owin</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Startup</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Configuration</span><span class="o">(</span><span class="n">app</span> <span class="o">:</span> <span class="n">IAppBuilder</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">MapSignalR</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then add an app setting in the <em>Web.config</em> file and configure the SignalR to use this <code>Startup</code> class</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;configuration&gt;</span>
</span><span class="line">  <span class="nt">&lt;appSettings&gt;</span>
</span><span class="line">    <span class="c">&lt;!-- Other keys.. --&gt;</span>
</span><span class="line">    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">&quot;owin:AppStartup&quot;</span> <span class="na">value=</span><span class="s">&quot;PhoneCat.Web.Startup&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/appSettings&gt;</span>
</span><span class="line">  <span class="c">&lt;!-- other configuration items.. --&gt;</span>
</span><span class="line"><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With SignalR added to the system, the next step is to create <code>RecommendationHub</code>. Add a source file in <strong>Web</strong> project and name it as <code>Hubs</code>.</p>

<p>Then create a <code>RecommendationHub</code> class with a public method <code>GetRecommendation</code> which will be invoked by the SignalR client to initiate recommendation process.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">RecommendationHub</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">Hub</span> <span class="bp">()</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetRecommendation</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">encodedAnonymousId</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">Cookies</span><span class="o">.[</span><span class="s">&quot;.ASPXANONYMOUS&quot;</span><span class="o">].</span><span class="n">Value</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">anonymousId</span> <span class="o">=</span> <span class="n">decode</span> <span class="n">encodedAnonymousId</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">connectionId</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">ConnectionId</span>
</span><span class="line">      <span class="nn">StorageAgent</span><span class="p">.</span><span class="n">Post</span> <span class="o">(</span><span class="n">GetRecommendation</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">connectionId</span><span class="o">))</span>
</span><span class="line">      <span class="s">&quot;Recommendation initiated&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then anonymous id of the user session is actually persisted in the <a href="http://msdn.microsoft.com/en-in/library/91ka2e6a%28v=vs.85%29.aspx">request cookies by Asp.Net</a> in an encoded format. In the <code>GetRecommendation</code> method we will be retrieving this encoded anonymous id from the cookie and decode it. Then we need to get the SignalR connection id which available in the base class <code>Hub</code>. After getting both the anonymous id and the connection id, send a <code>GetRecommendation</code> message to the <code>StorageAgent</code> with these information. Finally send a response to the SignalR client as “Recommendation initiated”.</p>

<p>The <code>decode</code> function is not added yet so let’s add them. Thanks to <a href="http://stackoverflow.com/a/2481110/159850">this stackoverflow answer</a> we just need to convert the code from C# to F#</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">decode</span> <span class="n">encodedAnonymousId</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">decodeMethod</span> <span class="o">=</span>
</span><span class="line">      <span class="n">typeof</span><span class="o">&lt;</span><span class="n">AnonymousIdentificationModule</span><span class="o">&gt;</span>
</span><span class="line">        <span class="o">.</span><span class="n">GetMethod</span><span class="o">(</span><span class="s">&quot;GetDecodedValue&quot;</span><span class="o">,</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">Static</span> <span class="o">|||</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">anonymousIdData</span> <span class="o">=</span> <span class="n">decodeMethod</span><span class="o">.</span><span class="n">Invoke</span><span class="o">(</span><span class="k">null</span><span class="o">,</span> <span class="o">[|</span> <span class="n">encodedAnonymousId</span> <span class="o">|]);</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">field</span> <span class="o">=</span>
</span><span class="line">      <span class="n">anonymousIdData</span><span class="o">.</span><span class="n">GetType</span><span class="bp">()</span>
</span><span class="line">        <span class="o">.</span><span class="n">GetField</span><span class="o">(</span><span class="s">&quot;AnonymousId&quot;</span><span class="o">,</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="o">|||</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="o">);</span>
</span><span class="line">    <span class="n">field</span><span class="o">.</span><span class="n">GetValue</span><span class="o">(</span><span class="n">anonymousIdData</span><span class="o">)</span> <span class="o">:?&gt;</span> <span class="kt">string</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We have used a special F# operator here <code>:?&gt;</code> which is a dynamic down cast operator which casts a base class to a sub-class of it. You can read <a href="http://msdn.microsoft.com/en-us/library/dd233220.aspx">this msdn documentation</a> to know more about F# casting and conversions.</p>

<p>The <code>GetRecommendation</code> message is not added yet, so let’s add them too. Modify <code>StorageAgentMessage</code> created before as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line">  <span class="k">type</span> <span class="nc">StorageAgentMessage</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span><span class="line">    <span class="o">|</span> <span class="n">GetRecommendation</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The final step of this pipeline is to Update the <code>StorageAgent</code> to handle this <code>GetRecommendation</code> message. Modify the <code>storageAgentFunc</code> in the <code>UserNavigationHistory</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"> <span class="k">let</span> <span class="nv">private</span> <span class="n">storageAgentFunc</span> <span class="o">(</span><span class="n">agent</span> <span class="o">:</span> <span class="n">Agent</span><span class="o">&lt;</span><span class="n">StorageAgentMessage</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">loop</span> <span class="o">(</span><span class="n">dict</span> <span class="o">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">list</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">storageAgentMessage</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
</span><span class="line">      <span class="k">match</span> <span class="n">storageAgentMessage</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">phoneIdBeingVisited</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="c1">// .. existing code ignored for brevity ..</span>
</span><span class="line">      <span class="o">|</span> <span class="n">GetRecommendation</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">connectionId</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="k">if</span> <span class="n">dict</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">            <span class="k">let</span> <span class="nv">phoneIdsVisited</span> <span class="o">=</span> <span class="n">dict</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span>
</span><span class="line">            <span class="nn">RecommendationAgent</span><span class="p">.</span><span class="n">Post</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span><span class="n">phoneIdsVisited</span><span class="o">)</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">loop</span> <span class="n">dict</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Handling of the <code>GetRecommendation</code> message is very straight forward. Just get the phone ids being visited by the given anonymous id from the in memory dictionary and send a message consists of connection id and this phone ids visited to the <code>RecommendationAgent</code> which we will be creating next.</p>

<p>Create a source file with the name <code>Recommendations</code> in the <strong>Domain</strong> project and add the <code>RecommendationAgent</code> below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Recommendation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">recommendationAgentFunc</span> <span class="o">(</span><span class="n">inbox</span> <span class="o">:</span> <span class="n">Agent</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">*</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">messageLoop</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">connectionId</span><span class="o">,</span> <span class="n">visitedPhoneIds</span> <span class="o">=</span> <span class="n">inbox</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="nn">Seq</span><span class="p">.</span><span class="n">length</span> <span class="n">visitedPhoneIds</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">then</span>
</span><span class="line">        <span class="n">suggestRecommendation</span> <span class="n">connectionId</span> <span class="o">(</span><span class="n">visitedPhoneIds</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">take</span> <span class="mi">2</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toList</span><span class="o">)</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">messageLoop</span><span class="bp">()</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">messageLoop</span> <span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">RecommendationAgent</span> <span class="o">=</span> <span class="nn">Agent</span><span class="p">.</span><span class="n">Start</span> <span class="n">recommendationAgentFunc</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In order to keep this blog post simple I’ve used my own ‘Hello World’ kind of algorithm which picks the latest two phone ids being visited and suggests recommendation based on it. In a real world you would be replacing this toddler algorithm with more sophisticated algorithms like <a href="http://en.wikipedia.org/wiki/Association_rule_learning">Association Rule Learning</a>. I am planning to implement this algorithm at later stages of this blog series.</p>

<p>Then the next step is to implement the <code>suggestRecommendation</code> function which picks a hardcoded recommendation and publish the result using Rx. To do this add the <a href="https://www.nuget.org/packages/Rx-Main/">Rx Nuget Package</a> in the <strong>Domain</strong> project and add the  <code>suggestRecommendation</code> function in the <code>Recommendation</code> module</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">RecommendationPipe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Subject</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">*</span><span class="kt">string</span> <span class="n">option</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">suggestRecommendation</span> <span class="n">connectionId</span> <span class="n">visitedPhoneIds</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">visitedPhoneIds</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="o">[</span><span class="s">&quot;motorola-xoom-with-wi-fi&quot;</span><span class="o">;</span> <span class="s">&quot;motorola-xoom&quot;</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">OnNext</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">Some</span> <span class="s">&quot;motorola-atrix-4g&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="o">[</span><span class="s">&quot;dell-streak-7&quot;</span><span class="o">;</span> <span class="s">&quot;dell-venue&quot;</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">OnNext</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">Some</span> <span class="s">&quot;nexus-s&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">OnNext</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">None</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The implementation is a very straight forward pattern matching. If last visited two items are (“motorola-xoom-with-wi-fi”, “motorola-xoom”), send the recommendation as “motorola-atrix-4g”, else if they are (“dell-streak-7”,”dell-venue”) then recommend “nexus-s”. If none of the condition matches then send none. Thanks to the <a href="http://fsharpforfunandprofit.com/posts/the-option-type/">option type</a> which expresses this result in type safe manner.</p>

<p>With all these infrastructure in place, all we need to do is to just subscribe to this <code>RecommendationPipe</code> and send the suggestion to the user via SignalR</p>

<p>Let’s add a observer for this pipe in the <strong>Web</strong> project. Open <code>Hubs</code> module in the <strong>Web</strong> project and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">getUrl</span> <span class="o">(</span><span class="n">phoneId</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="n">httpContext</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">routeValueDictionary</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RouteValueDictionary</span><span class="bp">()</span>
</span><span class="line">    <span class="n">routeValueDictionary</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;controller&quot;</span><span class="o">,</span> <span class="s">&quot;Phone&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">routeValueDictionary</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;action&quot;</span><span class="o">,</span> <span class="s">&quot;Show&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">routeValueDictionary</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">phoneId</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">requestContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RequestContext</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpContextWrapper</span><span class="o">(</span><span class="n">httpContext</span><span class="o">),</span> <span class="k">new</span> <span class="n">RouteData</span><span class="bp">()</span><span class="o">);</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">virtualPathData</span> <span class="o">=</span> <span class="nn">RouteTable</span><span class="p">.</span><span class="nn">Routes</span><span class="p">.</span><span class="n">GetVirtualPath</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">routeValueDictionary</span><span class="o">);</span>
</span><span class="line">    <span class="n">virtualPathData</span><span class="o">.</span><span class="n">VirtualPath</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">notifyRecommendation</span> <span class="n">httpContext</span> <span class="n">phones</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">recommendedPhoneId</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span>
</span><span class="line">    <span class="k">match</span> <span class="n">recommendedPhoneId</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="n">phoneId</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">recommendedPhone</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getPhoneById</span> <span class="n">phones&#39;</span> <span class="n">phoneId</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">phoneUrl</span> <span class="o">=</span> <span class="n">getUrl</span> <span class="n">phoneId</span> <span class="n">httpContext</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">hubContext</span> <span class="o">=</span> <span class="nn">GlobalHost</span><span class="p">.</span><span class="nn">ConnectionManager</span><span class="p">.</span><span class="n">GetHubContext</span><span class="o">&lt;</span><span class="n">RecommendationHub</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">      <span class="n">hubContext</span><span class="o">.</span><span class="n">Clients</span><span class="o">.</span><span class="n">Client</span><span class="o">(</span><span class="n">connectionId</span><span class="o">)?</span><span class="n">showRecommendation</span><span class="o">(</span><span class="n">recommendedPhone</span><span class="o">,</span> <span class="n">phoneUrl</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>notifyRecommendation</code> function checks whether the incoming recommendedPhoneId has value or not. If it has value, it just picks the <code>Phone</code> record corresponding to the given phoneId and get the url for the recommended phone. With all these data in place, we just need to send the response to the using via SignalR.</p>

<p>You would have a noticed a weird <code>?</code> symbol which is actually part of the <a href="https://www.nuget.org/packages/ImpromptuInterface.FSharp/">ImpromptuInterface.FSharp</a>. This library adds provisions to use <a href="http://msdn.microsoft.com/en-IN/library/dd264736.aspx">C# dynamic types</a> in F#</p>

<p>They are two missing pieces. One is <code>Phones.getPhoneById</code> which we are not having. Let’s add them. Open <code>Phones</code> module in <strong>Domain</strong> project and add it as mentioned below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getPhoneById</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="n">phoneId</span> <span class="o">=</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">phoneId</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The final step is wiring the <code>RecommendationPipe</code> with the <code>notifyRecommendation</code>. Open <code>Global.asax.fs</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Global</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// .. existing code ignore for brevity ..</span>
</span><span class="line"> <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Application_Start</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhones</span><span class="bp">()</span>
</span><span class="line">    <span class="c1">// .. existing code ignore for brevity ..</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">notificationObserver</span> <span class="o">=</span> <span class="nn">Hubs</span><span class="p">.</span><span class="n">notifyRecommendation</span> <span class="nn">HttpContext</span><span class="p">.</span><span class="n">Current</span> <span class="n">phones</span>
</span><span class="line">    <span class="nn">Recommendation</span><span class="p">.</span><span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">Subscribe</span> <span class="n">notificationObserver</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Partial application of function is a very handy thing which actually replaces its counterpart Dependency Injection in the OOP. We just provided the first two arguments of <code>notifyRecommendation</code> and created a new function with the signature <code>string * string option -&gt; unit</code> which is the expected observer signature for the <code>RecommendationPipe</code>.</p>

<h4 id="the-front-end-ui">The Front End UI</h4>
<p>The front end for this is a typical SignalR-Javascript client code which you can find it the <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/3/Web/Scripts/recommendation.js">github repository</a>. I’ve intentionally leaving the front-end part of this application as it would be extends the scope of the blog post. Moreover if you go through the source code in the github repository you can easily understand</p>

<h3 id="summary">Summary</h3>
<p>F# is just so awesome with so much expressive functional programming features. Rx, Agents and SignalR add more powers to it and enable you to create a scalable functional reactive architecture. I’d like give credits two incredible resources on this subject Mark Seemann’s Pluralsight course on <a href="http://www.pluralsight.com/courses/functional-architecture-fsharp">Functional Architecture with F#</a> and Kevin Ashton’s excellent blog post on <a href="http://namelessinteractive.com/blog/Full_Stack_FSharp_%E2%80%93_The_Long_Version_(Part_1)">Full Stack F#</a> which helped me a lot in coming out with this blog post.</p>

<p>Last but not the least, Thanks to <a href="https://sergeytihon.wordpress.com">Sergey Tihon</a> for the words of encouragement to write the blog post on this topic.</p>

<p>You can find the source code of this step in <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/3">the github repository</a>. </p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-2 Fsharp-PhoneCat Views using Razor]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/"/>
    <updated>2014-12-23T19:47:20+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 2 of my blog series on <a href="http://www.p3programmer.com/blog/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="http://www.p3programmer.com/blog/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">last blog post</a> we have created web-api endpoints which serve the data for the home page and in this blog post we are going to create views of the phones and manufacturers using <a href="http://en.wikipedia.org/wiki/ASP.NET_Razor_view_engine">Razor</a>.</p>

<h3 id="phone-view">Phone View</h3>
<p><img src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_2/Phone.png" /></p>

<p>As we did it in the step-1 we are going to start with the controller which serves the phone view. Let’s get started by creating a source file in <strong>Web</strong> project under the folders <em>Controllers</em> with the name <code>PhoneController</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">PhoneController</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Show</span> <span class="o">(</span><span class="n">id</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phone</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">id</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">PhoneViewModel</span><span class="p">.</span><span class="n">ToPhoneViewModel</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">phone</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The action method <code>Show</code> just picks the phone with the given id, converts the selected phone to a view model and returns the view.</p>

<p>The <code>phones</code> data which is being passed to the controller is actually a domain model representing the data that are required to show in the UI. Let’s create it in the <em>Domain</em> project. Create a source file in the <strong>Domain</strong> project and name it as <code>Catalog</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain.Measures</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">Catalog</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">Display</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">ScreenResolution</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ScreenSize</span> <span class="o">:</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">inch</span><span class="o">&gt;</span>
</span><span class="line">    <span class="n">TouchScreen</span> <span class="o">:</span> <span class="kt">bool</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">Storage</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Flash</span> <span class="o">:</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;</span>
</span><span class="line">    <span class="n">Ram</span> <span class="o">:</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">Android</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">OS</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">UI</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">Camera</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Features</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span>
</span><span class="line">    <span class="n">Primary</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">Phone</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Description</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Android</span> <span class="o">:</span> <span class="n">Android</span>
</span><span class="line">    <span class="n">Camera</span> <span class="o">:</span> <span class="n">Camera</span>
</span><span class="line">    <span class="n">Display</span> <span class="o">:</span> <span class="n">Display</span>
</span><span class="line">    <span class="n">Weight</span> <span class="o">:</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">g</span><span class="o">&gt;</span>
</span><span class="line">    <span class="n">Storage</span> <span class="o">:</span> <span class="n">Storage</span>
</span><span class="line">    <span class="n">Images</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>It’s a <a href="http://fsharpforfunandprofit.com/series/understanding-fsharp-types.html">typical type definition</a> in fsharp which describes the domain model <code>Phone</code>. Also if you remember we have already created a type with the same name <code>Phone</code> in <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/1/Domain/Production.fs#L29-L33">the previous step</a>. Though they share the name both are being used for different purposes. One for showing all the details of a phone and other one is for showing only few details about a phone. </p>

<p>This is what we call us <a href="http://martinfowler.com/bliki/BoundedContext.html">bounded context in DDD</a>. In fsharp we can easily achieve it using modules with less verbosity.</p>

<p>We have also used another awesome feature of fsharp called <a href="http://fsharpforfunandprofit.com/posts/units-of-measure/">units-of-measure</a> which help us <a href="http://en.wikipedia.org/wiki/Mars_Climate_Orbiter#Cause_of_failure">avoid failures in unit-coversion</a> by providing strong typed data.</p>

<p>In the later posts we will be extending the domain based on theses measure types right now it just expresses the domain correct. These measure types are not created yet so lets create them by adding a source file in <strong>Domain</strong> project with the name <code>Measures</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">Measures</span> <span class="o">=</span>
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Measure</span><span class="o">&gt;]</span> <span class="k">type</span> <span class="nc">inch</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Measure</span><span class="o">&gt;]</span> <span class="k">type</span> <span class="nc">g</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Measure</span><span class="o">&gt;]</span> <span class="k">type</span> <span class="nc">MB</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">toUOM</span> <span class="o">(</span><span class="n">measureString</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="n">stringToReplace</span> <span class="o">(</span><span class="n">uom</span> <span class="o">:</span> <span class="kt">float</span><span class="o">&lt;_&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span>
</span><span class="line">      <span class="k">if</span> <span class="n">measureString</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="k">then</span> <span class="mi">0</span><span class="o">.</span>
</span><span class="line">      <span class="k">else</span> <span class="n">measureString</span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="n">stringToReplace</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="kt">float</span>
</span><span class="line">    <span class="n">value</span> <span class="o">|&gt;</span> <span class="o">((*)</span> <span class="n">uom</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">toInch</span> <span class="o">(</span><span class="n">inchStr</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">toUOM</span> <span class="n">inchStr</span> <span class="s">&quot;inches&quot;</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">&lt;</span><span class="n">inch</span><span class="o">&gt;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">toGram</span> <span class="o">(</span><span class="n">weightStr</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">toUOM</span> <span class="n">weightStr</span> <span class="s">&quot;grams&quot;</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">&lt;</span><span class="n">g</span><span class="o">&gt;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">toMB</span> <span class="o">(</span><span class="n">storageStr</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">toUOM</span> <span class="n">storageStr</span> <span class="s">&quot;MB&quot;</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We have defined types to represents measures in inch, gram and megabytes. We have also added few utility methods to translate the raw string to strongly typed data which does the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&quot;200.5inches&quot; to 200.5&lt;inch&gt;
</span><span class="line">&quot;1200MB&quot; to 1200.&lt;MB&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>With the domain model in place the next step is to populate this domain model from the data-store. To do it we are going to reuse the PhoneTypeProvider that we have <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/1/DataAccess/TypeProviders.fs#L25">created in the step-1</a>. Since it has all the properties that we needed, we just need to add a function which does the mapping.</p>

<p>Open <code>TypeProviders</code> and add the below function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">ToCatalogPhone</span><span class="o">(</span><span class="n">phone</span> <span class="o">:</span> <span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">android</span> <span class="o">=</span> <span class="o">{</span> <span class="n">OS</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Android</span><span class="o">.</span><span class="n">Os</span><span class="o">;</span> <span class="n">UI</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Android</span><span class="o">.</span><span class="n">Ui</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">camera</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Features</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Camera</span><span class="o">.</span><span class="n">Features</span>
</span><span class="line">      <span class="n">Primary</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Camera</span><span class="o">.</span><span class="n">Primary</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">display</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">ScreenResolution</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">ScreenResolution</span>
</span><span class="line">      <span class="n">ScreenSize</span> <span class="o">=</span> <span class="n">toInch</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">ScreenSize</span>
</span><span class="line">      <span class="n">TouchScreen</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">TouchScreen</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">storage</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Flash</span> <span class="o">=</span> <span class="n">toMB</span> <span class="n">phone</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">Flash</span>
</span><span class="line">      <span class="n">Ram</span> <span class="o">=</span> <span class="n">toMB</span> <span class="n">phone</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">Ram</span><span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Id</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Name</span>
</span><span class="line">    <span class="n">Description</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Description</span>
</span><span class="line">    <span class="n">Android</span> <span class="o">=</span> <span class="n">android</span>
</span><span class="line">    <span class="n">Camera</span> <span class="o">=</span> <span class="n">camera</span>
</span><span class="line">    <span class="n">Display</span> <span class="o">=</span> <span class="n">display</span>
</span><span class="line">    <span class="n">Weight</span> <span class="o">=</span> <span class="n">toGram</span> <span class="n">phone</span><span class="o">.</span><span class="n">SizeAndWeight</span><span class="o">.</span><span class="n">Weight</span>
</span><span class="line">    <span class="n">Storage</span> <span class="o">=</span> <span class="n">storage</span>
</span><span class="line">    <span class="n">Images</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Images</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We are leveraging the utility functions <code>toGram</code>, <code>toMB</code> defined above as part of measure types and do seamless mapping of domain model from data store.</p>

<p>The next step is wiring the controller with the domain model and the data-store. We are going to follow the same <strong>Composition Root</strong> design as we <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/1/Web/Infrastructure.fs#L19-38">did in step-1</a></p>

<p>Add a source file in the <em>Web</em> project with the name <code>MvcInfrastructure</code> and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Web</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Web.Controllers</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Mvc</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">MvcInfrastructure</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">      <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">        <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">HomeController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">homeController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HomeController</span><span class="bp">()</span>
</span><span class="line">          <span class="n">homeController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">        <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhoneController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToCatalogPhone</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">phoneController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhoneController</span><span class="o">(</span><span class="n">phones&#39;</span><span class="o">)</span>
</span><span class="line">          <span class="n">phoneController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">        <span class="k">else</span>
</span><span class="line">          <span class="n">raise</span> <span class="o">&lt;|</span> <span class="n">ArgumentException</span><span class="o">((</span><span class="n">sprintf</span> <span class="s">&quot;Unknown controller type requested: %A&quot;</span> <span class="n">controllerType</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Similar to step-1 we are creating the composition root by passing the phones data and doing the wiring of different components.</p>

<p>Since we have created our custom ControllerFactory, we need to update the MVC configuration to use it when the framework creates the controllers.</p>

<p>Update the &#8220;`Global.asax.fs&#8220; file as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Application_Start</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phones</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhones</span><span class="bp">()</span>
</span><span class="line">  <span class="nn">AreaRegistration</span><span class="p">.</span><span class="n">RegisterAllAreas</span><span class="bp">()</span>
</span><span class="line">  <span class="nn">GlobalConfiguration</span><span class="p">.</span><span class="n">Configure</span><span class="o">(</span><span class="k">new</span> <span class="n">Action</span><span class="o">&lt;</span><span class="n">HttpConfiguration</span><span class="o">&gt;(</span><span class="k">fun</span> <span class="n">config</span> <span class="o">-&gt;</span> <span class="nn">Global</span><span class="p">.</span><span class="n">RegisterWebApi</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">phones</span><span class="o">)))</span>
</span><span class="line">  <span class="nn">Global</span><span class="p">.</span><span class="n">RegisterFilters</span><span class="o">(</span><span class="nn">GlobalFilters</span><span class="p">.</span><span class="n">Filters</span><span class="o">)</span>
</span><span class="line">  <span class="nn">Global</span><span class="p">.</span><span class="n">RegisterRoutes</span><span class="o">(</span><span class="nn">RouteTable</span><span class="p">.</span><span class="n">Routes</span><span class="o">)</span>
</span><span class="line">  <span class="nn">ControllerBuilder</span><span class="p">.</span><span class="nn">Current</span><span class="p">.</span><span class="n">SetControllerFactory</span><span class="o">(</span><span class="nn">MvcInfrastructure</span><span class="p">.</span><span class="n">CompositionRoot</span><span class="o">(</span><span class="n">phones</span><span class="o">))</span>
</span><span class="line">  <span class="nn">BundleConfig</span><span class="p">.</span><span class="n">RegisterBundles</span> <span class="nn">BundleTable</span><span class="p">.</span><span class="n">Bundles</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>In the last step the we have retrieved the phones data <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/1/Web/Global.asax.fs#L65">inside the RegisterWebApi method</a> and in this step we have moved it outside so that it can be used by both MVC Controllers and Web-Api controllers.</p>

<p>We have also changed the signature of RegisterWebApi method. In the <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/1/Web/Global.asax.fs#L51">earlier step</a> it gets the configuration parameter alone and now it has two parameters <code>httpConfiguration</code> and <code>phones</code></p>

<p>The next pending task in Phone View is translating the Phone Domain model to Phone View Model. Add the Phone View model in the <code>PhoneController</code> created before and update it us below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">PhoneViewModel</span> <span class="o">=</span>
</span><span class="line">  <span class="o">{</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Description</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Os</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Ui</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Flash</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Ram</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Weight</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ScreenResolution</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ScreenSize</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">TouchScreen</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Primary</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Features</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span>
</span><span class="line">    <span class="n">Images</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">with</span> <span class="k">static</span> <span class="k">member</span> <span class="n">ToPhoneViewModel</span><span class="o">(</span><span class="n">phone</span> <span class="o">:</span> <span class="n">Phone</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">roundToDigits</span> <span class="o">(</span><span class="n">value</span><span class="o">:</span><span class="kt">float</span><span class="o">)</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">Format</span><span class="o">(</span><span class="s">&quot;{0:0.00}&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">concatWithSpace</span> <span class="n">str2</span> <span class="n">str1</span> <span class="o">=</span> <span class="n">str1</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">str2</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">uomToString</span> <span class="o">(</span><span class="n">measureValue</span><span class="o">:</span> <span class="kt">float</span><span class="o">&lt;_&gt;)</span> <span class="n">measureName</span> <span class="o">=</span>
</span><span class="line">      <span class="n">measureValue</span> <span class="o">|&gt;</span> <span class="kt">float</span> <span class="o">|&gt;</span> <span class="n">roundToDigits</span> <span class="o">|&gt;</span> <span class="n">concatWithSpace</span> <span class="n">measureName</span>
</span><span class="line">
</span><span class="line">    <span class="o">{</span>
</span><span class="line">      <span class="n">Name</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Name</span>
</span><span class="line">      <span class="n">Description</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Description</span>
</span><span class="line">      <span class="n">Os</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Android</span><span class="o">.</span><span class="n">OS</span>
</span><span class="line">      <span class="n">Ui</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Android</span><span class="o">.</span><span class="n">UI</span>
</span><span class="line">      <span class="n">Flash</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">Flash</span> <span class="o">|&gt;</span> <span class="n">int</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s">&quot;%d MB&quot;</span>
</span><span class="line">      <span class="n">Ram</span> <span class="o">=</span>  <span class="n">phone</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">Ram</span> <span class="o">|&gt;</span> <span class="n">int</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s">&quot;%d MB&quot;</span>
</span><span class="line">      <span class="n">Weight</span> <span class="o">=</span> <span class="n">uomToString</span> <span class="n">phone</span><span class="o">.</span><span class="n">Weight</span> <span class="s">&quot;grams&quot;</span>
</span><span class="line">      <span class="n">ScreenResolution</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">ScreenResolution</span>
</span><span class="line">      <span class="n">ScreenSize</span> <span class="o">=</span> <span class="n">uomToString</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">ScreenSize</span> <span class="s">&quot;inches&quot;</span>
</span><span class="line">      <span class="n">TouchScreen</span> <span class="o">=</span> <span class="k">if</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">TouchScreen</span> <span class="k">then</span> <span class="s">&quot;Yes&quot;</span> <span class="k">else</span> <span class="s">&quot;No&quot;</span>
</span><span class="line">      <span class="n">Primary</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Camera</span><span class="o">.</span><span class="n">Primary</span>
</span><span class="line">      <span class="n">Features</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Camera</span><span class="o">.</span><span class="n">Features</span>
</span><span class="line">      <span class="n">Images</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Images</span>
</span><span class="line">    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>With all in place, we just need to create a razor view with the name <code>Show.cshtml</code> inside the <strong>View</strong> -&gt; <strong>Phone</strong> directory of <em>Web</em> project and update it <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/2/Web/Views/Phone/Show.cshtml">as mentioned here.</a> </p>

<p>That’s it. Phone View is up and running! Click the Phone Links in the Home Page it will take you to the Phones View Page.</p>

<h3 id="manufacturers-view">Manufacturers View</h3>
<p><img src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_2/Manufacturer.png" /><br />
Manufactures View follows the similar steps that we have used to create the Phone View. It displays the Phones manufactured by a selected manufacturer in the home page.</p>

<p>Let’s start from the controller. Create a controller in the <strong>Web</strong> project with the name <code>ManufacturerController</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="nn">Web</span><span class="p">.</span><span class="n">Controllers</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Mvc</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">ManufacturerViewModel</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="k">with</span> <span class="k">static</span> <span class="k">member</span> <span class="n">ToManufacturerViewModel</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">phones</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="o">{</span><span class="n">Name</span> <span class="o">=</span> <span class="nn">ManufacturerName</span><span class="p">.</span><span class="n">ToString</span> <span class="n">name</span><span class="o">;</span> <span class="n">Phones</span> <span class="o">=</span> <span class="n">phones</span><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">ManufacturerController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">getPhones</span> <span class="o">:</span> <span class="n">ManufacturerName</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">ManufacturerName</span> <span class="o">*</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Show</span> <span class="o">(</span><span class="n">id</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">viewModel</span> <span class="o">=</span>
</span><span class="line">      <span class="n">id</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">ManufacturerName</span><span class="p">.</span><span class="n">ToManufacturerName</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="n">getPhones</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">ManufacturerViewModel</span><span class="p">.</span><span class="n">ToManufacturerViewModel</span>
</span><span class="line">
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">viewModel</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>ManufacturerController</code> depends on the function <code>getPhones</code> which gives the Phones manufactured by the given manufacturer. The action method <code>Show</code> converts given id to the manufaturer name,  gets the Phones, converts them to <code>ManufacturerViewModel</code> and renders the view.</p>

<p>The domain model <code>Phone</code> mentioned here is the one that we have <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/1/Domain/Production.fs#L29-L33">already created in step-1</a>. The <code>getPhones</code> domain function is yet to be created. </p>

<p>Open <code>Phones</code> file in the <em>Domain</em> project and add the <code>getPhonesOfManufacturer</code> function.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getPhonesOfManufacturer</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">(</span><span class="n">manufacturerName</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span>
</span><span class="line">      <span class="n">phones</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="nn">ManufacturerName</span><span class="p">.</span><span class="n">ToManufacturerName</span> <span class="n">p</span><span class="o">.</span><span class="n">Name</span> <span class="o">=</span> <span class="n">manufacturerName</span><span class="o">)</span>
</span><span class="line">    <span class="o">(</span><span class="n">manufacturerName</span><span class="o">,</span> <span class="n">phones&#39;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>getPhonesOfManufacturer</code> function takes a sequence of phones and a manufacturer name, filters them for the given manufacturer and return a <a href="http://fsharpforfunandprofit.com/posts/tuples/">tuple</a> that contain the manufacturer name and the sequence of phones.</p>

<p>As we have already created the data-store functions which serves the required data, we just need to wire up the controller.</p>

<p>Update <code>MvcInfrastructure</code> file in the <em>Web</em> project to create <code>ManufacturerController</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">MvcInfrastructure</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">      <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">        <span class="c1">// ... Existing code ignored for brevity </span>
</span><span class="line">        <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">ManufacturerController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">getPhonesByManufactuerName</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span> <span class="o">|&gt;</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getPhonesOfManufacturer</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">manufacturerController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManufacturerController</span><span class="o">(</span><span class="n">getPhonesByManufactuerName</span><span class="o">)</span>
</span><span class="line">          <span class="n">manufacturerController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">        <span class="k">else</span>
</span><span class="line">          <span class="n">raise</span> <span class="o">&lt;|</span> <span class="n">ArgumentException</span><span class="o">((</span><span class="n">sprintf</span> <span class="s">&quot;Unknown controller type requested: %A&quot;</span> <span class="n">controllerType</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Thanks to the <a href="http://fsharpforfunandprofit.com/posts/partial-application/">partial function</a> we have partially applied the first parameter alone for the <code>Phones.getPhonesOfManufacturer</code> function which has the signature </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">seq&lt;Phone&gt; -&gt; ManufacturerName -&gt; seq&lt;Phone&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>and created a new function on the fly with the signature </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">ManufacturerName -&gt; seq&lt;Phone&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>which is the exactly the function that is needed by the <code>ManufacturerController</code></p>

<p>The final step is to create a razor view with the name <code>Show.cshtml</code> inside the <strong>View</strong> -&gt; <strong>Manufacturer</strong> directory of <strong>Web</strong> project and update it <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/2/Web/Views/Manufacturer/Show.cshtml">as mentioned here.</a> </p>

<h3 id="summary">Summary</h3>
<p>In this blog post we have seen how to create MVC Razor views in fsharp. You can find the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/2">source code in the github repository</a>. In the later posts we will be adding more interactivity. Stay tuned !!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step 1 - Phonecat backend using Web Api and TypeProviders]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/"/>
    <updated>2014-12-17T17:31:44+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 1 of my blog series on <a href="http://www.p3programmer.com/blog/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="http://www.p3programmer.com/blog/blog/2014/12/10/step-0-setting-up-the-fsharp-phonecat-solution/">last blog post</a> we have created the basic home page of phone cat with the placeholders and in this post we are going it wire the home page with the backend web apis.</p>

<p><img src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_1/home_page.png" /></p>

<p>As the above screenshot indicates we are going to develop three web api endpoints which serve the data to the front-end and we are going to use the existing json data available in <a href="https://github.com/angular/angular-phonecat/tree/master/app/phones">angular-phonecat</a> repository as our backend data store.</p>

<p>Initially I’ve planned to include TDD steps in this post but to keep it simple I am ignoring it. If you are interested in the tests that I’ve written check the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/1">source code.</a></p>

<h3 id="promotions-api">Promotions Api</h3>

<p>Let’s start with the promotions api which serves the data of three recently launched mobile phones. The first step is to create an ApiController called “PromotionsController”. You can create it by right clicking on the “Controllers” directory in the <strong>Web</strong> project and select <strong>Add -&gt; Source file</strong>. In the dialog box, name it as “PromotionsController”</p>

<p>After creating, update the controller with the dependencies as mentioned below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">Web</span><span class="p">.</span><span class="n">Controllers</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/promotions&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">PromotionsController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">getPromotions</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PhoneIndex</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PromotionPhone</span><span class="o">&gt;,</span>
</span><span class="line">    <span class="n">phoneIndexes</span><span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PhoneIndex</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>PromotionsController</code> has two dependencies. </p>

<ul>
  <li>
    <p><code>getPromotions</code> is a function a that takes a sequence of a domain model <code>PhoneIndex</code> and returns the sequence of domain model <code>PromotionPhone</code> which represents the phones that are recently launched.</p>
  </li>
  <li>
    <p><code>phoneIndexes</code> is a sequence of domain model <code>PhoneIndex</code> that represents the phones available in the backend data store.</p>
  </li>
</ul>

<p>These domain models currently not exists, so add them in the domain project as mentioned below</p>

<p>Right click on the domain project and select <strong>Add -&gt; Source file</strong>. In the dialog box, name it as “Promotions”. It creates a fsharp module with the name <code>Promotions</code> and add the <code>PromotionPhone</code> domain model</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Promotions</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">PromotionPhone</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ImageUrl</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Similarly, create an another source file called <code>Production</code> and add the domain model <code>PhoneIndex</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Production</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">PhoneIndex</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">      <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">      <span class="n">ImageUrl</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">      <span class="n">Age</span> <span class="o">:</span> <span class="n">int</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Age</code> property represents the age of the phone since its launch (so lower is younger!). Now the domain models are ready, the next step is to create an end point to expose it. </p>

<p>Let’s add a action method in PromotionsController which does the same</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Get</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="n">getPromotions</span> <span class="n">phoneIndexes</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The scaffolding is ready and the next step is to add the domain method <code>getPromotions</code> which does the actual business logic of giving recently launched phones.</p>

<p>Add the <code>getPromotions</code> function in the <code>Promotions</code> file as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getPromotions</span> <span class="o">(</span><span class="n">phoneIndexes</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PhoneIndex</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="n">phoneIndexes</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">phone</span> <span class="o">-&gt;</span> <span class="n">phone</span><span class="o">.</span><span class="n">Age</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">)</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">phone</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">Id</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Id</span><span class="o">;</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span> <span class="n">ImageUrl</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">ImageUrl</span><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>getPromotions</code> just filters the phones with the age less than 3 and map them to the corresponding <code>PromotionPhone</code> types.</p>

<p>Now its time to get the actual data from the data store. As I have mentioned earlier we will be using <a href="https://github.com/angular/angular-phonecat/tree/master/app/phones">angular-phonecat</a> repository as our data store. To access the data we will be using <a href="http://fsharp.github.io/FSharp.Data/library/JsonProvider.html">JsonTypeProvider</a>.</p>

<p>In the <em>DataAccess</em> project install the nuget package <a href="https://www.nuget.org/packages/FSharp.Data">FSharp.Data</a> and add a source file <code>TypeProviders</code>. Then update it with the type provider for Phone Index</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">FSharp.Data</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">TypeProviders</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">samplePhoneIndexes</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class="line"><span class="s">  [{</span>
</span><span class="line"><span class="s">      &quot;age&quot;: 1,</span>
</span><span class="line"><span class="s">      &quot;id&quot;: &quot;id0&quot;,</span>
</span><span class="line"><span class="s">      &quot;imageUrl&quot;: &quot;id0.jpg&quot;,</span>
</span><span class="line"><span class="s">      &quot;name&quot;: &quot;Name0&quot;,</span>
</span><span class="line"><span class="s">      &quot;snippet&quot;: &quot;Sample Snippet0&quot;</span>
</span><span class="line"><span class="s">  },{</span>
</span><span class="line"><span class="s">      &quot;age&quot;: 2,</span>
</span><span class="line"><span class="s">      &quot;id&quot;: &quot;id1&quot;,</span>
</span><span class="line"><span class="s">      &quot;imageUrl&quot;: &quot;id1.jpg&quot;,</span>
</span><span class="line"><span class="s">      &quot;name&quot;: &quot;Name1&quot;,</span>
</span><span class="line"><span class="s">      &quot;snippet&quot;: &quot;Sample Snippet2&quot;</span>
</span><span class="line"><span class="s">  }]</span>
</span><span class="line"><span class="s">  &quot;&quot;&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">PhoneIndexTypeProvider</span> <span class="o">=</span> <span class="n">JsonProvider</span><span class="o">&lt;</span><span class="n">samplePhoneIndexes</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">ToPhoneIndex</span> <span class="o">(</span><span class="n">phoneIndex</span> <span class="o">:</span> <span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="n">phoneIndex</span><span class="o">.</span><span class="n">Id</span><span class="o">;</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">phoneIndex</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span> <span class="n">Age</span> <span class="o">=</span> <span class="n">phoneIndex</span><span class="o">.</span><span class="n">Age</span><span class="o">;</span> <span class="n">ImageUrl</span> <span class="o">=</span> <span class="n">phoneIndex</span><span class="o">.</span><span class="n">ImageUrl</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>ToPhoneIndex</code> is a utility function which converts the data store model <code>PhoneIndexTypeProvider.Root</code> to the domain model <code>PhoneIndex</code></p>

<p>Now we got the type provide for <code>PhoneIndex</code>, the next step is populating it from the github repository. To do that add a source file <code>GitHubRepository</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">GitHubRepository</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">gitHubRepoUrl</span> <span class="o">=</span> <span class="s">&quot;https://raw.githubusercontent.com/angular/angular-phonecat/master/app/phones/&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">phoneIndexes</span> <span class="o">=</span> <span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Load</span><span class="o">(</span><span class="n">gitHubRepoUrl</span> <span class="o">+</span> <span class="s">&quot;phones.json&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getPhoneIndexes</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">phoneIndexes</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s it! just three line of code to get the data from the <a href="https://raw.githubusercontent.com/angular/angular-phonecat/master/app/phones/phones.json">angular-phonecat repo</a> and map to the equivalent strongly typed models  </p>

<h4 id="composition-root">Composition Root</h4>

<p>Now we need to wire up the controller with the domain and the data access. We can use a <a href="http://www.hanselman.com/blog/ListOfNETDependencyInjectionContainersIOC.aspx">Dependency Injection Container</a> to achieve it. In fact it used to be my default decision. But after reading this <a href="http://blog.ploeh.dk/2012/11/06/WhentouseaDIContainer/">wonderful blog post</a> by <a href="https://twitter.com/ploeh">Mark Seeman</a> I have actually started rethinking about dependency injection. In this sample application we are going to use the <a href="http://blog.ploeh.dk/2011/07/28/CompositionRoot/">Composition Root</a> as suggested by Mark Seeman.</p>

<p>In the <em>Web</em> project create a source file with the name <code>Infrastructure</code> and add the following composition root</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Web</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http.Dispatcher</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http.Controllers</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Web.Controllers</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">Infrastructure</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">CompositionRoot</span>
</span><span class="line">    <span class="o">(</span>
</span><span class="line">      <span class="n">phoneIndexes</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;</span>
</span><span class="line">    <span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">interface</span> <span class="n">IHttpControllerActivator</span> <span class="k">with</span>
</span><span class="line">
</span><span class="line">      <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">controllerDescriptor</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">        <span class="k">let</span> <span class="nv">phoneIndexes</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhoneIndex</span>
</span><span class="line">
</span><span class="line">        <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PromotionsController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">            <span class="k">let</span> <span class="nv">promotionsController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PromotionsController</span><span class="o">(</span><span class="n">getPromotions</span><span class="o">,</span> <span class="n">phoneIndexes&#39;</span><span class="o">)</span>
</span><span class="line">            <span class="n">promotionsController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">        <span class="k">else</span>
</span><span class="line">            <span class="n">raise</span> <span class="o">&lt;|</span> <span class="n">ArgumentException</span><span class="o">((</span><span class="n">sprintf</span> <span class="s">&quot;Unknown controller type requested: %A&quot;</span> <span class="n">controllerType</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We have actually created a custom implementation of <code>IHttpControllerActivator</code> as mentioned <a href="http://blog.ploeh.dk/2012/09/28/DependencyInjectionandLifetimeManagementwithASP.NETWebAPI/">here</a> which takes care of initializing the controllers by wiring the data store and the domain functions with the controller</p>

<p>The only pending task is tell ASP.NET Web Api to use this composition root. Update the <em>Global.asax.fs</em> file as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">static</span> <span class="k">member</span> <span class="n">RegisterWebApi</span><span class="o">(</span><span class="n">config</span><span class="o">:</span> <span class="n">HttpConfiguration</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// existing configuration will be here</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Additional Web API settings</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phoneIndexes</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhoneIndexes</span><span class="bp">()</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">Services</span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="n">typeof</span><span class="o">&lt;</span><span class="n">IHttpControllerActivator</span><span class="o">&gt;,</span> <span class="n">CompositionRoot</span><span class="o">(</span><span class="n">phoneIndexes</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have done an optimization by getting the phone indexes from the github when the application is starting, so that any requests to the application doesn’t get the data from github (typical enterprise performance improvement!).</p>

<h3 id="manufacturers-api">Manufacturers Api</h3>

<p>We are going to create the Manufacturers Api in the same way as Promotions Api. Let’s start from <code>ManufacturersController</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">Web</span><span class="p">.</span><span class="n">Controllers</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">ManufacturerViewModel</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/manufactures&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">ManufacturersController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">getManufacturerNames</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">ManufacturerName</span><span class="o">&gt;,</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Get</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="n">getManufacturerNames</span> <span class="n">phones</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">distinct</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">Name</span> <span class="o">=</span> <span class="nn">ManufacturerName</span><span class="p">.</span><span class="n">ToString</span> <span class="n">name</span><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As <code>PromotionsController</code>, <code>ManufacturersController</code> has also two dependencies.</p>

<ul>
  <li>
    <p><code>getManufacturerNames</code> is a function takes a sequence of domain model <code>Phone</code> and returns the sequence of domain model <code>ManufacturerName</code> which represents the manufacturer names of the given phones.</p>
  </li>
  <li>
    <p><code>phones</code> is a sequence of domain model &#8220;`Phone&#8220; that represents the phones available in the backend data store</p>
  </li>
</ul>

<p>The <code>Get</code> method in the <code>ManufacturersController</code> returns the manufacturer names for the given phones</p>

<p>The <code>ManufacturerViewModel</code> is just a DTO that is used to share the data across the wire.</p>

<p>The next step is to add the domain models. In the <code>Production</code> file of <em>Domain</em> project add the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">ManufacturerName</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="n">Samsung</span> <span class="o">|</span> <span class="n">Motorola</span> <span class="o">|</span> <span class="n">Dell</span> <span class="o">|</span> <span class="n">LG</span> <span class="o">|</span> <span class="n">TMobile</span> <span class="o">|</span> <span class="n">Sanyo</span> <span class="o">|</span> <span class="n">Unknown</span>
</span><span class="line">
</span><span class="line">  <span class="k">static</span> <span class="k">member</span> <span class="n">ToString</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Samsung</span> <span class="o">-&gt;</span> <span class="s">&quot;Samsung&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Motorola</span> <span class="o">-&gt;</span> <span class="s">&quot;Motorola&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Dell</span> <span class="o">-&gt;</span> <span class="s">&quot;Dell&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">LG</span> <span class="o">-&gt;</span> <span class="s">&quot;LG&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">TMobile</span> <span class="o">-&gt;</span> <span class="s">&quot;T-Mobile&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Sanyo</span> <span class="o">-&gt;</span> <span class="s">&quot;Sanyo&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Unknown</span> <span class="o">-&gt;</span> <span class="s">&quot;Unknown&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">static</span> <span class="k">member</span> <span class="n">ToManufacturerName</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="k">match</span> <span class="n">name</span><span class="o">.</span><span class="n">ToLower</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;samsung&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Samsung</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;motorola&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Motorola</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;dell&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Dell</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;lg&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">LG</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;t-mobile&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">TMobile</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;sanyo&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Sanyo</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;nexus&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Samsung</span>
</span><span class="line">      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">Unknown</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Phone</span> <span class="o">=</span>
</span><span class="line">  <span class="o">{</span> <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Description</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ImageUrl</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>As the backend data-store doesn’t directly gives the manufacturer name, we will be adding two <strong>static</strong> members that derives the manufacturer name from the phone name. The <code>ToString</code> function translates to the domain model to its equivalent string version</p>

<p>After defining the domain models, add the business logic for the getting the manufacturer names from the phone in the new source file <code>Phones</code> of the <em>Domain</em> project.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Phones</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getManufacturerNames</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">phones</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="nn">ManufacturerName</span><span class="p">.</span><span class="n">ToManufacturerName</span> <span class="n">p</span><span class="o">.</span><span class="n">Name</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>getManufacturerNames</code> is a straight forward function that map given the phones to its equivalent manufacture names.</p>

<p>The next step would be fetching the phones from the data-store. </p>

<p>Let’s start by defining a type provider for the phone. Update the <code>TypeProviders</code> module in the <em>DataAccess</em> project as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">samplePhoneJson</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class="line"><span class="s">{</span>
</span><span class="line"><span class="s">  &quot;additionalFeatures&quot;: &quot;Trackball&quot;, </span>
</span><span class="line"><span class="s">  &quot;android&quot;: {</span>
</span><span class="line"><span class="s">      &quot;os&quot;: &quot;Android 2.2&quot;, </span>
</span><span class="line"><span class="s">      &quot;ui&quot;: &quot;&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;availability&quot;: [</span>
</span><span class="line"><span class="s">      &quot;Sprint&quot;</span>
</span><span class="line"><span class="s">  ], </span>
</span><span class="line"><span class="s">  &quot;battery&quot;: {</span>
</span><span class="line"><span class="s">      &quot;standbyTime&quot;: &quot;&quot;, </span>
</span><span class="line"><span class="s">      &quot;talkTime&quot;: &quot;4 hours&quot;, </span>
</span><span class="line"><span class="s">      &quot;type&quot;: &quot;Lithium Ion (Li-Ion) (1130 mAH)&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;camera&quot;: {</span>
</span><span class="line"><span class="s">      &quot;features&quot;: [</span>
</span><span class="line"><span class="s">          &quot;Video&quot;</span>
</span><span class="line"><span class="s">      ], </span>
</span><span class="line"><span class="s">      &quot;primary&quot;: &quot;3.2 megapixels&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;connectivity&quot;: {</span>
</span><span class="line"><span class="s">      &quot;bluetooth&quot;: &quot;Bluetooth 2.1&quot;, </span>
</span><span class="line"><span class="s">      &quot;cell&quot;: &quot;CDMA2000 1xEV-DO Rev.A&quot;, </span>
</span><span class="line"><span class="s">      &quot;gps&quot;: true, </span>
</span><span class="line"><span class="s">      &quot;infrared&quot;: false, </span>
</span><span class="line"><span class="s">      &quot;wifi&quot;: &quot;802.11 b/g&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;description&quot;: &quot;Zio uses CDMA2000 1xEV-DO rev&quot;, </span>
</span><span class="line"><span class="s">  &quot;display&quot;: {</span>
</span><span class="line"><span class="s">      &quot;screenResolution&quot;: &quot;WVGA (800 x 480)&quot;, </span>
</span><span class="line"><span class="s">      &quot;screenSize&quot;: &quot;3.5 inches&quot;, </span>
</span><span class="line"><span class="s">      &quot;touchScreen&quot;: true</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;hardware&quot;: {</span>
</span><span class="line"><span class="s">      &quot;accelerometer&quot;: true, </span>
</span><span class="line"><span class="s">      &quot;audioJack&quot;: &quot;3.5mm&quot;, </span>
</span><span class="line"><span class="s">      &quot;cpu&quot;: &quot;600MHz Qualcomm MSM7627&quot;, </span>
</span><span class="line"><span class="s">      &quot;fmRadio&quot;: false, </span>
</span><span class="line"><span class="s">      &quot;physicalKeyboard&quot;: false, </span>
</span><span class="line"><span class="s">      &quot;usb&quot;: &quot;USB 2.0&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;id&quot;: &quot;sanyo-zio&quot;, </span>
</span><span class="line"><span class="s">  &quot;images&quot;: [</span>
</span><span class="line"><span class="s">      &quot;img/phones/sanyo-zio.0.jpg&quot;, </span>
</span><span class="line"><span class="s">      &quot;img/phones/sanyo-zio.1.jpg&quot;, </span>
</span><span class="line"><span class="s">      &quot;img/phones/sanyo-zio.2.jpg&quot;</span>
</span><span class="line"><span class="s">  ], </span>
</span><span class="line"><span class="s">  &quot;name&quot;: &quot;SANYO ZIO&quot;, </span>
</span><span class="line"><span class="s">  &quot;sizeAndWeight&quot;: {</span>
</span><span class="line"><span class="s">      &quot;dimensions&quot;: [</span>
</span><span class="line"><span class="s">          &quot;58.6 mm (w)&quot;, </span>
</span><span class="line"><span class="s">          &quot;116.0 mm (h)&quot;, </span>
</span><span class="line"><span class="s">          &quot;12.2 mm (d)&quot;</span>
</span><span class="line"><span class="s">      ], </span>
</span><span class="line"><span class="s">      &quot;weight&quot;: &quot;105.0 grams&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;storage&quot;: {</span>
</span><span class="line"><span class="s">      &quot;flash&quot;: &quot;130MB&quot;, </span>
</span><span class="line"><span class="s">      &quot;ram&quot;: &quot;256MB&quot;</span>
</span><span class="line"><span class="s">  }</span>
</span><span class="line"><span class="s">}</span>
</span><span class="line">
</span><span class="line"><span class="s">&quot;&quot;&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">PhoneTypeProvider</span> <span class="o">=</span> <span class="n">JsonProvider</span><span class="o">&lt;</span><span class="n">samplePhoneJson</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">ToPhone</span> <span class="o">(</span><span class="n">phone</span> <span class="o">:</span> <span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Id</span><span class="o">;</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span> <span class="n">Description</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Description</span><span class="o">;</span> <span class="n">ImageUrl</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Images</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Like <code>ToPhoneIndex</code> utility function,  <code>ToPhone</code> converts the data store model <code>PhoneTypeProvider.Root</code> to the domain model <code>Phone</code></p>

<p>Unlike the phone index, <a href="https://github.com/angular/angular-phonecat/tree/master/app/phones">angular-phonecat</a> repository stores the details of each phones in a seperate json file with the naming convention of <strong>{phoneId}.json</strong>. So, in order to get the details of all the phones, we need to fire multiple requests to get the details. Thanks to <a href="http://blogs.msdn.com/b/dsyme/archive/2010/01/09/async-and-parallel-design-patterns-in-f-parallelizing-cpu-and-i-o-computations.aspx">fsharp async workflow</a> we can easily pull all the data parallelly and populate the strongly typed domain models from them.</p>

<p>Update the <code>GitHubRepository</code> module with the code to populate the data from the data store.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">GitHubRepository</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">gitHubRepoUrl</span> <span class="o">=</span> <span class="s">&quot;https://raw.githubusercontent.com/angular/angular-phonecat/master/app/phones/&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">phoneIndexes</span> <span class="o">=</span> <span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Load</span><span class="o">(</span><span class="n">gitHubRepoUrl</span> <span class="o">+</span> <span class="s">&quot;phones.json&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">phoneIds</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">pMap</span> <span class="n">ids</span> <span class="o">=</span>
</span><span class="line">      <span class="n">seq</span> <span class="o">{</span><span class="k">for</span> <span class="n">id</span> <span class="k">in</span> <span class="n">ids</span> <span class="o">-&gt;</span> <span class="n">async</span> <span class="o">{</span> <span class="k">return</span> <span class="n">id</span><span class="o">,</span> <span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Load</span><span class="o">(</span><span class="n">gitHubRepoUrl</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">&quot;.json&quot;</span><span class="o">)</span> <span class="o">}}</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="n">Parallel</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="n">RunSynchronously</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">phones</span> <span class="o">=</span> <span class="n">pMap</span> <span class="n">phoneIds</span> <span class="o">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">ofSeq</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getPhoneIndexes</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">phoneIndexes</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getPhones</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Value</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Expressiveness is one of the reason behind my fsharp addiction. Just see the above code we have done some much thing with just few lines of code. We have fetched the details of all the phones using their ids from phone index and created an in-memory map.</p>

<p>The <code>getPhones</code> function returns the strongly typed <code>PhoneTypeProvider</code> models from the in-memory map.</p>

<p>The last thing is to wire up all the things and create the <code>ManufacturersController</code>. Update the <code>CompositionRoot</code> type in the <code>Infrastructure</code> module with the below code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;,</span>
</span><span class="line">    <span class="n">phoneIndexes</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">interface</span> <span class="n">IHttpControllerActivator</span> <span class="k">with</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">controllerDescriptor</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phoneIndexes</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhoneIndex</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PromotionsController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">promotionsController</span> <span class="o">=</span>
</span><span class="line">          <span class="k">new</span> <span class="n">PromotionsController</span><span class="o">(</span><span class="n">getPromotions</span><span class="o">,</span> <span class="n">phoneIndexes&#39;</span><span class="o">)</span>
</span><span class="line">        <span class="n">promotionsController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">
</span><span class="line">    <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">ManufacturersController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">manufacturersController</span> <span class="o">=</span>
</span><span class="line">          <span class="k">new</span> <span class="n">ManufacturersController</span><span class="o">(</span><span class="n">getManufacturerNames</span><span class="o">,</span> <span class="n">phones&#39;</span><span class="o">)</span>
</span><span class="line">        <span class="n">manufacturersController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">        <span class="n">raise</span> <span class="o">&lt;|</span> <span class="n">ArgumentException</span><span class="o">((</span><span class="n">sprintf</span> <span class="s">&quot;Unknown controller type requested: %A&quot;</span> <span class="n">controllerType</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And update the <em>Global.asax.fs</em> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">static</span> <span class="k">member</span> <span class="n">RegisterWebApi</span><span class="o">(</span><span class="n">config</span><span class="o">:</span> <span class="n">HttpConfiguration</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// existing configuration will be here</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Additional Web API settings</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phones</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhones</span><span class="bp">()</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phoneIndexes</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhoneIndexes</span><span class="bp">()</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">Services</span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="n">typeof</span><span class="o">&lt;</span><span class="n">IHttpControllerActivator</span><span class="o">&gt;,</span> <span class="n">CompositionRoot</span><span class="o">(</span><span class="n">phones</span><span class="o">,</span> <span class="n">phoneIndexes</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="top-selling-phones-api">Top Selling Phones Api</h3>

<p>Create <code>PhonesController</code> in the <em>Web</em> project and add the api to return the top selling phones</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">Web</span><span class="p">.</span><span class="n">Controllers</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/phones&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">PhonesController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">getTopSellingPhones</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;topselling&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetTopSelling</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="n">getTopSellingPhones</span> <span class="mi">3</span> <span class="n">phones</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>getTopSellingPhones</code> picks given count of phones from the given phones and return them.</p>

<p>In the <code>Phones</code> module of <em>Domain</em> project add the function <code>getTopSellingPhones</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">(</span><span class="n">phonesSold</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PhoneSold</span><span class="o">&gt;)</span> <span class="n">phoneCount</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="n">phonesSold</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Quantity</span><span class="o">,</span> <span class="o">(</span><span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p&#39;</span> <span class="o">-&gt;</span> <span class="n">p&#39;</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span><span class="o">)))</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">sortBy</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="o">-(</span><span class="n">fst</span> <span class="n">x</span><span class="o">))</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">take</span> <span class="n">phoneCount</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="n">snd</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>PhoneSold</code> domain model represents how much quantity of each phone has been sold. The <code>getTopSellingPhones</code> sorts the given phones in the descending order based on the quantity being sold and return the given count of the phones from the sorting result</p>

<p>Right now the <code>PhoneSold</code> domain model is not added. So add them in the new module <code>Purchases</code> in the <em>Domain</em> project as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Purchases</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">PhoneSold</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Quantity</span> <span class="o">:</span> <span class="n">int</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The angular data-store doesn’t provide quantity sold information, so we need to get it from somewhere else. To keep it simple, we are going add an <code>InMemoryInventory</code> in <em>DataAccess</em> project as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">InMemoryInventory</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">getPhonesSold</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">[</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;motorola-xoom-with-wi-fi&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">10</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;motorola-atrix-4g&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">24</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;nexus-s&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">4</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;samsung-galaxy-tab&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">41</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;sanyo-zio&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">31</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;motorola-xoom&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">6</span><span class="o">}</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As previous api’s we need wire things up and create the controller in the <code>CompositeRoot</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"> <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhonesController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getTopSellingPhones</span> <span class="o">(</span><span class="nn">InMemoryInventory</span><span class="p">.</span><span class="n">getPhonesSold</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phonesController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhonesController</span><span class="o">(</span><span class="n">getTopSellingPhones</span><span class="o">,</span> <span class="n">phones&#39;</span><span class="o">)</span>
</span><span class="line">  <span class="n">phonesController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have used <a href="http://fsharpforfunandprofit.com/posts/partial-application/">partial application</a> of the <code>Phones.getTopSellingPhones</code> function here. Its signature is <code>seq&lt;PhoneSold&gt; -&gt; int -&gt; seq&lt;Phone&gt; -&gt; seq&lt;Phone&gt;</code><br />
but the controller expects the function with the signature <code>int -&gt; seq&lt;Phone&gt; -&gt; seq&lt;Phone&gt;</code>.</p>

<p>The expression</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getTopSellingPhones</span> <span class="o">(</span><span class="nn">InMemoryInventory</span><span class="p">.</span><span class="n">getPhonesSold</span><span class="bp">()</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>actually does this.</p>

<h3 id="front-end">Front-End</h3>

<p>As front-end is out of the scope of this blog post I am not covering it here. I’ve actually developed it using knockout.js.</p>

<h2 id="summary">Summary</h2>

<p>We have covered a quite a large ground here by creating three web-api endpoints in fsharp using Web Api 2. In the later posts we will be adding error handling and making it robust. The source code for this step can be found in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/1">github repository</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step 0 - Setting up the fsharp-phonecat Solution]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2014/12/10/step-0-setting-up-the-fsharp-phonecat-solution/"/>
    <updated>2014-12-10T22:15:50+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2014/12/10/step-0-setting-up-the-fsharp-phonecat-solution</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 0 of my blog series on <a href="http://www.p3programmer.com/blog/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In this blog post, we are going to set up the visual studio solution and create the high level project structure for the <em>fsharp-phonecat</em> application. </p>

<p><strong>Let’s get started!</strong></p>

<h4 id="setting-up-visual-studio-solution">Setting Up Visual Studio Solution</h4>

<p>The first step is to create an blank visual studio solution and name it as <strong>PhoneCat</strong></p>

<p><img class="center" src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_0/BlankSolution.png" width="700" height="700" /></p>

<p>After creating the blank solution create two fsharp class libraries and name it as <strong>Domain</strong> and <strong>DataAccess</strong> respectively.</p>

<p><img class="center" src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_0/ClassLibrary.png" width="700" height="700" /></p>

<p>Do delete the sample fsharp files Domain1.fs, DataAccess1.fs and Script.fsx that are created by default while creating the class libraries</p>

<p>Then create a ASP.NET MVC web project using <a href="https://visualstudiogallery.msdn.microsoft.com/39ae8dec-d11a-4ac9-974e-be0fdadec71b">F# MVC 5 template</a> and name it as <em>Web</em></p>

<p><img class="center" src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_0/WebProject.png" width="700" height="700" /></p>

<p><img class="center" src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_0/MVC5.png" /></p>

<p>We are going to use TDD, so create test projects for each of the above projects created and name it as <strong>Domain.Tests</strong>, <strong>DataAccess.Tests</strong> and <strong>Web.Tests</strong> respectively.</p>

<p>The final project structure would look like</p>

<p><img class="center" src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_0/ProjectStructure.png" /></p>

<p>F# MVC 5 template comes with a default Bootstrap theme and we are going to extend it by using e-commerce theme from <a href="http://startbootstrap.com/template-overviews/shop-homepage/">Start Bootstrap</a>. Download the theme and add <em>shop-homepage.css</em> to the Content directory of <strong>Web</strong> project. After adding it update <em>Global.asax.fs</em> to include this css file while bundling.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>BundleConfig after adding shop-homepage.css</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">BundleConfig</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">static</span> <span class="k">member</span> <span class="n">RegisterBundles</span> <span class="o">(</span><span class="n">bundles</span><span class="o">:</span><span class="n">BundleCollection</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">        <span class="n">bundles</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">ScriptBundle</span><span class="o">(</span><span class="s">&quot;~/bundles/jquery&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="n">Include</span><span class="o">([|</span><span class="s">&quot;~/Scripts/jquery-{version}.js&quot;</span><span class="o">|]))</span>
</span><span class="line">
</span><span class="line">        <span class="n">bundles</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">ScriptBundle</span><span class="o">(</span><span class="s">&quot;~/bundles/modernizr&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="n">Include</span><span class="o">([|</span><span class="s">&quot;~/Scripts/modernizr-*&quot;</span><span class="o">|]))</span>
</span><span class="line">
</span><span class="line">        <span class="n">bundles</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">ScriptBundle</span><span class="o">(</span><span class="s">&quot;~/bundles/bootstrap&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="n">Include</span><span class="o">(</span><span class="s">&quot;~/Scripts/bootstrap.js&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;~/Scripts/respond.js&quot;</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">        <span class="n">bundles</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">StyleBundle</span><span class="o">(</span><span class="s">&quot;~/Content/css&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="n">Include</span><span class="o">(</span><span class="s">&quot;~/Content/bootstrap.css&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;~/Content/site.css&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;~/Content/shop-homepage.css&quot;</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now the stage is set for awesomeness. Update <strong>_Layout.cshtml</strong> and <strong>Index.cshtml</strong> as mentioned in the bootstrap theme and run the web project.</p>

<p><img class="center" src="http://www.p3programmer.com/blog/images/fsharp_phonecat/step_0/HomePage.png" width="800" height="800" /></p>

<p>You can checkout the code <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/0">here</a>. In the <a href="http://www.p3programmer.com/blog/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">next-post</a> we will be wiring up the backend. Stay tuned !</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Web Application Development in Fsharp using ASP.NET MVC]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/"/>
    <updated>2014-12-10T17:07:48+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc</id>
    <content type="html"><![CDATA[<h3 id="introduction">Introduction</h3>

<p>Fsharp is my new favorite language in recent times and I’ve been learning it for the last six months. I always believe the best way to learn a language / technology / framework is to create something using it and also learning from the mistakes while creating it. So, here is my attempt to create a sample web application in fsharp using ASP.NET MVC framework. In this series of blog posts I’m going to share my experience on creating “phone-cat” web application inspired from the <a href="https://github.com/angular/angular-phonecat">angular-phonecat</a>. </p>

<p>As it is my maiden attempt to create a relatively large web application in fsharp, if you find something that can be improved, feel free to share <em>I’m willing to learn from you.</em></p>

<h3 id="blog-series-links">Blog Series Links</h3>

<ul>
  <li><strong>Step 0</strong> - <a href="http://www.p3programmer.com/blog/blog/2014/12/10/step-0-setting-up-the-fsharp-phonecat-solution/">Setting up the fsharp-phonecat Solution</a></li>
  <li><strong>Step 1</strong> - <a href="http://www.p3programmer.com/blog/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">Creating Web Api endpoints for fsharp-phonecat using Web Api 2</a></li>
  <li><strong>Step 2</strong> - <a href="http://www.p3programmer.com/blog/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">Creating ASP.NET MVC Razor Views for fsharp-phonecat</a></li>
  <li><strong>Step 3</strong> - <a href="http://www.p3programmer.com/blog/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/">PhoneCat Recommendation System using F# Agents, SignalR and Rx</a></li>
  <li><strong>Step 4</strong> - <a href="http://www.p3programmer.com/blog/blog/2015/01/06/step-4-build-automation-using-fake/">Build Automation using Fake</a></li>
  <li><strong>Step 5</strong> - <a href="http://www.p3programmer.com/blog/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec/">Advanced Search DSL using FSParsec</a></li>
  <li><strong>Step 6</strong> - <a href="http://www.p3programmer.com/blog/blog/2015/02/04/step-6-authentication-using-owin-middleware-and-asp-dot-net-identity/">Authentication using Owin and Asp.Net Identity</a></li>
</ul>

<h4 id="upcoming-posts">Upcoming Posts</h4>

<ul>
  <li>Event Sourcing using EventStore</li>
  <li>Data Access Layer using No-Sql</li>
  <li>Integration testing using TickSpec and canopy</li>
  <li>Documentation generation using FSharp.Formatting</li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Verbs - Buried abstraction in OO World]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2014/09/26/verbs-buried-abstraction-in-oo-world/"/>
    <updated>2014-09-26T12:44:00+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2014/09/26/verbs-buried-abstraction-in-oo-world</id>
    <content type="html"><![CDATA[<p>In Object Oriented Programming, the problem domain is being modeled as objects(nouns) which collaborate with one another in the form of messages(verbs). We are actually creating abstractions and through which we are solving the problems in an organized and cleaner way. But this way of creating abstractions does not scale in all the scenarios.</p>

<p>Let me share it through an example </p>

<p>Lets rewind the time machine to travel back to 2006 (.NET 2.0) which doesn’t have <code>LINQ</code> support. You are asked to solve the following problem statement</p>

<blockquote>
  <p>You are working on a Student Management Application. Each student is having a name and an age. You are asked to create module to sort the Students based on their name</p>
</blockquote>

<div><script src="https://gist.github.com/4fd1f5ea2b4e28658e81.js?file=Student.cs"></script>
<noscript><pre><code>public class Student
{
  public int Age { get; set; }
  public string Name { get; set; }
}</code></pre></noscript></div>

<p>To sort based on Name we need to write a comparer which compares two student names and return some integer</p>

<div><script src="https://gist.github.com/4fd1f5ea2b4e28658e81.js?file=StudentNameComparer.cs"></script>
<noscript><pre><code>public class StudentNameComparer : IComparer&lt;Student&gt;
{
  public int Compare(Student x, Student y)
  {
    return string.Compare(x.Name, y.Name, StringComparison.CurrentCulture);
  }
}</code></pre></noscript></div>

<p>Then in the main program we will be doing the sorting using <code>Array.Sort</code> method</p>

<div><script src="https://gist.github.com/4fd1f5ea2b4e28658e81.js?file=Program.cs"></script>
<noscript><pre><code>class Program
{
  static void Main(string[] args)
  {
    List&lt;Student&gt; students = new List&lt;Student&gt;();

    // Populate Students List here	

    Student[] studentsSortedByName = students.ToArray();       

    Array.Sort(studentsSortedByName, new StudentNameComparer());
  }
}</code></pre></noscript></div>

<p>Hmmm. You might think what is a big deal in it ? But there is! Let me complicate the scenario by adding a new requirement</p>

<blockquote>
  <p>You also asked to do sorting based on Age!</p>
</blockquote>

<p>How do you do it ?</p>

<p>Well! Just create yet another Comparer which compares the age</p>

<div><script src="https://gist.github.com/4fd1f5ea2b4e28658e81.js?file=StudentAgeComparer.cs"></script>
<noscript><pre><code>public class StudentAgeComparer : IComparer&lt;Student&gt;
{
  public int Compare(Student x, Student y)
  {
    if (x.Age == y.Age)
    {
      return 0;
    }
    if (x.Age &lt; y.Age)
    {
      return -1;
    }
      return 1;
  }
}</code></pre></noscript></div>

<div><script src="https://gist.github.com/4fd1f5ea2b4e28658e81.js?file=Program1.cs"></script>
<noscript><pre><code>class Program1
{
  static void Main(string[] args)
  {
    List&lt;Student&gt; students = new List&lt;Student&gt;();
	
    // Populate Students List here	

    Student[] studentsSortedByAge = students.ToArray();       

    Array.Sort(studentsSortedByAge, new StudentAgeComparer());
  }
}</code></pre></noscript></div>

<p>So much of code to do the trivial thing, isn’t it ?</p>

<p>Let us dig deep to figure out what is wrong here. First let us start with the comparers <code>StudentAgeComparer</code> and <code>StudentNameComparer</code>. These comparers (nouns) actually escorting the method <code>Compare</code> (verb) and not doing anything productive apart from this. In OO world a verb should always be associated with a noun and because of this way of abstraction, we are adding an unnecessary complexity to the code. </p>

<p>Just think of yet another scenario where want to sort the student by rank, customer by name, product by name. We need to write so much comparers!</p>

<h3 id="verbs-to-the-rescue">Verbs to the rescue</h3>

<p>Let us see the student sorting scenario from a different perspective. In this new pair of (functional)eyes we see the same scenario as</p>

<ul>
  <li><strong>Order</strong> <em>Student</em> by <strong>Name</strong>  </li>
  <li><strong>Order</strong> <em>Student</em> by <strong>Age</strong>  </li>
  <li><strong>Order</strong> <em>Customer</em> by <strong>Name</strong>  </li>
  <li><strong>Order</strong> <em>Product</em> by <strong>Name</strong>  </li>
</ul>

<p>i.e the verb <strong>Order</strong> is common across all the scenario. </p>

<p>The only thing which is changing is <em>what we are ordering</em> and <em>by which property</em>. Let us model things based on this verb abstraction.</p>

<p>PseudoCode</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class=""><span class="line">OrderBy&lt;Student&gt;(s -&gt; s.Name)
</span><span class="line">OrderBy&lt;Student&gt;(s -&gt; s.Age)
</span><span class="line">OrderBy&lt;Customer&gt;(c -&gt; c.Name)
</span><span class="line">OrderBy&lt;Product&gt;(p -&gt; p.Name)</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here OrderBy is a function which models the verb (Order). Two things to note</p>

<ul>
  <li>OrderBy is generic and it can act on any types of objects (Student, Customer, Product,…)</li>
  <li>OrderBy doesn’t know which property to choose so, we need to tell explicitly.</li>
</ul>

<p>So, what we gained because of this ?</p>

<p>Let us go back to the initial requirement</p>

<blockquote>
  <p>You are working on a Student Management Application. Each student is having a name and an age. You are asked to create module to sort the Students based on their name and age</p>
</blockquote>

<p>Now change the time machine to land in 2014. We have <code>LINQ</code> support in <code>C#</code> now which supports verbs (functions) as first class citizens</p>

<div><script src="https://gist.github.com/4fd1f5ea2b4e28658e81.js?file=Program2.cs"></script>
<noscript><pre><code>class Program2
{
  static void Main(string[] args)
  {
    List&lt;Student&gt; students = new List&lt;Student&gt;();

    // Populate Students List here	

    var studentsSortedByName = Enumerable.OrderBy(students, s =&gt; s.Name);
    var studentsSortedByAge = Enumerable.OrderBy(students, s =&gt; s.Age);
  }
}</code></pre></noscript></div>

<p>Just two lines instead of two comparers. All we did is just changed the way we create abstractions. Let me explain it using some visuals.</p>

<p><img class="center" src="http://www.p3programmer.com/blog/images/VerbsInOoWorld/Students_Sorted_By_Name.png" title="" /></p>

<p>OrderBy is an abstraction which does only one thing, that is order the objects in an ascending order and does it to the perfection. But to use this abstraction we need to provide two inputs, the objects and a function which provides the propery by which the objects to be sorted </p>

<p>Does it closely resemble what we have seen earlier in the pseudocode ? Since it is generic, we can also use it for all other objects (Product, Customer, etc.,) too !</p>

<p><img class="center" src="http://www.p3programmer.com/blog/images/VerbsInOoWorld/Students_Sorted_By_Age.png" title="" /></p>

<h4 id="summary">Summary</h4>

<p>Verbs(functions) are not silver bullets and they are not the replacement of Nouns(objects). But by choosing our abstraction wisely we can achieve great things with lesser lines of code and in turn release the code with lesser bugs <i class="emoji smile"></i> </p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[If your fsharp code compiles it usually works]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2013/08/08/if-your-fsharp-code-compiles-it-usually-works/"/>
    <updated>2013-08-08T11:39:00+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2013/08/08/if-your-fsharp-code-compiles-it-usually-works</id>
    <content type="html"><![CDATA[<div class="post">

  <p>
    When I first started learning fsharp, one of the astounding fact that hit my mind was <em>&#8220;If the code compiles it usually works!&#8221;</em> For a guy who is coming from c# and java Programming background it was bit weird! After delving deep into f# I have found it very useful and inspired by its awesomeness. In this blog-post I&#8217;ll be covering some of my experiences that I come across while learning this great feature!  
  </p>

  <h3>Fever Diagnosis Program</h3>
  <p>
    Let us consider a simple fever diagnosis program. If your temperature is greater than 37.5 Celsius or 99.0 Fahrenheit then you are suffering from fever else you are all right.  
  </p>

  <h3>Defining Temperature Types</h3>
  <p>One of the cool feature that I like about f# is its less verbosity. You can do lot of magic things with less lines of code! Consider our fever diagnosis program, A temperature can be either in Celsius or in Fahrenheit. Here is the equivalent type defined in f#</p>

    <div><script src='https://gist.github.com/268f405f64ce99b19548.js?file=Temperature.fs'></script>
<noscript><pre><code>type Temperature = 
  | Celsius of double
  | Fahrenheit of double</code></pre></noscript></div>


  <p>Just 3 lines of code!</p>
  <p>The type Temperature has been defined as a <a href="http://en.wikibooks.org/wiki/F_Sharp_Programming/Discriminated_Unions">discriminated union.</a> In brief, Discriminated union represent data that can take on one of a few different types of results.</p> <p>Also in this 3 lines we have described the strongly typed alias for temperature in both Celsius and in Fahrenheit. With this code in place if you want to describe a temperature in Celsius or in Fahrenheit all you need to use the following syntax</p>

    <div><script src='https://gist.github.com/268f405f64ce99b19548.js?file=Declaration.fs'></script>
<noscript><pre><code>let tempInCelsius = Celsius 10.8
let tempInFahernheit = Fahrenheit 10.6</code></pre></noscript></div>


  <p>By defining strongly typed cases like this we can make our code cleaner and preventing ourselves from various logic errors that we usually do when we interpret the values of these types. Though we can achieve the same in c# by the following code, it is very elegant to do in f# </p>

    <div><script src='https://gist.github.com/268f405f64ce99b19548.js?file=Temperature.cs'></script>
<noscript><pre><code>public abstract class Temperature 
{
  public double Value { get; private set; }

  protected Temperature(double value) 
  {
    Value = value;
  }
}

public class Celsius : Temperature
{
  public Celsius (double value) : base(value)
  {

  }
}

public class Fahrenheit : Temperature
{
  public Fahrenheit (double value) : base(value)
  {
    
  }
} 

public class Program 
{
  public static void Main() 
  {
    Temperature tempInCelsius = new Celsius(10.8);
    Temperature tempInFahernheit = new Fahrenheit(10.6);
  }  
}</code></pre></noscript></div>


<p>34 lines of code to achieve the same!!</p>

<h3>Let&#8217;s diagnosis fever</h3>
<p>With the types for the two representation of temperature in place, our next step is to check the values and find out whether the concerned person is having fever or not. You can do this in f# by using <a href="http://en.wikibooks.org/wiki/F_Sharp_Programming/Pattern_Matching_Basics">pattern matching</a></p>
<div><script src='https://gist.github.com/268f405f64ce99b19548.js?file=HasFever.fs'></script>
<noscript><pre><code>let hasFever temperature =
  match temperature with 
  | Celsius value -&gt; (value &gt; 37.5)
  | Fahrenheit value -&gt; (value &gt; 99.0)</code></pre></noscript></div>


<p>f# automatically takes care of decomposing our data into appropriate data structure and all we need to concentrate on our business logic. For a beginner the syntax might look intimidating at first sight but if we use it quite some time you will fell in love with f#</p> 

<h4>How can I call this function?</h4>
<div><script src='https://gist.github.com/268f405f64ce99b19548.js?file=CallingHasFever.fs'></script>
<noscript><pre><code>hasFever (Celsius 10.5)
hasFever (Fahrenheit 22.5)</code></pre></noscript></div>


<p>Based on the type we are passing in the hasFever function, the corresponding pattern will be matched then the value is decomposed and verified with their respective numbers. Code is prettier, isn&#8217;t it ?</p>

<h3>What&#8217;s the big deal in it?</h3>
<p>You might think apart from reducing the lines of code what else f# adds ?. Great! I was exactly like you when I first come across it. Later I&#8217;ve found out it how it can help us to save some hairs ;-) </p>

<p>Let us assume that we forget to handle Fahrenheit in hasFever function</p>
    <div><script src='https://gist.github.com/268f405f64ce99b19548.js?file=CompilerError.fs'></script>
<noscript><pre><code>let hasFever temperature =
  match temperature with 
  | Celsius value -&gt; (value &gt; 37.5)</code></pre></noscript></div>

<p>Typically in C# if we missed to handle one of the cases like this we won&#8217;t be getting any compiler error and It&#8217;d crash the application in the runtime. But in f#, the above code would result in following compiler error</p>
<pre>warning FS0025: Incomplete pattern matches on this expression, For example, the value 'Fahrenheit (_)' may indicate a case not covered by the pattern(s)</pre>
<p>So, if you make any logical error like this is your f# code, compiler will show compile time errors and prevents you from building buggy code!</p>

<h3>Summary</h3>
<p>If you follow the idioms of f#, it will let you write a better code and even if do some logical error the compiler will come as a rescue!. You can check the source code live in <a href="http://www.tryfsharp.org/create/tamizhvendan/fever_diagnosis.fsx">tryfsharp</a> </p>
</div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A hybrid application using ASP.NET MVC3 and Node.js]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2012/06/01/hybrid-application-using-aspnet-mvc3/"/>
    <updated>2012-06-01T00:00:00+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2012/06/01/hybrid-application-using-aspnet-mvc3</id>
    <content type="html"><![CDATA[<div class='post'>
    <div>
        Each and every technology has its pros and cons and there is
        <a href="http://people.eecs.ku.edu/~saiedian/Teaching/Sp08/816/Papers/Background-Papers/no-silver-bullet.pdf">no silver bullet!</a><br />

        <br />If you would ask me what you have learnt in your profession so far, I would say the above line as the first one. One technology / platform / language is good at
        solving one kind of problems and bad at solving other kind of problems. The key is leveraging existing <em>platforms</em> with <em>languages</em> targeted at
        specific problems and applications to solve the business problems in hand.<br /><br />Three months ago I
        have come across <a href="http://www.infoq.com/presentations/10-Ways-to-Better-Code-Neal-Ford">an excellent presentation</a> from Neil Ford “10 ways to improve your
        code”. As a 8th way he talks about “Polyglot Programming”. Its about picking the right tool to do the right job. I am inspired by this presentation and started
        exploring the “right tools”.<br /><br />In the pursuit of “Right tools”, I’ve come across the young awesome framework <a href="http://nodejs.org/">node.js</a> which is
        really cool and perfect for real-time applications. On the other hand frameworks like <a href="http://www.asp.net/mvc">ASP.NET MVC3</a> is not meant for creating real-time
        applications and they address different set of other problems. <br /><br />In this blog post, I going to share my recent exploration on leveraging node.js in an
        ASP.NET MVC3 application using a “Chat” feature. Though we can achieve it using <a href="http://signalr.net/">SignalR</a>, I’ve preferred node.js as it is a right tool
        for the chat feature IMO also I wanted to get my hands dirty in creating a hybrid application.<br /><strong><br /></strong><br /><strong>The Node.js Part</strong>
        <br /><br /><a href="http://lh5.ggpht.com/-HLh-ldizDJ0/T8kHC3Ao5_I/AAAAAAAAAZA/vI0DypFIKh8/s1600-h/image%25255B4%25255D.png">
                        <img src="http://lh6.ggpht.com/-rcbRWOlpeBc/T8kHHp32UJI/AAAAAAAAAZI/ypOCgUHMrN0/image_thumb%25255B2%25255D.png?imgmax=800" style="background-image: none; border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="589" />
                    </a><br /><br />The chat server that we are going to use in the MVC3 application has been created using <a href="http://socket.io/">socket.io</a> which makes web-socket programming insanely easy!<br />Its listen for three events<br /><ul><li><em>join</em> – It will be triggered when a new user joined the chat and it broadcast the user name to all the connected users  </li><li><em>message</em> – It willed be triggered when an user send a message in the chat application and broadcast it to the other users  </li><li><em>disconnect</em>– It willed be triggered when an user closes the chat or closes the browser </li></ul>That’s it bang!<br /><strong><br /></strong><br /><strong>The ASP.NET MVC3 side</strong><br /><br /><a href="http://lh6.ggpht.com/-pQEJCXkjOuw/T8kHJFR0zVI/AAAAAAAAAZQ/FTqswQ8XvtY/s1600-h/image%25255B9%25255D.png"><img alt="image" border="0" height="197" src="http://lh6.ggpht.com/-TMmsX9z4rRc/T8kHLTRTuYI/AAAAAAAAAZY/MQurv3YzYIw/image_thumb%25255B5%25255D.png?imgmax=800" style="background-image: none; border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="387" /></a><br /><br />The controller side of Chat just renders the “Index view”. The index view has the following javascript code, and it completes the client side part of the chat application<br /><br /><a href="http://lh5.ggpht.com/-QnLwJvxMIR8/T8kHMoTx1qI/AAAAAAAAAZg/VYhVayPULm4/s1600-h/image%25255B14%25255D.png"><img alt="image" border="0" height="403" src="http://lh5.ggpht.com/-XxmqzAqX1i8/T8kHQ1J07tI/AAAAAAAAAZo/sMw8RevtD9k/image_thumb%25255B8%25255D.png?imgmax=800" style="background-image: none; border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="image" width="530" /></a><br /><strong><br /></strong><br />
        <strong>Chat feature in Action</strong><br /><br />
        <a href="http://lh3.ggpht.com/-OoM7_UDFHzQ/T8kHSZP8R8I/AAAAAAAAAZw/QcXNptcqe1I/s1600-h/image%25255B17%25255D.png">
            <img src="http://lh5.ggpht.com/-B4IkFTFavZI/T8kHVZP234I/AAAAAAAAAZ4/IGC3r-10yBA/image_thumb%25255B9%25255D.png?imgmax=800" />
        </a><br />
        <a href="http://lh3.ggpht.com/-xWwrw06nVTk/T8kHW9r2X1I/AAAAAAAAAaA/-g8XAZDm-Qg/s1600-h/image%25255B21%25255D.png">
                <img src="http://lh3.ggpht.com/-F7UPYcQXT14/T8kHZfq0W8I/AAAAAAAAAaI/hLP9g4s8QGA/image_thumb%25255B11%25255D.png?imgmax=800" />
        </a><br />
        <a href="http://lh6.ggpht.com/-OI01pFQYBEs/T8kHaT3_bmI/AAAAAAAAAaQ/GM-QdsQzTVU/s1600-h/image%25255B25%25255D.png">
            <img src="http://lh4.ggpht.com/-VIPYKbYG-rs/T8kHbgnYkBI/AAAAAAAAAaY/24TJhDEHqA8/image_thumb%25255B13%25255D.png?imgmax=800" />
        </a><br />
        <a href="http://lh6.ggpht.com/-_jFs2OzmBx0/T8kHczZpZBI/AAAAAAAAAag/-FMnxb_cD9w/s1600-h/image%25255B29%25255D.png">
            <img alt="image" src="http://lh4.ggpht.com/-KwvpW47kGxI/T8kHeUKp3BI/AAAAAAAAAao/GP4naqkNkvc/image_thumb%25255B15%25255D.png?imgmax=800" />
        </a><br />
        <a href="http://lh4.ggpht.com/-YNLo_UVoZf0/T8kHfwe76BI/AAAAAAAAAaw/dq8JfcSfYRE/s1600-h/image%25255B33%25255D.png">
            <img alt="image" src="http://lh3.ggpht.com/-tcpQUHyW58I/T8kHhrerqxI/AAAAAAAAAa4/ZEJOJK8swnk/image_thumb%25255B17%25255D.png?imgmax=800" />
        </a><br />
        <a href="http://lh6.ggpht.com/-j4AUmiQEA5k/T8kHioICVWI/AAAAAAAAAbA/ZAuJNXh4oZ4/s1600-h/image%25255B37%25255D.png">
            <img src="http://lh3.ggpht.com/-KoM6ka9qFxc/T8kHkUP0AGI/AAAAAAAAAbI/ZuGQ-d8KKS8/image_thumb%25255B19%25255D.png?imgmax=800" />
        </a></div><strong><br /></strong><br /><strong>Summary</strong><br /><br />The objective behind this blog post is just to share the knowledge that I’ve gained in my recent exploration and its just a proof of concept of how to leverage node.js in an MVC3 application. The bottom-line is “Identify and pick the right tool to do the right job”. If you want to play with the source code, don’t forget to clone <a href="https://github.com/tamizhvendan/a-hybrid-app">the repository </a>
    </div>
</div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jade Visualizer using Node.js and Socket.io]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2012/05/19/jade-visualizer-using-nodejs-and/"/>
    <updated>2012-05-19T00:00:00+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2012/05/19/jade-visualizer-using-nodejs-and</id>
    <content type="html"><![CDATA[<div class='post'>
    <p><strong>Hurrah! Finally I made it</strong></p> <blockquote> 
    <p><em>“None of my inventions came by accident. I see a worthwhile need to be met and I make trial after trial until it comes. 
        What it boils down to is one per cent inspiration and ninety-nine per cent perspiration”&nbsp; - Thomas Alva Edison</em></p></blockquote> 
    <p>Today I’m very glad and excited to announce my little contribution to the open source community called 
    <a href="http://jade-visualizer.herokuapp.com/">“Jade-Visualizer”</a> a web-based visualizer/translator which targets the beginners 
    of <a href="http://jade-lang.com/">Jade</a> (A widely used <a href="http://nodejs.org">Node.js</a> view engine) to learn it effectively. </p> 
    <p>Its the inspiration from good bloggers, kindled me to <a href="http://www.p3programmer.com/blog/blog/2011/01/05/thank-god/">start writing</a> blogs and Its the inspiration from many people who are all contributing to the open source community, encouraged me to kick start my contribution through this tiny web-app. This is my first step towards a great journey of more than 1000 miles and I hope it would lay a firm foundation.</p> <p><strong>What is Jade?</strong></p> <p><a href="https://github.com/visionmedia/jade#readme">Jade</a> is a high performance template engine for Node.js and the default rendering engine for the <a href="http://expressjs.com/">express</a> framework. If you are from the ASP.NET MVC background (like me), its similar to <a href="http://www.asp.net/mvc/videos/mvc-3/mvc-3-razor-view-engine">Razor</a> view engine. Unlike razor, Jade is less verbose and easier to read.</p> <p><strong>Why Jade-Visualizer ?</strong></p> <p><a href="http://www.w3schools.com/">W3schools</a> is my starting point and reference when it comes to basics of web development. I have learned and toyed with JavaScript, html, css in my early days using the “<a href="http://www.w3schools.com/css/tryit.asp?filename=trycss_default">Try it yourself</a>” feature available in their website. It is very intuitive to use and we can learn effectively by actually getting our hands dirty. Also, the immediate output of what we do would certainly help us (helped me!) to understand things much better.</p> <p>I am a kind of “Show me the code” programmer, would love to play with code rather than learning by just theory. When I am learning Jade, I found it very interesting as I never exposed to <a href="http://haml-lang.com">haml</a> kind of syntax. To learn it, I’ve created a sample web-page in node.js and for each feature in Jade, I’ve modified the jade page and understand its behaviour by seeing the html source in the browser.</p> <p>One day after toying with Jade for quite some time, I’ve went to bed and it strikes. <em>“How nice it would be to have a “Try it yourself” kind of feature for learning jade ?”</em>&nbsp; and hence <a href="http://jade-visualizer.herokuapp.com/">Jade-Visualizer</a></p> <p><strong>How to use Jade-Visualizer ?</strong></p> <p>Jade-Visaulizer is a single-page app, with only three parts. </p> <blockquote> <p>1. The Jade Template – A textarea to play with the jade-template</p> <p><a href="http://lh3.ggpht.com/-v_4K4nC5X8g/T7akj2dl48I/AAAAAAAAAYA/9IwuGzv5CxA/s1600-h/image%25255B3%25255D.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/-tX9_bKdkoCM/T7akk6bPFmI/AAAAAAAAAYI/jxhVxCnRcvk/image_thumb%25255B1%25255D.png?imgmax=800" width="352" height="133"></a></p></blockquote> <blockquote> <p>2. Data – Want to mix some data with the jade template ? It is for you. Enter some hacky data in JSON format in it and start toying!</p> <p><a href="http://lh5.ggpht.com/-cpsUeVldirk/T7akmeaR3EI/AAAAAAAAAYQ/xnpFbbSatxg/s1600-h/image%25255B7%25255D.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/-lq2NOBAmynI/T7aknqHcIxI/AAAAAAAAAYY/_7wiHbu2XPw/image_thumb%25255B3%25255D.png?imgmax=800" width="313" height="122"></a></p> <p>3. Output – Excited about what would be the generated output ? This part will help you to feed your brain.</p> <p align="center"><a href="http://lh6.ggpht.com/-CkroM0OM1II/T7ako3S4kTI/AAAAAAAAAYc/aNGmF8Ce0Cg/s1600-h/image%25255B11%25255D.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/-FzPHwu-tPxc/T7akpxtOanI/AAAAAAAAAYo/lRg032qDWgA/image_thumb%25255B5%25255D.png?imgmax=800" width="342" height="96"></a></p> <p align="center">Don’t forget to click the “Translate” button to view the html <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="http://lh4.ggpht.com/-t_I-2AzWiW8/T7akq4S6BXI/AAAAAAAAAYw/msikTfLIqoY/wlEmoticon-smile%25255B2%25255D.png?imgmax=800"></p></blockquote> <p align="left"><strong>Behind the Scene</strong></p> <p align="left">Curious about what are all the things behind this app ? Here is the list</p> <ul> <li> <div align="left"><a href="http://nodejs.org">Node.js</a> - My new toy in programming</div> <li> <div align="left"><a href="http://socket.io/">Socket.Io</a></div> <li> <div align="left"><a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a></div> <li> <div align="left"><a href="http://codemirror.net/">CodeMirror</a> and <a href="http://google-code-prettify.googlecode.com/svn/trunk/README.html">Prettify</a></div> <li> <div align="left"><a href="https://github.com/tamizhvendan/jade-visualizer">Github</a></div> <li> <div align="left"><a href="http://www.heroku.com/">Heroku</a></div></li></ul> <p><strong>Why Node.js ?</strong></p> <p>There are lot of fuss about Node.js in the industry. Will it scale ? Is it insanely fast ? JavaScript on server side ? Will it work out?. I am not going to answer for these questions and I am not a expert too! I believe a <a href="http://lmgtfy.com/?q=nodejs">simple google search</a> will help you much much better than me. Then why this section in this blog post ? Let me explain</p> <p>I would like to add an another flavour to Node.js by putting my words on <em>why you should learn Node.js </em>especially if you are from a .net background like me</p> <ul> <li><em>I’m using </em><a href="http://www.ubuntu.com"><em>Ubuntu</em></a><em> to play with node.js –</em> Node has helped me to come out from windows and inspired me to work with Linux for the first time in my life  <li><em>I’m using </em><a href="http://www.vim.org/"><em>Vim</em></a><em> to write node.js apps – </em>Awesome editor! I am regretting myself for not using this so far. Its my default editor even in windows now&nbsp; <li><em>I’m using </em><a href="https://github.com"><em>Github</em></a><em> as a version control</em> to store <a href="https://github.com/tamizhvendan/NodeJsKatas">my nodejs katas</a>  <li><em>I’ve full control over my apps in node.js – </em>Its helping me to learn some of the under the hood stuff which I never learnt before. <a href="https://github.com/tamizhvendan/jade-visualizer">Source code of Jade-Visualizer</a> is an excellent example for this. I am using my own module to serve the static files. Yes, I’m re-inventing the wheel. But I am learning, That’s good for myself!  <li><em>I’m a part of </em><a href="http://nodejs.org/community/"><em>vibrant community</em></a> – I’m having a sense of belonging feeling  <li><em>I’m getting better at javascript</em> – I love this tricky language and its really twisting my programming brain  <li><em>I’m getting exposed to various frameworks, tools, datastores, techniques, skills</em> every day which I like very much  <li>Last but not least, <em>its helping me to contribute back to the community</em></li></ul> <p><u>Note:</u> Its just my personal views, I’m just sharing what are all benefits that I am reaping by virtue of Node.js.</p> <p><strong>Summary</strong></p> <p>I would like to conclude this blog post by dedicating the “jade-visualizer” to all the open-source contributors in the planet. Its you who inspired me! Hearty thanks to one and all <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="http://lh4.ggpht.com/-t_I-2AzWiW8/T7akq4S6BXI/AAAAAAAAAYw/msikTfLIqoY/wlEmoticon-smile%25255B2%25255D.png?imgmax=800"></p>
</div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[An interesting JSON Model Binding behaviour in ASP.NET MVC3]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2012/04/13/interesting-json-model-binding/"/>
    <updated>2012-04-13T00:00:00+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2012/04/13/interesting-json-model-binding</id>
    <content type="html"><![CDATA[<div class='post'>
    <h3>Introduction</h3>
    <p>
        <a href="http://msdn.microsoft.com/en-us/library/dd410405.aspx">Model Binding</a> is one of the coolest feature in ASP.NET MVC3.
        Like a magic wand, your form element values, <a href="http://www.json.org/">JSON values</a>, also query string values automatically get converted to the equivalent C# object and
        makes the life of the developer easier.
    </p> <p>
        The default behaviour of MVC3 model binding works well in more common scenarios.
        But in certain cases it wont work as expected, and in such situations we need to <a href="http://odetocode.com/blogs/scott/archive/2009/04/27/6-tips-for-asp-net-mvc-model-binding.aspx">
            write
            custom model binders
        </a>. Two weeks before while I was working with model binding on JSON values, I’ve encountered an interesting behaviour of JSON model binding.
    </p>

    <p>
        If a JSON property contains a string, it get bind to a string property of the equivalent C# object. But if that same JSON property contains a empty string, while model binding,
        the equivalent C# object’s property is assigned to null and not to empty string! The same happened with arrays. If it contains elements, it get bind without any problems.
        But if the array is empty it get bind to null!!
    </p> <p>
        In this blog post, we are going to get rid of this intriguing behaviour by writing a Custom JSON model binder.
        Hope it would be useful and save you some hairs <i class='emoji smile'></i>

        <h3>The Sample Application – “MyMobileStore”</h3>
    <p>
        In this blog post we are going to see a small application called “MyMobileStore”. This sample app has two features. One will help you to search the mobiles
        in the “MyMobileStore” by using the company name and the mobile types. An another feature will help you to find out the sales details of the mobiles from a given
        company for the specified mobile types.
    </p>

    <h3>Show me the code</h3>
    <p>Core classes</p>
    <p><img class="center" src="http://www.p3programmer.com/blog/images/JsonModelBinding/CoreClasses.png" title="" ></p>
    <p>As mentioned earlier, the two features of “MyMobileStore” are exposed as controller action methods as below</p>
    <p>
    <p><img class="center" src="http://www.p3programmer.com/blog/images/JsonModelBinding/MobileController.png" title="" ></p>
    <p>
        Both action methods uses a parameter of type “MobileFilter” which actually holds the filter criteria for finding out the mobiles. It has two properties,
        the companyname of the mobile and the collection of mobile types (Normal, DualSim or SmartPhone)
    </p>
    <p>
    <p><img class="center" src="http://www.p3programmer.com/blog/images/JsonModelBinding/MobileFilter.png" title="" ></p>
    </p> <p>
        The SearchMobiles action method retrieves all the mobiles from the repository and filter it first by the company name and then by the mobile types.
        One small tweak, if the mobile types count is more than 3, it would take only the first 3 types (Added for demo purpose). I just left the logic of SalesDetails
        action method blank to keep it simple. Both actions returns a JSON result to make them consumed by ajax.
    </p>

    <p><em>(Note: I’ve violated some design principles in the sample code as I just wanted to make this blog post as simple as possible) </em></p>

    <h3>The Problem (Opportunity in my language)</h3>
    <p>
        In a good world, if the user selected either or both the company name and the mobiles types to be filtered, then our controller in “MyMobileStore”
        will happily accepts them as a parameter and continue its work without any mishaps.
    </p>

    <p><img class="center" src="http://www.p3programmer.com/blog/images/JsonModelBinding/Problem.png" title="" ></p>
    <p>
        But in the bad world, if the user missed out either the company names or the mobiles types or both, ASP.NET MVC3 treat them as nulls which might cause null
        reference exception and breaks the functionality!!
    </p>
    <p><img class="center" src="http://www.p3programmer.com/blog/images/JsonModelBinding/BadWorld.png" title="" ></p>
    <p><img class="center" src="http://www.p3programmer.com/blog/images/JsonModelBinding/NullException.png" title="" ></p>

    <p>
        <em>
            (Now you might have understood why I added a tweak in the number of mobile types
            <i class='emoji smile'></i>)
        </em>
    </p>
    <h3>Possible Solutions</h3>
    <ol>
        <li>Perform null check inside the “SearchMobiles” action method and assign empty array.</li>
        <li>Write a Custom Model Binder for “MobileFilter” and perform the null check inside the model binding logic</li>
    </ol>
    <p>
        Though the option 1 is a simple and straightforward thing, what would you do if the “SalesDetails” action method works with the mobile types collection.
        You certainly need to duplicate the null checking inside it also. Let us assume that we have some more action methods in our “MyMobileStore” which has “MobileFilter”
        as their parameter. Do you still duplicate the null check there ?. Think!!
    </p>
    <p>
        If you do so, I am sorry my dear friend, you are violating the <a href="http://en.wikipedia.org/wiki/Don't_repeat_yourself">DRY</a> principle and creating
        <a href="http://pragprog.com/the-pragmatic-programmer/extracts/software-entropy">a broken window</a> in your codebase! So, lets go ahead and write
        <a href="http://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882">clean code</a> by making use of Custom Model Binder for our “MobileFilter”.
    </p>

    <h3>The Pragmatic Solution – MobileFilterModelBinder</h3>
    <p>
        <img class="center" src="http://www.p3programmer.com/blog/images/JsonModelBinding/MobileFilterModelBinder.png" title="" >
    </p>

    <p>
        Our custom model binder is very simple, it just makes use of Default Model binding behaviour. After the default behaviour has been done,
        it checks for null values using <a href="http://msdn.microsoft.com/en-us/library/ms173224.aspx">Null-Coalescing operator</a> and assign empty values if
        the values are null.
    </p> <p>Don’t forget add the custom model binder in the Global.asax.cs file.</p>

    <p>
        <img class="center" src="http://www.p3programmer.com/blog/images/JsonModelBinding/Global.png" title="" >
    </p>
    <p>Now our “MyAppStore” is robust enough to tackle the bad world!!</p>
    <p>
        <img class="center" src="http://www.p3programmer.com/blog/images/JsonModelBinding/NoMoreBadWorld.png" title="" >
    </p> 
    <h3>Conclusion</h3> 
    <p>In this blog post you have seen an exciting problematic behaviour of JSON model binding in ASP.NET MVC3 and a simple way to get rid of the default model 
        binding problems. In my next blog post I would share my experiences in how to unit test this custom model binders. 
    You can download the source code that I have used in this blog post from <a href="http://www.box.com/s/16dbb662bb2f94babe27">here</a></p>
</div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Unit Testing Html Helpers in ASP.NET MVC3–The Cleaner Way]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2012/03/04/unit-testing-html-helpers-in-aspnet/"/>
    <updated>2012-03-04T00:00:00+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2012/03/04/unit-testing-html-helpers-in-aspnet</id>
    <content type="html"><![CDATA[<div class='post'>
    <p>Would you like if your unit test have an assertion like this ?</p>
    <div style="text-align: center;clear:both">
        <img src="http://lh5.ggpht.com/-Z7XXVGQ3sX4/T1J73ct1gqI/AAAAAAAAASQ/qw-uSNrLoOE/image_thumb3.png?imgmax=800">
    </div>
    <p>
        IMHO having a unit test assertion like this with a long magical string value would become a maintenance problem with additional logic being added.
        It breaks with even minor changes like “adding an extra whitespace” though it is logically correct(Browsers ignores the whitespaces while rendering html)!.
        It is harder to debug to!!
    </p>
    <p>
        How can we get rid of this long string assertion ? Is there any better way to do assertion against this long magical string ejected from a
        <a href="http://stephenwalther.com/blog/archive/2009/03/03/chapter-6-understanding-html-helpers.aspx">HtmlHelper</a> ? One thing which strikes on my mind when I come
        across this problem is why don’t we parse the string as an xml and assert against the xml element instead. It might appear like laborious at the first sight,
        but by making use of <a href="http://msdn.microsoft.com/en-us/library/system.xml.linq.xelement.aspx">XElement</a> and
        <a href="http://msdn.microsoft.com/en-us/library/bb383977.aspx">extension methods</a> we can easily do that.
    </p>

    <p>In the blog post we are going to see how can we implement this in a more cleaner way. </p>

    <p>Okay.. Enough texts.. Its time to see some code!!</p>

    <p>
        The first step is to convert the “html string” returned by the html helper to XElement. Generally most of the helpers returns
        <a href="http://stackoverflow.com/questions/2293357/what-is-an-mvchtmlstring-and-when-should-i-use-it">MvcHtmlString</a>, So, we can easily achieve this
        by writing an extension method called “ToXElement” on MvcHtmlString.
    </p>

    <div style="text-align: center;clear:both">
        <img src="http://lh4.ggpht.com/-cwtnsV7pl2c/T1J763QmH1I/AAAAAAAAASg/6QKxAEGZ5uM/image_thumb%25255B2%25255D.png?imgmax=800">
    </div>

    <p>That’s it! All set to redefine the way custom html helpers are being tested. </p>

    <p>Fine, Let us see it in action. We will start with a handy HtmlHelper method called “Button” which would render a “Html button tag” and here is the test to assert it.</p>

    <div style="text-align: center;clear:both">
        <img src="http://lh4.ggpht.com/-Zl-hH4zYH1A/T1J7_Y9Qr3I/AAAAAAAAASw/PyWZZJMadV0/image_thumb%25255B10%25255D.png?imgmax=800">
    </div>
    <p>
        The first test uses the ToXElement extension method and assert against the XElement’s properties whereas the second test uses the
        “magical string with tags added” to do the assertion. Now you may feel what’s wrong with this guy the second test look clean to me,
        why he is making fuss about it. Yes you are correct, the second one looks clean. But it appears to be clean as the requirement in hand is very simple.
    </p>
    <p>IMHO the custom html helpers that we are building in our real world application won’t be as simple as having a button tag with just plain caption in it. </p>
    <p>Fine, lets see the real world. Voice from your team lead <em></em></p>
    <p>
        <em>
            Hey! the Button HtmlHelper you designed has did a tremendous job. Can you make a small change on it so that it would
            <strong>generate a button with a class attribute having the value ‘appbutton’ by default</strong>.
            We need it because it make the button styling consistent with rest of our application ”
        </em>
    </p>

    <p>Let us implement the feature by starting with the test for it</p>
    <p>
        <a href="http://lh4.ggpht.com/-HScL-9YaD1s/T1J8Awk2YbI/AAAAAAAAAS4/Q3E6JlpRItM/s1600-h/image%25255B23%25255D.png">
            <img src="http://lh5.ggpht.com/-MyHzxXBfdCM/T1J8DL_KgbI/AAAAAAAAATA/Vvt1j4k-KYo/image_thumb%25255B14%25255D.png?imgmax=800">
        </a>
    </p>
    <p>
        Now tell me is the second test clean ? I don’t think so. The generate html string is bit long now also having double quotes inside double quotes makes it hard to read.
        At the same time the first test remains robust and clean.
    </p>

    <p>
        Still not convinced, okay just go up and see the very first test that we have wrote to test the button caption.
        Do you think the <strong>hard way test</strong> with the “<strong>long magical string</strong>” still pass ??
    </p>

    <p style="text-align: center; color: #ff0000; font-weight: bold">It would fail</p>

    <p>Why ?? Here is the error message </p>
    <p>
        <a href="http://lh5.ggpht.com/-K6RjhSEMhLA/T1J8EpZAZ-I/AAAAAAAAATI/TUutsjz0XdE/s1600-h/image%25255B28%25255D.png">
            <img src="http://lh4.ggpht.com/-SpmB-mDwffk/T1J8HO3Np4I/AAAAAAAAATQ/oKxboMdbr6I/image_thumb%25255B17%25255D.png?imgmax=800">
        </a>
    </p>
    <p>Now what would you do, if you decided to persist with the “long magical string”, then your action would be editing the test as below</p>
    <div style="text-align: center;clear:both">
        <img src="http://lh6.ggpht.com/-RJKnvJ5K8dI/T1J8LTJG_iI/AAAAAAAAATg/TAKyOA5Ej9w/image_thumb%25255B21%25255D.png?imgmax=800">
    </div>
    <p>Nice job. Now tell me what is the difference between this one and the below one</p>
    <div style="text-align: center;clear:both">
        <a href="http://lh6.ggpht.com/-ps4dX_FO-B0/T1J8MhVBtwI/AAAAAAAAATo/u003U24qiBo/s1600-h/image%25255B42%25255D.png">
            <img src="http://lh3.ggpht.com/-i5zAV0v0JfY/T1J8O7pNIiI/AAAAAAAAATw/Fuo_4WMsFzk/image_thumb%25255B27%25255D.png?imgmax=800">
        </a>
    </div>
    <p>
        Apart from the test method name everything is same. Is the test clean ? Is the test clearly saying what it is trying to assert ?
        What would happen if we got the requirement to add one more attribute or even more? Think !!
    </p>

    <p>But at the same time the tests which written using XElement assertion would remain healthy and their test method name mean what it is testing </p>
    <p>
        <a href="http://lh6.ggpht.com/-t5GRHpUvWSI/T1J8Qh6dvqI/AAAAAAAAAT4/WaaIvzaEKCY/s1600-h/image%25255B47%25255D.png">
            <img src="http://lh3.ggpht.com/-fQ_eFoBZqnE/T1J8TPZgtFI/AAAAAAAAAUA/1wGDDsT5J8Y/image_thumb%25255B30%25255D.png?imgmax=800">
        </a>
    </p>
    <p>I leave it you to decide which one is cleaner. </p>
    <h4>Summary</h4>
    <p>Here is the implementation of “Button HtmlHelper” that we unit tested so far</p>
    <div style="text-align: center;clear:both">
        <img src="http://lh4.ggpht.com/-lg0jE79JCVI/T1J8Y3QGqOI/AAAAAAAAAUQ/gif78dMv6XI/image_thumb%25255B33%25255D.png?imgmax=800">
    </div>
    <p>
        My humble request to the readers of this blog post, please take care of your “Unit tests” and give some more importance to it.
        An hour spent upfront would save a day in future.
    </p>
    <p>“Beauty is in the eye of the beholder”, If you have a better idea to do the same, kindly leave a comment, I am open to learn from you.</p>
</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Unit Testing Custom Model Binders in MVC3]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2012/02/11/unit-testing-custom-model-binders-in/"/>
    <updated>2012-02-11T00:00:00+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2012/02/11/unit-testing-custom-model-binders-in</id>
    <content type="html"><![CDATA[<div class='post'>
    <p>
        In <a href="http://www.p3programmer.com/blog/blog/2012/02/02/unit-testing-with-sessions-in-aspnet/">my previous post</a> we have seen a way to do unit testing 
        with Sessions in MVC3 using Custom model binders. In this blog post we are going to see how to do unit test the model binder itself.
    </p>
    <p>
        One remarkable thing which everybody hails in MVC3 is its extensibility and its testability. You can extend/customize the components in the 
        framework and also you can unit test them with ease.
    </p>
    <p>
        Before getting into unit testing the custom model binder, Lets have a closer look at 
            the <a href="http://msdn.microsoft.com/en-us/library/system.web.mvc.imodelbinder.bindmodel.aspx">BindModel</a> method
    </p>
    <br />
    <img class="center" src="http://www.p3programmer.com/blog/images/UnitTesting_ModelBinders/BindModel.png">
       
        <p>
            In the BindModel method we are making use of Session property in the HttpContext object which is in turn a property of 
            the <a href="http://msdn.microsoft.com/en-us/library/dd492673.aspx">ControllerContext</a> object that is passed to the BindModel method as 
            a parameter by the MVC3 framework. In order to unit test this method we need to have to control over the HttpContext property of 
            the ControllerContext and the Session property of the HttpContext.
    </p>

    <p>How to get control over those properties ? Thanks to <a href="http://msdn.microsoft.com/en-us/library/dd460098.aspx">a constructor of ControllerContext</a></p>
    <br /><img class="center" src="http://www.p3programmer.com/blog/images/UnitTesting_ModelBinders/ControllerContext.png">        
        <p>ControllerContext uses the constructor dependency injection to get rid of the direct dependency on <a href="http://msdn.microsoft.com/en-us/library/system.web.httpcontextbase.aspx">HttpContextBase</a> and we are going to exploit this to do unit testing. Using a mocking framework we can easily create a mock of HttpContetBase and drive the unit test.</p>
    <p>The Session property of the HttpContextBase is of type <a href="http://msdn.microsoft.com/en-us/library/system.web.httpsessionstatebase.aspx">HttpSessionStateBase</a> which can also be mocked.</p>
    <p>Here is the complete implementation of Test fixture class which unit test the CartModelBinder class that we have seen in the <a href="http://www.p3programmer.com/blog/blog/2012/02/02/unit-testing-with-sessions-in-aspnet/">previous post</a> using the mocking library <a href="http://code.google.com/p/moq/">Moq</a>.</p>
    <br /><img class="center" src="http://www.p3programmer.com/blog/images/UnitTesting_ModelBinders/UnitTest.png">      

</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Unit Testing with Sessions in ASP.NET MVC3]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2012/02/02/unit-testing-with-sessions-in-aspnet/"/>
    <updated>2012-02-02T00:00:00+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2012/02/02/unit-testing-with-sessions-in-aspnet</id>
    <content type="html"><![CDATA[<div class='post'>
    <h3>Introduction</h3>
        
        <p>While talking to my friend regarding his project, he told me about how he is doing unit testing which involves sessions in ASP.NET MVC3. 
            His team is actually using a “HttpSimulator” which simulates the web request and then the do unit test by verifying the session by interacting 
            with the simulator. When digging further I have come to know that this way of unit testing session objects are influenced 
            from the “ASP.NET Webforms”. It reminds me the talk of <a href="http://www.infoq.com/presentations/Functional-Thinking">Neil Ford on 
                Function Thinking</a>. In that video he talks about an analogy called “Axe and Chain Saw” to explain our way of thinking as
        </p>
        <blockquote>When we give a chain saw to people who were cutting trees by axe, they would tend to use chain saw in the same way as the use Axe. 
            Which is obviously inefficient. So we should understand at the capabilities of the tool in our hand before we using it</blockquote>
       
        <p>ASP.NET MVC3 is far better than Web Forms when it comes to unit testing. We don’t need to use a simulator to test against our sessions. 
            There is a better way to do this MVC3 and in this blog post we are going to explore it.<p/>
       
        <h4>Time for Code</h4>       
        <p>Shopping Cart is the first thing that strikes our mind when we want to quote an example for using Http session. 
        So, I am going to show an app called “MyShop” a mini shopping site through which I am going to explain the concepts involved. 
        The application flow would be as follows</p>
        
            <img class="center" src="http://www.p3programmer.com/blog/images/UnitTesting_With_Session/Cart.png">
            <img class="center" src="http://www.p3programmer.com/blog/images/UnitTesting_With_Session/Cart2.png">       
        

        <h4>Models</h4>
        
        <p>The models are simple, straight forward and self explanatory.</p>
    <img class="center" src="http://www.p3programmer.com/blog/images/UnitTesting_With_Session/model.png">  
    <img class="center" src="http://www.p3programmer.com/blog/images/UnitTesting_With_Session/CartCsharp.png">    
        <p>I’ve tried my level best to keep the model as simple as possible. 
        So, Cart in MyShop will have only two public methods. One to add a product to the Cart’s Line and another one to retrieve all the 
        products inside the Cart’s line.</p>
        
        <h4>The CartController Version 1.0</h4>
        <img class="center" src="http://www.p3programmer.com/blog/images/UnitTesting_With_Session/CartController.png"> 
        <p>In this CartController version 1.0 we have two public methods Index and AddToCart which are dependent on HttpSession object. 
            This dependency inside the methods is actually preventing us from unit testing the CartController in simple way and we have no 
            choice other than implementing a “Http Simulator” to unit test these two methods. As I said before there is better to do is! Here we go!!</p>
        
        <h4>The CartController Version 2.0</h4>
        <img class="center" src="http://www.p3programmer.com/blog/images/UnitTesting_With_Session/CartController2.png"> 
    <p>No more Sessions!!.. Yeah.. We have got rid of the dependency on the session object by adding a new parameter called cart. Now you can use easily unit test the CartController as follows</p>
        <img class="center" src="http://www.p3programmer.com/blog/images/UnitTesting_With_Session/UnitTest.png"> 
        <p>Okay we made it easy for unit testing by moving the dependency out of the method and introduced the cart as the parameter. But how does my MVC3 framework will know the cart parameter should come from session object ?… Good Catch!! and here comes the magic called custom ModelBinder</p>
       
        <h4>ModelBinder – A brief background</h4>
        <p>Model binding is an exciting feature in MVC3 framework which automatically creates the C# objects directly from Http request and 
            pass it to the Action methods in controller as parameter values. It uses a default model binder which looks at the form values, 
            query string values that are submitted with the Http Request and create the model object.</p>
        <h4>CartModelBinder</h4>
        
        <p>In our case, we need to have a object of Cart which is populated from the Session object and not from the HttpRequest. 
            The default model binder used by MVC3 has no idea about session object. So, Its our responsibility to tell to the MVC3 framework
        </p>
        
        <p>“<em>Hey! If there is any parameter of type Cart in controller action method, then use my own custom model binder called CartModelBinder to create the object</em>”</p>
        <p>There are two steps to do the above said operation</p>
        <p>1. Creating the custom model binder by inheriting the IModelBinder interface</p>
        <img class="center" src="http://www.p3programmer.com/blog/images/UnitTesting_With_Session/CartModelBinder.png"> 
        <p>2. Registering our custom model binder in the Global.asax.cs file</p>
        <img class="center" src="http://www.p3programmer.com/blog/images/UnitTesting_With_Session/AppStart.png"> 
        <p>
        That’s all.. MVC3 takes care of rest</p>
        
        <h4>Summary</h4>
        <p>In this blog post we have explored how we can get rid of “Http Simulator” to unit test the controllers which involves Session objects using 
            custom model binder. You can download the working example of “MyShop” showcased in this blog post 
            from <a href="http://www.box.com/s/b9lf2heukyivh68921jj">here</a>. 
            Refer <a href="http://www.p3programmer.com/blog/blog/2012/02/11/unit-testing-custom-model-binders-in/">my next blog post</a> to check out how to do 
            unit testing with the custom model binder itself.</p>
</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2012 – A year of aspirations]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2011/12/29/2012-year-of-aspirations/"/>
    <updated>2011-12-29T00:00:00+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2011/12/29/2012-year-of-aspirations</id>
    <content type="html"><![CDATA[<div class='post'>
<div dir="ltr" style="text-align: left;" trbidi="on"><div align="justify"><br /></div><div align="justify">2011 has been a magnificent year for me both professionally and personally. The most significant thing about the year 2011 was the time that I have spent with my mentor, team mate and a good friend <a href="http://www.linkedin.com/pub/jijesh-mohan/a/488/545">Jijesh Mohan</a>. I have started the year with full of ambitions but with the uncertainty of how to achieve them. Though I have worked really hard to achieve those ambitions, I failed plenty of times while trying to reach the next level and the reason is absence of direction. Jijesh shared his experience with me and helped a lot in understanding various aspects of programming, software development and much more. Hearty thanks Jijesh <img alt="Smile" class="wlEmoticon wlEmoticon-smile" src="http://lh4.ggpht.com/-n3NYjmGhjro/TvyccIdnG0I/AAAAAAAAANY/-8YxbNYlPjU/wlEmoticon-smile%25255B2%25255D.png?imgmax=800" style="border-bottom-style: none; border-left-style: none; border-right-style: none; border-top-style: none;" /> . The difference you made in my life as a programmer can not be expressed just by words.&nbsp; <br /><br /></div><div align="justify">It was a tough decision to make, but I have decided to leave Cognizant to explore different real time problems which are totally outside my comfort zone. I would like to thank my cherished manager&nbsp; <a href="http://www.linkedin.com/pub/ramakrishnan-venkatasubramanian/8/85/6a0">Ramakrishnan</a>, and beloved leads <a href="http://in.linkedin.com/pub/vijay-krishnan-ramaswamy/43/738/766">Vijay</a> and <a href="http://www.facebook.com/profile.php?id=100003088519900">Karthik</a>. Thank you all three for the inspiration, responsibilities and freedom you offered me to explore, learn, apply and adopt new technologies on various assignments. The trust you had in me helped a lot to shape up my professional career. I will surely miss you.<br /><br /></div><div align="justify"><strong>What’s Next ?</strong></div><div align="justify"><br />I will be joining <a href="http://www.advisory.com/">Advisory Board</a> in the first week on February 2012. I am very excited about it as it is a position that enable me to solve complex problems which involves huge volumes of data.&nbsp; <br /><br /></div><div align="justify"><strong>Goals </strong></div><div align="justify"><br />The one thing which keep me passionate and crazy about Computer Science is <strong>It is a path with no destination</strong>. One good lesson which I have learned last year is having goals like WaterFall model will not keep you valuable in the market. Like the requirements, the technologies are also volatile so the right way I believe is <strong>being Agile </strong>and the bottom line is set big goals, but make constant corrections along the way. My focus for the year 2012 would be</div><ul><li> <div align="justify">Javascript, HTML5, interactive Web Applications</div></li><li> <div align="justify">Functional Programming</div></li><li> <div align="justify">Working with huge volume of data</div></li><li> <div align="justify">Agile Methodologies</div></li><li> <div align="justify">Open Source Contributions</div></li><li> <div align="justify">Knowledge sharing through blogs and webinars</div></li></ul><div align="justify">Wish you all a very happy and prosperous new year.</div></div></div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Going Declarative in C#]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2011/11/22/going-declarative-in-c/"/>
    <updated>2011-11-22T00:00:00+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2011/11/22/going-declarative-in-c</id>
    <content type="html"><![CDATA[<div class='post'>

    <p>
        <a href="http://en.wikipedia.org/wiki/Declarative_programming">Declarative programming</a> is a simpler, more concise way to describe the 
            behavior of a software program than <a href="http://en.wikipedia.org/wiki/Imperative_programming">imperative programming</a>. 
            I am an admirer of declarative aspects of programming ever since I have started writing SQL queries. We always do our best to write code 
            that is easier to read and maintain. Declarative style is one of the proven ways to write clean code. 
            <a href="http://msdn.microsoft.com/en-us/library/bb308959.aspx">LINQ</a> is an excellent example of declarative style programming that 
            enables the developers to simply state what they want to do. When I was learning <a href="http://learnyouahaskell.com/higher-order-functions">higher order functions in Haskell</a>, I have found the interrelationship between the higher order functions and the LINQ. 
            It really made me to think in a different way to solve a problem. 
            Through this blog post I would like to share my experiments on <a href="http://en.wikipedia.org/wiki/Higher-order_function">higher order functions</a> in C#.
    </p>

    <p>Let me start with a very simple requirement. </p>
    <blockquote>Write a program to print the even numbers present in the given n numbers</blockquote>
    <p>The code implementation fairly straight forward as below</p>
    <div class="separator" style="clear: both; text-align: center;">
        <img border="0" src="http://2.bp.blogspot.com/-F8d-q0yfDxQ/TsutZtHjXFI/AAAAAAAAAMM/VZOQO-TrRkM/s1600/PrintEvenNumbers.PNG" />
    </div>

    <p>Nothing fancy about this trivial thing. Let me add some more twist to the code by adding two more requirements.</p>
    <blockquote>Modify the program implemented above to print odd numbers and multiples of four present in the given n numbers</blockquote>

    <p>To be honest, If I have encountered this requirements before I have learnt Higher Order Functions my implementation would be as follows.</p>
    <br />
    <div class="separator" style="clear: both; text-align: center;">
        <img border="0" src="http://2.bp.blogspot.com/-6Yj8HNUD34s/Tsutfjqe-AI/AAAAAAAAAMU/Oq7SKgTBOyA/s1600/TwoMoreReq.PNG"/>
    </div>
    
    <p>If you look at the above implementation with a critical eye, you can find a potential candidate of duplication. 
        Let me explain the common pattern that is being used in the implemented PrintXXXX functions. 
        For each number in the numbers enumerable we are doing the following</p>
    <ul>
        <li>Deciding whether the number should be printed or not <em>(Deciding)</em></li>  
        <li>Printing the number if it is passes the above decision <em>(Doing)</em></li>  
    </ul>    
<br />
    <div class="separator" style="clear: both; text-align: center;">
        <img src="http://1.bp.blogspot.com/-9xr-Hu8TT7U/TsutkGNc9SI/AAAAAAAAAMc/_JeMMy5u1RY/s1600/Duplication.PNG">
    </div>
<p>All the three functions iterate over the numbers enumerable and print the numbers. The only thing which actually differentiates the functions is deciding which numbers to be printed.</p>
<p>Now the question is how can we eliminate this duplication????</p>
<p>It’s where higher order functions come into picture. If we move the deciding part of the function away from its implementation then we can easily achieve it.&nbsp;&nbsp; Here we go! The brand new implementation of Print would be </p>

<br /><div class="separator" style="clear: both; text-align: center;">
        <img border="0" src="http://2.bp.blogspot.com/-9RF4Km0s1NA/TsutoVD_WkI/AAAAAAAAAMk/GWASEODqJTk/s1600/HigherOrderPrint.PNG"/>
</div>


<p>In the new implementation we have just isolated the deciding part of the function from its implementation and parameterize it as function delegate that takes an integer as its input and return a Boolean value.&nbsp; In the client code (Main function) we are actually just calling the print function and declaratively telling it to print only those numbers which satisfies the given condition. As we separated the deciding part from the actual implementation, we can easily accommodate any future requirements like “<i style="mso-bidi-font-style: normal;">Printing multiples of five, printing only single digit numbers</i>” by declarative calling the Print function like as below</p>
<br /><div class="separator" style="clear: both; text-align: center;">
        <img border="0" src="http://4.bp.blogspot.com/-iunnD2jPXv8/TsutsrFa_4I/AAAAAAAAAMs/oE81RX5J8gY/s1600/AccomodatedRequirement.PNG" />
</div>

<p>Cool.. Isn’t it ? Let me complicate the things little more. What would you do if you want to call this Print method across different classes?. A notorious option would be creating a <a href="http://en.wikipedia.org/wiki/Utility_class">Utility class</a> with the Print method and calling it from the other classes. We can also solve these using <a href="http://msdn.microsoft.com/en-us/library/bb383977.aspx">Extension methods</a> which results a clean readable code like as below</p>
<br /><div class="separator" style="clear: both; text-align: center;">
    <img border="0" src="http://4.bp.blogspot.com/-DZVepYydQ84/TsutwLqz__I/AAAAAAAAAM0/eNlsA0F2jzI/s1600/ExtensionMethod.PNG" />
</div>

<p>So far, so good. We have started with a single function and then we added two more, then eliminated the duplication using Higher Order functions and 
    finally we have made the code readable by using extension method. </p>
<p>Okay. Now “<i>I want to print the strings which starts with ‘s’ in the given n strings </i>”. Pardon me for complicating things, I will stop by this one.</p>
<p>It is almost logically similar to what we have done so far. Instead of numbers here it is string. How can we put it into action?. 
    Thanks to <a href="http://msdn.microsoft.com/en-us/library/512aeb7t%28v=vs.80%29.aspx">Generics</a>. We can easily achieve this by modifying the extension method to support generic type as below</p>
    <br />
<div class="separator" style="clear: both; text-align: center;">
   <img border="0" src="http://3.bp.blogspot.com/-Cwp_3vrURcU/Tsut-VkAqjI/AAAAAAAAAM8/UrutESWMdw4/s1600/GenericExtensionMethod.PNG" />
</div>


<div>That’s it. Now you are free to play with all sort of logic you want. You can play with different set of conditions to print the elements or even you can also use different collection of your custom classes. And all can be done declaratively!!</div>
<div>Now its time to reveal to the interrelationship exists between the LINQ and the higher order functions. All the LINQ methods are actually using these Print extension methods kind of extension methods under the hood and makes the life of developer easily but letting them to work declaratively. </div>
<div><a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.parallel.aspx">Parallel Class</a> a new addition in C# 4.0, also uses higher order functions and enables the developer to say “Hey CLR, I wanna run these methods parallel”. </div>
<br /><div class="separator" style="clear: both; text-align: center;">
        <img border="0" src="http://3.bp.blogspot.com/-oghYOKAdsl4/TsuuMGSPzJI/AAAAAAAAANE/YVpPV4cfTOU/s1600/Parallel+Invoke.PNG" />
</div>

<p>Awesome! No new thread creation and no verbose. </p>
<h4>Summary</h4>
<p>Declarative Programming is powerful tool. It creates more readable, cleaner code and also reduces the possibility of logical mistakes in 
    multiple similar algorithms. That means fewer mistakes now and in the future.</p>
</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Think Before You LINQ]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2011/11/03/think-before-you-linq/"/>
    <updated>2011-11-03T00:00:00+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2011/11/03/think-before-you-linq</id>
    <content type="html"><![CDATA[<div class='post'>
<div>
<p>LINQ is an awesome feature which I like the most in C#. The abstraction, expressiveness and the power it offers to the code are simply amazing. In general when we think of abstractions, we tend to think towards expressiveness and <a href="http://martinfowler.com/bliki/FluentInterface.html">fluent interfaces</a> and get carried away.</p>

<p>Efficiency of an abstraction is often an afterthought (Based on my experience, correct me if am wrong) and also it is very hard to define an abstraction which should be efficient for all the real world problems it address. When we encountered any efficiency issue in an abstraction, it is our primary responsibility to get rid of it.</p>

<p>Let us assume that you have found an efficiency issue with an abstraction. How would you troubleshoot it? Think! I believe, awareness of internals of the abstraction would be the prime prerequisite to circumvent the problem.&nbsp; Hence as a professional developer we should be aware of what is happening under the hood when we use LINQ or any such kind of abstractions. Though we are not going to employ this in most of our coding efforts, I feel it would be an ideal weapon that we should keep in our arsenal.</p>

<p>I have encountered one of such efficiency issue with LINQ and it really made me to think twice (even thrice) before applying LINQ to solve the problems. Let me explain it through a simple example. Here is the problem which I am going to solve through LINQ.</p>

<p>“I need a method that should take a collection of numbers as its parameter and write all the numbers in the console. If the collection contains only one number it should not write anything”</p>

<p>Here is the code snippet which address this problem and along with the output.
	<br>
  <img src="http://4.bp.blogspot.com/-22Zod3zjsX0/TrJi6zjlU9I/AAAAAAAAALc/oK_RVfhUQOs/s1600/1.PNG" alt="">
</p>

<p>I have used two abstractions on this function, one is the LINQ extension method “Count” and the other one is iterating through the enumeration abstraction. Would you able to find an efficiency issue lurking on this very simple function? Kudos if you find it out.
</p>

<p>Let me give a small background about LINQ extension methods and Enumeration. Most of the LINQ extension methods are using lazy execution internally and computes the enumeration on demand basis. However some extension methods (Count, Sum) collectively called <a href="http://code.msdn.microsoft.com/LINQ-Aggregate-Operators-c51b3869">Aggregate Operators</a> causes immediate execution instead of lazy execution on the enumeration. We can we make an enumeration to enumerate lazily by using <a href="http://msdn.microsoft.com/en-us/library/9k7k7cf0.aspx">“yield”</a> statements. Enough theory, &nbsp;let us see some code which shows the efficiency issue associated with the function that we have seen earlier</p>

<br>
<div>
  <img src="http://2.bp.blogspot.com/-Gfsxz8fP4WU/TrJi642QHRI/AAAAAAAAALk/OsojBB--7jM/s1600/2.PNG">
</div>


<p>I have added some code in “PrintMe” method to log how it is actually getting executed. Also I have added the “GetNumbers” method which lazily creates a list of numbers using yield statement. </p>

<p>Now can you able to find the exact issue associated with the method “PrintMe”? The red lines are areas of concern. The list is yielded twice!! One while using the Aggregate Operator of LINQ “Count” which causes immediate execution results enumeration all the yields and the second one is yielding the list once again lazily when enumerating through “foreach” loop.</p>

<p>Though it is just a matter of nanoseconds in this example, it may be possible candidate of bottleneck in real world. So, whenever you are doing more than one operation on LINQ or an enumeration or both combined, do not forget think about efficiency. <em>In fact we should give a special attention to the speed of our algorithm when we are actually coding it.</em> (Refer <a href="http://pragprog.com/the-pragmatic-programmer">Pragmatic Programmer</a>, Chapter 6, While You Are Coding)</p>

<p>I hope now you are ready to think about efficiency when you code. Here in our case we can get rid of the efficiency issue by converting the enumeration of number to an array or a list using LINQ <a href="http://code.msdn.microsoft.com/LINQ-Conversion-Operators-e4e59714">convertor operators</a> ToArray or ToList respectively. Like aggregate operators it causes immediate execution and converts the enumeration to the target type. Then we can do the operations on the converted target. Here is the code snippet of that with the output.</p>

<br>
<img src="http://3.bp.blogspot.com/-sJ0FDYxkl9Y/TrJi63comkI/AAAAAAAAALg/iPn8h9xdVOQ/s1600/3.PNG" alt="">

<p>The modified code now iterate through the list only once!!</p>

<h4>Summary:</h4>

<p>Would you use powerful weapons to get rid of smaller problems, certainly not? LINQ is such kind of powerful weapon which is meant to solve powerful problems. So, think twice before using LINQ and don’t use it blindly. Efficiency Matters!! &nbsp;</p>
</div></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Practice, Practice, Practice !!]]></title>
    <link href="http://www.p3programmer.com/blog/blog/2011/09/15/practice-practice-practice/"/>
    <updated>2011-09-15T00:00:00+05:30</updated>
    <id>http://www.p3programmer.com/blog/blog/2011/09/15/practice-practice-practice</id>
    <content type="html"><![CDATA[<div class='post'>
<div>
	<p>In the pursuit of becoming a better programmer, I have come across lot of good things, which in fact have a lot of positive impact on my thinking, attitude and the way I approach a problem. &nbsp;One of such thing is the book “<a href="http://pragprog.com/book/cfcar2/the-passionate-programmer">Passionate Programmer</a>” which I am currently reading. It is all about creating a remarkable career in software development. If you are a developer, it is a highly recommended book. &nbsp;&nbsp;&nbsp;&nbsp;</p>

	<p>There are a lot of impressive tips we can learn from this book of wisdom. One of Such tip is “Practice, Practice, and Practice!!” It talks about how to practice as a software developer. Though it seems like a mighty task, the author “Chad Fowler” convey this by breaking the might task into the following three category (Divide and Conquer Approach).</p>

<dl>
	<dt>Physical/Coordination</dt>
	<dd>
		<ul>
			<li>Learn and master the unexplored areas of the language that you are working with. Say for example, Regular Expressions</li>
			<li>Dig your language’s API and don’t reinvent the wheel</li>
		</ul>
	</dd>
	<dt>Sight Reading</dt>
	<dd>
		<ul>
			<li>Learn by reading the code </li>
			<li>Pick any of your favorite open source, explore it understand and learn the tips and tricks of the trade</li>
			<li>Add some new feature</li>
			<li>Be sure to vary the software you work with</li>
		</ul>
	</dd>
	<dt>Improvisation</dt>
	<dd>
		<ul>
			<li>Takes some structure or constraint and creating something new, on the fly on top of that structure. For example pick a simple program and try to write it with the self-imposed constraints</li>
			<li>Play with <a href="http://codekata.pragprog.com/">Code Katas</a></li>
		</ul>
	</dd> 
</dl>

<h4>It’s time for action</h4>

<p>I believe these three very fundamental aspects makes a lot of difference. So, I’ve decided to get my hands dirty with these three things and here is my list of to dos.</p>

<dl>
	<dt>Physical/Coordination – (I pick C# as its my primary language in my current role)</dt>
	<dd>
		<ul>
			<li>Regular Expressions</li>
			<li>Dynamic Programming</li>
			<li>Multithreading</li>
			<li>Parallel Programming</li>
			<li>LINQ</li>
			<li>Reflection</li>
			<li>Streams and Networking</li>
			<li>Entity Framework</li>
			<li>Data Structures and Algorithms</li>
			<li>Customizing MVC3 Framework</li>
		</ul>
	</dd>
	<dt>Sight Reading</dt>
	<dd>
		<ul>
			<li>Exploring ASP.NET MVC3 source code</li>
			<li>Exploring Nunit source Code</li>
			<li>Blog my understanding during this exploration</li>
		</ul>
	</dd>
	<dt>Improvisation</dt>
	<dd>
		<ul>
			<li>Make most of Code Katas</li>
			<li>Active participation in Technical Forums</li>
		</ul>
	</dd>
</dl>	
</div>
</div>
]]></content>
  </entry>
  
</feed>
