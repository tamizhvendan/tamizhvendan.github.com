<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[P3 Programmer]]></title>
  <link href="http://blog.tamizhvendan.in/atom.xml" rel="self"/>
  <link href="http://blog.tamizhvendan.in/"/>
  <updated>2016-04-09T15:01:27+05:30</updated>
  <id>http://blog.tamizhvendan.in/</id>
  <author>
    <name><![CDATA[Tamizhvendan S]]></name>
    <email><![CDATA[tamizh88@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Keep it Simple]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2016/02/01/keep-it-simple/"/>
    <updated>2016-02-01T15:51:46+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2016/02/01/keep-it-simple</id>
    <content type="html"><![CDATA[<p>Last week, I was working on a task which involves populating some PostgreSQL database tables from CSV files. Though this is a straight forward work, I’ve encountered an interesting approach while manipulating a CSV file to adhere some changes in the database schema. In this blog post, I will be sharing what it is and how it made me think better.</p>

<p>Unlike my other blog posts, this post is more on the thought process behind my approach than the code.</p>

<h3 id="the-story">The Story</h3>

<p>The CSV file that we suppose to import to a database table has the following Structure with 1000 rows</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class=""><span class="line">code,value
</span><span class="line">XAS,0.23
</span><span class="line">SDR,3.21
</span><span class="line">WFZ,1.87
</span><span class="line">........
</span><span class="line">........
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The column name <code>code</code> and <code>value</code> are just for illustration.</p>

<p>The Proposed schema change is introduce a new column called <code>year</code> with a fixed value <code>2015</code> for all the rows. So, the expected CSV file would like</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class=""><span class="line">year,code,value
</span><span class="line">2015,XAS,0.23
</span><span class="line">2015,SDR,3.21
</span><span class="line">2015,WFZ,1.87
</span><span class="line">........
</span><span class="line">........</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>A Very Simple Task</p>

<p>Now, How can we solve it?</p>

<h3 id="approach-1---dont-try-this-at-your-officehome">Approach 1 - Don’t try this at your office/home</h3>

<p>Let me start with an approach number one</p>

<blockquote>
  <p>Edit all the rows manually</p>
</blockquote>

<p>It is something that you never wanted to see/do. So, let me move on to the next approach without wasting any time here</p>

<h3 id="approach-2---leverage-your-programming-skill">Approach 2 - Leverage your programming skill</h3>

<blockquote>
  <p>Pick your favorite programming language and whack the CSV file  </p>
</blockquote>

<p>I believe this would be the approach that came to your mind when you read the problem statement. A typical programmer’s instinct!</p>

<p>So, you picked your programming language ‘X’, what would be the next steps</p>

<ul>
  <li>Open the IDE/Editor - <em>Wait for it to load!</em></li>
  <li>Create a Project - <em>if required and wait for it also to load!</em></li>
  <li>Start typing - <em>and your phone rings</em></li>
  <li>Refer library documentation - <em>or Refer Stackoverflow</em></li>
  <li>Compile - <em>and wait for it</em> - <em>Ignore this step and wait for a run-time error if your programming language is dynamic</em></li>
  <li>Execute - <em>A bug -&gt; Go to Google -&gt; Stack Overflow -&gt; Change the code -&gt; Start again</em></li>
  <li>You are done!</li>
</ul>

<p><em>I’ve exaggerated some things here. If you don’t agree with any steps, just ignore that step</em></p>

<p>After 2 to 15 minutes (based on your ability &amp; the ceremony of your programming language) you have solved the problem.</p>

<p>Is it really worth? Well, It depends on the context.</p>

<p>If there are lot of CSV files which require the same change or also few more like this will about to come in the near future, then this effort really makes sense</p>

<p>But, here it is only one file which requires the change. So, I feel it is a complex response to a simple problem</p>

<h3 id="approach-3---use-a-tool">Approach 3 - Use a tool</h3>

<blockquote>
  <p>Use a shiny CSV management tool to make the changes</p>
</blockquote>

<p>It is slightly better approach than the previous one but it also has its own downsides</p>

<ul>
  <li>Googling to find the tool</li>
  <li>Download it - <em>Your office firewall is blocking that site! / Registration on the tool site / Requires Java x.x version</em></li>
  <li>Open the CSV file.</li>
  <li>Refer the tool’s documentation</li>
  <li>Get the job done</li>
</ul>

<p>You can also Microsoft Excel to achieve this. But again a heavy solution to solve a simple problem!</p>

<p>There should be a simple approach! That’s what we are going to see next.</p>

<h3 id="approach-4---find-and-replace">Approach 4 - Find And Replace</h3>

<blockquote>
  <p>Just use Find and Replace in an advanced editor</p>
</blockquote>

<p>This approach involves just three steps</p>

<ul>
  <li>Open the CSV file in an advanced text editor (notepad++, atom, sublime text, etc.,)</li>
  <li>Select all the text and press <code>tab</code></li>
  <li>Open <code>Find and Replace</code>. Find for <code>tab</code> and replace it with <code>2015,</code></li>
</ul>

<p>That’s it!</p>

<h3 id="summary">Summary</h3>

<blockquote class="twitter-tweet" lang="en"><p lang="en" dir="ltr">The older I get, the more I realize the biggest problem to solve in tech is to get people to stop making things harder than they have to be.</p>&mdash; Chad Fowler (@chadfowler) <a href="https://twitter.com/chadfowler/status/646624348028190720">September 23, 2015</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Implementing API Gateway in F# using Rx and Suave]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/12/29/implementing-api-gateway-in-f-number-using-rx-and-suave/"/>
    <updated>2015-12-29T09:22:49+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/12/29/implementing-api-gateway-in-f-number-using-rx-and-suave</id>
    <content type="html"><![CDATA[<p>One of the impressive aspects of functional programming is that it will enable you to write simple and expressive code to solve  complex problems. If you are wondering, how is it possible? Well, It is because, Functional Programming provides a lot of higher level abstractions to solve the problem in hand and avoids the need of writing lot of boilerplate &amp; plumbing code. As a developer, you will be more productive and deliver the solution faster.</p>

<p>In this blog post, we are going to see the application of the above statements by implementing an <a href="https://www.nginx.com/blog/building-microservices-using-an-api-gateway">API Gateway Pattern</a> in F# using <a href="http://reactivex.io/">Rx</a> and <a href="https://suave.io/">Suave</a>.  </p>

<blockquote>
  <p>This blog post is my contribution towards <a href="https://sergeytihon.wordpress.com/2015/10/25/f-advent-calendar-in-english-2015/">fsharp advent calendar 2015</a>. Do check out other great fsharp posts there</p>
</blockquote>

<h2 id="api-gateway-pattern">API Gateway Pattern</h2>
<p>Let’s assume that you are asked to build the backend for the below GitHub user profile screen.</p>

<p><img src="http://res.cloudinary.com/tamizhvendan/image/upload/v1450769741/Profile.png" alt="Github Profile" /></p>

<p>This profile screen has 3 components</p>

<ol>
  <li>
    <p>User - Username and Avatar</p>
  </li>
  <li>
    <p>Popular Repos - Top 3 Repos of the Given User (determined by the number of stars)</p>
  </li>
  <li>
    <p>Languages being used in the corresponding repos</p>
  </li>
</ol>

<p>Now as a developer, you have two options</p>

<ul>
  <li>
    <p>Build the Profile completely in client side by calling their corresponding GitHub APIs
<img src="http://res.cloudinary.com/tamizhvendan/image/upload/v1450769816/Profile_With_API_Calls.png" alt="Profile with URLs" /></p>

    <p>This approach makes the client side complex as it involves five HTTP requests to create the complete profile screen. It has a lot of drawbacks as mentioned in <a href="http://techblog.netflix.com/2013/01/optimizing-netflix-api.html">this blog post</a> by Netflix.</p>
  </li>
  <li>
    <p>Create a Facade API which takes care of the heavy lifting and hides the complexity of calling multiple services by  exposing a single endpoint which returns all the data required to create the profile screen in one API call
<img src="http://res.cloudinary.com/tamizhvendan/image/upload/v1450775641/API_Gateway.png" alt="API Gateway" /></p>

    <p>This approach is called API Gateway. It is one of the commonly used <a href="http://microservices.io/patterns/apigateway.html">patterns in the microservices</a> world.</p>
  </li>
</ul>

<h2 id="rx">Rx</h2>

<p>API Gateway is normally implemented using <a href="http://reactivex.io/">Rx</a>. Rx, an implementation of <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">Functional Reactive Programming</a>, makes it easy to implement this kind of problems by enable us to think each asynchronous operation as streams (aka Observables). These streams offer a declarative API to work with the asynchronous operations.</p>

<p>In the implementation that we are going to see, we will be using <a href="http://fsprojects.github.io/FSharp.Control.Reactive/">FSharp.Control.Reactive</a>, an extension and wrapper for using the Reactive Extensions (Rx) with F#</p>

<h2 id="project-structure">Project Structure</h2>

<p>Create a new F# Console Application Project with the name <code>RxFsharp</code> and then create the files mentioned below in the given order</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class=""><span class="line">RxFsharp
</span><span class="line">|--Http.fs --&gt; Abstraction to make http requests
</span><span class="line">|--GitHub.fs --&gt; Define data types, transforming &amp; parsing of responses from GitHub
</span><span class="line">|--ObservableExtensions.fs --&gt; Some Util methods over Rx Observable
</span><span class="line">|--Profile.fs --&gt; Implemention of API Gateway using Rx
</span><span class="line">|--ApiGateway.fs --&gt; Suave API
</span><span class="line">|--Program.fs --&gt; Entry Point
</span><span class="line">|--user.json --&gt; Sample response of GitHub user API
</span><span class="line">|--repos.json --&gt; Sample response of GitHub repos API
</span><span class="line">|--App.config
</span><span class="line">|--packages.config</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then install the following NuGet packages</p>

<ul>
  <li><a href="https://www.nuget.org/packages/FSharp.Control.Reactive">FSharp.Control.Reactive</a></li>
  <li><a href="https://www.nuget.org/packages/Http.fs">Http.fs</a></li>
  <li><a href="https://www.nuget.org/packages/Suave">Suave</a></li>
  <li><a href="https://www.nuget.org/packages/Newtonsoft.Json">Newtonsoft.Json</a></li>
  <li><a href="https://www.nuget.org/packages/FSharp.Data">FSharp.Data</a></li>
</ul>

<h2 id="modeling-http-request--response-as-stream">Modeling Http Request &amp; Response as Stream</h2>

<p>In Functional Reactive Programming(FRP) every action is treated as stream. So, first step in implementing an API Gateway is modeling each HTTP request&amp;response as stream.</p>

<p>Open <code>Http.fs</code> file and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Http</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">HttpClient</span>
</span><span class="line"><span class="k">open</span> <span class="nn">FSharp.Control.Reactive</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">HttpResponse</span> <span class="o">=</span>
</span><span class="line"><span class="o">|</span> <span class="n">Ok</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class="line"><span class="o">|</span> <span class="n">Error</span> <span class="k">of</span> <span class="n">int</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">getResponseAsync</span> <span class="n">url</span> <span class="o">=</span>
</span><span class="line">  <span class="n">async</span> <span class="o">{</span>
</span><span class="line">    <span class="k">let!</span> <span class="nv">response</span> <span class="o">=</span>
</span><span class="line">      <span class="n">createRequest</span> <span class="n">Get</span> <span class="n">url</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="n">withHeader</span> <span class="o">(</span><span class="n">UserAgent</span> <span class="s">&quot;FsharpRx&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">HttpClient</span><span class="p">.</span><span class="n">getResponseAsync</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">httpResponse</span> <span class="o">=</span>
</span><span class="line">      <span class="k">match</span> <span class="n">response</span><span class="o">.</span><span class="n">StatusCode</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="mi">200</span> <span class="o">-&gt;</span> <span class="n">response</span><span class="o">.</span><span class="n">EntityBody</span><span class="o">.</span><span class="n">Value</span> <span class="o">|&gt;</span> <span class="n">Ok</span>
</span><span class="line">      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">response</span><span class="o">.</span><span class="n">StatusCode</span> <span class="o">|&gt;</span> <span class="n">Error</span>
</span><span class="line">    <span class="k">return</span> <span class="n">httpResponse</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">asyncResponseToObservable</span> <span class="o">=</span> <span class="n">getResponseAsync</span> <span class="o">&gt;&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">ofAsync</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>getResponseAsync</code> function makes use of <a href="https://github.com/relentless/Http.fs">Http.fs</a>, an HTTP Client library for F#, to fire the HTTP GET request and returns the HTTP response asynchronously.</p>

<p>The HTTP response has been modeled as either <code>Ok</code> with the response content for all the responses with the status code <code>200</code> and everything else is treated as <code>Error</code> for simplicity.</p>

<p>In the final line, we create a stream (aka Observable) from asynchronous response using the function <code>Observable.ofAsync</code> from <a href="https://github.com/fsprojects/FSharp.Control.Reactive">FSharp.Control.Reactive</a></p>

<p>As all the GitHub API <a href="https://developer.github.com/v3/#user-agent-required">requests require user agent</a>, we are adding one before firing the request.</p>

<h2 id="parsing-and-transforming-github-api-responses">Parsing and Transforming GitHub API Responses</h2>

<p>Upon successful response from GitHub, the next step is parsing the JSON response and transforming the parsed response as per the Profile screen requirements.</p>

<p>To parse the response, we are going to leverage the powerful tool of FSharp called <a href="http://fsharp.github.io/FSharp.Data/library/JsonProvider.html">JsonTypeProvider</a></p>

<p>The JSON Type Provider provides statically typed access to JSON documents. It takes a sample document as an input. Here in our case, it is user.json and repos.json</p>

<p>Get the sample response from GitHub using its <a href="https://api.github.com/users/tamizhvendan">User API</a> and <a href="https://api.github.com/users/tamizhvendan/repos">Repos API</a> and save the response in user.json and repos.json respectively.</p>

<p>With the help of JsonTypeProvider, we can now easily parse the raw JSON response to its equivalent types in just a few lines of code in <code>GitHub.fs</code>!</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">GitHub</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">Http</span>
</span><span class="line"><span class="k">open</span> <span class="nn">FSharp.Data</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">GitHubUser</span> <span class="o">=</span> <span class="n">JsonProvider</span><span class="o">&lt;</span><span class="s">&quot;user.json&quot;</span><span class="o">&gt;</span>
</span><span class="line"><span class="k">type</span> <span class="nc">GitHubUserRepos</span> <span class="o">=</span> <span class="n">JsonProvider</span><span class="o">&lt;</span><span class="s">&quot;repos.json&quot;</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">parseUser</span> <span class="o">=</span> <span class="nn">GitHubUser</span><span class="p">.</span><span class="n">Parse</span>
</span><span class="line"><span class="k">let</span> <span class="nv">parseUserRepos</span> <span class="o">=</span> <span class="nn">GitHubUserRepos</span><span class="p">.</span><span class="n">Parse</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As <code>GitHub.fs</code> is an abstraction of GitHub let’s put their URLs also here in the same file</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">host</span> <span class="o">=</span> <span class="s">&quot;https://api.github.com&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">userUrl</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s">&quot;%s/users/%s&quot;</span> <span class="n">host</span>
</span><span class="line"><span class="k">let</span> <span class="nv">reposUrl</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s">&quot;%s/users/%s/repos&quot;</span> <span class="n">host</span>
</span><span class="line"><span class="k">let</span> <span class="nv">languagesUrl</span> <span class="n">repoName</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s">&quot;%s/repos/%s/%s/languages&quot;</span> <span class="n">host</span> <span class="n">userName</span> <span class="n">repoName</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have used <a href="http://fsharpforfunandprofit.com/posts/partial-application">partial application</a> of function <code>sprintf</code> in the <code>userUrl</code> and <code>reposUrl</code> function here, so both of these functions take username as its parameter implicitly</p>

<p>The JSON response of <a href="https://api.github.com/repos/tamizhvendan/fsharp-phonecat/languages">languages</a> API is little tricky to parse as its keys are dynamic. The type provider will work only if the underlying response has a fixed schema. So, we can’t use the type provider directly to parse the response of languages API.</p>

<p>We are going to use the inbuilt <a href="http://fsharp.github.io/FSharp.Data/library/JsonValue.html">JSON Parser</a> available with JsonTypeProvider to parse the languages response</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">parseLanguages</span> <span class="n">languagesJson</span> <span class="o">=</span>
</span><span class="line">  <span class="n">languagesJson</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">JsonValue</span><span class="p">.</span><span class="n">Parse</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">JsonExtensions</span><span class="p">.</span><span class="n">Properties</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="n">fst</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>JsonValue.Parse</code> parses the raw string JSON to a type called <code>JsonValue</code> and the <code>JsonExtensions.Properties</code> function takes a <code>JsonValue</code> and returns the key and value pairs of all the properties in the JSON as tuples. As we are interested only in the Keys here, we just pluck that value alone using the function <code>fst</code></p>

<p>Great! Now we are done with parsing the JSON response of all the three APIs and creating it’s equivalent types. The next step is doing some business transformation</p>

<p>One of the requirements of the Profile Screen is that we need to show only the top 3 popular repositories based on the stars received by the repository. Let’s implement it</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">popularRepos</span> <span class="o">(</span><span class="n">repos</span> <span class="o">:</span> <span class="nn">GitHubUserRepos</span><span class="p">.</span><span class="n">Root</span> <span class="bp">[]</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">ownRepos</span> <span class="o">=</span> <span class="n">repos</span> <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">repo</span> <span class="o">-&gt;</span> <span class="ow">not</span> <span class="n">repo</span><span class="o">.</span><span class="n">Fork</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">takeCount</span> <span class="o">=</span> <span class="k">if</span> <span class="n">ownRepos</span><span class="o">.</span><span class="n">Length</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">then</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">repos</span><span class="o">.</span><span class="n">Length</span>
</span><span class="line">
</span><span class="line">  <span class="n">ownRepos</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sortBy</span> <span class="o">(</span><span class="k">fun</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="n">r</span><span class="o">.</span><span class="n">StargazersCount</span><span class="o">)</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">toSeq</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">take</span> <span class="n">takeCount</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toArray</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In the <code>Http.fs</code> file, we defined how to get the raw JSON response using Stream as <code>HttpResponse</code> (<code>Ok</code> &amp; <code>Error</code>) and in this <code>GitHub.fs</code>, we have defined how to parse this raw JSON response and transform them its equivalent strongly types.</p>

<p>The final step is integrating both these logic and return the Output record type needed by the Profile Screen</p>

<p>let’s start by defining the Profile type</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Profile</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">AvatarUrl</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">PopularRepositories</span> <span class="o">:</span> <span class="n">Repository</span> <span class="n">seq</span>
</span><span class="line"><span class="o">}</span> <span class="ow">and</span> <span class="n">Repository</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Stars</span> <span class="o">:</span> <span class="n">int</span>
</span><span class="line">  <span class="n">Languages</span> <span class="o">:</span> <span class="kt">string</span><span class="bp">[]</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Then write functions to get the value from <code>HttpResponse</code> and create this profile output.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">reposResponseToPopularRepos</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">  <span class="o">|</span><span class="n">Ok</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">r</span> <span class="o">|&gt;</span> <span class="n">parseUserRepos</span> <span class="o">|&gt;</span> <span class="n">popularRepos</span>
</span><span class="line">  <span class="o">|_</span> <span class="o">-&gt;</span> <span class="o">[||]</span>
</span><span class="line">
</span><span class="line"><span class="c1">// Languages always associated with a repository</span>
</span><span class="line"><span class="k">let</span> <span class="nv">languageResponseToRepoWithLanguages</span> <span class="o">(</span><span class="n">repo</span> <span class="o">:</span> <span class="nn">GitHubUserRepos</span><span class="p">.</span><span class="n">Root</span><span class="o">)</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">  <span class="o">|</span><span class="n">Ok</span><span class="o">(</span><span class="n">l</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">Name</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span> <span class="n">Languages</span> <span class="o">=</span> <span class="o">(</span><span class="n">parseLanguages</span> <span class="n">l</span><span class="o">);</span> <span class="n">Stars</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">StargazersCount</span><span class="o">}</span>
</span><span class="line">  <span class="o">|_</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">Name</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span> <span class="n">Languages</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">empty</span><span class="o">;</span> <span class="n">Stars</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">StargazersCount</span><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">toProfile</span>  <span class="o">=</span> <span class="k">function</span>
</span><span class="line">  <span class="o">|</span><span class="n">Ok</span><span class="o">(</span><span class="n">u</span><span class="o">),</span> <span class="n">repos</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">parseUser</span> <span class="n">u</span>
</span><span class="line">      <span class="o">{</span><span class="n">Name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span> <span class="n">PopularRepositories</span> <span class="o">=</span> <span class="n">repos</span><span class="o">;</span> <span class="n">AvatarUrl</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">AvatarUrl</span><span class="o">}</span> <span class="o">|&gt;</span> <span class="n">Some</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>All the above functions except <code>toProfile</code> take <code>HttpResponse</code> as its last parameter implicitly.</p>

<p>In <code>reposResponseToPopularRepos</code> function, if the repos API request is successful, we parse the response to its equivalent type and then pick only three of them based on star count and in the case of an error we just return an empty array.</p>

<p>The <code>languageResponseToRepoWithLanguages</code> function handles the response from the Languages API request which takes its associated repository as its first parameter. If the response is successful, then it creates the <code>Repository</code> record with the returned languages else it just the <code>Repository</code> record with an empty array for languages.</p>

<p>The last function <code>toProfile</code> is a merge function which takes a tuple of <code>HttpResponse</code> (of User API request) and <code>Repository []</code> and creates a <code>Profile</code> record if the response is successful. In case of an error, it just returns <code>None</code></p>

<p><em>Note: To keep this blog post simple, I am handling the errors using empty arrays and None. It can be extended using <a href="http://fsharpforfunandprofit.com/rop/">ROP</a></em></p>

<h2 id="implementing-api-gateway">Implementing API Gateway</h2>

<p>Let me quickly summarize what we have done so far. We have created two abstractions.</p>

<ul>
  <li><code>Http</code> - Responsible for firing the HTTP GET request with the given URL and give the response as a Rx Stream</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="n">URL</span>
</span><span class="line">  <span class="err">\</span>
</span><span class="line"><span class="o">----------</span><span class="n">Response</span><span class="o">--|</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li><code>GitHub</code> - Takes care of parsing the JSON response from GitHub API and does some business logic (finding top 3 popular repositories). Then returns the output in the format that the Client needs.</li>
</ul>

<p>With the help of these abstractions now we are going to build the API Gateway to get the profile object.</p>

<p>Open <code>Gateway.fs</code> and add the <code>getProfile</code> function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">//string -&gt; Async&lt;Profile&gt;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">getProfile</span> <span class="n">username</span> <span class="o">=</span>
</span><span class="line">  <span class="n">async</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// TODO</span>
</span><span class="line">    <span class="k">return</span><span class="o">!</span> <span class="n">profile</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>It is just a skeleton which just describes the what function does. Let’s start its implementation.</p>

<p>In Rx world, everything is a stream. So, the first step is converting GitHub User API request to stream</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getProfile</span> <span class="n">username</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userStream</span> <span class="o">=</span> <span class="n">username</span> <span class="o">|&gt;</span> <span class="n">userUrl</span> <span class="o">|&gt;</span> <span class="n">asyncResponseToObservable</span>
</span><span class="line">  <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We have created the <code>userStream</code> using the <code>userUrl</code> and <code>asyncResponseToObservable</code> function defined earlier.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="n">userURL</span>
</span><span class="line">  <span class="err">\</span>
</span><span class="line"><span class="o">-----------</span><span class="n">UJ</span><span class="o">--|</span>              <span class="c1">// UJ - GitHub User Response in JSON format</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then we need top three popular repositories as a stream</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getProfile</span> <span class="n">username</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">popularReposStream</span> <span class="o">=</span>
</span><span class="line">    <span class="n">username</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">reposUrl</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">asyncResponseToObservable</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="n">reposResponseToPopularRepos</span>
</span><span class="line">  <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Except the last line, everything is same as that of creating <code>userStream</code>. If you check <a href="https://api.github.com/users/tamizhvendan/repos">GitHub repos API</a> it just returns all the repos associated with the given username. But what we need is only top three of them based on the number of stars it has received.</p>

<p>We already have a function <code>reposResponseToPopularRepos</code> in <code>GitHub.fs</code> which does the job of picking the top three repos from the raw JSON. As the response is in the form Rx stream, we need to get the value from the stream and then we need to apply this function and that’s what the <code>Observable.map</code> does. It is very similar to <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Array/map">Array.map</a> and <a href="https://msdn.microsoft.com/en-us/library/system.linq.enumerable.select(v=vs.100).aspx">LINQ Select</a></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="n">reposURL</span>
</span><span class="line">  <span class="err">\</span>
</span><span class="line"><span class="o">----------</span><span class="n">RJ</span><span class="o">---|</span>                          <span class="c1">// RJ - GitHub user repos in JSON format</span>
</span><span class="line">          <span class="o">|</span> <span class="n">MAP</span> <span class="k">function</span> <span class="o">(</span><span class="n">RJ</span> <span class="o">-&gt;</span> <span class="n">PR</span><span class="o">)</span>       <span class="c1">// PR - Popular Repos</span>
</span><span class="line">          <span class="n">V</span>
</span><span class="line"><span class="o">--------------</span><span class="n">PR</span><span class="o">---|</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The next operation is a little complex. i.e. finding out the programming languages being used in these popular repositories. To get this GitHub API, we need to fire three separate requests to the <a href="https://developer.github.com/v3/repos/#list-languages">Languages API</a> for each repository and then merge the results back with the corresponding repository.</p>

<p>To implement this with the help of Rx streams, we need to understand the <code>flatMap</code> <a href="http://reactivex.io/documentation/operators/flatmap.html">function of Rx</a>.</p>

<p>It is similar to the <code>map</code> function that we have seen before with a difference that it takes a function that returns a new item stream instead of a new item.</p>

<h3 id="map">Map</h3>

<p><img src="http://reactivex.io/documentation/operators/images/map.c.png" alt="Map" /></p>

<p>The <code>map</code> function has the following signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">(</span><span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="flatmap">FlatMap</h3>

<p><img src="http://reactivex.io/documentation/operators/images/flatMap.c.png" alt="FlatMap" /></p>

<p>The <code>flatMap</code> function has the following signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">(</span><span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;)</span> <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This function is also called as <code>bind</code> function in the functional programming world. If you would like to know further on this topic, I strongly recommend <a href="http://fsharpforfunandprofit.com/posts/elevated-world">this blog series</a> by the fsharp great, <a href="https://twitter.com/ScottWlaschin">Scott Wlaschin</a></p>

<p>Back to the problem in hand, we need to fire three HTTP GET Requests to get back the languages associated with the each of the top three popular repos. In terms of the <code>flatMap</code> function, it boils down to three functions of the following syntax</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">(</span><span class="nn">GitHubUserRepos</span><span class="p">.</span><span class="n">Root</span> <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="n">Repostiory</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="nn">GitHubUserRepos</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="n">Repostiory</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We can implement the solution using three <code>flatMap</code> functions using the above syntax. But, we can make it more granular by creating a new variant of <code>flatMap</code> function to achieve this in a more straightforward way.</p>

<p>The ideal function that we are looking for in this <code>flatMap</code> variant holds the following signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">(</span><span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;)</span> <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span> <span class="bp">[]</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">b</span> <span class="bp">[]</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>i.e three <code>flatMap</code> can be rewritten as</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">(</span><span class="nn">GitHubUserRepos</span><span class="p">.</span><span class="n">Root</span> <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="n">Repostiory</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="nn">GitHubUserRepos</span><span class="p">.</span><span class="n">Root</span> <span class="bp">[]</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="n">Repostiory</span> <span class="bp">[]</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Let’s name it as <code>flatMap2</code> and add the implementation of it in the file <code>ObservableExtensions.fs</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">ObservableExtensions</span>
</span><span class="line"><span class="k">open</span> <span class="nn">FSharp.Control.Reactive</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">flatmap2</span> <span class="n">f</span> <span class="n">observable</span> <span class="o">=</span>
</span><span class="line">  <span class="n">observable</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">flatmap</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="n">f</span> <span class="o">&gt;&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">mergeArray</span><span class="o">)</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">toArray</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here is the representation of what this function does</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">-----</span><span class="n">X</span><span class="o">[</span><span class="n">n</span><span class="o">]--------------------------|-&gt;</span>
</span><span class="line">      <span class="err">\</span>   <span class="n">flatMap</span> <span class="n">on</span> <span class="n">each</span> <span class="n">item</span> <span class="k">in</span> <span class="n">X</span> <span class="n">which</span> <span class="k">yield</span> <span class="n">the</span> <span class="n">stream</span> <span class="k">of</span> <span class="n">R</span>
</span><span class="line"><span class="o">-------</span><span class="n">R1</span><span class="o">-------------------------|-&gt;</span>
</span><span class="line"><span class="o">----------</span><span class="n">R2</span><span class="o">----------------------|-&gt;</span>
</span><span class="line">          <span class="o">......</span>
</span><span class="line"><span class="o">-------------</span><span class="n">Rn</span><span class="o">-------------------|-&gt;</span>
</span><span class="line">          <span class="o">||</span>  <span class="n">mergeArray</span> <span class="o">-&gt;</span> <span class="n">merge</span> <span class="n">array</span> <span class="k">of</span> <span class="n">R</span> <span class="n">streams</span> <span class="n">into</span> <span class="n">one</span> <span class="n">stream</span>
</span><span class="line">          <span class="n">VV</span>
</span><span class="line"><span class="o">------</span><span class="n">R1</span><span class="o">-</span><span class="n">R2</span><span class="o">--</span><span class="n">Rn</span><span class="o">-------------------|-&gt;</span>
</span><span class="line">              <span class="err">\</span> <span class="n">toArray</span> <span class="o">-&gt;</span> <span class="n">Creates</span> <span class="n">an</span> <span class="n">array</span> <span class="n">from</span> <span class="n">an</span> <span class="n">observable</span> <span class="n">sequence</span>
</span><span class="line"><span class="o">-------------</span><span class="n">R</span><span class="o">[</span><span class="n">n</span><span class="o">]-----------------|-&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It’s hard to get it right in a single shot. So, let’s see it in detail step by step by applying it to our use case here</p>

<ul>
  <li>We have the stream of three popular repos (i.e array of repos)</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">-----</span><span class="n">X</span><span class="o">[</span><span class="n">n</span><span class="o">]--------------------------|-&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<ul>
  <li>To get the languages associated with the each repo we need to call the languages API for every repo item in the above step</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">-----</span><span class="n">X</span><span class="o">[</span><span class="n">n</span><span class="o">]--------------------------|-&gt;</span>
</span><span class="line">      <span class="err">\</span>   <span class="n">flatMap</span> <span class="n">on</span> <span class="n">each</span> <span class="n">item</span> <span class="k">in</span> <span class="n">X</span> <span class="n">which</span> <span class="k">yield</span> <span class="n">the</span> <span class="n">n</span> <span class="n">streams</span> <span class="k">of</span> <span class="n">R</span>
</span><span class="line"><span class="o">-------</span><span class="n">R1</span><span class="o">-------------------------|-&gt;</span>
</span><span class="line"><span class="o">----------</span><span class="n">R2</span><span class="o">----------------------|-&gt;</span>
</span><span class="line">          <span class="o">......</span>
</span><span class="line"><span class="o">-------------</span><span class="n">Rn</span><span class="o">-------------------|-&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<ul>
  <li>After we received the response from each languages API call, we need to merge them into one stream</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">-------</span><span class="n">R1</span><span class="o">-------------------------|-&gt;</span>
</span><span class="line"><span class="o">----------</span><span class="n">R2</span><span class="o">----------------------|-&gt;</span>
</span><span class="line">          <span class="o">......</span>
</span><span class="line"><span class="o">-------------</span><span class="n">Rn</span><span class="o">-------------------|-&gt;</span>
</span><span class="line">          <span class="o">|</span>  <span class="n">mergeArray</span> <span class="o">-&gt;</span> <span class="n">merge</span> <span class="n">array</span> <span class="k">of</span> <span class="n">R</span> <span class="n">streams</span> <span class="n">into</span> <span class="n">one</span> <span class="n">stream</span>
</span><span class="line">          <span class="n">V</span>
</span><span class="line"><span class="o">------</span><span class="n">R1</span><span class="o">-</span><span class="n">R2</span><span class="o">--</span><span class="n">Rn</span><span class="o">-------------------|-&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>To integrate this with the expected application response, we need all the responses in a single go</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">------</span><span class="n">R1</span><span class="o">-</span><span class="n">R2</span><span class="o">--</span><span class="n">Rn</span><span class="o">-------------------|-&gt;</span>
</span><span class="line">              <span class="err">\</span> <span class="n">toArray</span> <span class="o">-&gt;</span> <span class="n">Creates</span> <span class="n">an</span> <span class="n">array</span> <span class="n">from</span> <span class="n">an</span> <span class="n">observable</span> <span class="n">sequence</span>
</span><span class="line"><span class="o">-------------</span><span class="n">R</span><span class="o">[</span><span class="n">n</span><span class="o">]-----------------|-&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Great! You got it right!!</p>

<p>Let’s use this <code>flatMap2</code> function and complete the implementation of profile API gateway.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getProfile</span> <span class="n">username</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">toRepoWithLanguagesStream</span> <span class="o">(</span><span class="n">repo</span> <span class="o">:</span> <span class="nn">GitHubUserRepos</span><span class="p">.</span><span class="n">Root</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">username</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">languagesUrl</span> <span class="n">repo</span><span class="o">.</span><span class="n">Name</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">asyncResponseToObservable</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">languageResponseToRepoWithLanguages</span> <span class="n">repo</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">popularReposStream</span> <span class="o">=</span>
</span><span class="line">    <span class="n">username</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">reposUrl</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">asyncResponseToObservable</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="n">reposResponseToPopularRepos</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">flatmap2</span> <span class="n">toRepoWithLanguagesStream</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>flatmap2</code> function takes the function <code>toRepoWithLanguagesStream</code> which converts the <code>GitHubUserRepos.Root</code> type to <code>IObservable&lt;Repository&gt;</code> to find out the languages associated with the given popular repositories.</p>

<p>The <code>toRepoWithLanguagesStream</code> function does the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="nn">GitHubUserRepos</span><span class="p">.</span><span class="n">Root</span>
</span><span class="line">  <span class="err">\</span> <span class="n">create</span> <span class="n">a</span> <span class="n">languages</span> <span class="n">GitHub</span> <span class="n">API</span> <span class="n">stream</span> <span class="n">using</span> <span class="n">the</span> <span class="n">repo</span> <span class="n">name</span> <span class="n">from</span> <span class="n">the</span> <span class="n">input</span>
</span><span class="line"><span class="o">-------</span><span class="n">LR</span><span class="o">----------|</span>              <span class="c1">// LR - languages GitHub API response</span>
</span><span class="line">        <span class="err">\</span> <span class="n">MAP</span> <span class="k">function</span> <span class="o">(</span><span class="nn">GitHubUserRepos</span><span class="p">.</span><span class="n">Root</span> <span class="o">-&gt;</span> <span class="n">LR</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="o">)</span>
</span><span class="line"><span class="o">------------</span><span class="n">R</span><span class="o">------|</span>              <span class="c1">// R - Repository type that defined earlier</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>Observable.map</code> function takes only one input, but here we need to two inputs. So, With the help of <a href="http://fsharpforfunandprofit.com/posts/partial-application/">partial application</a>, we created an intermediate function by partially applying the first parameter alone</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">languageResponseToRepoWithLanguages</span> <span class="n">repo</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>languageResponseToRepoWithLanguages</code> function has been already defined in the <code>GitHub.fs</code> file.</p>

<p>The last step of the <code>getProfile</code> function is combining this <code>popularReposStream</code> with the <code>userStream</code> created earlier and return the <code>Profile</code> type asynchronously.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getProfile</span> <span class="n">username</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="n">async</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span><span class="o">!</span> <span class="n">popularReposStream</span>
</span><span class="line">            <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">zip</span> <span class="n">userStream</span>
</span><span class="line">            <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="n">toProfile</span>
</span><span class="line">            <span class="o">|&gt;</span> <span class="nn">TaskObservableExtensions</span><span class="p">.</span><span class="n">ToTask</span>
</span><span class="line">            <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="n">AwaitTask</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Observable.zip</code> function takes two streams as its input, then merges the output of each stream and return the output as a tuple. From this tuple, we have used <code>Observable.map</code> function to map it a <code>Profile</code> type using the <code>toProfile</code> function created earlier in <code>GitHub.fs</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">-----</span><span class="n">UR</span><span class="o">-------------|</span>     <span class="c1">// UR - GitHub User API Response</span>
</span><span class="line"><span class="o">--------</span><span class="n">PR</span><span class="o">----------|</span>     <span class="c1">// PR - Popular Repos</span>
</span><span class="line">        <span class="err">\</span> <span class="n">ZIP</span> <span class="k">function</span> <span class="o">(</span><span class="n">UR</span> <span class="o">-&gt;</span> <span class="n">PR</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">UR</span><span class="o">,</span><span class="n">PR</span><span class="o">))</span>
</span><span class="line"><span class="o">---------(</span><span class="n">UR</span><span class="o">,</span><span class="n">PR</span><span class="o">)----|</span>
</span><span class="line">          <span class="err">\</span> <span class="n">MAP</span> <span class="o">(</span> <span class="o">(</span><span class="n">UR</span><span class="o">,</span><span class="n">PR</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">P</span> <span class="o">)</span>  <span class="c1">// P - Profile</span>
</span><span class="line"><span class="o">----------</span><span class="n">P</span><span class="o">---------|</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The last functions <code>TaskObservableExtensions.ToTask</code> and <code>Async.AwaitTask</code> does the conversion of <code>IObservable</code> to <code>async</code> by converting it to a <code>Task</code> first and then the <code>Task</code> to <code>async</code></p>

<p>The final <code>getProfile</code> function will be like</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getProfile</span> <span class="n">username</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">userStream</span> <span class="o">=</span> <span class="n">username</span> <span class="o">|&gt;</span> <span class="n">userUrl</span> <span class="o">|&gt;</span> <span class="n">asyncResponseToObservable</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">toRepoWithLanguagesStream</span> <span class="o">(</span><span class="n">repo</span> <span class="o">:</span> <span class="nn">GitHubUserRepos</span><span class="p">.</span><span class="n">Root</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">username</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">languagesUrl</span> <span class="n">repo</span><span class="o">.</span><span class="n">Name</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">asyncResponseToObservable</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">languageResponseToRepoWithLanguages</span> <span class="n">repo</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">popularReposStream</span> <span class="o">=</span>
</span><span class="line">    <span class="n">username</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">reposUrl</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">asyncResponseToObservable</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="n">reposResponseToPopularRepos</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">flatmap2</span> <span class="n">toRepoWithLanguagesStream</span>
</span><span class="line">
</span><span class="line">  <span class="n">async</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span><span class="o">!</span> <span class="n">popularReposStream</span>
</span><span class="line">            <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">zip</span> <span class="n">userStream</span>
</span><span class="line">            <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="n">toProfile</span>
</span><span class="line">            <span class="o">|&gt;</span> <span class="nn">TaskObservableExtensions</span><span class="p">.</span><span class="n">ToTask</span>
</span><span class="line">            <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="n">AwaitTask</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This function is a testimonial on <em>How functional programming helps to write less, robust, and readable code to solve a complex problem</em></p>

<p>We have handled all the five HTTP requests asynchronously, did some error handling (by returning empty types), and finally efficiently combined outputs of these five HTTP requests and created a type to send back to the client. Everything is asynchronous!</p>

<p>Pretty awesome isn’t it?</p>

<h2 id="exposing-the-api">Exposing the API</h2>

<p>The final step is exposing what we have done so far as an API to the outside world. We are going to implement this using <a href="https://suave.io/">Suave</a></p>

<p>Open <code>ApiGateway.fs</code> file and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">JSON</span> <span class="n">v</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">jsonSerializerSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonSerializerSettings</span><span class="bp">()</span>
</span><span class="line">  <span class="n">jsonSerializerSettings</span><span class="o">.</span><span class="n">ContractResolver</span> <span class="o">&lt;-</span> <span class="k">new</span> <span class="n">CamelCasePropertyNamesContractResolver</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="nn">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">jsonSerializerSettings</span><span class="o">)</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="n">OK</span>
</span><span class="line">  <span class="o">&gt;=&gt;</span> <span class="nn">Writers</span><span class="p">.</span><span class="n">setMimeType</span> <span class="s">&quot;application/json; charset=utf-8&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">getProfile</span> <span class="n">userName</span> <span class="o">(</span><span class="n">httpContext</span> <span class="o">:</span> <span class="n">HttpContext</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">   <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">profile</span> <span class="o">=</span> <span class="n">getProfile</span> <span class="n">userName</span>
</span><span class="line">      <span class="k">match</span> <span class="n">profile</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Some</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="o">!</span> <span class="n">JSON</span> <span class="n">p</span> <span class="n">httpContext</span>
</span><span class="line">      <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="o">!</span> <span class="n">NOT_FOUND</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s">&quot;Username %s not found&quot;</span> <span class="n">userName</span><span class="o">)</span> <span class="n">httpContext</span>
</span><span class="line">   <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>JSON</code> is a utility function (WebPart in the world of Suave) which takes any type, serialize it to JSON format and return it as JSON HTTP response.</p>

<p>The <code>getProfile</code> function is the API WebPart which calls our backend API gateway implementation and pass the received response to the <code>JSON</code> WebPart defined before.</p>

<p>In case if there is no profile available (Remember? we return empty types in case of errors), we just return <code>404</code> with the message that the given username is not found.</p>

<p>Then update the <code>Program.fs</code> to write the web server code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="nv">main</span> <span class="n">argv</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">webpart</span> <span class="o">=</span> <span class="n">pathScan</span> <span class="s">&quot;/api/profile/%s&quot;</span> <span class="nn">ApiGateway</span><span class="p">.</span><span class="n">getProfile</span>
</span><span class="line">  <span class="n">startWebServer</span> <span class="n">defaultConfig</span> <span class="n">webpart</span>
</span><span class="line">  <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Thanks to <code>Suave</code> for it’s lightweight and low-ceremony offerings in creating an API. We just exposed it in two lines!</p>

<p>Hit <code>F5</code> and access the API at <code>http://localhost:8083/api/profile/{github-username}</code> Bingo!!</p>

<h2 id="summary">Summary</h2>

<blockquote>
  <p>A language that doesn’t affect the way you think about programming is not worth knowing - Alan Perils</p>
</blockquote>

<p>The above quote summarizes the gist of this blog post. Functional Programming will help you think better. You can get the source code associated with the blog post in my <a href="https://github.com/tamizhvendan/blog-samples/tree/master/RxFsharp">blog-samples GitHub repository</a></p>

<p>Wish you a happy and prosperous new year</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A beginner's guide to setup React.js environment using npm, Babel 6 and Webpack]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/11/23/a-beginner-guide-to-setup-react-dot-js-environment-using-babel-6-and-webpack/"/>
    <updated>2015-11-23T16:12:30+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/11/23/a-beginner-guide-to-setup-react-dot-js-environment-using-babel-6-and-webpack</id>
    <content type="html"><![CDATA[<p>Facebook has really changed the way we think about front-end UI development with the introduction of <a href="https://facebook.github.io/react">React</a>. One of the main advantages of this component based approach is, it is easy to reason about as the view is just a function of props and state.</p>

<p>Though, the learning curve of React is smaller compared to that of its counterparts, one intimidating aspect for the beginners is the tools (<a href="http://babeljs.io">Babel</a>, <a href="https://webpack.github.io">Webpack</a>) and libraries around it.</p>

<p>In fact, these tools are not required to use React and but in order to get the most out of the features of <a href="https://github.com/lukehoban/es6features">ES6</a>, <a href="https://facebook.github.io/react/docs/jsx-in-depth.html">JSX</a> and bundling, we need them. In this blog post we are going to see how to setup a React development environment without being sidetracked by the tools.</p>

<p>A Disclaimer: The approach that I am going to share is just for beginners to understand on how to get started with React as going by this lean way has helped a lot when I started learning React.</p>

<h2 id="lets-start-from-scratch">Let’s start from scratch</h2>

<p>Create a new folder ‘react-hello-world’ and initialize it with npm.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">mkdir react-hello-world
</span><span class="line">cd react-hello-world
</span><span class="line">npm init</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Accept the default for all the prompts</p>

<h2 id="installing-and-configuring-webpack">Installing and Configuring Webpack</h2>

<p><a href="https://webpack.github.io">Webpack</a> is a module bundler which takes modules with dependencies and generates static assets by bundling them together based on some configuration.</p>

<p>The support of <a href="http://webpack.github.io/docs/loaders.html">loaders</a> in Webpack makes it a perfect fit for using it along with React and we will discuss it later in this post with more details.</p>

<p>Let’s start with installing webpack using npm</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">npm i webpack -S</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Webpack requires some configuration settings to carry out its work and the best practice is doing it via a config file called <em>webpack.config.js</em>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">touch webpack.config.js</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Update the config file as follows</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="kd">var</span> <span class="nx">webpack</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;webpack&#39;</span><span class="p">);</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="kd">var</span> <span class="nx">BUILD_DIR</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;src/client/public&#39;</span><span class="p">);</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">APP_DIR</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;src/client/app&#39;</span><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">entry</span><span class="o">:</span> <span class="nx">APP_DIR</span> <span class="o">+</span> <span class="s1">&#39;/index.jsx&#39;</span><span class="p">,</span>
</span><span class="line">  <span class="nx">output</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">path</span><span class="o">:</span> <span class="nx">BUILD_DIR</span><span class="p">,</span>
</span><span class="line">    <span class="nx">filename</span><span class="o">:</span> <span class="s1">&#39;bundle.js&#39;</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="p">};</span>
</span><span class="line">
</span><span class="line"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">config</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The minimalist requirement of a Webpack config file is the presence of entry and output properties.</p>

<p>The <code>APP_DIR</code> holds the directory path of the React application’s codebase and the <code>BUILD_DIR</code> represents the directory path of the bundle file output.</p>

<p>As the name suggests <em>entry</em> specifies the entry file using which the bundling process starts. If you are coming from C# or Java, it’s similar to the class that contains <em>main</em> method. Webpack supports multiple entry points too. Here the <em>index.jsx</em> in the <em>src/client/app</em> directory is the starting point of the application</p>

<p>The <em>output</em> instructs Webpack what to do after the bundling process has been completed. Here, we are instructing it to use the <em>src/client/public</em> directory to output the bundled file with the name <em>bundle.js</em></p>

<p>Let’s create the <em>index.jsx</em> file in the <em>./src/client/app</em> and add the following code to verify this configuration.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Hello World!&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now in the terminal run the following command</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="p">.</span><span class="o">/</span><span class="nx">node_modules</span><span class="o">/</span><span class="p">.</span><span class="nx">bin</span><span class="o">/</span><span class="nx">webpack</span> <span class="o">-</span><span class="nx">d</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The above command runs the webpack in the development mode and generates the <em>bundle.js</em> file and its associated map file <em>bundle.js.map</em> in the <em>src/client/public</em> directory.</p>

<p>To make it more interactive, create an <em>index.html</em> file in the <em>src/client</em> directory and modify it to use this <em>bundle.js</em> file</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;html&gt;</span>
</span><span class="line">  <span class="nt">&lt;head&gt;</span>
</span><span class="line">    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class="line">    <span class="nt">&lt;title&gt;</span>React.js using NPM, Babel6 and Webpack<span class="nt">&lt;/title&gt;</span>
</span><span class="line">  <span class="nt">&lt;/head&gt;</span>
</span><span class="line">  <span class="nt">&lt;body&gt;</span>
</span><span class="line">    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;app&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;public/bundle.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class="line">  <span class="nt">&lt;/body&gt;</span>
</span><span class="line"><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now if you open the browser, you can see the <em>Hello World!</em> in the console log.</p>

<p>Note: There is a webpack loader called <a href="https://github.com/webpack/html-loader">html-loader</a> which automatically creates this html file with the correct location of <em>bundle.js</em>.   </p>

<h2 id="setting-up-babel-loader">Setting Up Babel-Loader</h2>

<p>As we have seen in the beginning, by using JSX and ES6 we can be more productive while working with React. But the JSX syntax and ES6, are not supported in all the browsers.</p>

<p>Hence, if we are using them in the React code, we need to use a tool which translates them to the format that has been supported by the browsers. It’s where <a href="http://babeljs.io">babel</a> comes into the picture.</p>

<p>While installing Webpack we touched a little on loaders. Webpack uses loaders to translate the file before bundling them</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/react-hello-world/babel-loader.png" /></p>

<p>To setup install the following npm packages</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="html"><span class="line">npm i babel-loader babel-preset-es2015 babel-preset-react -S
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <em>babel-preset-es2015</em> and <em>babel-preset-react</em> are plugins being used by the <em>babel-loader</em> to translate ES6 and JSX syntax respectively.</p>

<p>As we did for Webpack, <em>babel-loader</em> also requires some configuration. Here we need to tell it to use the ES6 and JSX plugins.</p>

<p>Create a .babelrc file and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="html"><span class="line">touch .babelrc
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="p">{</span>
</span><span class="line">  <span class="s2">&quot;presets&quot;</span> <span class="o">:</span> <span class="p">[</span><span class="s2">&quot;es2015&quot;</span><span class="p">,</span> <span class="s2">&quot;react&quot;</span><span class="p">]</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The next step is telling Webpack to use the babel-loader while bundling the files</p>

<p>open <em>webpack.config.js</em> file and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="c1">// Existing Code ....</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// Existing Code ....</span>
</span><span class="line">  <span class="nx">module</span> <span class="o">:</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">loaders</span> <span class="o">:</span> <span class="p">[</span>
</span><span class="line">      <span class="p">{</span>
</span><span class="line">        <span class="nx">test</span> <span class="o">:</span> <span class="sr">/\.jsx?/</span><span class="p">,</span>
</span><span class="line">        <span class="nx">include</span> <span class="o">:</span> <span class="nx">APP_DIR</span><span class="p">,</span>
</span><span class="line">        <span class="nx">loader</span> <span class="o">:</span> <span class="s1">&#39;babel&#39;</span>
</span><span class="line">      <span class="p">}</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <em>loaders</em> property takes array of loaders, here we are just using <em>babel-loader</em>. Each <em>loader</em> property should specify what are the file extension it has to process via the <em>test</em> property. Here we have configured it to process both <em>.js</em> and <em>.jsx</em> files using the regular expression. The <em>include</em> property specifies what is the directory to be used to look for these file extensions. The <em>loader</em> property represents the name of the loader.</p>

<p>Now we all the setup done. Let’s write some code in React.</p>

<h2 id="hello-react">Hello React</h2>

<p>Use npm to install react and react-dom</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="nx">npm</span> <span class="nx">i</span> <span class="nx">react</span> <span class="nx">react</span><span class="o">-</span><span class="nx">dom</span> <span class="o">-</span><span class="nx">S</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Replace the existing console.log statement in the <em>index.jsx</em> with the following content</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
</span><span class="line"><span class="kr">import</span> <span class="p">{</span><span class="nx">render</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;react-dom&#39;</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="kr">class</span> <span class="nx">App</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">render</span> <span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span> <span class="nx">Hello</span> <span class="nx">React</span><span class="o">!&lt;</span><span class="err">/p&gt;;</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">App</span><span class="o">/&gt;</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then run the following command to update the bundle file with the new changes</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="p">.</span><span class="o">/</span><span class="nx">node_modules</span><span class="o">/</span><span class="p">.</span><span class="nx">bin</span><span class="o">/</span><span class="nx">webpack</span> <span class="o">-</span><span class="nx">d</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now, if you open the <em>index.html</em> in the browser you can see <em>Hello React</em></p>

<h2 id="adding-some-complexity">Adding Some Complexity</h2>

<h3 id="making-webpack-to-watch-the-changes">Making Webpack to watch the changes</h3>

<p>Running the webpack command on every time when you change the file is not a productive work. We can easily change this behavior by using the following command</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="p">.</span><span class="o">/</span><span class="nx">node_modules</span><span class="o">/</span><span class="p">.</span><span class="nx">bin</span><span class="o">/</span><span class="nx">webpack</span> <span class="o">-</span><span class="nx">d</span> <span class="o">--</span><span class="nx">watch</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Now Webpack is running in the watch mode, which will automatically bundle the file whenever there is a change detected. To test it, change <em>Hello React</em> to something else and refresh the <em>index.html</em> in the browser. You can see your new changes.</p>

<p>If you don’t like refreshing the browser to see the changes you can use <a href="http://gaearon.github.io/react-hot-loader/getstarted/">react-hot-loader</a>!</p>

<h3 id="using-npm-as-a-tool-runner">Using npm as a tool runner</h3>

<p>The command <code>./node_modules/.bin/webpack</code> can be made even simpler by leveraging npm.</p>

<p>Update the packages.json as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">    <span class="s2">&quot;dev&quot;</span><span class="o">:</span> <span class="s2">&quot;webpack -d --watch&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="s2">&quot;build&quot;</span> <span class="o">:</span> <span class="s2">&quot;webpack -p&quot;</span>
</span><span class="line">  <span class="p">},</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now the command <code>npm run build</code> runs Webpack in production mode, which minimizes the bundle file automatically and<br />
the command <code>npm run dev</code> runs the Webpack in the watch mode.</p>

<h3 id="adding-some-files">Adding some files</h3>

<p>In the sample we have seen only one Component called <em>App</em>. Let’s add some more to test the bundling setup.</p>

<p>Create a new file <em>AwesomeComponent.jsx</em> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="kr">class</span> <span class="nx">AwesomeComponent</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class="line">
</span><span class="line">  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
</span><span class="line">    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span><span class="nx">likesCount</span> <span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
</span><span class="line">    <span class="k">this</span><span class="p">.</span><span class="nx">onLike</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onLike</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="nx">onLike</span> <span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="kd">let</span> <span class="nx">newLikesCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">likesCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class="line">    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="nx">likesCount</span><span class="o">:</span> <span class="nx">newLikesCount</span><span class="p">});</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="p">(</span>
</span><span class="line">      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span><span class="line">        <span class="nx">Likes</span> <span class="o">:</span> <span class="o">&lt;</span><span class="nx">span</span><span class="o">&gt;</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">likesCount</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/span&gt;</span>
</span><span class="line">        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">onLike</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">Like</span> <span class="nx">Me</span><span class="o">&lt;</span><span class="err">/button&gt;&lt;/div&gt;</span>
</span><span class="line">      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class="line">    <span class="p">);</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kr">export</span> <span class="k">default</span> <span class="nx">AwesomeComponent</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then include it in the <em>index.jsx</em> file</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kr">import</span> <span class="nx">AwesomeComponent</span> <span class="nx">from</span> <span class="s1">&#39;./AwesomeComponent.jsx&#39;</span><span class="p">;</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kr">class</span> <span class="nx">App</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="p">(</span>
</span><span class="line">      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
</span><span class="line">        <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span> <span class="nx">Hello</span> <span class="nx">React</span><span class="o">!&lt;</span><span class="err">/p&gt;</span>
</span><span class="line">        <span class="o">&lt;</span><span class="nx">AwesomeComponent</span> <span class="o">/&gt;</span>
</span><span class="line">      <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class="line">    <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>`</p>

<p>If your Webpack is already running in watch mode then refresh the browser to see the AwesomeComponent in action!</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/react-hello-world/Output.png" /></p>

<h2 id="summary">Summary</h2>

<p>In this blog post we have seen a lean approach for setting up a development environment to work with React. In the next blog post we will be extending this example to implement the <a href="https://facebook.github.io/react/docs/flux-overview.html">flux</a> architecture using <a href="http://alt.js.org">Alt</a>. You can get the source code associated with this blog post can be found in my <a href="https://github.com/tamizhvendan/blog-samples/tree/master/react-hello-world">github repository</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Creating Mock API server in fsharp using Suave]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/07/23/creating-mock-api-server-in-fsharp-using-suave/"/>
    <updated>2015-07-23T16:56:20+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/07/23/creating-mock-api-server-in-fsharp-using-suave</id>
    <content type="html"><![CDATA[<p>As part of the current assignment in my day job, I am working in a web application which integrates with an another web application via web APIs. The backend calls the exposed web APIs and does some business logic. Due to some technical limitations, we are not able to setup a development environment of the Web APIs so we have decided to create a mock API server during the development and replace it with the real one in the production.</p>

<p>Since it’s just a mock API server, we don’t want to spend much time on it. Thanks to the awesome light-weight fsharp library <a href="http://suave.io/">Suave</a> we have made it in just 15 minutes!</p>

<p>In this blog post, I will be sharing how we have achieved it. As a sample, we will mock the <a href="https://developer.GitHub.com/v3/">GitHub API</a>.</p>

<h2 id="getting-started">Getting Started</h2>

<p>Create a new fsharp console application project “GitHubMockApiServer” in Visual Studio and install the <a href="https://www.nuget.org/packages/Suave/">suave</a> nuget package.</p>

<p>To keep it short we are going to mock only two GitHub APIs</p>

<ul>
  <li><a href="https://developer.GitHub.com/v3/users/#get-a-single-user">Get a single user</a> - <strong>/users/:username</strong></li>
  <li><a href="https://developer.GitHub.com/v3/repos/#list-user-repositories">List user repositories</a> - <strong>/users/:username/repos</strong></li>
</ul>

<h2 id="creating-the-mock-apis">Creating the mock APIs</h2>

<p>The first step is getting the sample response for these APIs and save them in separate JSON files. In this example, I’ve created these using my GitHub username and added to the project as below.</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/suave_mock_api/project.png" /></p>

<p>After adding, change the “Copy to Output Directory” property of the both the files to “Copy always”</p>

<p>Open the <strong>Program.fs</strong> and update it as follows</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">open</span> <span class="nn">Suave</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Operators</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Successful</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Filters</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.IO</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="nv">main</span> <span class="n">argv</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">json</span> <span class="n">fileName</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">content</span> <span class="o">=</span> <span class="nn">File</span><span class="p">.</span><span class="n">ReadAllText</span> <span class="n">fileName</span>
</span><span class="line">    <span class="n">content</span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">).</span><span class="n">Replace</span><span class="o">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">,</span><span class="s">&quot;&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">OK</span> <span class="o">&gt;=&gt;</span> <span class="nn">Writers</span><span class="p">.</span><span class="n">setMimeType</span> <span class="s">&quot;application/json&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">pathScan</span> <span class="s">&quot;/users/%s&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s">&quot;User.json&quot;</span> <span class="o">|&gt;</span> <span class="n">json</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">repos</span> <span class="o">=</span> <span class="n">pathScan</span> <span class="s">&quot;/users/%s/repos&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s">&quot;Repos.json&quot;</span> <span class="o">|&gt;</span> <span class="n">json</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">mockApi</span> <span class="o">=</span> <span class="n">choose</span> <span class="o">[</span><span class="n">repos</span><span class="o">;</span><span class="n">user</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="n">startWebServer</span> <span class="n">defaultConfig</span> <span class="n">mockApi</span>
</span><span class="line">  <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Short and Sweet! Now you can hit this mock GitHub APIs without worrying about its <a href="https://developer.GitHub.com/v3/#rate-limiting">rate limits</a></p>

<p>The <code>json</code> function reads the sample JSON file, then removes the line breaks and return the HTTP 200 response with the content type as  “application/json”</p>

<p>The nice DSL in suave enabled us to configure the routes without giving much works to our hands :-)  </p>

<h2 id="mock-apis-in-action">Mock APIs in action</h2>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/suave_mock_api/user_api.png" /></p>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/suave_mock_api/repos_api.png" /></p>

<h2 id="summary">Summary</h2>

<p>This work is inspired by Scott Wlaschin’s blog post series on <a href="http://fsharpforfunandprofit.com/series/low-risk-ways-to-use-fsharp-at-work.html">Low-risk ways to use F# at work</a>. I am glad to find one more low-risk way to use F# at work and I believe it would help you in future. You can find the sample code in my <a href="https://github.com/tamizhvendan/blog-samples/tree/master/GithubMockApiServer">blog-samples GitHub repository</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Securing APIs in Suave using JSON Web Token]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/07/15/securing-apis-in-suave-using-json-web-token/"/>
    <updated>2015-07-15T12:04:12+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/07/15/securing-apis-in-suave-using-json-web-token</id>
    <content type="html"><![CDATA[<p>In the <a href="http://blog.tamizhvendan.in/blog/2015/06/11/building-rest-api-in-fsharp-using-suave/">last blog post</a>, we have seen how we can combine small functions to create a REST API in Suave and in this blog post we are going to see how can we secure the APIs using JSON web tokens(JWT).</p>

<p>This blog post is based on <a href="http://bitoftech.net/">Taiseer’s</a> blog post on <a href="http://bitoftech.net/2014/10/27/json-web-token-asp-net-web-api-2-jwt-owin-authorization-server/">JSON Web Token in ASP.NET Web API 2 using Owin</a> and I will be covering how to implement the same in <a href="http://suave.io">Suave</a>. If you are interested in the theoretical background of JWT, kindly read his blog post before reading this.</p>

<h2 id="workflow">Workflow</h2>

<p>The typical workflow of JWT based application would look like this</p>

<ol>
  <li>New Audience (Resource Server) gets registered with Authorization Server.</li>
  <li>Get the JWT access token from Authorization Server by passing Client Id of the resource server and login credentials</li>
  <li>Use the access token obtained above to get access to the secured resources in the resource server</li>
</ol>

<p>We are going to see how to implement all these three steps in this blog post</p>

<h2 id="project-setup">Project Setup</h2>

<p>Create an empty visual studio solution and add new projects with the following name</p>

<ul>
  <li>SuaveJwt - A fsharp library project which contains all the JWT related things</li>
  <li>SuaveJwt.AuthServerHost - A fsharp console application which is going to host the authorization server</li>
  <li>Audience1 - A fsharp console application representing the resource server 1   </li>
  <li>Audience2 - A fsharp console application representing the resource server 2   </li>
</ul>

<p>After creating, install the following NuGet packages</p>

<ul>
  <li><a href="https://www.nuget.org/packages/Suave/">Suave</a> in all the four projects</li>
  <li><a href="https://www.nuget.org/packages/Newtonsoft.Json/">Newtonsoft.Json</a> and <a href="https://www.nuget.org/packages/System.IdentityModel.Tokens.Jwt/">JSON Web Token Handler</a> in <em>SuaveJwt</em></li>
</ul>

<p>Then add reference the .NET framework library <strong>System.IdentityModel</strong> in all the four projects from GAC and then add a reference to the <strong>SuaveJwt</strong> project library in all the other three projects.</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/suave_jwt/project_structure.png" /></p>

<h2 id="new-audience-registration">New Audience Registration</h2>

<p>As we have seen in the workflow, the first step is to enable an audience to register itself with the authorization server. Let’s begin by defining the business logic.</p>

<p>Add a new source file <em>JwtToken.fs</em> in the <strong>SuaveJwt</strong> project and update it as follows</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Audience</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">ClientId</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Secret</span> <span class="o">:</span> <span class="n">Base64String</span>
</span><span class="line">  <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="c1">// string -&gt; Audience</span>
</span><span class="line"><span class="k">let</span> <span class="nv">createAudience</span> <span class="n">audienceName</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">clientId</span> <span class="o">=</span> <span class="nn">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="bp">()</span><span class="o">.</span><span class="n">ToString</span><span class="o">(</span><span class="s">&quot;N&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">zeroCreate</span> <span class="mi">32</span>
</span><span class="line">  <span class="nn">RNGCryptoServiceProvider</span><span class="p">.</span><span class="n">Create</span><span class="bp">()</span><span class="o">.</span><span class="n">GetBytes</span><span class="o">(</span><span class="n">data</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">secret</span> <span class="o">=</span> <span class="n">data</span> <span class="o">|&gt;</span> <span class="nn">Base64String</span><span class="p">.</span><span class="n">create</span>
</span><span class="line">  <span class="o">{</span><span class="n">ClientId</span> <span class="o">=</span> <span class="n">clientId</span><span class="o">;</span> <span class="n">Secret</span> <span class="o">=</span> <span class="n">secret</span><span class="o">;</span> <span class="n">Name</span> <span class="o">=</span>  <span class="n">audienceName</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The above snippet creates an audience record with a random client id and secret key. The secret key is of type <a href="https://en.wikipedia.org/wiki/Base64#URL_applications">base64 URL encoded</a> string. This type doesn’t exist, so let’s create it.</p>

<p>Add a new source file <em>Encodings.fs</em> in the <strong>SuaveJwt</strong> project and add this type</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Base64String</span> <span class="o">=</span> <span class="k">private</span> <span class="n">Base64String</span> <span class="k">of</span> <span class="kt">string</span> <span class="k">with</span>
</span><span class="line">
</span><span class="line">  <span class="k">static</span> <span class="k">member</span> <span class="n">decode</span> <span class="o">(</span><span class="n">base64String</span> <span class="o">:</span> <span class="n">Base64String</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="o">(</span><span class="n">Base64String</span> <span class="n">text</span><span class="o">)</span> <span class="o">=</span> <span class="n">base64String</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pad</span> <span class="n">text</span> <span class="o">=</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">padding</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="o">((</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">text</span> <span class="o">+</span> <span class="mi">3</span><span class="o">)</span> <span class="o">%</span> <span class="mi">4</span><span class="o">)</span>
</span><span class="line">      <span class="k">if</span> <span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">text</span> <span class="k">else</span> <span class="o">(</span><span class="n">text</span> <span class="o">+</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="sc">&#39;=&#39;</span><span class="o">,</span> <span class="n">padding</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">    <span class="nn">Convert</span><span class="p">.</span><span class="n">FromBase64String</span><span class="o">(</span><span class="n">pad</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="sc">&#39;-&#39;</span><span class="o">,</span> <span class="sc">&#39;+&#39;</span><span class="o">).</span><span class="n">Replace</span><span class="o">(</span><span class="sc">&#39;_&#39;</span><span class="o">,</span> <span class="sc">&#39;/&#39;</span><span class="o">)))</span>
</span><span class="line">
</span><span class="line">  <span class="k">static</span> <span class="k">member</span> <span class="n">create</span> <span class="n">data</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">Convert</span><span class="p">.</span><span class="n">ToBase64String</span><span class="o">(</span><span class="n">data</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">TrimEnd</span><span class="o">(</span><span class="sc">&#39;=&#39;</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="sc">&#39;+&#39;</span><span class="o">,</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span>
</span><span class="line">      <span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="sc">&#39;/&#39;</span><span class="o">,</span> <span class="sc">&#39;_&#39;</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">Base64String</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">  <span class="k">static</span> <span class="k">member</span> <span class="n">fromString</span> <span class="o">=</span> <span class="n">Base64String</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">ToString</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="o">(</span><span class="n">Base64String</span> <span class="n">str</span><span class="o">)</span> <span class="o">=</span> <span class="n">this</span>
</span><span class="line">    <span class="n">str</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To keep things simple, I haven’t added any validations here. The next step is to create a Suave <em>WebPart</em> to expose the audience create functionality.</p>

<p>Add a new source file <em>AuthServer.fs</em> in the <strong>SuaveJwt</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">AudienceCreateRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">AudienceCreateResponse</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">ClientId</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Base64Secret</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Config</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">AddAudienceUrlPath</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">SaveAudience</span> <span class="o">:</span> <span class="n">Audience</span> <span class="o">-&gt;</span> <span class="n">Async</span><span class="o">&lt;</span><span class="n">Audience</span><span class="o">&gt;</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">audienceWebPart</span> <span class="n">config</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">toAudienceCreateResponse</span> <span class="o">(</span><span class="n">audience</span> <span class="o">:</span> <span class="n">Audience</span><span class="o">)</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Base64Secret</span> <span class="o">=</span> <span class="n">audience</span><span class="o">.</span><span class="n">Secret</span><span class="o">.</span><span class="n">ToString</span><span class="bp">()</span>
</span><span class="line">    <span class="n">ClientId</span> <span class="o">=</span> <span class="n">audience</span><span class="o">.</span><span class="n">ClientId</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">=</span> <span class="n">audience</span><span class="o">.</span><span class="n">Name</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">tryCreateAudience</span> <span class="o">(</span><span class="n">ctx</span><span class="o">:</span> <span class="n">HttpContext</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">mapJsonPayload</span><span class="o">&lt;</span><span class="n">AudienceCreateRequest</span><span class="o">&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="n">request</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="n">audienceCreateRequest</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="n">async</span> <span class="o">{</span>
</span><span class="line">          <span class="k">let!</span> <span class="nv">audience</span> <span class="o">=</span>
</span><span class="line">            <span class="n">audienceCreateRequest</span><span class="o">.</span><span class="n">Name</span> <span class="o">|&gt;</span> <span class="n">createAudience</span> <span class="o">|&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">SaveAudience</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">audienceCreateResponse</span> <span class="o">=</span> <span class="n">toAudienceCreateResponse</span> <span class="n">audience</span>
</span><span class="line">          <span class="k">return</span><span class="o">!</span> <span class="n">JSON</span> <span class="n">audienceCreateResponse</span> <span class="n">ctx</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="n">BAD_REQUEST</span> <span class="s">&quot;Invalid Audience Create Request&quot;</span> <span class="n">ctx</span>
</span><span class="line">
</span><span class="line">  <span class="n">path</span> <span class="n">config</span><span class="o">.</span><span class="n">AddAudienceUrlPath</span> <span class="o">&gt;=&gt;</span> <span class="n">POST</span> <span class="o">&gt;=&gt;</span> <span class="n">tryCreateAudience</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>audienceWebPart</code> function retrieves the <code>AudienceCreateRequest</code> from the JSON request payload and creates a new audience.<br />
To make it independent of the host, we have externalized the hosting functionality using the <code>Config</code> record type.</p>

<p>The <code>mapJsonPayload</code> and <code>JSON</code> functions serialize and deserialize JSON objects across the wire respectively. These functions are not part of Suave, so let’s add them</p>

<p>Add a new source file <em>SuaveJson.fs</em> in the <strong>SuaveJwt</strong> project and add these functions</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">JSON</span> <span class="n">v</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">jsonSerializerSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonSerializerSettings</span><span class="bp">()</span>
</span><span class="line">  <span class="n">jsonSerializerSettings</span><span class="o">.</span><span class="n">ContractResolver</span> <span class="o">&lt;-</span> <span class="k">new</span> <span class="n">CamelCasePropertyNamesContractResolver</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="nn">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">jsonSerializerSettings</span><span class="o">)</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="n">OK</span>
</span><span class="line">  <span class="o">&gt;=&gt;</span> <span class="nn">Writers</span><span class="p">.</span><span class="n">setMimeType</span> <span class="s">&quot;application/json; charset=utf-8&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">mapJsonPayload</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">(</span><span class="n">req</span> <span class="o">:</span> <span class="n">HttpRequest</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">fromJson</span> <span class="n">json</span> <span class="o">=</span>
</span><span class="line">    <span class="k">try</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">obj</span> <span class="o">=</span> <span class="nn">JsonConvert</span><span class="p">.</span><span class="n">DeserializeObject</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;)</span> <span class="o">:?&gt;</span> <span class="k">&#39;</span><span class="n">a</span>
</span><span class="line">      <span class="n">Some</span> <span class="kt">obj</span>
</span><span class="line">    <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getString</span> <span class="n">rawForm</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">System</span><span class="p">.</span><span class="nn">Text</span><span class="p">.</span><span class="nn">Encoding</span><span class="p">.</span><span class="nn">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="o">(</span><span class="n">rawForm</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">req</span><span class="o">.</span><span class="n">rawForm</span> <span class="o">|&gt;</span> <span class="n">getString</span> <span class="o">|&gt;</span> <span class="n">fromJson</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The next step is hosting this audience web part.</p>

<p>Open the <em>Program.fs</em> file in the <strong>SuaveJwt.AuthServerHost</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">authorizationServerConfig</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">AddAudienceUrlPath</span> <span class="o">=</span> <span class="s">&quot;/api/audience&quot;</span>
</span><span class="line">  <span class="n">SaveAudience</span> <span class="o">=</span> <span class="nn">AudienceStorage</span><span class="p">.</span><span class="n">saveAudience</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="k">let</span> <span class="nv">audienceWebPart</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">audienceWebPart</span> <span class="n">authorizationServerConfig</span>
</span><span class="line"><span class="n">startWebServer</span> <span class="n">defaultConfig</span> <span class="n">audienceWebPart&#39;</span>
</span><span class="line"><span class="mi">0</span> <span class="c1">// return an integer exit code</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It is a straight forward self-host suave server program which exposes the audience web part.</p>

<p>The <em>AudienceStorage</em> is responsible for storing the created audiences and to add it create a new source file <em>AudienceStorage.fs</em> in the <strong>SuaveJwt.AuthServerHost</strong> project and add these functions</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">AudienceStorage</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">audienceStorage</span>
</span><span class="line">  <span class="o">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="n">Audience</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">saveAudience</span> <span class="o">(</span><span class="n">audience</span> <span class="o">:</span> <span class="n">Audience</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">audienceStorage</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">audience</span><span class="o">.</span><span class="n">ClientId</span><span class="o">,</span> <span class="n">audience</span><span class="o">)</span>
</span><span class="line">    <span class="n">audience</span> <span class="o">|&gt;</span> <span class="n">async</span><span class="o">.</span><span class="n">Return</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>To keep this simple, we are using in-memory dictionary here and it can be easily replaced with any data store</p>

<p>Now we have everything to create a new audience. So, let’s run the <strong>SuaveJwt.AuthServerHost</strong> application and verify</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/suave_jwt/audience_create.png" /></p>

<p>Keep a note of this <em>clientId</em> and <em>base64Secret</em> as we will be using them while defining the resource server (“Audience1” in this case).</p>

<h2 id="generating-access-token">Generating Access Token</h2>

<p>After registering an audience with the authorization server, the next step is to get the access token to access the resources in the given resource server.</p>

<p>Let’s begin by defining the business logic to create an access token.</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/suave_jwt/createToken.png" /></p>

<p>Open <em>JwtToken.fs</em> and add the following types</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">TokenCreateRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Issuer</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">UserName</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Password</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">TokenTimeSpan</span> <span class="o">:</span> <span class="n">TimeSpan</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">IdentityStore</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">getClaims</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">Async</span><span class="o">&lt;</span><span class="n">Claim</span> <span class="n">seq</span><span class="o">&gt;</span>
</span><span class="line">  <span class="n">isValidCredentials</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">Async</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>
</span><span class="line">  <span class="n">getSecurityKey</span> <span class="o">:</span> <span class="n">Base64String</span> <span class="o">-&gt;</span> <span class="n">SecurityKey</span>
</span><span class="line">  <span class="n">getSigningCredentials</span> <span class="o">:</span> <span class="n">SecurityKey</span> <span class="o">-&gt;</span> <span class="n">SigningCredentials</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Token</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">AccessToken</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">ExpiresIn</span> <span class="o">:</span> <span class="kt">float</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>These types are generic abstractions which decouple the token creation part from the underlying host.</p>

<p>The <code>TokenCreateRequest</code> models the underlying issuer and token lifetime.</p>

<p>The <code>IdentityStore</code> represents a generic data store in which the identity information has been stored and it also provides the security key and the signing credentials to protect the access token from misuse.</p>

<p>With these types in place let’s add the <code>createToken</code> function in the <em>SuaveJwt.fs</em> file</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">createToken</span> <span class="n">tokenCreateRequest</span> <span class="n">identityStore</span> <span class="n">audience</span> <span class="o">=</span>
</span><span class="line">  <span class="n">async</span> <span class="o">{</span>
</span><span class="line">    <span class="k">let!</span> <span class="nv">isValidCredentials</span> <span class="o">=</span>
</span><span class="line">      <span class="n">identityStore</span><span class="o">.</span><span class="n">isValidCredentials</span> <span class="n">tokenCreateRequest</span><span class="o">.</span><span class="n">UserName</span> <span class="n">tokenCreateRequest</span><span class="o">.</span><span class="n">Password</span>
</span><span class="line">    <span class="k">if</span> <span class="n">isValidCredentials</span> <span class="k">then</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">signingCredentials</span> <span class="o">=</span>
</span><span class="line">        <span class="o">(</span><span class="n">identityStore</span><span class="o">.</span><span class="n">getSecurityKey</span> <span class="o">&gt;&gt;</span> <span class="n">identityStore</span><span class="o">.</span><span class="n">getSigningCredentials</span><span class="o">)</span> <span class="n">audience</span><span class="o">.</span><span class="n">Secret</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">issuedOn</span> <span class="o">=</span> <span class="n">Nullable</span> <span class="nn">DateTime</span><span class="p">.</span><span class="n">UtcNow</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">expiresBy</span> <span class="o">=</span> <span class="n">Nullable</span> <span class="o">(</span><span class="nn">DateTime</span><span class="p">.</span><span class="nn">UtcNow</span><span class="p">.</span><span class="n">Add</span><span class="o">(</span><span class="n">tokenCreateRequest</span><span class="o">.</span><span class="n">TokenTimeSpan</span><span class="o">))</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">claims</span> <span class="o">=</span>  <span class="n">identityStore</span><span class="o">.</span><span class="n">getClaims</span> <span class="n">tokenCreateRequest</span><span class="o">.</span><span class="n">UserName</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">jwtSecurityToken</span> <span class="o">=</span>
</span><span class="line">        <span class="k">new</span> <span class="n">JwtSecurityToken</span><span class="o">(</span><span class="n">tokenCreateRequest</span><span class="o">.</span><span class="n">Issuer</span><span class="o">,</span> <span class="n">audience</span><span class="o">.</span><span class="n">ClientId</span><span class="o">,</span> <span class="n">claims</span><span class="o">,</span> <span class="n">issuedOn</span><span class="o">,</span> <span class="n">expiresBy</span><span class="o">,</span> <span class="n">signingCredentials</span><span class="o">)</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JwtSecurityTokenHandler</span><span class="bp">()</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">accessToken</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">WriteToken</span><span class="o">(</span><span class="n">jwtSecurityToken</span><span class="o">)</span>
</span><span class="line">      <span class="k">return</span> <span class="n">Some</span> <span class="o">{</span><span class="n">AccessToken</span> <span class="o">=</span> <span class="n">accessToken</span><span class="o">;</span> <span class="n">ExpiresIn</span> <span class="o">=</span> <span class="n">tokenCreateRequest</span><span class="o">.</span><span class="n">TokenTimeSpan</span><span class="o">.</span><span class="n">TotalSeconds</span><span class="o">}</span>
</span><span class="line">    <span class="k">else</span> <span class="k">return</span> <span class="n">None</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>createToken</code> function checks the validness of the login credentials. If it is valid, then it get the claims associated with the given username and creates a <em>JwtToken</em> using the <a href="https://www.nuget.org/packages/System.IdentityModel.Tokens.Jwt/">JSON Web Token Handler</a> library, else it returns <code>None</code></p>

<p>Now we have got the backend business logic ready, let’s expose it as a suave <em>WebPart</em></p>

<p>Open <em>AuthServer.fs</em> and add a new record type for the incoming token create request and update <code>Config</code> and <code>audienceWebPart</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">TokenCreateCredentials</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">UserName</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Password</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">ClientId</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Config</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="c1">// ... existing fields ...</span>
</span><span class="line">  <span class="n">CreateTokenUrlPath</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">GetAudience</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">Async</span><span class="o">&lt;</span><span class="n">Audience</span> <span class="n">option</span><span class="o">&gt;</span>
</span><span class="line">  <span class="n">Issuer</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">TokenTimeSpan</span> <span class="o">:</span> <span class="n">TimeSpan</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">audienceWebPart</span> <span class="n">config</span> <span class="n">identityStore</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// ... existing functions ...</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">tryCreateToken</span> <span class="o">(</span><span class="n">ctx</span><span class="o">:</span> <span class="n">HttpContext</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">mapJsonPayload</span><span class="o">&lt;</span><span class="n">TokenCreateCredentials</span><span class="o">&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="n">request</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="n">tokenCreateCredentials</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">async</span> <span class="o">{</span>
</span><span class="line">        <span class="k">let!</span> <span class="nv">audience</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">GetAudience</span> <span class="n">tokenCreateCredentials</span><span class="o">.</span><span class="n">ClientId</span>
</span><span class="line">        <span class="k">match</span> <span class="n">audience</span> <span class="k">with</span>
</span><span class="line">        <span class="o">|</span> <span class="n">Some</span> <span class="n">audience</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="k">let</span> <span class="nv">tokenCreateRequest</span> <span class="o">:</span> <span class="n">TokenCreateRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">              <span class="n">Issuer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Issuer</span>
</span><span class="line">              <span class="n">UserName</span> <span class="o">=</span> <span class="n">tokenCreateCredentials</span><span class="o">.</span><span class="n">UserName</span>
</span><span class="line">              <span class="n">Password</span> <span class="o">=</span> <span class="n">tokenCreateCredentials</span><span class="o">.</span><span class="n">Password</span>
</span><span class="line">              <span class="n">TokenTimeSpan</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">TokenTimeSpan</span>
</span><span class="line">            <span class="o">}</span>
</span><span class="line">            <span class="k">let!</span> <span class="nv">token</span> <span class="o">=</span> <span class="n">createToken</span> <span class="n">tokenCreateRequest</span> <span class="n">identityStore</span> <span class="n">audience</span>
</span><span class="line">            <span class="k">match</span> <span class="n">token</span> <span class="k">with</span>
</span><span class="line">            <span class="o">|</span> <span class="n">Some</span> <span class="n">token</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="o">!</span> <span class="n">JSON</span> <span class="n">token</span> <span class="n">ctx</span>
</span><span class="line">            <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="o">!</span> <span class="n">BAD_REQUEST</span> <span class="s">&quot;Invalid Login Credentials&quot;</span> <span class="n">ctx</span>
</span><span class="line">
</span><span class="line">        <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="o">!</span> <span class="n">BAD_REQUEST</span> <span class="s">&quot;Invalid Client Id&quot;</span> <span class="n">ctx</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="n">BAD_REQUEST</span> <span class="s">&quot;Invalid Token Create Request&quot;</span> <span class="n">ctx</span>
</span><span class="line">
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="n">path</span> <span class="n">config</span><span class="o">.</span><span class="n">AddAudienceUrlPath</span> <span class="o">&gt;=&gt;</span> <span class="n">POST</span> <span class="o">&gt;=&gt;</span> <span class="n">tryCreateAudience</span>
</span><span class="line">    <span class="n">path</span> <span class="n">config</span><span class="o">.</span><span class="n">CreateTokenUrlPath</span> <span class="o">&gt;=&gt;</span> <span class="n">POST</span> <span class="o">&gt;=&gt;</span> <span class="n">tryCreateToken</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>tryCreateToken</code> function checks whether the <code>ClientId</code> is a registered audience or not, if it exists, then this function creates a token using the <code>createToken</code> function defined above otherwise it returns the <code>BAD_REQUST</code> <em>WebPart</em> with the appropriate error message.</p>

<p>The final change is modifying the <em>Program.fs</em> and <em>AudienceStorage.fs</em> files in the <strong>SuaveJwt.AuthServerHost</strong> to expose this <em>WebPart</em>.</p>

<p><strong>Program.fs</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">authorizationServerConfig</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">AddAudienceUrlPath</span> <span class="o">=</span> <span class="s">&quot;/api/audience&quot;</span>
</span><span class="line">  <span class="n">CreateTokenUrlPath</span> <span class="o">=</span> <span class="s">&quot;/oauth2/token&quot;</span>
</span><span class="line">  <span class="n">SaveAudience</span> <span class="o">=</span> <span class="nn">AudienceStorage</span><span class="p">.</span><span class="n">saveAudience</span>
</span><span class="line">  <span class="n">GetAudience</span> <span class="o">=</span> <span class="nn">AudienceStorage</span><span class="p">.</span><span class="n">getAudience</span>
</span><span class="line">  <span class="n">Issuer</span> <span class="o">=</span> <span class="s">&quot;http://localhost:8083/suave&quot;</span>
</span><span class="line">  <span class="n">TokenTimeSpan</span> <span class="o">=</span> <span class="nn">TimeSpan</span><span class="p">.</span><span class="n">FromMinutes</span><span class="o">(</span><span class="mi">1</span><span class="o">.)</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">identityStore</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">getClaims</span> <span class="o">=</span> <span class="nn">IdentityStore</span><span class="p">.</span><span class="n">getClaims</span>
</span><span class="line">  <span class="n">isValidCredentials</span> <span class="o">=</span> <span class="nn">IdentityStore</span><span class="p">.</span><span class="n">isValidCredentials</span>
</span><span class="line">  <span class="n">getSecurityKey</span> <span class="o">=</span> <span class="nn">KeyStore</span><span class="p">.</span><span class="n">securityKey</span>
</span><span class="line">  <span class="n">getSigningCredentials</span> <span class="o">=</span> <span class="nn">KeyStore</span><span class="p">.</span><span class="n">hmacSha256</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">audienceWebPart</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">audienceWebPart</span> <span class="n">authorizationServerConfig</span> <span class="n">identityStore</span>
</span><span class="line">
</span><span class="line"><span class="n">startWebServer</span> <span class="n">defaultConfig</span> <span class="n">audienceWebPart&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>AudienceStorage.fs</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getAudience</span> <span class="n">clientId</span> <span class="o">=</span>
</span><span class="line">  <span class="k">if</span> <span class="n">audienceStorage</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">clientId</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">    <span class="n">Some</span> <span class="n">audienceStorage</span><span class="o">.[</span><span class="n">clientId</span><span class="o">]</span> <span class="o">|&gt;</span> <span class="n">async</span><span class="o">.</span><span class="n">Return</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="n">None</span> <span class="o">|&gt;</span> <span class="n">async</span><span class="o">.</span><span class="n">Return</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <em>KeyStore</em> and <em>IdentityStore</em> do not exists, so let’s add them</p>

<p>Add <em>KeyStore.fs</em> in the <strong>SuaveJwt</strong> project and it provide the in-memory symmetric security key based on <a href="https://en.wikipedia.org/wiki/Hash-based_message_authentication_code">HMAC</a></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">KeyStore</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.IdentityModel.Tokens</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Encodings</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">securityKey</span> <span class="n">sharedKey</span> <span class="o">:</span> <span class="n">SecurityKey</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">symmetricKey</span> <span class="o">=</span> <span class="n">sharedKey</span> <span class="o">|&gt;</span> <span class="nn">Base64String</span><span class="p">.</span><span class="n">decode</span>
</span><span class="line">  <span class="k">new</span> <span class="n">InMemorySymmetricSecurityKey</span><span class="o">(</span><span class="n">symmetricKey</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">SecurityKey</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">hmacSha256</span> <span class="n">secretKey</span> <span class="o">=</span>
</span><span class="line">  <span class="k">new</span> <span class="n">SigningCredentials</span><span class="o">(</span><span class="n">secretKey</span><span class="o">,</span><span class="nn">SecurityAlgorithms</span><span class="p">.</span><span class="n">HmacSha256Signature</span><span class="o">,</span> <span class="nn">SecurityAlgorithms</span><span class="p">.</span><span class="n">Sha256Digest</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then add <em>IdentityStore.fs</em> in the <strong>SuaveJwt.AuthServerHost</strong> project.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">IdentityStore</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Security.Claims</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">getClaims</span> <span class="n">userName</span> <span class="o">=</span>
</span><span class="line">  <span class="n">seq</span> <span class="o">{</span>
</span><span class="line">    <span class="k">yield</span> <span class="o">(</span><span class="nn">ClaimTypes</span><span class="p">.</span><span class="n">Name</span><span class="o">,</span> <span class="n">userName</span><span class="o">)</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">userName</span> <span class="o">=</span> <span class="s">&quot;Admin&quot;</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="k">yield</span> <span class="o">(</span><span class="nn">ClaimTypes</span><span class="p">.</span><span class="n">Role</span><span class="o">,</span> <span class="s">&quot;Admin&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">userName</span> <span class="o">=</span> <span class="s">&quot;Foo&quot;</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="k">yield</span> <span class="o">(</span><span class="nn">ClaimTypes</span><span class="p">.</span><span class="n">Role</span><span class="o">,</span> <span class="s">&quot;SuperUser&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">Claim</span><span class="o">(</span><span class="n">fst</span> <span class="n">x</span><span class="o">,</span> <span class="n">snd</span> <span class="n">x</span><span class="o">))</span> <span class="o">|&gt;</span> <span class="n">async</span><span class="o">.</span><span class="n">Return</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">isValidCredentials</span> <span class="n">username</span> <span class="n">password</span> <span class="o">=</span>
</span><span class="line">  <span class="n">username</span> <span class="o">=</span> <span class="n">password</span> <span class="o">|&gt;</span> <span class="n">async</span><span class="o">.</span><span class="n">Return</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To keep this simple, I am just hardcoding the credentials and claims here and it can be replaced with any backend. In this case, I am just going with accepting all the credentials as valid if the username and password are same.</p>

<p>Let’s run the <strong>SuaveJwt.AuthServerHost</strong> and verify the token</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/suave_jwt/audience_admin_token.png" /></p>

<h2 id="securing-the-resources">Securing the resources</h2>

<p>Now we have come to the interesting part of securing the resources using the <em>access token</em> created in the above step</p>

<p>The first step to achieving this to validate the incoming access token. Let’s add this validation logic in the <em>JwtToken.fs</em> file.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">TokenValidationRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Issuer</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">SecurityKey</span> <span class="o">:</span> <span class="n">SecurityKey</span>
</span><span class="line">  <span class="n">ClientId</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">AccessToken</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">validate</span> <span class="n">tokenValidationRequest</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">tokenValidationParameters</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">validationParams</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TokenValidationParameters</span><span class="bp">()</span>
</span><span class="line">    <span class="n">validationParams</span><span class="o">.</span><span class="n">ValidAudience</span> <span class="o">&lt;-</span> <span class="n">tokenValidationRequest</span><span class="o">.</span><span class="n">ClientId</span>
</span><span class="line">    <span class="n">validationParams</span><span class="o">.</span><span class="n">ValidIssuer</span> <span class="o">&lt;-</span> <span class="n">tokenValidationRequest</span><span class="o">.</span><span class="n">Issuer</span>
</span><span class="line">    <span class="n">validationParams</span><span class="o">.</span><span class="n">ValidateLifetime</span> <span class="o">&lt;-</span> <span class="k">true</span>
</span><span class="line">    <span class="n">validationParams</span><span class="o">.</span><span class="n">ValidateIssuerSigningKey</span> <span class="o">&lt;-</span> <span class="k">true</span>
</span><span class="line">    <span class="n">validationParams</span><span class="o">.</span><span class="n">IssuerSigningKey</span> <span class="o">&lt;-</span>  <span class="n">tokenValidationRequest</span><span class="o">.</span><span class="n">SecurityKey</span>
</span><span class="line">    <span class="n">validationParams</span>
</span><span class="line">  <span class="k">try</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JwtSecurityTokenHandler</span><span class="bp">()</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">principal</span> <span class="o">=</span>
</span><span class="line">      <span class="n">handler</span><span class="o">.</span><span class="n">ValidateToken</span><span class="o">(</span><span class="n">tokenValidationRequest</span><span class="o">.</span><span class="n">AccessToken</span><span class="o">,</span> <span class="n">tokenValidationParameters</span><span class="o">,</span> <span class="n">ref</span> <span class="k">null</span><span class="o">)</span>
</span><span class="line">    <span class="n">principal</span><span class="o">.</span><span class="n">Claims</span> <span class="o">|&gt;</span> <span class="n">Choice1Of2</span>
</span><span class="line">  <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">ex</span> <span class="o">-&gt;</span> <span class="n">ex</span><span class="o">.</span><span class="n">Message</span> <span class="o">|&gt;</span> <span class="n">Choice2Of2</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>validate</code> function returns a <code>Choice</code> type which contains either a sequence of <a href="https://msdn.microsoft.com/en-us/library/system.security.claims(v=vs.110).aspx">Claims</a> present in the token if the access token is valid or an error message describing what’s wrong with the access token</p>

<p>The next step is using this function to secure a Suave <em>WebPart</em></p>

<p>Create a new source file <em>Secure.fs</em> in the <strong>SuaveJwt</strong> project and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">JwtConfig</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Issuer</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">SecurityKey</span> <span class="o">:</span> <span class="n">SecurityKey</span>
</span><span class="line">    <span class="n">ClientId</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">jwtAuthenticate</span> <span class="n">jwtConfig</span> <span class="n">webpart</span> <span class="o">(</span><span class="n">ctx</span><span class="o">:</span> <span class="n">HttpContext</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">updateContextWithClaims</span> <span class="n">claims</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">ctx</span> <span class="k">with</span> <span class="n">userState</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">userState</span><span class="o">.</span><span class="n">Remove</span><span class="o">(</span><span class="s">&quot;Claims&quot;</span><span class="o">).</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;Claims&quot;</span><span class="o">,</span> <span class="n">claims</span><span class="o">)</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">match</span> <span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">header</span> <span class="s">&quot;token&quot;</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Choice1Of2</span> <span class="n">accessToken</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">tokenValidationRequest</span> <span class="o">=</span>  <span class="o">{</span>
</span><span class="line">        <span class="n">Issuer</span> <span class="o">=</span> <span class="n">jwtConfig</span><span class="o">.</span><span class="n">Issuer</span>
</span><span class="line">        <span class="n">SecurityKey</span> <span class="o">=</span> <span class="n">jwtConfig</span><span class="o">.</span><span class="n">SecurityKey</span>
</span><span class="line">        <span class="n">ClientId</span> <span class="o">=</span> <span class="n">jwtConfig</span><span class="o">.</span><span class="n">ClientId</span>
</span><span class="line">        <span class="n">AccessToken</span> <span class="o">=</span> <span class="n">accessToken</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">validationResult</span> <span class="o">=</span> <span class="n">validate</span> <span class="n">tokenValidationRequest</span>
</span><span class="line">      <span class="k">match</span> <span class="n">validationResult</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Choice1Of2</span> <span class="n">claims</span> <span class="o">-&gt;</span> <span class="n">webpart</span> <span class="o">(</span><span class="n">updateContextWithClaims</span> <span class="n">claims</span><span class="o">)</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Choice2Of2</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">FORBIDDEN</span> <span class="n">err</span> <span class="n">ctx</span>
</span><span class="line">
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">BAD_REQUEST</span> <span class="s">&quot;Invalid Request. Provide both clientid and token&quot;</span> <span class="n">ctx</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>jwtAuthenticate</code> function validates the access token present in the request header and invokes the given <em>WebPart</em> if it is valid. In case of invalid or absence of access token, it returns an HTTP error response instead of executing the <em>WebPart</em>.</p>

<p>Upon successful access token validation, the <code>jwtAuthenticate</code> function puts the claims in the <code>userState</code> map of incoming <code>HttpContext</code> so that subsequent <em>WebPart</em>s in the pipeline can use it.</p>

<p>The <code>JwtConfig</code> record abstracts the underlying audience from the validation logic so that it can be reused across multiple audiences.</p>

<p>Now we have a functionality secure a web part. Let’s create an audience and leverage this</p>

<p>Update the <em>Program.fs</em> file in the <strong>Audience1</strong> project as mentioned below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="nv">main</span> <span class="n">argv</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">jwtConfig</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Issuer</span> <span class="o">=</span> <span class="s">&quot;http://localhost:8083/suave&quot;</span>
</span><span class="line">    <span class="n">ClientId</span> <span class="o">=</span> <span class="s">&quot;7ff79ba3305c4e4f9d0ececeae70c78f&quot;</span>
</span><span class="line">    <span class="n">SecurityKey</span> <span class="o">=</span> <span class="nn">KeyStore</span><span class="p">.</span><span class="n">securityKey</span> <span class="o">(</span><span class="nn">Base64String</span><span class="p">.</span><span class="n">fromString</span> <span class="s">&quot;Op5EqjC70aLS2dx3gI0zADPIZGX2As6UEwjA4oyBjMo&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">sample1</span> <span class="o">=</span> <span class="n">path</span> <span class="s">&quot;/audience1/sample1&quot;</span> <span class="o">&gt;=&gt;</span> <span class="n">jwtAuthenticate</span> <span class="n">jwtConfig</span> <span class="o">(</span><span class="n">OK</span> <span class="s">&quot;Sample 1&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">config</span> <span class="o">=</span> <span class="o">{</span> <span class="n">defaultConfig</span> <span class="k">with</span> <span class="n">bindings</span> <span class="o">=</span> <span class="o">[</span><span class="nn">HttpBinding</span><span class="p">.</span><span class="n">mkSimple</span> <span class="n">HTTP</span> <span class="s">&quot;127.0.0.1&quot;</span> <span class="mi">8084</span><span class="o">]</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="n">startWebServer</span> <span class="n">config</span> <span class="n">sample1</span>
</span><span class="line">  <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I’ve asked you to keep a note of the <em>clientId</em> and the <em>securityKey</em> while doing the registration of <strong>Audience1</strong>. We are using them here in the <code>jwtConfig</code> record.</p>

<p>Let’s see it in action</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/suave_jwt/audience_sample1_success.png" /></p>

<p>Hurray! We have made it. “/audience1/sample1” is a secured API now!</p>

<p>What will happen if we mess with the access token? Well, we will get an HTTP error. Let’s change the character <code>Q</code> in the access token from upper case to lower case and here is the result of it.</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/suave_jwt/audience_sample1_error.png" /></p>

<p>Cool, Isn’t it?</p>

<p>Let’s add authorization based on the claims that we have obtained from the JWT token</p>

<p>Open <em>Secure.fs</em> and update the authorization functionality</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">AuthorizationResult</span> <span class="o">=</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Authorized</span>
</span><span class="line">  <span class="o">|</span> <span class="n">UnAuthorized</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">jwtAuthorize</span> <span class="n">jwtConfig</span> <span class="n">authorizeUser</span> <span class="n">webpart</span>  <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getClaims</span> <span class="o">(</span><span class="n">ctx</span><span class="o">:</span> <span class="n">HttpContext</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userState</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">userState</span>
</span><span class="line">    <span class="k">if</span> <span class="n">userState</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="s">&quot;Claims&quot;</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="k">match</span> <span class="n">userState</span><span class="o">.</span><span class="n">Item</span> <span class="s">&quot;Claims&quot;</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="o">:?</span> <span class="o">(</span><span class="n">Claim</span> <span class="n">seq</span><span class="o">)</span> <span class="k">as</span> <span class="n">claims</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">claims</span>
</span><span class="line">      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">        <span class="n">None</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">authorize</span> <span class="n">httpContext</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">getClaims</span> <span class="n">httpContext</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="n">claims</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="n">async</span> <span class="o">{</span>
</span><span class="line">          <span class="k">let!</span> <span class="nv">authorizationResult</span> <span class="o">=</span> <span class="n">authorizeUser</span> <span class="n">claims</span>
</span><span class="line">          <span class="k">match</span> <span class="n">authorizationResult</span> <span class="k">with</span>
</span><span class="line">          <span class="o">|</span> <span class="n">Authorized</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="o">!</span> <span class="n">webpart</span> <span class="n">httpContext</span>
</span><span class="line">          <span class="o">|</span> <span class="n">UnAuthorized</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="o">!</span> <span class="n">FORBIDDEN</span> <span class="n">err</span> <span class="n">httpContext</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="n">FORBIDDEN</span> <span class="s">&quot;Claims not found&quot;</span> <span class="n">httpContext</span>
</span><span class="line">
</span><span class="line">  <span class="n">jwtAuthenticate</span> <span class="n">jwtConfig</span> <span class="n">authorize</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>jwtConfig</code> function is very similar to the <code>jwtAuthenticate</code> function which provides authorization in addition to the authentication.</p>

<p>The key here is the parameter <code>authorizeUser</code> which is a function that takes a sequence of claims and returns an <code>AuthorizationResult</code>.</p>

<p>Like <code>jwtAuthenticate`` function, the</code>jwtConfig&#8220;` function is also abstracted from the underlying <em>Audience</em> so we can use it across multiple <em>Audience</em>s.</p>

<p>Let’s use this in the <strong>Audience1</strong>.</p>

<p><strong>Program.fs</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="nv">main</span> <span class="n">argv</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// ... existing code ...</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Claim Seq -&gt; Async&lt;AuthorizationResult&gt;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">authorizeAdmin</span> <span class="o">(</span><span class="n">claims</span> <span class="o">:</span> <span class="n">Claim</span> <span class="n">seq</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">claims</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">tryFind</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="nn">ClaimTypes</span><span class="p">.</span><span class="n">Role</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">.</span><span class="n">Value</span> <span class="o">=</span> <span class="s">&quot;Admin&quot;</span><span class="o">)</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">Authorized</span> <span class="o">|&gt;</span> <span class="n">async</span><span class="o">.</span><span class="n">Return</span>
</span><span class="line">    <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="n">UnAuthorized</span> <span class="s">&quot;User is not an admin&quot;</span> <span class="o">|&gt;</span> <span class="n">async</span><span class="o">.</span><span class="n">Return</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">sample2</span> <span class="o">=</span> <span class="n">path</span> <span class="s">&quot;/audience1/sample2&quot;</span> <span class="o">&gt;=&gt;</span> <span class="n">jwtAuthorize</span> <span class="n">jwtConfig</span> <span class="n">authorizeAdmin</span> <span class="o">(</span><span class="n">OK</span> <span class="s">&quot;Sample 2&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">app</span> <span class="o">=</span> <span class="n">choose</span> <span class="o">[</span><span class="n">sample1</span><span class="o">;</span><span class="n">sample2</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="n">startWebServer</span> <span class="n">config</span> <span class="n">app</span>
</span><span class="line">  <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>jwtAuthroize</code> function in action</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/suave_jwt/audience1_sample2_error.png" /></p>

<p><em>Note: I’ve generated a new access token here to exercise this use case.</em></p>

<p>That’s it we have successfully completed all the three steps mentioned at the beginning of this blog post.</p>

<h2 id="a-supplement">A Supplement</h2>

<p>One cool thing about the design of the <strong>SuaveJwt</strong> library is, it doesn’t have any assumption about the <em>Authorization Server</em> and the <em>Resource Server</em>. Because of it, we can easily extend it.</p>

<p>Let’s prove it by updating the <em>Program.fs</em> file in the <strong>Audience2</strong> project.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="nv">main</span> <span class="n">argv</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">jwtConfig</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Issuer</span> <span class="o">=</span> <span class="s">&quot;http://localhost:8083/suave&quot;</span>
</span><span class="line">    <span class="n">ClientId</span> <span class="o">=</span> <span class="s">&quot;ada9263885c440869fb484fe354de13d&quot;</span>
</span><span class="line">    <span class="n">SecurityKey</span> <span class="o">=</span> <span class="nn">KeyStore</span><span class="p">.</span><span class="n">securityKey</span> <span class="o">(</span><span class="nn">Base64String</span><span class="p">.</span><span class="n">fromString</span> <span class="s">&quot;0RWyzyttDmJtiaYkG9rph5cqxCTI8YAOsR7stq-P_5o&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">authorizeSuperUser</span> <span class="o">(</span><span class="n">claims</span> <span class="o">:</span> <span class="n">Claim</span> <span class="n">seq</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">claims</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">tryFind</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="nn">ClaimTypes</span><span class="p">.</span><span class="n">Role</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">.</span><span class="n">Value</span> <span class="o">=</span> <span class="s">&quot;SuperUser&quot;</span><span class="o">)</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">Authorized</span> <span class="o">|&gt;</span> <span class="n">async</span><span class="o">.</span><span class="n">Return</span>
</span><span class="line">    <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="n">UnAuthorized</span> <span class="s">&quot;User is not a Super User&quot;</span> <span class="o">|&gt;</span> <span class="n">async</span><span class="o">.</span><span class="n">Return</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">authorize</span> <span class="o">=</span> <span class="n">jwtAuthorize</span> <span class="n">jwtConfig</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">sample1</span> <span class="o">=</span> <span class="n">path</span> <span class="s">&quot;/audience2/sample1&quot;</span> <span class="o">&gt;=&gt;</span> <span class="n">OK</span> <span class="s">&quot;Sample 1&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">sample2</span> <span class="o">=</span> <span class="n">path</span> <span class="s">&quot;/audience2/sample2&quot;</span> <span class="o">&gt;=&gt;</span> <span class="n">authorize</span> <span class="n">authorizeSuperUser</span> <span class="o">(</span><span class="n">OK</span> <span class="s">&quot;Sample 2&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">config</span> <span class="o">=</span> <span class="o">{</span> <span class="n">defaultConfig</span> <span class="k">with</span> <span class="n">bindings</span> <span class="o">=</span> <span class="o">[</span><span class="nn">HttpBinding</span><span class="p">.</span><span class="n">mkSimple</span> <span class="n">HTTP</span> <span class="s">&quot;127.0.0.1&quot;</span> <span class="mi">8085</span><span class="o">]</span> <span class="o">}</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">app</span> <span class="o">=</span> <span class="n">choose</span> <span class="o">[</span><span class="n">sample1</span><span class="o">;</span><span class="n">sample2</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="n">startWebServer</span> <span class="n">config</span> <span class="n">app</span>
</span><span class="line">  <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Note that the <code>jwtConfig</code> values are different from that of <strong>Audience1</strong> and it is obtained from calling the <strong>AuthorizationServer</strong>’s audience registration API for <strong>Audience2</strong>.</p>

<h2 id="summary">Summary</h2>

<p>Suave provides a simple and elegant way of extending its core functionality. In this blog post, we have seen how to bend it to support JWT based authorization and I believe we can do a lot of other cool things too!</p>

<p>You can find the complete source code of the sample application used in this blog post in my <a href="https://github.com/tamizhvendan/blog-samples/tree/master/SuaveJwtSampleApplication">blog-samples</a> GitHub repository.    </p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building REST Api in fsharp using Suave]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/06/11/building-rest-api-in-fsharp-using-suave/"/>
    <updated>2015-06-11T10:48:20+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/06/11/building-rest-api-in-fsharp-using-suave</id>
    <content type="html"><![CDATA[<p>In the last one month lot of great things happening in fsharp world around <a href="suave.io">suave</a>, a simple web development fsharp library. Scott Hanselman <a href="http://www.hanselman.com/blog/RunningSuaveioAndFWithFAKEInAzureWebAppsWithGitAndTheDeployButton.aspx">blogged</a> about it, <a href="https://twitter.com/tomaspetricek">Tomas Petricek</a> kick-started an awesome <a href="https://skillsmatter.com/skillscasts/6381-suave-hands-on-with-tomas-petricek">hands on session</a> and followed up with a <a href="http://channel9.msdn.com/Blogs/Seth-Juarez/Deploying-an-F-Web-Application-with-Suave">great talk</a> on Channel 9. Last but not the least, <a href="https://twitter.com/theimowski">Tomasz Heimowski</a> authored a clear and crisp <a href="http://theimowski.gitbooks.io/suave-music-store/content/">book on Suave</a></p>

<p>I got super excited after learning suave from these resources and started playing with it. One of the great things about the fsharp community is, if you want to improve any existing library all you need is just send a pull request with the feature you would like to have. Yes, it’s as simple as that! It <a href="https://github.com/SuaveIO/suave/pull/259">worked</a> for me and I am sure for you too, if you wish.</p>

<p>In this blog post, you are going to learn how to build a REST api using suave. The REST api that we are going to create here follows the standard being used in the <a href="http://docs.strongloop.com/display/public/LB/Use+API+Explorer">StrongLoop</a>, a node.js REST api library. To keep things simple, we are not going to see validation and error handling as part of this post and I will be covering that in an another post.</p>

<p>Let’s get started</p>

<h2 id="setting-up-the-project">Setting up the project</h2>

<p>Create a new “F# Console Application” project in Visual Studio with the name <code>SuaveRestApi</code> and rename <code>Program.fs</code> to <code>App.fs</code>. This file is going to contain the application bootstrap logic. Add two more files <code>Db.fs</code> and <code>RestFul.fs</code> which would contain database access and restful api implementation code respectively. Ensure these files are in the order as shown in below.</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/sauve_rest_api/proj_structure.png" /></p>

<p>After creating, install the following nuget packages</p>

<ul>
  <li><a href="https://www.nuget.org/packages/suave">Suave</a></li>
  <li><a href="">Newtonsoft.Json</a></li>
</ul>

<h2 id="webpart">WebPart</h2>

<p>The basic building block of Suave is <a href="http://theimowski.gitbooks.io/suave-music-store/content/webpart.html">WebPart</a>. It is an alias of function type <code>HttpContext -&gt; Async&lt;HttpContext option&gt;</code>. This simple function type actually model whole set of Request and Response model of Http protocol. From the Tomasz Heimowski’s book here is the definition of the <code>WebPart</code></p>

<blockquote>
  <p>Based on the http context, we give you a promise (async) of optional resulting http context, where the resulting context is likely to have its response set with regards to the logic of the WebPart itself</p>
</blockquote>

<p>A <code>WebPart</code> represents a http request and response. Since it is a function, we can combine multiple <code>WebPart</code>s together and build a complex web application which handles multiple requests and responses. This is the beauty of functional programming. You just think in terms of one function at a time and make it work. Once you are done, all you need to do is just gluing them together. Solving problems using this functional abstraction will make things much easier and help you to write less code compare to its Object Oriented version.</p>

<p>The <code>OK</code> webpart is a very simple one in Suave which takes a <code>string</code> and returns a http response with the status code <code>200</code> and the given string. Add the following code in the <code>App.fs</code> and run the console app.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">open</span> <span class="nn">Suave.Web</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Successful</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="nv">main</span> <span class="n">argv</span> <span class="o">=</span>
</span><span class="line">  <span class="n">startWebServer</span> <span class="n">defaultConfig</span> <span class="o">(</span><span class="n">OK</span> <span class="s">&quot;Hello, Suave!&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The is the simplest Suave application that greets all visitors with the string “Hello, Suave!”. The <code>startWebServer</code> is a blocking function that takes a configuration (port number, ssl, etc.,) and starts a http web server in the port 8083 upon calling.</p>

<p><img class="center border" src="http://blog.tamizhvendan.in/images/sauve_rest_api/hello_suave.png" /></p>

<p>The Rest Api that we are going to design here is a <code>WebPart</code> which will be replacing this <code>OK</code> webpart.</p>

<h2 id="http-get">HTTP GET</h2>

<p>Let’s begin by defining a record type representing a <em>restful</em> resource. Open <code>Restful.fs</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">SuaveRestApi</span><span class="p">.</span><span class="n">Rest</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">RestFul</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">RestResource</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">GetAll</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">seq</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This <code>RestResource</code> is a container representing all the operations on a restful  resource. This record type abstracts the actual resource from the rest api web part. This enables the reuse of rest api web part across multiple resources.</p>

<p>Let’s create a function in <code>RestFul.fs</code> which takes a resource name and this <code>RestResource</code> and returns a web part representing the restful api.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// string -&gt; RestResource&lt;&#39;a&gt; -&gt; WebPart</span>
</span><span class="line"><span class="k">let</span> <span class="nv">rest</span> <span class="n">resourceName</span> <span class="n">resource</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// TODO</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We are going to use the following building blocks of the suave library to implement the <code>rest</code> function.</p>

<ul>
  <li>
    <p>The <code>path</code> is a function of type: <code>string -&gt; WebPart</code>. It means that if we give it a string it will return <code>WebPart</code>. Under the hood, the function looks at the incoming request and returns <code>Some</code> if the paths match, and <code>None</code> otherwise.</p>
  </li>
  <li>
    <p>The <code>GET</code> is a static inbuilt <code>WebPart</code> which matches the HTTP GET requests.</p>
  </li>
  <li>
    <p>The <code>&gt;=&gt;</code> operator composes two WebParts into one by first evaluating the <code>WebPart</code> on the left, and applying the WebPart on the right only if the first one returned <code>Some</code>.</p>
  </li>
</ul>

<p>To return a json response we need to change the mime type to “application/json” of the response. There is an <a href="https://github.com/SuaveIO/suave/blob/master/src/Suave/Json.fs">inbuilt function</a> in suave to do this but it is using .Net’s <code>DataContractJsonSerializer</code>. I feel it’s not ideal to use as we need to write decorator attribute <code>DataMember</code> to serialize the types.</p>

<p>As <a href="http://james.newtonking.com/archive/2014/04/30/json-net-6-0-release-3-serialize-all-the-f">Newtonsoft.Json</a> provides serialization support for fsharp types without any need of decorating attributes, we will be using them there.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// &#39;a -&gt; WebPart</span>
</span><span class="line"><span class="k">let</span> <span class="nv">JSON</span> <span class="n">v</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">jsonSerializerSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonSerializerSettings</span><span class="bp">()</span>
</span><span class="line">  <span class="n">jsonSerializerSettings</span><span class="o">.</span><span class="n">ContractResolver</span> <span class="o">&lt;-</span> <span class="k">new</span> <span class="n">CamelCasePropertyNamesContractResolver</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="nn">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">jsonSerializerSettings</span><span class="o">)</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="n">OK</span>
</span><span class="line">  <span class="o">&gt;=&gt;</span> <span class="nn">Writers</span><span class="p">.</span><span class="n">setMimeType</span> <span class="s">&quot;application/json; charset=utf-8&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>As the signature indicates <code>JSON</code> function takes a generic type, serialize it using <em>Newtonsoft.Json</em> and return the json response. <code>Writers.setMimeType</code> takes a mime type and a web part returns the web part with the given mime type.</p>

<p>Now we have everything to implement the HTTP GET request</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">rest</span> <span class="n">resourceName</span> <span class="n">resource</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">resourcePath</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">resourceName</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">gellAll</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">GetAll</span> <span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">JSON</span>
</span><span class="line">  <span class="n">path</span> <span class="n">resourcePath</span> <span class="o">&gt;=&gt;</span> <span class="n">GET</span> <span class="o">&gt;=&gt;</span> <span class="n">getAll</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The one caveat here is the path resolution of Suave library. Based on the webpart given, the <code>startWebServer</code> function configures it’s internal routing table during the application startup and it is static after the application has been started. So, the <code>getAll</code> webpart will be created only during application startup. To avoid this, we need to wrap the <code>getAll</code> webpart with a <code>warbler</code> function which ensures that it is called only when the incoming request matches the given resource path.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">rest</span> <span class="n">resourceName</span> <span class="n">resource</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">resourcePath</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">resourceName</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">gellAll</span> <span class="o">=</span> <span class="n">warbler</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">GetAll</span> <span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">JSON</span><span class="o">)</span>
</span><span class="line">  <span class="n">path</span> <span class="n">resourcePath</span> <span class="o">&gt;=&gt;</span> <span class="n">GET</span> <span class="o">&gt;=&gt;</span> <span class="n">getAll</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now we have the middleware to create a web part. Let’s create other things and glue them together.</p>

<p>Open <code>Db.fs</code> file and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">SuaveRestApi</span><span class="p">.</span><span class="n">Db</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Collections.Generic</span>
</span><span class="line"><span class="k">type</span> <span class="nc">Person</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Id</span> <span class="o">:</span> <span class="n">int</span>
</span><span class="line">  <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Age</span> <span class="o">:</span> <span class="n">int</span>
</span><span class="line">  <span class="n">Email</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Db</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">peopleStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">int</span><span class="o">,</span> <span class="n">Person</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">getPeople</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="n">peopleStorage</span><span class="o">.</span><span class="n">Values</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Since it’s a sample application, I am just using an in memory dictionary to store the details of people. You can easily replace this with any data source. The <code>Person</code> type represents the <code>People</code> resource of the rest api.</p>

<p>The next step is wiring the Restful web part with the application. Open <code>App.fs</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">open</span> <span class="nn">SuaveRestApi.Rest</span>
</span><span class="line"><span class="k">open</span> <span class="nn">SuaveRestApi.Db</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Web</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Suave.Http.Successful</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="nv">main</span> <span class="n">argv</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">personWebPart</span> <span class="o">=</span> <span class="n">rest</span> <span class="s">&quot;people&quot;</span> <span class="o">{</span>
</span><span class="line">    <span class="n">GetAll</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">getPeople</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="n">startWebServer</span> <span class="n">defaultConfig</span> <span class="n">personWebPart</span>
</span><span class="line">  <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s it! Now we have the HTTP GET Request up and running</p>

<p><img class="center border" src="http://blog.tamizhvendan.in/images/sauve_rest_api/http_get.png" /></p>

<p>Since we are having no people in our in-memory dictionary, we are getting an empty result here. Let’s add a new person using HTTP POST</p>

<h2 id="http-post">HTTP POST</h2>

<p>HTTP POST uses the same workflow as HTTP GET. To implement this, we are going to use the following features in Suave.</p>

<ul>
  <li>
    <p>The <code>choose</code> function takes a list of WebParts, and chooses the first one that applies (i.e which returns <code>Some</code>), or if none WebPart applies, then choose will  return <code>None</code></p>
  </li>
  <li>
    <p>The <code>request</code> function takes a function of type <code>HttpRequest -&gt; WebPart</code> and returns the <code>WebPart</code>. We will use this <code>HttpRequest</code> to get the POST content.</p>
  </li>
  <li>
    <p>The <code>POST</code> is a static in-built <code>WebPart</code> which matches the HTTP POST requests.</p>
  </li>
</ul>

<p>The first step in implementing POST request is updating the <code>RestResource</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">RestResource</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">GetAll</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">seq</span>
</span><span class="line">  <span class="n">Create</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then add the following utility functions in <code>Restful.fs</code> to get the resource from the HttpRequest</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">fromJson</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="n">json</span> <span class="o">=</span>
</span><span class="line">  <span class="nn">JsonConvert</span><span class="p">.</span><span class="n">DeserializeObject</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;)</span> <span class="o">:?&gt;</span> <span class="k">&#39;</span><span class="n">a</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">getResourceFromReq</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">(</span><span class="n">req</span> <span class="o">:</span> <span class="n">HttpRequest</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">getString</span> <span class="n">rawForm</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">System</span><span class="p">.</span><span class="nn">Text</span><span class="p">.</span><span class="nn">Encoding</span><span class="p">.</span><span class="nn">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="o">(</span><span class="n">rawForm</span><span class="o">)</span>
</span><span class="line">  <span class="n">req</span><span class="o">.</span><span class="n">rawForm</span> <span class="o">|&gt;</span> <span class="n">getString</span> <span class="o">|&gt;</span> <span class="n">fromJson</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>rawForm</code> field in the <code>HttpRequest</code> has the POST content as a byte array, we are just deserializing to a fsharp type.</p>

<p>The next step is updating the <code>rest</code> function to support POST</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">rest</span> <span class="n">resourceName</span> <span class="n">resource</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">resourcePath</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">resourceName</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">gellAll</span> <span class="o">=</span> <span class="n">warbler</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">GetAll</span> <span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">JSON</span><span class="o">)</span>
</span><span class="line">  <span class="n">path</span> <span class="n">resourcePath</span> <span class="o">&gt;=&gt;</span> <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="n">GET</span> <span class="o">&gt;=&gt;</span> <span class="n">getAll</span>
</span><span class="line">    <span class="n">POST</span> <span class="o">&gt;=&gt;</span> <span class="n">request</span> <span class="o">(</span><span class="n">getResourceFromReq</span> <span class="o">&gt;&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">Create</span> <span class="o">&gt;&gt;</span> <span class="n">JSON</span><span class="o">)</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Thanks to the awesome function composition feature, we have combined all these tiny functions and implemented a new request and response.  </p>

<p>Then update <code>Db.fs</code> and <code>App.fs</code> respectively as follows</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Db</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">createPerson</span> <span class="n">person</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">id</span> <span class="o">=</span> <span class="n">peopleStorage</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">Count</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">newPerson</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">        <span class="n">Id</span> <span class="o">=</span> <span class="n">id</span>
</span><span class="line">        <span class="n">Name</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">Name</span>
</span><span class="line">        <span class="n">Age</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">Age</span>
</span><span class="line">        <span class="n">Email</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">Email</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">peopleStorage</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">newPerson</span><span class="o">)</span>
</span><span class="line">    <span class="n">newPerson</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">personWebPart</span> <span class="o">=</span> <span class="n">rest</span> <span class="s">&quot;people&quot;</span> <span class="o">{</span>
</span><span class="line">  <span class="n">GetAll</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">getPeople</span>
</span><span class="line">  <span class="n">Create</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">createPerson</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The HTTP POST function in action</p>

<p><img class="center border" src="http://blog.tamizhvendan.in/images/sauve_rest_api/http_post.png" /></p>

<h2 id="http-put">HTTP PUT</h2>

<p>As we did for GET &amp; POST we will be starting by updating the <code>RestResource</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">RestResource</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">GetAll</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">seq</span>
</span><span class="line">  <span class="n">Create</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span>
</span><span class="line">  <span class="n">Update</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have added a bit of error handling here. This <code>Update</code> function tries to update a resource and returns the updated resource if the resource exists. If it didn’t it returns <code>None</code></p>

<p>To support HTTP PUT we will be using the following from suave library</p>

<ul>
  <li>
    <p>The <code>BAD_REQUEST</code> function takes a string and returns a WebPart representing HTTP status code 400 response with given string as it response.</p>
  </li>
  <li>
    <p>The <code>PUT</code> is a static in-built <code>WebPart</code> which matches the HTTP PUT requests.</p>
  </li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">rest</span> <span class="n">resourceName</span> <span class="n">resource</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">resourcePath</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">resourceName</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">badRequest</span> <span class="o">=</span> <span class="n">BAD_REQUEST</span> <span class="s">&quot;Resource not found&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">gellAll</span> <span class="o">=</span> <span class="n">warbler</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">GetAll</span> <span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">JSON</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">handleResource</span> <span class="n">requestError</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span> <span class="o">|&gt;</span> <span class="n">JSON</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">requestError</span>
</span><span class="line">
</span><span class="line">  <span class="n">path</span> <span class="n">resourcePath</span> <span class="o">&gt;=&gt;</span>
</span><span class="line">    <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">      <span class="n">GET</span> <span class="o">&gt;=&gt;</span> <span class="n">getAll</span>
</span><span class="line">      <span class="n">POST</span> <span class="o">&gt;=&gt;</span>
</span><span class="line">        <span class="n">request</span> <span class="o">(</span><span class="n">getResourceFromReq</span> <span class="o">&gt;&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">Create</span> <span class="o">&gt;&gt;</span> <span class="n">JSON</span><span class="o">)</span>
</span><span class="line">      <span class="n">PUT</span> <span class="o">&gt;=&gt;</span>
</span><span class="line">        <span class="n">request</span> <span class="o">(</span><span class="n">getResourceFromReq</span> <span class="o">&gt;&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">Update</span> <span class="o">&gt;&gt;</span> <span class="n">handleResource</span> <span class="n">badRequest</span><span class="o">)</span>
</span><span class="line">    <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Then update <code>Db.fs</code> and <code>App.fs</code> as usual</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Db</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">updatePersonById</span> <span class="n">personId</span> <span class="n">personToBeUpdated</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="n">peopleStorage</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">personId</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">updatedPerson</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">        <span class="n">Id</span> <span class="o">=</span> <span class="n">personId</span>
</span><span class="line">        <span class="n">Name</span> <span class="o">=</span> <span class="n">personToBeUpdated</span><span class="o">.</span><span class="n">Name</span>
</span><span class="line">        <span class="n">Age</span> <span class="o">=</span> <span class="n">personToBeUpdated</span><span class="o">.</span><span class="n">Age</span>
</span><span class="line">        <span class="n">Email</span> <span class="o">=</span> <span class="n">personToBeUpdated</span><span class="o">.</span><span class="n">Email</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">      <span class="n">peopleStorage</span><span class="o">.[</span><span class="n">personId</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">updatedPerson</span>
</span><span class="line">      <span class="n">Some</span> <span class="n">updatedPerson</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">None</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">updatePerson</span> <span class="n">personToBeUpdated</span> <span class="o">=</span>
</span><span class="line">    <span class="n">updatePersonById</span> <span class="n">personToBeUpdated</span><span class="o">.</span><span class="n">Id</span> <span class="n">personToBeUpdated</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have created one more function here <code>updatePersonById</code> which will be used later.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">personWebPart</span> <span class="o">=</span> <span class="n">rest</span> <span class="s">&quot;people&quot;</span> <span class="o">{</span>
</span><span class="line">  <span class="n">GetAll</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">getPeople</span>
</span><span class="line">  <span class="n">Create</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">createPerson</span>
</span><span class="line">  <span class="n">Update</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">updatePerson</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Updating an existing resource</strong></p>

<p><img class="center border" src="http://blog.tamizhvendan.in/images/sauve_rest_api/http_put.png" /></p>

<p><strong>Updating a non-existing resource</strong></p>

<p><img class="center border" src="http://blog.tamizhvendan.in/images/sauve_rest_api/http_put_error.png" /></p>

<h2 id="http-delete">HTTP DELETE</h2>

<p>Let’s begin by updating the <code>RestResource</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">RestResource</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">GetAll</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">seq</span>
</span><span class="line">  <span class="n">Create</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span>
</span><span class="line">  <span class="n">Update</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span>
</span><span class="line">  <span class="n">Delete</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>HTTP DELETE is little different from the other implemented requests as we will be retrieving the id of the resource to be deleted from the URL.</p>

<p>For example, <strong>DELETE /people/1</strong> will delete a person with the id 1.  </p>

<p>To retrieve the id from the url, we will be using the <code>pathScan</code> function in Suave. This function similar to <code>printf</code> which takes a <a href="">PrintfFormat</a> and a function which takes the output of the printfformat and returns the WebPart. You can get more details about it from the <a href="http://theimowski.gitbooks.io/suave-music-store/content/url_parameters.html">suave-music-store book</a>.</p>

<p>In addition to this, we will be using the following from suave</p>

<ul>
  <li>The <code>NO_CONTENT</code> is a static <code>WebPart</code> represents the HTTP Response with the status code 204</li>
  <li>The <code>DELETE</code> matches the HTTP request of type DELETE</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">rest</span> <span class="n">resourceName</span> <span class="n">resource</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">resourcePath</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">resourceName</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">resourceIdPath</span> <span class="o">=</span>
</span><span class="line">    <span class="k">new</span> <span class="n">PrintfFormat</span><span class="o">&lt;(</span><span class="n">int</span> <span class="o">-&gt;</span> <span class="kt">string</span><span class="o">),</span><span class="kt">unit</span><span class="o">,</span><span class="kt">string</span><span class="o">,</span><span class="kt">string</span><span class="o">,</span><span class="n">int</span><span class="o">&gt;(</span><span class="n">resourcePath</span> <span class="o">+</span> <span class="s">&quot;/%d&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">badRequest</span> <span class="o">=</span> <span class="n">BAD_REQUEST</span> <span class="s">&quot;Resource not found&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">gellAll</span> <span class="o">=</span> <span class="n">warbler</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">GetAll</span> <span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">JSON</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">handleResource</span> <span class="n">requestError</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span> <span class="o">|&gt;</span> <span class="n">JSON</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">requestError</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">deleteResourceById</span> <span class="n">id</span> <span class="o">=</span>
</span><span class="line">    <span class="n">resource</span><span class="o">.</span><span class="n">Delete</span> <span class="n">id</span>
</span><span class="line">    <span class="n">NO_CONTENT</span>
</span><span class="line">
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="n">path</span> <span class="n">resourcePath</span> <span class="o">&gt;=&gt;</span> <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">      <span class="n">GET</span> <span class="o">&gt;=&gt;</span> <span class="n">getAll</span>
</span><span class="line">      <span class="n">POST</span> <span class="o">&gt;=&gt;</span>
</span><span class="line">        <span class="n">request</span> <span class="o">(</span><span class="n">getResourceFromReq</span> <span class="o">&gt;&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">Create</span> <span class="o">&gt;&gt;</span> <span class="n">JSON</span><span class="o">)</span>
</span><span class="line">      <span class="n">PUT</span> <span class="o">&gt;=&gt;</span>
</span><span class="line">        <span class="n">request</span> <span class="o">(</span><span class="n">getResourceFromReq</span> <span class="o">&gt;&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">Update</span> <span class="o">&gt;&gt;</span> <span class="n">handleResource</span> <span class="n">badRequest</span><span class="o">)</span>
</span><span class="line">    <span class="o">]</span>
</span><span class="line">    <span class="n">DELETE</span> <span class="o">&gt;=&gt;</span> <span class="n">pathScan</span> <span class="n">resourceIdPath</span> <span class="n">deleteResourceById</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>One thing to notice here is we have wrapped the existing <code>choose</code> function with an another <code>choose</code> function. It may be little complex to understand but if you understand what each thing mean, it is easier. Here the inner <code>choose</code> function represents the handler functions for GET, POST &amp; PUT requests having the url “/{resourceName}” and the <code>DELETE</code> webpart represents the HTTP DELETE handler for the url “/{resourceName}/{resourceId}”.</p>

<p>The outer <code>choose</code> function chooses one of these based on the incoming request.</p>

<p><strong>Db.fs</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">deletePerson</span> <span class="n">personId</span> <span class="o">=</span>
</span><span class="line">  <span class="n">peopleStorage</span><span class="o">.</span><span class="n">Remove</span><span class="o">(</span><span class="n">personId</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>App.fs</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">personWebPart</span> <span class="o">=</span> <span class="n">rest</span> <span class="s">&quot;people&quot;</span> <span class="o">{</span>
</span><span class="line">  <span class="n">GetAll</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">getPeople</span>
</span><span class="line">  <span class="n">Create</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">createPerson</span>
</span><span class="line">  <span class="n">Update</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">updatePerson</span>
</span><span class="line">  <span class="n">Delete</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">deletePerson</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p><img class="center border" src="http://blog.tamizhvendan.in/images/sauve_rest_api/http_delete.png" /></p>

<h2 id="http-get--http-put-by-id">HTTP GET &amp; HTTP PUT by id</h2>

<p>I hope by this time you know how to wire things up in Suave to create an API. Let’s add features for getting and updating resource by id.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">RestResource</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">GetAll</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">seq</span>
</span><span class="line">  <span class="n">Create</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span>
</span><span class="line">  <span class="n">Update</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span>
</span><span class="line">  <span class="n">Delete</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</span><span class="line">  <span class="n">GetById</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span>
</span><span class="line">  <span class="n">UpdateById</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">rest</span> <span class="n">resourceName</span> <span class="n">resource</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// .. Existing code ...</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">getResourceById</span> <span class="o">=</span>
</span><span class="line">    <span class="n">resource</span><span class="o">.</span><span class="n">GetById</span> <span class="o">&gt;&gt;</span> <span class="n">handleResource</span> <span class="o">(</span><span class="n">NOT_FOUND</span> <span class="s">&quot;Resource not found&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">updateResourceById</span> <span class="n">id</span> <span class="o">=</span>
</span><span class="line">    <span class="n">request</span> <span class="o">(</span><span class="n">getResourceFromReq</span> <span class="o">&gt;&gt;</span> <span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="n">UpdateById</span> <span class="n">id</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="n">handleResource</span> <span class="n">badRequest</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="n">path</span> <span class="n">resourcePath</span> <span class="o">&gt;=&gt;</span> <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">      <span class="n">GET</span> <span class="o">&gt;=&gt;</span> <span class="n">getAll</span>
</span><span class="line">      <span class="n">POST</span> <span class="o">&gt;=&gt;</span>
</span><span class="line">        <span class="n">request</span> <span class="o">(</span><span class="n">getResourceFromReq</span> <span class="o">&gt;&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">Create</span> <span class="o">&gt;&gt;</span> <span class="n">JSON</span><span class="o">)</span>
</span><span class="line">      <span class="n">PUT</span> <span class="o">&gt;=&gt;</span>
</span><span class="line">        <span class="n">request</span> <span class="o">(</span><span class="n">getResourceFromReq</span> <span class="o">&gt;&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">Update</span> <span class="o">&gt;&gt;</span> <span class="n">handleResource</span> <span class="n">badRequest</span><span class="o">)</span>
</span><span class="line">    <span class="o">]</span>
</span><span class="line">    <span class="n">DELETE</span> <span class="o">&gt;=&gt;</span> <span class="n">pathScan</span> <span class="n">resourceIdPath</span> <span class="n">deleteResourceById</span>
</span><span class="line">    <span class="n">GET</span> <span class="o">&gt;=&gt;</span> <span class="n">pathScan</span> <span class="n">resourceIdPath</span> <span class="n">getResourceById</span>
</span><span class="line">    <span class="n">PUT</span> <span class="o">&gt;=&gt;</span> <span class="n">pathScan</span> <span class="n">resourceIdPath</span> <span class="n">updateResourceById</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Db.fs</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getPerson</span> <span class="n">id</span> <span class="o">=</span>
</span><span class="line">  <span class="k">if</span> <span class="n">peopleStorage</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">    <span class="n">Some</span> <span class="n">peopleStorage</span><span class="o">.[</span><span class="n">id</span><span class="o">]</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="n">None</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>App.fs</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">personWebPart</span> <span class="o">=</span> <span class="n">rest</span> <span class="s">&quot;people&quot;</span> <span class="o">{</span>
</span><span class="line">  <span class="n">GetAll</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">getPeople</span>
</span><span class="line">  <span class="n">Create</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">createPerson</span>
</span><span class="line">  <span class="n">Update</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">updatePerson</span>
</span><span class="line">  <span class="n">Delete</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">deletePerson</span>
</span><span class="line">  <span class="n">GetById</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">getPerson</span>
</span><span class="line">  <span class="n">UpdateById</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">updatePersonById</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><img class="center border" src="http://blog.tamizhvendan.in/images/sauve_rest_api/http_get_id.png" />
<img class="center border" src="http://blog.tamizhvendan.in/images/sauve_rest_api/http_put_id.png" /></p>

<h2 id="http-head">HTTP HEAD</h2>

<p>Http HEAD request checks whether the request with the given id is there or not. Its implementation is straight forward.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">RestResource</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">GetAll</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">seq</span>
</span><span class="line">  <span class="n">Create</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span>
</span><span class="line">  <span class="n">Update</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span>
</span><span class="line">  <span class="n">Delete</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</span><span class="line">  <span class="n">GetById</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span>
</span><span class="line">  <span class="n">UpdateById</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span>
</span><span class="line">  <span class="n">IsExists</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">rest</span> <span class="n">resourceName</span> <span class="n">resource</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// .. Existing code ...</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">isResourceExists</span> <span class="n">id</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">IsExists</span> <span class="n">id</span> <span class="k">then</span> <span class="n">OK</span> <span class="s">&quot;&quot;</span> <span class="k">else</span> <span class="n">NOT_FOUND</span> <span class="s">&quot;&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="n">path</span> <span class="n">resourcePath</span> <span class="o">&gt;=&gt;</span> <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">      <span class="n">GET</span> <span class="o">&gt;=&gt;</span> <span class="n">getAll</span>
</span><span class="line">      <span class="n">POST</span> <span class="o">&gt;=&gt;</span>
</span><span class="line">        <span class="n">request</span> <span class="o">(</span><span class="n">getResourceFromReq</span> <span class="o">&gt;&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">Create</span> <span class="o">&gt;&gt;</span> <span class="n">JSON</span><span class="o">)</span>
</span><span class="line">      <span class="n">PUT</span> <span class="o">&gt;=&gt;</span>
</span><span class="line">        <span class="n">request</span> <span class="o">(</span><span class="n">getResourceFromReq</span> <span class="o">&gt;&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">Update</span> <span class="o">&gt;&gt;</span> <span class="n">handleResource</span> <span class="n">badRequest</span><span class="o">)</span>
</span><span class="line">    <span class="o">]</span>
</span><span class="line">    <span class="n">DELETE</span> <span class="o">&gt;=&gt;</span> <span class="n">pathScan</span> <span class="n">resourceIdPath</span> <span class="n">deleteResourceById</span>
</span><span class="line">    <span class="n">GET</span> <span class="o">&gt;=&gt;</span> <span class="n">pathScan</span> <span class="n">resourceIdPath</span> <span class="n">getResourceById</span>
</span><span class="line">    <span class="n">PUT</span> <span class="o">&gt;=&gt;</span> <span class="n">pathScan</span> <span class="n">resourceIdPath</span> <span class="n">updateResourceById</span>
</span><span class="line">    <span class="n">HEAD</span> <span class="o">&gt;=&gt;</span> <span class="n">pathScan</span> <span class="n">resourceIdPath</span> <span class="n">isResourceExists</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p><strong>Db.fs</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">isPersonExists</span> <span class="o">=</span> <span class="n">peopleStorage</span><span class="o">.</span><span class="n">ContainsKey</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>App.fs</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">personWebPart</span> <span class="o">=</span> <span class="n">rest</span> <span class="s">&quot;people&quot;</span> <span class="o">{</span>
</span><span class="line">  <span class="n">GetAll</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">getPeople</span>
</span><span class="line">  <span class="n">GetById</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">getPerson</span>
</span><span class="line">  <span class="n">Create</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">createPerson</span>
</span><span class="line">  <span class="n">Update</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">updatePerson</span>
</span><span class="line">  <span class="n">UpdateById</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">updatePersonById</span>
</span><span class="line">  <span class="n">Delete</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">deletePerson</span>
</span><span class="line">  <span class="n">IsExists</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">isPersonExists</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p><img class="center border" src="http://blog.tamizhvendan.in/images/sauve_rest_api/head.png" /></p>

<p>That’s all.. We have successfully implemented a REST API using Suave</p>

<h2 id="extending-with-a-new-resource">Extending with a new Resource</h2>

<p>The beautiful aspect of this functional REST API design we can easily extend it to support other resources.</p>

<p>Here is the rest API implementation of the <code>albums</code> resource in the <a href="http://theimowski.gitbooks.io/suave-music-store/content/database.html">music-store</a> application. You can find the source code of MusicStoreDb <a href="https://github.com/tamizhvendan/blog-samples/blob/master/SuaveRestApi/SuaveRestApi/MusicStoreDb.fs">here</a>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="nv">main</span> <span class="n">argv</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">personWebPart</span> <span class="o">=</span> <span class="n">rest</span> <span class="s">&quot;people&quot;</span> <span class="o">{</span>
</span><span class="line">    <span class="n">GetAll</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">getPeople</span>
</span><span class="line">    <span class="n">GetById</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">getPerson</span>
</span><span class="line">    <span class="n">Create</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">createPerson</span>
</span><span class="line">    <span class="n">Update</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">updatePerson</span>
</span><span class="line">    <span class="n">UpdateById</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">updatePersonById</span>
</span><span class="line">    <span class="n">Delete</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">deletePerson</span>
</span><span class="line">    <span class="n">IsExists</span> <span class="o">=</span> <span class="nn">Db</span><span class="p">.</span><span class="n">isPersonExists</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">albumWebPart</span> <span class="o">=</span> <span class="n">rest</span> <span class="s">&quot;albums&quot;</span> <span class="o">{</span>
</span><span class="line">    <span class="n">GetAll</span> <span class="o">=</span> <span class="nn">MusicStoreDb</span><span class="p">.</span><span class="n">getAlbums</span>
</span><span class="line">    <span class="n">GetById</span> <span class="o">=</span> <span class="nn">MusicStoreDb</span><span class="p">.</span><span class="n">getAlbumById</span>
</span><span class="line">    <span class="n">Create</span> <span class="o">=</span> <span class="nn">MusicStoreDb</span><span class="p">.</span><span class="n">createAlbum</span>
</span><span class="line">    <span class="n">Update</span> <span class="o">=</span> <span class="nn">MusicStoreDb</span><span class="p">.</span><span class="n">updateAlbum</span>
</span><span class="line">    <span class="n">UpdateById</span> <span class="o">=</span> <span class="nn">MusicStoreDb</span><span class="p">.</span><span class="n">updateAlbumById</span>
</span><span class="line">    <span class="n">Delete</span> <span class="o">=</span> <span class="nn">MusicStoreDb</span><span class="p">.</span><span class="n">deleteAlbum</span>
</span><span class="line">    <span class="n">IsExists</span> <span class="o">=</span> <span class="nn">MusicStoreDb</span><span class="p">.</span><span class="n">isAlbumExists</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="n">startWebServer</span> <span class="n">defaultConfig</span> <span class="o">(</span><span class="n">choose</span> <span class="o">[</span><span class="n">personWebPart</span><span class="o">;</span><span class="n">albumWebPart</span><span class="o">])</span>
</span><span class="line">  <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><img class="center border" src="http://blog.tamizhvendan.in/images/sauve_rest_api/get_album_id.png" /></p>

<h2 id="conclusion">Conclusion</h2>

<p>In the amazing presentation on <a href="https://skillsmatter.com/skillscasts/6120-functional-programming-design-patterns-with-scott-wlaschin">Functional Programming Design Patterns</a>, Scott Wlaschin had this slide</p>

<p><img class="center border" src="http://blog.tamizhvendan.in/images/sauve_rest_api/fp_design_patterns_slide.png" /></p>

<p>I wondered how this can be applied in real-time. By creating a rest API using suave I’ve understood this.</p>

<blockquote>
  <p>Just create functions and combine it to build a bigger system.</p>
</blockquote>

<p>What a nice way to develop a system!</p>

<p>You can get the source code associated with this blog post in <a href="https://github.com/tamizhvendan/blog-samples/tree/master/SuaveRestApi">my GitHub repository</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Grouping data into buckets using fsharp]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/05/09/grouping-data-into-buckets-using-fsharp/"/>
    <updated>2015-05-09T16:19:06+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/05/09/grouping-data-into-buckets-using-fsharp</id>
    <content type="html"><![CDATA[<p>Last week I came across an interesting data grouping problem, which groups the data into different buckets based on the given filters as shown in the image below</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fs_data_grouping/bucket_function.png" /></p>

<p>In this blog post I am going to share how can we solve this problem very expressively using fsharp.</p>

<h2 id="parsing-filters-and-translate-to-an-abstract-syntax-tree-ast">Parsing filters and translate to an Abstract Syntax Tree (AST)</h2>

<p>The first step to solve this problem is parsing the filters and translate to an AST. The strong type system in fsharp makes this step pretty easy.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Filter</span> <span class="o">=</span>
</span><span class="line">  <span class="o">|</span> <span class="n">GreaterThan</span> <span class="k">of</span> <span class="n">int</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Between</span> <span class="k">of</span> <span class="n">int</span> <span class="o">*</span> <span class="n">int</span>
</span><span class="line">  <span class="o">|</span> <span class="n">LessThan</span> <span class="k">of</span> <span class="n">int</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Filter</code> type represents the AST of the raw string filter. There are <strong>n</strong> number of ways to transform this incoming string filter to its strongly typed counterpart.</p>

<p>The most idiomatic way of achieving it in fsharp is through <a href="http://en.wikibooks.org/wiki/F_Sharp_Programming/Active_Patterns#Partial_Active_Patterns">Partial Active Patterns</a></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="o">(|</span><span class="n">Regex</span><span class="o">|_|)</span> <span class="n">pattern</span> <span class="n">input</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">m</span> <span class="o">=</span> <span class="nn">Regex</span><span class="p">.</span><span class="n">Match</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">pattern</span><span class="o">)</span>
</span><span class="line">  <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">Success</span> <span class="k">then</span> <span class="n">Some</span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tail</span> <span class="o">[</span> <span class="k">for</span> <span class="n">g</span> <span class="k">in</span> <span class="n">m</span><span class="o">.</span><span class="n">Groups</span> <span class="o">-&gt;</span> <span class="n">g</span><span class="o">.</span><span class="n">Value</span> <span class="o">])</span>
</span><span class="line">  <span class="k">else</span> <span class="n">None</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>You can easily understand this partial active pattern by thinking it as a function with the following signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="kt">list</span> <span class="n">option</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>i.e Takes an input, matches it against a pattern. If it matched, then returns the list of matched strings wrapped with the <code>Some</code> type else returns the <code>None</code> type.</p>

<p>Now you may think why we need to write this straight-forward function as a partial active pattern with some weird symbols <code>(|_|)</code> ?</p>

<p>We can certainly do that, but we can’t do <a href="http://fsharpforfunandprofit.com/posts/match-expression/">pattern matching</a> against a function. </p>

<p>The best way to understand this by seeing it in action</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// string -&gt; Filter</span>
</span><span class="line"><span class="k">let</span> <span class="nv">createFilter</span> <span class="n">filterString</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">filterString</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Regex</span> <span class="s">&quot;^&gt;(</span><span class="err">\</span><span class="s">d+)$&quot;</span> <span class="o">[</span><span class="n">min</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="n">GreaterThan</span><span class="o">(</span><span class="n">int</span> <span class="n">min</span><span class="o">)</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Regex</span> <span class="s">&quot;^(</span><span class="err">\</span><span class="s">d+)-(</span><span class="err">\</span><span class="s">d+)$&quot;</span> <span class="o">[</span><span class="n">min</span><span class="o">;</span><span class="n">max</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="n">Between</span><span class="o">(</span><span class="n">int</span> <span class="n">min</span><span class="o">,</span><span class="n">int</span> <span class="n">max</span><span class="o">)</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Regex</span> <span class="s">&quot;^&lt;(</span><span class="err">\</span><span class="s">d+)$&quot;</span> <span class="o">[</span><span class="n">max</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="n">LessThan</span><span class="o">(</span><span class="n">int</span> <span class="n">max</span><span class="o">)</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s">&quot;Invalid Filter&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The above function transforms the raw string filter into its equivalent fsharp type that we have defined before. The pattern matching makes our job very easier by declaratively saying if it matches this, then do this.</p>

<p>One another important benefit that we are getting here, the return value (list of matched strings) is available as a last parameter in the pattern matching. It’s just coming for free. </p>

<p>I’d like to give you an exercise to appreciate this excellent feature in fsharp. Try to implement the above using a function instead of a partial active patterns. </p>

<p>Great! We are done with the first step. Let’s move to the next one.</p>

<h2 id="grouping-the-data-using-the-filter">Grouping the data using the filter</h2>

<p>To do the actual grouping we need to have a function that filters the data based on the given filter. Let me call it as a predicate.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// Filter -&gt; int -&gt; bool</span>
</span><span class="line"><span class="k">let</span> <span class="nv">createPredicate</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">  <span class="o">|</span> <span class="n">GreaterThan</span> <span class="n">min</span> <span class="o">-&gt;</span> <span class="k">fun</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">min</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Between</span> <span class="o">(</span><span class="n">min</span><span class="o">,</span> <span class="n">max</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">fun</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">min</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">max</span>
</span><span class="line">  <span class="o">|</span> <span class="n">LessThan</span> <span class="n">max</span> <span class="o">-&gt;</span> <span class="k">fun</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">max</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>createPredicate</code> function takes a filter and returns the predicate function <code>int -&gt; bool</code></p>

<p>With the functions <code>createFilter</code> and <code>createPredicate</code> in place, we can combine them and create a new function that takes a raw filter string and translate that to a predicate. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// string -&gt; int -&gt; bool</span>
</span><span class="line"><span class="k">let</span> <span class="nv">createRule</span> <span class="o">=</span> <span class="n">createFilter</span> <span class="o">&gt;&gt;</span> <span class="n">createPredicate</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Let me create a new record type <code>BucketRule</code> which holds this string and the predicate</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">BucketRule</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Label</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Rule</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="kt">bool</span><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">createBucketRule</span> <span class="n">filterString</span> <span class="o">=</span>
</span><span class="line">  <span class="o">{</span> <span class="n">Label</span> <span class="o">=</span> <span class="n">filterString</span><span class="o">;</span> <span class="n">Rule</span> <span class="o">=</span> <span class="n">createRule</span> <span class="n">filterString</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now we have all required functions and it’s time to do the data grouping</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">createBucket</span> <span class="n">numbers</span> <span class="n">bucketRule</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">bucketContent</span> <span class="o">=</span> <span class="n">numbers</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="n">bucketRule</span><span class="o">.</span><span class="n">Rule</span>
</span><span class="line">  <span class="o">(</span><span class="n">bucketRule</span><span class="o">.</span><span class="n">Label</span><span class="o">,</span> <span class="n">bucketContent</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">createBuckets</span> <span class="n">numbers</span> <span class="n">filterStrings</span>  <span class="o">=</span>
</span><span class="line">  <span class="n">filterStrings</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">createBucketRule</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">createBucket</span> <span class="n">numbers</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="summary">Summary</h2>

<p>Though the problem that we have seen is so trivial, the great features in fsharp make it very pleasant to write expressive code to solve it. The complete code snippet is available in <a href="http://fssnip.net/qZ">fssnipnet</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Some tips for Using C# Libraries in F#]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/04/30/some-tips-for-using-c-number-libraries-in-f-number/"/>
    <updated>2015-04-30T11:19:53+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/04/30/some-tips-for-using-c-number-libraries-in-f-number</id>
    <content type="html"><![CDATA[<p>In my <a href="http://blog.tamizhvendan.in/blog/2015/04/25/my-takeaways/">last blog post</a> on what I’ve learned while developing a complete web application in fsharp, I’ve mentioned that we can leverage all the libraries that were written for csharp in fsharp. </p>

<p>Fsharp is a hybrid programming language which supports both functional programming and object oriented programming. Though you can write an application completely in a functional way, when you need to integrate with other .NET languages, you may need to use some OO features.</p>

<p>As both the languages has its own design and principles (immutable types, not allowing null, etc.,), the integration of these is not straightforward in certain scenarios. In this blog post you are going to learn how to handle these tricky scenarios. </p>

<h2 id="allownullliteral-attribute">AllowNullLiteral Attribute</h2>

<p>When you <a href="http://fsharpforfunandprofit.com/posts/classes/">create a class in F#</a>, by default, we can’t explicitly assign a null value to an instance of the class unlike C#. You will get a compiler error when you do it. It’s a great feature and it helps in getting rid of Null Reference exceptions. </p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fs_cs_interop/NullError.png" /></p>

<p>But in certain cases, we may need to assign a null value to a class. For example, let us take the <a href="https://msdn.microsoft.com/en-us/library/dn497475(v=vs.108).aspx">Find method</a> in the Asp.Net identity framework. It returns a user with the specified username and password or null if there is a no match. </p>

<p>When you try to use this in a fsharp code, you will be getting a compiler error</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fs_cs_interop/UserNullError.png" /></p>

<p>It’s where <a href="https://msdn.microsoft.com/en-us/library/ee353608.aspx?f=255&amp;MSPPError=-2147217396">AllowNullLiteral attribute</a> comes into the picture. If you want to make a class type to allow null literal as one of its value, you need to decorate that class with the AllowNullLiteral attribute.</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fs_cs_interop/AllowNullAttr.png" /></p>

<h2 id="climutable-attribute">CLIMutable Attribute</h2>

<p>When a fsharp Record type is compiled, it has been translated to a Common Language Infrastructure (CLI) representation of a typical <a href="http://blog.pluralsight.com/domain-driven-design-in-csharp-implementing-immutable-value-objects">value object declaration</a> in C#.</p>

<p><img class="center border" src="http://blog.tamizhvendan.in/images/fs_cs_interop/Record_Type_Compilation.png" /></p>

<p>The important thing to notice here is there is no default constructor! </p>

<p>Certain libraries and frameworks requires a class to contain default constructor. For example, the <a href="http://www.asp.net/web-api/overview/formats-and-model-binding/parameter-binding-in-aspnet-web-api">model binding</a> feature in Asp.Net framework expects the class with a default constructor to bind the incoming request to a parameter in the action method. You will get a run-time error if the class doesn’t contain default constructor.</p>

<p>So, if we need to have a default constructor for a fsharp record type when it get compiled, we need to decorate the record type with the <a href="https://msdn.microsoft.com/en-us/library/hh289724.aspx">CLIMutable attribute</a></p>

<p>The Ppesence of this attribute enables the compiler to generate the default constructor and the property setters when the code gets compiled to IL</p>

<p><img class="center border" src="http://blog.tamizhvendan.in/images/fs_cs_interop/Record_Type_Attr_Compilation.png" /></p>

<h2 id="using-dynamic-types">Using Dynamic Types</h2>

<p>In C#, we can create a <a href="https://msdn.microsoft.com/en-IN/library/dd264736.aspx">dynamic type</a> which bypasses static type checking and helps to hold the data together without declaring any types. </p>

<p>The <a href="http://stackoverflow.com/questions/14896013/how-viewbag-in-asp-net-mvc-works">ViewBag feature</a> in Asp.Net MVC is a one of the best examples of using dynamic types. It allows you to put any arbitary data in it and use them in the razor views.</p>

<p>There is no straightforward way to access the dynamic types in fsharp.</p>

<p><img class="center border" src="http://blog.tamizhvendan.in/images/fs_cs_interop/ViewBagError.png" /></p>

<p>If we would like to access dynamic types in fsharp we need to use the <a href="https://www.nuget.org/packages/ImpromptuInterface.FSharp/">ImpromptuInterface.FSharp</a> nuget package.</p>

<p>This package defines the <code>?</code> operator, which provides the implementation for accessing dynamic types.</p>

<p><img class="center border" src="http://blog.tamizhvendan.in/images/fs_cs_interop/Dynamic_Operator.png" /></p>

<h2 id="summary">Summary</h2>

<p>In this blog post we have seen three tips which can help us while using C# libraries in F#. If you know any other interoperability tips, kindly leave a comment below. </p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[My Takeaways]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/04/25/my-takeaways/"/>
    <updated>2015-04-25T15:09:02+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/04/25/my-takeaways</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is the concluding part of my blog series on <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>I would like to begin this blog post by thanking <a href="https://twitter.com/jsonmez">John Sonmez</a> for his inspirational video on <a href="http://simpleprogrammer.com/2014/01/09/importance-finishing-started/">the importance of finishing what you started</a>. I haven’t written any blog series <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">like this</a> before, so during this course, I was about to give up but the statement </p>

<p style="text-align:center"> <strong> Finish what you started </strong> </p>

<p>kept me going. Thank you John, I have learned a great lesson in my life from you.</p>

<p>Back to the business, In this blog post I am going to share my key takeaways on developing a complete web application in fsharp using ASP.NET MVC</p>

<h2 id="enterprise-application-development-in-fsharp">Enterprise application development in fsharp</h2>

<p>As a learner of F#, I have spent lots of time in listening to <a href="https://vimeo.com/channels/c4fsharp">the great talks</a> by the vibrant <a href="http://c4fsharp.net/">fsharp community</a>. Though those talks are great, I was intrigued, how these individual pieces would work together in creating a complete enterprise application. Is it really possible? </p>

<p>Developing this complete <a href="https://github.com/tamizhvendan/fsharp-phonecat">fsharp-phonecat</a> application answered my questions and I am sure it answered yours too. It may appear hard because of less sources and functional paradigm, but once you figured it out, it would be a cakewalk.</p>

<p>The bottom line is <strong>we can create a complete enterprise application in fsharp</strong>. As a matter of fact, there is a book written on this subject, <a href="http://www.amazon.com/gp/product/1617291323/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1617291323&amp;linkCode=as2&amp;tag=bor0b-20&amp;linkId=SYG2CSFARCGD5KUL">F# Deep Dives</a></p>

<p>If you are not convinced yet, read <a href="http://fsharp.org/testimonials/">these testimonials</a> from the commercial users of F#. </p>

<h2 id="leveraging-the-existing-net-ecosystem">Leveraging the existing .NET ecosystem</h2>

<p>In my perspective F# is a <em>pragmatic functional programming language</em>. In addition to lot of elegant features of the language, it works seamlessly with the existing .NET libraries. This one characteristic I would say is a blessing. You can say, ‘This feature is really cool’, but at the end of the day it should help you to get the job done. F# is not only cool, It can help you too!</p>

<p>In the sample application we have leveraged the <a href="http://blog.tamizhvendan.in/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">Web Api 2</a>, <a href="http://blog.tamizhvendan.in/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">Razor Views</a>, <a href="http://blog.tamizhvendan.in/blog/2015/02/04/step-6-authentication-using-owin-middleware-and-asp-dot-net-identity/">Asp.Net Identity</a> and the Asp.Net framework itself. So, you can do whatever you are doing in C# in F#! ( With less lines of code <i class="emoji smile"></i>)</p>

<h2 id="using-f-in-your-existing-c-codebase">Using F# in your existing C# Codebase</h2>

<p>As F# is a <a href="http://en.wikipedia.org/wiki/List_of_CLI_languages#CLI_languages">CLI Language</a> it can be added to your existing C# solution. All you need to do just create a new F# project in the solution and this project can work seamlessly with the other projects in the solution. </p>

<p>In the sample application, we have a <a href="http://blog.tamizhvendan.in/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec/">created a parser</a> for a search criteria DSL using <a href="http://www.quanttec.com/fparsec/">FParsec</a>. Doing this in C# would be very hard. So we can easily wrap this F# implementation in a class library and use it from any C# codebase. </p>

<p>In the <a href="http://blog.tamizhvendan.in/blog/2015/01/06/step-4-build-automation-using-fake/">step-5</a> we have automated build process using <a href="http://fsharp.github.io/FAKE/">FAKE</a> which is <em>far</em> better than its counterpart verbose MSBuild xml files. This can be used in any .NET projects!</p>

<h2 id="less-is-beautiful">Less is beautiful</h2>

<p>Another cool aspect of F# is you will be writing less lines of code to achieve complex things. It took only <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/5/Domain/SearchParser.fs#L10-L44">35 lines of code</a> to create a parser for a DSL. </p>

<p><a href="http://fsharpforfunandprofit.com/rop/">Railway Oriented Programming</a> by <a href="https://twitter.com/ScottWlaschin">Scott Wlaschin</a> is an absolute gem. If you would like to know what F# brings to your plate, I strongly suggest you to listen his talk on <a href="http://fsharpforfunandprofit.com/fppatterns/">Functional Design Patterns</a>. The way you see programming will never be the same after you have seen this presentation. </p>

<h2 id="summary">Summary</h2>

<p>In nutshell, F# is just an awesome programming language to create applications. I hope you would have enjoyed this series. If you have any suggestions, kindly leave a comment.</p>

<p>I would like to conclude this post with the below formula</p>

<p style="text-align:center"> <strong> Python + .NET = F# </strong> </p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-10 Refactoring Composition Root]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/04/02/step-10-refactoring-composition-root/"/>
    <updated>2015-04-02T17:07:23+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/04/02/step-10-refactoring-composition-root</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 10 of my blog series on <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p> </p>

<p>In the fsharp-phonecat application that we are creating as part of this series, to <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/9/Web/MvcInfrastructure.fs#L14-L48">create the controller instances</a>, we are using <a href="http://blog.ploeh.dk/2014/06/10/pure-di/">Pure DI</a>. Though this <a href="http://blog.ploeh.dk/2011/07/28/CompositionRoot/">composition root</a> solves the problem of <a href="http://blog.ploeh.dk/2012/11/06/WhentouseaDIContainer/">dependency injection</a>, the quality of the code is not up to the mark. </p>

<p>In this blog post we are going to refactor this and make it shorter and more F# idiomatic.</p>

<h3 id="the-current-state-of-getcontrollerinstance-method">The current state of GetControllerInstance method</h3>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_10/if_else_tangle.png" /></p>

<p> 
 </p>

<p>It’s if full of <strong>if..else if.. else if.. else</strong> and the method is too long</p>

<p>As depicted in the above screenshot, the <code>GetControllerInstance</code> method does the following three things for all the controller types in the application</p>

<ul>
  <li>Checks the incoming controller type</li>
  <li>Creates the requested controller instance</li>
  <li>Returns the created controller instance</li>
</ul>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_10/home_controller_creation.png" /></p>

<p>This can be refactored to a function</p>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_10/home_controller_function.png" /></p>

<p>The function takes a type and returns an <a href="http://fsharpforfunandprofit.com/posts/the-option-type/">Option type</a> of <code>IController</code></p>

<p>Let’s do the same for an another controller creation which is little complex than this.</p>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_10/phone_controller_function.png" /></p>

<p>Here in this case to create an instance of <code>PhoneController</code> we need two additional parameters, Phones sequence and anonymous id of the session.</p>

<p>With these functions in place, the <code>GetControllerInstance</code> method would look like as below</p>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_10/match_with_some_and_none.png" /></p>

<p>Though the functions that have created has reduced the size of the method, it has introduced an another problem (<a href="http://raynos.github.io/presentation/shower/controlflow.htm?full#PyramidOfDoom">Pyramid Of Doom</a>) as indicated by the arrow in the screenshot. </p>

<p>We can get rid of this using a bind function as we did in <a href="http://blog.tamizhvendan.in/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/">validation step using rop</a>.</p>

<p>The downside of the <a href="http://fsharpforfunandprofit.com/posts/computation-expressions-bind/">bind function</a> is it’s not generic and we can’t reuse the existing bind function that we have created for doing validation.</p>

<p>So, going with this approach would lead to adding more code which is not in alignment with the objective of this refactoring.</p>

<p>What can we do ??</p>

<p> 
 
 
 
 
 
 
 
 
 
 
 </p>

<p>The answer is <strong><a href="http://en.wikibooks.org/wiki/F_Sharp_Programming/Active_Patterns">Active Patterns</a></strong></p>

<blockquote>
  <p>Active Patterns allow programmers to wrap arbitrary values in a union-like data structure for easy pattern matching. For example, its possible wrap objects with an active pattern, so that you can use objects in pattern matching as easily as any other union type -    <em>F# Programming WikiBook</em></p>
</blockquote>

<p>We are going to use <a href="http://en.wikibooks.org/wiki/F_Sharp_Programming/Active_Patterns#Partial_Active_Patterns">Partial Active Patterns</a> to refactor the composition root.</p>

<h3 id="creating-partial-active-patterns">Creating Partial Active Patterns</h3>

<p>Let’s start by creating a partial active pattern for <code>HomeController</code></p>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_10/home_controller_active_pattern.png" /></p>

<p>As described in the screenshot, it’s very similar to the <code>createHomeController</code> function and the only difference is the addition of the <em>Banana Clips</em> (yellow ellipses). The <code>_</code> symbol makes the active pattern partial.  </p>

<p>The partial active patterns always returns an <code>Option</code> type. </p>

<p>Partial active patterns support defining pattern with multiple parameters. So we can change the <code>createPhoneController</code> function as below</p>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_10/phone_controller_active_pattern.png" /></p>

<p>Great! We are almost done with the refactoring. The pending step is leveraging these partial active patterns in the <code>GetControllerInstance</code> method.</p>

<p>It’s where the <strong>beauty of pattern matching</strong> reveals!</p>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_10/home_controller_pattern_matching.png" /></p>

<p>What’s happening here? </p>

<ul>
  <li>Based on the Active Pattern Name (<code>HomeController</code>), the control goes to the corresponding active pattern</li>
  <li>The value we are matching (<code>controllerType</code>) passed as argument.</li>
  <li>The value returned by the active pattern (instance of <code>HomeController</code>) is assigned to the <code>homeController</code> literal in the match expression</li>
  <li>If none of the pattern has met the matching criteria, it executes the default match (raising the exception)</li>
</ul>

<p>It does the same thing for the Active Patterns with multiple parameters</p>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_10/phone_controller_pattern_matching.png" /></p>

<p>The only thing to note here is, the value against which we are matching is always passed as a last argument.</p>

<p>That’s it!!</p>

<p>After completing the creation of partial active patterns for all the other controller types in the application, the <code>GetControllerInstance</code> would be shorter like this</p>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_10/composition_root_final.png" /></p>

<p> 
 
 
 
 
 
 
 </p>

<p><img class="border center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_10/awesomeness.gif" /></p>

<h3 id="summary">Summary</h3>

<p>Moving from C# to F#, it’s not just change in syntax! It’s much more than that. The perfect analogy for this refactoring is the classic proverb <em>When in Rome, do as the Romans do</em>. You can find the complete source code of this step in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/10">phonecat github repository</a></p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-9 Adding Checkout]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/03/28/step-9-adding-checkout/"/>
    <updated>2015-03-28T13:07:20+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/03/28/step-9-adding-checkout</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 9 of my blog series on <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="http://blog.tamizhvendan.in/blog/2015/03/20/step-8-adding-shopping-cart/">last blog post</a> we have added the shopping cart feature to our phonecat application and in this blog post we are going to implement the checkout feature.</p>

<p>Implementing the checkout feature involves two steps.<br />
  1. Adding a View Cart Page<br />
  2. Processing the Checkout and creating an order</p>

<h3 id="adding-a-view-cart-page">Adding a View Cart Page</h3>

<p><img class="border" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_9/view-cart.png" /></p>

<p>As we have done in the previous posts, let’s begin by extending our shopping cart domain. The first step is to add a function to retrieve the items in the shopping cart. </p>

<p>Open <code>ShoppingCart</code> module in the <strong>Domain</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getItems</span> <span class="n">cart</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">cart</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Empty</span> <span class="o">-&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Active</span> <span class="n">items</span> <span class="o">-&gt;</span> <span class="n">items</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">toSeq</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The above function retrieves the phone ids present in the cart. In order to show a detailed checkout page, we need to get the associated phone details of these phone ids. Right now we don’t have this capability in our app so let’s add them.</p>

<p>Open <code>Phones</code> module in the <strong>Domain</strong> project and add the below functions</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">contains</span> <span class="n">x</span> <span class="o">=</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">exists</span> <span class="o">((=)</span> <span class="n">x</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">getPhonesByIds</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="n">phoneIds</span> <span class="o">=</span>
</span><span class="line">  <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">contains</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="n">phoneIds</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>contains</code> function is a utility function which checks whether the given element is present in a <code>seq</code> or not and the <code>getPhonesByIds</code> function filters phones in the system by the incoming phone ids and returns the requested ones.</p>

<p>Now we have all the bare bones and the next step is defining a controller to serve the View Cart Page.</p>

<p>Add a new Source file <code>CheckoutController</code> in the <strong>Web</strong> project under <em>Controllers</em> directory and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CheckoutController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">      <span class="n">getPhones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">      <span class="n">cart</span> <span class="o">:</span> <span class="n">Cart</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span> <span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">ViewCart</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="n">cart</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">getItems</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">getPhones</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">this</span><span class="o">.</span><span class="n">View</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>ViewCart</code> action method uses the two functions that we have defined before and renders the <code>ViewCart</code> view. Add a new razor view with the name <code>ViewCart</code> in the <em>Views\Checkout</em> Directory and update it <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/9/Web/Views/Checkout/ViewCart.cshtml#L1-L30">as described here</a>. </p>

<p>The final step in rendering this view is gluing the components together in the <code>CheckoutController</code> controller instance creation. </p>

<p>To get the cart associated with the given session id we have added <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/8/Web/Infrastructure.fs#L41-L45">a piece of logic</a> in the last step which checks the presence of <code>Cart</code> for the given anonymous id in the <code>CartStorage</code> and creates the cart if it doesn’t contain. Since we need the same logic here, let’s move this logic to a function <code>getOrCreate</code> in the <code>CartStorage</code> module and reuse it in both the places</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getOrCreate</span> <span class="n">anonymousId</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">get</span> <span class="n">anonymousId</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">cart</span> <span class="o">-&gt;</span> <span class="n">cart</span>
</span><span class="line">  <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="n">create</span> <span class="n">anonymousId</span> <span class="nn">ShoppingCart</span><span class="p">.</span><span class="n">Empty</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Then open <code>MvcInfrastructure</code> module in the <strong>Web</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">    <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="c1">// ... existing code ...</span>
</span><span class="line">    <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">CheckoutController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">anonymousID</span> <span class="o">=</span> <span class="n">requestContext</span><span class="o">.</span><span class="n">HttpContext</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">AnonymousID</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">shoppingCart</span> <span class="o">=</span> <span class="nn">CartStorage</span><span class="p">.</span><span class="n">getOrCreate</span> <span class="n">anonymousID</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">getPhonesByIds</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span> <span class="o">|&gt;</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getPhonesByIds</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">checkoutController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CheckoutController</span><span class="o">(</span><span class="n">getPhonesByIds</span><span class="o">,</span> <span class="n">shoppingCart</span><span class="o">)</span>
</span><span class="line">      <span class="n">checkoutController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">    <span class="c1">// ... existing code ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The composition of <code>CheckoutController</code> is similar to that of other controllers in the application. We get the cart associated with the given anonymous id and then create a partial applied function of <code>Phones.getPhonesByIds</code> by passing the first argument (phones in the app) alone.</p>

<p>That’s it. The Cart View is up and running!</p>

<h3 id="processing-the-checkout">Processing the Checkout</h3>

<p>As mentioned in the beginning, the next step after displaying the shopping cart page is processing the checkout and creating an order. </p>

<p>Let’s begin by defining the domain for Orders.</p>

<p>Create a source file with the name <code>Orders</code> in the <strong>Domain</strong> project and add the following types</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Orders</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">OrderRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">UserId</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ProductIds</span> <span class="o">:</span> <span class="n">ProductId</span> <span class="n">seq</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">OrderConfirmed</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">OrderId</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">UserId</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ProductIds</span> <span class="o">:</span> <span class="n">ProductId</span> <span class="n">seq</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>OrderRequest</code> type represents the order being placed by the user and the <code>OrderConfirmed</code> type represents the successful order creation.</p>

<p>To Keep things simple, we are just going to see the order confirmation and we are intentionally leaving out error handling and validation. We can easily <a href="http://blog.tamizhvendan.in/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/">add them as we did</a>  it in the user registration step and I leave it you as an exercise.</p>

<p>The next step is storing the incoming order. </p>

<p>Create a source file with the name <code>OrderStorage</code> in the <strong>DataAccess</strong> project and add the following function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">OrderStorage</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">placeOrder</span> <span class="o">(</span><span class="n">orderRequest</span> <span class="o">:</span> <span class="n">OrderRequest</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">orderId</span> <span class="o">=</span> <span class="nn">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="bp">()</span><span class="o">.</span><span class="n">ToString</span><span class="bp">()</span>
</span><span class="line">    <span class="o">{</span><span class="n">OrderId</span> <span class="o">=</span> <span class="n">orderId</span><span class="o">;</span> <span class="n">UserId</span> <span class="o">=</span> <span class="n">orderRequest</span><span class="o">.</span><span class="n">UserId</span><span class="o">;</span> <span class="n">ProductIds</span> <span class="o">=</span> <span class="n">orderRequest</span><span class="o">.</span><span class="n">ProductIds</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here we are just faked the implementation of order storage by generating a new <code>Guid</code> and returning it as Order Id</p>

<p>Now it’s time for adding a <code>OrderController</code> in the <strong>Web</strong> project to handle the checkout and creating the order using the components defined above.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">OrderController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">cart</span> <span class="o">:</span> <span class="n">Cart</span><span class="o">,</span>
</span><span class="line">    <span class="n">placeOrder</span> <span class="o">:</span> <span class="n">OrderRequest</span> <span class="o">-&gt;</span> <span class="n">OrderConfirmed</span><span class="o">,</span>
</span><span class="line">    <span class="n">updateCart</span> <span class="o">:</span> <span class="n">Cart</span> <span class="o">-&gt;</span> <span class="n">Cart</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span> <span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Authorize</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Checkout</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">identity</span> <span class="o">=</span> <span class="k">base</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">Identity</span> <span class="o">:?&gt;</span> <span class="n">ClaimsIdentity</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userId</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">FindFirst</span><span class="o">(</span><span class="nn">ClaimTypes</span><span class="p">.</span><span class="n">Name</span><span class="o">).</span><span class="n">Value</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">orderConfirmed</span> <span class="o">=</span> <span class="n">placeOrder</span> <span class="o">{</span> <span class="n">UserId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span> <span class="n">ProductIds</span> <span class="o">=</span> <span class="n">getItems</span> <span class="n">cart</span><span class="o">}</span>
</span><span class="line">    <span class="n">updateCart</span> <span class="nn">Cart</span><span class="p">.</span><span class="n">Empty</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">orderConfirmed</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The checkout method is straightforward. We get the <code>UserId</code> from the <code>User.Identity</code> property and place the order using it. Upon successful order confirmation, we are clearing the shopping cart and rendering the <code>Checkout</code> view.</p>

<p><img class="border" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_9/order-confirmation.png" /></p>

<p>The important thing to notice here the <code>Authorize</code> attribute. Just like any other e-commerce portal, we are not allowing anonymous check out here. The presence of <a href="https://msdn.microsoft.com/en-us/library/system.web.mvc.authorizeattribute%28v=vs.118%29.aspx">this authorize attribute</a> ensures that only logged in users are checking out and in case if they are not logged in it would redirect the user to the login page.</p>

<p>The last step is updating the composition root to create the <code>OrderController</code> instance.</p>

<p>Open <code>MvcInfrasturcture</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">    <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="c1">// ... existing code ...</span>
</span><span class="line">    <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">OrderController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">anonymousID</span> <span class="o">=</span> <span class="n">requestContext</span><span class="o">.</span><span class="n">HttpContext</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">AnonymousID</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">shoppingCart</span> <span class="o">=</span> <span class="nn">CartStorage</span><span class="p">.</span><span class="n">getOrCreate</span> <span class="n">anonymousID</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">updateCart</span> <span class="o">=</span> <span class="nn">CartStorage</span><span class="p">.</span><span class="n">update</span> <span class="n">anonymousID</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">orderController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderController</span><span class="o">(</span><span class="n">shoppingCart</span><span class="o">,</span> <span class="nn">OrderStorage</span><span class="p">.</span><span class="n">placeOrder</span><span class="o">,</span> <span class="n">updateCart</span><span class="o">)</span>
</span><span class="line">      <span class="n">orderController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">    <span class="c1">// ... existing code ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We are done!</p>

<h3 id="summary">Summary</h3>

<p>We have come a long way from just setting up the visual studio project to a complete prototype of an e-commerce site and I hope you would have enjoyed this series of blog post. In the next blog post we are going to refactor the <code>CompositionRoot</code>which is getting clumsy with a series of <code>if..else if..</code> expressions using Active Patterns and I will be wrapping this series by an another post which will be reflecting back on what I have learned by writing this blog series.</p>

<p>You can find the source code of this step in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/9">fsharp-phonecat github repository</a></p>

<p>Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-8 Adding Shopping Cart]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/03/20/step-8-adding-shopping-cart/"/>
    <updated>2015-03-20T11:49:35+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/03/20/step-8-adding-shopping-cart</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 8 of my blog series on <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="http://blog.tamizhvendan.in/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/">last blog post</a> we have seen how to do validation and error handling in fsharp and in this blog post we are going to add shopping cart feature to the phone-cat application that we are developing in this blog series. To keep this blog post simple, we are going to see only adding an item to shopping cart. Remvoing an item from shopping cart is a straightforward implementation and I leave it to you as an exercise</p>

<p><img src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_8/cart_intro.png" /></p>

<h3 id="the-shopping-cart-domain">The Shopping Cart Domain</h3>

<p>Let’s start with defining the domain model for handling shopping cart. Create a source file <code>ShoppingCart</code> in the <strong>Domain</strong> project and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">ShoppingCart</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">ProductId</span> <span class="o">=</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">Cart</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Empty</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Active</span> <span class="k">of</span> <span class="n">ProductId</span> <span class="n">List</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">addItem</span> <span class="n">cart</span> <span class="n">productId</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">cart</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Empty</span> <span class="o">-&gt;</span> <span class="n">Active</span> <span class="o">[</span><span class="n">productId</span><span class="o">]</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Active</span> <span class="n">items</span> <span class="o">-&gt;</span> <span class="n">Active</span> <span class="o">(</span><span class="n">productId</span> <span class="o">::</span> <span class="n">items</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>ProductId</code> is an alias of <code>string</code> type represents the id of the phone.</p>

<p>The <code>Cart</code> is a <code>Sum</code> type represents the two possible states of Shopping Cart. The <code>Cart</code> would be either empty or contain product ids that has been added to the cart.</p>

<p>We have added a function which adds a product id to the cart. It just checks the state of the cart and based on the state it either creates the cart with <code>Active</code> state or appends the product id to the existing list.</p>

<p>Thanks to the strong fsharp type system, we have modeled the domain with less lines of code.</p>

<h3 id="persisting-shopping-cart">Persisting Shopping Cart</h3>

<p>Now we have the domain logic to represent the shopping cart and adding items to it. The next step is persisting the cart. We can persist it anywhere as the domain model is persistent ignorant. To keep things simple, we will be persisting it in-memory. </p>

<p>As we did during the <a href="http://blog.tamizhvendan.in/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/">recommendation step</a> we will be using a dictionary to store the cart with Asp.Net’s <a href="http://msdn.microsoft.com/en-us/library/system.web.httprequest.anonymousid%28v=vs.110%29.aspx">anonymousId</a> as the key. </p>

<p>Create a source file <code>CartStorage</code> in the <strong>DataAccess</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">CartStorage</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">inMemoryStorage</span> <span class="o">=</span>
</span><span class="line">    <span class="k">new</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="n">Cart</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">create</span> <span class="n">anonymousId</span> <span class="n">cart</span> <span class="o">=</span>
</span><span class="line">    <span class="n">inMemoryStorage</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">cart</span><span class="o">)</span>
</span><span class="line">    <span class="n">cart</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">update</span> <span class="n">anonymousId</span> <span class="n">cart</span> <span class="o">=</span>
</span><span class="line">    <span class="n">inMemoryStorage</span><span class="o">.</span><span class="n">Remove</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="n">create</span> <span class="n">anonymousId</span> <span class="n">cart</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">get</span> <span class="n">anonymousId</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">inMemoryStorage</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">)</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="k">true</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">inMemoryStorage</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The code is very straight forward to understand. It contains typical CRUD operations of a shopping cart using an in-memory dictionary object.</p>

<h3 id="shopping-cart-api">Shopping Cart Api</h3>

<p>It’s time to code the api for the shopping cart. Let’s add a source file <code>ShoppingCartController</code> in the <strong>Web</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/cart&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">ShoppingCartController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">cart</span> <span class="o">:</span> <span class="n">Cart</span><span class="o">,</span>
</span><span class="line">    <span class="n">updateCart</span> <span class="o">:</span> <span class="n">Cart</span> <span class="o">-&gt;</span> <span class="n">Cart</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">ApiController</span> <span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Get</span><span class="bp">()</span> <span class="o">=</span> <span class="n">cart</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;add&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">AddItem</span><span class="o">([&lt;</span><span class="n">FromBody</span><span class="o">&gt;]</span><span class="n">productId</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">addItem</span> <span class="n">cart</span> <span class="n">productId</span> <span class="o">|&gt;</span> <span class="n">updateCart</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>ShoppingCartController</code> has two dependencies.<br />
  1. <code>Cart</code> - Cart associated with the current session<br />
  2. <code>updateCart</code> - a function to update the cart</p>

<p>To keep it simple, I haven’t added error handling or validation here. The action method <code>Get</code> returns the cart and the action method <code>AddItem</code> adds the item to the cart and then update the cart in the storage.</p>

<h3 id="wiring-things-up">Wiring things up</h3>

<p>Now we have all the pieces to add shopping cart to our application and the final step is tying them together. As we did it in other steps we need to do it in the composition root. Open <code>Infrastructure</code> in the <strong>Web</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="c1">// ... Exisitng Code ...</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">interface</span> <span class="n">IHttpControllerActivator</span> <span class="k">with</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">controllerDescriptor</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="c1">// ... Exisiting Code ...</span>
</span><span class="line">      <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">ShoppingCartController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">anonymousID</span> <span class="o">=</span> <span class="nn">HttpContext</span><span class="p">.</span><span class="nn">Current</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="n">AnonymousID</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">shoppingCart</span> <span class="o">=</span>
</span><span class="line">          <span class="k">match</span> <span class="nn">CartStorage</span><span class="p">.</span><span class="n">get</span> <span class="n">anonymousID</span> <span class="k">with</span>
</span><span class="line">          <span class="o">|</span> <span class="n">Some</span> <span class="n">cart</span> <span class="o">-&gt;</span> <span class="n">cart</span>
</span><span class="line">          <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="nn">CartStorage</span><span class="p">.</span><span class="n">create</span> <span class="n">anonymousID</span> <span class="nn">ShoppingCart</span><span class="p">.</span><span class="n">Empty</span>
</span><span class="line">
</span><span class="line">        <span class="k">let</span> <span class="nv">shoppingCartController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ShoppingCartController</span><span class="o">(</span><span class="n">shoppingCart</span><span class="o">,</span> <span class="nn">CartStorage</span><span class="p">.</span><span class="n">update</span> <span class="n">anonymousID</span><span class="o">)</span>
</span><span class="line">        <span class="n">shoppingCartController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">      <span class="c1">// ... Existing Code ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here before the creating an instance of <code>ShoppingCartController</code> we retrieve the anonymous id from the incoming request and get the cart associated with the anonymous id from the storage. In case if the cart is not available, we are creating one. For the <code>update</code> function, we pass the partially applied <code>update</code> function of <code>CartStorage</code>.</p>

<p>That’s it!!</p>

<h3 id="the-front-end-code">The front-end code</h3>

<p>In the front end, we just call the <code>ShoppingCartController</code> action methods using plain jQuery ajax methods and update the UI. Since it is out of the scope of this blog post I haven’t covered it here and you can find <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/8/Web/Scripts/site.js">the code here</a>.</p>

<h3 id="summary">Summary</h3>

<p>In this blog post we have seen how to implement shopping cart in a web application written in fsharp. I leave some exercises for you to extend it to use some other storage and also to add validation and error handling. You can find the source code in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/8">github phonecat repository</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-7 Validation and Error Handling using ROP]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/"/>
    <updated>2015-03-02T12:30:33+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/03/02/step-7-validation-and-error-handling-using-rop</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 7 of my blog series on <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="http://blog.tamizhvendan.in/blog/2015/02/04/step-6-authentication-using-owin-middleware-and-asp-dot-net-identity/">last blog post</a> we have seen how to register a new user using the Asp.Net Identity Management framework. Validating the incoming data before updating the backend datastore and handling error while saving are typical tasks in a web application. In this blog post we are going to see how to achieve these things in a web application written in fsharp. As mentioned in the last blog post we will be adding validation logic for new user registration using <a href="http://fsharpforfunandprofit.com/rop/">Railway oriented Programming</a> aka <em>ROP</em>.</p>

<h3 id="cleanup">Cleanup</h3>

<p>Before adding the validation,  let’s do some cleanup and make it ready for adding validation. </p>

<p>Create a new source file <code>UserStorage</code> in the <strong>Identity</strong> project and move the user manager creation logic from <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/6/Web/MvcInfrastructure.fs#L15-L20">MvcInfrastructure</a> to here.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">UserStorage</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">createUserManager</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userStore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserStore</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">UserDbContext</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userStore</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userValidator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserValidator</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userManager</span><span class="o">)</span>
</span><span class="line">    <span class="n">userValidator</span><span class="o">.</span><span class="n">AllowOnlyAlphanumericUserNames</span> <span class="o">&lt;-</span> <span class="k">false</span>
</span><span class="line">    <span class="n">userManager</span><span class="o">.</span><span class="n">UserValidator</span> <span class="o">&lt;-</span> <span class="n">userValidator</span>
</span><span class="line">    <span class="n">userManager</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Create a Request record type in <code>Users</code> that represents the request for creating a new user</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CreateUserRequest</span> <span class="o">=</span> <span class="o">{</span><span class="n">Name</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Password</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Email</span> <span class="o">:</span> <span class="kt">string</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then move the user creation logic from Authentication Controller’s <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/6/Web/Controllers/AuthenticationController.fs#L62-L65">Register action method</a> to <code>UserStorage</code> and update it to use <code>CreateUserRequest</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">createUser</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">,</span>
</span><span class="line">                      <span class="n">UserName</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">,</span>
</span><span class="line">                      <span class="n">Email</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">userManager</span><span class="o">.</span><span class="n">Create</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Finally, update the <code>Register</code> action method in <code>AuthenticationController</code> to use the above function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">createUserRequest</span> <span class="o">:</span> <span class="n">CreateUserRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span>
</span><span class="line">    <span class="n">Email</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span><span class="o">;</span>
</span><span class="line">    <span class="n">Password</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Password</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userCreateResult</span> <span class="o">=</span> <span class="nn">Users</span><span class="p">.</span><span class="n">createUser</span> <span class="n">userManager</span> <span class="n">createUserRequest</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">userCreateResult</span><span class="o">.</span><span class="n">Succeeded</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="n">userCreateResult</span><span class="o">.</span><span class="n">Errors</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">iter</span><span class="o">(</span><span class="k">fun</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">err</span><span class="o">))</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">registerViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With this we are wrapping the cleanup work and all set for adding validation.</p>

<h3 id="adding-validation">Adding Validation</h3>

<p>The first step in ROP is defining the “two tracks”. The track <code>Success</code> represents a successful operation (here its validation) and the other track <code>Failure</code> represents the failure while executing an operation. Usually these “two tracks” will be defined using a discriminated union.</p>

<p>Create a source file <code>Rop</code> in the <strong>Identity</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Rop</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">Error</span> <span class="o">=</span> <span class="o">{</span><span class="n">Property</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Message</span> <span class="o">:</span> <span class="kt">string</span><span class="o">}</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">Result</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Success</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">a</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Failure</span> <span class="k">of</span> <span class="n">Error</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Error</code> type provides the metadata associated with the error.</p>

<p>Let’s start writing validation rules from validating Name. Create a source file <code>NameValidation</code> in <strong>Identity</strong> project and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">NameValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameEmptiness</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span>
</span><span class="line">          <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span> <span class="o">&lt;&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">Empty</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Name&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Name is required&quot;</span><span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameLength</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">        <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Name&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Name should not contain more than 50 characters&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Hope these rules are self-explanatory. We are just validating the name for emptiness and length, and based on the result we are returning either the <code>Success</code> track or <code>Failure</code> track.</p>

<p>Next, add validation rules for Password. Similar to Name Validation add a source file with the name <code>PasswordValidation</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">PasswordValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordEmptiness</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span>
</span><span class="line">          <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span> <span class="o">&lt;&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">Empty</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Password&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Password is required&quot;</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordLength</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Password&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Password should not contain more than 10 characters&quot;</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordStrength</span>  <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">specialCharacters</span> <span class="o">=</span> <span class="o">[</span> <span class="s">&quot;*&quot;</span><span class="o">;</span> <span class="s">&quot;&amp;&quot;</span><span class="o">;</span> <span class="s">&quot;%&quot;</span><span class="o">;</span> <span class="s">&quot;$&quot;</span> <span class="o">]</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">hasSpecialCharacters</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="n">String</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="n">specialCharacters</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">exists</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">errorMessage</span> <span class="o">=</span>
</span><span class="line">      <span class="s">&quot;Password should contain atleast one of the special characters &quot;</span>
</span><span class="line">        <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">Join</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">,</span> <span class="n">specialCharacters</span><span class="o">)</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="n">hasSpecialCharacters</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="n">errorMessage</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In addition to the two validation rules that we have seen in <code>NameValidation</code> here we have added one more validation to verify the presence of special characters in the <code>Password</code>.</p>

<p>There is a pattern in all the validation rules that we have seen so far. </p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_7/validation_pattern.png" width="450" height="450" /></p>

<p>Let’s extract this pattern out of these validation rules and reduce the lines of code!</p>

<p>Create a new source file <code>Validation</code> and add the write this pattern as a function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Validation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validate</span> <span class="n">isValid</span> <span class="n">property</span> <span class="n">message</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="n">isValid</span> <span class="n">createUserRequest</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span><span class="n">Property</span> <span class="o">=</span> <span class="n">property</span><span class="o">;</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">message</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>validate</code> function represents the outer box of the above diagram which takes four inputs</p>

<ul>
  <li>A function to validate the createUserRequest <code>isValid</code> which has the signature
<code>'a -&gt; bool</code> that represents the validation rule</li>
  <li>A string to show which property is invalid in the error <code>property</code></li>
  <li>A string representing the error <code>message</code></li>
  <li>The last is the incoming userCreateRequest <code>createUserRequest</code></li>
</ul>

<p><em>Note: Property and Message parameters are not shown in the diagram just to express the pattern clearly</em></p>

<p>We also need a small utility function to check the emptiness of the string. So add it in <code>Validation</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">isNonEmptyString</span> <span class="n">str</span> <span class="o">=</span> <span class="n">str</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span> <span class="n">str</span> <span class="o">&lt;&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">Empty</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With these functions in place we can refactor the validation rules that we written before.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">NameValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameEmptiness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isNonEmptyString</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Name&quot;</span>
</span><span class="line">      <span class="s">&quot;Name is required&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameLength</span>  <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Name&quot;</span>
</span><span class="line">      <span class="s">&quot;Name should not contain more than 50 characters&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">PasswordValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordEmptiness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isNonEmptyString</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="s">&quot;Password is required&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordLength</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="s">&quot;Password should not contain more than 10 characters&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">hasSpecialCharacters</span> <span class="n">specialCharacters</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="n">String</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">specialCharacters</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">exists</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordStrength</span>  <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">specialCharacters</span> <span class="o">=</span> <span class="o">[</span> <span class="s">&quot;*&quot;</span><span class="o">;</span> <span class="s">&quot;&amp;&quot;</span><span class="o">;</span> <span class="s">&quot;%&quot;</span><span class="o">;</span> <span class="s">&quot;$&quot;</span> <span class="o">]</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">errorMessage</span> <span class="o">=</span>
</span><span class="line">      <span class="s">&quot;Password should contain atleast one of the special characters &quot;</span>
</span><span class="line">        <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">Join</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">,</span> <span class="n">specialCharacters</span><span class="o">)</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="n">hasSpecialCharacters</span> <span class="n">specialCharacters</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="n">errorMessage</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Much cleaner than the previous version, isn’t it?</p>

<p>The final validation is Email validation. It is very similar to the other validations that we have seen so far. One extra validation is verifying the uniqueness of the email id being used to register.</p>

<p>Create a new source file <code>EmailValidation</code> and add the validations</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">EmailValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">isUniqueEmailAddr</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">emailAddr</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">FindByName</span><span class="o">(</span><span class="n">emailAddr</span><span class="o">)</span>
</span><span class="line">    <span class="n">user</span> <span class="o">=</span> <span class="k">null</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">isValidEmailAddress</span> <span class="n">emailAddr</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">emailAddrRegex</span> <span class="o">=</span>
</span><span class="line">      <span class="s">@&quot;\A(?:[a-z0-9!#$%&amp;&#39;*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&amp;&#39;*+/=?^_`{|}~-]+)&quot;</span> <span class="o">+</span>
</span><span class="line">        <span class="s">&quot;*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?</span><span class="err">\</span><span class="s">.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?)</span><span class="err">\</span><span class="s">Z&quot;</span>
</span><span class="line">    <span class="nn">Regex</span><span class="p">.</span><span class="n">IsMatch</span><span class="o">(</span><span class="n">emailAddr</span><span class="o">,</span> <span class="n">emailAddrRegex</span><span class="o">,</span> <span class="nn">RegexOptions</span><span class="p">.</span><span class="n">IgnoreCase</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateEmailEmptiness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isNonEmptyString</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Email&quot;</span>
</span><span class="line">      <span class="s">&quot;Email is required&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateEmailUniqueness</span> <span class="n">isUniqueEmailAddr</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isUniqueEmailAddr</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Email&quot;</span>
</span><span class="line">      <span class="s">&quot;Email address already exists&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateEmailCorrectness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isValidEmailAddress</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Email&quot;</span>
</span><span class="line">      <span class="s">&quot;Email address is invalid&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="putting-all-the-validations-together">Putting all the validations together</h3>

<p>So far we have seen individual property validation rules. It’s time to put all these pieces together and validate the <code>CreateUserRequest</code> as a whole.</p>

<p>Create a source file <code>UserValidation</code> and update it as below</p>

<p><img src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_7/uservalidation_match.png" /></p>

<p>Wait.. Wait.. I know how do you feel here.. It’s too much code! Can we do it in a better way? </p>

<h3 id="using-railway-oriented-programming-rop">Using Railway Oriented Programming (ROP)</h3>

<p>Thanks to ROP, we can make the mighty code smaller and more readable. I am going ahead with an assumption that you are aware of ROP. In case if you are not aware of it then watch this <a href="http://vimeo.com/97344498">excellent presentation</a> by <a href="https://twitter.com/ScottWlaschin">Scott Wlaschin</a></p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_7/bind_function.png" width="350" height="500" /></p>

<p>The crux of ROP is the bind function which composes two functions where the output type of one function is not matching with that of the input. If you want to know more this bind function, do visit this <a href="http://adit.io./posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html">awesome blog post</a> by <a href="https://twitter.com/_egonschiele">Aditya</a>. In this blog post he explains about the bind function under the title <strong>Monads</strong></p>

<p>Let’s start by adding this bind function in the module <code>Rop</code> that we have already created.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">bind</span> <span class="n">f1</span> <span class="n">f2</span> <span class="n">x</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">f1</span> <span class="n">str</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Success</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f2</span> <span class="n">x</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Failure</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">Failure</span> <span class="n">err</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">inline</span> <span class="o">(&gt;&gt;=)</span> <span class="n">f1</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">bind</span> <span class="n">f1</span> <span class="n">f2</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The bind function here calls the function <code>f1</code> with the given input <code>x</code> if it succeeds, then executes the second function <code>f2</code> with <code>x</code>. In case if the execution of <code>f1</code> resulted in failure then it just passes without executing the second function. </p>

<p>The infix operator <code>&gt;&gt;=</code> is an alias of bind function. </p>

<p>With the help of this bind function, we can rewrite the <code>validateCreateUserRequest</code> function in a better way as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">UserValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validateCreateUserRequest</span> <span class="n">userManager</span>  <span class="o">=</span>
</span><span class="line">      <span class="n">validateEmailEmptiness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateEmailCorrectness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateEmailUniqueness</span> <span class="o">(</span><span class="n">isUniqueEmailAddr</span> <span class="n">userManager</span><span class="o">)</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateNameEmptiness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateNameLength</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validatePasswordEmptiness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validatePasswordLength</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validatePasswordStrength</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It’s awesome! Isn’t it? If you are still wondering what’s happening here! Watch the Scott’s presentation one more time.</p>

<h3 id="adding-validation-before-saving">Adding validation before saving</h3>

<p>Now we have the validation infrastructure in place. So, let’s go ahead and add it before creating a new user in the backend. As part of this refactoring we are also going to do error handling of new user creation. </p>

<p>Create a new private function in <code>UserStorage</code> to create a new user with error handling</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">createUser&#39;</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">  <span class="k">try</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">,</span>
</span><span class="line">                        <span class="n">UserName</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">,</span>
</span><span class="line">                        <span class="n">Email</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">identityResult</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Create</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">identityResult</span><span class="o">.</span><span class="n">Succeeded</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">errors</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s">&quot;,&quot;</span> <span class="n">identityResult</span><span class="o">.</span><span class="n">Errors</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="n">errors</span><span class="o">}</span>
</span><span class="line">  <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;An unexpected error happened while creating new user&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Like validation rules defined before this new <code>createUser'</code> function is also outputs “two tracks”, Success if the user creation is successful others it outputs Failure. Because of this change in function signature <br />
(<code>UserManager&lt;User&gt; -&gt; CreateUserRequest -&gt; Result&lt;CreateUserRequest&gt;</code>) we can fit this easily into the bind function.</p>

<p>Modify the existing <code>CreateUser</code> function to use this</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">createUser</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">      <span class="n">validateCreateUserRequest</span> <span class="n">userManager</span> <span class="o">&gt;&gt;=</span> <span class="n">createUser&#39;</span> <span class="n">userManager</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Thanks to <a href="http://fsharpforfunandprofit.com/posts/partial-application/">Partial application</a> we have created new functions on the fly by passing only the partial parameters (<code>UserManager</code> in this case) and make it fit with less code. </p>

<p>Since we have changed the signature of the <code>createUser</code> function from <code>UserManager&lt;User&gt; -&gt; CreateUserRequest -&gt; IdentityResult</code> to <code>UserManager&lt;User&gt; -&gt; CreateUserRequest -&gt; Result&lt;CreateUserRequest&gt;</code> we need to change the <code>Register</code> action method in the <code>AuthenticationController</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">createUserRequest</span> <span class="o">:</span> <span class="n">CreateUserRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span>
</span><span class="line">    <span class="n">Email</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span><span class="o">;</span>
</span><span class="line">    <span class="n">Password</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Password</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">match</span> <span class="nn">UserStorage</span><span class="p">.</span><span class="n">createUser</span> <span class="n">userManager</span> <span class="n">createUserRequest</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Failure</span> <span class="n">error</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">Property</span><span class="o">,</span> <span class="n">error</span><span class="o">.</span><span class="n">Message</span><span class="o">)</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">registerViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Success</span> <span class="n">createUserRequest&#39;</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Find</span><span class="o">(</span><span class="n">createUserRequest&#39;</span><span class="o">.</span><span class="n">Email</span><span class="o">,</span> <span class="n">createUserRequest&#39;</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s it, we are ready to go!</p>

<h3 id="summary">Summary</h3>

<p>In this blog post we have seen how to add validations and error handling in fsharp using ROP. Though it is little hard to get this kind of functional thinking, it offers a great deal of expressiveness and flexibility to your codebase. Just like any other skills if you practice it for quite time you can also master it. You can find the source code associated with this step in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/7">github repository</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-6 Authentication using Owin authentication Middleware and ASP.NET Identity]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/02/04/step-6-authentication-using-owin-middleware-and-asp-dot-net-identity/"/>
    <updated>2015-02-04T17:24:22+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/02/04/step-6-authentication-using-owin-middleware-and-asp-dot-net-identity</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 6 of my blog series on <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="http://blog.tamizhvendan.in/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec/">last blog post</a> we have added an interactive feature to search phones and in this blog post we are going to add authentication to our PhoneCat application using Owin Authentication Middleware and ASP.NET identity.</p>

<p>In the first half of this blog post we are going to see how to implement a new user registration workflow </p>

<p><img src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_6/registration_workflow.png" /></p>

<p>And in the second half, we are going to see how to do authentication using the registered login credentials</p>

<p><img src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_6/login_workflow.png" /></p>

<h3 id="owin-authentication-middleware-in-brief">Owin Authentication Middleware in brief</h3>

<p>In the <a href="https://msdn.microsoft.com/en-us/magazine/dn451439.aspx">Owin Specification</a>, a middleware access the request before it reaches the underlying web framework. You can view the authentication middleware as gate keeper who checks the incoming request, if it is authenticated it let the request to go through the other middlewares in the pipeline else it bypasses the pipeline and take a different route (usually redirecting to the login page)</p>

<p>In the blog post we are going to use cookie based authentication middleware which is similar to the <a href="https://msdn.microsoft.com/en-us/library/7t6b43z4%28v=vs.140%29.aspx">Asp.Net Forms Authentication</a> and it also supports <a href="https://msdn.microsoft.com/en-us/library/system.security.claims.claim(v=vs.110).aspx">Claims</a>.</p>

<p>Another appreciable feature in Owin it is upto us on how to validate the incoming user credentials. We can plug it to any external authentication providers like Google, Facebook, etc., or using Active Directory or Asp.Net Identity. Here we are going to validate the user credentials using <a href="http://odetocode.com/blogs/scott/archive/2013/11/25/asp-net-core-identity.aspx">Asp.Net Identity framework</a> which provides the required interfaces for handling the authentication and <a href="http://odetocode.com/blogs/scott/archive/2014/01/03/asp-net-identity-with-the-entity-framework.aspx">Entity Framework Identity</a> which provides the concrete implementations for this Identity interfaces.</p>

<h3 id="setting-up-the-infrastructure">Setting up the infrastructure</h3>

<p>Create a new F# class library project with the name <code>Identity</code> and install the Microsoft <a href="https://www.nuget.org/packages/Microsoft.AspNet.Identity.EntityFramework/">AspNet.Identity.EntityFramework</a> nuget package which provides a pluggable data store for the user identity management using Entity Framework.</p>

<p>Then add a source file in the <code>Identity</code> project with the name <code>User</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">open</span> <span class="nn">Microsoft.AspNet.Identity.EntityFramework</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AllowNullLiteral</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">User</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">IdentityUser</span><span class="bp">()</span>
</span><span class="line">  <span class="k">member</span> <span class="k">val</span> <span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="k">with</span> <span class="n">get</span><span class="o">,</span> <span class="n">set</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">UserDbContext</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">IdentityDbContext</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="s">&quot;IdentityConnection&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>IdentityUser</code> represents the default implementation of <a href="https://msdn.microsoft.com/en-us/library/microsoft.aspnet.identity.iuser%28v=vs.108%29.aspx">IUser</a> interface which provides the basic properties for a user. We can extend it by adding our custom properties. Here we have added a custom property called <code>Name</code> which represents the name of the user.</p>

<p>The <a href="https://msdn.microsoft.com/en-us/library/ee353608.aspx">AllowNullLiteral</a> attribute is one of the feature in F# which explicitly make a type to allow null as one of its value. F# by default doesn’t support null value for its types and the beauty is you will get a compiler error if you assign null to an identifier! Pretty cool isn’t it? No Null Exception, <a href="http://www.infoq.com/presentations/Null-References-The-Billion-Dollar-Mistake-Tony-Hoare">No Billion Dollar Mistake</a>! Then why we are allowing it explicitly here. Well, it has been added here for a reason and I will reveal it later in this blog post</p>

<p>The <code>IdentityDbContext</code> represents the data store abstraction of Identity entities like Users, Roles, Claims and Logins. The <code>UserDbContext</code> is just a subclass of <code>IdentityDbContext</code> which tells Entity Framework to use the connection string name <code>IdentityConnection</code></p>

<h3 id="setting-up-user-registration">Setting up User Registration</h3>

<p>With all the needed infrastructure in place its time to do the actual work and lets start with adding a provision for registering new user.</p>

<p>In the <code>Web</code> project add the reference to the <code>Identity</code> project and install the following nuget packages</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Microsoft.Owin.Security.Cookies
</span><span class="line">Microsoft.Owin.Host.SystemWeb
</span><span class="line">Microsoft.AspNet.Identity.EntityFramework
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Create a controller with the name <code>AuthenticationController</code> in the <code>Web</code> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">CLIMutable</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">RegisterViewModel</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Email</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Password</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">AuthenticationController</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="bp">()</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>AuthenticationController</code> depends on <code>UserManager</code> to take care of managing users. <a href="https://msdn.microsoft.com/en-us/library/dn613290%28v=vs.108%29.aspx">UserManager</a> is an abstraction defined in the <strong>AspNet.Identity</strong> assembly. It provides various APIs to work with the underlying user datastore. </p>

<p>As the name indicates <code>RegisterViewModel</code> represents the view model for Registration View. The <a href="https://msdn.microsoft.com/en-us/library/hh289724.aspx">CLIMutable</a> attribute creates a default constructor and “getters and setters” for all the properties of a record type when it is compiled to IL and here it makes the <code>RegisterViewModel</code> compatible with the Asp.Net <a href="https://msdn.microsoft.com/en-us/library/system.web.mvc.defaultmodelbinder(v=vs.118).aspx">DefaultModelBinder</a> which expects the types to have default constructor to bind the incoming request.</p>

<p>The action method <code>Register</code> simply renders the Register View. This view not created yet so lets add it. Create a cshtml file with the name <em>Register.cshtml</em> in the directory <strong>Views/Authentication</strong>. </p>

<p>This is a strongly typed view of type <code>RegisterViewModel</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="html"><span class="line">@model PhoneCat.Web.Controllers.RegisterViewModel
</span><span class="line">
</span><span class="line"><span class="nt">&lt;h3&gt;</span>Register New User<span class="nt">&lt;/h3&gt;</span>
</span><span class="line">
</span><span class="line">@using (Html.BeginForm(&quot;Register&quot;, &quot;Authentication&quot;, FormMethod.Post))
</span><span class="line">{
</span><span class="line">  @Html.AntiForgeryToken()
</span><span class="line">  @Html.ValidationSummary()
</span><span class="line">
</span><span class="line">  @Html.TextBoxFor(m =&gt; m.Name)
</span><span class="line">
</span><span class="line">  @Html.TextBoxFor(m =&gt; m.Email)
</span><span class="line">
</span><span class="line">  @Html.PasswordFor(m =&gt; m.Password)
</span><span class="line">
</span><span class="line">  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span><span class="nt">&gt;</span>Create<span class="nt">&lt;/button&gt;</span>
</span><span class="line">}
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p><em>Note: I’ve intentionally ignored the bootstrap css form styles here to keep the code snippet less noisy</em></p>

<p><img src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_6/new_user_registration.png" /></p>

<p>It’s a typical razor view representing the registration screen. For the sake of simplicity I’ve ignored the retype password field. </p>

<p>The next step is handling the new user registration POST request.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Name</span><span class="o">,</span>
</span><span class="line">                      <span class="n">UserName</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span> <span class="o">,</span>
</span><span class="line">                      <span class="n">Email</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userCreateResult</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Create</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">userCreateResult</span><span class="o">.</span><span class="n">Succeeded</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="n">userCreateResult</span><span class="o">.</span><span class="n">Errors</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">iter</span><span class="o">(</span><span class="k">fun</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">err</span><span class="o">))</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">registerViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Add the above action method in the <code>AuthenticationController</code> to create new user. It creates a <code>User</code> object from the <code>RegisterViewModel</code> and use it to create a new user via <code>UserManager</code>. We are using <code>Email</code> as the <code>UserName</code> in the above code snippet</p>

<p>If the user creation is successful, we are redirecting the user to the home page else we are showing the error messages to the user. After we implemented the login we will modify the above logic to sign in after successful registration.</p>

<p>The next task is creation of <code>AuthenticationController</code> instance. Open <code>MvcInfrastructure</code> that we have <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/2/Web/MvcInfrastructure.fs">created in the step-2</a> and update it as below.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">createUserManager</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">UserStore</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">UserDbContext</span><span class="bp">()</span><span class="o">))</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userValidator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserValidator</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userManager</span><span class="o">)</span>
</span><span class="line">  <span class="n">userValidator</span><span class="o">.</span><span class="n">AllowOnlyAlphanumericUserNames</span> <span class="o">&lt;-</span> <span class="k">false</span>
</span><span class="line">  <span class="n">userManager</span><span class="o">.</span><span class="n">UserValidator</span> <span class="o">&lt;-</span> <span class="n">userValidator</span>
</span><span class="line">  <span class="n">userManager</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">    <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="c1">// ... Existing code ...</span>
</span><span class="line">      <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">AuthenticationController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">authenticationController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthenticationController</span><span class="o">(</span><span class="n">createUserManager</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">        <span class="n">authenticationController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">      <span class="c1">// ... Existing code ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>As we are using email as username we need to change the user validator in the <code>UserManager</code> to allow the alphanumeric characters in the username.</p>

<p>The final step is providing the connection string to access the identity database. Open the <strong>Web.config</strong> file and add the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;connectionStrings&gt;</span>
</span><span class="line">    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;IdentityConnection&quot;</span>
</span><span class="line">      <span class="na">connectionString=</span><span class="s">&quot;Data Source=localhost;Initial Catalog=PhoneCatIdentity;Integrated Security=True&quot;</span>
</span><span class="line">      <span class="na">providerName=</span><span class="s">&quot;System.Data.SqlClient&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/connectionStrings&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As we are using Entity Framework’s Code First here, the schema will be generated dynamically when we run the code for the very first time.</p>

<p>That’s it. We have wired up everything to create a new user!</p>

<h3 id="setting-up-user-login">Setting up User Login</h3>

<p>As we are going to use owin <a href="http://blogs.msdn.com/b/webdev/archive/2013/07/03/understanding-owin-forms-authentication-in-mvc-5.aspx">cookies based authentication</a> middleware, the first step to tell the application startup pipeline to use cookie authentication. </p>

<p>Open <code>Startup</code> and update it to support authentication</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Startup</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">configureAuthentication</span> <span class="o">(</span><span class="n">app</span> <span class="o">:</span> <span class="n">IAppBuilder</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">cookieAuthenticationOptions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CookieAuthenticationOptions</span><span class="bp">()</span>
</span><span class="line">    <span class="n">cookieAuthenticationOptions</span><span class="o">.</span><span class="n">AuthenticationType</span> <span class="o">&lt;-</span> <span class="nn">DefaultAuthenticationTypes</span><span class="p">.</span><span class="n">ApplicationCookie</span>
</span><span class="line">    <span class="n">cookieAuthenticationOptions</span><span class="o">.</span><span class="n">LoginPath</span> <span class="o">&lt;-</span> <span class="k">new</span> <span class="n">PathString</span><span class="o">(</span><span class="s">&quot;/authentication/login&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">UseCookieAuthentication</span><span class="o">(</span><span class="n">cookieAuthenticationOptions</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">  <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Configuration</span><span class="o">(</span><span class="n">app</span> <span class="o">:</span> <span class="n">IAppBuilder</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">MapSignalR</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="n">configureAuthentication</span> <span class="n">app</span>
</span><span class="line">    <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>AuthenticationType</code> is an identifier to distinguish between different authentication middlewares and the <code>LoginPath</code> is the url to the Login Page which will be used to redirect the unauthorized requests.</p>

<p>After setting up cookie authentication, like we did for new user registration, we are going to create a view to enable the user to login.</p>

<p>Add the <code>Login</code> action method in the <code>AuthenticationController</code> and also create <code>LoginViewModel</code> </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">CLIMutable</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">LoginViewModel</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Email</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Password</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">AuthenticationController</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">  <span class="c1">// ... Existing code ...  </span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Login</span><span class="bp">()</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>and create <code>Login</code> view in the <strong>Authentication\Login</strong> directory</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="html"><span class="line">@model PhoneCat.Web.Controllers.LoginViewModel
</span><span class="line">
</span><span class="line"><span class="nt">&lt;h3&gt;</span>Login<span class="nt">&lt;/h3&gt;</span>
</span><span class="line">@using (Html.BeginForm(&quot;Login&quot;, &quot;Authentication&quot;, FormMethod.Post))
</span><span class="line">{
</span><span class="line">  @Html.AntiForgeryToken()
</span><span class="line">  @Html.ValidationSummary()
</span><span class="line">
</span><span class="line">  @Html.TextBoxFor(m =&gt; m.Email)
</span><span class="line">
</span><span class="line">  @Html.PasswordFor(m =&gt; m.Password)
</span><span class="line">
</span><span class="line">  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>Log in<span class="nt">&lt;/button&gt;</span>
</span><span class="line">}
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p><img src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_6/login.png" /></p>

<p>The next step is the crux of this blog post. Challenging the incoming user login credentials against its corresponding registered one.</p>

<p>We will be using <code>UserManager</code>’s following methods to achieve it.</p>

<ul>
  <li>
    <p><a href="https://msdn.microsoft.com/en-us/library/dn497475(v=vs.108).aspx">Find</a> - Returns a user with the specified username and password or null if there is no match (C# needs <a href="http://fsharpforfunandprofit.com/posts/the-option-type/">Option</a> type badly!). In the beginning of the blog post I’ve mentioned you that I will talk about why we are using <code>AllowNullLiteral</code> attribute for the <code>User</code> class. As you see here <code>Find</code> method returns <code>null</code> if the user is not available! So, As per this definition <code>null</code> is valid value for <code>User</code> class.</p>
  </li>
  <li>
    <p><a href="https://msdn.microsoft.com/en-us/library/dn497467(v=vs.108).aspx">CreateIdentity</a> - Creates the Claim Identity representing the user. We need this claim identity to signin and also to pass around the claim details. </p>
  </li>
</ul>

<p>Both of the above methods are having their async counterparts. But for the sake of simplicity I’m ignoring it. May be it can be a exercise for you to figure it out!</p>

<p>Let’s add some utility function to handle finding the user and signing in</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">signin</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">(</span><span class="n">request</span> <span class="o">:</span> <span class="n">HttpRequestBase</span><span class="o">)</span> <span class="n">user</span>  <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">identity</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">CreateIdentity</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="nn">DefaultAuthenticationTypes</span><span class="p">.</span><span class="n">ApplicationCookie</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">authManager</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GetOwinContext</span><span class="bp">()</span><span class="o">.</span><span class="n">Authentication</span>
</span><span class="line">  <span class="n">identity</span><span class="o">.</span><span class="n">AddClaim</span><span class="o">(</span><span class="k">new</span> <span class="n">Claim</span><span class="o">(</span><span class="nn">ClaimTypes</span><span class="p">.</span><span class="n">GivenName</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="n">Name</span><span class="o">))</span>
</span><span class="line">  <span class="n">authManager</span><span class="o">.</span><span class="n">SignIn</span><span class="o">(</span><span class="n">identity</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">tryFindUser</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">email</span> <span class="n">password</span>  <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Find</span><span class="o">(</span><span class="n">email</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span>
</span><span class="line">  <span class="k">if</span> <span class="n">user</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="k">then</span> <span class="n">Some</span> <span class="n">user</span> <span class="k">else</span> <span class="n">None</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Since we are using Email as the UserName here in this example, we need to have a specific claim to pass around the Name of the user. That’s what we are doing in the <code>signin</code> method. Later we will be using this claim to display the user name in the header of the page.</p>

<p>Great! Now its time to handle handle Login POST request. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Login</span><span class="o">(</span><span class="n">loginViewModel</span> <span class="o">:</span> <span class="n">LoginViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">tryFindUser</span> <span class="n">userManager</span> <span class="n">loginViewModel</span><span class="o">.</span><span class="n">Email</span> <span class="n">loginViewModel</span><span class="o">.</span><span class="n">Password</span>  <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="s">&quot;Invalid Email or Password&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">loginViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">user</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Login</code> action method just tries to find the user using given credentials. If the user is available, signin to the application using his credentials and redirect to the home page else show login error to the user.</p>

<p>We can add this same signin behavior after successful user registration too.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// ... Existing Code ...</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">userCreateResult</span><span class="o">.</span><span class="n">Succeeded</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="c1">// ... Existing Code ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Since <code>UserManager</code> is an <code>IDisposable</code>. It’s good practices to dispose it after using. So, Override <code>Dispose</code> method in <code>AuthenticationController</code> and dispose it. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">Dispose</span><span class="o">(</span><span class="n">disposing</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">if</span> <span class="n">disposing</span> <span class="k">then</span>
</span><span class="line">    <span class="n">userManager</span><span class="o">.</span><span class="n">Dispose</span><span class="bp">()</span>
</span><span class="line">  <span class="k">base</span><span class="o">.</span><span class="n">Dispose</span><span class="o">(</span><span class="n">disposing</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The final pending work is displaying the user name in the header after successful login. Open <strong>Layout.cshtml</strong> add the following lines</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="c">&lt;!-- ... Existing code ... --&gt;</span>
</span><span class="line"><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav navbar-nav navbar-right top-nav&quot;</span><span class="nt">&gt;</span>
</span><span class="line">
</span><span class="line">  @if (Request.IsAuthenticated)
</span><span class="line">  {
</span><span class="line">    var identity = User.Identity as ClaimsIdentity;
</span><span class="line">    var name = identity.FindFirst(ClaimTypes.GivenName).Value;
</span><span class="line">    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
</span><span class="line">      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span> <span class="na">aria-expanded=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-user&quot;</span><span class="nt">&gt;&lt;/i&gt;</span>@name
</span><span class="line">      <span class="nt">&lt;/a&gt;</span>
</span><span class="line">      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;li&gt;</span>
</span><span class="line">          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;@Url.Action(&quot;</span><span class="na">Logout</span><span class="err">&quot;,&quot;</span><span class="na">Authentication</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class="line">            <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-fw fa-power-off&quot;</span><span class="nt">&gt;&lt;/i&gt;</span> Log Out
</span><span class="line">          <span class="nt">&lt;/a&gt;</span>
</span><span class="line">        <span class="nt">&lt;/li&gt;</span>
</span><span class="line">      <span class="nt">&lt;/ul&gt;</span>
</span><span class="line">    <span class="nt">&lt;/li&gt;</span>
</span><span class="line">  }
</span><span class="line">  else
</span><span class="line">  {
</span><span class="line">    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
</span><span class="line">      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span> <span class="na">aria-expanded=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-user&quot;</span><span class="nt">&gt;&lt;/i&gt;</span> Guest
</span><span class="line">      <span class="nt">&lt;/a&gt;</span>
</span><span class="line">      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;li&gt;</span>
</span><span class="line">          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;@Url.Action(&quot;</span><span class="na">Login</span><span class="err">&quot;,&quot;</span><span class="na">Authentication</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class="line">            <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-fw fa-bank&quot;</span><span class="nt">&gt;&lt;/i&gt;</span> Log In
</span><span class="line">          <span class="nt">&lt;/a&gt;</span>
</span><span class="line">        <span class="nt">&lt;/li&gt;</span>
</span><span class="line">        <span class="nt">&lt;li&gt;</span>
</span><span class="line">          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;@Url.Action(&quot;</span><span class="na">Register</span><span class="err">&quot;,&quot;</span><span class="na">Authentication</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class="line">            <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;fa fa-fw fa-laptop&quot;</span><span class="nt">&gt;&lt;/i&gt;</span>Register
</span><span class="line">          <span class="nt">&lt;/a&gt;</span>
</span><span class="line">        <span class="nt">&lt;/li&gt;</span>
</span><span class="line">      <span class="nt">&lt;/ul&gt;</span>
</span><span class="line">    <span class="nt">&lt;/li&gt;</span>
</span><span class="line">  }
</span><span class="line"><span class="nt">&lt;/ul&gt;</span>
</span><span class="line"><span class="c">&lt;!-- ... Existing code ... --&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="adding-logout">Adding Logout</h3>

<p>Adding logout is very simple and straight forward. All we need to do is just invoke the Owin Authentication Manager’s <code>SignOut</code> method. Create an action method in <code>AuthenticationController</code> to handle it</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Logout</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">authManager</span> <span class="o">=</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">GetOwinContext</span><span class="bp">()</span><span class="o">.</span><span class="n">Authentication</span>
</span><span class="line">  <span class="n">authManager</span><span class="o">.</span><span class="n">SignOut</span><span class="o">(</span><span class="nn">DefaultAuthenticationTypes</span><span class="p">.</span><span class="n">ApplicationCookie</span><span class="o">)</span>
</span><span class="line">  <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="summary">Summary</h3>

<p>The interoperability offered by F# to integrate with the existing C# libraries is very seamless and I hope you have got it too! You can find the source code in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/6">github</a> as usual. In the next blog post We will see how to add validations in the User Registration. Stay tuned!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-5 Advanced Search DSL using FParsec]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec/"/>
    <updated>2015-01-18T19:52:26+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/01/18/step-5-advanced-search-dsl-using-fparsec</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 5 of my blog series on <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In this blog post we are going create an advanced Search <a href="http://en.wikipedia.org/wiki/Domain-specific_language">DSL</a> for searching Phones in the PhoneCat application that we are building in this blog series, using a F# parser combinator library called <a href="http://www.quanttec.com/fparsec/">FParsec</a>. </p>

<p><img src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_5/search_results.png" /></p>

<p>As you seen in the screenshot above the DSL that we are going to build will enable us to search phones using three search filters (parameters) <strong>weight</strong>, <strong>screen</strong> and <strong>ram</strong>. The values (value filters) of these search filters can be defined in three ways as <strong>&gt;</strong>(greater than), <strong>-</strong>(range) and <strong>{value}</strong>(actual value itself i.e <em>=</em>). Each of these values should be accompanied with their unit of measures <strong>g</strong>, <strong>inch</strong> and <strong>MB</strong> respectively. For simplicity, I’ve expressed these units in singulars. The <strong>:</strong> symbol is used to separate Search Filter and Value Filter. Multiple filters can be used by seperating thing using the <strong>;</strong> symbol. </p>

<p>The <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract syntax tree (AST)</a> of this external DSL is</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">SearchFilter</span> <span class="o">=</span>
</span><span class="line"><span class="o">|</span> <span class="n">Ram</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line"><span class="o">|</span> <span class="n">Weight</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line"><span class="o">|</span> <span class="n">Screen</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">ValueFilter</span> <span class="o">=</span>
</span><span class="line"><span class="o">|</span> <span class="n">Value</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line"><span class="o">|</span> <span class="n">GreaterThan</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line"><span class="o">|</span> <span class="n">Range</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">*</span> <span class="kt">float</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">filters</span> <span class="o">:</span> <span class="o">(</span><span class="n">SearchFilter</span> <span class="o">*</span> <span class="n">ValueFilter</span><span class="o">)</span> <span class="kt">list</span> <span class="o">=</span> <span class="c1">// ... </span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>FParsec does both <a href="http://en.wikipedia.org/wiki/Lexical_analysis">lexical analysis</a> (converting raw character sequence into meaningful tokens) and <a href="http://en.wikipedia.org/wiki/Parsing">parsing</a> (converting tokens to an AST like the one above). FParsec has been built using pure functions from the ground up and it enable us to create complex parser by combining small parsers (aka <a href="http://programmers.stackexchange.com/questions/117522/what-are-combinators-and-how-are-they-applied-to-programming-projects-practica">combinators</a>). </p>

<h3 id="fpasec-101">FPasec 101</h3>

<p>Lets quickly walk through the basics of FParsec.</p>

<p>In Fparsec all the parsers are of type <code>Parser&lt;'Result,'UserState&gt;</code> . The <code>'Result</code> represents the type of the parser result and the <code>'UserState</code> represents the internal state of the parser. </p>

<p>FParsec offers lot of in-built parser functions which takes F# primitive types and return a parser type for it. </p>

<h4 id="pchar">pchar</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">psearchValueSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;:&#39;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pmultiFiltersSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;;&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>pchar</code> function takes a character and returns a parser (i.e of type <code>Parser&lt;char, 'UserState&gt;</code>) which parses only the given character. </p>

<p>FParsec uses a convention of prefix <strong>p</strong> to define all its parser function and we are also going to use the same to define our custom parser functions.</p>

<h3 id="pstring">pstring</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pram</span> <span class="o">=</span> <span class="n">pstring</span> <span class="s">&quot;ram&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pweight</span> <span class="o">=</span> <span class="n">pstring</span> <span class="s">&quot;weight&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pscreen</span> <span class="o">=</span> <span class="n">pstring</span> <span class="s">&quot;ram&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Like <code>pchar</code> function, the <code>pstring</code> takes a string as its input and return a parser (<code>Parser&lt;string, 'UserState&gt;</code>) that parses only the given string. This parser is case-sensitive. If you want to have a parser which is case-insensitive you can use <code>pstringCI</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pmb</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;MB&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pg</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;g&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pinch</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;inch&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="pfloat">pfloat</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pvalue</span> <span class="o">=</span> <span class="n">pfloat</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I hope by this time you would have been familiar with the FParsec functions. Yes, you are right <code>pfloat</code> parses a floating point and returns the parser for the same. But unlike <code>pchar</code> and <code>pstrig</code> it doesn’t take any input and it can parse any floating point numbers and return the same when we execute the parser. </p>

<h3 id="section">|»</h3>

<p>So far we have seen parsers for the F# primitive types. What about our custom types ? FParsec has an answer for that too using the function (aka operator) <code>|&gt;&gt;</code>. </p>

<p>The signature of <code>|&gt;&gt;</code> function is</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; (a&#39; -&gt; &#39;b) -&gt; Parser&lt;&#39;b, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>i.e this function takes two inputs, a parser of type <code>'a</code> and a function that transform the type <code>'a</code> to <code>'b</code> and return a parser of type <code>'b</code></p>

<p>If you remember the AST that we have defined in the beginning of the post, the search filter has been defined as a discriminated union of type <code>SearchFilter</code>. Each fields <code>Ram</code>, <code>Screen</code>, <code>Weight</code> are being represented in the DSL by their string counterparts <em>“ram”</em>, <em>“screen”</em>, <em>“weight”</em> respectively. We can leverage this <code>|&gt;&gt;</code> function to take care of this data type transformation</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">toLowerCase</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">ToLowerInvariant</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">toSearchFilter</span> <span class="n">str</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">toLowerCase</span> <span class="n">str</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="s">&quot;ram&quot;</span> <span class="o">-&gt;</span> <span class="n">Ram</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="n">Weight</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="s">&quot;screen&quot;</span> <span class="o">-&gt;</span> <span class="n">Screen</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s">&quot;Invalid search filter&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">psearchFilter</span> <span class="n">str</span> <span class="o">=</span> <span class="n">pstring</span> <span class="n">str</span> <span class="o">|&gt;&gt;</span> <span class="n">toSearchFilter</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">pram</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;ram&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pweight</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;weight&quot;</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pscreen</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;screen&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>If you see the type of <code>pram</code> it is Parser&lt;SearchFilter, ‘u&gt; i.e Parser for our custom type. The <code>psearchFilter</code> is an utility function which helps in avoiding the code duplication across multiple search filter parser creation.</p>

<h3 id="section-1">».</h3>

<p>I love this function and it represents the beauty of functional programming. This function has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It takes two parsers of same or different types and returns a parser that parses the input using the given two parsers by applying them sequentially and returns a parser with the input type of second parser (The <strong>.</strong> symbol represents which parser to pick)</p>

<p>Lets see this action to understand it more</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">let pgreaterThan = pchar &#39;&gt;&#39; &gt;&gt;. pfloat |&gt;&gt; GreaterThan
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have created parser here for greater than. It parses the string <strong>“&gt;80.2”</strong> (i.e <code>pchar</code> parses the <strong>&gt;</strong> symbol and <code>pfloat</code> parses the number <strong>80.2</strong>. Since we have created it using <code>&gt;&gt;.</code> function, both <code>pchar</code> and <code>pfloat</code> are applied in sequence and it returns a parser of float type) and retrieve the floating number <strong>80.2</strong> when the parser is executed. Then we have applied the <code>|&gt;&gt;</code> function which translate it our custom type <code>GreaterThan</code> that we defined in the AST.</p>

<p>The <code>&gt;&gt;.</code> is much like functional composition done by the <a href="http://en.wikibooks.org/wiki/F_Sharp_Programming/Higher_Order_Functions#The_Composition_Function_.28.3C.3C_operator.29">» function (aka operator)</a> but instead of acting at the function level it acts at the parser level.</p>

<h3 id="section-2">.»</h3>

<p>It is similar to the <code>&gt;&gt;.</code> function but instead of returning a parser with the input type of second parser it returns a parser with the input type of the first parser.</p>

<p>It has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt; -&gt; Parser&lt;&#39;a, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-3">.».</h3>

<p>It is a combination of <code>.&gt;&gt;</code> and <code>&gt;&gt;.</code> i.e Instead of dropping the output of either of the given parsers, it returns a parser which parses the input and returns a parser with the result type as tuple representing the inputs of both of the given parsers.</p>

<p>It has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a, &#39;u&gt; -&gt; Parser&lt;&#39;c, &#39;u&gt; -&gt; Parser&lt;(&#39;a * &#39;c), &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Lets see both <code>.&gt;&gt;</code> and <code>.&gt;&gt;.</code> in action</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">prange</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">.&gt;&gt;</span> <span class="o">(</span><span class="n">pchar</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Range</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>prange</code> parser parses the string “100-200” and returns <code>Range (100, 200)</code>.</p>

<p>The <code>.&gt;&gt;</code> function here dropped the symbol <strong>-</strong> here (output of <code>pchar</code> parser) and the function <code>.&gt;&gt;.</code> picked the output of these parsers and returned a tuple representing the given range.</p>

<p>Now you got why I said I love this function! These tiny functions allow us to create parsers by combining them. If you understand how these tiny functions work and trust me you can create complex parsers even a <a href="http://trelford.com/blog/post/parsecsharp.aspx">C# compiler</a></p>

<h3 id="attempt">attempt</h3>

<p>This function takes parser <code>p</code> and execute it against the input. If it result in <strong>fatal error</strong>, it <a href="http://en.wikipedia.org/wiki/Backtracking">backtracks</a> the parser state to its original state as if that the given input is not being consumed. </p>

<h3 id="choice">choice</h3>

<p>This function takes multiple parsers say <code>p1</code>, <code>p2</code> … <code>pn</code> and execute it against the input in the following order.</p>

<p>Run the parser <code>p1</code> against the input. If the parsing succeed skip the rest of the parsers and return the parser else if it resulted an <strong>non-fatal error</strong>, backtrack the parser state to its original state and try the same with the next parser <code>p2</code>. This continues all the way down to <code>pn</code>.</p>

<p>What is the difference between <a href="http://www.quanttec.com/fparsec/reference/primitives.html#members.Error">Non-Fatal Error</a> and a <a href="http://www.quanttec.com/fparsec/reference/primitives.html#members.FatalError">Fatal Error</a> ?</p>

<p>Well, its closely associated with the internal implementation of FParsec. FParsec implements backtracking with only a “one token look-ahead”. i.e if the parser consumed one input token from the stream, it modifies the internal state and if it fails after that it would result in Fatal Error. Not-Fatal Error occurs when parer error happened without consuming the input. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">pgreaterThan</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">GreaterThan</span>
</span><span class="line"><span class="k">let</span> <span class="nv">prange</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">.&gt;&gt;</span> <span class="o">(</span><span class="n">pchar</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Range</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pvalue</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Value</span>
</span><span class="line"><span class="k">let</span> <span class="nv">pvalueFilters</span> <span class="o">=</span> <span class="n">choice</span> <span class="o">[</span><span class="n">pgreaterThan</span><span class="o">;</span> <span class="o">(</span><span class="n">attempt</span> <span class="n">prange</span><span class="o">);</span> <span class="n">pvalue</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>If you seen the AST of the DSL that we are going to implement, the value filters can be any one of greaterThan or range or value. Using <code>choice</code> we have implemented this “either or” parser and also we have leveraged the <code>attempt</code> function to get rid of parser fatal error.</p>

<p>Both <code>prange</code> and <code>value</code>, shares the same first token i.e for “100-200MB” &amp; “100MB”, the first token ‘1’ is same. So while parsing the string “100MB” it starts by consuming the first token ‘1’ from the input sequence. FParsec assumes its a range filter and changes its internal state. By the time it reaches the token ‘M’ in “100MB”, it would result in a fatal error saying <em>Expecting: ‘-‘</em>. As we have used <code>attempt</code> here, it backtracks the parser state back to the token ‘1’ of “100MB” and start parsing using <code>pvalue</code> parser. Its hard to get it first time (I’ve spent close to an hour to figure it out) and I recommend you to spend some quality time in understanding the <a href="http://www.quanttec.com/fparsec/users-guide/parsing-alternatives.html">documentation</a> if you want really want to crack it!</p>

<h3 id="sepby">sepBy</h3>

<p><a href="http://www.quanttec.com/fparsec/reference/primitives.html#members.sepBy">sepBy</a> takes an element parser <code>p1</code> and a separator parser as its input and returns a parser for a list of elements separated by the separators.</p>

<p>It has the signature</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">Parser&lt;&#39;a,&#39;u&gt; -&gt; Parser&lt;&#39;b,&#39;u&gt; -&gt; Parser&lt;&#39;a list, &#39;u&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We will be using this function to parse multiple search filters separated by <strong>;</strong></p>

<h3 id="run">run</h3>

<p>The <a href="http://www.quanttec.com/fparsec/reference/charparsers.html#members.run">run function</a> takes a parser and a string as its input and it executes the given parser against the string input and returns a <a href="http://www.quanttec.com/fparsec/reference/charparsers.html#members.ParserResult">ParserResult</a> representing the result.</p>

<h2 id="implementing-the-parser">Implementing the Parser</h2>

<p>We have seen a brief overview of some of the basic building blocks of FParsec. It’s time to pull all these things together and create the complete parser which parses the Search DSL.</p>

<p>Create a source file in the <strong>Domain</strong> project and name it as <code>Search</code>. Then add the AST that we have discussed as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Search</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">SearchFilter</span> <span class="o">=</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Ram</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Weight</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Screen</span> <span class="k">of</span> <span class="o">(</span><span class="kt">float</span> <span class="o">-&gt;</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">ValueFilter</span> <span class="o">=</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Value</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line">  <span class="o">|</span> <span class="n">GreaterThan</span> <span class="k">of</span> <span class="kt">float</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Range</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">*</span> <span class="kt">float</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The next step is to install the <a href="https://www.nuget.org/packages/FParsec">FParsec Nuget Package</a> in the <strong>Domain</strong> project. After installing it create a source file with the name <code>SearchParser</code> and add a function to parse the filter string as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">SearchParser</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">parseFilter</span> <span class="n">filterStr</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">toLowerCase</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">ToLowerInvariant</span><span class="bp">()</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">toSearchFilter</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">      <span class="o">|</span> <span class="s">&quot;ram&quot;</span> <span class="o">-&gt;</span> <span class="n">Ram</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">MB</span><span class="o">&gt;)</span>
</span><span class="line">      <span class="o">|</span> <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="n">Weight</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">g</span><span class="o">&gt;)</span>
</span><span class="line">      <span class="o">|</span> <span class="s">&quot;screen&quot;</span> <span class="o">-&gt;</span> <span class="n">Screen</span> <span class="o">((*)</span> <span class="mi">1</span><span class="o">.&lt;</span><span class="n">inch</span><span class="o">&gt;)</span>
</span><span class="line">      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s">&quot;Invalid search filter&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">psearchFilter</span> <span class="n">str</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="n">str</span> <span class="o">|&gt;&gt;</span> <span class="o">(</span><span class="n">toLowerCase</span> <span class="o">&gt;&gt;</span> <span class="n">toSearchFilter</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">psearchValueSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;:&#39;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pmultiFiltersSeperator</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;;&#39;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pgreaterThan</span> <span class="o">=</span> <span class="n">pchar</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">GreaterThan</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">prange</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">.&gt;&gt;</span> <span class="o">(</span><span class="n">pchar</span> <span class="sc">&#39;-&#39;</span><span class="o">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Range</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pvalue</span> <span class="o">=</span> <span class="n">pfloat</span> <span class="o">|&gt;&gt;</span> <span class="n">Value</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pvalueFilters</span> <span class="o">=</span> <span class="n">choice</span> <span class="o">[</span><span class="n">pgreaterThan</span><span class="o">;</span> <span class="o">(</span><span class="n">attempt</span> <span class="n">prange</span><span class="o">);</span> <span class="n">pvalue</span><span class="o">]</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">createCompleteFilter</span> <span class="n">psearchfilter</span> <span class="n">puom</span>  <span class="o">=</span>
</span><span class="line">      <span class="n">psearchfilter</span> <span class="o">.&gt;&gt;</span> <span class="n">psearchValueSeperator</span> <span class="o">.&gt;&gt;.</span> <span class="n">pvalueFilters</span> <span class="o">.&gt;&gt;</span> <span class="n">puom</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">pmb</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;MB&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pg</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;g&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pinch</span> <span class="o">=</span> <span class="n">pstringCI</span> <span class="s">&quot;inch&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pram</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;ram&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pweight</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;weight&quot;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pscreen</span> <span class="o">=</span> <span class="n">psearchFilter</span> <span class="s">&quot;screen&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">pramFilter</span> <span class="o">=</span> <span class="n">createCompleteFilter</span> <span class="n">pram</span> <span class="n">pmb</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pweightFilter</span> <span class="o">=</span> <span class="n">createCompleteFilter</span> <span class="n">pweight</span> <span class="n">pg</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pscreenFilter</span> <span class="o">=</span> <span class="n">createCompleteFilter</span> <span class="n">pscreen</span> <span class="n">pinch</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">pfilter</span> <span class="o">=</span> <span class="n">choice</span> <span class="o">[</span><span class="n">pramFilter</span><span class="o">;</span><span class="n">pweightFilter</span><span class="o">;</span><span class="n">pscreenFilter</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">parser</span> <span class="o">=</span> <span class="n">sepBy</span> <span class="n">pfilter</span> <span class="n">pmultiFiltersSeperator</span>
</span><span class="line">
</span><span class="line">    <span class="k">match</span> <span class="n">run</span> <span class="n">parser</span> <span class="n">filterStr</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Success</span><span class="o">(</span><span class="n">filters</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="n">Choice1Of2</span><span class="o">(</span><span class="n">filters</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Failure</span><span class="o">(</span><span class="n">err</span><span class="o">,_,_)</span> <span class="o">-&gt;</span> <span class="n">Choice2Of2</span><span class="o">(</span><span class="n">err</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>parseFilter</code> function takes the search filter query from the front end, parses it using the custom parsers that we have built and return the <a href="http://msdn.microsoft.com/en-us/library/ee353439.aspx">Choice type</a>.</p>

<p>The <code>Choice1Of2</code> will contain a list of tuples (SearchFilter * ValueFilter) that represents the strongly typed AST of the given input query.</p>

<p>The <code>Choice2of2</code> will contain the error message in case if there is any parser error happened while parsing the input query.</p>

<h2 id="implementing-phone-search-backend">Implementing Phone Search backend</h2>

<p>With the parser in place, the next step is to building the backend logic of filtering the phones using the filters returned by the parsers</p>

<p>Open the module <code>Search</code> in the <strong>Domain</strong> project and add the following <code>searchPhones</code> function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">searchPhones</span> <span class="n">phones</span> <span class="n">filters</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">hasMetValueFilter</span> <span class="n">toUom</span> <span class="n">valueFilter</span> <span class="n">property</span>  <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">valueFilter</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Value</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">property</span> <span class="o">=</span> <span class="n">toUom</span> <span class="n">x</span>
</span><span class="line">    <span class="o">|</span> <span class="n">GreaterThan</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">property</span> <span class="o">&gt;</span> <span class="n">toUom</span> <span class="n">x</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Range</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">property</span> <span class="o">&gt;=</span> <span class="n">toUom</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">property</span> <span class="o">&lt;=</span> <span class="n">toUom</span> <span class="n">y</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">hasMetSearchFilter</span> <span class="n">filter</span> <span class="n">phone</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">valueFilter</span> <span class="o">=</span> <span class="o">(</span><span class="n">snd</span> <span class="n">filter</span><span class="o">)</span>
</span><span class="line">    <span class="k">match</span> <span class="o">(</span><span class="n">fst</span> <span class="n">filter</span><span class="o">)</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Ram</span> <span class="n">toMB</span> <span class="o">-&gt;</span> <span class="n">hasMetValueFilter</span> <span class="n">toMB</span> <span class="n">valueFilter</span> <span class="n">phone</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">Ram</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Weight</span> <span class="n">toG</span> <span class="o">-&gt;</span> <span class="n">hasMetValueFilter</span> <span class="n">toG</span> <span class="n">valueFilter</span> <span class="n">phone</span><span class="o">.</span><span class="n">Weight</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Screen</span> <span class="n">toInch</span><span class="o">-&gt;</span> <span class="n">hasMetValueFilter</span> <span class="n">toInch</span> <span class="n">valueFilter</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">ScreenSize</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">filterPhones</span> <span class="n">phones&#39;</span> <span class="n">filter</span> <span class="o">=</span>
</span><span class="line">    <span class="n">phones&#39;</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="n">hasMetSearchFilter</span> <span class="n">filter</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">rec</span> <span class="n">searchPhones&#39;</span> <span class="n">phones&#39;</span> <span class="n">filters&#39;</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">filters&#39;</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">phones&#39;</span>
</span><span class="line">    <span class="o">|</span> <span class="n">x</span> <span class="o">::</span> <span class="n">xs</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">searchPhones&#39;</span> <span class="o">(</span><span class="n">filterPhones</span> <span class="n">phones&#39;</span> <span class="n">x</span><span class="o">)</span> <span class="n">xs</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">searchPhones&#39;</span> <span class="n">phones</span> <span class="n">filters</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The function <code>searchPhones</code> recursively applies the filters one by one over the list of phones and filter the phones based on the filter criteria.</p>

<h2 id="exposing-the-phone-search-as-web-api">Exposing the phone search as web-api</h2>

<p>Open the <code>PhonesController</code> that we have added in the <a href="http://blog.tamizhvendan.in/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">step-1</a> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Error</span> <span class="o">=</span> <span class="o">{</span> <span class="n">message</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/phones&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">PhonesController</span>
</span><span class="line">    <span class="o">(</span>
</span><span class="line">        <span class="n">getTopSellingPhones</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">        <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">        <span class="n">catalogPhones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">Catalog</span><span class="p">.</span><span class="n">Phone</span><span class="o">&gt;</span>
</span><span class="line">    <span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">    <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;topselling&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetTopSelling</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">      <span class="n">getTopSellingPhones</span> <span class="mi">3</span> <span class="n">phones</span>
</span><span class="line">
</span><span class="line">    <span class="o">[&lt;</span><span class="n">HttpGet</span><span class="o">&gt;]</span>
</span><span class="line">    <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;search&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">SearchPhones</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">parserResult</span> <span class="o">=</span> <span class="nn">SearchParser</span><span class="p">.</span><span class="n">parseFilter</span> <span class="n">q</span>
</span><span class="line">      <span class="k">match</span> <span class="n">parserResult</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Choice1Of2</span> <span class="n">filters</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">filteredPhones</span> <span class="o">=</span> <span class="nn">Search</span><span class="p">.</span><span class="n">searchPhones</span> <span class="n">catalogPhones</span> <span class="n">filters</span>
</span><span class="line">        <span class="k">base</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">CreateResponse</span><span class="o">(</span><span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="o">,</span> <span class="n">filteredPhones</span><span class="o">)</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Choice2Of2</span> <span class="n">errMsg</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="k">base</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">CreateResponse</span><span class="o">(</span><span class="nn">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="o">,</span> <span class="o">{</span> <span class="n">message</span> <span class="o">=</span> <span class="n">errMsg</span> <span class="o">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The action method <code>SearchPhones</code> gets the input query <code>q</code> from the user and give it to the parser using the <code>parseFilter</code> function. If the parsing is successful, then we will be calling the <code>searchPhones</code> function with the filters returned by the parser. If the parsing failed, we will be returning the error response with the error message from the parser.</p>

<p>We have added a new dependency <code>catalogPhones</code> in the <code>PhonesController</code> constructor which represents all the available phones in the catalog. We need to inject it while creating the controller. Open the <code>Infrastructure</code> module and update the <code>PhonesController</code> creation as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">controllerDescriptor</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phoneIndexes</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhoneIndex</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">catalogPhones</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToCatalogPhone</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">
</span><span class="line">  <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhonesController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getTopSellingPhones</span> <span class="o">(</span><span class="nn">InMemoryInventory</span><span class="p">.</span><span class="n">getPhonesSold</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">phonesController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhonesController</span><span class="o">(</span><span class="n">getTopSellingPhones</span><span class="o">,</span> <span class="n">phones&#39;</span><span class="o">,</span> <span class="n">catalogPhones</span><span class="o">)</span>
</span><span class="line">      <span class="n">phonesController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">  <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="creating-phone-search-view">Creating Phone Search View</h2>

<p>The final step of the creating a view for the Phone Search which enable the user to search the phones using the DSL that we have created so far.</p>

<p>It is straight forward razor view creation as we have seen in <a href="http://blog.tamizhvendan.in/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">step-2</a>. Add an action method <code>Search</code> in the <code>PhoneController</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Search</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="bp">()</span>
</span><span class="line"><span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Create a razor view <strong>Search.cshtml</strong> in the <em>Views/Phone</em> directory and add the code as <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/5/Web/Views/Phone/Show.cshtml">defined here</a>.</p>

<p>The javascript side has been taken care by knockout.js and you can find the script that takes care of calling the api and rendering the filtered phones <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/5/Web/Scripts/search.js">here</a>. </p>

<h2 id="summary">Summary</h2>

<p>Its a little longer post than I expected and I am glad that you have read it this far. I’d like give credit to this <a href="http://blog.fogcreek.com/fparsec/">blog post</a> by <a href="http://haolian.org/">Hao Lian</a> which I’ve used as a reference to come up with this implementation. As usual you can find the source code in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/5">phonecat github repository</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-4 Build automation using FAKE]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/01/06/step-4-build-automation-using-fake/"/>
    <updated>2015-01-06T05:22:32+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/01/06/step-4-build-automation-using-fake</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 4 of my blog series on <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the last three steps, we have seen how to build an web application in fsharp by leveraging <a href="http://blog.tamizhvendan.in/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">Web-Api</a>, <a href="http://blog.tamizhvendan.in/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">Razor</a> and <a href="http://blog.tamizhvendan.in/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/">SignalR</a>. In this step for a change we are going to take the <a href="http://en.wikipedia.org/wiki/DevOps">DevOps</a> side of the application and going to add the build automation capabilities for the application. Let’s get stated!</p>

<h2 id="fake---an-awesome-build-automation-library">Fake - An awesome build automation library</h2>

<p><a href="http://fsharp.github.io/FAKE/">Fake</a> is a F# version of very successful and widely used build automation libraries <a href="http://www.gnu.org/software/make/">Make</a> and <a href="http://en.wikipedia.org/wiki/Rake_%28software%29">Rake</a>. The combination of <a href="http://fsharp.org/testimonials/">fsharp’s expressiveness</a> and the <a href="http://fsharp.github.io/FAKE/gettingstarted.html">Fake’s DSL</a> is a visual treat to the eyes and especially if you are someone who is using <a href="http://en.wikipedia.org/wiki/MSBuild">MsBuild</a> xml files for doing build automation you will definitely appreciate it.</p>

<h3 id="adding-nugetexe-to-nuget-folder">Adding nuget.exe to .nuget folder</h3>

<p>As we are going to drive the nuget packages installation from the fsharp script file, we will be needing a <a href="nuget.org/nuget.exe">command line version of nuget</a>. Download it and place it inside the <strong>.nuget</strong> folder</p>

<p>Also its a good practice to add a <a href="http://docs.nuget.org/docs/reference/nuget-config-settings">Nuget.config file</a>. Add it too under <strong>.nuget</strong> folder. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class="line"><span class="nt">&lt;configuration&gt;</span>
</span><span class="line">  <span class="nt">&lt;packageSources&gt;</span>
</span><span class="line">    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">&quot;nuget.org&quot;</span> <span class="na">value=</span><span class="s">&quot;https://www.nuget.org/api/v2/&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/packageSources&gt;</span>
</span><span class="line"><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="adding-buildbat-file">Adding build.bat file</h3>

<p>Create a batch file <strong>build.bat</strong> in the root directory of the solution. It is going act as bootstrap file which initiates the entire build process.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="bat"><span class="line"><span class="p">@</span><span class="k">echo</span> <span class="k">off</span>
</span><span class="line"><span class="k">cls</span>
</span><span class="line"><span class="s2">&quot;.nuget\NuGet.exe&quot;</span> <span class="s2">&quot;Install&quot;</span> <span class="s2">&quot;FAKE&quot;</span> <span class="s2">&quot;-OutputDirectory&quot;</span> <span class="s2">&quot;tools&quot;</span> <span class="s2">&quot;-ExcludeVersion&quot;</span>
</span><span class="line"><span class="s2">&quot;tools\FAKE\tools\Fake.exe&quot;</span> build.fsx
</span><span class="line"><span class="k">pause</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>It just download the Fake nuget package using the nuget.exe that we added earlier and call the fake.exe with the fsharp build script <strong>build.fsx</strong>.</p>

<h3 id="adding-buildfsx-file">Adding build.fsx file</h3>

<p>Create a <a href="http://blogs.msdn.com/b/chrsmith/archive/2008/09/12/scripting-in-f.aspx">fsharp script file</a> with the name <strong>build.fsx</strong> in the root directory. This script is going to implement all our build automation tasks by using fake library.</p>

<h3 id="cleaning-the-build-directory">Cleaning the build directory</h3>

<p>Just a like any other build process, the first step is to clear the build directory. Fake follows the same convention of MsBuild’s <a href="http://msdn.microsoft.com/en-us/library/ms171462.aspx">Targets</a>. Defining targets in Fake is less verbose compare to its MsBuild’s counterpart. As a matter of fact, it is a fsharp function that take two parameters, the name of the target and a function which defines the target. </p>

<p>Since it is a script file we need to add reference to the <strong>FakeLib.dll</strong> before writing the actual code.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">#</span><span class="n">r</span> <span class="s">&quot;tools/FAKE/tools/FakeLib.dll&quot;</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Fake</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">buildDir</span> <span class="o">=</span> <span class="s">&quot;./build&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">Target</span> <span class="s">&quot;Clean&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">CleanDir</span> <span class="n">buildDir</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Less verbose, Isn’t it ?</p>

<p>The <code>CleanDir</code> is a predefined function in Fake library which clean up this build directory. If the directory doesn’t exist it creates the directory. </p>

<h3 id="build-the-solution">Build the solution</h3>

<p>After cleaning the build directory the next step is to carrying out the actual build process. Before building the application we need to resolve the nuget packages being referred in the application. It’s so simple in Fake. All you need to do is just call predefined function <code>RestorePackages</code>.    </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="n">Target</span> <span class="s">&quot;Build&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="n">RestorePackages</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">!!</span> <span class="s">&quot;./PhoneCat.sln&quot;</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">MSBuildRelease</span> <span class="n">buildDir</span> <span class="s">&quot;Build&quot;</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">Log</span> <span class="s">&quot;Build-Output: &quot;</span>
</span><span class="line">
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>!!</code> is a function which takes a file path and returns <a href="http://fsharp.github.io/FAKE/apidocs/fake-filesystem-fileincludes.html">FileIncludes</a> which is Fake’s internal representation of a file set.</p>

<p>FileIncludes <a href="https://github.com/fsharp/FAKE/blob/master/src/app/FakeLib/Globbing/FileSystem.fs#L95-l117">implements</a> <code>IEnumerable&lt;string&gt;</code> so it can be used wherever we need an <code>IEnumerable&lt;string&gt;</code>. </p>

<p>The <code>MsBuildRelease</code> is also a predefined function in Fake which builds the given solution (which is piped from the <code>!!</code>). The first two parameters are the output build directory path and the target names which should be run by MsBuild. Fake offers lot of functional wrappers on top of MsBuild and you can find more about it in this <a href="http://fsharp.github.io/FAKE/apidocs/fake-msbuildhelper.html">api documentation.</a>. </p>

<p>The last line just pipes the log result from the <code>MsBuildRelease</code> function to the log output.</p>

<h3 id="running-unit-tests-using-nunitrunner">Running unit tests using Nunit.Runner</h3>

<p>Now we have built the solution and the next step is running the unit test cases. Since I’ve written the test cases using Nunit and we are going to see how to run nunit tests using Fake. Fake also supports <a href="http://fsharp.github.io/FAKE/apidocs/fake-xunithelper.html">XUnit</a> and <a href="http://fsharp.github.io/FAKE/apidocs/fake-mstest.html">MsTest</a>. Porting the below code to other unit testing framework is very straight forward.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="n">Target</span> <span class="s">&quot;Test&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">  <span class="o">!!</span> <span class="o">(</span><span class="n">buildDir</span> <span class="o">+</span> <span class="s">&quot;/*.Tests.dll&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">NUnit</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">p</span> <span class="k">with</span> <span class="n">ToolPath</span> <span class="o">=</span> <span class="s">&quot;./tools/NUnit.Runners/tools&quot;</span> <span class="o">})</span>
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>As we did it in the build target, the <code>!!</code> function picks all the unit test files (I’ve used a convention of naming the unit tests projects with the <strong>.Tests</strong> suffix) in the build directory and transform them to FileIncludes. </p>

<p>The <code>NUnit</code> is yet another <a href="http://fsharp.github.io/FAKE/apidocs/fake-nunitsequential.html">inbuilt function of Fake</a> which runs nunit on the given group of assemblies.</p>

<p>It takes two parameter, a function that returns the modified default <code>NUnitParams</code> value and a sequence of assembly paths. We have modified the default <code>ToolPath</code> property which specifies the file path of <strong>NUnit Runner</strong> </p>

<p>As we did for Fake we have to modify the batch file as below to install the Nunit Runner nuget package before running the actual script.  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="bat"><span class="line"><span class="p">@</span><span class="k">echo</span> <span class="k">off</span>
</span><span class="line"><span class="k">cls</span>
</span><span class="line"><span class="s2">&quot;.nuget\NuGet.exe&quot;</span> <span class="s2">&quot;Install&quot;</span> <span class="s2">&quot;FAKE&quot;</span> <span class="s2">&quot;-OutputDirectory&quot;</span> <span class="s2">&quot;tools&quot;</span> <span class="s2">&quot;-ExcludeVersion&quot;</span>
</span><span class="line"><span class="s2">&quot;.nuget\NuGet.exe&quot;</span> <span class="s2">&quot;Install&quot;</span> <span class="s2">&quot;NUnit.Runners&quot;</span> <span class="s2">&quot;-OutputDirectory&quot;</span> <span class="s2">&quot;tools&quot;</span> <span class="s2">&quot;-ExcludeVersion&quot;</span>
</span><span class="line">
</span><span class="line"><span class="s2">&quot;tools\FAKE\tools\Fake.exe&quot;</span> build.fsx
</span><span class="line"><span class="k">pause</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="deploy-the-application-in-iis">Deploy the application in IIS</h3>

<p>Well, now we are at the final step of the build process which deploy the application in the local IIS server. </p>

<p>Deploying an application in IIS is super easy using Fake. All you need to do is just input necessary things like site name, virtual directory name, etc., and call the <code>IIS</code> function in <strong>Fake.IIS</strong> library which is installed as part of Fake.</p>

<p>To begin with we need to add reference in the beginning <strong>build.fsx</strong> to include the <strong>Fake.IIS</strong> library. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">#</span><span class="n">r</span> <span class="s">&quot;tools/FAKE/tools/Fake.IIS.dll&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This <strong>Fake.IIS</strong> makes heavy use of <a href="http://msdn.microsoft.com/en-us/library/microsoft.web.administration.servermanager(v=vs.90).aspx">ServerManager</a> which helps to dynamically configure IIS 7.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="n">Target</span> <span class="s">&quot;Deploy&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">siteName</span> <span class="o">=</span> <span class="s">&quot;fsharp&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">appPool</span> <span class="o">=</span> <span class="s">&quot;fsharp.appPool&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">port</span> <span class="o">=</span> <span class="s">&quot;:9999:&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">vdir</span> <span class="o">=</span> <span class="s">&quot;/phonecat&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">webBuildPath</span> <span class="o">=</span> <span class="n">buildDir</span> <span class="o">+</span> <span class="s">&quot;/_PublishedWebsites/Web&quot;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">sitePhysicalPath</span> <span class="o">=</span> <span class="s">@&quot;c:\inetpub\wwwroot\phonecat&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="n">XCopy</span> <span class="n">webBuildPath</span> <span class="n">sitePhysicalPath</span>
</span><span class="line">
</span><span class="line">  <span class="o">(</span><span class="n">IIS</span>
</span><span class="line">    <span class="o">(</span><span class="n">Site</span> <span class="n">siteName</span> <span class="s">&quot;http&quot;</span> <span class="n">port</span> <span class="s">@&quot;C:\inetpub\wwwroot&quot;</span> <span class="n">appPool</span><span class="o">)</span>
</span><span class="line">    <span class="o">(</span><span class="n">ApplicationPool</span> <span class="n">appPool</span> <span class="k">true</span> <span class="s">&quot;v4.0&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">(</span><span class="n">Some</span><span class="o">(</span><span class="n">Application</span> <span class="n">vdir</span> <span class="n">sitePhysicalPath</span><span class="o">)))</span>
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>When we build a web project using MsBuild in release mode, it creates a deployable directory which can be accessed using the path <em>/_PublishedWebsites/Web</em> in the build directory. So, after building the application we just need to copy this deployable directory to the <strong>intepub\wwwroot</strong> directory using the XCopy function in Fake.</p>

<p>The <code>IIS</code> function takes three parameters</p>

<ul>
  <li>site - A function with the signature <code>ServerManager -&gt; Site</code> which takes an instance of ServerManager and returns a <a href="http://msdn.microsoft.com/en-us/library/microsoft.web.administration.site(v=vs.90).aspx">Site</a> with the given site settings. </li>
  <li>appPool - A function with the signature <code>ServerManager -&gt; ApplicationPool</code> which takes an instance of ServerManager and returns a <a href="http://msdn.microsoft.com/en-us/library/microsoft.web.administration.applicationpool(v=vs.90).aspx">AppPool</a> with the given appPool settings.  </li>
  <li>app - An option type with the signature <code>(Site -&gt; ServerManager -&gt; Application) option</code> provides the <a href="http://msdn.microsoft.com/en-us/library/microsoft.web.administration.application(v=vs.90).aspx">Application</a>  </li>
</ul>

<p>Fake’s IIS helper library has in-built function for Site, ApplicationPool and Application which takes the necessary inputs need for its creation and returns the associated instances. All of these function creates Site, ApplicationPool and Application respectively if they are not available in the IIS. </p>

<h3 id="running-the-targets">Running the Targets</h3>

<p>In the above steps we just defined various Fake targets. These targets doesn’t execute on its own and we need to explicitly define the order of its execution and initiate.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="s">&quot;Clean&quot;</span>
</span><span class="line">  <span class="o">==&gt;</span> <span class="s">&quot;Build&quot;</span>
</span><span class="line">  <span class="o">==&gt;</span> <span class="s">&quot;Test&quot;</span>
</span><span class="line">  <span class="o">==&gt;</span> <span class="s">&quot;Deploy&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">RunTargetOrDefault</span> <span class="s">&quot;Deploy&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>==&gt;</code> is one of <a href="http://fsharp.github.io/FAKE/apidocs/fake-additionalsyntax.html">the DSL in Fake</a> which is actually a function that defines the target execution order.</p>

<p>The <code>RunTargetOrDefault</code> function runs the target specified in the parameter or executes the default target.</p>

<h3 id="summary">Summary</h3>

<p>Fake is just awesome. We can automate so much things with very few lines of code and the beauty is it can be used in <strong>any .net projects</strong>. If you are using MsBuild Xml scripts, do try Fake! It will make you super productive. You can find the source of this step in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/4">fsharp-phonecat repository</a>. </p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-3 PhoneCat Recommendation System using F# Agents, SignalR and Rx]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/"/>
    <updated>2015-01-02T05:44:52+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 3 of my blog series on <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the last two steps we have seen how to create a <a href="http://blog.tamizhvendan.in/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">web apis</a> and <a href="http://blog.tamizhvendan.in/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">static razor views</a> in fsharp. In this blog post we are going to see one of my favorite feature in fsharp <a href="http://fsharpforfunandprofit.com/posts/concurrency-actor-model/">“Message based approach to concurrency”</a>.</p>

<h3 id="a-small-flashback">A Small Flashback</h3>
<p>I’ve actually planned to put this blog post for the great fsharp community initiative <a href="https://sergeytihon.wordpress.com/2014/11/24/f-advent-calendar-in-english-2014/">F# Advent Calender</a>. Unfortunately it was not able to get through as I’ve <a href="http://sergeytihon.wordpress.com/2014/11/24/f-advent-calendar-in-english-2014/#comment-4135">nominated myself</a> little late. I always believe there is an opportunity behind every adversity. I didn’t get hung up and I knew this is one of the great topic to blog about. When I decided to blog about it, I needed a sample web application. So, I was creating that sample application and it suddenly strikes! <em>How about a blog series on web application development in fsharp?</em> I’ve immediately started working on it and hence this blog series.</p>

<h3 id="so-what-we-gonna-do-in-this-step">So what we gonna do in this step</h3>
<p>In this blog post we are going to build a recommendation system which keeps track of what phones that the user is viewing, and based on his navigation history, we will be recommending a phone that he might be interested in</p>

<p style="text-align:center"> <strong> User visits &#8220;Motorola XOOM™&#8221; </strong> </p>
<p><img src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_3/Phone_1.png" /></p>

<p style="text-align:center"> <strong> User visits &#8220;Motorola XOOM™ with Wi-Fi&#8221; </strong> </p>
<p><img src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_3/Phone_2.png" /></p>

<p>Let us start the implementation by defining two high level tasks</p>

<ol>
  <li>Tracking user navigation</li>
  <li>Recommending a phone</li>
</ol>

<h3 id="tracking-user-navigation">1. Tracking user navigation</h3>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_3/Phone_Visit_Workflow.png" width="600" height="500" /></p>

<p>The first two components has been already implemented as part of <a href="http://blog.tamizhvendan.in/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">step-2</a>. So we just need to wire up the other two components. Let’s start from <code>PhoneViewTracker</code></p>

<p>Create a source file in the <strong>Web</strong> project and name it as <code>PhoneViewTracker</code>. Add a function <code>observePhonesViewed</code> which will be invoked when you a user visits a phone.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">PhoneViewTracker</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">observePhonesViewed</span> <span class="n">anonymousId</span> <span class="n">phoneIdBeingVisited</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">StorageAgent</span><span class="p">.</span><span class="n">Post</span> <span class="o">(</span><span class="n">SavePhoneVisit</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">phoneIdBeingVisited</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>anonymousId</code> is a <a href="http://msdn.microsoft.com/en-us/library/system.web.httprequest.anonymousid%28v=vs.110%29.aspx">http property</a> which represents a unique identifier for the given user session</p>

<p>Upon receiving the <code>anonymousId</code> and <code>phoneIdBeingVisited</code> we will be posting a message to the <code>StorageAgent</code> to save this visit. Both the agent and the message doesn’t exist now, so lets create them</p>

<p>Create a source file in the <strong>Domain</strong> project and name it as <code>UserNavigationHistory</code> and add the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Reactive.Subjects</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Collections.Generic</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Agent</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">MailboxProcessor</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">T</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">UserNavigationHistory</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">StorageAgentMessage</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">storageAgentFunc</span> <span class="o">(</span><span class="n">agent</span> <span class="o">:</span> <span class="n">Agent</span><span class="o">&lt;</span><span class="n">StorageAgentMessage</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">loop</span> <span class="o">(</span><span class="n">dict</span> <span class="o">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">list</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">storageAgentMessage</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
</span><span class="line">      <span class="k">match</span> <span class="n">storageAgentMessage</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">phoneIdBeingVisited</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="k">if</span> <span class="n">dict</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">            <span class="k">let</span> <span class="nv">phoneIdsVisited</span> <span class="o">=</span> <span class="n">phoneIdBeingVisited</span> <span class="o">::</span> <span class="n">dict</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span>
</span><span class="line">            <span class="n">dict</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">phoneIdsVisited</span>
</span><span class="line">          <span class="k">else</span>
</span><span class="line">            <span class="n">dict</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="o">[</span><span class="n">phoneIdBeingVisited</span><span class="o">])</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">loop</span> <span class="n">dict</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="n">loop</span> <span class="o">(</span><span class="k">new</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">list</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">StorageAgent</span> <span class="o">=</span> <span class="nn">Agent</span><span class="p">.</span><span class="n">Start</span><span class="o">(</span><span class="n">storageAgentFunc</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Storage Agent is an F# Agent which stores the user navigation history in an in-memory dictionary. It can be replaced by any key-value store like <a href="http://redis.io/">redis</a> but for experimentation I’ve preferred to use F# Agents.</p>

<p>The <code>StorageAgentMessage</code> is a <a href="http://fsharpforfunandprofit.com/posts/discriminated-unions/">dicriminated union</a> represents possible messages that the <code>StorageAgent</code> can process. Right now it has only message <code>SavePhoneVisit</code> which takes a tuple representing the <code>anonymousId</code> and the <code>phoneIdBeingVisited</code></p>

<p>The <code>StorageAgent</code> is a typical F# Agent which waits for the incoming <code>StorageAgentMessage</code> and upon receiving it stores the visit in the in-memory dictionary. </p>

<p>The next step is wiring the <code>PhoneViewTracker.observePhonesViewed</code> function with the <code>PhoneController.Show</code> action method. We can call the function directly that will create a strongly coupled code. We can even directly post the message to the agent. But that also makes the code tightly coupled. </p>

<p>What we are actually trying to implement here is a <strong>User Phone Visit Stream</strong>. Whenever the user visits a phone, we just want to notifiy somebody to keep track of it and move on. And its where <a href="http://msdn.microsoft.com/en-in/data/gg577609.aspx">Reactive Extensions aka Rx</a> comes into the picture. If you are new to Reactive Programming or Rx, I strongly recommend you to go through <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">this excellent article</a> by <a href="http://staltz.com/">André Staltz</a></p>

<p>Install the <a href="https://www.nuget.org/packages/Rx-Main/">Rx Nuget Package</a> in the <em>Web</em> project. With Rx in the kitty the next step is to make the User’s phone visit as event and subscribe this event with the <code>PhoneViewTracker</code></p>

<p>The first step is to make the <code>PhoneController</code> as observable. Modify the already created <code>PhoneController</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">PhoneController</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Subject</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">interface</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span> <span class="k">with</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Subscribe</span> <span class="n">observer</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">Subscribe</span> <span class="n">observer</span>
</span><span class="line">
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Show</span> <span class="o">(</span><span class="n">id</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phone</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">id</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">PhoneViewModel</span><span class="p">.</span><span class="n">ToPhoneViewModel</span>
</span><span class="line">    <span class="n">subject</span><span class="o">.</span><span class="n">OnNext</span> <span class="n">id</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">phone</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">Dispose</span> <span class="n">disposing</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="n">disposing</span> <span class="k">then</span>
</span><span class="line">      <span class="n">subject</span><span class="o">.</span><span class="n">OnCompleted</span><span class="bp">()</span>
</span><span class="line">      <span class="n">subject</span><span class="o">.</span><span class="n">Dispose</span><span class="bp">()</span>
</span><span class="line">    <span class="k">base</span><span class="o">.</span><span class="n">Dispose</span> <span class="n">disposing</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>One of the great feature of F# is its seamless interoperability with C# libraries. As you seen in the above code snippet we have just made the <code>PhoneController</code> into an observable by implementing the interface <a href="http://msdn.microsoft.com/en-us/library/dd990377%28v=vs.110%29.aspx">IObservable</a>. </p>

<p>We have created a private <a href="http://msdn.microsoft.com/en-us/library/hh242970%28v=vs.103%29.aspx">Rx Subject</a> and made it responsible for pushing the notification which contains the phone id that is being visited.</p>

<p>But wait how do we configure the subscription between this controller and the <code>PhoneViewTracker</code> ? Thanks to the CompositionRoot that we have <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/2/Web/Infrastructure.fs#L28-L32">created in the step-2</a>. As we have full control over the creation of controller its just a matter of two lines to achieve it.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">      <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">        <span class="c1">// ...</span>
</span><span class="line">        <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhoneController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToCatalogPhone</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">observer</span> <span class="o">=</span> <span class="nn">PhoneViewTracker</span><span class="p">.</span><span class="n">observePhonesViewed</span> <span class="o">(</span><span class="n">requestContext</span><span class="o">.</span><span class="n">HttpContext</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">AnonymousID</span><span class="o">)</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">phoneController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhoneController</span><span class="o">(</span><span class="n">phones&#39;</span><span class="o">)</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">subscription</span> <span class="o">=</span> <span class="n">phoneController</span><span class="o">.</span><span class="n">Subscribe</span> <span class="n">observer</span>
</span><span class="line">          <span class="n">phoneController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">        <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We are leveraging the ASP.NET’s <a href="http://msdn.microsoft.com/en-us/library/fsykd036.aspx">Anonymous Identification Module</a> which help us in creating a unique anonymous id for every user session. We can retrieve it from the <a href="http://msdn.microsoft.com/en-us/library/system.web.httprequest.anonymousid.aspx">HttpRequest</a> as mentioned in the above snippet</p>

<p><a href="http://msdn.microsoft.com/en-in/library/91ka2e6a(v=vs.85).aspx">Anonymous identification of user session</a> are not enabled by default, so add the following entry in the <strong>Web.config</strong> file</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;configuration&gt;</span>
</span><span class="line">  <span class="c">&lt;!-- Existing Code ignored for brevity ... --&gt;</span>
</span><span class="line">  <span class="nt">&lt;system.web&gt;</span>
</span><span class="line">    <span class="c">&lt;!-- Existing Code ignored for brevity... --&gt;</span>
</span><span class="line">    <span class="nt">&lt;anonymousIdentification</span> <span class="na">enabled=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/system.web&gt;</span>
</span><span class="line"><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With the help of the partial application of functions as we did it in the previous steps, we have created a partial function called <code>observer</code> which has the signature <code>string -&gt; unit</code>. Then we have subscribed to <code>PhoneController</code> using the <code>Subscribe</code> method and with this we are done with saving an user visit. </p>

<h3 id="recommending-a-phone">2. Recommending a phone</h3>

<p><strong>Workflow</strong></p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_3/Phone_Recommendation_Workflow.png" width="600" height="500" /></p>

<ol>
  <li>User initiates the recommendation request using SignalR</li>
  <li>Upon receiving it, Recommendation SignalR hub sends a recommendation request message to Storage Agent with the user Anonymous Id and SignlaR connection Id of the given user</li>
  <li>Storage Agent then fetches the phone visit history of the given user based on the incoming anonymous id and pass it to the Recommendation Agent along with the SignalR connection id.</li>
  <li>Recommendation Agent responds to this by computing the recommendation and publish the result (Either recommended phone id or none) in the Recommendation observable</li>
  <li>Recommendation hub receives this recommendation result, send the response back to the corresponding SignalR client.</li>
</ol>

<p>The beauty of this entire workflow is all are message driven and asynchronous by default.  </p>

<p>Let’s start from Recommendation SignalR hub. The first step is installing SingalR from <a href="https://www.nuget.org/packages/Microsoft.AspNet.SignalR/2.1.2">the nuget</a>.</p>

<p>After installing create a source file in the <strong>Web</strong> project and name it as <code>Startup</code> then add the following code as per the SignalR convention.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Web</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">Owin</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Startup</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Configuration</span><span class="o">(</span><span class="n">app</span> <span class="o">:</span> <span class="n">IAppBuilder</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">MapSignalR</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then add an app setting in the <em>Web.config</em> file and configure the SignalR to use this <code>Startup</code> class</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;configuration&gt;</span>
</span><span class="line">  <span class="nt">&lt;appSettings&gt;</span>
</span><span class="line">    <span class="c">&lt;!-- Other keys.. --&gt;</span>
</span><span class="line">    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">&quot;owin:AppStartup&quot;</span> <span class="na">value=</span><span class="s">&quot;PhoneCat.Web.Startup&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/appSettings&gt;</span>
</span><span class="line">  <span class="c">&lt;!-- other configuration items.. --&gt;</span>
</span><span class="line"><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With SignalR added to the system, the next step is to create <code>RecommendationHub</code>. Add a source file in <strong>Web</strong> project and name it as <code>Hubs</code>.</p>

<p>Then create a <code>RecommendationHub</code> class with a public method <code>GetRecommendation</code> which will be invoked by the SignalR client to initiate recommendation process.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">RecommendationHub</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">Hub</span> <span class="bp">()</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetRecommendation</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">encodedAnonymousId</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">Cookies</span><span class="o">.[</span><span class="s">&quot;.ASPXANONYMOUS&quot;</span><span class="o">].</span><span class="n">Value</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">anonymousId</span> <span class="o">=</span> <span class="n">decode</span> <span class="n">encodedAnonymousId</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">connectionId</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">ConnectionId</span>
</span><span class="line">      <span class="nn">StorageAgent</span><span class="p">.</span><span class="n">Post</span> <span class="o">(</span><span class="n">GetRecommendation</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">connectionId</span><span class="o">))</span>
</span><span class="line">      <span class="s">&quot;Recommendation initiated&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then anonymous id of the user session is actually persisted in the <a href="http://msdn.microsoft.com/en-in/library/91ka2e6a%28v=vs.85%29.aspx">request cookies by Asp.Net</a> in an encoded format. In the <code>GetRecommendation</code> method we will be retrieving this encoded anonymous id from the cookie and decode it. Then we need to get the SignalR connection id which available in the base class <code>Hub</code>. After getting both the anonymous id and the connection id, send a <code>GetRecommendation</code> message to the <code>StorageAgent</code> with these information. Finally send a response to the SignalR client as “Recommendation initiated”.</p>

<p>The <code>decode</code> function is not added yet so let’s add them. Thanks to <a href="http://stackoverflow.com/a/2481110/159850">this stackoverflow answer</a> we just need to convert the code from C# to F#</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">decode</span> <span class="n">encodedAnonymousId</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">decodeMethod</span> <span class="o">=</span>
</span><span class="line">      <span class="n">typeof</span><span class="o">&lt;</span><span class="n">AnonymousIdentificationModule</span><span class="o">&gt;</span>
</span><span class="line">        <span class="o">.</span><span class="n">GetMethod</span><span class="o">(</span><span class="s">&quot;GetDecodedValue&quot;</span><span class="o">,</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">Static</span> <span class="o">|||</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">anonymousIdData</span> <span class="o">=</span> <span class="n">decodeMethod</span><span class="o">.</span><span class="n">Invoke</span><span class="o">(</span><span class="k">null</span><span class="o">,</span> <span class="o">[|</span> <span class="n">encodedAnonymousId</span> <span class="o">|]);</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">field</span> <span class="o">=</span>
</span><span class="line">      <span class="n">anonymousIdData</span><span class="o">.</span><span class="n">GetType</span><span class="bp">()</span>
</span><span class="line">        <span class="o">.</span><span class="n">GetField</span><span class="o">(</span><span class="s">&quot;AnonymousId&quot;</span><span class="o">,</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="o">|||</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="o">);</span>
</span><span class="line">    <span class="n">field</span><span class="o">.</span><span class="n">GetValue</span><span class="o">(</span><span class="n">anonymousIdData</span><span class="o">)</span> <span class="o">:?&gt;</span> <span class="kt">string</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We have used a special F# operator here <code>:?&gt;</code> which is a dynamic down cast operator which casts a base class to a sub-class of it. You can read <a href="http://msdn.microsoft.com/en-us/library/dd233220.aspx">this msdn documentation</a> to know more about F# casting and conversions.</p>

<p>The <code>GetRecommendation</code> message is not added yet, so let’s add them too. Modify <code>StorageAgentMessage</code> created before as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line">  <span class="k">type</span> <span class="nc">StorageAgentMessage</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span><span class="line">    <span class="o">|</span> <span class="n">GetRecommendation</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The final step of this pipeline is to Update the <code>StorageAgent</code> to handle this <code>GetRecommendation</code> message. Modify the <code>storageAgentFunc</code> in the <code>UserNavigationHistory</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"> <span class="k">let</span> <span class="nv">private</span> <span class="n">storageAgentFunc</span> <span class="o">(</span><span class="n">agent</span> <span class="o">:</span> <span class="n">Agent</span><span class="o">&lt;</span><span class="n">StorageAgentMessage</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">loop</span> <span class="o">(</span><span class="n">dict</span> <span class="o">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">list</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">storageAgentMessage</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
</span><span class="line">      <span class="k">match</span> <span class="n">storageAgentMessage</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">phoneIdBeingVisited</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="c1">// .. existing code ignored for brevity ..</span>
</span><span class="line">      <span class="o">|</span> <span class="n">GetRecommendation</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">connectionId</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="k">if</span> <span class="n">dict</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">            <span class="k">let</span> <span class="nv">phoneIdsVisited</span> <span class="o">=</span> <span class="n">dict</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span>
</span><span class="line">            <span class="nn">RecommendationAgent</span><span class="p">.</span><span class="n">Post</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span><span class="n">phoneIdsVisited</span><span class="o">)</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">loop</span> <span class="n">dict</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Handling of the <code>GetRecommendation</code> message is very straight forward. Just get the phone ids being visited by the given anonymous id from the in memory dictionary and send a message consists of connection id and this phone ids visited to the <code>RecommendationAgent</code> which we will be creating next.</p>

<p>Create a source file with the name <code>Recommendations</code> in the <strong>Domain</strong> project and add the <code>RecommendationAgent</code> below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Recommendation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">recommendationAgentFunc</span> <span class="o">(</span><span class="n">inbox</span> <span class="o">:</span> <span class="n">Agent</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">*</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">messageLoop</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">connectionId</span><span class="o">,</span> <span class="n">visitedPhoneIds</span> <span class="o">=</span> <span class="n">inbox</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="nn">Seq</span><span class="p">.</span><span class="n">length</span> <span class="n">visitedPhoneIds</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">then</span>
</span><span class="line">        <span class="n">suggestRecommendation</span> <span class="n">connectionId</span> <span class="o">(</span><span class="n">visitedPhoneIds</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">take</span> <span class="mi">2</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toList</span><span class="o">)</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">messageLoop</span><span class="bp">()</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">messageLoop</span> <span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">RecommendationAgent</span> <span class="o">=</span> <span class="nn">Agent</span><span class="p">.</span><span class="n">Start</span> <span class="n">recommendationAgentFunc</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In order to keep this blog post simple I’ve used my own ‘Hello World’ kind of algorithm which picks the latest two phone ids being visited and suggests recommendation based on it. In a real world you would be replacing this toddler algorithm with more sophisticated algorithms like <a href="http://en.wikipedia.org/wiki/Association_rule_learning">Association Rule Learning</a>. I am planning to implement this algorithm at later stages of this blog series.</p>

<p>Then the next step is to implement the <code>suggestRecommendation</code> function which picks a hardcoded recommendation and publish the result using Rx. To do this add the <a href="https://www.nuget.org/packages/Rx-Main/">Rx Nuget Package</a> in the <strong>Domain</strong> project and add the  <code>suggestRecommendation</code> function in the <code>Recommendation</code> module</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">RecommendationPipe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Subject</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">*</span><span class="kt">string</span> <span class="n">option</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">suggestRecommendation</span> <span class="n">connectionId</span> <span class="n">visitedPhoneIds</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">visitedPhoneIds</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="o">[</span><span class="s">&quot;motorola-xoom-with-wi-fi&quot;</span><span class="o">;</span> <span class="s">&quot;motorola-xoom&quot;</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">OnNext</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">Some</span> <span class="s">&quot;motorola-atrix-4g&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="o">[</span><span class="s">&quot;dell-streak-7&quot;</span><span class="o">;</span> <span class="s">&quot;dell-venue&quot;</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">OnNext</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">Some</span> <span class="s">&quot;nexus-s&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">OnNext</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">None</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The implementation is a very straight forward pattern matching. If last visited two items are (“motorola-xoom-with-wi-fi”, “motorola-xoom”), send the recommendation as “motorola-atrix-4g”, else if they are (“dell-streak-7”,”dell-venue”) then recommend “nexus-s”. If none of the condition matches then send none. Thanks to the <a href="http://fsharpforfunandprofit.com/posts/the-option-type/">option type</a> which expresses this result in type safe manner.</p>

<p>With all these infrastructure in place, all we need to do is to just subscribe to this <code>RecommendationPipe</code> and send the suggestion to the user via SignalR</p>

<p>Let’s add a observer for this pipe in the <strong>Web</strong> project. Open <code>Hubs</code> module in the <strong>Web</strong> project and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">getUrl</span> <span class="o">(</span><span class="n">phoneId</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="n">httpContext</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">routeValueDictionary</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RouteValueDictionary</span><span class="bp">()</span>
</span><span class="line">    <span class="n">routeValueDictionary</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;controller&quot;</span><span class="o">,</span> <span class="s">&quot;Phone&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">routeValueDictionary</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;action&quot;</span><span class="o">,</span> <span class="s">&quot;Show&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">routeValueDictionary</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">phoneId</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">requestContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RequestContext</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpContextWrapper</span><span class="o">(</span><span class="n">httpContext</span><span class="o">),</span> <span class="k">new</span> <span class="n">RouteData</span><span class="bp">()</span><span class="o">);</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">virtualPathData</span> <span class="o">=</span> <span class="nn">RouteTable</span><span class="p">.</span><span class="nn">Routes</span><span class="p">.</span><span class="n">GetVirtualPath</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">routeValueDictionary</span><span class="o">);</span>
</span><span class="line">    <span class="n">virtualPathData</span><span class="o">.</span><span class="n">VirtualPath</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">notifyRecommendation</span> <span class="n">httpContext</span> <span class="n">phones</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">recommendedPhoneId</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span>
</span><span class="line">    <span class="k">match</span> <span class="n">recommendedPhoneId</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="n">phoneId</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">recommendedPhone</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getPhoneById</span> <span class="n">phones&#39;</span> <span class="n">phoneId</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">phoneUrl</span> <span class="o">=</span> <span class="n">getUrl</span> <span class="n">phoneId</span> <span class="n">httpContext</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">hubContext</span> <span class="o">=</span> <span class="nn">GlobalHost</span><span class="p">.</span><span class="nn">ConnectionManager</span><span class="p">.</span><span class="n">GetHubContext</span><span class="o">&lt;</span><span class="n">RecommendationHub</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">      <span class="n">hubContext</span><span class="o">.</span><span class="n">Clients</span><span class="o">.</span><span class="n">Client</span><span class="o">(</span><span class="n">connectionId</span><span class="o">)?</span><span class="n">showRecommendation</span><span class="o">(</span><span class="n">recommendedPhone</span><span class="o">,</span> <span class="n">phoneUrl</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>notifyRecommendation</code> function checks whether the incoming recommendedPhoneId has value or not. If it has value, it just picks the <code>Phone</code> record corresponding to the given phoneId and get the url for the recommended phone. With all these data in place, we just need to send the response to the using via SignalR.</p>

<p>You would have a noticed a weird <code>?</code> symbol which is actually part of the <a href="https://www.nuget.org/packages/ImpromptuInterface.FSharp/">ImpromptuInterface.FSharp</a>. This library adds provisions to use <a href="http://msdn.microsoft.com/en-IN/library/dd264736.aspx">C# dynamic types</a> in F#</p>

<p>They are two missing pieces. One is <code>Phones.getPhoneById</code> which we are not having. Let’s add them. Open <code>Phones</code> module in <strong>Domain</strong> project and add it as mentioned below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getPhoneById</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="n">phoneId</span> <span class="o">=</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">phoneId</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The final step is wiring the <code>RecommendationPipe</code> with the <code>notifyRecommendation</code>. Open <code>Global.asax.fs</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Global</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// .. existing code ignore for brevity ..</span>
</span><span class="line"> <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Application_Start</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhones</span><span class="bp">()</span>
</span><span class="line">    <span class="c1">// .. existing code ignore for brevity ..</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">notificationObserver</span> <span class="o">=</span> <span class="nn">Hubs</span><span class="p">.</span><span class="n">notifyRecommendation</span> <span class="nn">HttpContext</span><span class="p">.</span><span class="n">Current</span> <span class="n">phones</span>
</span><span class="line">    <span class="nn">Recommendation</span><span class="p">.</span><span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">Subscribe</span> <span class="n">notificationObserver</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Partial application of function is a very handy thing which actually replaces its counterpart Dependency Injection in the OOP. We just provided the first two arguments of <code>notifyRecommendation</code> and created a new function with the signature <code>string * string option -&gt; unit</code> which is the expected observer signature for the <code>RecommendationPipe</code>.</p>

<h4 id="the-front-end-ui">The Front End UI</h4>
<p>The front end for this is a typical SignalR-Javascript client code which you can find it the <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/3/Web/Scripts/recommendation.js">github repository</a>. I’ve intentionally leaving the front-end part of this application as it would be extends the scope of the blog post. Moreover if you go through the source code in the github repository you can easily understand</p>

<h3 id="summary">Summary</h3>
<p>F# is just so awesome with so much expressive functional programming features. Rx, Agents and SignalR add more powers to it and enable you to create a scalable functional reactive architecture. I’d like give credits two incredible resources on this subject Mark Seemann’s Pluralsight course on <a href="http://www.pluralsight.com/courses/functional-architecture-fsharp">Functional Architecture with F#</a> and Kevin Ashton’s excellent blog post on <a href="http://namelessinteractive.com/blog/Full_Stack_FSharp_%E2%80%93_The_Long_Version_(Part_1)">Full Stack F#</a> which helped me a lot in coming out with this blog post.</p>

<p>Last but not the least, Thanks to <a href="https://sergeytihon.wordpress.com">Sergey Tihon</a> for the words of encouragement to write the blog post on this topic.</p>

<p>You can find the source code of this step in <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/3">the github repository</a>. </p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-2 Fsharp-PhoneCat Views using Razor]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/"/>
    <updated>2014-12-23T19:47:20+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 2 of my blog series on <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="http://blog.tamizhvendan.in/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">last blog post</a> we have created web-api endpoints which serve the data for the home page and in this blog post we are going to create views of the phones and manufacturers using <a href="http://en.wikipedia.org/wiki/ASP.NET_Razor_view_engine">Razor</a>.</p>

<h3 id="phone-view">Phone View</h3>
<p><img src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_2/Phone.png" /></p>

<p>As we did it in the step-1 we are going to start with the controller which serves the phone view. Let’s get started by creating a source file in <strong>Web</strong> project under the folders <em>Controllers</em> with the name <code>PhoneController</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">PhoneController</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Show</span> <span class="o">(</span><span class="n">id</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phone</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">id</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">PhoneViewModel</span><span class="p">.</span><span class="n">ToPhoneViewModel</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">phone</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The action method <code>Show</code> just picks the phone with the given id, converts the selected phone to a view model and returns the view.</p>

<p>The <code>phones</code> data which is being passed to the controller is actually a domain model representing the data that are required to show in the UI. Let’s create it in the <em>Domain</em> project. Create a source file in the <strong>Domain</strong> project and name it as <code>Catalog</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain.Measures</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">Catalog</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">Display</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">ScreenResolution</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ScreenSize</span> <span class="o">:</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">inch</span><span class="o">&gt;</span>
</span><span class="line">    <span class="n">TouchScreen</span> <span class="o">:</span> <span class="kt">bool</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">Storage</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Flash</span> <span class="o">:</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;</span>
</span><span class="line">    <span class="n">Ram</span> <span class="o">:</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">Android</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">OS</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">UI</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">Camera</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Features</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span>
</span><span class="line">    <span class="n">Primary</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">Phone</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Description</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Android</span> <span class="o">:</span> <span class="n">Android</span>
</span><span class="line">    <span class="n">Camera</span> <span class="o">:</span> <span class="n">Camera</span>
</span><span class="line">    <span class="n">Display</span> <span class="o">:</span> <span class="n">Display</span>
</span><span class="line">    <span class="n">Weight</span> <span class="o">:</span> <span class="kt">float</span><span class="o">&lt;</span><span class="n">g</span><span class="o">&gt;</span>
</span><span class="line">    <span class="n">Storage</span> <span class="o">:</span> <span class="n">Storage</span>
</span><span class="line">    <span class="n">Images</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>It’s a <a href="http://fsharpforfunandprofit.com/series/understanding-fsharp-types.html">typical type definition</a> in fsharp which describes the domain model <code>Phone</code>. Also if you remember we have already created a type with the same name <code>Phone</code> in <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/1/Domain/Production.fs#L29-L33">the previous step</a>. Though they share the name both are being used for different purposes. One for showing all the details of a phone and other one is for showing only few details about a phone. </p>

<p>This is what we call us <a href="http://martinfowler.com/bliki/BoundedContext.html">bounded context in DDD</a>. In fsharp we can easily achieve it using modules with less verbosity.</p>

<p>We have also used another awesome feature of fsharp called <a href="http://fsharpforfunandprofit.com/posts/units-of-measure/">units-of-measure</a> which help us <a href="http://en.wikipedia.org/wiki/Mars_Climate_Orbiter#Cause_of_failure">avoid failures in unit-coversion</a> by providing strong typed data.</p>

<p>In the later posts we will be extending the domain based on theses measure types right now it just expresses the domain correct. These measure types are not created yet so lets create them by adding a source file in <strong>Domain</strong> project with the name <code>Measures</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">Measures</span> <span class="o">=</span>
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Measure</span><span class="o">&gt;]</span> <span class="k">type</span> <span class="nc">inch</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Measure</span><span class="o">&gt;]</span> <span class="k">type</span> <span class="nc">g</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Measure</span><span class="o">&gt;]</span> <span class="k">type</span> <span class="nc">MB</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">toUOM</span> <span class="o">(</span><span class="n">measureString</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="n">stringToReplace</span> <span class="o">(</span><span class="n">uom</span> <span class="o">:</span> <span class="kt">float</span><span class="o">&lt;_&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span>
</span><span class="line">      <span class="k">if</span> <span class="n">measureString</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="k">then</span> <span class="mi">0</span><span class="o">.</span>
</span><span class="line">      <span class="k">else</span> <span class="n">measureString</span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="n">stringToReplace</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="kt">float</span>
</span><span class="line">    <span class="n">value</span> <span class="o">|&gt;</span> <span class="o">((*)</span> <span class="n">uom</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">toInch</span> <span class="o">(</span><span class="n">inchStr</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">toUOM</span> <span class="n">inchStr</span> <span class="s">&quot;inches&quot;</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">&lt;</span><span class="n">inch</span><span class="o">&gt;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">toGram</span> <span class="o">(</span><span class="n">weightStr</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">toUOM</span> <span class="n">weightStr</span> <span class="s">&quot;grams&quot;</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">&lt;</span><span class="n">g</span><span class="o">&gt;</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">toMB</span> <span class="o">(</span><span class="n">storageStr</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">toUOM</span> <span class="n">storageStr</span> <span class="s">&quot;MB&quot;</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">&lt;</span><span class="n">MB</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We have defined types to represents measures in inch, gram and megabytes. We have also added few utility methods to translate the raw string to strongly typed data which does the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&quot;200.5inches&quot; to 200.5&lt;inch&gt;
</span><span class="line">&quot;1200MB&quot; to 1200.&lt;MB&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>With the domain model in place the next step is to populate this domain model from the data-store. To do it we are going to reuse the PhoneTypeProvider that we have <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/1/DataAccess/TypeProviders.fs#L25">created in the step-1</a>. Since it has all the properties that we needed, we just need to add a function which does the mapping.</p>

<p>Open <code>TypeProviders</code> and add the below function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">ToCatalogPhone</span><span class="o">(</span><span class="n">phone</span> <span class="o">:</span> <span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">android</span> <span class="o">=</span> <span class="o">{</span> <span class="n">OS</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Android</span><span class="o">.</span><span class="n">Os</span><span class="o">;</span> <span class="n">UI</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Android</span><span class="o">.</span><span class="n">Ui</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">camera</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Features</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Camera</span><span class="o">.</span><span class="n">Features</span>
</span><span class="line">      <span class="n">Primary</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Camera</span><span class="o">.</span><span class="n">Primary</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">display</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">ScreenResolution</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">ScreenResolution</span>
</span><span class="line">      <span class="n">ScreenSize</span> <span class="o">=</span> <span class="n">toInch</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">ScreenSize</span>
</span><span class="line">      <span class="n">TouchScreen</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">TouchScreen</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">storage</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Flash</span> <span class="o">=</span> <span class="n">toMB</span> <span class="n">phone</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">Flash</span>
</span><span class="line">      <span class="n">Ram</span> <span class="o">=</span> <span class="n">toMB</span> <span class="n">phone</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">Ram</span><span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Id</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Name</span>
</span><span class="line">    <span class="n">Description</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Description</span>
</span><span class="line">    <span class="n">Android</span> <span class="o">=</span> <span class="n">android</span>
</span><span class="line">    <span class="n">Camera</span> <span class="o">=</span> <span class="n">camera</span>
</span><span class="line">    <span class="n">Display</span> <span class="o">=</span> <span class="n">display</span>
</span><span class="line">    <span class="n">Weight</span> <span class="o">=</span> <span class="n">toGram</span> <span class="n">phone</span><span class="o">.</span><span class="n">SizeAndWeight</span><span class="o">.</span><span class="n">Weight</span>
</span><span class="line">    <span class="n">Storage</span> <span class="o">=</span> <span class="n">storage</span>
</span><span class="line">    <span class="n">Images</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Images</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We are leveraging the utility functions <code>toGram</code>, <code>toMB</code> defined above as part of measure types and do seamless mapping of domain model from data store.</p>

<p>The next step is wiring the controller with the domain model and the data-store. We are going to follow the same <strong>Composition Root</strong> design as we <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/1/Web/Infrastructure.fs#L19-38">did in step-1</a></p>

<p>Add a source file in the <em>Web</em> project with the name <code>MvcInfrastructure</code> and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Web</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Web.Controllers</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Mvc</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">MvcInfrastructure</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">      <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">        <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">HomeController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">homeController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HomeController</span><span class="bp">()</span>
</span><span class="line">          <span class="n">homeController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">        <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhoneController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToCatalogPhone</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">phoneController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhoneController</span><span class="o">(</span><span class="n">phones&#39;</span><span class="o">)</span>
</span><span class="line">          <span class="n">phoneController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">        <span class="k">else</span>
</span><span class="line">          <span class="n">raise</span> <span class="o">&lt;|</span> <span class="n">ArgumentException</span><span class="o">((</span><span class="n">sprintf</span> <span class="s">&quot;Unknown controller type requested: %A&quot;</span> <span class="n">controllerType</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Similar to step-1 we are creating the composition root by passing the phones data and doing the wiring of different components.</p>

<p>Since we have created our custom ControllerFactory, we need to update the MVC configuration to use it when the framework creates the controllers.</p>

<p>Update the &#8220;`Global.asax.fs&#8220; file as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Application_Start</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phones</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhones</span><span class="bp">()</span>
</span><span class="line">  <span class="nn">AreaRegistration</span><span class="p">.</span><span class="n">RegisterAllAreas</span><span class="bp">()</span>
</span><span class="line">  <span class="nn">GlobalConfiguration</span><span class="p">.</span><span class="n">Configure</span><span class="o">(</span><span class="k">new</span> <span class="n">Action</span><span class="o">&lt;</span><span class="n">HttpConfiguration</span><span class="o">&gt;(</span><span class="k">fun</span> <span class="n">config</span> <span class="o">-&gt;</span> <span class="nn">Global</span><span class="p">.</span><span class="n">RegisterWebApi</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">phones</span><span class="o">)))</span>
</span><span class="line">  <span class="nn">Global</span><span class="p">.</span><span class="n">RegisterFilters</span><span class="o">(</span><span class="nn">GlobalFilters</span><span class="p">.</span><span class="n">Filters</span><span class="o">)</span>
</span><span class="line">  <span class="nn">Global</span><span class="p">.</span><span class="n">RegisterRoutes</span><span class="o">(</span><span class="nn">RouteTable</span><span class="p">.</span><span class="n">Routes</span><span class="o">)</span>
</span><span class="line">  <span class="nn">ControllerBuilder</span><span class="p">.</span><span class="nn">Current</span><span class="p">.</span><span class="n">SetControllerFactory</span><span class="o">(</span><span class="nn">MvcInfrastructure</span><span class="p">.</span><span class="n">CompositionRoot</span><span class="o">(</span><span class="n">phones</span><span class="o">))</span>
</span><span class="line">  <span class="nn">BundleConfig</span><span class="p">.</span><span class="n">RegisterBundles</span> <span class="nn">BundleTable</span><span class="p">.</span><span class="n">Bundles</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>In the last step the we have retrieved the phones data <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/1/Web/Global.asax.fs#L65">inside the RegisterWebApi method</a> and in this step we have moved it outside so that it can be used by both MVC Controllers and Web-Api controllers.</p>

<p>We have also changed the signature of RegisterWebApi method. In the <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/1/Web/Global.asax.fs#L51">earlier step</a> it gets the configuration parameter alone and now it has two parameters <code>httpConfiguration</code> and <code>phones</code></p>

<p>The next pending task in Phone View is translating the Phone Domain model to Phone View Model. Add the Phone View model in the <code>PhoneController</code> created before and update it us below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">PhoneViewModel</span> <span class="o">=</span>
</span><span class="line">  <span class="o">{</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Description</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Os</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Ui</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Flash</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Ram</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Weight</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ScreenResolution</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ScreenSize</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">TouchScreen</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Primary</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Features</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span>
</span><span class="line">    <span class="n">Images</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">with</span> <span class="k">static</span> <span class="k">member</span> <span class="n">ToPhoneViewModel</span><span class="o">(</span><span class="n">phone</span> <span class="o">:</span> <span class="n">Phone</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">roundToDigits</span> <span class="o">(</span><span class="n">value</span><span class="o">:</span><span class="kt">float</span><span class="o">)</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">Format</span><span class="o">(</span><span class="s">&quot;{0:0.00}&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">concatWithSpace</span> <span class="n">str2</span> <span class="n">str1</span> <span class="o">=</span> <span class="n">str1</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">str2</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">uomToString</span> <span class="o">(</span><span class="n">measureValue</span><span class="o">:</span> <span class="kt">float</span><span class="o">&lt;_&gt;)</span> <span class="n">measureName</span> <span class="o">=</span>
</span><span class="line">      <span class="n">measureValue</span> <span class="o">|&gt;</span> <span class="kt">float</span> <span class="o">|&gt;</span> <span class="n">roundToDigits</span> <span class="o">|&gt;</span> <span class="n">concatWithSpace</span> <span class="n">measureName</span>
</span><span class="line">
</span><span class="line">    <span class="o">{</span>
</span><span class="line">      <span class="n">Name</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Name</span>
</span><span class="line">      <span class="n">Description</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Description</span>
</span><span class="line">      <span class="n">Os</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Android</span><span class="o">.</span><span class="n">OS</span>
</span><span class="line">      <span class="n">Ui</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Android</span><span class="o">.</span><span class="n">UI</span>
</span><span class="line">      <span class="n">Flash</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">Flash</span> <span class="o">|&gt;</span> <span class="n">int</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s">&quot;%d MB&quot;</span>
</span><span class="line">      <span class="n">Ram</span> <span class="o">=</span>  <span class="n">phone</span><span class="o">.</span><span class="n">Storage</span><span class="o">.</span><span class="n">Ram</span> <span class="o">|&gt;</span> <span class="n">int</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s">&quot;%d MB&quot;</span>
</span><span class="line">      <span class="n">Weight</span> <span class="o">=</span> <span class="n">uomToString</span> <span class="n">phone</span><span class="o">.</span><span class="n">Weight</span> <span class="s">&quot;grams&quot;</span>
</span><span class="line">      <span class="n">ScreenResolution</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">ScreenResolution</span>
</span><span class="line">      <span class="n">ScreenSize</span> <span class="o">=</span> <span class="n">uomToString</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">ScreenSize</span> <span class="s">&quot;inches&quot;</span>
</span><span class="line">      <span class="n">TouchScreen</span> <span class="o">=</span> <span class="k">if</span> <span class="n">phone</span><span class="o">.</span><span class="n">Display</span><span class="o">.</span><span class="n">TouchScreen</span> <span class="k">then</span> <span class="s">&quot;Yes&quot;</span> <span class="k">else</span> <span class="s">&quot;No&quot;</span>
</span><span class="line">      <span class="n">Primary</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Camera</span><span class="o">.</span><span class="n">Primary</span>
</span><span class="line">      <span class="n">Features</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Camera</span><span class="o">.</span><span class="n">Features</span>
</span><span class="line">      <span class="n">Images</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Images</span>
</span><span class="line">    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>With all in place, we just need to create a razor view with the name <code>Show.cshtml</code> inside the <strong>View</strong> -&gt; <strong>Phone</strong> directory of <em>Web</em> project and update it <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/2/Web/Views/Phone/Show.cshtml">as mentioned here.</a> </p>

<p>That’s it. Phone View is up and running! Click the Phone Links in the Home Page it will take you to the Phones View Page.</p>

<h3 id="manufacturers-view">Manufacturers View</h3>
<p><img src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_2/Manufacturer.png" /><br />
Manufactures View follows the similar steps that we have used to create the Phone View. It displays the Phones manufactured by a selected manufacturer in the home page.</p>

<p>Let’s start from the controller. Create a controller in the <strong>Web</strong> project with the name <code>ManufacturerController</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="nn">Web</span><span class="p">.</span><span class="n">Controllers</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Mvc</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">ManufacturerViewModel</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="n">Phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="k">with</span> <span class="k">static</span> <span class="k">member</span> <span class="n">ToManufacturerViewModel</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">phones</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="o">{</span><span class="n">Name</span> <span class="o">=</span> <span class="nn">ManufacturerName</span><span class="p">.</span><span class="n">ToString</span> <span class="n">name</span><span class="o">;</span> <span class="n">Phones</span> <span class="o">=</span> <span class="n">phones</span><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">ManufacturerController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">getPhones</span> <span class="o">:</span> <span class="n">ManufacturerName</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">ManufacturerName</span> <span class="o">*</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Show</span> <span class="o">(</span><span class="n">id</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">viewModel</span> <span class="o">=</span>
</span><span class="line">      <span class="n">id</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">ManufacturerName</span><span class="p">.</span><span class="n">ToManufacturerName</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="n">getPhones</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">ManufacturerViewModel</span><span class="p">.</span><span class="n">ToManufacturerViewModel</span>
</span><span class="line">
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">viewModel</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>ManufacturerController</code> depends on the function <code>getPhones</code> which gives the Phones manufactured by the given manufacturer. The action method <code>Show</code> converts given id to the manufaturer name,  gets the Phones, converts them to <code>ManufacturerViewModel</code> and renders the view.</p>

<p>The domain model <code>Phone</code> mentioned here is the one that we have <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/1/Domain/Production.fs#L29-L33">already created in step-1</a>. The <code>getPhones</code> domain function is yet to be created. </p>

<p>Open <code>Phones</code> file in the <em>Domain</em> project and add the <code>getPhonesOfManufacturer</code> function.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getPhonesOfManufacturer</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">(</span><span class="n">manufacturerName</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span>
</span><span class="line">      <span class="n">phones</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="nn">ManufacturerName</span><span class="p">.</span><span class="n">ToManufacturerName</span> <span class="n">p</span><span class="o">.</span><span class="n">Name</span> <span class="o">=</span> <span class="n">manufacturerName</span><span class="o">)</span>
</span><span class="line">    <span class="o">(</span><span class="n">manufacturerName</span><span class="o">,</span> <span class="n">phones&#39;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>getPhonesOfManufacturer</code> function takes a sequence of phones and a manufacturer name, filters them for the given manufacturer and return a <a href="http://fsharpforfunandprofit.com/posts/tuples/">tuple</a> that contain the manufacturer name and the sequence of phones.</p>

<p>As we have already created the data-store functions which serves the required data, we just need to wire up the controller.</p>

<p>Update <code>MvcInfrastructure</code> file in the <em>Web</em> project to create <code>ManufacturerController</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">MvcInfrastructure</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">      <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">        <span class="c1">// ... Existing code ignored for brevity </span>
</span><span class="line">        <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">ManufacturerController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">getPhonesByManufactuerName</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span> <span class="o">|&gt;</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getPhonesOfManufacturer</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">manufacturerController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManufacturerController</span><span class="o">(</span><span class="n">getPhonesByManufactuerName</span><span class="o">)</span>
</span><span class="line">          <span class="n">manufacturerController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">        <span class="k">else</span>
</span><span class="line">          <span class="n">raise</span> <span class="o">&lt;|</span> <span class="n">ArgumentException</span><span class="o">((</span><span class="n">sprintf</span> <span class="s">&quot;Unknown controller type requested: %A&quot;</span> <span class="n">controllerType</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Thanks to the <a href="http://fsharpforfunandprofit.com/posts/partial-application/">partial function</a> we have partially applied the first parameter alone for the <code>Phones.getPhonesOfManufacturer</code> function which has the signature </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">seq&lt;Phone&gt; -&gt; ManufacturerName -&gt; seq&lt;Phone&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>and created a new function on the fly with the signature </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">ManufacturerName -&gt; seq&lt;Phone&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>which is the exactly the function that is needed by the <code>ManufacturerController</code></p>

<p>The final step is to create a razor view with the name <code>Show.cshtml</code> inside the <strong>View</strong> -&gt; <strong>Manufacturer</strong> directory of <strong>Web</strong> project and update it <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/2/Web/Views/Manufacturer/Show.cshtml">as mentioned here.</a> </p>

<h3 id="summary">Summary</h3>
<p>In this blog post we have seen how to create MVC Razor views in fsharp. You can find the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/2">source code in the github repository</a>. In the later posts we will be adding more interactivity. Stay tuned !!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step 1 - Phonecat backend using Web Api and TypeProviders]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/"/>
    <updated>2014-12-17T17:31:44+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 1 of my blog series on <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="http://blog.tamizhvendan.in/blog/2014/12/10/step-0-setting-up-the-fsharp-phonecat-solution/">last blog post</a> we have created the basic home page of phone cat with the placeholders and in this post we are going it wire the home page with the backend web apis.</p>

<p><img src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_1/home_page.png" /></p>

<p>As the above screenshot indicates we are going to develop three web api endpoints which serve the data to the front-end and we are going to use the existing json data available in <a href="https://github.com/angular/angular-phonecat/tree/master/app/phones">angular-phonecat</a> repository as our backend data store.</p>

<p>Initially I’ve planned to include TDD steps in this post but to keep it simple I am ignoring it. If you are interested in the tests that I’ve written check the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/1">source code.</a></p>

<h3 id="promotions-api">Promotions Api</h3>

<p>Let’s start with the promotions api which serves the data of three recently launched mobile phones. The first step is to create an ApiController called “PromotionsController”. You can create it by right clicking on the “Controllers” directory in the <strong>Web</strong> project and select <strong>Add -&gt; Source file</strong>. In the dialog box, name it as “PromotionsController”</p>

<p>After creating, update the controller with the dependencies as mentioned below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">Web</span><span class="p">.</span><span class="n">Controllers</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/promotions&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">PromotionsController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">getPromotions</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PhoneIndex</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PromotionPhone</span><span class="o">&gt;,</span>
</span><span class="line">    <span class="n">phoneIndexes</span><span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PhoneIndex</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>PromotionsController</code> has two dependencies. </p>

<ul>
  <li>
    <p><code>getPromotions</code> is a function a that takes a sequence of a domain model <code>PhoneIndex</code> and returns the sequence of domain model <code>PromotionPhone</code> which represents the phones that are recently launched.</p>
  </li>
  <li>
    <p><code>phoneIndexes</code> is a sequence of domain model <code>PhoneIndex</code> that represents the phones available in the backend data store.</p>
  </li>
</ul>

<p>These domain models currently not exists, so add them in the domain project as mentioned below</p>

<p>Right click on the domain project and select <strong>Add -&gt; Source file</strong>. In the dialog box, name it as “Promotions”. It creates a fsharp module with the name <code>Promotions</code> and add the <code>PromotionPhone</code> domain model</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Promotions</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">PromotionPhone</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ImageUrl</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Similarly, create an another source file called <code>Production</code> and add the domain model <code>PhoneIndex</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Production</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">PhoneIndex</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">      <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">      <span class="n">ImageUrl</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">      <span class="n">Age</span> <span class="o">:</span> <span class="n">int</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Age</code> property represents the age of the phone since its launch (so lower is younger!). Now the domain models are ready, the next step is to create an end point to expose it. </p>

<p>Let’s add a action method in PromotionsController which does the same</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Get</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="n">getPromotions</span> <span class="n">phoneIndexes</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The scaffolding is ready and the next step is to add the domain method <code>getPromotions</code> which does the actual business logic of giving recently launched phones.</p>

<p>Add the <code>getPromotions</code> function in the <code>Promotions</code> file as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getPromotions</span> <span class="o">(</span><span class="n">phoneIndexes</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PhoneIndex</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="n">phoneIndexes</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">phone</span> <span class="o">-&gt;</span> <span class="n">phone</span><span class="o">.</span><span class="n">Age</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">)</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">phone</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">Id</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Id</span><span class="o">;</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span> <span class="n">ImageUrl</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">ImageUrl</span><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>getPromotions</code> just filters the phones with the age less than 3 and map them to the corresponding <code>PromotionPhone</code> types.</p>

<p>Now its time to get the actual data from the data store. As I have mentioned earlier we will be using <a href="https://github.com/angular/angular-phonecat/tree/master/app/phones">angular-phonecat</a> repository as our data store. To access the data we will be using <a href="http://fsharp.github.io/FSharp.Data/library/JsonProvider.html">JsonTypeProvider</a>.</p>

<p>In the <em>DataAccess</em> project install the nuget package <a href="https://www.nuget.org/packages/FSharp.Data">FSharp.Data</a> and add a source file <code>TypeProviders</code>. Then update it with the type provider for Phone Index</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">FSharp.Data</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">TypeProviders</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">samplePhoneIndexes</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class="line"><span class="s">  [{</span>
</span><span class="line"><span class="s">      &quot;age&quot;: 1,</span>
</span><span class="line"><span class="s">      &quot;id&quot;: &quot;id0&quot;,</span>
</span><span class="line"><span class="s">      &quot;imageUrl&quot;: &quot;id0.jpg&quot;,</span>
</span><span class="line"><span class="s">      &quot;name&quot;: &quot;Name0&quot;,</span>
</span><span class="line"><span class="s">      &quot;snippet&quot;: &quot;Sample Snippet0&quot;</span>
</span><span class="line"><span class="s">  },{</span>
</span><span class="line"><span class="s">      &quot;age&quot;: 2,</span>
</span><span class="line"><span class="s">      &quot;id&quot;: &quot;id1&quot;,</span>
</span><span class="line"><span class="s">      &quot;imageUrl&quot;: &quot;id1.jpg&quot;,</span>
</span><span class="line"><span class="s">      &quot;name&quot;: &quot;Name1&quot;,</span>
</span><span class="line"><span class="s">      &quot;snippet&quot;: &quot;Sample Snippet2&quot;</span>
</span><span class="line"><span class="s">  }]</span>
</span><span class="line"><span class="s">  &quot;&quot;&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">PhoneIndexTypeProvider</span> <span class="o">=</span> <span class="n">JsonProvider</span><span class="o">&lt;</span><span class="n">samplePhoneIndexes</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">ToPhoneIndex</span> <span class="o">(</span><span class="n">phoneIndex</span> <span class="o">:</span> <span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="n">phoneIndex</span><span class="o">.</span><span class="n">Id</span><span class="o">;</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">phoneIndex</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span> <span class="n">Age</span> <span class="o">=</span> <span class="n">phoneIndex</span><span class="o">.</span><span class="n">Age</span><span class="o">;</span> <span class="n">ImageUrl</span> <span class="o">=</span> <span class="n">phoneIndex</span><span class="o">.</span><span class="n">ImageUrl</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>ToPhoneIndex</code> is a utility function which converts the data store model <code>PhoneIndexTypeProvider.Root</code> to the domain model <code>PhoneIndex</code></p>

<p>Now we got the type provide for <code>PhoneIndex</code>, the next step is populating it from the github repository. To do that add a source file <code>GitHubRepository</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">GitHubRepository</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">gitHubRepoUrl</span> <span class="o">=</span> <span class="s">&quot;https://raw.githubusercontent.com/angular/angular-phonecat/master/app/phones/&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">phoneIndexes</span> <span class="o">=</span> <span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Load</span><span class="o">(</span><span class="n">gitHubRepoUrl</span> <span class="o">+</span> <span class="s">&quot;phones.json&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getPhoneIndexes</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">phoneIndexes</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s it! just three line of code to get the data from the <a href="https://raw.githubusercontent.com/angular/angular-phonecat/master/app/phones/phones.json">angular-phonecat repo</a> and map to the equivalent strongly typed models  </p>

<h4 id="composition-root">Composition Root</h4>

<p>Now we need to wire up the controller with the domain and the data access. We can use a <a href="http://www.hanselman.com/blog/ListOfNETDependencyInjectionContainersIOC.aspx">Dependency Injection Container</a> to achieve it. In fact it used to be my default decision. But after reading this <a href="http://blog.ploeh.dk/2012/11/06/WhentouseaDIContainer/">wonderful blog post</a> by <a href="https://twitter.com/ploeh">Mark Seeman</a> I have actually started rethinking about dependency injection. In this sample application we are going to use the <a href="http://blog.ploeh.dk/2011/07/28/CompositionRoot/">Composition Root</a> as suggested by Mark Seeman.</p>

<p>In the <em>Web</em> project create a source file with the name <code>Infrastructure</code> and add the following composition root</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Web</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http.Dispatcher</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http.Controllers</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Web.Controllers</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">Infrastructure</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">CompositionRoot</span>
</span><span class="line">    <span class="o">(</span>
</span><span class="line">      <span class="n">phoneIndexes</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;</span>
</span><span class="line">    <span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">interface</span> <span class="n">IHttpControllerActivator</span> <span class="k">with</span>
</span><span class="line">
</span><span class="line">      <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">controllerDescriptor</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">        <span class="k">let</span> <span class="nv">phoneIndexes</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhoneIndex</span>
</span><span class="line">
</span><span class="line">        <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PromotionsController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">            <span class="k">let</span> <span class="nv">promotionsController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PromotionsController</span><span class="o">(</span><span class="n">getPromotions</span><span class="o">,</span> <span class="n">phoneIndexes&#39;</span><span class="o">)</span>
</span><span class="line">            <span class="n">promotionsController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">        <span class="k">else</span>
</span><span class="line">            <span class="n">raise</span> <span class="o">&lt;|</span> <span class="n">ArgumentException</span><span class="o">((</span><span class="n">sprintf</span> <span class="s">&quot;Unknown controller type requested: %A&quot;</span> <span class="n">controllerType</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We have actually created a custom implementation of <code>IHttpControllerActivator</code> as mentioned <a href="http://blog.ploeh.dk/2012/09/28/DependencyInjectionandLifetimeManagementwithASP.NETWebAPI/">here</a> which takes care of initializing the controllers by wiring the data store and the domain functions with the controller</p>

<p>The only pending task is tell ASP.NET Web Api to use this composition root. Update the <em>Global.asax.fs</em> file as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">static</span> <span class="k">member</span> <span class="n">RegisterWebApi</span><span class="o">(</span><span class="n">config</span><span class="o">:</span> <span class="n">HttpConfiguration</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// existing configuration will be here</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Additional Web API settings</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phoneIndexes</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhoneIndexes</span><span class="bp">()</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">Services</span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="n">typeof</span><span class="o">&lt;</span><span class="n">IHttpControllerActivator</span><span class="o">&gt;,</span> <span class="n">CompositionRoot</span><span class="o">(</span><span class="n">phoneIndexes</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have done an optimization by getting the phone indexes from the github when the application is starting, so that any requests to the application doesn’t get the data from github (typical enterprise performance improvement!).</p>

<h3 id="manufacturers-api">Manufacturers Api</h3>

<p>We are going to create the Manufacturers Api in the same way as Promotions Api. Let’s start from <code>ManufacturersController</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">Web</span><span class="p">.</span><span class="n">Controllers</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">ManufacturerViewModel</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/manufactures&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">ManufacturersController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">getManufacturerNames</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">ManufacturerName</span><span class="o">&gt;,</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Get</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="n">getManufacturerNames</span> <span class="n">phones</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">distinct</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">Name</span> <span class="o">=</span> <span class="nn">ManufacturerName</span><span class="p">.</span><span class="n">ToString</span> <span class="n">name</span><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As <code>PromotionsController</code>, <code>ManufacturersController</code> has also two dependencies.</p>

<ul>
  <li>
    <p><code>getManufacturerNames</code> is a function takes a sequence of domain model <code>Phone</code> and returns the sequence of domain model <code>ManufacturerName</code> which represents the manufacturer names of the given phones.</p>
  </li>
  <li>
    <p><code>phones</code> is a sequence of domain model &#8220;`Phone&#8220; that represents the phones available in the backend data store</p>
  </li>
</ul>

<p>The <code>Get</code> method in the <code>ManufacturersController</code> returns the manufacturer names for the given phones</p>

<p>The <code>ManufacturerViewModel</code> is just a DTO that is used to share the data across the wire.</p>

<p>The next step is to add the domain models. In the <code>Production</code> file of <em>Domain</em> project add the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">ManufacturerName</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="n">Samsung</span> <span class="o">|</span> <span class="n">Motorola</span> <span class="o">|</span> <span class="n">Dell</span> <span class="o">|</span> <span class="n">LG</span> <span class="o">|</span> <span class="n">TMobile</span> <span class="o">|</span> <span class="n">Sanyo</span> <span class="o">|</span> <span class="n">Unknown</span>
</span><span class="line">
</span><span class="line">  <span class="k">static</span> <span class="k">member</span> <span class="n">ToString</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Samsung</span> <span class="o">-&gt;</span> <span class="s">&quot;Samsung&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Motorola</span> <span class="o">-&gt;</span> <span class="s">&quot;Motorola&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Dell</span> <span class="o">-&gt;</span> <span class="s">&quot;Dell&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">LG</span> <span class="o">-&gt;</span> <span class="s">&quot;LG&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">TMobile</span> <span class="o">-&gt;</span> <span class="s">&quot;T-Mobile&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Sanyo</span> <span class="o">-&gt;</span> <span class="s">&quot;Sanyo&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Unknown</span> <span class="o">-&gt;</span> <span class="s">&quot;Unknown&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">static</span> <span class="k">member</span> <span class="n">ToManufacturerName</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="k">match</span> <span class="n">name</span><span class="o">.</span><span class="n">ToLower</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;samsung&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Samsung</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;motorola&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Motorola</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;dell&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Dell</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;lg&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">LG</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;t-mobile&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">TMobile</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;sanyo&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Sanyo</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;nexus&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Samsung</span>
</span><span class="line">      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">Unknown</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Phone</span> <span class="o">=</span>
</span><span class="line">  <span class="o">{</span> <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Description</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ImageUrl</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>As the backend data-store doesn’t directly gives the manufacturer name, we will be adding two <strong>static</strong> members that derives the manufacturer name from the phone name. The <code>ToString</code> function translates to the domain model to its equivalent string version</p>

<p>After defining the domain models, add the business logic for the getting the manufacturer names from the phone in the new source file <code>Phones</code> of the <em>Domain</em> project.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Phones</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getManufacturerNames</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">phones</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="nn">ManufacturerName</span><span class="p">.</span><span class="n">ToManufacturerName</span> <span class="n">p</span><span class="o">.</span><span class="n">Name</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>getManufacturerNames</code> is a straight forward function that map given the phones to its equivalent manufacture names.</p>

<p>The next step would be fetching the phones from the data-store. </p>

<p>Let’s start by defining a type provider for the phone. Update the <code>TypeProviders</code> module in the <em>DataAccess</em> project as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">samplePhoneJson</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class="line"><span class="s">{</span>
</span><span class="line"><span class="s">  &quot;additionalFeatures&quot;: &quot;Trackball&quot;, </span>
</span><span class="line"><span class="s">  &quot;android&quot;: {</span>
</span><span class="line"><span class="s">      &quot;os&quot;: &quot;Android 2.2&quot;, </span>
</span><span class="line"><span class="s">      &quot;ui&quot;: &quot;&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;availability&quot;: [</span>
</span><span class="line"><span class="s">      &quot;Sprint&quot;</span>
</span><span class="line"><span class="s">  ], </span>
</span><span class="line"><span class="s">  &quot;battery&quot;: {</span>
</span><span class="line"><span class="s">      &quot;standbyTime&quot;: &quot;&quot;, </span>
</span><span class="line"><span class="s">      &quot;talkTime&quot;: &quot;4 hours&quot;, </span>
</span><span class="line"><span class="s">      &quot;type&quot;: &quot;Lithium Ion (Li-Ion) (1130 mAH)&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;camera&quot;: {</span>
</span><span class="line"><span class="s">      &quot;features&quot;: [</span>
</span><span class="line"><span class="s">          &quot;Video&quot;</span>
</span><span class="line"><span class="s">      ], </span>
</span><span class="line"><span class="s">      &quot;primary&quot;: &quot;3.2 megapixels&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;connectivity&quot;: {</span>
</span><span class="line"><span class="s">      &quot;bluetooth&quot;: &quot;Bluetooth 2.1&quot;, </span>
</span><span class="line"><span class="s">      &quot;cell&quot;: &quot;CDMA2000 1xEV-DO Rev.A&quot;, </span>
</span><span class="line"><span class="s">      &quot;gps&quot;: true, </span>
</span><span class="line"><span class="s">      &quot;infrared&quot;: false, </span>
</span><span class="line"><span class="s">      &quot;wifi&quot;: &quot;802.11 b/g&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;description&quot;: &quot;Zio uses CDMA2000 1xEV-DO rev&quot;, </span>
</span><span class="line"><span class="s">  &quot;display&quot;: {</span>
</span><span class="line"><span class="s">      &quot;screenResolution&quot;: &quot;WVGA (800 x 480)&quot;, </span>
</span><span class="line"><span class="s">      &quot;screenSize&quot;: &quot;3.5 inches&quot;, </span>
</span><span class="line"><span class="s">      &quot;touchScreen&quot;: true</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;hardware&quot;: {</span>
</span><span class="line"><span class="s">      &quot;accelerometer&quot;: true, </span>
</span><span class="line"><span class="s">      &quot;audioJack&quot;: &quot;3.5mm&quot;, </span>
</span><span class="line"><span class="s">      &quot;cpu&quot;: &quot;600MHz Qualcomm MSM7627&quot;, </span>
</span><span class="line"><span class="s">      &quot;fmRadio&quot;: false, </span>
</span><span class="line"><span class="s">      &quot;physicalKeyboard&quot;: false, </span>
</span><span class="line"><span class="s">      &quot;usb&quot;: &quot;USB 2.0&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;id&quot;: &quot;sanyo-zio&quot;, </span>
</span><span class="line"><span class="s">  &quot;images&quot;: [</span>
</span><span class="line"><span class="s">      &quot;img/phones/sanyo-zio.0.jpg&quot;, </span>
</span><span class="line"><span class="s">      &quot;img/phones/sanyo-zio.1.jpg&quot;, </span>
</span><span class="line"><span class="s">      &quot;img/phones/sanyo-zio.2.jpg&quot;</span>
</span><span class="line"><span class="s">  ], </span>
</span><span class="line"><span class="s">  &quot;name&quot;: &quot;SANYO ZIO&quot;, </span>
</span><span class="line"><span class="s">  &quot;sizeAndWeight&quot;: {</span>
</span><span class="line"><span class="s">      &quot;dimensions&quot;: [</span>
</span><span class="line"><span class="s">          &quot;58.6 mm (w)&quot;, </span>
</span><span class="line"><span class="s">          &quot;116.0 mm (h)&quot;, </span>
</span><span class="line"><span class="s">          &quot;12.2 mm (d)&quot;</span>
</span><span class="line"><span class="s">      ], </span>
</span><span class="line"><span class="s">      &quot;weight&quot;: &quot;105.0 grams&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;storage&quot;: {</span>
</span><span class="line"><span class="s">      &quot;flash&quot;: &quot;130MB&quot;, </span>
</span><span class="line"><span class="s">      &quot;ram&quot;: &quot;256MB&quot;</span>
</span><span class="line"><span class="s">  }</span>
</span><span class="line"><span class="s">}</span>
</span><span class="line">
</span><span class="line"><span class="s">&quot;&quot;&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">PhoneTypeProvider</span> <span class="o">=</span> <span class="n">JsonProvider</span><span class="o">&lt;</span><span class="n">samplePhoneJson</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">ToPhone</span> <span class="o">(</span><span class="n">phone</span> <span class="o">:</span> <span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Id</span><span class="o">;</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span> <span class="n">Description</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Description</span><span class="o">;</span> <span class="n">ImageUrl</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Images</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Like <code>ToPhoneIndex</code> utility function,  <code>ToPhone</code> converts the data store model <code>PhoneTypeProvider.Root</code> to the domain model <code>Phone</code></p>

<p>Unlike the phone index, <a href="https://github.com/angular/angular-phonecat/tree/master/app/phones">angular-phonecat</a> repository stores the details of each phones in a seperate json file with the naming convention of <strong>{phoneId}.json</strong>. So, in order to get the details of all the phones, we need to fire multiple requests to get the details. Thanks to <a href="http://blogs.msdn.com/b/dsyme/archive/2010/01/09/async-and-parallel-design-patterns-in-f-parallelizing-cpu-and-i-o-computations.aspx">fsharp async workflow</a> we can easily pull all the data parallelly and populate the strongly typed domain models from them.</p>

<p>Update the <code>GitHubRepository</code> module with the code to populate the data from the data store.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">GitHubRepository</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">gitHubRepoUrl</span> <span class="o">=</span> <span class="s">&quot;https://raw.githubusercontent.com/angular/angular-phonecat/master/app/phones/&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">phoneIndexes</span> <span class="o">=</span> <span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Load</span><span class="o">(</span><span class="n">gitHubRepoUrl</span> <span class="o">+</span> <span class="s">&quot;phones.json&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">phoneIds</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">pMap</span> <span class="n">ids</span> <span class="o">=</span>
</span><span class="line">      <span class="n">seq</span> <span class="o">{</span><span class="k">for</span> <span class="n">id</span> <span class="k">in</span> <span class="n">ids</span> <span class="o">-&gt;</span> <span class="n">async</span> <span class="o">{</span> <span class="k">return</span> <span class="n">id</span><span class="o">,</span> <span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Load</span><span class="o">(</span><span class="n">gitHubRepoUrl</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">&quot;.json&quot;</span><span class="o">)</span> <span class="o">}}</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="n">Parallel</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="n">RunSynchronously</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">phones</span> <span class="o">=</span> <span class="n">pMap</span> <span class="n">phoneIds</span> <span class="o">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">ofSeq</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getPhoneIndexes</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">phoneIndexes</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getPhones</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Value</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Expressiveness is one of the reason behind my fsharp addiction. Just see the above code we have done some much thing with just few lines of code. We have fetched the details of all the phones using their ids from phone index and created an in-memory map.</p>

<p>The <code>getPhones</code> function returns the strongly typed <code>PhoneTypeProvider</code> models from the in-memory map.</p>

<p>The last thing is to wire up all the things and create the <code>ManufacturersController</code>. Update the <code>CompositionRoot</code> type in the <code>Infrastructure</code> module with the below code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;,</span>
</span><span class="line">    <span class="n">phoneIndexes</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">interface</span> <span class="n">IHttpControllerActivator</span> <span class="k">with</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">controllerDescriptor</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phoneIndexes</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhoneIndex</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PromotionsController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">promotionsController</span> <span class="o">=</span>
</span><span class="line">          <span class="k">new</span> <span class="n">PromotionsController</span><span class="o">(</span><span class="n">getPromotions</span><span class="o">,</span> <span class="n">phoneIndexes&#39;</span><span class="o">)</span>
</span><span class="line">        <span class="n">promotionsController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">
</span><span class="line">    <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">ManufacturersController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">manufacturersController</span> <span class="o">=</span>
</span><span class="line">          <span class="k">new</span> <span class="n">ManufacturersController</span><span class="o">(</span><span class="n">getManufacturerNames</span><span class="o">,</span> <span class="n">phones&#39;</span><span class="o">)</span>
</span><span class="line">        <span class="n">manufacturersController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">        <span class="n">raise</span> <span class="o">&lt;|</span> <span class="n">ArgumentException</span><span class="o">((</span><span class="n">sprintf</span> <span class="s">&quot;Unknown controller type requested: %A&quot;</span> <span class="n">controllerType</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And update the <em>Global.asax.fs</em> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">static</span> <span class="k">member</span> <span class="n">RegisterWebApi</span><span class="o">(</span><span class="n">config</span><span class="o">:</span> <span class="n">HttpConfiguration</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// existing configuration will be here</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Additional Web API settings</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phones</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhones</span><span class="bp">()</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phoneIndexes</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhoneIndexes</span><span class="bp">()</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">Services</span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="n">typeof</span><span class="o">&lt;</span><span class="n">IHttpControllerActivator</span><span class="o">&gt;,</span> <span class="n">CompositionRoot</span><span class="o">(</span><span class="n">phones</span><span class="o">,</span> <span class="n">phoneIndexes</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="top-selling-phones-api">Top Selling Phones Api</h3>

<p>Create <code>PhonesController</code> in the <em>Web</em> project and add the api to return the top selling phones</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">Web</span><span class="p">.</span><span class="n">Controllers</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/phones&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">PhonesController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">getTopSellingPhones</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;topselling&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetTopSelling</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="n">getTopSellingPhones</span> <span class="mi">3</span> <span class="n">phones</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>getTopSellingPhones</code> picks given count of phones from the given phones and return them.</p>

<p>In the <code>Phones</code> module of <em>Domain</em> project add the function <code>getTopSellingPhones</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">(</span><span class="n">phonesSold</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PhoneSold</span><span class="o">&gt;)</span> <span class="n">phoneCount</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="n">phonesSold</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Quantity</span><span class="o">,</span> <span class="o">(</span><span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p&#39;</span> <span class="o">-&gt;</span> <span class="n">p&#39;</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span><span class="o">)))</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">sortBy</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="o">-(</span><span class="n">fst</span> <span class="n">x</span><span class="o">))</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">take</span> <span class="n">phoneCount</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="n">snd</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>PhoneSold</code> domain model represents how much quantity of each phone has been sold. The <code>getTopSellingPhones</code> sorts the given phones in the descending order based on the quantity being sold and return the given count of the phones from the sorting result</p>

<p>Right now the <code>PhoneSold</code> domain model is not added. So add them in the new module <code>Purchases</code> in the <em>Domain</em> project as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Purchases</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">PhoneSold</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Quantity</span> <span class="o">:</span> <span class="n">int</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The angular data-store doesn’t provide quantity sold information, so we need to get it from somewhere else. To keep it simple, we are going add an <code>InMemoryInventory</code> in <em>DataAccess</em> project as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">InMemoryInventory</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">getPhonesSold</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">[</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;motorola-xoom-with-wi-fi&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">10</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;motorola-atrix-4g&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">24</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;nexus-s&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">4</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;samsung-galaxy-tab&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">41</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;sanyo-zio&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">31</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;motorola-xoom&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">6</span><span class="o">}</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As previous api’s we need wire things up and create the controller in the <code>CompositeRoot</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"> <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhonesController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getTopSellingPhones</span> <span class="o">(</span><span class="nn">InMemoryInventory</span><span class="p">.</span><span class="n">getPhonesSold</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phonesController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhonesController</span><span class="o">(</span><span class="n">getTopSellingPhones</span><span class="o">,</span> <span class="n">phones&#39;</span><span class="o">)</span>
</span><span class="line">  <span class="n">phonesController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have used <a href="http://fsharpforfunandprofit.com/posts/partial-application/">partial application</a> of the <code>Phones.getTopSellingPhones</code> function here. Its signature is <code>seq&lt;PhoneSold&gt; -&gt; int -&gt; seq&lt;Phone&gt; -&gt; seq&lt;Phone&gt;</code><br />
but the controller expects the function with the signature <code>int -&gt; seq&lt;Phone&gt; -&gt; seq&lt;Phone&gt;</code>.</p>

<p>The expression</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getTopSellingPhones</span> <span class="o">(</span><span class="nn">InMemoryInventory</span><span class="p">.</span><span class="n">getPhonesSold</span><span class="bp">()</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>actually does this.</p>

<h3 id="front-end">Front-End</h3>

<p>As front-end is out of the scope of this blog post I am not covering it here. I’ve actually developed it using knockout.js.</p>

<h2 id="summary">Summary</h2>

<p>We have covered a quite a large ground here by creating three web-api endpoints in fsharp using Web Api 2. In the later posts we will be adding error handling and making it robust. The source code for this step can be found in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/1">github repository</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step 0 - Setting up the fsharp-phonecat Solution]]></title>
    <link href="http://blog.tamizhvendan.in/blog/2014/12/10/step-0-setting-up-the-fsharp-phonecat-solution/"/>
    <updated>2014-12-10T22:15:50+05:30</updated>
    <id>http://blog.tamizhvendan.in/blog/2014/12/10/step-0-setting-up-the-fsharp-phonecat-solution</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is step 0 of my blog series on <a href="http://blog.tamizhvendan.in/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In this blog post, we are going to set up the visual studio solution and create the high level project structure for the <em>fsharp-phonecat</em> application. </p>

<p><strong>Let’s get started!</strong></p>

<h4 id="setting-up-visual-studio-solution">Setting Up Visual Studio Solution</h4>

<p>The first step is to create an blank visual studio solution and name it as <strong>PhoneCat</strong></p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_0/BlankSolution.png" width="700" height="700" /></p>

<p>After creating the blank solution create two fsharp class libraries and name it as <strong>Domain</strong> and <strong>DataAccess</strong> respectively.</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_0/ClassLibrary.png" width="700" height="700" /></p>

<p>Do delete the sample fsharp files Domain1.fs, DataAccess1.fs and Script.fsx that are created by default while creating the class libraries</p>

<p>Then create a ASP.NET MVC web project using <a href="https://visualstudiogallery.msdn.microsoft.com/39ae8dec-d11a-4ac9-974e-be0fdadec71b">F# MVC 5 template</a> and name it as <em>Web</em></p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_0/WebProject.png" width="700" height="700" /></p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_0/MVC5.png" /></p>

<p>We are going to use TDD, so create test projects for each of the above projects created and name it as <strong>Domain.Tests</strong>, <strong>DataAccess.Tests</strong> and <strong>Web.Tests</strong> respectively.</p>

<p>The final project structure would look like</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_0/ProjectStructure.png" /></p>

<p>F# MVC 5 template comes with a default Bootstrap theme and we are going to extend it by using e-commerce theme from <a href="http://startbootstrap.com/template-overviews/shop-homepage/">Start Bootstrap</a>. Download the theme and add <em>shop-homepage.css</em> to the Content directory of <strong>Web</strong> project. After adding it update <em>Global.asax.fs</em> to include this css file while bundling.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>BundleConfig after adding shop-homepage.css</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">BundleConfig</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">static</span> <span class="k">member</span> <span class="n">RegisterBundles</span> <span class="o">(</span><span class="n">bundles</span><span class="o">:</span><span class="n">BundleCollection</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">        <span class="n">bundles</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">ScriptBundle</span><span class="o">(</span><span class="s">&quot;~/bundles/jquery&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="n">Include</span><span class="o">([|</span><span class="s">&quot;~/Scripts/jquery-{version}.js&quot;</span><span class="o">|]))</span>
</span><span class="line">
</span><span class="line">        <span class="n">bundles</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">ScriptBundle</span><span class="o">(</span><span class="s">&quot;~/bundles/modernizr&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="n">Include</span><span class="o">([|</span><span class="s">&quot;~/Scripts/modernizr-*&quot;</span><span class="o">|]))</span>
</span><span class="line">
</span><span class="line">        <span class="n">bundles</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">ScriptBundle</span><span class="o">(</span><span class="s">&quot;~/bundles/bootstrap&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="n">Include</span><span class="o">(</span><span class="s">&quot;~/Scripts/bootstrap.js&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;~/Scripts/respond.js&quot;</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">        <span class="n">bundles</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">StyleBundle</span><span class="o">(</span><span class="s">&quot;~/Content/css&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="n">Include</span><span class="o">(</span><span class="s">&quot;~/Content/bootstrap.css&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;~/Content/site.css&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;~/Content/shop-homepage.css&quot;</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now the stage is set for awesomeness. Update <strong>_Layout.cshtml</strong> and <strong>Index.cshtml</strong> as mentioned in the bootstrap theme and run the web project.</p>

<p><img class="center" src="http://blog.tamizhvendan.in/images/fsharp_phonecat/step_0/HomePage.png" width="800" height="800" /></p>

<p>You can checkout the code <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/0">here</a>. In the <a href="http://blog.tamizhvendan.in/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">next-post</a> we will be wiring up the backend. Stay tuned !</p>
]]></content>
  </entry>
  
</feed>
