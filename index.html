
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>P3 Programmer</title>
	<meta name="author" content="Tamizhvendan S">

	
	<meta name="description" content="Jul 26th, 2017 golang, gorm Comments Managing Data in Golang Using Gorm - Part 2 In my previous blog post, we have seen how to use the create and &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="http://feeds.feedburner.com/tamizhvendan-blog" rel="alternate" title="P3 Programmer" type="application/atom+xml">
	
	<link rel="canonical" href="http://blog.tamizhvendan.in/">
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link href="/favicon.png" rel="shortcut icon">
  <link href='/stylesheets/fonts.css' rel='stylesheet' type='text/css'>
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <style type="text/css">

  </style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
	<!-- Start of Leadin Embed -->
  <script type="text/javascript" src="//js.leadin.com/js/v1/2177345.js" id="LeadinEmbed-2177345" crossorigin="use-credentials" async defer></script>
<!-- End of Leadin Embed -->
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-43004255-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><style>
@media (max-width: 600px) {
  .book-cover, #tag-cloud {
    display: none;
  }
}
</style>

<nav id="main-nav"><ul class="main">
    <li><a target="_blank" href="https://www.demystifyfp.com">My FP Blog</a>
    <li><a target="_blank" href="https://www.udemy.com/learn-suave/?couponCode=TAMIZH_BLOG">My FSharpTV Course</a>
    <li><a target="_blank" href="http://about.me/tamizhvendan">About Me</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    
		</li>
    <br/>
    <li>
      <a target="_blank" href="https://www.codementor.io/tamizhvendan?utm_source=github&utm_medium=button&utm_term=tamizhvendan&utm_campaign=github"><img src="https://cdn.codementor.io/badges/book_session_github.svg" alt="Book session on Codementor" style="max-width:100%" /></a>
		</li>
    <br/>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a target="_blank" class="email" href="mailto:tamizh88@gmail.com" title="Email">Email</a>
		
		
		
		
			<a target="_blank" class="twitter" href="http://twitter.com/tamizhvendan" title="Twitter">Twitter</a>
		
		
			<a target="_blank" class="github" href="https://github.com/tamizhvendan" title="GitHub">GitHub</a>
		
		
			<a target="_blank" class="coderwall" href="https://coderwall.com/tamizhvendan" title="Coderwall">Coderwall</a>
		
		
		
		
		
		
		
		
		
    	
    	
			<a target="_blank" class="rss" href="http://feeds.feedburner.com/tamizhvendan-blog" title="RSS">RSS</a>
		
	</div>
</nav>
<nav class="book-cover" style="margin-top:32px">
	<a target="_blank" href="http://products.tamizhvendan.in/fsharp-applied">
	<img class="center" src="/images/fsharp_applied_cover.jpg" width="160">
</a>
</nav>
<nav class="book-cover" style="margin-top:32px">
	<a target="_blank" href="https://www.demystifyfp.com/FsApplied2">
    <img class="center" src="/images/fsharp_applied2_cover.jpg" width="160">
</a>
</nav>
<nav id="tag-cloud">
	<section>
    <!-- <h3>Tag Cloud</h3>
    <span id="tag-cloud"><a href='/blog/categories/asp-dot-net-mvc' style='font-size: 140.0%'>asp.net mvc</a> <a href='/blog/categories/c-number' style='font-size: 110.0%'>c#</a> <a href='/blog/categories/craftsmanship' style='font-size: 115.0%'>craftsmanship</a> <a href='/blog/categories/entity-framework' style='font-size: 112.5%'>entity framework</a> <a href='/blog/categories/fsharp' style='font-size: 160.0%'>fsharp</a> <a href='/blog/categories/functional-programming' style='font-size: 120.0%'>functional-programming</a> <a href='/blog/categories/golang' style='font-size: 112.5%'>golang</a> <a href='/blog/categories/javascript' style='font-size: 110.0%'>javascript</a> <a href='/blog/categories/programming' style='font-size: 115.0%'>programming</a> <a href='/blog/categories/suave' style='font-size: 115.0%'>suave</a> <a href='/blog/categories/unit-testing' style='font-size: 112.5%'>unit testing</a> </span> -->
</section>
</nav>


</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2017-07-26T07:09:17+05:30" data-updated="true" itemprop="datePublished">Jul 26<sup>th</sup>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/golang/'>golang</a>, <a class='category' href='/blog/categories/gorm/'>gorm</a>


</div>
		
			<span class="comments"><a href="/blog/2017/07/26/managing-data-in-golang-using-gorm-part-2/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2017/07/26/managing-data-in-golang-using-gorm-part-2/" itemprop="url">Managing Data in Golang Using Gorm - Part 2</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In my previous <a href="/blog/2017/07/23/managing-data-in-golang-using-gorm-part-1/">blog post</a>, we have seen how to use the create and find function in gorm along with use-case driven approach. In this blog post, we will be extending our blogging platform <strong>gomidway</strong> by implementing an another interesting use case. </p>

<h2 id="use-case-3---publishing-a-new-blog-post">Use Case #3 - Publishing a new blog post</h2>

<p>Publishing a new blog post use case involves the following</p>

<ul>
  <li>
    <p>A user can publish a new blog post by providing a title, body of the post and a set of tags.</p>
  </li>
  <li>
    <p>If the title already exists we need to let the user know about it.</p>
  </li>
  <li>
    <p>We also need to let him know if publish went well. </p>
  </li>
</ul>

<p>Though the requirement looks simple on paper, there are some complexities regarding organizing the code and orchestrating the entire operation. </p>

<p>Let’s dig up and see how we can solve it!</p>

<h2 id="the-database-schema">The Database Schema</h2>

<p>As a first step, let’s add some new tables to our existing schema which has only the <code>users</code> table.</p>

<p>The first one is the <code>posts</code> table</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">posts</span><span class="p">(</span>
</span><span class="line">  <span class="n">id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
</span><span class="line">  <span class="n">title</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">UNIQUE</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class="line">  <span class="n">body</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class="line">  <span class="n">published_at</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class="line">  <span class="n">author_id</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">REFERENCES</span> <span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class="line"><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then we need to have an another table for <code>tags</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">tags</span><span class="p">(</span>
</span><span class="line">  <span class="n">id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
</span><span class="line">  <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line"><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And finally, a bridge table to associate <code>posts</code> and <code>tags</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">posts_tags</span><span class="p">(</span>
</span><span class="line">  <span class="n">tag_id</span> <span class="nb">INTEGER</span> <span class="k">REFERENCES</span> <span class="n">tags</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
</span><span class="line">  <span class="n">post_id</span> <span class="nb">INTEGER</span> <span class="k">REFERENCES</span> <span class="n">posts</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class="line"><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><em>Note: a blog post can have multiple tags, and a tag can have multiple blog posts associated with it</em></p>

<h2 id="model-definitions---post-and-tag">Model Definitions - Post and Tag</h2>

<p>The next step is defining equivalent models for <code>Post</code> and <code>Tag</code> in golang. </p>

<p>Let’s create a new folder called <code>tag</code> and define the <code>Tag</code> model.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// tag/model.go</span>
</span><span class="line"><span class="kn">package</span> <span class="nx">tag</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Tag</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">ID</span>   <span class="kt">uint</span>
</span><span class="line">  <span class="nx">Name</span> <span class="kt">string</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then define the <code>Post</code> model in an another new folder <code>post</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// post/model.go</span>
</span><span class="line"><span class="kn">package</span> <span class="nx">post</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">  <span class="s">&quot;time&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="s">&quot;github.com/tamizhvendan/gomidway/tag&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">const</span> <span class="p">(</span>
</span><span class="line">  <span class="nx">UniqueConstraintTitle</span> <span class="p">=</span> <span class="s">&quot;posts_title_key&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Post</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">ID</span>          <span class="kt">uint</span>
</span><span class="line">  <span class="nx">Title</span>       <span class="kt">string</span>
</span><span class="line">  <span class="nx">Body</span>        <span class="kt">string</span>
</span><span class="line">  <span class="nx">AuthorID</span>    <span class="kt">uint</span>
</span><span class="line">  <span class="nx">Tags</span>        <span class="p">[]</span><span class="nx">tag</span><span class="p">.</span><span class="nx">Tag</span> <span class="s">`gorm:&quot;many2many:posts_tags;&quot;`</span>
</span><span class="line">  <span class="nx">PublishedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">TitleDuplicateError</span> <span class="kd">struct</span><span class="p">{}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">TitleDuplicateError</span><span class="p">)</span> <span class="nx">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="s">&quot;title already exists&quot;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As we have seen in <a href="https://github.com/tamizhvendan/gomidway/blob/part-1/user/create.go#L11-#L16">the previous blog post</a>, the constant <code>UniqueConstraintTitle</code> and the <code>TitleDuplicateError</code> are required for doing unique constraint violation error check on the <code>title</code> column and to communicate it to the application respectively. </p>

<p>The important thing to notice in this model definition is the <code>Tags</code> field</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">Post</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="nx">Tags</span>        <span class="p">[]</span><span class="nx">tag</span><span class="p">.</span><span class="nx">Tag</span> <span class="s">`gorm:&quot;many2many:posts_tags;&quot;`</span>
</span><span class="line">  <span class="c1">// ..</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Tags</code> field has a <a href="https://golang.org/ref/spec#Tag">golang struct tag</a> <code>gorm</code> defining the association type <code>many2many</code> and the name of the bridge table <code>posts_tags</code>.</p>

<h2 id="implementing-new-blog-post-use-case">Implementing new blog post use case</h2>

<p>Now we have all the models required to enable publishing a new blog post, and it’s time to have to go at its implementation.</p>

<p>Let’s start by creating a new folder <code>publish</code> under <code>post</code> and add the scaffolding for the handler </p>

<p><em>As we have seen earlier, the folder structure represent the use case, and the handler orchestrate the use case</em></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// post/publish/handler.go</span>
</span><span class="line"><span class="kn">package</span> <span class="nx">publish</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">  <span class="s">&quot;github.com/jinzhu/gorm&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Request</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">Title</span>    <span class="kt">string</span>
</span><span class="line">  <span class="nx">Body</span>     <span class="kt">string</span>
</span><span class="line">  <span class="nx">AuthorID</span> <span class="kt">uint</span>
</span><span class="line">  <span class="nx">Tags</span>     <span class="p">[]</span><span class="kt">string</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Response</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">PostId</span> <span class="kt">uint</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">NewPost</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// TODO</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The implementation of publishing a new post involves the following steps</p>

<ol>
  <li>
    <p>For all the <code>Tags</code> that are part of the request, we need to create an entry in the <code>tags</code> table. If it is already there, we don’t need to create.</p>
  </li>
  <li>
    <p>The next step is creating a new entry in the <code>posts</code> table with the given details. </p>
  </li>
  <li>
    <p>Finally, we need to associate the <code>Tags</code> with the newly created <code>Post</code> via the bridge table. </p>
  </li>
</ol>

<p>Since it involves multiple inserts on the database side, all the three steps should happen inside a transaction.</p>

<p><em>The first two steps can be executed in any order as they are independent of each other</em></p>

<h3 id="code-organization-aka-responsibility-separation">Code Organization (aka Responsibility Separation)</h3>

<p>We discussed a little bit about code organization in the <a href="/blog/2017/07/23/managing-data-in-golang-using-gorm-part-1/">last blog post</a>. One important thing which can help us, in the long run is having proper separation of concern in the code base. </p>

<p>There are multiple ways we can separate the concern. In our case, we are organizing by use cases with <code>handler</code> driving the implementation. The handler may access the <code>data</code> layer if the use case requires. </p>

<p>To keep things simple, we are not discussing dependency injection in <code>handler</code> and <code>data</code> layer interaction here. I am planning to cover this in my future blog posts.</p>

<p>Back to our business, the data access logic of the three steps will be in their respective packages and the <code>publish</code> handler coordinate the entire use case logic. </p>

<p><img class="center" src="/images/gomidway/part2/code_org.png" /></p>

<h4 id="step-1-create-a-tag-if-not-exists">Step 1: Create a Tag if not exists</h4>

<p>The first step is creating a tag if it is not there in the database. For the both new tags and the existing tags we need to get its <code>id</code> from the database to associate it with the <code>posts</code>.</p>

<p>Gorm has a method called <a href="https://godoc.org/github.com/jinzhu/gorm#DB.FirstOrCreate">FirstOrCreate</a> to help us to implement this step. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// tag/create.go</span>
</span><span class="line"><span class="kn">package</span> <span class="nx">tag</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="s">&quot;github.com/jinzhu/gorm&quot;</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">CreateIfNotExists</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">tagName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Tag</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="kd">var</span> <span class="nx">tag</span> <span class="nx">Tag</span>
</span><span class="line">  <span class="nx">res</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">FirstOrCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">Tag</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="nx">tagName</span><span class="p">})</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Error</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">tag</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <em>FirstOrCreate</em> method populates the <code>Id</code> field of the tag.</p>

<h4 id="step-2-creating-a-new-post">Step 2: Creating a new Post</h4>

<p>It is similar to creating a new user that we saw in the last blog post</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// post/create.go</span>
</span><span class="line"><span class="kn">package</span> <span class="nx">post</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">  <span class="s">&quot;github.com/jinzhu/gorm&quot;</span>
</span><span class="line">  <span class="s">&quot;github.com/tamizhvendan/gomidway/postgres&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">Create</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">post</span> <span class="o">*</span><span class="nx">Post</span><span class="p">)</span> <span class="p">(</span><span class="kt">uint</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">res</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">postgres</span><span class="p">.</span><span class="nx">IsUniqueConstraintError</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">Error</span><span class="p">,</span> <span class="nx">UniqueConstraintTitle</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">      <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">TitleDuplicateError</span><span class="p">{}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Error</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">post</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="step-3-associating-tag-with-post">Step 3: Associating Tag with Post</h4>

<p>The final step is associating the tag with the post in the database. Gorm has a decent support for <a href="http://jinzhu.me/gorm/associations.html">Associations</a>. The one that we needed from gorm to carry out the current step is its <a href="https://godoc.org/github.com/jinzhu/gorm#Association.Append">Append</a> method.</p>

<p>Let’s define a <code>constant</code> in <code>Post</code> model which holds the AssociationTag</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// post/model.go</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kd">const</span> <span class="p">(</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="nx">AssociationTags</span> <span class="p">=</span> <span class="s">&quot;Tags&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line"><span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then add a new file <em>tag.go</em> in the <em>post</em> folder and implement the third step as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// post/tag.go</span>
</span><span class="line"><span class="kn">package</span> <span class="nx">post</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">	<span class="s">&quot;github.com/jinzhu/gorm&quot;</span>
</span><span class="line">	<span class="s">&quot;github.com/tamizhvendan/gomidway/tag&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">AddTag</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">post</span> <span class="o">*</span><span class="nx">Post</span><span class="p">,</span> <span class="nx">tag</span> <span class="o">*</span><span class="nx">tag</span><span class="p">.</span><span class="nx">Tag</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">res</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Model</span><span class="p">(</span><span class="nx">post</span><span class="p">).</span><span class="nx">Association</span><span class="p">(</span><span class="nx">AssociationTags</span><span class="p">).</span><span class="nx">Append</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Error</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="publishing-new-blog-post">Publishing New Blog Post</h3>

<p>Now we have all the individual database layer functions ready for all the three steps, and it’s time to focus on the implementation of publishing a new blog post.</p>

<p>We already have the scaffolding in place</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// publish/handler.go</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">NewPost</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// TODO</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As a first step, let’s begin a new transaction using gorm’s <a href="https://godoc.org/github.com/jinzhu/gorm#DB.Begin">Begin</a> method. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">NewPost</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">tx</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Begin</span><span class="p">()</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Error</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="c1">// TODO</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then call the <code>Create</code> function in <code>post</code> package to create a new blog post</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">NewPost</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="nx">newPost</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">post</span><span class="p">.</span><span class="nx">Post</span><span class="p">{</span>
</span><span class="line">    <span class="nx">AuthorID</span><span class="p">:</span>    <span class="nx">req</span><span class="p">.</span><span class="nx">AuthorId</span><span class="p">,</span>
</span><span class="line">    <span class="nx">Title</span><span class="p">:</span>       <span class="nx">req</span><span class="p">.</span><span class="nx">Title</span><span class="p">,</span>
</span><span class="line">    <span class="nx">Body</span><span class="p">:</span>        <span class="nx">req</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span>
</span><span class="line">    <span class="nx">PublishedAt</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UTC</span><span class="p">(),</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">post</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">tx</span><span class="p">,</span> <span class="nx">newPost</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="c1">// TODO</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then for all the tags in the request, call the <code>CreateIfNotExists</code> function in <code>tag</code> package to get its respective <em>Ids</em> and associate it with the newly created post using the <code>AddTag</code> function in the <code>post</code> package.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">NewPost</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">tagName</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Tags</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">CreateIfNotExists</span><span class="p">(</span><span class="nx">tx</span><span class="p">,</span> <span class="nx">tagName</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">      <span class="nx">tx</span><span class="p">.</span><span class="nx">Rollback</span><span class="p">()</span>
</span><span class="line">      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">post</span><span class="p">.</span><span class="nx">AddTag</span><span class="p">(</span><span class="nx">tx</span><span class="p">,</span> <span class="nx">newPost</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">      <span class="nx">tx</span><span class="p">.</span><span class="nx">Rollback</span><span class="p">()</span>
</span><span class="line">      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="c1">// TODO</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>A thing to note here is we are rolling back the transaction using the <a href="https://godoc.org/github.com/jinzhu/gorm#DB.Rollback">RollBack</a> method in case of error. </p>

<p>The final step is committing the transaction and returning the newly created post id as response</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">NewPost</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="nx">res</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Commit</span><span class="p">()</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Error</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Response</span><span class="p">{</span><span class="nx">PostId</span><span class="p">:</span> <span class="nx">newPost</span><span class="p">.</span><span class="nx">ID</span><span class="p">},</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="test-driving-publish-new-blog-post">Test Driving Publish New Blog Post</h3>

<p>Let’s test drive our implementation from the <code>main</code> function with some hard coded value</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// main.go</span>
</span><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="s">&quot;github.com/tamizhvendan/gomidway/post&quot;</span>
</span><span class="line">  <span class="s">&quot;github.com/tamizhvendan/gomidway/post/publish&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="nx">publishPost</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">publishPost</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">publish</span><span class="p">.</span><span class="nx">NewPost</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">publish</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span>
</span><span class="line">    <span class="nx">AuthorId</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class="line">    <span class="nx">Body</span><span class="p">:</span>     <span class="s">&quot;Golang rocks!&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="nx">Title</span><span class="p">:</span>    <span class="s">&quot;My first gomidway post&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="nx">Tags</span><span class="p">:</span>     <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;intro&quot;</span><span class="p">,</span> <span class="s">&quot;golang&quot;</span><span class="p">},</span>
</span><span class="line">  <span class="p">})</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="o">*</span><span class="nx">post</span><span class="p">.</span><span class="nx">TitleDuplicateError</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span><span class="line">      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Bad Request: &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span class="line">      <span class="k">return</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Internal Server Error: &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span class="line">    <span class="k">return</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Created: &quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">PostId</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>if we run the program with these hard coded values, we will get the following output</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">Created: 1
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>if we rerun the program without changing anything, we will get the bad request error as expected</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">Bad Request: title already exists
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="summary">Summary</h2>

<p>In this blog post, we have seen how to perform, create operation of a model having many to many relationship using gorm. The source code is available in my <a href="https://github.com/tamizhvendan/gomidway/tree/part-2">GitHub repository</a>. </p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2017-07-23T07:55:59+05:30" data-updated="true" itemprop="datePublished">Jul 23<sup>rd</sup>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/golang/'>golang</a>, <a class='category' href='/blog/categories/gorm/'>gorm</a>


</div>
		
			<span class="comments"><a href="/blog/2017/07/23/managing-data-in-golang-using-gorm-part-1/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2017/07/23/managing-data-in-golang-using-gorm-part-1/" itemprop="url">Managing Data in Golang Using Gorm - Part 1</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p><a href="www.ajira.tech">We</a> have been using <a href="jinzhu.me/gorm/">gorm</a> as a primary tool to interact with <a href="https://www.PostgreSQL.org">PostgreSQL</a> from <a href="https://golang.org">golang</a> for almost a year now. </p>

<p>Gorm does an excellent job as an <a href="https://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a> library, and we enjoyed using it in our projects. </p>

<p>Through this blog post series, I will be sharing our experiences on how we leveraged gorm to solve our client’s needs.</p>

<h2 id="the-domain">The Domain</h2>

<p>In this blog post series, we will be implementing the data persistence side of a blogging platform similar to <a href="https://medium.com">medium</a>, called <strong>gomidway</strong>.  </p>

<h2 id="part-1-introduction">Part-1 Introduction</h2>

<p>In this blog post, we will be working on defining the backend for signing up a new user and providing a provision for user login.</p>

<h2 id="the-user-model">The User Model</h2>

<p>Let’s start our modeling from the User table. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">users</span><span class="p">(</span>
</span><span class="line">  <span class="n">id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
</span><span class="line">  <span class="n">username</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">UNIQUE</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class="line">  <span class="n">email</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">UNIQUE</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class="line">  <span class="n">password_hash</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line"><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then define an equivalent model in golang.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">ID</span>           <span class="kt">uint</span> <span class="s">`gorm:&quot;primary_key&quot;`</span>
</span><span class="line">  <span class="nx">Username</span>     <span class="kt">string</span>
</span><span class="line">  <span class="nx">Email</span>        <span class="kt">string</span>
</span><span class="line">  <span class="nx">PasswordHash</span> <span class="kt">string</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Before taking the next steps, let me spend some time on explaining where to put this <code>User</code> <em>struct</em></p>

<h3 id="the-folder-structure">The Folder Structure</h3>

<p>There are two common ways to organize the models in golang. </p>

<p>One approach is defining a folder called <code>models</code> and put all the models here</p>

<p><img class="center" src="/images/gomidway/part1/models.png" /></p>

<p>The another approach is an invert of this structure. In this design, we will have a separate folder for each model. </p>

<p><img class="center" src="/images/gomidway/part1/domain.png" /></p>

<p>Both the approaches have pros and cons. Choosing one over the other is entirely opinionated, and my preference is the second one.</p>

<p>IMHO, the folder structure has <a href="https://8thlight.com/blog/uncle-bob/2011/09/30/Screaming-Architecture.html">to represent the domain</a> and the code associated a domain model should coexist with proper separation of concern. </p>

<p><img class="center" src="/images/gomidway/part1/folder_structure.png" /></p>

<blockquote>
  <p>Software architectures are structures that support the use cases of the system - <a href="https://www.amazon.com/Object-Oriented-Software-Engineering-Driven-Approach/dp/0201403471">Ivar Jacobson</a></p>
</blockquote>

<p>In this gorm blog post series, I will be following the <code>domain</code> based folder structure. </p>

<h2 id="use-case-1---user-signup">Use Case #1 - User Signup</h2>

<p>The Signup use case of a user is defined as </p>

<ul>
  <li>A user should sign up himself by providing his email, username, and password</li>
  <li>If the username or the email already exists, we need to let him now </li>
  <li>We also need to let him know if there is any error while persisting his signup details</li>
  <li>If signup succeeds, he should be getting a unique identifier in the system</li>
</ul>

<p>To keep things simple and the focus of this series is on the data persistence side, we are not going to discuss/implement the HTTP portion of the application. Instead, we will be driving our implementation with some hard code values during the application bootstrap. </p>

<h3 id="defining-the-signup-handler">Defining the Signup handler</h3>

<p>Like many terms in software engineering, the term <strong>handler</strong> has different meanings. So, let me start by explaining what I mean by a handler here. </p>

<p>A handler is a function that represents an use-case. It takes its dependency(ies) and its input(s) as parameters and returns the outcome of the use case. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// user/signup/handler.go</span>
</span><span class="line"><span class="kn">package</span> <span class="nx">signup</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Request</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">Username</span> <span class="kt">string</span>
</span><span class="line">  <span class="nx">Email</span>    <span class="kt">string</span>
</span><span class="line">  <span class="nx">Password</span> <span class="kt">string</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Response</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">Id</span> <span class="kt">uint</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">Signup</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>One important thing to notice here is, the <code>Request</code> and the <code>Response</code> are golang structs. How the request is being populated from user’s request (JSON Post / HTML form Post / command from a message queue) and how the response communicated to the user (JSON response / HTML view / event in the message queue) are left up to the application boundary. </p>

<p>In the Signup function, as a first step, we need to create the hash for the password using <a href="https://godoc.org/golang.org/x/crypto/bcrypt">bcrypt</a> and then create the new user. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">Signup</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">passwordHash</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">GenerateFromPassword</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">),</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">DefaultCost</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="nx">newUser</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">user</span><span class="p">.</span><span class="nx">User</span><span class="p">{</span>
</span><span class="line">    <span class="nx">Username</span><span class="p">:</span>     <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span><span class="p">,</span>
</span><span class="line">    <span class="nx">Email</span><span class="p">:</span>        <span class="nx">req</span><span class="p">.</span><span class="nx">Email</span><span class="p">,</span>
</span><span class="line">    <span class="nx">PasswordHash</span><span class="p">:</span> <span class="nb">string</span><span class="p">(</span><span class="nx">passwordHash</span><span class="p">),</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="c1">// ????</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The next step is persisting this newly created user</p>

<h3 id="adding-user-create-function">Adding User Create function</h3>

<p>The create user function is straight forward. We just need to call the <a href="https://godoc.org/github.com/jinzhu/gorm#DB.Create">Create</a> method in gorm</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// user/create.go</span>
</span><span class="line"><span class="kn">package</span> <span class="nx">user</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">Create</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">user</span> <span class="o">*</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="kt">uint</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">Error</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>But the work is not done yet!</p>

<p>As per our use case, We need to let the handler to know if the username or the email already exists. </p>

<p>We already have unique constraints in place in the <code>users</code> table. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">gomidway</span><span class="o">=</span><span class="c"># \d users</span>
</span><span class="line">                                    Table <span class="s2">&quot;public.users&quot;</span>
</span><span class="line">    Column     <span class="p">|</span>          Type          <span class="p">|</span>                     Modifiers
</span><span class="line">---------------+------------------------+----------------------------------------------------
</span><span class="line"> id            <span class="p">|</span> integer                <span class="p">|</span> not null default nextval<span class="o">(</span><span class="s1">&#39;users_id_seq&#39;</span>::regclass<span class="o">)</span>
</span><span class="line"> username      <span class="p">|</span> character varying<span class="o">(</span>50<span class="o">)</span>  <span class="p">|</span> not null
</span><span class="line"> email         <span class="p">|</span> character varying<span class="o">(</span>255<span class="o">)</span> <span class="p">|</span> not null
</span><span class="line"> password_hash <span class="p">|</span> text                   <span class="p">|</span> not null
</span><span class="line">Indexes:
</span><span class="line">    <span class="s2">&quot;users_pkey&quot;</span> PRIMARY KEY, btree <span class="o">(</span>id<span class="o">)</span>
</span><span class="line">    <span class="s2">&quot;users_email_key&quot;</span> UNIQUE CONSTRAINT, btree <span class="o">(</span>email<span class="o">)</span>
</span><span class="line">    <span class="s2">&quot;users_username_key&quot;</span> UNIQUE CONSTRAINT, btree <span class="o">(</span>username<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>So, the <code>Create</code> method in gorm would return an error of type <a href="http://godoc.org/github.com/lib/pq#Error">pq Error</a> with the <a href="http://godoc.org/github.com/lib/pq#ErrorCode">ErrorCode</a> as <code>"23505"</code> for <code>unique_violation</code>, and the <code>Constraint</code> field will be having the unique constraint key name <code>users_email_key</code> and <code>users_username_key</code> for email and username duplicate error respectively. </p>

<p>Though this error does communicate what we wanted, it is very generic and what we want is something concrete to our use case. </p>

<p>To make it happen, let’s create a new folder <code>postgres</code> (aka package) and write a utility function <code>IsUniqueConstraintError</code> which checks whether the given error is a unique constraint error or not.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// postgres/pq.go</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">IsUniqueConstraintError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">constraintName</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">pqErr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="o">*</span><span class="nx">pq</span><span class="p">.</span><span class="nx">Error</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">pqErr</span><span class="p">.</span><span class="nx">Code</span> <span class="o">==</span> <span class="s">&quot;23505&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">pqErr</span><span class="p">.</span><span class="nx">Constraint</span> <span class="o">==</span> <span class="nx">constraintName</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">return</span> <span class="kc">false</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and then in the <code>model.go</code>, where we have the User model, add the constraint names as constants.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// user/model.go</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kd">const</span> <span class="p">(</span>
</span><span class="line">  <span class="nx">UniqueConstraintUsername</span> <span class="p">=</span> <span class="s">&quot;users_username_key&quot;</span>
</span><span class="line">  <span class="nx">UniqueConstraintEmail</span>    <span class="p">=</span> <span class="s">&quot;users_email_key&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line"><span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Finally, define the custom error types</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// user/model.go</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kd">type</span> <span class="nx">UsernameDuplicateError</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">Username</span> <span class="kt">string</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">UsernameDuplicateError</span><span class="p">)</span> <span class="nx">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Username &#39;%s&#39; already exists&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Username</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">EmailDuplicateError</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">Email</span> <span class="kt">string</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">EmailDuplicateError</span><span class="p">)</span> <span class="nx">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Email &#39;%s&#39; already exists&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Email</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With this new helper function, constants and types in places, we can complete the create user function as follows.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// user/create.go</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">Create</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">user</span> <span class="o">*</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="kt">uint</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">Error</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">postgres</span><span class="p">.</span><span class="nx">IsUniqueConstraintError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">UniqueConstraintUsername</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">      <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">UsernameDuplicateError</span><span class="p">{</span><span class="nx">Username</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Username</span><span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">postgres</span><span class="p">.</span><span class="nx">IsUniqueConstraintError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">UniqueConstraintEmail</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">      <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">EmailDuplicateError</span><span class="p">{</span><span class="nx">Email</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Email</span><span class="p">}</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>On the handler side, we just pass the outcome of this create function to the outside(application boundary) layer</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// user/signup/handler.go</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">Signup</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">newUser</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Response</span><span class="p">{</span><span class="nx">Id</span><span class="p">:</span> <span class="nx">id</span><span class="p">},</span> <span class="nx">err</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="test-driving-user-signup">Test Driving User Signup</h3>

<p>As we discussed earlier, let’s test drive the implementation from the application bootstrap. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// main.go</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">panicOnError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;postgres&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="s">`host=localhost </span>
</span><span class="line"><span class="s">      user=postgres password=test</span>
</span><span class="line"><span class="s">      dbname=gomidway </span>
</span><span class="line"><span class="s">      sslmode=disable`</span><span class="p">)</span>
</span><span class="line">  <span class="nx">panicOnError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">  <span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">  <span class="nx">signupUser</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// main.go</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">signupUser</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">signup</span><span class="p">.</span><span class="nx">Signup</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">signup</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span>
</span><span class="line">    <span class="nx">Email</span><span class="p">:</span>    <span class="s">&quot;foo@bar.com&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="nx">Username</span><span class="p">:</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="nx">Password</span><span class="p">:</span> <span class="s">&quot;foobar&quot;</span><span class="p">,</span>
</span><span class="line">  <span class="p">})</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">switch</span> <span class="nx">err</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="k">case</span> <span class="o">*</span><span class="nx">user</span><span class="p">.</span><span class="nx">UsernameDuplicateError</span><span class="p">:</span>
</span><span class="line">      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Bad Request: &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span class="line">      <span class="k">return</span>
</span><span class="line">    <span class="k">case</span> <span class="o">*</span><span class="nx">user</span><span class="p">.</span><span class="nx">EmailDuplicateError</span><span class="p">:</span>
</span><span class="line">      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Bad Request: &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span class="line">      <span class="k">return</span>
</span><span class="line">    <span class="k">default</span><span class="p">:</span>
</span><span class="line">      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Internal Server Error: &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span class="line">      <span class="k">return</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Created: &quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Id</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>if we run the program for the first time after setting up the PostgreSQL database <code>gomidway</code> with the <code>users</code> table, we will get the following output</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">Created:  1
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>if we rerun the program again, we’ll see the bad request error</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">Bad Request:  Username <span class="s1">&#39;foo&#39;</span> already exists
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>if we modify the username from <code>foo</code> to <code>bar</code> and run the program, we’ll again get a bad request error for the email address</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">Bad Request:  Email <span class="s1">&#39;foo@bar.com&#39;</span> already exists
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s it! We have completed the first use case of <strong>gomidway</strong>!!</p>

<h2 id="use-case-2---user-login">Use Case #2 - User Login</h2>

<p>The next use case that we are going to implement is user login. The requirement for login has been defined as</p>

<ul>
  <li>
    <p>if the user logs in with a different email address or with a different password, we need to show him appropriate errors</p>
  </li>
  <li>
    <p>if the email and the password matches, let the user know that he has logged in</p>
  </li>
</ul>

<h3 id="defining-the-login-handler">Defining the Login handler</h3>

<p>As we did for the signup, let’s start our implementation from defining the handler for login</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// user/login/handler.go</span>
</span><span class="line"><span class="kd">type</span> <span class="nx">Request</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">Email</span>    <span class="kt">string</span>
</span><span class="line">  <span class="nx">Password</span> <span class="kt">string</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Response</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">User</span> <span class="o">*</span><span class="nx">user</span><span class="p">.</span><span class="nx">User</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">Login</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To implement login, we need some help from the persistence. In other words, we have to find whether the user with the given email address exists in our application.</p>

<h3 id="adding-user-findbyemail-function">Adding User FindByEmail function</h3>

<p>Let’s create a new file <code>find.go</code> in the <code>user</code> folder and define the <code>FindByEmail</code> function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// user/find.go</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">FindByEmail</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">email</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="kd">var</span> <span class="nx">user</span> <span class="nx">User</span>
</span><span class="line">  <span class="nx">res</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">User</span><span class="p">{</span><span class="nx">Email</span><span class="p">:</span> <span class="nx">email</span><span class="p">})</span>
</span><span class="line">  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">user</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Error</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s great. But how are we going to find if the email didn’t exist in the first place?</p>

<p>Thankfully, We don’t need to anything extra other than calling the <a href="https://godoc.org/github.com/jinzhu/gorm#DB.RecordNotFound">RecordNotFound</a> to figure this out!</p>

<p>Let’s define a custom error type <code>EmailNotExistsError</code> and return it if no records found.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// user/find.go</span>
</span><span class="line"><span class="kd">type</span> <span class="nx">EmailNotExistsError</span> <span class="kd">struct</span><span class="p">{}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">EmailNotExistsError</span><span class="p">)</span> <span class="nx">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="s">&quot;email not exists&quot;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">FindByEmail</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">email</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="kd">var</span> <span class="nx">user</span> <span class="nx">User</span>
</span><span class="line">  <span class="nx">res</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">User</span><span class="p">{</span><span class="nx">Email</span><span class="p">:</span> <span class="nx">email</span><span class="p">})</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">RecordNotFound</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">EmailNotExistsError</span><span class="p">{}</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">user</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now its time to turn our attention to Login handler to wire up the login functionality. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// user/login/handler.go</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">Login</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">user</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">FindByEmail</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Email</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The next scenario that we need to handle is, compare the password in the request with the password hash. As we need to let the user know in case of password mismatch, let’s create a <code>PasswordMismatchError</code> in the login handler and return it during the mismatch.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// user/login/handler.go</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kd">type</span> <span class="nx">PasswordMismatchError</span> <span class="kd">struct</span><span class="p">{}</span>
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">PasswordMismatchError</span><span class="p">)</span> <span class="nx">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="s">&quot;password didn&#39;t match&quot;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">Login</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="nx">err</span> <span class="p">=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">CompareHashAndPassword</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">PasswordHash</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">))</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">PasswordMismatchError</span><span class="p">{}</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Response</span><span class="p">{</span><span class="nx">User</span><span class="p">:</span> <span class="nx">user</span><span class="p">},</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With this, we are done with login handler implementation. Let’s test drive it!</p>

<h3 id="test-driving-user-login">Test Driving User Login</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// main.go</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="nx">loginUser</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">loginUser</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">login</span><span class="p">.</span><span class="nx">Login</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">login</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span>
</span><span class="line">    <span class="nx">Email</span><span class="p">:</span> <span class="s">&quot;foo@bar.com&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="nx">Password</span><span class="p">:</span> <span class="s">&quot;foobar&quot;</span><span class="p">})</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">switch</span> <span class="nx">err</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="k">case</span> <span class="o">*</span><span class="nx">user</span><span class="p">.</span><span class="nx">EmailNotExistsError</span><span class="p">:</span>
</span><span class="line">      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Bad Request: &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span class="line">      <span class="k">return</span>
</span><span class="line">    <span class="k">case</span> <span class="o">*</span><span class="nx">login</span><span class="p">.</span><span class="nx">PasswordMismatchError</span><span class="p">:</span>
</span><span class="line">      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Bad Request: &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span class="line">      <span class="k">return</span>
</span><span class="line">    <span class="k">default</span><span class="p">:</span>
</span><span class="line">      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Internal Server Error: &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
</span><span class="line">      <span class="k">return</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Ok: User &#39;%s&#39; logged in&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">Username</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="summary">Summary</h2>

<p>In this blog post, we have seen how we can use the create and find function in gorm along with the use case driven approach. The source code can be found in <a href="https://github.com/tamizhvendan/gomidway/tree/part-1">my GitHub repository</a>. </p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2017-07-03T19:44:33+05:30" data-updated="true" itemprop="datePublished">Jul 3<sup>rd</sup>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/golang/'>golang</a>, <a class='category' href='/blog/categories/gorm/'>gorm</a>


</div>
		
			<span class="comments"><a href="/blog/2017/07/03/leveraging-interfaces-in-golang-part-2/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2017/07/03/leveraging-interfaces-in-golang-part-2/" itemprop="url">Leveraging Interfaces in Golang - Part 2</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In my previous <a href="/blog/2017/06/24/leveraging-interfaces-in-golang-part-1/">blog post</a>, we have seen how interfaces in golang can help us to come up with a cleaner design. In this blog post, we are going to see an another interesting use case of applying golang’s interfaces in creating adapters!</p>

<h2 id="some-context">Some Context</h2>

<p>In my current project, we are using <a href="https://www.postgresql.org/">Postgres</a> for persisting the application data. To make our life easier, we are using <a href="http://jinzhu.me/gorm/">gorm</a> to talk to Postgres from our golang code. Things were going well and we started rolling out new features without any challenges. One beautiful day, we came across an interesting requirement which gave us a run for the money.   </p>

<p>The requirement is to store and retrieve an array of strings from Postgres!</p>

<p><img class="center" src="/images/igo2/slice-to-array-conversion.png" /></p>

<p>It sounds simple on paper but while implementing it we found that it is not straightforward. Let me explain what the challenge was and how we solved it through a <strong>Task list</strong> example</p>

<h2 id="the-database-side">The Database Side</h2>

<p>Let’s assume that we have database <code>mytasks</code> with a table <code>tasks</code> to keep track of the tasks. </p>

<p>The <code>tasks</code> table has the following schema </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">tasks</span> <span class="p">(</span>
</span><span class="line">  <span class="n">id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
</span><span class="line">  <span class="n">name</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class="line">  <span class="n">is_completed</span> <span class="n">BOOL</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class="line">  <span class="n">tags</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)[]</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>An important thing to note over here is that each <code>task</code> has an array of <code>tags</code> of type <code>varchar(10)</code>.</p>

<h2 id="the-golang-side">The Golang Side</h2>

<p>The equivalent <a href="http://jinzhu.me/gorm/models.html#model-definition">model definition</a> of the <code>tasks</code> table would look like the following in <em>Golang</em></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">Task</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">Id</span>          <span class="kt">uint</span>
</span><span class="line">  <span class="nx">Name</span>        <span class="kt">string</span>
</span><span class="line">  <span class="nx">IsCompleted</span> <span class="kt">bool</span>
</span><span class="line">  <span class="nx">Tags</span>        <span class="p">[]</span><span class="kt">string</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="the-challenge">The Challenge</h2>

<p>Everything is set to test drive the task creation. </p>

<p>Let’s see what happens when we try to create a new task!</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">  <span class="s">&quot;fmt&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="s">&quot;github.com/jinzhu/gorm&quot;</span>
</span><span class="line">  <span class="nx">_</span> <span class="s">&quot;github.com/jinzhu/gorm/dialects/postgres&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">panicOnError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">CreateTask</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">tags</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">uint</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">newTask</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Task</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">Tags</span><span class="p">:</span> <span class="nx">tags</span><span class="p">}</span>
</span><span class="line">  <span class="nx">result</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">newTask</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Error</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">newTask</span><span class="p">.</span><span class="nx">Id</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;postgres&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="s">`host=localhost </span>
</span><span class="line"><span class="s">      user=postgres password=test</span>
</span><span class="line"><span class="s">      dbname=mytasks </span>
</span><span class="line"><span class="s">      sslmode=disable`</span><span class="p">)</span>
</span><span class="line">  <span class="nx">panicOnError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">  <span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">  <span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">CreateTask</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="s">&quot;test 123&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;personal&quot;</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">})</span>
</span><span class="line">  <span class="nx">panicOnError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Task %d has been created\n&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>When we run this program, it will panic with the following error message </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">panic: sql: converting Exec argument <span class="nv">$3</span> <span class="nb">type</span>: unsupported <span class="nb">type</span> <span class="o">[]</span>string, a slice of string
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As the error message says, the SQL driver doesn’t support <code>[]string</code>. From <a href="https://golang.org/pkg/database/sql/driver/#Value">the documentation</a>, we can found that the <em>SQL drivers</em> only support the following values</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">int64
</span><span class="line">float64
</span><span class="line">bool
</span><span class="line"><span class="o">[]</span>byte
</span><span class="line">string
</span><span class="line">time.Time
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>So, we can’t persist the <code>task</code> with the <code>tags</code> using this approach. </p>

<h2 id="golangs-interface-in-action">Golang’s interface in Action</h2>

<p>As a first step towards the solution, let’s see how the plain SQL <code>insert</code> query provides the value for arrays in <em>Postgres</em></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">tasks</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">is_completed</span><span class="p">,</span><span class="n">tags</span><span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;buy milk&#39;</span><span class="p">,</span><span class="k">false</span><span class="p">,</span><span class="s1">&#39;{&quot;home&quot;,&quot;delegate&quot;}&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The clue here is the plain SQL expects the value for array as a string with the following format</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="s1">&#39;{ val1 delim val2 delim ... }&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<blockquote>
  <p>double quotes around element values if they are empty strings, contain curly braces, delimiter characters, double quotes, backslashes, or white space, or match the word NULL. Double quotes and backslashes embedded in element values will be backslash-escaped. - <a href="https://www.postgresql.org/docs/9.6/static/arrays.html">Postgres Documentation</a></p>
</blockquote>

<p>That’s great! All we need to do is convert the <code>[]string</code> to <code>string</code> which follows the format specified above. </p>

<p>An easier approach would be changing the <code>Tags</code> field of the <code>Task</code> <strong>struct</strong> to <code>string</code> and do this conversion somewhere in the application code before persisting the task. </p>

<p>But it’s not a cleaner approach as the resulting code is not semantically correct!</p>

<p>Golang provides a neat solution to this problem through the <a href="https://golang.org/pkg/database/sql/driver/#Valuer">Valuer</a> interface</p>

<blockquote>
  <p>Types implementing Valuer interface are able to convert themselves to a driver Value.</p>
</blockquote>

<p>That is we need to have a type representing the <code>[]string</code> type and implement this interface to do the type conversion. </p>

<p>Like we did in the <a href="/blog/2017/06/24/leveraging-interfaces-in-golang-part-1/">part-1</a> of this series, let’s make use of <a href="https://golang.org/ref/spec#Type_identity">named types</a> by creating a new type called <code>StringSlice</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">StringSlice</span> <span class="p">[]</span><span class="kt">string</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then we need to do the type conversion in the <code>Value</code> method</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">stringSlice</span> <span class="nx">StringSlice</span><span class="p">)</span> <span class="nx">Value</span><span class="p">()</span> <span class="p">(</span><span class="nx">driver</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="kd">var</span> <span class="nx">quotedStrings</span> <span class="p">[]</span><span class="kt">string</span>
</span><span class="line">  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">str</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">stringSlice</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">quotedStrings</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">quotedStrings</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Quote</span><span class="p">(</span><span class="nx">str</span><span class="p">))</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="nx">value</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;{ %s }&quot;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">quotedStrings</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">value</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Great! </p>

<p>With this new type in place, we can change the datatype of <code>Tags</code> field from <code>[]string</code> to <code>StringSlice</code> in the <code>Task</code> struct. </p>

<p>If we rerun the program, it will work as expected!!</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">Task 1 has been created
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="filter-by-tag">Filter by tag</h2>

<p>Let’s move to the query side of the problem. </p>

<p>We would like to get a list of tasks associated with a particular tag. </p>

<p>It’d be a straightforward function that uses the <a href="http://jinzhu.me/gorm/crud.html#query">find method</a> in gorm.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">GetTasksByTag</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">tag</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="nx">Task</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">tasks</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">Task</span><span class="p">{}</span>
</span><span class="line">  <span class="nx">result</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">tasks</span><span class="p">,</span> <span class="s">&quot;? = any(tags)&quot;</span><span class="p">,</span> <span class="nx">tag</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Error</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">tasks</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then we need to call it from our main function </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line">  <span class="nx">tasks</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">GetTasksByTag</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="s">&quot;project-x&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="nx">panicOnError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class="line">  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">tasks</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Unfortunately, if we run the program, it will panic with the following error message</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">panic: sql: Scan error on column index 3: unsupported Scan, storing driver.Value <span class="nb">type</span> <span class="o">[]</span>uint8 into
</span><span class="line"><span class="nb">type</span> *main.StringSlice<span class="p">;</span> sql: Scan error on column index 3: unsupported Scan,
</span><span class="line">storing driver.Value <span class="nb">type</span> <span class="o">[]</span>uint8 into <span class="nb">type</span> *main.StringSlice
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As the error message says, the SQL driver unable to scan (unmarshal) the data type byte slice (<code>[]uint8</code>) into our custom type <code>StringSlice</code>. </p>

<p>To fix this, we need to provide a mechanism to convert <code>[]uint8</code> to <code>StringSlice</code> which in turn will be used by the SQL driver while scanning. </p>

<p>Like the <code>Valuer</code> interface, <em>Golang</em> provides <a href="https://golang.org/pkg/database/sql/#Scanner">Scanner</a> interface to do the data type conversion while scanning. </p>

<p>The signature of the <em>Scanner</em> interface returns an error and not the converted value. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">Scanner</span> <span class="kd">interface</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">Scan</span><span class="p">(</span><span class="nx">src</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>So, it implies the implementor of this interface should have a pointer receiver (<code>*StringSlice</code>) which will mutate its value upon successful conversion.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">stringSlice</span> <span class="o">*</span><span class="nx">StringSlice</span><span class="p">)</span> <span class="nx">Scan</span><span class="p">(</span><span class="nx">src</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">  <span class="c1">// ...</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In the implementation of this interface, we just need to convert the byte slice into a string slice by converting it to a <code>string</code> (Postgres representation of array value) first, and then to <code>StringSlice</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="p">[]</span><span class="kt">uint8</span> <span class="o">--</span><span class="p">&gt;</span> <span class="p">{</span><span class="nx">home</span><span class="p">,</span><span class="nx">delegate</span><span class="p">}</span> <span class="o">--</span><span class="p">&gt;</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;home&quot;</span><span class="p">,</span> <span class="s">&quot;delegate&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>After successful conversion, we need to assign the converted value to the receiver (<code>*stringSlice</code>)</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">stringSlice</span> <span class="o">*</span><span class="nx">StringSlice</span><span class="p">)</span> <span class="nx">Scan</span><span class="p">(</span><span class="nx">src</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">val</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">src</span><span class="p">.([]</span><span class="kt">byte</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;unable to scan&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">  <span class="nx">value</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">TrimPrefix</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">val</span><span class="p">),</span> <span class="s">&quot;{&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="nx">value</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSuffix</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="s">&quot;}&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">  <span class="o">*</span><span class="nx">stringSlice</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">return</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s it. If we run the program now, we can see the output as expected. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="o">[{</span>2 schedule meeting with the team <span class="nb">false</span> <span class="o">[</span>project-x<span class="o">]}</span>
</span><span class="line">  <span class="o">{</span>3 prepare <span class="k">for </span>client demo <span class="nb">false</span> <span class="o">[</span>slides project-x<span class="o">]}]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="summary">Summary</h2>

<p>In this blog post, we have seen how we can make use of <code>Valuer</code> and <code>Scanner</code> interfaces in golang to marshal and unmarshal our custom data type from the database. </p>

<p>The source code can be found in <a href="https://github.com/tamizhvendan/igo2">my GitHub repository</a></p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
        <a href="2" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2017

    Tamizhvendan S


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'tamizhvendan-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>






</body>
</html>
