
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>P3 Programmer</title>
	<meta name="author" content="Tamizhvendan S">

	
	<meta name="description" content="Mar 28th, 2015 asp.net mvc, fsharp Comments Step-9 Adding Checkout This is step 9 of my blog series on Web Application Development in Fsharp using &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="http://feeds.feedburner.com/tamizhvendan-blog" rel="alternate" title="P3 Programmer" type="application/atom+xml">
	
	<link rel="canonical" href="http://blog.tamizhvendan.in/">
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link href="/favicon.png" rel="shortcut icon">
  <link href='/stylesheets/fonts.css' rel='stylesheet' type='text/css'>
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">	
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <style type="text/css">
  p, li, #tag-cloud {
    font-family: "Archer A","Archer B","georgia","serif";
    line-height: 1.4em;
    font-size: 1.354rem;
    font-weight: 500;
    color: #222222;
    margin: 0;
    font-style: normal;
  }  
  h1, h2, h3 {
    font-family: 'Archer A','Archer B',georgia,serif;
    font-weight: 800 !important;
    font-style: normal;
    font-size: 2.6154rem !important;
    padding: 1.6154rem 0;
    color: #286c8d;
  }
  h1 {
    font-size: 2.6154rem !important;    
  }
  h2 {
    font-size: 1.8rem !important;
  }
  h3 {
    font-size: 1.6154rem !important;
  }
  h4 {
    font-size: 1.5rem !important;
  }
  div.mid-col {
    background-color: #f8f8f8;
  }
  pre code {
    font-family: Consolas,Menlo,Monaco,"Andale Mono","lucida console","Courier New",monospace;
    font-size: 1em;
    line-height: 1.8;
    display: block;
    background: #fff;
    color: #000;
    border: solid 1px #eee;
    box-shadow: 1px 1px 2px #aaa;
    margin: 10px 0 8px 0;
    overflow-x: auto;
    word-wrap: break-word;
  }
  td.gutter {
    display: none;
  }
  td.code {
    padding-left: 0px;
  }
  a:hover {
    color: #428bca !important;    
  }
  </style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-43004255-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("tamizh88@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="http://about.me/tamizhvendan">About</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <li><a href="/open-source-contributions">Contributions</a></li>
</ul>
<a href="http://www.codeproject.com" rel="tag" style="display:none">CodeProject</a>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:tamizh88@gmail.com" title="Email">Email</a>
		
		
		
		
			<a class="twitter" href="http://twitter.com/tamizhvendan" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/tamizhvendan" title="GitHub">GitHub</a>
		
		
			<a class="coderwall" href="https://coderwall.com/tamizhvendan" title="Coderwall">Coderwall</a>
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="http://feeds.feedburner.com/tamizhvendan-blog" title="RSS">RSS</a>
		
	</div>
<nav id="tag-cloud">
	<section>
    <span id="tag-cloud"><a href='/blog/categories/asp-dot-net' style='font-size: 103.75%'>asp.net</a> <a href='/blog/categories/asp-dot-net-mvc' style='font-size: 160.0%'>asp.net mvc</a> <a href='/blog/categories/asp-dot-net-identity' style='font-size: 103.75%'>asp.net-identity</a> <a href='/blog/categories/c-number' style='font-size: 115.0%'>c#</a> <a href='/blog/categories/craftsmanship' style='font-size: 115.0%'>craftsmanship</a> <a href='/blog/categories/data-access' style='font-size: 111.25%'>data access</a> <a href='/blog/categories/devops' style='font-size: 103.75%'>devops</a> <a href='/blog/categories/dsl' style='font-size: 103.75%'>dsl</a> <a href='/blog/categories/entity-framework' style='font-size: 118.75%'>entity framework</a> <a href='/blog/categories/fake' style='font-size: 103.75%'>fake</a> <a href='/blog/categories/fparsec' style='font-size: 103.75%'>fparsec</a> <a href='/blog/categories/fsharp' style='font-size: 145.0%'>fsharp</a> <a href='/blog/categories/functional-programming' style='font-size: 122.5%'>functional-programming</a> <a href='/blog/categories/goals' style='font-size: 103.75%'>goals</a> <a href='/blog/categories/javascript' style='font-size: 111.25%'>javascript</a> <a href='/blog/categories/jquery' style='font-size: 107.5%'>jquery</a> <a href='/blog/categories/node-dot-js' style='font-size: 107.5%'>node.js</a> <a href='/blog/categories/others' style='font-size: 103.75%'>others</a> <a href='/blog/categories/owin' style='font-size: 103.75%'>owin</a> <a href='/blog/categories/programming' style='font-size: 122.5%'>programming</a> <a href='/blog/categories/rop' style='font-size: 103.75%'>rop</a> <a href='/blog/categories/rx' style='font-size: 103.75%'>rx</a> <a href='/blog/categories/signalr' style='font-size: 103.75%'>signalr</a> <a href='/blog/categories/unit-testing' style='font-size: 118.75%'>unit testing</a> <a href='/blog/categories/web-api' style='font-size: 111.25%'>web-api</a> </span>
</section>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-03-28T13:07:20+05:30" data-updated="true" itemprop="datePublished">Mar 28<sup>th</sup>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/asp-dot-net-mvc/'>asp.net mvc</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>


</div>
		
			<span class="comments"><a href="/blog/2015/03/28/step-9-adding-checkout/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/03/28/step-9-adding-checkout/" itemprop="url">Step-9 Adding Checkout</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<blockquote>
  <p>This is step 9 of my blog series on <a href="/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="/blog/2015/03/20/step-8-adding-shopping-cart/">last blog post</a> we have added the shopping cart feature to our phonecat application and in this blog post we are going to implement the checkout feature.</p>

<p>Implementing the checkout feature involves two steps.<br />
  1. Adding a View Cart Page<br />
  2. Processing the Checkout and creating an order</p>

<h3 id="adding-a-view-cart-page">Adding a View Cart Page</h3>

<p><img class="border" src="/images/fsharp_phonecat/step_9/view-cart.png" /></p>

<p>As we have done in the previous posts, let’s begin by extending our shopping cart domain. The first step is to add a function to retrieve the items in the shopping cart. </p>

<p>Open <code>ShoppingCart</code> module in the <strong>Domain</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getItems</span> <span class="n">cart</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">cart</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Empty</span> <span class="o">-&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Active</span> <span class="n">items</span> <span class="o">-&gt;</span> <span class="n">items</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">toSeq</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The above function retrieves the phone ids present in the cart. In order to show a detailed checkout page, we need to get the associated phone details of these phone ids. Right now we don’t have this capability in our app so let’s add them.</p>

<p>Open <code>Phones</code> module in the <strong>Domain</strong> project and add the below functions</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">contains</span> <span class="n">x</span> <span class="o">=</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">exists</span> <span class="o">((=)</span> <span class="n">x</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">getPhonesByIds</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="n">phoneIds</span> <span class="o">=</span>
</span><span class="line">  <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">contains</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="n">phoneIds</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>contains</code> function is a utility function which checks whether the given element is present in a <code>seq</code> or not and the <code>getPhonesByIds</code> function filters phones in the system by the incoming phone ids and returns the requested ones.</p>

<p>Now we have all the bare bones and the next step is defining a controller to serve the View Cart Page.</p>

<p>Add a new Source file <code>CheckoutController</code> in the <strong>Web</strong> project under <em>Controllers</em> directory and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CheckoutController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">      <span class="n">getPhones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">      <span class="n">cart</span> <span class="o">:</span> <span class="n">Cart</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span> <span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">ViewCart</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="n">cart</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">getItems</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">getPhones</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="n">this</span><span class="o">.</span><span class="n">View</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>ViewCart</code> action method uses the two functions that we have defined before and renders the <code>ViewCart</code> view. Add a new razor view with the name <code>ViewCart</code> in the <em>Views\Checkout</em> Directory and update it <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/9/Web/Views/Checkout/ViewCart.cshtml#L1-L30">as described here</a>. </p>

<p>The final step in rendering this view is gluing the components together in the <code>CheckoutController</code> controller instance creation. </p>

<p>To get the cart associated with the given session id we have added <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/8/Web/Infrastructure.fs#L41-L45">a piece of logic</a> in the last step which checks the presence of <code>Cart</code> for the given anonymous id in the <code>CartStorage</code> and creates the cart if it doesn’t contain. Since we need the same logic here, let’s move this logic to a function <code>getOrCreate</code> in the <code>CartStorage</code> module and reuse it in both the places</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getOrCreate</span> <span class="n">anonymousId</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">get</span> <span class="n">anonymousId</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Some</span> <span class="n">cart</span> <span class="o">-&gt;</span> <span class="n">cart</span>
</span><span class="line">  <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="n">create</span> <span class="n">anonymousId</span> <span class="nn">ShoppingCart</span><span class="p">.</span><span class="n">Empty</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Then open <code>MvcInfrastructure</code> module in the <strong>Web</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">    <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="c1">// ... existing code ...</span>
</span><span class="line">    <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">CheckoutController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">anonymousID</span> <span class="o">=</span> <span class="n">requestContext</span><span class="o">.</span><span class="n">HttpContext</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">AnonymousID</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">shoppingCart</span> <span class="o">=</span> <span class="nn">CartStorage</span><span class="p">.</span><span class="n">getOrCreate</span> <span class="n">anonymousID</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">getPhonesByIds</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span> <span class="o">|&gt;</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getPhonesByIds</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">checkoutController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CheckoutController</span><span class="o">(</span><span class="n">getPhonesByIds</span><span class="o">,</span> <span class="n">shoppingCart</span><span class="o">)</span>
</span><span class="line">      <span class="n">checkoutController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">    <span class="c1">// ... existing code ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The composition of <code>CheckoutController</code> is similar to that of other controllers in the application. We get the cart associated with the given anonymous id and then create a partial applied function of <code>Phones.getPhonesByIds</code> by passing the first argument (phones in the app) alone.</p>

<p>That’s it. The Cart View is up and running!</p>

<h3 id="processing-the-checkout">Processing the Checkout</h3>

<p>As mentioned in the beginning, the next step after displaying the shopping cart page is processing the checkout and creating an order. </p>

<p>Let’s begin by defining the domain for Orders.</p>

<p>Create a source file with the name <code>Orders</code> in the <strong>Domain</strong> project and add the following types</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Orders</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">OrderRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">UserId</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ProductIds</span> <span class="o">:</span> <span class="n">ProductId</span> <span class="n">seq</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">OrderConfirmed</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">OrderId</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">UserId</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ProductIds</span> <span class="o">:</span> <span class="n">ProductId</span> <span class="n">seq</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>OrderRequest</code> type represents the order being placed by the user and the <code>OrderConfirmed</code> type represents the successful order creation.</p>

<p>To Keep things simple, we are just going to see the order confirmation and we are intentionally leaving out error handling and validation. We can easily <a href="/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/">add them as we did</a>  it in the user registration step and I leave it you as an exercise.</p>

<p>The next step is storing the incoming order. </p>

<p>Create a source file with the name <code>OrderStorage</code> in the <strong>DataAccess</strong> project and add the following function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">OrderStorage</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">placeOrder</span> <span class="o">(</span><span class="n">orderRequest</span> <span class="o">:</span> <span class="n">OrderRequest</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">orderId</span> <span class="o">=</span> <span class="nn">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="bp">()</span><span class="o">.</span><span class="n">ToString</span><span class="bp">()</span>
</span><span class="line">    <span class="o">{</span><span class="n">OrderId</span> <span class="o">=</span> <span class="n">orderId</span><span class="o">;</span> <span class="n">UserId</span> <span class="o">=</span> <span class="n">orderRequest</span><span class="o">.</span><span class="n">UserId</span><span class="o">;</span> <span class="n">ProductIds</span> <span class="o">=</span> <span class="n">orderRequest</span><span class="o">.</span><span class="n">ProductIds</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here we are just faked the implementation of order storage by generating a new <code>Guid</code> and returning it as Order Id</p>

<p>Now it’s time for adding a <code>OrderController</code> in the <strong>Web</strong> project to handle the checkout and creating the order using the components defined above.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">OrderController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">cart</span> <span class="o">:</span> <span class="n">Cart</span><span class="o">,</span>
</span><span class="line">    <span class="n">placeOrder</span> <span class="o">:</span> <span class="n">OrderRequest</span> <span class="o">-&gt;</span> <span class="n">OrderConfirmed</span><span class="o">,</span>
</span><span class="line">    <span class="n">updateCart</span> <span class="o">:</span> <span class="n">Cart</span> <span class="o">-&gt;</span> <span class="n">Cart</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span> <span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Authorize</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Checkout</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">identity</span> <span class="o">=</span> <span class="k">base</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">Identity</span> <span class="o">:?&gt;</span> <span class="n">ClaimsIdentity</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userId</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">FindFirst</span><span class="o">(</span><span class="nn">ClaimTypes</span><span class="p">.</span><span class="n">Name</span><span class="o">).</span><span class="n">Value</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">orderConfirmed</span> <span class="o">=</span> <span class="n">placeOrder</span> <span class="o">{</span> <span class="n">UserId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span> <span class="n">ProductIds</span> <span class="o">=</span> <span class="n">getItems</span> <span class="n">cart</span><span class="o">}</span>
</span><span class="line">    <span class="n">updateCart</span> <span class="nn">Cart</span><span class="p">.</span><span class="n">Empty</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">orderConfirmed</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The checkout method is straightforward. We get the <code>UserId</code> from the <code>User.Identity</code> property and place the order using it. Upon successful order confirmation, we are clearing the shopping cart and rendering the <code>Checkout</code> view.</p>

<p><img class="border" src="/images/fsharp_phonecat/step_9/order-confirmation.png" /></p>

<p>The important thing to notice here the <code>Authorize</code> attribute. Just like any other e-commerce portal, we are not allowing anonymous check out here. The presence of <a href="https://msdn.microsoft.com/en-us/library/system.web.mvc.authorizeattribute%28v=vs.118%29.aspx">this authorize attribute</a> ensures that only logged in users are checking out and in case if they are not logged in it would redirect the user to the login page.</p>

<p>The last step is updating the composition root to create the <code>OrderController</code> instance.</p>

<p>Open <code>MvcInfrasturcture</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">    <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="c1">// ... existing code ...</span>
</span><span class="line">    <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">OrderController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">anonymousID</span> <span class="o">=</span> <span class="n">requestContext</span><span class="o">.</span><span class="n">HttpContext</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">AnonymousID</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">shoppingCart</span> <span class="o">=</span> <span class="nn">CartStorage</span><span class="p">.</span><span class="n">getOrCreate</span> <span class="n">anonymousID</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">updateCart</span> <span class="o">=</span> <span class="nn">CartStorage</span><span class="p">.</span><span class="n">update</span> <span class="n">anonymousID</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">orderController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderController</span><span class="o">(</span><span class="n">shoppingCart</span><span class="o">,</span> <span class="nn">OrderStorage</span><span class="p">.</span><span class="n">placeOrder</span><span class="o">,</span> <span class="n">updateCart</span><span class="o">)</span>
</span><span class="line">      <span class="n">orderController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">    <span class="c1">// ... existing code ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We are done!</p>

<h3 id="summary">Summary</h3>

<p>We have come a long way from just setting up the visual studio project to a complete prototype of an e-commerce site and I hope you would have enjoyed this series of blog post. In the next blog post we are going to refactor the <code>CompositionRoot</code>which is getting clumsy with a series of <code>if..else if..</code> expressions using Active Patterns and I will be wrapping this series by an another post which will be reflecting back on what I have learned by writing this blog series.</p>

<p>You can find the source code of this step in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/9">fsharp-phonecat github repository</a></p>

<p>Thanks for reading!</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-03-20T11:49:35+05:30" data-updated="true" itemprop="datePublished">Mar 20<sup>th</sup>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/fsharp/'>fsharp</a>, <a class='category' href='/blog/categories/web-api/'>web-api</a>


</div>
		
			<span class="comments"><a href="/blog/2015/03/20/step-8-adding-shopping-cart/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/03/20/step-8-adding-shopping-cart/" itemprop="url">Step-8 Adding Shopping Cart</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<blockquote>
  <p>This is step 8 of my blog series on <a href="/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/">last blog post</a> we have seen how to do validation and error handling in fsharp and in this blog post we are going to add shopping cart feature to the phone-cat application that we are developing in this blog series. To keep this blog post simple, we are going to see only adding an item to shopping cart. Remvoing an item from shopping cart is a straightforward implementation and I leave it to you as an exercise</p>

<p><img src="/images/fsharp_phonecat/step_8/cart_intro.png" /></p>

<h3 id="the-shopping-cart-domain">The Shopping Cart Domain</h3>

<p>Let’s start with defining the domain model for handling shopping cart. Create a source file <code>ShoppingCart</code> in the <strong>Domain</strong> project and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">ShoppingCart</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">ProductId</span> <span class="o">=</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">Cart</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Empty</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Active</span> <span class="k">of</span> <span class="n">ProductId</span> <span class="n">List</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">addItem</span> <span class="n">cart</span> <span class="n">productId</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">cart</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Empty</span> <span class="o">-&gt;</span> <span class="n">Active</span> <span class="o">[</span><span class="n">productId</span><span class="o">]</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Active</span> <span class="n">items</span> <span class="o">-&gt;</span> <span class="n">Active</span> <span class="o">(</span><span class="n">productId</span> <span class="o">::</span> <span class="n">items</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>ProductId</code> is an alias of <code>string</code> type represents the id of the phone.</p>

<p>The <code>Cart</code> is a <code>Sum</code> type represents the two possible states of Shopping Cart. The <code>Cart</code> would be either empty or contain product ids that has been added to the cart.</p>

<p>We have added a function which adds a product id to the cart. It just checks the state of the cart and based on the state it either creates the cart with <code>Active</code> state or appends the product id to the existing list.</p>

<p>Thanks to the strong fsharp type system, we have modeled the domain with less lines of code.</p>

<h3 id="persisting-shopping-cart">Persisting Shopping Cart</h3>

<p>Now we have the domain logic to represent the shopping cart and adding items to it. The next step is persisting the cart. We can persist it anywhere as the domain model is persistent ignorant. To keep things simple, we will be persisting it in-memory. </p>

<p>As we did during the <a href="/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/">recommendation step</a> we will be using a dictionary to store the cart with Asp.Net’s <a href="http://msdn.microsoft.com/en-us/library/system.web.httprequest.anonymousid%28v=vs.110%29.aspx">anonymousId</a> as the key. </p>

<p>Create a source file <code>CartStorage</code> in the <strong>DataAccess</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">CartStorage</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">inMemoryStorage</span> <span class="o">=</span>
</span><span class="line">    <span class="k">new</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="n">Cart</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">create</span> <span class="n">anonymousId</span> <span class="n">cart</span> <span class="o">=</span>
</span><span class="line">    <span class="n">inMemoryStorage</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">cart</span><span class="o">)</span>
</span><span class="line">    <span class="n">cart</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">update</span> <span class="n">anonymousId</span> <span class="n">cart</span> <span class="o">=</span>
</span><span class="line">    <span class="n">inMemoryStorage</span><span class="o">.</span><span class="n">Remove</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="n">create</span> <span class="n">anonymousId</span> <span class="n">cart</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">get</span> <span class="n">anonymousId</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">inMemoryStorage</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">)</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="k">true</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">inMemoryStorage</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The code is very straight forward to understand. It contains typical CRUD operations of a shopping cart using an in-memory dictionary object.</p>

<h3 id="shopping-cart-api">Shopping Cart Api</h3>

<p>It’s time to code the api for the shopping cart. Let’s add a source file <code>ShoppingCartController</code> in the <strong>Web</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/cart&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">ShoppingCartController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">cart</span> <span class="o">:</span> <span class="n">Cart</span><span class="o">,</span>
</span><span class="line">    <span class="n">updateCart</span> <span class="o">:</span> <span class="n">Cart</span> <span class="o">-&gt;</span> <span class="n">Cart</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">ApiController</span> <span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Get</span><span class="bp">()</span> <span class="o">=</span> <span class="n">cart</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;add&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">AddItem</span><span class="o">([&lt;</span><span class="n">FromBody</span><span class="o">&gt;]</span><span class="n">productId</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">addItem</span> <span class="n">cart</span> <span class="n">productId</span> <span class="o">|&gt;</span> <span class="n">updateCart</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>ShoppingCartController</code> has two dependencies.<br />
  1. <code>Cart</code> - Cart associated with the current session<br />
  2. <code>updateCart</code> - a function to update the cart</p>

<p>To keep it simple, I haven’t added error handling or validation here. The action method <code>Get</code> returns the cart and the action method <code>AddItem</code> adds the item to the cart and then update the cart in the storage.</p>

<h3 id="wiring-things-up">Wiring things up</h3>

<p>Now we have all the pieces to add shopping cart to our application and the final step is tying them together. As we did it in other steps we need to do it in the composition root. Open <code>Infrastructure</code> in the <strong>Web</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="c1">// ... Exisitng Code ...</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">interface</span> <span class="n">IHttpControllerActivator</span> <span class="k">with</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">controllerDescriptor</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="c1">// ... Exisiting Code ...</span>
</span><span class="line">      <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">ShoppingCartController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">anonymousID</span> <span class="o">=</span> <span class="nn">HttpContext</span><span class="p">.</span><span class="nn">Current</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="n">AnonymousID</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">shoppingCart</span> <span class="o">=</span>
</span><span class="line">          <span class="k">match</span> <span class="nn">CartStorage</span><span class="p">.</span><span class="n">get</span> <span class="n">anonymousID</span> <span class="k">with</span>
</span><span class="line">          <span class="o">|</span> <span class="n">Some</span> <span class="n">cart</span> <span class="o">-&gt;</span> <span class="n">cart</span>
</span><span class="line">          <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="nn">CartStorage</span><span class="p">.</span><span class="n">create</span> <span class="n">anonymousID</span> <span class="nn">ShoppingCart</span><span class="p">.</span><span class="n">Empty</span>
</span><span class="line">
</span><span class="line">        <span class="k">let</span> <span class="nv">shoppingCartController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ShoppingCartController</span><span class="o">(</span><span class="n">shoppingCart</span><span class="o">,</span> <span class="nn">CartStorage</span><span class="p">.</span><span class="n">update</span> <span class="n">anonymousID</span><span class="o">)</span>
</span><span class="line">        <span class="n">shoppingCartController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">      <span class="c1">// ... Existing Code ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here before the creating an instance of <code>ShoppingCartController</code> we retrieve the anonymous id from the incoming request and get the cart associated with the anonymous id from the storage. In case if the cart is not available, we are creating one. For the <code>update</code> function, we pass the partially applied <code>update</code> function of <code>CartStorage</code>.</p>

<p>That’s it!!</p>

<h3 id="the-front-end-code">The front-end code</h3>

<p>In the front end, we just call the <code>ShoppingCartController</code> action methods using plain jQuery ajax methods and update the UI. Since it is out of the scope of this blog post I haven’t covered it here and you can find <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/8/Web/Scripts/site.js">the code here</a>.</p>

<h3 id="summary">Summary</h3>

<p>In this blog post we have seen how to implement shopping cart in a web application written in fsharp. I leave some exercises for you to extend it to use some other storage and also to add validation and error handling. You can find the source code in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/8">github phonecat repository</a>.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-03-02T12:30:33+05:30" data-updated="true" itemprop="datePublished">Mar 2<sup>nd</sup>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/fsharp/'>fsharp</a>, <a class='category' href='/blog/categories/rop/'>rop</a>


</div>
		
			<span class="comments"><a href="/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/" itemprop="url">Step-7 Validation and Error Handling Using ROP</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<blockquote>
  <p>This is step 7 of my blog series on <a href="/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="/blog/2015/02/04/step-6-authentication-using-owin-middleware-and-asp-dot-net-identity/">last blog post</a> we have seen how to register a new user using the Asp.Net Identity Management framework. Validating the incoming data before updating the backend datastore and handling error while saving are typical tasks in a web application. In this blog post we are going to see how to achieve these things in a web application written in fsharp. As mentioned in the last blog post we will be adding validation logic for new user registration using <a href="http://fsharpforfunandprofit.com/rop/">Railway oriented Programming</a> aka <em>ROP</em>.</p>

<h3 id="cleanup">Cleanup</h3>

<p>Before adding the validation,  let’s do some cleanup and make it ready for adding validation. </p>

<p>Create a new source file <code>UserStorage</code> in the <strong>Identity</strong> project and move the user manager creation logic from <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/6/Web/MvcInfrastructure.fs#L15-L20">MvcInfrastructure</a> to here.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">UserStorage</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">createUserManager</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userStore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserStore</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">UserDbContext</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userStore</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userValidator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserValidator</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userManager</span><span class="o">)</span>
</span><span class="line">    <span class="n">userValidator</span><span class="o">.</span><span class="n">AllowOnlyAlphanumericUserNames</span> <span class="o">&lt;-</span> <span class="k">false</span>
</span><span class="line">    <span class="n">userManager</span><span class="o">.</span><span class="n">UserValidator</span> <span class="o">&lt;-</span> <span class="n">userValidator</span>
</span><span class="line">    <span class="n">userManager</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Create a Request record type in <code>Users</code> that represents the request for creating a new user</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CreateUserRequest</span> <span class="o">=</span> <span class="o">{</span><span class="n">Name</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Password</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Email</span> <span class="o">:</span> <span class="kt">string</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then move the user creation logic from Authentication Controller’s <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/6/Web/Controllers/AuthenticationController.fs#L62-L65">Register action method</a> to <code>UserStorage</code> and update it to use <code>CreateUserRequest</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">createUser</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">,</span>
</span><span class="line">                      <span class="n">UserName</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">,</span>
</span><span class="line">                      <span class="n">Email</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">userManager</span><span class="o">.</span><span class="n">Create</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Finally, update the <code>Register</code> action method in <code>AuthenticationController</code> to use the above function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">createUserRequest</span> <span class="o">:</span> <span class="n">CreateUserRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span>
</span><span class="line">    <span class="n">Email</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span><span class="o">;</span>
</span><span class="line">    <span class="n">Password</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Password</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userCreateResult</span> <span class="o">=</span> <span class="nn">Users</span><span class="p">.</span><span class="n">createUser</span> <span class="n">userManager</span> <span class="n">createUserRequest</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">userCreateResult</span><span class="o">.</span><span class="n">Succeeded</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="n">userCreateResult</span><span class="o">.</span><span class="n">Errors</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">iter</span><span class="o">(</span><span class="k">fun</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">err</span><span class="o">))</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">registerViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With this we are wrapping the cleanup work and all set for adding validation.</p>

<h3 id="adding-validation">Adding Validation</h3>

<p>The first step in ROP is defining the “two tracks”. The track <code>Success</code> represents a successful operation (here its validation) and the other track <code>Failure</code> represents the failure while executing an operation. Usually these “two tracks” will be defined using a discriminated union.</p>

<p>Create a source file <code>Rop</code> in the <strong>Identity</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Rop</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">Error</span> <span class="o">=</span> <span class="o">{</span><span class="n">Property</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Message</span> <span class="o">:</span> <span class="kt">string</span><span class="o">}</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">Result</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Success</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">a</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Failure</span> <span class="k">of</span> <span class="n">Error</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Error</code> type provides the metadata associated with the error.</p>

<p>Let’s start writing validation rules from validating Name. Create a source file <code>NameValidation</code> in <strong>Identity</strong> project and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">NameValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameEmptiness</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span>
</span><span class="line">          <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span> <span class="o">&lt;&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">Empty</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Name&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Name is required&quot;</span><span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameLength</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">        <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Name&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Name should not contain more than 50 characters&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Hope these rules are self-explanatory. We are just validating the name for emptiness and length, and based on the result we are returning either the <code>Success</code> track or <code>Failure</code> track.</p>

<p>Next, add validation rules for Password. Similar to Name Validation add a source file with the name <code>PasswordValidation</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">PasswordValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordEmptiness</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span>
</span><span class="line">          <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span> <span class="o">&lt;&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">Empty</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Password&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Password is required&quot;</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordLength</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Password&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Password should not contain more than 10 characters&quot;</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordStrength</span>  <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">specialCharacters</span> <span class="o">=</span> <span class="o">[</span> <span class="s">&quot;*&quot;</span><span class="o">;</span> <span class="s">&quot;&amp;&quot;</span><span class="o">;</span> <span class="s">&quot;%&quot;</span><span class="o">;</span> <span class="s">&quot;$&quot;</span> <span class="o">]</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">hasSpecialCharacters</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="n">String</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="n">specialCharacters</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">exists</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">errorMessage</span> <span class="o">=</span>
</span><span class="line">      <span class="s">&quot;Password should contain atleast one of the special characters &quot;</span>
</span><span class="line">        <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">Join</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">,</span> <span class="n">specialCharacters</span><span class="o">)</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="n">hasSpecialCharacters</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="n">errorMessage</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In addition to the two validation rules that we have seen in <code>NameValidation</code> here we have added one more validation to verify the presence of special characters in the <code>Password</code>.</p>

<p>There is a pattern in all the validation rules that we have seen so far. </p>

<p><img class="center" src="/images/fsharp_phonecat/step_7/validation_pattern.png" width="450" height="450" /></p>

<p>Let’s extract this pattern out of these validation rules and reduce the lines of code!</p>

<p>Create a new source file <code>Validation</code> and add the write this pattern as a function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Validation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validate</span> <span class="n">isValid</span> <span class="n">property</span> <span class="n">message</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="n">isValid</span> <span class="n">createUserRequest</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span><span class="n">Property</span> <span class="o">=</span> <span class="n">property</span><span class="o">;</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">message</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>validate</code> function represents the outer box of the above diagram which takes four inputs</p>

<ul>
  <li>A function to validate the createUserRequest <code>isValid</code> which has the signature
<code>'a -&gt; bool</code> that represents the validation rule</li>
  <li>A string to show which property is invalid in the error <code>property</code></li>
  <li>A string representing the error <code>message</code></li>
  <li>The last is the incoming userCreateRequest <code>createUserRequest</code></li>
</ul>

<p><em>Note: Property and Message parameters are not shown in the diagram just to express the pattern clearly</em></p>

<p>We also need a small utility function to check the emptiness of the string. So add it in <code>Validation</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">isNonEmptyString</span> <span class="n">str</span> <span class="o">=</span> <span class="n">str</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span> <span class="n">str</span> <span class="o">&lt;&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">Empty</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With these functions in place we can refactor the validation rules that we written before.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">NameValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameEmptiness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isNonEmptyString</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Name&quot;</span>
</span><span class="line">      <span class="s">&quot;Name is required&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameLength</span>  <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Name&quot;</span>
</span><span class="line">      <span class="s">&quot;Name should not contain more than 50 characters&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">PasswordValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordEmptiness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isNonEmptyString</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="s">&quot;Password is required&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordLength</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="s">&quot;Password should not contain more than 10 characters&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">hasSpecialCharacters</span> <span class="n">specialCharacters</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="n">String</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">specialCharacters</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">exists</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordStrength</span>  <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">specialCharacters</span> <span class="o">=</span> <span class="o">[</span> <span class="s">&quot;*&quot;</span><span class="o">;</span> <span class="s">&quot;&amp;&quot;</span><span class="o">;</span> <span class="s">&quot;%&quot;</span><span class="o">;</span> <span class="s">&quot;$&quot;</span> <span class="o">]</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">errorMessage</span> <span class="o">=</span>
</span><span class="line">      <span class="s">&quot;Password should contain atleast one of the special characters &quot;</span>
</span><span class="line">        <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">Join</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">,</span> <span class="n">specialCharacters</span><span class="o">)</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="n">hasSpecialCharacters</span> <span class="n">specialCharacters</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="n">errorMessage</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Much cleaner than the previous version, isn’t it?</p>

<p>The final validation is Email validation. It is very similar to the other validations that we have seen so far. One extra validation is verifying the uniqueness of the email id being used to register.</p>

<p>Create a new source file <code>EmailValidation</code> and add the validations</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">EmailValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">isUniqueEmailAddr</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">emailAddr</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">FindByName</span><span class="o">(</span><span class="n">emailAddr</span><span class="o">)</span>
</span><span class="line">    <span class="n">user</span> <span class="o">=</span> <span class="k">null</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">isValidEmailAddress</span> <span class="n">emailAddr</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">emailAddrRegex</span> <span class="o">=</span>
</span><span class="line">      <span class="s">@&quot;\A(?:[a-z0-9!#$%&amp;&#39;*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&amp;&#39;*+/=?^_`{|}~-]+)&quot;</span> <span class="o">+</span>
</span><span class="line">        <span class="s">&quot;*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?</span><span class="err">\</span><span class="s">.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?)</span><span class="err">\</span><span class="s">Z&quot;</span>
</span><span class="line">    <span class="nn">Regex</span><span class="p">.</span><span class="n">IsMatch</span><span class="o">(</span><span class="n">emailAddr</span><span class="o">,</span> <span class="n">emailAddrRegex</span><span class="o">,</span> <span class="nn">RegexOptions</span><span class="p">.</span><span class="n">IgnoreCase</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateEmailEmptiness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isNonEmptyString</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Email&quot;</span>
</span><span class="line">      <span class="s">&quot;Email is required&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateEmailUniqueness</span> <span class="n">isUniqueEmailAddr</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isUniqueEmailAddr</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Email&quot;</span>
</span><span class="line">      <span class="s">&quot;Email address already exists&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateEmailCorrectness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isValidEmailAddress</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Email&quot;</span>
</span><span class="line">      <span class="s">&quot;Email address is invalid&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="putting-all-the-validations-together">Putting all the validations together</h3>

<p>So far we have seen individual property validation rules. It’s time to put all these pieces together and validate the <code>CreateUserRequest</code> as a whole.</p>

<p>Create a source file <code>UserValidation</code> and update it as below</p>

<p><img src="/images/fsharp_phonecat/step_7/uservalidation_match.png" /></p>

<p>Wait.. Wait.. I know how do you feel here.. It’s too much code! Can we do it in a better way? </p>

<h3 id="using-railway-oriented-programming-rop">Using Railway Oriented Programming (ROP)</h3>

<p>Thanks to ROP, we can make the mighty code smaller and more readable. I am going ahead with an assumption that you are aware of ROP. In case if you are not aware of it then watch this <a href="http://vimeo.com/97344498">excellent presentation</a> by <a href="https://twitter.com/ScottWlaschin">Scott Wlaschin</a></p>

<p><img class="center" src="/images/fsharp_phonecat/step_7/bind_function.png" width="350" height="500" /></p>

<p>The crux of ROP is the bind function which composes two functions where the output type of one function is not matching with that of the input. If you want to know more this bind function, do visit this <a href="http://adit.io./posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html">awesome blog post</a> by <a href="https://twitter.com/_egonschiele">Aditya</a>. In this blog post he explains about the bind function under the title <strong>Monads</strong></p>

<p>Let’s start by adding this bind function in the module <code>Rop</code> that we have already created.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">bind</span> <span class="n">f1</span> <span class="n">f2</span> <span class="n">x</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">f1</span> <span class="n">str</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Success</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f2</span> <span class="n">x</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Failure</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">Failure</span> <span class="n">err</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">inline</span> <span class="o">(&gt;&gt;=)</span> <span class="n">f1</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">bind</span> <span class="n">f1</span> <span class="n">f2</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The bind function here calls the function <code>f1</code> with the given input <code>x</code> if it succeeds, then executes the second function <code>f2</code> with <code>x</code>. In case if the execution of <code>f1</code> resulted in failure then it just passes without executing the second function. </p>

<p>The infix operator <code>&gt;&gt;=</code> is an alias of bind function. </p>

<p>With the help of this bind function, we can rewrite the <code>validateCreateUserRequest</code> function in a better way as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">UserValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validateCreateUserRequest</span> <span class="n">userManager</span>  <span class="o">=</span>
</span><span class="line">      <span class="n">validateEmailEmptiness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateEmailCorrectness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateEmailUniqueness</span> <span class="o">(</span><span class="n">isUniqueEmailAddr</span> <span class="n">userManager</span><span class="o">)</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateNameEmptiness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateNameLength</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validatePasswordEmptiness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validatePasswordLength</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validatePasswordStrength</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It’s awesome! Isn’t it? If you are still wondering what’s happening here! Watch the Scott’s presentation one more time.</p>

<h3 id="adding-validation-before-saving">Adding validation before saving</h3>

<p>Now we have the validation infrastructure in place. So, let’s go ahead and add it before creating a new user in the backend. As part of this refactoring we are also going to do error handling of new user creation. </p>

<p>Create a new private function in <code>UserStorage</code> to create a new user with error handling</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">createUser&#39;</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">  <span class="k">try</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">,</span>
</span><span class="line">                        <span class="n">UserName</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">,</span>
</span><span class="line">                        <span class="n">Email</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">identityResult</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Create</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">identityResult</span><span class="o">.</span><span class="n">Succeeded</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">errors</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s">&quot;,&quot;</span> <span class="n">identityResult</span><span class="o">.</span><span class="n">Errors</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="n">errors</span><span class="o">}</span>
</span><span class="line">  <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;An unexpected error happened while creating new user&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Like validation rules defined before this new <code>createUser'</code> function is also outputs “two tracks”, Success if the user creation is successful others it outputs Failure. Because of this change in function signature <br />
(<code>UserManager&lt;User&gt; -&gt; CreateUserRequest -&gt; Result&lt;CreateUserRequest&gt;</code>) we can fit this easily into the bind function.</p>

<p>Modify the existing <code>CreateUser</code> function to use this</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">createUser</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">      <span class="n">validateCreateUserRequest</span> <span class="n">userManager</span> <span class="o">&gt;&gt;=</span> <span class="n">createUser&#39;</span> <span class="n">userManager</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Thanks to <a href="http://fsharpforfunandprofit.com/posts/partial-application/">Partial application</a> we have created new functions on the fly by passing only the partial parameters (<code>UserManager</code> in this case) and make it fit with less code. </p>

<p>Since we have changed the signature of the <code>createUser</code> function from <code>UserManager&lt;User&gt; -&gt; CreateUserRequest -&gt; IdentityResult</code> to <code>UserManager&lt;User&gt; -&gt; CreateUserRequest -&gt; Result&lt;CreateUserRequest&gt;</code> we need to change the <code>Register</code> action method in the <code>AuthenticationController</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">createUserRequest</span> <span class="o">:</span> <span class="n">CreateUserRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span>
</span><span class="line">    <span class="n">Email</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span><span class="o">;</span>
</span><span class="line">    <span class="n">Password</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Password</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">match</span> <span class="nn">UserStorage</span><span class="p">.</span><span class="n">createUser</span> <span class="n">userManager</span> <span class="n">createUserRequest</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Failure</span> <span class="n">error</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">Property</span><span class="o">,</span> <span class="n">error</span><span class="o">.</span><span class="n">Message</span><span class="o">)</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">registerViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Success</span> <span class="n">createUserRequest&#39;</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Find</span><span class="o">(</span><span class="n">createUserRequest&#39;</span><span class="o">.</span><span class="n">Email</span><span class="o">,</span> <span class="n">createUserRequest&#39;</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s it, we are ready to go!</p>

<h3 id="summary">Summary</h3>

<p>In this blog post we have seen how to add validations and error handling in fsharp using ROP. Though it is little hard to get this kind of functional thinking, it offers a great deal of expressiveness and flexibility to your codebase. Just like any other skills if you practice it for quite time you can also master it. You can find the source code associated with this step in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/7">github repository</a></p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
        <a href="2" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2015

    Tamizhvendan S


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'tamizhvendan-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>






</body>
</html>
