
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Step 1 - Phonecat backend using Web Api and TypeProviders - P3 Programmer</title>
	<meta name="author" content="Tamizhvendan S">

	
	<meta name="description" content="Step 1 - Phonecat Backend Using Web Api and TypeProviders This is step 1 of my blog series on Web Application Development in Fsharp using ASP.NET &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="http://feeds.feedburner.com/tamizhvendan-blog" rel="alternate" title="P3 Programmer" type="application/atom+xml">
	
	<link rel="canonical" href="http://blog.tamizhvendan.in/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link href="/favicon.png" rel="shortcut icon">
  <link href='/stylesheets/fonts.css' rel='stylesheet' type='text/css'>
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">	
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <style type="text/css">
  p, li, #tag-cloud {
    font-family: "Archer A","Archer B","georgia","serif";
    line-height: 1.4em;
    font-size: 1.354rem;
    font-weight: 500;
    color: #222222;
    margin: 0;
    font-style: normal;
  }  
  h1, h2, h3 {
    font-family: 'Archer A','Archer B',georgia,serif;
    font-weight: 800 !important;
    font-style: normal;
    font-size: 2.6154rem !important;
    padding: 1.6154rem 0;
    color: #286c8d;
  }
  h1 {
    font-size: 2.6154rem !important;    
  }
  h2 {
    font-size: 1.8rem !important;
  }
  h3 {
    font-size: 1.6154rem !important;
  }
  h4 {
    font-size: 1.5rem !important;
  }
  div.mid-col {
    background-color: #f8f8f8;
  }
  pre code {
    font-family: Consolas,Menlo,Monaco,"Andale Mono","lucida console","Courier New",monospace;
    font-size: 1em;
    line-height: 1.8;
    display: block;
    background: #fff;
    color: #000;
    border: solid 1px #eee;
    box-shadow: 1px 1px 2px #aaa;
    margin: 10px 0 8px 0;
    overflow-x: auto;
    word-wrap: break-word;
  }
  td.gutter {
    display: none;
  }
  td.code {
    padding-left: 0px;
  }
  a:hover {
    color: #428bca !important;    
  }
  </style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-43004255-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("tamizh88@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="http://about.me/tamizhvendan">About</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <li><a href="/open-source-contributions">Contributions</a></li>
</ul>
<a href="http://www.codeproject.com" rel="tag" style="display:none">CodeProject</a>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:tamizh88@gmail.com" title="Email">Email</a>
		
		
		
		
			<a class="twitter" href="http://twitter.com/tamizhvendan" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/tamizhvendan" title="GitHub">GitHub</a>
		
		
			<a class="coderwall" href="https://coderwall.com/tamizhvendan" title="Coderwall">Coderwall</a>
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="http://feeds.feedburner.com/tamizhvendan-blog" title="RSS">RSS</a>
		
	</div>
<nav id="tag-cloud">
	<section>
    <span id="tag-cloud"><a href='/blog/categories/asp-dot-net' style='font-size: 103.15789473684211%'>asp.net</a> <a href='/blog/categories/asp-dot-net-mvc' style='font-size: 150.5263157894737%'>asp.net mvc</a> <a href='/blog/categories/asp-dot-net-identity' style='font-size: 103.15789473684211%'>asp.net-identity</a> <a href='/blog/categories/c-number' style='font-size: 112.63157894736842%'>c#</a> <a href='/blog/categories/craftsmanship' style='font-size: 112.63157894736842%'>craftsmanship</a> <a href='/blog/categories/data-access' style='font-size: 109.47368421052632%'>data access</a> <a href='/blog/categories/devops' style='font-size: 103.15789473684211%'>devops</a> <a href='/blog/categories/dsl' style='font-size: 103.15789473684211%'>dsl</a> <a href='/blog/categories/entity-framework' style='font-size: 115.78947368421052%'>entity framework</a> <a href='/blog/categories/fake' style='font-size: 103.15789473684211%'>fake</a> <a href='/blog/categories/fparsec' style='font-size: 103.15789473684211%'>fparsec</a> <a href='/blog/categories/fsharp' style='font-size: 160.0%'>fsharp</a> <a href='/blog/categories/functional-programming' style='font-size: 122.10526315789474%'>functional-programming</a> <a href='/blog/categories/goals' style='font-size: 103.15789473684211%'>goals</a> <a href='/blog/categories/javascript' style='font-size: 109.47368421052632%'>javascript</a> <a href='/blog/categories/jquery' style='font-size: 106.3157894736842%'>jquery</a> <a href='/blog/categories/node-dot-js' style='font-size: 106.3157894736842%'>node.js</a> <a href='/blog/categories/others' style='font-size: 103.15789473684211%'>others</a> <a href='/blog/categories/owin' style='font-size: 103.15789473684211%'>owin</a> <a href='/blog/categories/programming' style='font-size: 118.94736842105263%'>programming</a> <a href='/blog/categories/rop' style='font-size: 103.15789473684211%'>rop</a> <a href='/blog/categories/rx' style='font-size: 103.15789473684211%'>rx</a> <a href='/blog/categories/signalr' style='font-size: 103.15789473684211%'>signalr</a> <a href='/blog/categories/suave' style='font-size: 109.47368421052632%'>suave</a> <a href='/blog/categories/unit-testing' style='font-size: 115.78947368421052%'>unit testing</a> <a href='/blog/categories/web-api' style='font-size: 109.47368421052632%'>web-api</a> </span>
</section>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Step 1 - Phonecat Backend Using Web Api and TypeProviders</h1>
	<div class="entry-content" itemprop="articleBody"><blockquote>
  <p>This is step 1 of my blog series on <a href="/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="/blog/2014/12/10/step-0-setting-up-the-fsharp-phonecat-solution/">last blog post</a> we have created the basic home page of phone cat with the placeholders and in this post we are going it wire the home page with the backend web apis.</p>

<p><img src="/images/fsharp_phonecat/step_1/home_page.png" /></p>

<p>As the above screenshot indicates we are going to develop three web api endpoints which serve the data to the front-end and we are going to use the existing json data available in <a href="https://github.com/angular/angular-phonecat/tree/master/app/phones">angular-phonecat</a> repository as our backend data store.</p>

<p>Initially I’ve planned to include TDD steps in this post but to keep it simple I am ignoring it. If you are interested in the tests that I’ve written check the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/1">source code.</a></p>

<h3 id="promotions-api">Promotions Api</h3>

<p>Let’s start with the promotions api which serves the data of three recently launched mobile phones. The first step is to create an ApiController called “PromotionsController”. You can create it by right clicking on the “Controllers” directory in the <strong>Web</strong> project and select <strong>Add -&gt; Source file</strong>. In the dialog box, name it as “PromotionsController”</p>

<p>After creating, update the controller with the dependencies as mentioned below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">Web</span><span class="p">.</span><span class="n">Controllers</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/promotions&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">PromotionsController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">getPromotions</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PhoneIndex</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PromotionPhone</span><span class="o">&gt;,</span>
</span><span class="line">    <span class="n">phoneIndexes</span><span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PhoneIndex</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>PromotionsController</code> has two dependencies. </p>

<ul>
  <li>
    <p><code>getPromotions</code> is a function a that takes a sequence of a domain model <code>PhoneIndex</code> and returns the sequence of domain model <code>PromotionPhone</code> which represents the phones that are recently launched.</p>
  </li>
  <li>
    <p><code>phoneIndexes</code> is a sequence of domain model <code>PhoneIndex</code> that represents the phones available in the backend data store.</p>
  </li>
</ul>

<p>These domain models currently not exists, so add them in the domain project as mentioned below</p>

<p>Right click on the domain project and select <strong>Add -&gt; Source file</strong>. In the dialog box, name it as “Promotions”. It creates a fsharp module with the name <code>Promotions</code> and add the <code>PromotionPhone</code> domain model</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Promotions</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">PromotionPhone</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ImageUrl</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Similarly, create an another source file called <code>Production</code> and add the domain model <code>PhoneIndex</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Production</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">PhoneIndex</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">      <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">      <span class="n">ImageUrl</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">      <span class="n">Age</span> <span class="o">:</span> <span class="n">int</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Age</code> property represents the age of the phone since its launch (so lower is younger!). Now the domain models are ready, the next step is to create an end point to expose it. </p>

<p>Let’s add a action method in PromotionsController which does the same</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Get</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="n">getPromotions</span> <span class="n">phoneIndexes</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The scaffolding is ready and the next step is to add the domain method <code>getPromotions</code> which does the actual business logic of giving recently launched phones.</p>

<p>Add the <code>getPromotions</code> function in the <code>Promotions</code> file as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getPromotions</span> <span class="o">(</span><span class="n">phoneIndexes</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PhoneIndex</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="n">phoneIndexes</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">phone</span> <span class="o">-&gt;</span> <span class="n">phone</span><span class="o">.</span><span class="n">Age</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">)</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">phone</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">Id</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Id</span><span class="o">;</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span> <span class="n">ImageUrl</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">ImageUrl</span><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>getPromotions</code> just filters the phones with the age less than 3 and map them to the corresponding <code>PromotionPhone</code> types.</p>

<p>Now its time to get the actual data from the data store. As I have mentioned earlier we will be using <a href="https://github.com/angular/angular-phonecat/tree/master/app/phones">angular-phonecat</a> repository as our data store. To access the data we will be using <a href="http://fsharp.github.io/FSharp.Data/library/JsonProvider.html">JsonTypeProvider</a>.</p>

<p>In the <em>DataAccess</em> project install the nuget package <a href="https://www.nuget.org/packages/FSharp.Data">FSharp.Data</a> and add a source file <code>TypeProviders</code>. Then update it with the type provider for Phone Index</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">FSharp.Data</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">TypeProviders</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">samplePhoneIndexes</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class="line"><span class="s">  [{</span>
</span><span class="line"><span class="s">      &quot;age&quot;: 1,</span>
</span><span class="line"><span class="s">      &quot;id&quot;: &quot;id0&quot;,</span>
</span><span class="line"><span class="s">      &quot;imageUrl&quot;: &quot;id0.jpg&quot;,</span>
</span><span class="line"><span class="s">      &quot;name&quot;: &quot;Name0&quot;,</span>
</span><span class="line"><span class="s">      &quot;snippet&quot;: &quot;Sample Snippet0&quot;</span>
</span><span class="line"><span class="s">  },{</span>
</span><span class="line"><span class="s">      &quot;age&quot;: 2,</span>
</span><span class="line"><span class="s">      &quot;id&quot;: &quot;id1&quot;,</span>
</span><span class="line"><span class="s">      &quot;imageUrl&quot;: &quot;id1.jpg&quot;,</span>
</span><span class="line"><span class="s">      &quot;name&quot;: &quot;Name1&quot;,</span>
</span><span class="line"><span class="s">      &quot;snippet&quot;: &quot;Sample Snippet2&quot;</span>
</span><span class="line"><span class="s">  }]</span>
</span><span class="line"><span class="s">  &quot;&quot;&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">PhoneIndexTypeProvider</span> <span class="o">=</span> <span class="n">JsonProvider</span><span class="o">&lt;</span><span class="n">samplePhoneIndexes</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">ToPhoneIndex</span> <span class="o">(</span><span class="n">phoneIndex</span> <span class="o">:</span> <span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="n">phoneIndex</span><span class="o">.</span><span class="n">Id</span><span class="o">;</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">phoneIndex</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span> <span class="n">Age</span> <span class="o">=</span> <span class="n">phoneIndex</span><span class="o">.</span><span class="n">Age</span><span class="o">;</span> <span class="n">ImageUrl</span> <span class="o">=</span> <span class="n">phoneIndex</span><span class="o">.</span><span class="n">ImageUrl</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>ToPhoneIndex</code> is a utility function which converts the data store model <code>PhoneIndexTypeProvider.Root</code> to the domain model <code>PhoneIndex</code></p>

<p>Now we got the type provide for <code>PhoneIndex</code>, the next step is populating it from the github repository. To do that add a source file <code>GitHubRepository</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">GitHubRepository</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">gitHubRepoUrl</span> <span class="o">=</span> <span class="s">&quot;https://raw.githubusercontent.com/angular/angular-phonecat/master/app/phones/&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">phoneIndexes</span> <span class="o">=</span> <span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Load</span><span class="o">(</span><span class="n">gitHubRepoUrl</span> <span class="o">+</span> <span class="s">&quot;phones.json&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getPhoneIndexes</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">phoneIndexes</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s it! just three line of code to get the data from the <a href="https://raw.githubusercontent.com/angular/angular-phonecat/master/app/phones/phones.json">angular-phonecat repo</a> and map to the equivalent strongly typed models  </p>

<h4 id="composition-root">Composition Root</h4>

<p>Now we need to wire up the controller with the domain and the data access. We can use a <a href="http://www.hanselman.com/blog/ListOfNETDependencyInjectionContainersIOC.aspx">Dependency Injection Container</a> to achieve it. In fact it used to be my default decision. But after reading this <a href="http://blog.ploeh.dk/2012/11/06/WhentouseaDIContainer/">wonderful blog post</a> by <a href="https://twitter.com/ploeh">Mark Seeman</a> I have actually started rethinking about dependency injection. In this sample application we are going to use the <a href="http://blog.ploeh.dk/2011/07/28/CompositionRoot/">Composition Root</a> as suggested by Mark Seeman.</p>

<p>In the <em>Web</em> project create a source file with the name <code>Infrastructure</code> and add the following composition root</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Web</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http.Dispatcher</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http.Controllers</span>
</span><span class="line"><span class="k">open</span> <span class="nn">Web.Controllers</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">Infrastructure</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">CompositionRoot</span>
</span><span class="line">    <span class="o">(</span>
</span><span class="line">      <span class="n">phoneIndexes</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;</span>
</span><span class="line">    <span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">interface</span> <span class="n">IHttpControllerActivator</span> <span class="k">with</span>
</span><span class="line">
</span><span class="line">      <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">controllerDescriptor</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">        <span class="k">let</span> <span class="nv">phoneIndexes</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhoneIndex</span>
</span><span class="line">
</span><span class="line">        <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PromotionsController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">            <span class="k">let</span> <span class="nv">promotionsController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PromotionsController</span><span class="o">(</span><span class="n">getPromotions</span><span class="o">,</span> <span class="n">phoneIndexes&#39;</span><span class="o">)</span>
</span><span class="line">            <span class="n">promotionsController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">        <span class="k">else</span>
</span><span class="line">            <span class="n">raise</span> <span class="o">&lt;|</span> <span class="n">ArgumentException</span><span class="o">((</span><span class="n">sprintf</span> <span class="s">&quot;Unknown controller type requested: %A&quot;</span> <span class="n">controllerType</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We have actually created a custom implementation of <code>IHttpControllerActivator</code> as mentioned <a href="http://blog.ploeh.dk/2012/09/28/DependencyInjectionandLifetimeManagementwithASP.NETWebAPI/">here</a> which takes care of initializing the controllers by wiring the data store and the domain functions with the controller</p>

<p>The only pending task is tell ASP.NET Web Api to use this composition root. Update the <em>Global.asax.fs</em> file as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">static</span> <span class="k">member</span> <span class="n">RegisterWebApi</span><span class="o">(</span><span class="n">config</span><span class="o">:</span> <span class="n">HttpConfiguration</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// existing configuration will be here</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Additional Web API settings</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phoneIndexes</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhoneIndexes</span><span class="bp">()</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">Services</span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="n">typeof</span><span class="o">&lt;</span><span class="n">IHttpControllerActivator</span><span class="o">&gt;,</span> <span class="n">CompositionRoot</span><span class="o">(</span><span class="n">phoneIndexes</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have done an optimization by getting the phone indexes from the github when the application is starting, so that any requests to the application doesn’t get the data from github (typical enterprise performance improvement!).</p>

<h3 id="manufacturers-api">Manufacturers Api</h3>

<p>We are going to create the Manufacturers Api in the same way as Promotions Api. Let’s start from <code>ManufacturersController</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">Web</span><span class="p">.</span><span class="n">Controllers</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">ManufacturerViewModel</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/manufactures&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">ManufacturersController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">getManufacturerNames</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">ManufacturerName</span><span class="o">&gt;,</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Get</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="n">getManufacturerNames</span> <span class="n">phones</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">distinct</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">Name</span> <span class="o">=</span> <span class="nn">ManufacturerName</span><span class="p">.</span><span class="n">ToString</span> <span class="n">name</span><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As <code>PromotionsController</code>, <code>ManufacturersController</code> has also two dependencies.</p>

<ul>
  <li>
    <p><code>getManufacturerNames</code> is a function takes a sequence of domain model <code>Phone</code> and returns the sequence of domain model <code>ManufacturerName</code> which represents the manufacturer names of the given phones.</p>
  </li>
  <li>
    <p><code>phones</code> is a sequence of domain model &#8220;`Phone&#8220; that represents the phones available in the backend data store</p>
  </li>
</ul>

<p>The <code>Get</code> method in the <code>ManufacturersController</code> returns the manufacturer names for the given phones</p>

<p>The <code>ManufacturerViewModel</code> is just a DTO that is used to share the data across the wire.</p>

<p>The next step is to add the domain models. In the <code>Production</code> file of <em>Domain</em> project add the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">ManufacturerName</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="n">Samsung</span> <span class="o">|</span> <span class="n">Motorola</span> <span class="o">|</span> <span class="n">Dell</span> <span class="o">|</span> <span class="n">LG</span> <span class="o">|</span> <span class="n">TMobile</span> <span class="o">|</span> <span class="n">Sanyo</span> <span class="o">|</span> <span class="n">Unknown</span>
</span><span class="line">
</span><span class="line">  <span class="k">static</span> <span class="k">member</span> <span class="n">ToString</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Samsung</span> <span class="o">-&gt;</span> <span class="s">&quot;Samsung&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Motorola</span> <span class="o">-&gt;</span> <span class="s">&quot;Motorola&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Dell</span> <span class="o">-&gt;</span> <span class="s">&quot;Dell&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">LG</span> <span class="o">-&gt;</span> <span class="s">&quot;LG&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">TMobile</span> <span class="o">-&gt;</span> <span class="s">&quot;T-Mobile&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Sanyo</span> <span class="o">-&gt;</span> <span class="s">&quot;Sanyo&quot;</span>
</span><span class="line">      <span class="o">|</span> <span class="n">Unknown</span> <span class="o">-&gt;</span> <span class="s">&quot;Unknown&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">static</span> <span class="k">member</span> <span class="n">ToManufacturerName</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="k">match</span> <span class="n">name</span><span class="o">.</span><span class="n">ToLower</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;samsung&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Samsung</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;motorola&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Motorola</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;dell&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Dell</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;lg&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">LG</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;t-mobile&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">TMobile</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;sanyo&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Sanyo</span>
</span><span class="line">      <span class="o">|</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&quot;nexus&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Samsung</span>
</span><span class="line">      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">Unknown</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Phone</span> <span class="o">=</span>
</span><span class="line">  <span class="o">{</span> <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Description</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">ImageUrl</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>As the backend data-store doesn’t directly gives the manufacturer name, we will be adding two <strong>static</strong> members that derives the manufacturer name from the phone name. The <code>ToString</code> function translates to the domain model to its equivalent string version</p>

<p>After defining the domain models, add the business logic for the getting the manufacturer names from the phone in the new source file <code>Phones</code> of the <em>Domain</em> project.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Phones</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getManufacturerNames</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">phones</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="nn">ManufacturerName</span><span class="p">.</span><span class="n">ToManufacturerName</span> <span class="n">p</span><span class="o">.</span><span class="n">Name</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>getManufacturerNames</code> is a straight forward function that map given the phones to its equivalent manufacture names.</p>

<p>The next step would be fetching the phones from the data-store. </p>

<p>Let’s start by defining a type provider for the phone. Update the <code>TypeProviders</code> module in the <em>DataAccess</em> project as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">samplePhoneJson</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class="line"><span class="s">{</span>
</span><span class="line"><span class="s">  &quot;additionalFeatures&quot;: &quot;Trackball&quot;, </span>
</span><span class="line"><span class="s">  &quot;android&quot;: {</span>
</span><span class="line"><span class="s">      &quot;os&quot;: &quot;Android 2.2&quot;, </span>
</span><span class="line"><span class="s">      &quot;ui&quot;: &quot;&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;availability&quot;: [</span>
</span><span class="line"><span class="s">      &quot;Sprint&quot;</span>
</span><span class="line"><span class="s">  ], </span>
</span><span class="line"><span class="s">  &quot;battery&quot;: {</span>
</span><span class="line"><span class="s">      &quot;standbyTime&quot;: &quot;&quot;, </span>
</span><span class="line"><span class="s">      &quot;talkTime&quot;: &quot;4 hours&quot;, </span>
</span><span class="line"><span class="s">      &quot;type&quot;: &quot;Lithium Ion (Li-Ion) (1130 mAH)&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;camera&quot;: {</span>
</span><span class="line"><span class="s">      &quot;features&quot;: [</span>
</span><span class="line"><span class="s">          &quot;Video&quot;</span>
</span><span class="line"><span class="s">      ], </span>
</span><span class="line"><span class="s">      &quot;primary&quot;: &quot;3.2 megapixels&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;connectivity&quot;: {</span>
</span><span class="line"><span class="s">      &quot;bluetooth&quot;: &quot;Bluetooth 2.1&quot;, </span>
</span><span class="line"><span class="s">      &quot;cell&quot;: &quot;CDMA2000 1xEV-DO Rev.A&quot;, </span>
</span><span class="line"><span class="s">      &quot;gps&quot;: true, </span>
</span><span class="line"><span class="s">      &quot;infrared&quot;: false, </span>
</span><span class="line"><span class="s">      &quot;wifi&quot;: &quot;802.11 b/g&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;description&quot;: &quot;Zio uses CDMA2000 1xEV-DO rev&quot;, </span>
</span><span class="line"><span class="s">  &quot;display&quot;: {</span>
</span><span class="line"><span class="s">      &quot;screenResolution&quot;: &quot;WVGA (800 x 480)&quot;, </span>
</span><span class="line"><span class="s">      &quot;screenSize&quot;: &quot;3.5 inches&quot;, </span>
</span><span class="line"><span class="s">      &quot;touchScreen&quot;: true</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;hardware&quot;: {</span>
</span><span class="line"><span class="s">      &quot;accelerometer&quot;: true, </span>
</span><span class="line"><span class="s">      &quot;audioJack&quot;: &quot;3.5mm&quot;, </span>
</span><span class="line"><span class="s">      &quot;cpu&quot;: &quot;600MHz Qualcomm MSM7627&quot;, </span>
</span><span class="line"><span class="s">      &quot;fmRadio&quot;: false, </span>
</span><span class="line"><span class="s">      &quot;physicalKeyboard&quot;: false, </span>
</span><span class="line"><span class="s">      &quot;usb&quot;: &quot;USB 2.0&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;id&quot;: &quot;sanyo-zio&quot;, </span>
</span><span class="line"><span class="s">  &quot;images&quot;: [</span>
</span><span class="line"><span class="s">      &quot;img/phones/sanyo-zio.0.jpg&quot;, </span>
</span><span class="line"><span class="s">      &quot;img/phones/sanyo-zio.1.jpg&quot;, </span>
</span><span class="line"><span class="s">      &quot;img/phones/sanyo-zio.2.jpg&quot;</span>
</span><span class="line"><span class="s">  ], </span>
</span><span class="line"><span class="s">  &quot;name&quot;: &quot;SANYO ZIO&quot;, </span>
</span><span class="line"><span class="s">  &quot;sizeAndWeight&quot;: {</span>
</span><span class="line"><span class="s">      &quot;dimensions&quot;: [</span>
</span><span class="line"><span class="s">          &quot;58.6 mm (w)&quot;, </span>
</span><span class="line"><span class="s">          &quot;116.0 mm (h)&quot;, </span>
</span><span class="line"><span class="s">          &quot;12.2 mm (d)&quot;</span>
</span><span class="line"><span class="s">      ], </span>
</span><span class="line"><span class="s">      &quot;weight&quot;: &quot;105.0 grams&quot;</span>
</span><span class="line"><span class="s">  }, </span>
</span><span class="line"><span class="s">  &quot;storage&quot;: {</span>
</span><span class="line"><span class="s">      &quot;flash&quot;: &quot;130MB&quot;, </span>
</span><span class="line"><span class="s">      &quot;ram&quot;: &quot;256MB&quot;</span>
</span><span class="line"><span class="s">  }</span>
</span><span class="line"><span class="s">}</span>
</span><span class="line">
</span><span class="line"><span class="s">&quot;&quot;&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">PhoneTypeProvider</span> <span class="o">=</span> <span class="n">JsonProvider</span><span class="o">&lt;</span><span class="n">samplePhoneJson</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">ToPhone</span> <span class="o">(</span><span class="n">phone</span> <span class="o">:</span> <span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Id</span><span class="o">;</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span> <span class="n">Description</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Description</span><span class="o">;</span> <span class="n">ImageUrl</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">Images</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Like <code>ToPhoneIndex</code> utility function,  <code>ToPhone</code> converts the data store model <code>PhoneTypeProvider.Root</code> to the domain model <code>Phone</code></p>

<p>Unlike the phone index, <a href="https://github.com/angular/angular-phonecat/tree/master/app/phones">angular-phonecat</a> repository stores the details of each phones in a seperate json file with the naming convention of <strong>{phoneId}.json</strong>. So, in order to get the details of all the phones, we need to fire multiple requests to get the details. Thanks to <a href="http://blogs.msdn.com/b/dsyme/archive/2010/01/09/async-and-parallel-design-patterns-in-f-parallelizing-cpu-and-i-o-computations.aspx">fsharp async workflow</a> we can easily pull all the data parallelly and populate the strongly typed domain models from them.</p>

<p>Update the <code>GitHubRepository</code> module with the code to populate the data from the data store.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">GitHubRepository</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">gitHubRepoUrl</span> <span class="o">=</span> <span class="s">&quot;https://raw.githubusercontent.com/angular/angular-phonecat/master/app/phones/&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">phoneIndexes</span> <span class="o">=</span> <span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Load</span><span class="o">(</span><span class="n">gitHubRepoUrl</span> <span class="o">+</span> <span class="s">&quot;phones.json&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">phoneIds</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">pMap</span> <span class="n">ids</span> <span class="o">=</span>
</span><span class="line">      <span class="n">seq</span> <span class="o">{</span><span class="k">for</span> <span class="n">id</span> <span class="k">in</span> <span class="n">ids</span> <span class="o">-&gt;</span> <span class="n">async</span> <span class="o">{</span> <span class="k">return</span> <span class="n">id</span><span class="o">,</span> <span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Load</span><span class="o">(</span><span class="n">gitHubRepoUrl</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">&quot;.json&quot;</span><span class="o">)</span> <span class="o">}}</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="n">Parallel</span>
</span><span class="line">      <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="n">RunSynchronously</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">phones</span> <span class="o">=</span> <span class="n">pMap</span> <span class="n">phoneIds</span> <span class="o">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">ofSeq</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getPhoneIndexes</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">phoneIndexes</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">getPhones</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Value</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Expressiveness is one of the reason behind my fsharp addiction. Just see the above code we have done some much thing with just few lines of code. We have fetched the details of all the phones using their ids from phone index and created an in-memory map.</p>

<p>The <code>getPhones</code> function returns the strongly typed <code>PhoneTypeProvider</code> models from the in-memory map.</p>

<p>The last thing is to wire up all the things and create the <code>ManufacturersController</code>. Update the <code>CompositionRoot</code> type in the <code>Infrastructure</code> module with the below code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;,</span>
</span><span class="line">    <span class="n">phoneIndexes</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneIndexTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">interface</span> <span class="n">IHttpControllerActivator</span> <span class="k">with</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">controllerDescriptor</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phoneIndexes</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phoneIndexes</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhoneIndex</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PromotionsController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">promotionsController</span> <span class="o">=</span>
</span><span class="line">          <span class="k">new</span> <span class="n">PromotionsController</span><span class="o">(</span><span class="n">getPromotions</span><span class="o">,</span> <span class="n">phoneIndexes&#39;</span><span class="o">)</span>
</span><span class="line">        <span class="n">promotionsController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">
</span><span class="line">    <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">ManufacturersController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">        <span class="k">let</span> <span class="nv">manufacturersController</span> <span class="o">=</span>
</span><span class="line">          <span class="k">new</span> <span class="n">ManufacturersController</span><span class="o">(</span><span class="n">getManufacturerNames</span><span class="o">,</span> <span class="n">phones&#39;</span><span class="o">)</span>
</span><span class="line">        <span class="n">manufacturersController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">        <span class="n">raise</span> <span class="o">&lt;|</span> <span class="n">ArgumentException</span><span class="o">((</span><span class="n">sprintf</span> <span class="s">&quot;Unknown controller type requested: %A&quot;</span> <span class="n">controllerType</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And update the <em>Global.asax.fs</em> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">static</span> <span class="k">member</span> <span class="n">RegisterWebApi</span><span class="o">(</span><span class="n">config</span><span class="o">:</span> <span class="n">HttpConfiguration</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// existing configuration will be here</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Additional Web API settings</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phones</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhones</span><span class="bp">()</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phoneIndexes</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhoneIndexes</span><span class="bp">()</span>
</span><span class="line">  <span class="n">config</span><span class="o">.</span><span class="n">Services</span><span class="o">.</span><span class="n">Replace</span><span class="o">(</span><span class="n">typeof</span><span class="o">&lt;</span><span class="n">IHttpControllerActivator</span><span class="o">&gt;,</span> <span class="n">CompositionRoot</span><span class="o">(</span><span class="n">phones</span><span class="o">,</span> <span class="n">phoneIndexes</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="top-selling-phones-api">Top Selling Phones Api</h3>

<p>Create <code>PhonesController</code> in the <em>Web</em> project and add the api to return the top selling phones</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">Web</span><span class="p">.</span><span class="n">Controllers</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Web.Http</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">RoutePrefix</span><span class="o">(</span><span class="s">&quot;api/phones&quot;</span><span class="o">)&gt;]</span>
</span><span class="line"><span class="k">type</span> <span class="nc">PhonesController</span>
</span><span class="line">  <span class="o">(</span>
</span><span class="line">    <span class="n">getTopSellingPhones</span> <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;,</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;</span>
</span><span class="line">  <span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">ApiController</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="o">[&lt;</span><span class="n">Route</span><span class="o">(</span><span class="s">&quot;topselling&quot;</span><span class="o">)&gt;]</span>
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetTopSelling</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="n">getTopSellingPhones</span> <span class="mi">3</span> <span class="n">phones</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>getTopSellingPhones</code> picks given count of phones from the given phones and return them.</p>

<p>In the <code>Phones</code> module of <em>Domain</em> project add the function <code>getTopSellingPhones</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">(</span><span class="n">phonesSold</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">PhoneSold</span><span class="o">&gt;)</span> <span class="n">phoneCount</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="n">phonesSold</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Quantity</span><span class="o">,</span> <span class="o">(</span><span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p&#39;</span> <span class="o">-&gt;</span> <span class="n">p&#39;</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span><span class="o">)))</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">sortBy</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="o">-(</span><span class="n">fst</span> <span class="n">x</span><span class="o">))</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">take</span> <span class="n">phoneCount</span>
</span><span class="line">  <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="n">snd</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>PhoneSold</code> domain model represents how much quantity of each phone has been sold. The <code>getTopSellingPhones</code> sorts the given phones in the descending order based on the quantity being sold and return the given count of the phones from the sorting result</p>

<p>Right now the <code>PhoneSold</code> domain model is not added. So add them in the new module <code>Purchases</code> in the <em>Domain</em> project as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Purchases</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">PhoneSold</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Id</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class="line">    <span class="n">Quantity</span> <span class="o">:</span> <span class="n">int</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The angular data-store doesn’t provide quantity sold information, so we need to get it from somewhere else. To keep it simple, we are going add an <code>InMemoryInventory</code> in <em>DataAccess</em> project as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">DataAccess</span>
</span><span class="line"><span class="k">open</span> <span class="nn">PhoneCat.Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">InMemoryInventory</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">getPhonesSold</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">[</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;motorola-xoom-with-wi-fi&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">10</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;motorola-atrix-4g&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">24</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;nexus-s&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">4</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;samsung-galaxy-tab&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">41</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;sanyo-zio&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">31</span><span class="o">}</span>
</span><span class="line">    <span class="o">{</span> <span class="n">Id</span> <span class="o">=</span> <span class="s">&quot;motorola-xoom&quot;</span><span class="o">;</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mi">6</span><span class="o">}</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As previous api’s we need wire things up and create the controller in the <code>CompositeRoot</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"> <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhonesController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getTopSellingPhones</span> <span class="o">(</span><span class="nn">InMemoryInventory</span><span class="p">.</span><span class="n">getPhonesSold</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">phonesController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhonesController</span><span class="o">(</span><span class="n">getTopSellingPhones</span><span class="o">,</span> <span class="n">phones&#39;</span><span class="o">)</span>
</span><span class="line">  <span class="n">phonesController</span> <span class="o">:&gt;</span> <span class="n">IHttpController</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We have used <a href="http://fsharpforfunandprofit.com/posts/partial-application/">partial application</a> of the <code>Phones.getTopSellingPhones</code> function here. Its signature is <code>seq&lt;PhoneSold&gt; -&gt; int -&gt; seq&lt;Phone&gt; -&gt; seq&lt;Phone&gt;</code><br />
but the controller expects the function with the signature <code>int -&gt; seq&lt;Phone&gt; -&gt; seq&lt;Phone&gt;</code>.</p>

<p>The expression</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getTopSellingPhones</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getTopSellingPhones</span> <span class="o">(</span><span class="nn">InMemoryInventory</span><span class="p">.</span><span class="n">getPhonesSold</span><span class="bp">()</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>actually does this.</p>

<h3 id="front-end">Front-End</h3>

<p>As front-end is out of the scope of this blog post I am not covering it here. I’ve actually developed it using knockout.js.</p>

<h2 id="summary">Summary</h2>

<p>We have covered a quite a large ground here by creating three web-api endpoints in fsharp using Web Api 2. In the later posts we will be adding error handling and making it robust. The source code for this step can be found in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/1">github repository</a></p>
</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2015

    Tamizhvendan S


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'tamizhvendan-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.tamizhvendan.in/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/';
        var disqus_url = 'http://blog.tamizhvendan.in/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>






</body>
</html>
