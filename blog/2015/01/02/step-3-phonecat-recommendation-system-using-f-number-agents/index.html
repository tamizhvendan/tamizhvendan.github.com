
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Step-3 PhoneCat Recommendation System using F# Agents, SignalR and Rx - Tamizh's Thoughts</title>
	<meta name="author" content="Tamizhvendan S">

	
	<meta name="description" content="Step-3 PhoneCat Recommendation System Using F# Agents, SignalR and Rx This is step 3 of my blog series on Web Application Development in Fsharp &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="http://feeds.feedburner.com/tamizhvendan-blog" rel="alternate" title="Tamizh's Thoughts" type="application/atom+xml">
	
	<link rel="canonical" href="http://blog.tamizhvendan.in/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-43004255-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("tamizh88@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="http://about.me/tamizhvendan">About</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <li><a href="/open-source-contributions">Contributions</a></li>
</ul>
<a href="http://www.codeproject.com" rel="tag" style="display:none">CodeProject</a>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:tamizh88@gmail.com" title="Email">Email</a>
		
		
		
		
			<a class="twitter" href="http://twitter.com/tamizhvendan" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/tamizhvendan" title="GitHub">GitHub</a>
		
		
			<a class="coderwall" href="https://coderwall.com/tamizhvendan" title="Coderwall">Coderwall</a>
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="http://feeds.feedburner.com/tamizhvendan-blog" title="RSS">RSS</a>
		
	</div>
<nav id="tag-cloud">
	<section>
    <span id="tag-cloud"><a href='/blog/categories/asp-dot-net' style='font-size: 104.0%'>asp.net</a> <a href='/blog/categories/asp-dot-net-mvc' style='font-size: 160.0%'>asp.net mvc</a> <a href='/blog/categories/c-number' style='font-size: 116.0%'>c#</a> <a href='/blog/categories/craftsmanship' style='font-size: 116.0%'>craftsmanship</a> <a href='/blog/categories/data-access' style='font-size: 112.0%'>data access</a> <a href='/blog/categories/devops' style='font-size: 104.0%'>devops</a> <a href='/blog/categories/dsl' style='font-size: 104.0%'>dsl</a> <a href='/blog/categories/entity-framework' style='font-size: 120.0%'>entity framework</a> <a href='/blog/categories/fake' style='font-size: 104.0%'>fake</a> <a href='/blog/categories/fparsec' style='font-size: 104.0%'>fparsec</a> <a href='/blog/categories/fsharp' style='font-size: 132.0%'>fsharp</a> <a href='/blog/categories/functional-programming' style='font-size: 124.0%'>functional-programming</a> <a href='/blog/categories/goals' style='font-size: 104.0%'>goals</a> <a href='/blog/categories/javascript' style='font-size: 112.0%'>javascript</a> <a href='/blog/categories/jquery' style='font-size: 108.0%'>jquery</a> <a href='/blog/categories/node-dot-js' style='font-size: 108.0%'>node.js</a> <a href='/blog/categories/others' style='font-size: 104.0%'>others</a> <a href='/blog/categories/programming' style='font-size: 124.0%'>programming</a> <a href='/blog/categories/rx' style='font-size: 104.0%'>rx</a> <a href='/blog/categories/signalr' style='font-size: 104.0%'>signalr</a> <a href='/blog/categories/unit-testing' style='font-size: 120.0%'>unit testing</a> <a href='/blog/categories/web-api' style='font-size: 108.0%'>web-api</a> </span>
</section>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Step-3 PhoneCat Recommendation System Using F# Agents, SignalR and Rx</h1>
	<div class="entry-content" itemprop="articleBody"><blockquote>
  <p>This is step 3 of my blog series on <a href="/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the last two steps we have seen how to create a <a href="/blog/2014/12/17/phonecat-backend-using-web-api-and-typeproviders/">web apis</a> and <a href="/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">static razor views</a> in fsharp. In this blog post we are going to see one of my favorite feature in fsharp <a href="http://fsharpforfunandprofit.com/posts/concurrency-actor-model/">“Message based approach to concurrency”</a>.</p>

<h3 id="a-small-flashback">A Small Flashback</h3>
<p>I’ve actually planned to put this blog post for the great fsharp community initiative <a href="https://sergeytihon.wordpress.com/2014/11/24/f-advent-calendar-in-english-2014/">F# Advent Calender</a>. Unfortunately it was not able to get through as I’ve <a href="http://sergeytihon.wordpress.com/2014/11/24/f-advent-calendar-in-english-2014/#comment-4135">nominated myself</a> little late. I always believe there is an opportunity behind every adversity. I didn’t get hung up and I knew this is one of the great topic to blog about. When I decided to blog about it, I needed a sample web application. So, I was creating that sample application and it suddenly strikes! <em>How about a blog series on web application development in fsharp?</em> I’ve immediately started working on it and hence this blog series.</p>

<h3 id="so-what-we-gonna-do-in-this-step">So what we gonna do in this step</h3>
<p>In this blog post we are going to build a recommendation system which keeps track of what phones that the user is viewing, and based on his navigation history, we will be recommending a phone that he might be interested in</p>

<p style="text-align:center"> <strong> User visits &#8220;Motorola XOOM™&#8221; </strong> </p>
<p><img src="/images/fsharp_phonecat/step_3/Phone_1.png" /></p>

<p style="text-align:center"> <strong> User visits &#8220;Motorola XOOM™ with Wi-Fi&#8221; </strong> </p>
<p><img src="/images/fsharp_phonecat/step_3/Phone_2.png" /></p>

<p>Let us start the implementation by defining two high level tasks</p>

<ol>
  <li>Tracking user navigation</li>
  <li>Recommending a phone</li>
</ol>

<h3 id="tracking-user-navigation">1. Tracking user navigation</h3>

<p><img class="center" src="/images/fsharp_phonecat/step_3/Phone_Visit_Workflow.png" width="600" height="500" /></p>

<p>The first two components has been already implemented as part of <a href="/blog/2014/12/23/step-2-fsharp-phonecat-views-using-razor/">step-2</a>. So we just need to wire up the other two components. Let’s start from <code>PhoneViewTracker</code></p>

<p>Create a source file in the <strong>Web</strong> project and name it as <code>PhoneViewTracker</code>. Add a function <code>observePhonesViewed</code> which will be invoked when you a user visits a phone.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">PhoneViewTracker</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">observePhonesViewed</span> <span class="n">anonymousId</span> <span class="n">phoneIdBeingVisited</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">StorageAgent</span><span class="p">.</span><span class="n">Post</span> <span class="o">(</span><span class="n">SavePhoneVisit</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">phoneIdBeingVisited</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>anonymousId</code> is a <a href="http://msdn.microsoft.com/en-us/library/system.web.httprequest.anonymousid%28v=vs.110%29.aspx">http property</a> which represents a unique identifier for the given user session</p>

<p>Upon receiving the <code>anonymousId</code> and <code>phoneIdBeingVisited</code> we will be posting a message to the <code>StorageAgent</code> to save this visit. Both the agent and the message doesn’t exist now, so lets create them</p>

<p>Create a source file in the <strong>Domain</strong> project and name it as <code>UserNavigationHistory</code> and add the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Domain</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">System.Reactive.Subjects</span>
</span><span class="line"><span class="k">open</span> <span class="nn">System.Collections.Generic</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Agent</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">MailboxProcessor</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">T</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">UserNavigationHistory</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="nc">StorageAgentMessage</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">storageAgentFunc</span> <span class="o">(</span><span class="n">agent</span> <span class="o">:</span> <span class="n">Agent</span><span class="o">&lt;</span><span class="n">StorageAgentMessage</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">loop</span> <span class="o">(</span><span class="n">dict</span> <span class="o">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">list</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">storageAgentMessage</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
</span><span class="line">      <span class="k">match</span> <span class="n">storageAgentMessage</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">phoneIdBeingVisited</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="k">if</span> <span class="n">dict</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">            <span class="k">let</span> <span class="nv">phoneIdsVisited</span> <span class="o">=</span> <span class="n">phoneIdBeingVisited</span> <span class="o">::</span> <span class="n">dict</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span>
</span><span class="line">            <span class="n">dict</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">phoneIdsVisited</span>
</span><span class="line">          <span class="k">else</span>
</span><span class="line">            <span class="n">dict</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="o">[</span><span class="n">phoneIdBeingVisited</span><span class="o">])</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">loop</span> <span class="n">dict</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="n">loop</span> <span class="o">(</span><span class="k">new</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">list</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">StorageAgent</span> <span class="o">=</span> <span class="nn">Agent</span><span class="p">.</span><span class="n">Start</span><span class="o">(</span><span class="n">storageAgentFunc</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Storage Agent is an F# Agent which stores the user navigation history in an in-memory dictionary. It can be replaced by any key-value store like <a href="http://redis.io/">redis</a> but for experimentation I’ve preferred to use F# Agents.</p>

<p>The <code>StorageAgentMessage</code> is a <a href="http://fsharpforfunandprofit.com/posts/discriminated-unions/">dicriminated union</a> represents possible messages that the <code>StorageAgent</code> can process. Right now it has only message <code>SavePhoneVisit</code> which takes a tuple representing the <code>anonymousId</code> and the <code>phoneIdBeingVisited</code></p>

<p>The <code>StorageAgent</code> is a typical F# Agent which waits for the incoming <code>StorageAgentMessage</code> and upon receiving it stores the visit in the in-memory dictionary. </p>

<p>The next step is wiring the <code>PhoneViewTracker.observePhonesViewed</code> function with the <code>PhoneController.Show</code> action method. We can call the function directly that will create a strongly coupled code. We can even directly post the message to the agent. But that also makes the code tightly coupled. </p>

<p>What we are actually trying to implement here is a <strong>User Phone Visit Stream</strong>. Whenever the user visits a phone, we just want to notifiy somebody to keep track of it and move on. And its where <a href="http://msdn.microsoft.com/en-in/data/gg577609.aspx">Reactive Extensions aka Rx</a> comes into the picture. If you are new to Reactive Programming or Rx, I strongly recommend you to go through <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">this excellent article</a> by <a href="http://staltz.com/">André Staltz</a></p>

<p>Install the <a href="https://www.nuget.org/packages/Rx-Main/">Rx Nuget Package</a> in the <em>Web</em> project. With Rx in the kitty the next step is to make the User’s phone visit as event and subscribe this event with the <code>PhoneViewTracker</code></p>

<p>The first step is to make the <code>PhoneController</code> as observable. Modify the already created <code>PhoneController</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">PhoneController</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">inherit</span> <span class="n">Controller</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">subject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Subject</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">interface</span> <span class="n">IObservable</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span> <span class="k">with</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Subscribe</span> <span class="n">observer</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">Subscribe</span> <span class="n">observer</span>
</span><span class="line">
</span><span class="line">  <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Show</span> <span class="o">(</span><span class="n">id</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phone</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">id</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">PhoneViewModel</span><span class="p">.</span><span class="n">ToPhoneViewModel</span>
</span><span class="line">    <span class="n">subject</span><span class="o">.</span><span class="n">OnNext</span> <span class="n">id</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">phone</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">Dispose</span> <span class="n">disposing</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="n">disposing</span> <span class="k">then</span>
</span><span class="line">      <span class="n">subject</span><span class="o">.</span><span class="n">OnCompleted</span><span class="bp">()</span>
</span><span class="line">      <span class="n">subject</span><span class="o">.</span><span class="n">Dispose</span><span class="bp">()</span>
</span><span class="line">    <span class="k">base</span><span class="o">.</span><span class="n">Dispose</span> <span class="n">disposing</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>One of the great feature of F# is its seamless interoperability with C# libraries. As you seen in the above code snippet we have just made the <code>PhoneController</code> into an observable by implementing the interface <a href="http://msdn.microsoft.com/en-us/library/dd990377%28v=vs.110%29.aspx">IObservable</a>. </p>

<p>We have created a private <a href="http://msdn.microsoft.com/en-us/library/hh242970%28v=vs.103%29.aspx">Rx Subject</a> and made it responsible for pushing the notification which contains the phone id that is being visited.</p>

<p>But wait how do we configure the subscription between this controller and the <code>PhoneViewTracker</code> ? Thanks to the CompositionRoot that we have <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/2/Web/Infrastructure.fs#L28-L32">created in the step-2</a>. As we have full control over the creation of controller its just a matter of two lines to achieve it.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CompositionRoot</span><span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="nn">PhoneTypeProvider</span><span class="p">.</span><span class="n">Root</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">DefaultControllerFactory</span><span class="bp">()</span> <span class="k">with</span>
</span><span class="line">      <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetControllerInstance</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">controllerType</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">        <span class="c1">// ...</span>
</span><span class="line">        <span class="k">else</span> <span class="k">if</span> <span class="n">controllerType</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">PhoneController</span><span class="o">&gt;</span> <span class="k">then</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToCatalogPhone</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">observer</span> <span class="o">=</span> <span class="nn">PhoneViewTracker</span><span class="p">.</span><span class="n">observePhonesViewed</span> <span class="o">(</span><span class="n">requestContext</span><span class="o">.</span><span class="n">HttpContext</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">AnonymousID</span><span class="o">)</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">phoneController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhoneController</span><span class="o">(</span><span class="n">phones&#39;</span><span class="o">)</span>
</span><span class="line">          <span class="k">let</span> <span class="nv">subscription</span> <span class="o">=</span> <span class="n">phoneController</span><span class="o">.</span><span class="n">Subscribe</span> <span class="n">observer</span>
</span><span class="line">          <span class="n">phoneController</span> <span class="o">:&gt;</span> <span class="n">IController</span>
</span><span class="line">        <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We are leveraging the ASP.NET’s <a href="http://msdn.microsoft.com/en-us/library/fsykd036.aspx">Anonymous Identification Module</a> which help us in creating a unique anonymous id for every user session. We can retrieve it from the <a href="http://msdn.microsoft.com/en-us/library/system.web.httprequest.anonymousid.aspx">HttpRequest</a> as mentioned in the above snippet</p>

<p><a href="http://msdn.microsoft.com/en-in/library/91ka2e6a(v=vs.85).aspx">Anonymous identification of user session</a> are not enabled by default, so add the following entry in the <strong>Web.config</strong> file</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;configuration&gt;</span>
</span><span class="line">  <span class="c">&lt;!-- Existing Code ignored for brevity ... --&gt;</span>
</span><span class="line">  <span class="nt">&lt;system.web&gt;</span>
</span><span class="line">    <span class="c">&lt;!-- Existing Code ignored for brevity... --&gt;</span>
</span><span class="line">    <span class="nt">&lt;anonymousIdentification</span> <span class="na">enabled=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/system.web&gt;</span>
</span><span class="line"><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With the help of the partial application of functions as we did it in the previous steps, we have created a partial function called <code>observer</code> which has the signature <code>string -&gt; unit</code>. Then we have subscribed to <code>PhoneController</code> using the <code>Subscribe</code> method and with this we are done with saving an user visit. </p>

<h3 id="recommending-a-phone">2. Recommending a phone</h3>

<p><strong>Workflow</strong></p>

<p><img class="center" src="/images/fsharp_phonecat/step_3/Phone_Recommendation_Workflow.png" width="600" height="500" /></p>

<ol>
  <li>User initiates the recommendation request using SignalR</li>
  <li>Upon receiving it, Recommendation SignalR hub sends a recommendation request message to Storage Agent with the user Anonymous Id and SignlaR connection Id of the given user</li>
  <li>Storage Agent then fetches the phone visit history of the given user based on the incoming anonymous id and pass it to the Recommendation Agent along with the SignalR connection id.</li>
  <li>Recommendation Agent responds to this by computing the recommendation and publish the result (Either recommended phone id or none) in the Recommendation observable</li>
  <li>Recommendation hub receives this recommendation result, send the response back to the corresponding SignalR client.</li>
</ol>

<p>The beauty of this entire workflow is all are message driven and asynchronous by default.  </p>

<p>Let’s start from Recommendation SignalR hub. The first step is installing SingalR from <a href="https://www.nuget.org/packages/Microsoft.AspNet.SignalR/2.1.2">the nuget</a>.</p>

<p>After installing create a source file in the <strong>Web</strong> project and name it as <code>Startup</code> then add the following code as per the SignalR convention.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">namespace</span> <span class="nn">PhoneCat</span><span class="p">.</span><span class="n">Web</span>
</span><span class="line">
</span><span class="line"><span class="k">open</span> <span class="nn">Owin</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="nc">Startup</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Configuration</span><span class="o">(</span><span class="n">app</span> <span class="o">:</span> <span class="n">IAppBuilder</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">app</span><span class="o">.</span><span class="n">MapSignalR</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then add an app setting in the <em>Web.config</em> file and configure the SignalR to use this <code>Startup</code> class</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;configuration&gt;</span>
</span><span class="line">  <span class="nt">&lt;appSettings&gt;</span>
</span><span class="line">    <span class="c">&lt;!-- Other keys.. --&gt;</span>
</span><span class="line">    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">&quot;owin:AppStartup&quot;</span> <span class="na">value=</span><span class="s">&quot;PhoneCat.Web.Startup&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">  <span class="nt">&lt;/appSettings&gt;</span>
</span><span class="line">  <span class="c">&lt;!-- other configuration items.. --&gt;</span>
</span><span class="line"><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With SignalR added to the system, the next step is to create <code>RecommendationHub</code>. Add a source file in <strong>Web</strong> project and name it as <code>Hubs</code>.</p>

<p>Then create a <code>RecommendationHub</code> class with a public method <code>GetRecommendation</code> which will be invoked by the SignalR client to initiate recommendation process.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">RecommendationHub</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">Hub</span> <span class="bp">()</span>
</span><span class="line">    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetRecommendation</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">encodedAnonymousId</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">Cookies</span><span class="o">.[</span><span class="s">&quot;.ASPXANONYMOUS&quot;</span><span class="o">].</span><span class="n">Value</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">anonymousId</span> <span class="o">=</span> <span class="n">decode</span> <span class="n">encodedAnonymousId</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">connectionId</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">ConnectionId</span>
</span><span class="line">      <span class="nn">StorageAgent</span><span class="p">.</span><span class="n">Post</span> <span class="o">(</span><span class="n">GetRecommendation</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">connectionId</span><span class="o">))</span>
</span><span class="line">      <span class="s">&quot;Recommendation initiated&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then anonymous id of the user session is actually persisted in the <a href="http://msdn.microsoft.com/en-in/library/91ka2e6a%28v=vs.85%29.aspx">request cookies by Asp.Net</a> in an encoded format. In the <code>GetRecommendation</code> method we will be retrieving this encoded anonymous id from the cookie and decode it. Then we need to get the SignalR connection id which available in the base class <code>Hub</code>. After getting both the anonymous id and the connection id, send a <code>GetRecommendation</code> message to the <code>StorageAgent</code> with these information. Finally send a response to the SignalR client as “Recommendation initiated”.</p>

<p>The <code>decode</code> function is not added yet so let’s add them. Thanks to <a href="http://stackoverflow.com/a/2481110/159850">this stackoverflow answer</a> we just need to convert the code from C# to F#</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">decode</span> <span class="n">encodedAnonymousId</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">decodeMethod</span> <span class="o">=</span>
</span><span class="line">      <span class="n">typeof</span><span class="o">&lt;</span><span class="n">AnonymousIdentificationModule</span><span class="o">&gt;</span>
</span><span class="line">        <span class="o">.</span><span class="n">GetMethod</span><span class="o">(</span><span class="s">&quot;GetDecodedValue&quot;</span><span class="o">,</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">Static</span> <span class="o">|||</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">anonymousIdData</span> <span class="o">=</span> <span class="n">decodeMethod</span><span class="o">.</span><span class="n">Invoke</span><span class="o">(</span><span class="k">null</span><span class="o">,</span> <span class="o">[|</span> <span class="n">encodedAnonymousId</span> <span class="o">|]);</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">field</span> <span class="o">=</span>
</span><span class="line">      <span class="n">anonymousIdData</span><span class="o">.</span><span class="n">GetType</span><span class="bp">()</span>
</span><span class="line">        <span class="o">.</span><span class="n">GetField</span><span class="o">(</span><span class="s">&quot;AnonymousId&quot;</span><span class="o">,</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="o">|||</span> <span class="nn">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="o">);</span>
</span><span class="line">    <span class="n">field</span><span class="o">.</span><span class="n">GetValue</span><span class="o">(</span><span class="n">anonymousIdData</span><span class="o">)</span> <span class="o">:?&gt;</span> <span class="kt">string</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We have used a special F# operator here <code>:?&gt;</code> which is a dynamic down cast operator which casts a base class to a sub-class of it. You can read <a href="http://msdn.microsoft.com/en-us/library/dd233220.aspx">this msdn documentation</a> to know more about F# casting and conversions.</p>

<p>The <code>GetRecommendation</code> message is not added yet, so let’s add them too. Modify <code>StorageAgentMessage</code> created before as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line">  <span class="k">type</span> <span class="nc">StorageAgentMessage</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span><span class="line">    <span class="o">|</span> <span class="n">GetRecommendation</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The final step of this pipeline is to Update the <code>StorageAgent</code> to handle this <code>GetRecommendation</code> message. Modify the <code>storageAgentFunc</code> in the <code>UserNavigationHistory</code> as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"> <span class="k">let</span> <span class="nv">private</span> <span class="n">storageAgentFunc</span> <span class="o">(</span><span class="n">agent</span> <span class="o">:</span> <span class="n">Agent</span><span class="o">&lt;</span><span class="n">StorageAgentMessage</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">loop</span> <span class="o">(</span><span class="n">dict</span> <span class="o">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">list</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">storageAgentMessage</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
</span><span class="line">      <span class="k">match</span> <span class="n">storageAgentMessage</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="n">SavePhoneVisit</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">phoneIdBeingVisited</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="c1">// .. existing code ignored for brevity ..</span>
</span><span class="line">      <span class="o">|</span> <span class="n">GetRecommendation</span> <span class="o">(</span><span class="n">anonymousId</span><span class="o">,</span> <span class="n">connectionId</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="k">if</span> <span class="n">dict</span><span class="o">.</span><span class="n">ContainsKey</span><span class="o">(</span><span class="n">anonymousId</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">            <span class="k">let</span> <span class="nv">phoneIdsVisited</span> <span class="o">=</span> <span class="n">dict</span><span class="o">.[</span><span class="n">anonymousId</span><span class="o">]</span>
</span><span class="line">            <span class="nn">RecommendationAgent</span><span class="p">.</span><span class="n">Post</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span><span class="n">phoneIdsVisited</span><span class="o">)</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">loop</span> <span class="n">dict</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Handling of the <code>GetRecommendation</code> message is very straight forward. Just get the phone ids being visited by the given anonymous id from the in memory dictionary and send a message consists of connection id and this phone ids visited to the <code>RecommendationAgent</code> which we will be creating next.</p>

<p>Create a source file with the name <code>Recommendations</code> in the <strong>Domain</strong> project and add the <code>RecommendationAgent</code> below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Recommendation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">recommendationAgentFunc</span> <span class="o">(</span><span class="n">inbox</span> <span class="o">:</span> <span class="n">Agent</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">*</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">messageLoop</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class="line">      <span class="k">let!</span> <span class="nv">connectionId</span><span class="o">,</span> <span class="n">visitedPhoneIds</span> <span class="o">=</span> <span class="n">inbox</span><span class="o">.</span><span class="n">Receive</span><span class="bp">()</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="nn">Seq</span><span class="p">.</span><span class="n">length</span> <span class="n">visitedPhoneIds</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">then</span>
</span><span class="line">        <span class="n">suggestRecommendation</span> <span class="n">connectionId</span> <span class="o">(</span><span class="n">visitedPhoneIds</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">take</span> <span class="mi">2</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toList</span><span class="o">)</span>
</span><span class="line">      <span class="k">return</span><span class="o">!</span> <span class="n">messageLoop</span><span class="bp">()</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">messageLoop</span> <span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">RecommendationAgent</span> <span class="o">=</span> <span class="nn">Agent</span><span class="p">.</span><span class="n">Start</span> <span class="n">recommendationAgentFunc</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In order to keep this blog post simple I’ve used my own ‘Hello World’ kind of algorithm which picks the latest two phone ids being visited and suggests recommendation based on it. In a real world you would be replacing this toddler algorithm with more sophisticated algorithms like <a href="http://en.wikipedia.org/wiki/Association_rule_learning">Association Rule Learning</a>. I am planning to implement this algorithm at later stages of this blog series.</p>

<p>Then the next step is to implement the <code>suggestRecommendation</code> function which picks a hardcoded recommendation and publish the result using Rx. To do this add the <a href="https://www.nuget.org/packages/Rx-Main/">Rx Nuget Package</a> in the <strong>Domain</strong> project and add the  <code>suggestRecommendation</code> function in the <code>Recommendation</code> module</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">RecommendationPipe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Subject</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">*</span><span class="kt">string</span> <span class="n">option</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">private</span> <span class="n">suggestRecommendation</span> <span class="n">connectionId</span> <span class="n">visitedPhoneIds</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="n">visitedPhoneIds</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="o">[</span><span class="s">&quot;motorola-xoom-with-wi-fi&quot;</span><span class="o">;</span> <span class="s">&quot;motorola-xoom&quot;</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">OnNext</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">Some</span> <span class="s">&quot;motorola-atrix-4g&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="o">[</span><span class="s">&quot;dell-streak-7&quot;</span><span class="o">;</span> <span class="s">&quot;dell-venue&quot;</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">OnNext</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">Some</span> <span class="s">&quot;nexus-s&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">OnNext</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">None</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The implementation is a very straight forward pattern matching. If last visited two items are (“motorola-xoom-with-wi-fi”, “motorola-xoom”), send the recommendation as “motorola-atrix-4g”, else if they are (“dell-streak-7”,”dell-venue”) then recommend “nexus-s”. If none of the condition matches then send none. Thanks to the <a href="http://fsharpforfunandprofit.com/posts/the-option-type/">option type</a> which expresses this result in type safe manner.</p>

<p>With all these infrastructure in place, all we need to do is to just subscribe to this <code>RecommendationPipe</code> and send the suggestion to the user via SignalR</p>

<p>Let’s add a observer for this pipe in the <strong>Web</strong> project. Open <code>Hubs</code> module in the <strong>Web</strong> project and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">getUrl</span> <span class="o">(</span><span class="n">phoneId</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="n">httpContext</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">routeValueDictionary</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RouteValueDictionary</span><span class="bp">()</span>
</span><span class="line">    <span class="n">routeValueDictionary</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;controller&quot;</span><span class="o">,</span> <span class="s">&quot;Phone&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">routeValueDictionary</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;action&quot;</span><span class="o">,</span> <span class="s">&quot;Show&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">routeValueDictionary</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">phoneId</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">requestContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RequestContext</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpContextWrapper</span><span class="o">(</span><span class="n">httpContext</span><span class="o">),</span> <span class="k">new</span> <span class="n">RouteData</span><span class="bp">()</span><span class="o">);</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">virtualPathData</span> <span class="o">=</span> <span class="nn">RouteTable</span><span class="p">.</span><span class="nn">Routes</span><span class="p">.</span><span class="n">GetVirtualPath</span><span class="o">(</span><span class="n">requestContext</span><span class="o">,</span> <span class="n">routeValueDictionary</span><span class="o">);</span>
</span><span class="line">    <span class="n">virtualPathData</span><span class="o">.</span><span class="n">VirtualPath</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">notifyRecommendation</span> <span class="n">httpContext</span> <span class="n">phones</span> <span class="o">(</span><span class="n">connectionId</span><span class="o">,</span> <span class="n">recommendedPhoneId</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">TypeProviders</span><span class="p">.</span><span class="n">ToPhone</span>
</span><span class="line">    <span class="k">match</span> <span class="n">recommendedPhoneId</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Some</span> <span class="n">phoneId</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">recommendedPhone</span> <span class="o">=</span> <span class="nn">Phones</span><span class="p">.</span><span class="n">getPhoneById</span> <span class="n">phones&#39;</span> <span class="n">phoneId</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">phoneUrl</span> <span class="o">=</span> <span class="n">getUrl</span> <span class="n">phoneId</span> <span class="n">httpContext</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">hubContext</span> <span class="o">=</span> <span class="nn">GlobalHost</span><span class="p">.</span><span class="nn">ConnectionManager</span><span class="p">.</span><span class="n">GetHubContext</span><span class="o">&lt;</span><span class="n">RecommendationHub</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class="line">      <span class="n">hubContext</span><span class="o">.</span><span class="n">Clients</span><span class="o">.</span><span class="n">Client</span><span class="o">(</span><span class="n">connectionId</span><span class="o">)?</span><span class="n">showRecommendation</span><span class="o">(</span><span class="n">recommendedPhone</span><span class="o">,</span> <span class="n">phoneUrl</span><span class="o">)</span>
</span><span class="line">    <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>notifyRecommendation</code> function checks whether the incoming recommendedPhoneId has value or not. If it has value, it just picks the <code>Phone</code> record corresponding to the given phoneId and get the url for the recommended phone. With all these data in place, we just need to send the response to the using via SignalR.</p>

<p>You would have a noticed a weird <code>?</code> symbol which is actually part of the <a href="https://www.nuget.org/packages/ImpromptuInterface.FSharp/">ImpromptuInterface.FSharp</a>. This library adds provisions to use <a href="http://msdn.microsoft.com/en-IN/library/dd264736.aspx">C# dynamic types</a> in F#</p>

<p>They are two missing pieces. One is <code>Phones.getPhoneById</code> which we are not having. Let’s add them. Open <code>Phones</code> module in <strong>Domain</strong> project and add it as mentioned below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">getPhoneById</span> <span class="o">(</span><span class="n">phones</span> <span class="o">:</span> <span class="n">seq</span><span class="o">&lt;</span><span class="n">Phone</span><span class="o">&gt;)</span> <span class="n">phoneId</span> <span class="o">=</span>
</span><span class="line">    <span class="n">phones</span> <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">phoneId</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The final step is wiring the <code>RecommendationPipe</code> with the <code>notifyRecommendation</code>. Open <code>Global.asax.fs</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">Global</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="c1">// .. existing code ignore for brevity ..</span>
</span><span class="line"> <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Application_Start</span><span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">phones</span> <span class="o">=</span> <span class="nn">GitHubRepository</span><span class="p">.</span><span class="n">getPhones</span><span class="bp">()</span>
</span><span class="line">    <span class="c1">// .. existing code ignore for brevity ..</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">notificationObserver</span> <span class="o">=</span> <span class="nn">Hubs</span><span class="p">.</span><span class="n">notifyRecommendation</span> <span class="nn">HttpContext</span><span class="p">.</span><span class="n">Current</span> <span class="n">phones</span>
</span><span class="line">    <span class="nn">Recommendation</span><span class="p">.</span><span class="nn">RecommendationPipe</span><span class="p">.</span><span class="n">Subscribe</span> <span class="n">notificationObserver</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class="line">    <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Partial application of function is a very handy thing which actually replaces its counterpart Dependency Injection in the OOP. We just provided the first two arguments of <code>notifyRecommendation</code> and created a new function with the signature <code>string * string option -&gt; unit</code> which is the expected observer signature for the <code>RecommendationPipe</code>.</p>

<h4 id="the-front-end-ui">The Front End UI</h4>
<p>The front end for this is a typical SignalR-Javascript client code which you can find it the <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/3/Web/Scripts/recommendation.js">github repository</a>. I’ve intentionally leaving the front-end part of this application as it would be extends the scope of the blog post. Moreover if you go through the source code in the github repository you can easily understand</p>

<h3 id="summary">Summary</h3>
<p>F# is just so awesome with so much expressive functional programming features. Rx, Agents and SignalR add more powers to it and enable you to create a scalable functional reactive architecture. I’d like give credits two incredible resources on this subject Mark Seemann’s Pluralsight course on <a href="http://www.pluralsight.com/courses/functional-architecture-fsharp">Functional Architecture with F#</a> and Kevin Ashton’s excellent blog post on <a href="http://namelessinteractive.com/blog/Full_Stack_FSharp_%E2%80%93_The_Long_Version_(Part_1)">Full Stack F#</a> which helped me a lot in coming out with this blog post.</p>

<p>Last but not the least, Thanks to <a href="https://sergeytihon.wordpress.com">Sergey Tihon</a> for the words of encouragement to write the blog post on this topic.</p>

<p>You can find the source code of this step in <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/3">the github repository</a>. </p>
</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2015

    Tamizhvendan S


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'tamizhvendan-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.tamizhvendan.in/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/';
        var disqus_url = 'http://blog.tamizhvendan.in/blog/2015/01/02/step-3-phonecat-recommendation-system-using-f-number-agents/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>






</body>
</html>
