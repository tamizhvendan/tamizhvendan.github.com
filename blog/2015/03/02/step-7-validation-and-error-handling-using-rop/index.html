
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Step-7 Validation and Error Handling using ROP - P3 Programmer</title>
	<meta name="author" content="Tamizhvendan S">

	
	<meta name="description" content="Step-7 Validation and Error Handling Using ROP This is step 7 of my blog series on Web Application Development in Fsharp using ASP.NET MVC In the &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="http://feeds.feedburner.com/tamizhvendan-blog" rel="alternate" title="P3 Programmer" type="application/atom+xml">
	
	<link rel="canonical" href="http://blog.tamizhvendan.in/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/">
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link href="/favicon.png" rel="shortcut icon">
  <link href='/stylesheets/fonts.css' rel='stylesheet' type='text/css'>
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
  <style type="text/css">

  </style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
	<!-- Start of Leadin Embed -->
  <script type="text/javascript" src="//js.leadin.com/js/v1/2177345.js" id="LeadinEmbed-2177345" crossorigin="use-credentials" async defer></script>
<!-- End of Leadin Embed -->
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-43004255-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><!-- <div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("tamizh88@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div> -->
<style>
@media (max-width: 600px) {
  #book-cover, #tag-cloud {
    display: none;
  }
}
</style>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="http://about.me/tamizhvendan">About Me</a></li>
    <li><a href="/blog/archives">Archives</a></li>
    <li><a href="/open-source-contributions">Contributions</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:tamizh88@gmail.com" title="Email">Email</a>
		
		
		
		
			<a class="twitter" href="http://twitter.com/tamizhvendan" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/tamizhvendan" title="GitHub">GitHub</a>
		
		
			<a class="coderwall" href="https://coderwall.com/tamizhvendan" title="Coderwall">Coderwall</a>
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="http://feeds.feedburner.com/tamizhvendan-blog" title="RSS">RSS</a>
		
	</div>
</nav>
<nav id="book-cover" style="margin-top:32px">
	<a href="http://products.tamizhvendan.in/fsharp-applied">
	<img class="center" src="/images/fsharp_applied_cover.jpg" width="160">
</a>
</nav>
<nav id="tag-cloud">
	<section>
    <!-- <h3>Tag Cloud</h3>
    <span id="tag-cloud"><a href='/blog/categories/asp-dot-net-mvc' style='font-size: 143.63636363636363%'>asp.net mvc</a> <a href='/blog/categories/c-number' style='font-size: 110.9090909090909%'>c#</a> <a href='/blog/categories/craftsmanship' style='font-size: 116.36363636363636%'>craftsmanship</a> <a href='/blog/categories/entity-framework' style='font-size: 113.63636363636364%'>entity framework</a> <a href='/blog/categories/fsharp' style='font-size: 160.0%'>fsharp</a> <a href='/blog/categories/functional-programming' style='font-size: 119.0909090909091%'>functional-programming</a> <a href='/blog/categories/javascript' style='font-size: 110.9090909090909%'>javascript</a> <a href='/blog/categories/programming' style='font-size: 116.36363636363636%'>programming</a> <a href='/blog/categories/suave' style='font-size: 113.63636363636364%'>suave</a> <a href='/blog/categories/unit-testing' style='font-size: 113.63636363636364%'>unit testing</a> </span> -->
</section>
</nav>


</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Step-7 Validation and Error Handling Using ROP</h1>
	<div class="entry-content" itemprop="articleBody"><blockquote>
  <p>This is step 7 of my blog series on <a href="/blog/2014/12/10/web-application-development-in-fsharp-using-asp-dot-net-mvc/">Web Application Development in Fsharp using ASP.NET MVC</a></p>
</blockquote>

<p>In the <a href="/blog/2015/02/04/step-6-authentication-using-owin-middleware-and-asp-dot-net-identity/">last blog post</a> we have seen how to register a new user using the Asp.Net Identity Management framework. Validating the incoming data before updating the backend datastore and handling error while saving are typical tasks in a web application. In this blog post we are going to see how to achieve these things in a web application written in fsharp. As mentioned in the last blog post we will be adding validation logic for new user registration using <a href="http://fsharpforfunandprofit.com/rop/">Railway oriented Programming</a> aka <em>ROP</em>.</p>

<h3 id="cleanup">Cleanup</h3>

<p>Before adding the validation,  let’s do some cleanup and make it ready for adding validation. </p>

<p>Create a new source file <code>UserStorage</code> in the <strong>Identity</strong> project and move the user manager creation logic from <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/6/Web/MvcInfrastructure.fs#L15-L20">MvcInfrastructure</a> to here.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">module</span> <span class="nn">UserStorage</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">createUserManager</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userStore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserStore</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">UserDbContext</span><span class="bp">()</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userStore</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">userValidator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserValidator</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;(</span><span class="n">userManager</span><span class="o">)</span>
</span><span class="line">    <span class="n">userValidator</span><span class="o">.</span><span class="n">AllowOnlyAlphanumericUserNames</span> <span class="o">&lt;-</span> <span class="k">false</span>
</span><span class="line">    <span class="n">userManager</span><span class="o">.</span><span class="n">UserValidator</span> <span class="o">&lt;-</span> <span class="n">userValidator</span>
</span><span class="line">    <span class="n">userManager</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Create a Request record type in <code>Users</code> that represents the request for creating a new user</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">type</span> <span class="nc">CreateUserRequest</span> <span class="o">=</span> <span class="o">{</span><span class="n">Name</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Password</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Email</span> <span class="o">:</span> <span class="kt">string</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then move the user creation logic from Authentication Controller’s <a href="https://github.com/tamizhvendan/fsharp-phonecat/blob/6/Web/Controllers/AuthenticationController.fs#L62-L65">Register action method</a> to <code>UserStorage</code> and update it to use <code>CreateUserRequest</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">createUser</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">,</span>
</span><span class="line">                      <span class="n">UserName</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">,</span>
</span><span class="line">                      <span class="n">Email</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">userManager</span><span class="o">.</span><span class="n">Create</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Finally, update the <code>Register</code> action method in <code>AuthenticationController</code> to use the above function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">createUserRequest</span> <span class="o">:</span> <span class="n">CreateUserRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span>
</span><span class="line">    <span class="n">Email</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span><span class="o">;</span>
</span><span class="line">    <span class="n">Password</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Password</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">userCreateResult</span> <span class="o">=</span> <span class="nn">Users</span><span class="p">.</span><span class="n">createUser</span> <span class="n">userManager</span> <span class="n">createUserRequest</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">userCreateResult</span><span class="o">.</span><span class="n">Succeeded</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="n">userCreateResult</span><span class="o">.</span><span class="n">Errors</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">iter</span><span class="o">(</span><span class="k">fun</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">err</span><span class="o">))</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">registerViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With this we are wrapping the cleanup work and all set for adding validation.</p>

<h3 id="adding-validation">Adding Validation</h3>

<p>The first step in ROP is defining the “two tracks”. The track <code>Success</code> represents a successful operation (here its validation) and the other track <code>Failure</code> represents the failure while executing an operation. Usually these “two tracks” will be defined using a discriminated union.</p>

<p>Create a source file <code>Rop</code> in the <strong>Identity</strong> project and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Rop</span> <span class="o">=</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">Error</span> <span class="o">=</span> <span class="o">{</span><span class="n">Property</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">Message</span> <span class="o">:</span> <span class="kt">string</span><span class="o">}</span>
</span><span class="line">  <span class="k">type</span> <span class="nc">Result</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Success</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">a</span>
</span><span class="line">    <span class="o">|</span> <span class="n">Failure</span> <span class="k">of</span> <span class="n">Error</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>Error</code> type provides the metadata associated with the error.</p>

<p>Let’s start writing validation rules from validating Name. Create a source file <code>NameValidation</code> in <strong>Identity</strong> project and add the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">NameValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameEmptiness</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span>
</span><span class="line">          <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span> <span class="o">&lt;&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">Empty</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Name&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Name is required&quot;</span><span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameLength</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">        <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Name&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Name should not contain more than 50 characters&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Hope these rules are self-explanatory. We are just validating the name for emptiness and length, and based on the result we are returning either the <code>Success</code> track or <code>Failure</code> track.</p>

<p>Next, add validation rules for Password. Similar to Name Validation add a source file with the name <code>PasswordValidation</code> and update it as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">PasswordValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordEmptiness</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span>
</span><span class="line">          <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span> <span class="o">&lt;&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">Empty</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Password&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Password is required&quot;</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordLength</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">)</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;Password&quot;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;Password should not contain more than 10 characters&quot;</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordStrength</span>  <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">specialCharacters</span> <span class="o">=</span> <span class="o">[</span> <span class="s">&quot;*&quot;</span><span class="o">;</span> <span class="s">&quot;&amp;&quot;</span><span class="o">;</span> <span class="s">&quot;%&quot;</span><span class="o">;</span> <span class="s">&quot;$&quot;</span> <span class="o">]</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">hasSpecialCharacters</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="n">String</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">      <span class="n">specialCharacters</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">exists</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">errorMessage</span> <span class="o">=</span>
</span><span class="line">      <span class="s">&quot;Password should contain atleast one of the special characters &quot;</span>
</span><span class="line">        <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">Join</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">,</span> <span class="n">specialCharacters</span><span class="o">)</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="n">hasSpecialCharacters</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="n">errorMessage</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In addition to the two validation rules that we have seen in <code>NameValidation</code> here we have added one more validation to verify the presence of special characters in the <code>Password</code>.</p>

<p>There is a pattern in all the validation rules that we have seen so far. </p>

<p><img class="center" src="/images/fsharp_phonecat/step_7/validation_pattern.png" width="450" height="450" /></p>

<p>Let’s extract this pattern out of these validation rules and reduce the lines of code!</p>

<p>Create a new source file <code>Validation</code> and add the write this pattern as a function</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">Validation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validate</span> <span class="n">isValid</span> <span class="n">property</span> <span class="n">message</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="n">isValid</span> <span class="n">createUserRequest</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span><span class="n">Property</span> <span class="o">=</span> <span class="n">property</span><span class="o">;</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">message</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The <code>validate</code> function represents the outer box of the above diagram which takes four inputs</p>

<ul>
  <li>A function to validate the createUserRequest <code>isValid</code> which has the signature
<code>'a -&gt; bool</code> that represents the validation rule</li>
  <li>A string to show which property is invalid in the error <code>property</code></li>
  <li>A string representing the error <code>message</code></li>
  <li>The last is the incoming userCreateRequest <code>createUserRequest</code></li>
</ul>

<p><em>Note: Property and Message parameters are not shown in the diagram just to express the pattern clearly</em></p>

<p>We also need a small utility function to check the emptiness of the string. So add it in <code>Validation</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">isNonEmptyString</span> <span class="n">str</span> <span class="o">=</span> <span class="n">str</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span> <span class="n">str</span> <span class="o">&lt;&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">Empty</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With these functions in place we can refactor the validation rules that we written before.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">NameValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameEmptiness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isNonEmptyString</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Name&quot;</span>
</span><span class="line">      <span class="s">&quot;Name is required&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateNameLength</span>  <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Name&quot;</span>
</span><span class="line">      <span class="s">&quot;Name should not contain more than 50 characters&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">PasswordValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordEmptiness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isNonEmptyString</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="s">&quot;Password is required&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordLength</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="s">&quot;Password should not contain more than 10 characters&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">hasSpecialCharacters</span> <span class="n">specialCharacters</span> <span class="o">(</span><span class="n">str</span> <span class="o">:</span> <span class="n">String</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">    <span class="n">specialCharacters</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">exists</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validatePasswordStrength</span>  <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">specialCharacters</span> <span class="o">=</span> <span class="o">[</span> <span class="s">&quot;*&quot;</span><span class="o">;</span> <span class="s">&quot;&amp;&quot;</span><span class="o">;</span> <span class="s">&quot;%&quot;</span><span class="o">;</span> <span class="s">&quot;$&quot;</span> <span class="o">]</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">errorMessage</span> <span class="o">=</span>
</span><span class="line">      <span class="s">&quot;Password should contain atleast one of the special characters &quot;</span>
</span><span class="line">        <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">Join</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">,</span> <span class="n">specialCharacters</span><span class="o">)</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span>
</span><span class="line">        <span class="n">hasSpecialCharacters</span> <span class="n">specialCharacters</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Password&quot;</span>
</span><span class="line">      <span class="n">errorMessage</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Much cleaner than the previous version, isn’t it?</p>

<p>The final validation is Email validation. It is very similar to the other validations that we have seen so far. One extra validation is verifying the uniqueness of the email id being used to register.</p>

<p>Create a new source file <code>EmailValidation</code> and add the validations</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">EmailValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">isUniqueEmailAddr</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">emailAddr</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">FindByName</span><span class="o">(</span><span class="n">emailAddr</span><span class="o">)</span>
</span><span class="line">    <span class="n">user</span> <span class="o">=</span> <span class="k">null</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">isValidEmailAddress</span> <span class="n">emailAddr</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">emailAddrRegex</span> <span class="o">=</span>
</span><span class="line">      <span class="s">@&quot;\A(?:[a-z0-9!#$%&amp;&#39;*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&amp;&#39;*+/=?^_`{|}~-]+)&quot;</span> <span class="o">+</span>
</span><span class="line">        <span class="s">&quot;*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?</span><span class="err">\</span><span class="s">.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?)</span><span class="err">\</span><span class="s">Z&quot;</span>
</span><span class="line">    <span class="nn">Regex</span><span class="p">.</span><span class="n">IsMatch</span><span class="o">(</span><span class="n">emailAddr</span><span class="o">,</span> <span class="n">emailAddrRegex</span><span class="o">,</span> <span class="nn">RegexOptions</span><span class="p">.</span><span class="n">IgnoreCase</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateEmailEmptiness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isNonEmptyString</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Email&quot;</span>
</span><span class="line">      <span class="s">&quot;Email is required&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateEmailUniqueness</span> <span class="n">isUniqueEmailAddr</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isUniqueEmailAddr</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Email&quot;</span>
</span><span class="line">      <span class="s">&quot;Email address already exists&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="nv">validateEmailCorrectness</span> <span class="o">=</span>
</span><span class="line">    <span class="n">validate</span>
</span><span class="line">      <span class="o">(</span><span class="k">fun</span> <span class="n">createUserRequest</span> <span class="o">-&gt;</span> <span class="n">isValidEmailAddress</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">      <span class="s">&quot;Email&quot;</span>
</span><span class="line">      <span class="s">&quot;Email address is invalid&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="putting-all-the-validations-together">Putting all the validations together</h3>

<p>So far we have seen individual property validation rules. It’s time to put all these pieces together and validate the <code>CreateUserRequest</code> as a whole.</p>

<p>Create a source file <code>UserValidation</code> and update it as below</p>

<p><img src="/images/fsharp_phonecat/step_7/uservalidation_match.png" /></p>

<p>Wait.. Wait.. I know how do you feel here.. It’s too much code! Can we do it in a better way? </p>

<h3 id="using-railway-oriented-programming-rop">Using Railway Oriented Programming (ROP)</h3>

<p>Thanks to ROP, we can make the mighty code smaller and more readable. I am going ahead with an assumption that you are aware of ROP. In case if you are not aware of it then watch this <a href="http://vimeo.com/97344498">excellent presentation</a> by <a href="https://twitter.com/ScottWlaschin">Scott Wlaschin</a></p>

<p><img class="center" src="/images/fsharp_phonecat/step_7/bind_function.png" width="350" height="500" /></p>

<p>The crux of ROP is the bind function which composes two functions where the output type of one function is not matching with that of the input. If you want to know more this bind function, do visit this <a href="http://adit.io./posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html">awesome blog post</a> by <a href="https://twitter.com/_egonschiele">Aditya</a>. In this blog post he explains about the bind function under the title <strong>Monads</strong></p>

<p>Let’s start by adding this bind function in the module <code>Rop</code> that we have already created.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">bind</span> <span class="n">f1</span> <span class="n">f2</span> <span class="n">x</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">f1</span> <span class="n">str</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Success</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f2</span> <span class="n">x</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Failure</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">Failure</span> <span class="n">err</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="nv">inline</span> <span class="o">(&gt;&gt;=)</span> <span class="n">f1</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">bind</span> <span class="n">f1</span> <span class="n">f2</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The bind function here calls the function <code>f1</code> with the given input <code>x</code> if it succeeds, then executes the second function <code>f2</code> with <code>x</code>. In case if the execution of <code>f1</code> resulted in failure then it just passes without executing the second function. </p>

<p>The infix operator <code>&gt;&gt;=</code> is an alias of bind function. </p>

<p>With the help of this bind function, we can rewrite the <code>validateCreateUserRequest</code> function in a better way as below</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">module</span> <span class="nn">UserValidation</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">validateCreateUserRequest</span> <span class="n">userManager</span>  <span class="o">=</span>
</span><span class="line">      <span class="n">validateEmailEmptiness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateEmailCorrectness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateEmailUniqueness</span> <span class="o">(</span><span class="n">isUniqueEmailAddr</span> <span class="n">userManager</span><span class="o">)</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateNameEmptiness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validateNameLength</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validatePasswordEmptiness</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validatePasswordLength</span>
</span><span class="line">        <span class="o">&gt;&gt;=</span> <span class="n">validatePasswordStrength</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It’s awesome! Isn’t it? If you are still wondering what’s happening here! Watch the Scott’s presentation one more time.</p>

<h3 id="adding-validation-before-saving">Adding validation before saving</h3>

<p>Now we have the validation infrastructure in place. So, let’s go ahead and add it before creating a new user in the backend. As part of this refactoring we are also going to do error handling of new user creation. </p>

<p>Create a new private function in <code>UserStorage</code> to create a new user with error handling</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">private</span> <span class="n">createUser&#39;</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="n">createUserRequest</span> <span class="o">=</span>
</span><span class="line">  <span class="k">try</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Name</span><span class="o">,</span>
</span><span class="line">                        <span class="n">UserName</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">,</span>
</span><span class="line">                        <span class="n">Email</span> <span class="o">=</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Email</span><span class="o">)</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">identityResult</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Create</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">createUserRequest</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">identityResult</span><span class="o">.</span><span class="n">Succeeded</span> <span class="k">then</span>
</span><span class="line">      <span class="n">Success</span> <span class="n">createUserRequest</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="k">let</span> <span class="nv">errors</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s">&quot;,&quot;</span> <span class="n">identityResult</span><span class="o">.</span><span class="n">Errors</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="n">errors</span><span class="o">}</span>
</span><span class="line">  <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">Failure</span> <span class="o">{</span> <span class="n">Property</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class="line">                <span class="n">Message</span> <span class="o">=</span> <span class="s">&quot;An unexpected error happened while creating new user&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Like validation rules defined before this new <code>createUser'</code> function is also outputs “two tracks”, Success if the user creation is successful others it outputs Failure. Because of this change in function signature <br />
(<code>UserManager&lt;User&gt; -&gt; CreateUserRequest -&gt; Result&lt;CreateUserRequest&gt;</code>) we can fit this easily into the bind function.</p>

<p>Modify the existing <code>CreateUser</code> function to use this</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="k">let</span> <span class="nv">createUser</span> <span class="o">(</span><span class="n">userManager</span> <span class="o">:</span> <span class="n">UserManager</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class="line">      <span class="n">validateCreateUserRequest</span> <span class="n">userManager</span> <span class="o">&gt;&gt;=</span> <span class="n">createUser&#39;</span> <span class="n">userManager</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Thanks to <a href="http://fsharpforfunandprofit.com/posts/partial-application/">Partial application</a> we have created new functions on the fly by passing only the partial parameters (<code>UserManager</code> in this case) and make it fit with less code. </p>

<p>Since we have changed the signature of the <code>createUser</code> function from <code>UserManager&lt;User&gt; -&gt; CreateUserRequest -&gt; IdentityResult</code> to <code>UserManager&lt;User&gt; -&gt; CreateUserRequest -&gt; Result&lt;CreateUserRequest&gt;</code> we need to change the <code>Register</code> action method in the <code>AuthenticationController</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="fsharp"><span class="line"><span class="o">[&lt;</span><span class="n">HttpPost</span><span class="o">&gt;]</span>
</span><span class="line"><span class="o">[&lt;</span><span class="n">ValidateAntiForgeryToken</span><span class="o">&gt;]</span>
</span><span class="line"><span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Register</span><span class="o">(</span><span class="n">registerViewModel</span> <span class="o">:</span> <span class="n">RegisterViewModel</span><span class="o">)</span> <span class="o">:</span> <span class="n">ActionResult</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="nv">createUserRequest</span> <span class="o">:</span> <span class="n">CreateUserRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Name</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Name</span><span class="o">;</span>
</span><span class="line">    <span class="n">Email</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Email</span><span class="o">;</span>
</span><span class="line">    <span class="n">Password</span> <span class="o">=</span> <span class="n">registerViewModel</span><span class="o">.</span><span class="n">Password</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">match</span> <span class="nn">UserStorage</span><span class="p">.</span><span class="n">createUser</span> <span class="n">userManager</span> <span class="n">createUserRequest</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Failure</span> <span class="n">error</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">ModelState</span><span class="o">.</span><span class="n">AddModelError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">Property</span><span class="o">,</span> <span class="n">error</span><span class="o">.</span><span class="n">Message</span><span class="o">)</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">View</span><span class="o">(</span><span class="n">registerViewModel</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span><span class="line">  <span class="o">|</span> <span class="n">Success</span> <span class="n">createUserRequest&#39;</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">userManager</span><span class="o">.</span><span class="n">Find</span><span class="o">(</span><span class="n">createUserRequest&#39;</span><span class="o">.</span><span class="n">Email</span><span class="o">,</span> <span class="n">createUserRequest&#39;</span><span class="o">.</span><span class="n">Password</span><span class="o">)</span>
</span><span class="line">    <span class="n">signin</span> <span class="n">userManager</span> <span class="k">base</span><span class="o">.</span><span class="n">Request</span> <span class="n">user</span>
</span><span class="line">    <span class="n">this</span><span class="o">.</span><span class="n">RedirectToAction</span><span class="o">(</span><span class="s">&quot;Index&quot;</span><span class="o">,</span> <span class="s">&quot;Home&quot;</span><span class="o">)</span> <span class="o">:&gt;</span> <span class="n">ActionResult</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That’s it, we are ready to go!</p>

<h3 id="summary">Summary</h3>

<p>In this blog post we have seen how to add validations and error handling in fsharp using ROP. Though it is little hard to get this kind of functional thinking, it offers a great deal of expressiveness and flexibility to your codebase. Just like any other skills if you practice it for quite time you can also master it. You can find the source code associated with this step in the <a href="https://github.com/tamizhvendan/fsharp-phonecat/tree/7">github repository</a></p>
</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2016

    Tamizhvendan S


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'tamizhvendan-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.tamizhvendan.in/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/';
        var disqus_url = 'http://blog.tamizhvendan.in/blog/2015/03/02/step-7-validation-and-error-handling-using-rop/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>






</body>
</html>
